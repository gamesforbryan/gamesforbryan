<!DOCTYPE html>
<html>
<head><link id="stylesheet" rel="stylesheet" href="pd_style_default.css">
<meta charset="utf-8">
<title>PracticalDaemonology</title>

</head>

<body>

<tw-story></tw-story>

<!-- UUID://3128F1D7-B233-41CC-B2BE-0FCE619629B2// --><tw-storydata name="PracticalDaemonology" startnode="889" creator="Tweego" creator-version="2.1.1+81d1d71" ifid="3128F1D7-B233-41CC-B2BE-0FCE619629B2" zoom="0.6" format="Harlowe" format-version="3.1.0" options="" hidden><style role="stylesheet" id="twine-user-stylesheet" type="text/twine-css"></style><script role="script" id="twine-user-script" type="text/twine-javascript"></script><tw-tag name="book" color="gray"></tw-tag><tw-tag name="daemon" color="red"></tw-tag><tw-tag name="daemon-description" color="red"></tw-tag><tw-tag name="function" color="green"></tw-tag><tw-tag name="incense" color="red"></tw-tag><tw-tag name="journey" color="yellow"></tw-tag><tw-tag name="npc" color="blue"></tw-tag><tw-tag name="rumor" color="yellow"></tw-tag><tw-tag name="foray" color="yellow"></tw-tag><tw-tag name="persona" color="blue"></tw-tag><tw-tag name="potion" color="gray"></tw-tag><tw-tag name="reagent" color="purple"></tw-tag><tw-tag name="startup" color="green"></tw-tag><tw-passagedata pid="1" name="Canals" tags="location northharbor easternfortress" position="8381,2064" size="200,100">(display: &quot;Init Canals&quot;)
Hilbert space-filling curves of canals.
Borders North Harbor and Eastern Fortress.

[[North Harbor]] 

[[Eastern Fortress]]</tw-passagedata><tw-passagedata pid="2" name="Init Canals" tags="function" position="8388,1944" size="100,100">{(set: $environmentMaterials to (a: &quot;stone&quot;, &quot;wood&quot;, &quot;concrete&quot;))
(set: $environmentColors to (a: &quot;seafoam white&quot;, &quot;driftwood brown&quot;, &quot;wine dark&quot;, &quot;sea blue&quot;))
(set: $clothingMaterials to (a: &quot;satin&quot;, &quot;leather&quot;, &quot;linen&quot;))
(set: $clothingColors to (a: &quot;brown&quot;, &quot;black&quot;, &quot;gray&quot;, &quot;goldenrod&quot;, &quot;verdant&quot;,&quot;ruddy&quot;,&quot;robin&#39;s egg&quot;))
(set: $clothingTypes to (a: &quot;service uniforms&quot;, &quot;one-piece mountebank&#39;s livery&quot;, &quot;gentry livery&quot;, &quot;a cuirass and tunic&quot;))
(set: $adornmentMaterials to (a: &quot;silver foil&quot;, &quot;gold foil&quot;, &quot;ivory&quot;, &quot;living flower&quot;, &quot;feather&quot;, &quot;tin&quot;))
(set: $adornmentTypes to (a: &quot;masks&quot;, &quot;epaulets&quot;, &quot;diadems&quot;))
(set: $hairstyles to (a: &quot;a shaven scalp&quot;, &quot;a powdered wig&quot;, &quot;a wig and a hat&quot;,&quot;a glorious powdered confection&quot;))

(set: $sizes to (a: &quot;scrawny&quot;, &quot;rawboned&quot;))
(set: $races to (a: &quot;human&quot;, &quot;drake-kin&quot;, &quot;goblin&quot;, &quot;devil&quot;))
(set: $skinColors to (a: &quot;black&quot;, &quot;tan&quot;, &quot;brown&quot;, &quot;red&quot;, &quot;gray&quot;))
(set: $skinTypes to (a: &quot;smooth&quot;, &quot;lightly furred&quot;, &quot;fur-covered&quot;, &quot;scaled&quot;))
(set: $professions to (a: &quot;duelist&quot;, &quot;entertainer&quot;, &quot;juggler&quot;, &quot;courtesan&quot;))
}
{(set: $neighborhood to 
(dm: &quot;name&quot;, &quot;Canals&quot;, 
&quot;tagname&quot;, &quot;canals&quot;,
	&quot;locations&quot;, (a:),
&quot;contracts&quot;, (a:),
		&quot;events&quot;, (a:)))}</tw-passagedata><tw-passagedata pid="3" name="Init Catacombs" tags="function" position="4517,5459" size="100,100">{(set: $environmentMaterials to (a: &quot;stone&quot;, &quot;stalagmite&quot;, &quot;bone&quot;, &quot;calcite&quot;, &quot;dirt&quot;, &quot;fossil&quot;, &quot;pitch-soaked timbers&quot;))
(set: $environmentColors to (a: &quot;black&quot;, &quot;white&quot;, &quot;gray&quot;))
(set: $clothingMaterials to (a: &quot;sackcloth&quot;, &quot;burlap&quot;, &quot;hair&quot;))
(set: $clothingColors to (a: &quot;dun&quot;, &quot;black&quot;))
(set: $clothingTypes to (a: &quot;robe&quot;, &quot;tunic&quot;, &quot;cloak and cowl&quot;))
(set: $adornmentMaterials to (a: &quot;iron&quot;, &quot;bone&quot;, &quot;gold&quot;))
(set: $adornmentTypes to (a: &quot;chains&quot;, &quot;amulets&quot;))
(set: $hairstyles to (a: &quot;tonsure&quot;))

(set: $sizes to (a: &quot;drawn&quot;, &quot;rawboned&quot;))
(set: $races to (a: &quot;human&quot;, &quot;zombie&quot;, &quot;animated skeleton&quot;, &quot;spectre&quot;))
(set: $skinColors to (a: &quot;black&quot;, &quot;white&quot;, &quot;green&quot;, &quot;gray&quot;))
(set: $skinTypes to (a: &quot;smooth&quot;, &quot;scaly&quot;, &quot;moldy&quot;, &quot;wart-covered&quot;))
(set: $professions to (a: &quot;cenobite&quot;, &quot;monastic&quot;, &quot;incense-burner&quot;, &quot;sin eater&quot;))
}
{(set: $neighborhood to 
(dm: &quot;name&quot;, &quot;Catacombs&quot;, 
&quot;tagname&quot;, &quot;catacombs&quot;,
	&quot;locations&quot;, (a:),
&quot;contracts&quot;, (a:),
		&quot;events&quot;, (a:)))}</tw-passagedata><tw-passagedata pid="4" name="Catacombs: Grave Robbing" tags="" position="4780,5877" size="100,100">Golden treasures and precious reagents just sitting there, going to waste.  Reduce, Reuse, Recycle!

(link-reveal: &quot;Yes, I&#39;ll Rob That Juicy Grave!&quot;)[
You grab some gold and what-not
(set: $arg to (random: 0, 200))(display: &quot;UpdateGold&quot;)
(set: $arg to &quot;Bit of Bone&quot;)(display: &quot;GetItem&quot;)
(if: (random: 0, 2) is 0)[]
(else:)[
(goto: &quot;Encounter: Rattle Bones&quot;)
]

]

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="5" name="Catacombs: Groping in the Darkness" tags="" position="4651,5842" size="100,100">It&#39;s quite dark down here.
(if: (random: 0, $perception) &gt; 0)[But you&#39;re able to make your way just fine.
](else:)[
In the darkness, you slip and fall.
(set: $deathReason to &quot;You reach for firm ground but instead plummet into eternal darkness.&quot;)(set: $arg to 1)(display: &quot;TakeDamage&quot;)
]

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="6" name="Catacombs: Spirit Flames" tags="" position="4755,5752" size="100,100">Floating near the tunnel ceiling is a (either: &quot;faint&quot;, &quot;bright&quot;, &quot;queasy&quot;), (either: &quot;greenish&quot;, &quot;bluish&quot;, &quot;greyish&quot;) flame moving under its own direction.

You could follow it!

[[Catacombs: Follow the Spirit Flames]]

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="7" name="Catacombs: A Series of Twisty Crypts All Similar" tags="" position="4880,5637" size="100,100">It&#39;s a trope that all catacombs will have twisty passages, either alike or unalike, but all pointeless wastes of time.

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="8" name="Catacombs: Lower Depths Gate" tags="" position="4535,5637" size="100,100">[[Lower Depths]]</tw-passagedata><tw-passagedata pid="9" name="Catacombs: South Quarry Gate" tags="" position="4998,5628" size="100,100">[[South Quarry]]</tw-passagedata><tw-passagedata pid="10" name="Catacombs: Follow the Spirit Flames" tags="" position="4660,5962" size="100,100">(set: $encounterIndex to (random: 1, $encounterStack&#39;s length))
You follow the spirit flames, hoping that they don&#39;t deliver you into instant death.

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="11" name="Catacombs" tags="" position="4655,5487" size="200,200">(display: &quot;Init Catacombs&quot;)
//some form of adventure to unlock shortcut to...//

(set: $pursued to false)
(set: $encounterStack to (shuffled: 
&quot;Catacombs: Grave Robbing&quot;,&quot;Catacombs: Grave Robbing&quot;,&quot;Catacombs: Grave Robbing&quot;,&quot;Catacombs: Grave Robbing&quot;,
&quot;Catacombs: Groping in the Darkness&quot;,&quot;Catacombs: Groping in the Darkness&quot;,&quot;Catacombs: Groping in the Darkness&quot;,&quot;Catacombs: Groping in the Darkness&quot;,
&quot;Catacombs: Spirit Flames&quot;,&quot;Catacombs: Spirit Flames&quot;,&quot;Catacombs: Spirit Flames&quot;,&quot;Catacombs: Spirit Flames&quot;,
&quot;Catacombs: A Series of Twisty Crypts All Similar&quot;,&quot;Catacombs: A Series of Twisty Crypts All Similar&quot;,&quot;Catacombs: A Series of Twisty Crypts All Similar&quot;,&quot;Catacombs: A Series of Twisty Crypts All Similar&quot;
)&#39;s (range: 1, (random: 9, 13)))
(set: $encounterIndex to 1)
(if: $neighborhood&#39;s name is &quot;South Quarry&quot;)[(set: $encounterStack to it + (a: &quot;Catacombs: Lower Depths Gate&quot;))]
(else:)[(set: $encounterStack to it + (a: &quot;Catacombs: South Quarry Gate&quot;))]


[[Sally Forth!-&gt;Next Encounter]]

[[Catacombs: Grave Robbing]]
[[Catacombs: Groping in the Darkness]]
[[Catacombs: Spirit Flames]]
[[Catacombs: A Series of Twisty Crypts All Similar]]
[[Catacombs: Lower Depths Gate]]
[[Catacombs: South Quarry Gate]]
(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="12" name="Contract Fulfilled" tags="" position="3358,2697" size="100,100">{(set: $currentContractStatus to 1)
(set: $encounterStack to (a:))
(set: $encounterIndex to 0)
(set: $currentContractStatus to 0)
(set: $currentContract to &quot;&quot;)
(set: $encounterPayout to 0)
(set: $encounterLength to 0)
}

You&#39;ve done us proud, my (either: &quot;little&quot;, &quot;lovely&quot;, &quot;darling&quot;, &quot;wonderful&quot;) (either: &quot;pet&quot;, &quot;treasure&quot;, &quot;love&quot;, &quot;child&quot;).  

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="13" name="Slaying The Beast" tags="unique contract westfires brass-level" position="173,935" size="100,100">&quot;You want to make a difference?&quot;, your contact asks. &quot;I&#39;ve got a guy you could get rid of and protect a lot of little kids at the same time.&quot;

You&#39;re handed a crystal flask of poison gas and an itinerary for your target.  (if: $perception &gt; 2)[The target is an enchanter who may have left enchantment traps to snare would-be assassins.]

(set: $encounterPayout to (min: (50 + 5 * $reputation&#39;s ($neighborhood&#39;s name)), 250))
I&#39;ll offer you $encounterPayout coins for your trouble.
|input&gt;[
(link-reveal: &quot;Accept&quot;)[
(set: $currentContract to (passage:)&#39;s name)(replace:?input)[
You follow your target through a labyrinthine section of the Liar&#39;s Market.
He suspects that an assassin has been sent for him, but instead of going to ground, he is spending this day as if it is his last.

It is his last.

Need I describe for you the evil this man committed?
Need I describe for you the evil he will surely commit if he were to be allowed to live?
{
(set: $encounterStack to (a: &quot;Encounter: Enchantment Trap&quot;, &quot;Encounter Random Color&quot;, &quot;Encounter: Enchantment Trap&quot;, &quot;Fulfilled: Slaying The Beast&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 1)
}

[[Let Us Begin!-&gt;Encounter]]

[[Home Again]] To Prepare
]]

[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="14" name="Encounter: Enchantment Trap" tags="" position="3904,4484" size="100,100">(if: $enchantmentHidden is 0 or $perception &gt; $enchantmentHidden)[
You see the delicate tracery of an enchantment trap.  You&#39;ve seen these chop grown men to pieces.
You can attempt to destroy the enchantment with physical magic at the risk of your body or unravel the many knots at the risk of your mind.
|input&gt;[(link-reveal: &quot;Shatter the Enchantment&quot;)[(replace:?input)[](replace:?output)[(display: &quot;Shatter the Enchantment&quot;)]]
(if: $cunning &gt; 1)[ (link-reveal: &quot;Unweave the Enchantment&quot;)[(replace:?input)[](replace:?output)[(display: &quot;Attempt to Unweave the Enchantment&quot;)]]]]
]
(else:)[ (display: &quot;Display Random Color&quot;)
(link-reveal: &quot;Next Encounter&quot;)[(display: &quot;Trigger Enchantment&quot;)]
]
|output&gt;[]
[[Run Away-&gt;Cancel Contract]]</tw-passagedata><tw-passagedata pid="15" name="Shatter the Enchantment" tags="" position="4024,4484" size="100,100">You strike out at the enchantment with a surge of ley-line energy focussed by your force of will.  A meagre trick that shatters the strands of arcane energy that bound this place, sending fragments of it at terrifying speed.  Each strand of the web was under terrible tension, and you recoil as it lashes at you.
(set: $deathReason to &quot;Your corrupt, human flesh is lashed by razor-wire fine strands of arcane energy that cannot be stopped by your mortal armor.
  It&#39;s all too much.  You slump to the ground in a ragged, red mass.&quot;)
(set: $arg to 1)(display: &quot;TakeDamage&quot;)
Your corrupt, human flesh is lashed by razor-wire fine strands of arcane energy that cannot be stopped by your mortal armor.

You survive the blast with blood to spare.  Next time, you might lose an eye, my sweet child.

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="16" name="Attempt to Unweave the Enchantment" tags="" position="4138,4480" size="100,100">Each silky strand of the enchantment glides across your fingers as you attempt to unbind it from this spot.  It starts out very promisingly...
(set: _roll to $cunning + (random: -1,1))
(if: _roll &gt; 5)[and you get the payoff of some completely salvaged Ethereal Threads.
The strain makes you a bit weary.
(set: $inventory to it + (ds: &quot;Ethereal Threads&quot;))
(set: $cunning to it - 1)
Cunning - 1 ($cunning)
[[Next Encounter]] ](else-if: _roll &gt; 2)[
but you lose the thread of it.  You&#39;d managed to relieve enough of the pressure that you aren&#39;t injured, but you don&#39;t get any salvage from the activity.  Still, practice makes perfect.
(set: $cunning to it + 1)
Cunning + 1 ($cunning)
[[Next Encounter]] 
](else:)[
but you lose the thread of it while it&#39;s still under high tension.  The warp of it had been altered enough by your mishandling that instead of killing you outright, you are merely badly jolted.
(set: $cunning to it - 1)
Cunning - 1
(if: $cunning is 0)
[
Unfortunately, that jolt rendered you so completely stupid that your brain forgets to tell your heart to continue beating or your lungs to keep breathing.  You expire immediately.
[[Death]] 
]
(else:)
[
You&#39;ve got a migraine and blurry vision, but you can continue on your mission.
[[Next Encounter]] 
]
]
(replace:?clock)[(display: &quot;RenderHeader&quot;)]</tw-passagedata><tw-passagedata pid="17" name="Fulfilled: Slaying The Beast" tags="" position="287,942" size="100,100">You slip past the enchantments the Beast placed in your path, leaving him vulnerable to your attack.  You take out the vessel of poison gas and weave a simple teleportation spell.

He expires with a slight cough of greenish smoke and slumps against the market stall where he had been browsing the pornography.  In the vessel which held the poison gas is now the target&#39;s last breath.  You tuck it into a specially warded drake-hide satchel for safe keeping.
(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="18" name="Mutilating The Mountebank" tags="unique contract westfires brass-level" position="173,1046" size="100,100">&quot;A mountebank that performs at the Red Fountain in the Screaming Downs disrespected my boss,&quot; says the client&#39;s red-faced thug in the ill-fitting cuirass.  &quot;They&#39;re too cunning for me to catch them.&quot;
The thug sidles up to you and places a thick wedge of finger meat on your collar-bone.  &quot;Ruin their casting hand for me.  Do it right now!&quot;

(set: $encounterPayout to (min: (50 + 5 * $reputation&#39;s ($neighborhood&#39;s name)), 250))
&quot;I&#39;ll offer you $encounterPayout coins for your trouble.&quot;
|input&gt;[
(link-reveal: &quot;Accept&quot;)[(replace:?input)[
(set: $currentContract to (passage:)&#39;s name)
You spot your target as they&#39;re performing by the fountain in the Screaming Downs.  They spot you, too, and flee on foot.  (if: $perception &gt; 2)[The makes some obvious gestures, laying down enchantments and releasing a guardian daemon.]

(set: $encounterStack to (a: &quot;Encounter Random Color&quot;, &quot;Encounter: Enchantment Trap&quot;, &quot;Encounter: Fire Ghost&quot;, &quot;Encounter: Thug&quot;, &quot;Fulfilled: Mutilating The Mountebank&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 1)
(set: $contractCancelledOnDeath to 1)
[[Chase After Them!-&gt;Encounter]]

 ]]

[[Reject-&gt;Explore the Neighborhood]] 
]</tw-passagedata><tw-passagedata pid="19" name="Fulfilled: Mutilating The Mountebank" tags="" position="281,1046" size="100,100">Snicker-snack! goes your folding knife as you take a precious casting finger from the furious clown you&#39;ve subdued.
&quot;Stay down,&quot; you advise, and they listen.
(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="20" name="Encounter Random Color" tags="" position="4143,2880" size="100,100">(display: ($neighborhood&#39;s name) + &quot; Color&quot;)

[[Next Encounter]] 
[[Cancel Contract]]</tw-passagedata><tw-passagedata pid="21" name="Fulfilled: Hijinks in the Hedgemaze" tags="" position="287,1167" size="100,100">After stumbling your way through the maze, you finally find your quarry: two young nieces of a certain Senator, talking about things they should not know.  The one on the right gets up and leaves the bench.  Another of your client&#39;s agents are responsible for that one.

When the young lady on the left is turned away, you quickly reach in and snatch the silver thread of a brand new memory out from her perfect ear.
The secret that was whispered to her lives now in a small pouch made from the mummified head of a mutineer, its lips stitched shut and its lying tongue cut out.
(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="22" name="Hijinks in the Hedgemaze" tags="contract silver-level gold-level westfires" position="173,1172" size="100,100">&quot;It is common enough for young lovers to exchange secret time with each other in the ever-shifting hedgemaze at the Baron&#39;s castle grounds,&quot; the $clientDescription says to you.  &quot;I need you to erase a very specific secret... right away.&quot;

(set: $encounterPayout to (min: (50 + 5 * $reputation&#39;s ($neighborhood&#39;s name)), 350))
&quot;I&#39;ll offer you $encounterPayout coins for your trouble.&quot;
|input&gt;[
(link-reveal: &quot;Accept&quot;)[
(set: $currentContract to (passage:)&#39;s name)(replace:?input)[
The client left a parcel under a parkbench in front of the Baron&#39;s hedgemaze.  You open the parcel and pocket the tools of the trade.

You enter the maze, already frustrated.
(set: $encounterStack to (a: &quot;Encounter Random Color&quot;, &quot;Encounter: Shortcut&quot;, &quot;Encounter: Aura of Illusion&quot;, &quot;Encounter: Solar Spark&quot;, &quot;Encounter Random Color&quot;, &quot;Encounter: Enchantment Trap&quot;, &quot;Fulfilled: Hijinks in the Hedgemaze&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 3)
(set: $contractCancelledOnDeath to 1)
[[Let Us Begin!-&gt;Encounter]]
]]

[[Reject-&gt;Explore the Neighborhood]] 
]</tw-passagedata><tw-passagedata pid="23" name="Craftwork for Sale" tags="contract westfires brass-level silver-level" position="170,1280" size="100,100">(set: $clientGimmeItem to (either: &quot;Damage Ward&quot;, &quot;Love Potion&quot;, &quot;Shadow Threads&quot;, &quot;Ethereal Threads&quot;, &quot;Witch Bottle&quot;))
Your client desires a $clientGimmeItem.
(set: $encounterPayout to (min: (10 * (random: 0, 5) + 10 * $reputation&#39;s ($neighborhood&#39;s name)), 150))
They are willing to pay you $encounterPayout gold coins.
|input&gt;[
(if: $inventory contains $clientGimmeItem)[
(link-reveal: &quot;I Have One Right Here!&quot;)[(replace:?input)[(set: $currentContract to (passage:)&#39;s name)You hand over the $clientGimmeItem, and they hand over the cash.  No hassles.(set: $inventory to it - (ds: $clientGimmeItem))
(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $arg to $encounterPayout)(display: &quot;UpdateGold&quot;)
(display: &quot;Contract Fulfilled&quot;)]
]]

[[Reject-&gt;Explore the Neighborhood]] 
]</tw-passagedata><tw-passagedata pid="24" name="Encounter Gimme" tags="" position="3658,3621" size="100,100">&quot;Do you have the $clientGimmeItem?&quot; asks the (set: _char to $clientDescription)(display: &quot;DescribeChar&quot;).
(if: $inventory contains $clientGimmeItem)[(link-goto: &quot;Hand It Over&quot;, &quot;Next Encounter&quot;)]
[[Home Again]]</tw-passagedata><tw-passagedata pid="25" name="Mask of Memory" tags="unique contract gold-level westfires" position="172,1384" size="100,100">A cloaked figure approaches you with an awkward gait and an outstretched hand.  &quot;Please, I need an artificer.  It&#39;s to save my life!&quot;
(set: $encounterPayout to (min: (50 + 5 * $reputation&#39;s ($neighborhood&#39;s name)), 450))
I&#39;ll offer you $encounterPayout coins for your trouble.
The $clientDescription asks if you are a skilled artificer.  They have an enchantment designed that they need skilled hands to assemble.  Their own are weak and twisted and endlessly shake.

&quot;I desire an enchantment to be cast upon me by a skilled artificer.  Are you cunning enough?&quot; they ask.
|input&gt;[
(if: $cunning &gt; 4)[&quot;You are cunning enough, indeed.  Will you assist me?&quot;

(link-reveal: &quot;Accept&quot;)[ (replace:?input)[
(set: $currentContract to (passage:)&#39;s name)
(set: $clientGimmeItem to &quot;Ink of Enchantment&quot;)
(set: $encounterStack to (a: &quot;Encounter Gimme&quot;, &quot;Fulfilled: Mask of Memory&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 4)
&quot;What I need you to acquire is some $clientGimmeItem&quot;, they ask.
(if: $inventory contains $clientGimmeItem)[[[I Have One Right Here!-&gt;Encounter]]](else:)
[(link-goto: &quot;I&#39;ll Go Round One Up&quot;, (history:)&#39;s last)]]]

](else:)[&quot;No.  You are not.  Go refresh yourself and come back when you&#39;re ready.&quot;]


[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="26" name="Fulfilled: Mask of Memory" tags="" position="287,1393" size="100,100">You bring them the $clientGimmeItem, and they pass you a diagram on lambskin of the design they want you to tattoo on their forehead.
You perform the work well, and they reward you with the remaining Ink as well as 150 gold coins.
(if: $perception &lt; $enchantmentHidden)[When you look up from the bag of gold, your client has disappeared.]
(else:)[Before your very eyes, your client reaches up to their mask-like countenance.  They grab their face like it was mask, as if it had always been a mask.  A different face is beneath.  A younger face.  
Now, their body is no longer plagued and bent.  They are suddenly lithe and supple.
They are an Immortal, and you performed the enchantment.  You should be able to reproduce it.  If only you could remember the design.]
(set: $inventory to it + (ds: &quot;Ink of Enchantment&quot;))
(set: $encounterPayout to it + 150)
(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="27" name="Duel of Honor" tags="unique contract silver-level gold-level" position="169,1502" size="100,100">A minor noble&#39;s $clientDescription assistant approaches you with a hefty sack of gold coins to proxy in a duel of honor to the death.
(set: $encounterPayout to (min: (100 + 5 * $reputation&#39;s ($neighborhood&#39;s name)), 450))
&quot;I&#39;ll offer you $encounterPayout coins for your trouble.  Right away, right away!&quot;
|input&gt;[(link-reveal: &quot;Accept&quot;)[
(set: $currentContract to (passage:)&#39;s name)(replace:?input)[
It happens from time to time that some City noble picks a fight with someone they really shouldn&#39;t have and gets in over their heads.  For example, you loudly brag that you could defeat another noble in a duel, and they happened to overhear you in front of their entire retinue.  They have, of course, challenged you to a duel to the death that you accepted, because you are apparently a suicidal idiot.
However, a loophole in the Imperial Law allows you to have a champion as a proxy.  So, you&#39;ve been hired to be that champion/suicidal idiot fighting against a different proxy wizard.

(set: $encounterStack to (a: &quot;Encounter: Wizard Duel&quot;, &quot;Fulfilled: Duel of Honor&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 4)
(set: $contractCancelledOnDeath to 1)

[[FIGHT!-&gt;Encounter]]
]]

[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="28" name="Fulfilled: Duel of Honor" tags="" position="286,1505" size="100,100">You step over the smoldering body of your slain opponent and approach the noble for your pay.  They are too afraid of you to attempt any chicanery, so you end up with the whole amount plus a gratuity.
(set: $encounterPayout to it + 250)
(set: $inventory to it + (ds: &quot;Noble Cowl&quot;))
(set: $arg to 3)(display: &quot;UpdateReputation&quot;)

(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="29" name="Standard Exorcism" tags="contract westfires brass-level" position="169,1624" size="100,100">A (set: _char to $clientDescription)(display: &quot;DescribeChar&quot;) hands you an application for the Daemon cull that is occurring right now.  Any aethereal creatures you can trap or kill in a single day.
(set: $encounterPayout to 0)
&quot;You&#39;ll get about 3 coins for every beast you bag starting now,&quot; the client explains. &quot;But there&#39;s a sliding scale to reward culling several daemons in a row.  Performance bonuses from the City administration.&quot;

|input&gt;[
(replace:?input)[
(set: $currentContract to (passage:)&#39;s name)
Occasionally, daemons will rise up and start attacking mortals en masse.  No mortal is sure why this happens, and daemons won&#39;t explain.  They follow their own systems.  It is coincidence that our worlds intersect.
Wizards will be temporarily conscripted to trap and cull aethereals in a single area for a span of a single day.
{
(set: $encounterStack to (a: &quot;Call Off the Hunt&quot;, &quot;Encounter Select Random Daemon Encounter&quot;, &quot;EncounterRewind1or2&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 4)
(set: $contractCancelledOnDeath to 1)}

[[Tally Ho!-&gt;Encounter]]]

[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="30" name="Fulfilled: Standard Exorcism" tags="" position="286,1629" size="100,100">You turn in your card to the (print: $clientDescription&#39;s profession).
(set: $encounterPayout to (pow: 2, $encounterLength))
They hand you (print: $encounterPayout) gold coins and point the way out.
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="31" name="Encounter: Graceful Exit" tags="" position="3776,3613" size="100,100">You don&#39;t have to go any further.  You could finish this right now.  No one will be offended if you bowed out.

[[Next Encounter]] 

[[Contract Fulfilled]]</tw-passagedata><tw-passagedata pid="32" name="Cancel Contract" tags="" position="3705,3164" size="100,100">|clock&gt;[]
You can&#39;t hack it.  You&#39;ll lose some face but at least it won&#39;t cost your life.

{(set: $encounterStack to (a:))
(set: $encounterIndex to 0)
(set: $currentContract to &quot;&quot;)
(set: $currentContractStatus to 0)
(set: $encounterPayout to 0)
(set: $encounterLength to 0)}
(set: $arg to -2)(display: &quot;UpdateReputation&quot;)

[[Home Again]] with your tail between your legs.
(replace:?clock)[(display: &quot;Clock&quot;)]</tw-passagedata><tw-passagedata pid="33" name="Bagging the Bagman" tags="unique contract westfires silver-level gold-level" position="167,1739" size="100,100">A (set: _char to $clientDescription)(display: &quot;DescribeChar&quot;) approaches you with a proposal:
Intercept Begoudoum the Bagman
Get his package one way or the other
Bring it to your client

Begoudoum is a strong opponent who won&#39;t give up his goods easily.

(set: $encounterPayout to (min: (50 + 5 * $reputation&#39;s ($neighborhood&#39;s name)), 650))
I&#39;ll offer you $encounterPayout coins for your trouble.
|input&gt;[(link-reveal: &quot;Accept&quot;)[(replace:?input)[
(set: $currentContract to (passage:)&#39;s name)(set: $remainingPuzzleAttempts to 2)
Bagadoum is an Ifriti magician who runs special deliveries for the underlord of West Fires.
You are to intercept him during a delivery and divest him of his package.
Then, you are to return the package to an agent in the North Harbor.
{
(set: $encounterStack to (a: &quot;Encounter: Thug&quot;, &quot;Encounter Select Random Daemon Encounter&quot;, &quot;Encounter: Shortcut&quot;, &quot;EncounterRewind1or2&quot;,
&quot;Encounter: Shortcut&quot;, &quot;Encounter Select Random Daemon Encounter&quot;, &quot;Encounter: Shortcut&quot;, &quot;EncounterRewind1or2&quot;,&quot;Encounter: Wizard Duel&quot;,&quot;Take a Peek in the Package?&quot;,&quot;Fulfilled: Bagging the Bagman&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 5)}

[[Tally Ho!-&gt;Encounter]]

[[Home Again]] To Prepare

(link-goto: (history:)&#39;s last)
]]
[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="34" name="Fulfilled: Bagging the Bagman" tags="" position="288,1735" size="100,100">(if: $remainingPuzzleAttempts &lt;= 0)[
As soon as you hand over the package, they notice that you&#39;ve tampered with it.  They are angry enough to kill you, but they are honorable beings.  They throw your payment on the ground.
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;

(display: &quot;An Embarassing Display&quot;)
]
(else:)[
You hand over the package, unopened.  The (set: _char to $clientDescription)(display: &quot;DescribeChar&quot;) takes the package and examines both the embossed wax seal as well as a set of of unmolested trap enchantments.  Of course you didn&#39;t mess with the package: that wasn&#39;t part of the deal.
(set: $gold to it + $encounterPayout)
They hand you (print: $encounterPayout) gold coins and make a polite gesture as they leave out the back.
(set: $arg to 3)(display: &quot;UpdateReputation&quot;)
]
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="35" name="Contract Status" tags="" position="3723,2177" size="100,100">(if: $currentContract is not &quot;&quot; and $currentContractStatus is 0)[[[Continue Contract-&gt;Encounter]] : $currentContract
(display: &quot;Description &quot; + $currentContract)
](else-if: $currentContract is not &quot;&quot;)[(link-goto: &quot;Start the Contract&quot;, $currentContract) : $currentContract
(display: &quot;Description &quot; + $currentContract)]</tw-passagedata><tw-passagedata pid="36" name="Class Warfare" tags="contract easternfortress brass-level" position="166,1848" size="100,100">Two rival schools of spellcraft are in a rivalry that has recently boiled over.  Each school has called in their own brute squad.
You have been elected to be a member of a goon squad to smash members of a rival Arcane College&#39;s student body.  They will likely do the same to you.
For every student wizard you wreck, you&#39;ll get a payout.
|input&gt;[(link-reveal: &quot;Accept&quot;)[(replace:?input)[
(set: $currentContract to (passage:)&#39;s name)
 You are issued a copy of &quot;Ex Nobilis Aetherium&quot;, which is a sophomore year text on capturing and containing daemons, in order to prove that you are a student in case the police question why a group of hardened sociopaths is hanging around a campus estate.
{(set: $encounterPayout to 0)(set: $arg to &quot;Ex Nobilis Aetherium&quot;)(display: &quot;GetItem&quot;)
(set: $encounterStack to (a: &quot;Encounter: Wizard Duel&quot;, &quot;Encounter: Shortcut&quot;,&quot;EncounterRewind1or2&quot;,&quot;Fulfilled: Class Warfare&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 5)
(set: $contractCancelledOnDeath to 1)}

[[Tally Ho!-&gt;Encounter]]

[[Home Again]] To Prepare

(link-goto: (history:)&#39;s last)]]

[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="37" name="Shopping Trip to South Quarry" tags="contract unique westfires silver-level gold-level" position="162,1966" size="100,100">Your client needs an escort to South Quarry right away, as their financial situation right now is... complicated.

Not to worry you, though, because for you, they will pay in cash.

(set: $encounterPayout to (min: (50 + 5 * $reputation&#39;s ($neighborhood&#39;s name)), 250))

They will pay you $encounterPayout for your help.
|input&gt;[(link-reveal: &quot;Accept&quot;)[(replace:?input)[

(set: $currentContract to (passage:)&#39;s name)
Your client wants you to escort them to South Quarry for a shopping spree.
They are semi-famous (for the wrong reasons) and may need protection.  That&#39;s where you come in.  You will keep them safe during their journey and get a ride to South Quarry out of the deal.

(set: $encounterStack to (a: &quot;Encounter Random Color&quot;, &quot;Encounter: Enchantment Trap&quot;, &quot;Encounter: Fire Ghost&quot;, &quot;Encounter: Thug&quot;, &quot;Fulfilled: Shopping Trip to South Quarry&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 1)
(set: $contractCancelledOnDeath to 1)
[[Let&#39;s Go!-&gt;Encounter]]]]

[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="38" name="Nest of Box Adders" tags="contract" position="161,2077" size="100,100">(set: $currentContract to (passage:)&#39;s name)
You are handed an elaborate hardwood box traced with silvery sigils of power.  It is a box protected with Enchantment Locks, which are strong and deadly.
{
(set: $encounterStack to (a: &quot;Encounter: Enchantment Trap Lock&quot;, &quot;Encounter: Aura of Illusion&quot;,
&quot;Encounter: Enchantment Trap Lock&quot;, &quot;Encounter: Aura of Illusion&quot;,
&quot;Encounter: Enchantment Trap Lock&quot;, &quot;Encounter: Aura of Illusion&quot;,
&quot;Encounter: Enchantment Trap Lock&quot;, &quot;Encounter: Aura of Illusion&quot;,
&quot;Encounter: Enchantment Trap Lock&quot;, &quot;Encounter: Aura of Illusion&quot;,
&quot;Encounter: Enchantment Trap Lock&quot;, &quot;Encounter: Aura of Illusion&quot;,
&quot;Encounter: Enchantment Trap Lock&quot;, &quot;Encounter: Aura of Illusion&quot;,
&quot;Encounter: Enchantment Trap Lock&quot;, &quot;Encounter: Aura of Illusion&quot;,
&quot;Encounter: Enchantment Trap Lock&quot;, &quot;Encounter: Aura of Illusion&quot;,
&quot;Encounter: Enchantment Trap Lock&quot;, &quot;Encounter: Aura of Illusion&quot;,
&quot;Encounter: Enchantment Trap Lock&quot;, &quot;Encounter: Aura of Illusion&quot;,
&quot;Encounter: Enchantment Trap Lock&quot;, &quot;Encounter: Aura of Illusion&quot;

,&quot;Fulfilled: Nest of Box Adders&quot;, &quot;Hidden Treasure: Nest of Box Adders&quot;))
(set: $encounterIndex to 1)
(set: $danger to 1)
(set: $enchantmentHidden to 1)}
(set: $contractCancelledOnDeath to 1)
[[Tally Ho!-&gt;Encounter]]

[[Home Again]] To Prepare

(link-goto: (history:)&#39;s last)</tw-passagedata><tw-passagedata pid="39" name="The Shadow Heist" tags="unique contract gold-level westfires" position="677,2187" size="100,100">(set: $currentContract to (passage:)&#39;s name)
Your client wants you to crack into the Shadow Vault, a safehouse of legend where the most dangerous items in the world are kept away when they cannot be destroyed or are too valuable to be destroyed.

(set: $encounterStack to (a: &quot;Encounter Random Color&quot;, &quot;Encounter: Enchantment Trap&quot;, &quot;Encounter: Fire Ghost&quot;, &quot;Encounter: Thug&quot;, &quot;Fulfilled: The Shadow Heist&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 1)
[[Begin!-&gt;Encounter]]
(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="40" name="Plant A Spying Eye" tags="uppercastlerock contract silver-level" position="167,2294" size="100,100">Your client wants you to plant a trinket in an unobtrusive place in a powerful dignitaries home.  They can&#39;t be seen doing it, so they&#39;re hiring you to do the necessary.  The dignitary themselves is not at home right now.
|input&gt;[(link-reveal: &quot;Accept&quot;)[(replace:?input)[
(set: $currentContract to (passage:)&#39;s name)
{(set: $encounterPayout to (min: (100 + 10 * $reputation&#39;s ($neighborhood&#39;s name)), 500))
(set: $encounterStack to (a: &quot;Encounter Random Color&quot;, &quot;Encounter: Enchantment Trap&quot;, &quot;Encounter: Fire Ghost&quot;, &quot;Encounter: Thug&quot;, &quot;Fulfilled: Plant A Spying Eye&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 1)
(set: $contractCancelledOnDeath to 1)}
[[Get to Work!-&gt;Encounter]]]]

[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="41" name="Crack the Vault" tags="easternfortress contract silver-level gold-level" position="165,2405" size="100,100">The client would like you to take point on liberating some treasure from one of the minor vaults in the Fortress.

|input&gt;[(link-reveal: &quot;Accept&quot;)[(replace:?input)[
(set: $currentContract to (passage:)&#39;s name)
(set: $contractCancelledOnDeath to 1)

[[Let&#39;s Get to Work-&gt;Vault Heist]]
]]

[[Reject-&gt;Explore the Neighborhood]] 
]</tw-passagedata><tw-passagedata pid="42" name="Steal a Package" tags="westfires easternfortress lowerdepths contract brass-level" position="165,2518" size="100,100">|input&gt;[(link-reveal: &quot;Accept&quot;)[(replace:?input)[
(set: $currentContract to (passage:)&#39;s name)
{(set: $encounterPayout to (min: (100 + 10 * $reputation&#39;s ($neighborhood&#39;s name)), 500))
(set: $encounterStack to (a: &quot;Encounter Random Color&quot;, &quot;Encounter: Thug&quot;, (either: &quot;Encounter: Enchantment Trap&quot;, &quot;Encounter Random Color&quot;), &quot;Fulfilled: Steal a Package&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 1)
(set: $contractCancelledOnDeath to 1)}
[[Get to Work!-&gt;Encounter]]]]

[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="43" name="Tamper with Evidence" tags="westfires contract brass-level" position="172,2630" size="100,100">You&#39;ve got to get into the local Magistrate&#39;s office and alter a fingerprint on a morphine ampoule.

(set: $encounterPayout to (min: (100 + 10 * $reputation&#39;s ($neighborhood&#39;s name)), 750))
|input&gt;[(link-reveal: &quot;Accept&quot;)[(replace:?input)[
(set: $currentContract to (passage:)&#39;s name)
(set: $encounterStack to (a: &quot;Encounter: Corrupt Guard&quot;, &quot;Fulfilled: Tamper with Evidence&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 1)
(set: $contractCancelledOnDeath to 1)
[[Begin!-&gt;Encounter]]
]]
[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="44" name="Erase My Enemy" tags="uppercastlerock lowerdepths contract brass-level silver-level" position="174,2739" size="100,100">|input&gt;[
(link-reveal: &quot;Accept&quot;)[(replace:?input)[

(set: $currentContract to (passage:)&#39;s name)
Your client wants you erase an enemy of theirs.  It&#39;s like an assassination, but the victim will never have existed.  Your employer will put the payout in a temporal escrow enchantment so that when they don&#39;t remember having hired you, because the target of their hit no longer exists, you&#39;ll still get paid.

(set: $encounterPayout to (min: (100 + 10 * $reputation&#39;s ($neighborhood&#39;s name)), 900))
(set: $encounterStack to (a: &quot;Encounter Random Color&quot;, &quot;Encounter: Enchantment Trap&quot;, &quot;Encounter: Fire Ghost&quot;, &quot;Encounter: Thug&quot;, &quot;Fulfilled: Erase My Enemy&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 1)
[[Chase After Him!-&gt;Encounter]]
]]
[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="45" name="Prison Break" tags="southquarry contract silver-level" position="181,2961" size="100,100">|input&gt;[(link-reveal: &quot;Accept&quot;)[(replace:?input)[
(set: $currentContract to (passage:)&#39;s name)
(set: $encounterPayout to (min: (300 + 30 * $reputation&#39;s ($neighborhood&#39;s name)), 1500))
(set: $encounterStack to (a: &quot;Encounter Random Color&quot;, &quot;Encounter: Enchantment Trap&quot;, &quot;Encounter: Fire Ghost&quot;, &quot;Encounter: Thug&quot;, &quot;Fulfilled: Jailbreak&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 1)
(set: $contractCancelledOnDeath to 1)
[[Chase After Him!-&gt;Encounter]]

]]
[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="46" name="Jailbreak" tags="southquarry contract brass-level" position="176,2851" size="100,100">|input&gt;[(link-reveal: &quot;Accept&quot;)[(replace:?input)[
(set: $currentContract to (passage:)&#39;s name)
(set: $encounterPayout to (min: (300 + 30 * $reputation&#39;s ($neighborhood&#39;s name)), 1500))
(set: $encounterStack to (a: &quot;Encounter Random Color&quot;, &quot;Encounter: Enchantment Trap&quot;, &quot;Encounter: Fire Ghost&quot;, &quot;Encounter: Thug&quot;, &quot;Fulfilled: Jailbreak&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 1)
(set: $contractCancelledOnDeath to 1)
[[Chase After Him!-&gt;Encounter]]

]]
[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="47" name="Soul Jar Break" tags="southquarry easternfortress lowerdepths contract silver-level gold-level" position="180,3071" size="100,100">|input&gt;[(link-reveal: &quot;Accept&quot;)[(replace:?input)[
(set: $currentContract to (passage:)&#39;s name)
(set: $encounterPayout to (min: (300 + 30 * $reputation&#39;s ($neighborhood&#39;s name)), 1500))
(set: $encounterStack to (a: &quot;Encounter Random Color&quot;, &quot;Encounter: Enchantment Trap&quot;, &quot;Encounter: Fire Ghost&quot;, &quot;Encounter: Thug&quot;, &quot;Fulfilled: Jailbreak&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 1)
(set: $contractCancelledOnDeath to 1)
[[Chase After Him!-&gt;Encounter]]

]]
[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="48" name="Craft a Spellbook" tags="easternfortress uppercastlerock contract brass-level silver-level gold-level" position="181,3181" size="100,100">What a wizard does is constantly shaping the world around them to their will, altering threads of reality, reweaving or cutting where necessary.
You do not know &quot;spells&quot;, so much as you understand the seething skein of the Multiverse that surrounds us all.
However, the average Mortal cannot maintain such hypervigilance.  If they could, they&#39;d be wizards.  However, they can still perform magic: very specific effects for very specific conditions.
A mortal wishes for you to craft them a spell book with a handful of rituals for some minor effects.
- Get Ink of Enchantment
- Get Blank Scroll
- Get Ethereal Threads
|input&gt;[(link-reveal: &quot;Accept&quot;)[(replace:?input)[
(set: $currentContract to (passage:)&#39;s name)
(set: $encounterPayout to (min: (300 + 30 * $reputation&#39;s ($neighborhood&#39;s name)), 1500))
(set: $encounterStack to (a: &quot;Encounter Random Color&quot;, &quot;Encounter: Bring Your Client Spellbook Ingredients&quot;, &quot;Fulfilled: Craft a Spellbook&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 1)
(set: $contractCancelledOnDeath to 1)
(set: $contractRequirements to (a: &quot;Ink of Enchantment&quot;, &quot;Blank Scroll&quot;, &quot;Ethereal Threads&quot;))
[[Go Fetch!-&gt;Encounter]]

]]
[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="49" name="Matchmaker" tags="uppercastlerock westfires lowerdepths contract silver-level gold-level" position="183,3292" size="100,100">Your client wants you to perform enchantments and glamours on two young nobles so that they will marry and unite their houses in a strategic alliance.
|input&gt;[(link-reveal: &quot;Accept&quot;)[(replace:?input)[
(set: $currentContract to (passage:)&#39;s name)
(set: $encounterPayout to (min: (300 + 30 * $reputation&#39;s ($neighborhood&#39;s name)), 1500))
(set: $encounterStack to (a: &quot;Encounter Random Color&quot;, &quot;Encounter: Enchantment Trap&quot;, &quot;Encounter: Fire Ghost&quot;, &quot;Encounter: Thug&quot;, &quot;Fulfilled: Jailbreak&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 1)
(set: $contractCancelledOnDeath to 1)
[[Chase After Him!-&gt;Encounter]]

]]
[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="50" name="Matchbreaker" tags="easternfortress lowerdepths uppercastlerock contract brass-level silver-level" position="183,3394" size="100,100">Your client wants you to pretend to be a young noble&#39;s blind date and ruin the whole experience in order to ruin the potential relationship.

(set: $encounterTimeLimit to 15)
(set: $encounterLocation to (either: &quot;West Fires&quot;, &quot;North Harbor&quot;, &quot;Eastern Fortress&quot;, &quot;South Quarry&quot;, &quot;Lower Depths&quot;, &quot;Upper Castlerock&quot;))
(set: $encounterPayout to (min: (300 + 30 * $reputation&#39;s ($neighborhood&#39;s name)), 1500))
They want you to go to $encounterLocation within $encounterTimeLimit hours to visit with the young noble.
Then ruin the date.

|input&gt;[(link-reveal: &quot;Accept&quot;)[(replace:?input)[
(set: $currentContract to (passage:)&#39;s name)
(set: $encounterStack to (a:))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 1)
(set: $contractCancelledOnDeath to 1)

[[Home Again]]

(link-goto: (history:)&#39;s last)

]]
[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="51" name="Smuggle Your Client Out of the City" tags="westfires contract silver-level gold-level" position="184,3500" size="100,100">Your client wants you to escort them out of the city.
&quot;I can&#39;t be seen leaving!  They may send an assassin!&quot;

|input&gt;[(link-reveal: &quot;Accept&quot;)[(replace:?input)[
(set: $currentContract to (passage:)&#39;s name)
(set: $encounterPayout to (min: (300 + 30 * $reputation&#39;s ($neighborhood&#39;s name)), 1500))
(set: $encounterStack to (a: &quot;Encounter Random Color&quot;, &quot;Encounter: Enchantment Trap&quot;, &quot;Encounter: Fire Ghost&quot;, (either: &quot;Encounter: Thug&quot;, &quot;Encounter: Assassin&quot;), &quot;Fulfilled: Smuggle Your Client Out of the City&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 1)
(set: $contractCancelledOnDeath to 1)
[[Let Us Away!-&gt;Encounter]]

]]
[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="52" name="Professionals at the Card Table" tags="lowerdepths easterfortress contract brass-level silver-level" position="693,3573" size="100,100">(set: $currentContract to (passage:)&#39;s name)
You&#39;ve been invited to a card game.  It is strictly illegal.

(set: $encounterStack to (a: &quot;Encounter Random Color&quot;, &quot;Encounter: Card Sharks&quot;, &quot;Fulfilled: Professionals at the Card Table&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 1)
[[Let&#39;s Get Paid!-&gt;Encounter]]</tw-passagedata><tw-passagedata pid="53" name="Take a Dive" tags="westfires lowerdepths contract brass-level" position="188,3715" size="100,100">Your client wants you to take a dive in a wizard duel.  They promise you won&#39;t be killed or seriously maimed.

|input&gt;[(link-reveal: &quot;Accept&quot;)[(replace:?input)[
(set: $currentContract to (passage:)&#39;s name)
(set: $encounterPayout to (min: (300 + 30 * $reputation&#39;s ($neighborhood&#39;s name)), 1500))
(set: $encounterStack to (a: &quot;Encounter: Sparring Duel&quot;, &quot;Fulfilled: Take a Dive&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 1)
(set: $contractCancelledOnDeath to 1)
[[Let&#39;s Get It On!-&gt;Encounter]]

]]
[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="54" name="Lift a Curse" tags="easternfortress northharbor contract brass-level silver-level gold-level" position="185,3825" size="100,100">Your client wants you to remove a curse mark that has been placed upon them by their enemy.
|input&gt;[(link-reveal: &quot;Accept&quot;)[(replace:?input)[
(set: $currentContract to (passage:)&#39;s name)
(set: $encounterPayout to (min: (300 + 30 * $reputation&#39;s ($neighborhood&#39;s name)), 1500))
(set: $encounterStack to (a: &quot;Encounter Random Color&quot;, &quot;Encounter: Enchantment Trap&quot;, &quot;Encounter: Fire Ghost&quot;, &quot;Encounter: Thug&quot;, &quot;Fulfilled: Lift a Curse&quot;))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 1)
(set: $contractCancelledOnDeath to 1)
[[Chase After Him!-&gt;Encounter]]

]]
[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="55" name="Deliver a Package" tags="westfires easternfortress lowerdepths uppercastlerock contract brass-level" position="188,3934" size="100,100">(set: $encounterTarget to (shuffled: ...($neighborhood&#39;s locations))&#39;s 1st)
Your client wants you to carry a package to $encounterTarget.

|input&gt;[(link-reveal: &quot;Accept&quot;)[(replace:?input)[
{(set: $currentContract to (passage:)&#39;s name)(set: $encounterPayout to (min: (50 + 10 * $reputation&#39;s ($neighborhood&#39;s name)), 150))
(set: $encounterStack to (either: (a: &quot;Encounter Random Color&quot;, &quot;Encounter Random Color&quot;, &quot;Encounter Random Color&quot;, &quot;Fulfilled: Deliver a Package&quot;),(a: &quot;Encounter Random Color&quot;, &quot;Encounter Random Color&quot;, &quot;Encounter: Assassin&quot;, &quot;Fulfilled: Deliver a Package&quot;)))
(set: $encounterIndex to 1)
(set: $enchantmentHidden to 1)

(set: $contractCancelledOnDeath to 1)
}

[[Run Along!-&gt;Encounter]]

]]
[[Reject-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="56" name="Fulfilled: Class Warfare" tags="" position="281,1848" size="100,100">(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $encounterPayout to $encounterLength * (min: 45, 15 * $reputation&#39;s ($neighborhood&#39;s name)))
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;

(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="57" name="Fulfilled: Deliver a Package" tags="" position="296,3932" size="100,100">You deliver the package to the dead drop outside the (link-goto: $encounterTarget).
(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="58" name="Fulfilled: Lift a Curse" tags="" position="301,3822" size="100,100">(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="59" name="Fulfilled: Take a Dive" tags="" position="295,3714" size="100,100">(if: $reputation&#39;s ($neighborhood&#39;s name) &lt; $enchantmentHidden)[
(set: $arg to -1)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)]
(else:)
[
(display: &quot;Cancel Contract&quot;)
]</tw-passagedata><tw-passagedata pid="60" name="Description Professionals at the Card Table" tags="" position="577,3568" size="100,100">Professionals at the Card Table

(set: $encounterPayout to 0)

[[Accept-&gt;Professionals at the Card Table]] 

[[Reject-&gt;Explore the Neighborhood]]</tw-passagedata><tw-passagedata pid="61" name="Fulfilled: Professionals at the Card Table" tags="" position="806,3570" size="100,100">(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="62" name="Fulfilled: Smuggle Your Client Out of the City" tags="" position="303,3495" size="100,100">Once you&#39;ve escorted them past the last toll gate, a carriage with curtained windows is there to pick them up.  They swiftly pay you then depart.
(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="63" name="Fulfilled: Matchbreaker" tags="" position="301,3388" size="100,100">(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="64" name="Fulfilled: Matchmaker" tags="" position="298,3279" size="100,100">(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="65" name="Fulfilled: Craft a Spellbook" tags="" position="295,3173" size="100,100">(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="66" name="Fulfilled: Soul Jar Break" tags="" position="294,3063" size="100,100">(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="67" name="Fulfilled: Prison Break" tags="" position="295,2960" size="100,100">(set: $arg to 2)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="68" name="Fulfilled: Jailbreak" tags="" position="294,2851" size="100,100">(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="69" name="Fulfilled: Erase My Enemy" tags="" position="284,2743" size="100,100">(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="70" name="Fulfilled: Tamper with Evidence" tags="" position="290,2630" size="100,100">You spend a moment deciding whether to use illusion magic or hygromancy to change the fingerprint and decide the (either: &quot;former&quot;, &quot;latter&quot;) to be the best for this particular application.
I don&#39;t think anyone will end up on the wrong end of a gibbet over this business.
(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="71" name="Fulfilled: Steal a Package" tags="" position="290,2516" size="100,100">(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="72" name="Fulfilled: Crack the Vault" tags="" position="282,2404" size="100,100">(set: $arg to 2)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="73" name="Fulfilled: Plant A Spying Eye" tags="" position="278,2299" size="100,100">(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="74" name="Hextant" tags="item" position="5969,3471" size="100,100">This device is used to identify and trace ley lines.</tw-passagedata><tw-passagedata pid="75" name="Description The Shadow Heist" tags="" position="564,2192" size="100,100">The Shadow Heist

(set: $encounterPayout to (min: (100 + 10 * $reputation&#39;s ($neighborhood&#39;s name)), 1500))

[[Accept-&gt;The Shadow Heist]]

[[Reject-&gt;Explore the Neighborhood]]</tw-passagedata><tw-passagedata pid="76" name="Fulfilled: The Shadow Heist" tags="" position="796,2185" size="100,100">(set: $arg to 5)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="77" name="Fulfilled: Shopping Trip to South Quarry" tags="" position="270,1966" size="100,100">They blow you a kiss as they depart back to the smoke and cinders of the West Fires.

Stay for a while here in [[South Quarry]] 
(set: $arg to 1)(display: &quot;UpdateReputation&quot;)
(set: $gold to it + $encounterPayout)
&lt;b&gt;Gold + $encounterPayout&lt;/b&gt;
(display: &quot;Contract Fulfilled&quot;)</tw-passagedata><tw-passagedata pid="78" name="Fulfilled: Nest of Box Adders" tags="" position="281,2073" size="100,100">In the center of the nested puzzle boxes is a tangled, serpentine, venomous beast.  Think: asp meets rat king.
(display: &quot;Encounter Small Beast&quot;)</tw-passagedata><tw-passagedata pid="79" name="Void Contract" tags="" position="3700,3281" size="100,100">{(set: $encounterStack to (a:))
(set: $encounterIndex to 0)
(set: $currentContract to &quot;&quot;)
(set: $currentContractStatus to 0)
(set: $encounterPayout to 0)
(set: $encounterLength to 0)}</tw-passagedata><tw-passagedata pid="80" name="Call Off the Hunt" tags="" position="3511,3036" size="100,100">You don&#39;t have to go any further.  You could finish this right now.  No one will be offended if you bowed out.

[[Keep Going-&gt;Next Encounter]] 

[[Right, Let&#39;s Wrap It Up-&gt;Fulfilled: Standard Exorcism]]</tw-passagedata><tw-passagedata pid="81" name="Hidden Treasure: Nest of Box Adders" tags="" position="398,2075" size="100,100">Once the foul creature has been slain, you find inside of it the treasure that you sought:

(set: $inventory to it + (&quot;Universal Solvent&quot;))

(display: &quot;Contract Fulfilled&quot;)
[[Next Journey]]</tw-passagedata><tw-passagedata pid="82" name="Take a Peek in the Package?" tags="" position="410,1737" size="100,100">You went through such trouble to get this package.

It would be a shame if it were something more valuable than the mere lucre you&#39;d be getting otherwise.

What if it were something very special, like a Crystal Spyglass or a Lazarus Beacon charge?

[[I Must Know!-&gt;Encounter: Enchantment Trap Lock]] 

[[Let&#39;s Go Meet the Client-&gt;Next Encounter]]</tw-passagedata><tw-passagedata pid="83" name="Negotiate Contract" tags="" position="3700,3055" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="84" name="Encounter: Bring Your Client Spellbook Ingredients" tags="" position="413,3168" size="100,100">(set: $encounterIndex to it - 1)

(for: each _i, ...$contractRequirements)[(set: _ingredient to _i)I need _ingredient for this recipe. 
(if: $inventory contains _ingredient)[Do you have it for me?
(link-reveal: &quot;Give Them &quot; + _ingredient)[You hand them the _ingredient.
(set: $contractRequirements to it - (a: _ingredient))
(set: $arg to _ingredient)(display: &quot;LoseItem&quot;)
]]]

(event: when $contractRequirements&#39;s length &lt;= 0)[(set: $encounterIndex to it + 1) (replace:?input)[ [[Next Encounter]] ]]

|input&gt;[ [[Go Shopping-&gt;Explore the Neighborhood]] ]</tw-passagedata><tw-passagedata pid="85" name="GetDaemon" tags="function" position="4258,3239" size="100,100">//+ $arg//(set: $daemons to it + (ds: $arg))</tw-passagedata><tw-passagedata pid="86" name="Encounter Daemon" tags="" position="4276,3467" size="100,100">|output&gt;[]
|input&gt;[(display: &quot;DaemonShuffle&quot;)]

(event: when $enemyHealth &lt;= 0)[ (replace:?input)[ [[Next Encounter]] ]]</tw-passagedata><tw-passagedata pid="87" name="Buy a Daemon" tags="" position="4519,3220" size="100,100">The shopkeeper swaps your gold for a jar containing a $itemName.

(set: _pay to 100)
(set: $gold to it - _pay)
&lt;b&gt;Gold - _pay&lt;/b&gt;
(set: $daemons to it + (ds: $itemName))

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="88" name="Blood Sacrifice" tags="" position="5090,3377" size="100,100">You willingly shed your blood for them.(set: $deathReason to &quot;It looks like you bled too much for the sacrifice and have expired via exsanguination, the worst of the sanguinations.&quot;)
(set: $arg to (random: 0, 3))(display: &quot;TakeDamage&quot;)
[[Next Encounter]]</tw-passagedata><tw-passagedata pid="89" name="Bribe Daemon" tags="" position="5090,3479" size="100,100">(if: $enemyBribeType is &quot;Gold&quot;)[
You cast a purse full of gold to them.  (set: $gold to it - (random: 5, 10))(replace:?clock)[(display: &quot;RenderHeader&quot;)]  While they are distracted picking it up, you can silently walk away.
(display: &quot;An Embarassing Display&quot;)
[[Next Encounter]] 
](else:)[
(if: $inventory contains $enemyBribeType)[(set: $inventory to it - (ds: $enemyBribeType))They snatch the $enemyBribeType from your inventory and attempt to scarper.

[[Next Encounter]] 
]]</tw-passagedata><tw-passagedata pid="90" name="QuickBuyDaemon" tags="" position="5258,2460" size="100,100">(unless: $daemons contains _item)[_item
(display: _item)(set: _i1 to _item)(set: _i2 to _cost)  It will cost you _i2 gold.(if: $gold &gt;= _i2)[ You can afford it. (link-reveal-goto: &quot;Buy It&quot;, (passage:)&#39;s name)[(set: $daemons to it + (ds: _i1))(set: $gold to it - _i2)]
](else:)[ Quite a bit too rich for your blood.]]</tw-passagedata><tw-passagedata pid="91" name="DaemonShuffle" tags="" position="4272,3580" size="100,100">(set: _weapons to (find: _item where (passage: _item)&#39;s tags contains &quot;magic-weapon&quot;, ...$inventory))
(set: $options to $options + (altered: _weapon via &quot;Use &quot; + _weapon, ..._weapons))
(set: $options to $options + (altered: _item via &quot;Release &quot; + _item, ...$daemons))
(if: $options&#39;s length &lt;= 0)[]
(else-if: $options&#39;s length &gt; 1)[
(set: $options to (shuffled: ...$options))]
(else:)[]

(replace:?input)[(if: $options&#39;s length &gt; 0)[(for: each _i, ...(range: 1, (min: $cunning, $options&#39;s length)))[
(set: _item to ($options&#39;s (_i)))
(link-reveal: _item)[(replace:?output)[(display: _item)
]]]

(link-reveal: &quot;Shuffle&quot;)[(replace:?output)[You are whipped and beaten by the force of your foe as you prepare for another assault.(set: $arg to (random: 0,1))(display: &quot;TakeDamage&quot;)(set: $options to (a:))(display: &quot;DaemonShuffle&quot;)
]]](else:)[
[[Succumb-&gt;Death]] 
]]</tw-passagedata><tw-passagedata pid="92" name="Shadowling Swarm" tags="daemon-description" position="4508,4235" size="100,100">The combined mass of shadow daemons, maybe even shreds of half-living shadow creatures, is itself a combined creature, like a Portuguese Man O&#39;War, but one that devours the essential vitality out of its victims&#39; souls.</tw-passagedata><tw-passagedata pid="93" name="Encounter: Shadowling Swarm" tags="daemon lowerdepths event" position="4392,4234" size="100,100">A Shadowling Swarm envelops you in razor-sharp darkness.  You have but a few moments...

{(set: $enemyType to &quot;Shadowling Swarm&quot;)
(set: $deathReason to &quot;The strangulating effects of the Shadowling Swarm&#39;s tentacles don&#39;t seem to affect your oxygen or bloodflow but something apparently even more essential, until your body is an empty shell that flops to the ground.&quot;)
(set: $enemyHealth to 5)
(set: $enemyElementType to &quot;shadow&quot;)
(set: $options to (a: &quot;Blood Sacrifice&quot;))
(if: $inventory contains &quot;Slice of Silver&quot;)[ (set: $options to $options + (a: &quot;Bribe Daemon&quot;))
]
(if: $inventory contains &quot;Cellar of Salt&quot; and (history:) contains &quot;Read Ex Nobilis Aetherium&quot; and $cunning &gt;= 5)[ (set: $options to $options + (a: &quot;Capture Shadowling Swarm&quot;))
]
}
(display: &quot;Encounter Daemon&quot;)</tw-passagedata><tw-passagedata pid="94" name="Capture Shadowling Swarm" tags="" position="4722,4232" size="100,100">You quickly dash out a design on the ground that is intended to bind the shadow within.
(if: (random: 0, 6) is 0)[You use up the last of your Cellar of Salt doing it.  (set: $inventory to it - (ds: &quot;Cellar of Salt&quot;))]
(if: $inventory contains &quot;Soul Jar&quot;)[
   You attempt to capture it with your Soul jar,
   (if: $cunning &gt; 3)[ and succeed in entrapping a Living Shadow, part of the swarm. 
   (set: $daemons to it + (ds: &quot;Living Shadow&quot;))
   (set: $inventory to it - (ds: &quot;Soul Jar&quot;))(set: $arg to 2)(display: &quot;DealDamage&quot;) ]
   (else:)[ but you are unable to predict its movements, and it shreds you with what feels like thousands of razor-sharp tentacles.
   (set: $arg to (random: 1,2))(display: &quot;TakeDamage&quot;)]
]
(else:)[You didn&#39;t bring a Soul Jar!

In retaliation, it shreds you with what feels like thousands of razor-sharp tentacles.
   (set: $arg to (random: 1,2))(display: &quot;TakeDamage&quot;)]</tw-passagedata><tw-passagedata pid="95" name="Living Shadow" tags="daemon-description" position="4511,3333" size="100,100">An ethereal creature made of living shadow.  Is so utterly thin that it can slice through the flesh of their victims.
They don&#39;t appear to eat anything, but their victim&#39;s bodies are always about (random: 3, 12) pounds lighter than they were when they were still alive.</tw-passagedata><tw-passagedata pid="96" name="Release Living Shadow" tags="" position="4836,3333" size="100,100">(set: $dieroll to (random: 0, 6))
(if: $inventory contains &quot;Rack of Torment&quot;)[(set: $dieroll to it - 1)]

(if: $enemyType is not &quot;Shadow&quot;)[
(if: $dieroll &gt; 4)[The shadow daemon takes the opportunity to scarper!(set: $daemons to it - (ds: &quot;Living Shadow&quot;))
(set: $arg to (either: 0, 1, 1, 2))(if: $arg &gt; 0)[It brushes past your opponent on the way out.
(display: &quot;DealDamage&quot;)]
]
(else:)[
The living shadow lashes out at the enemy!  You pull it back into its Soul Jar for next time.(set: $arg to 2)(display: &quot;DealDamage&quot;)]](else:)[You release the shadow daemon, and it merges with its kin.(set: $enemyHealth to it + 2)(set: $daemons to it - (ds: &quot;Living Shadow&quot;))
]</tw-passagedata><tw-passagedata pid="97" name="Capture Fire Ghost" tags="" position="4718,3655" size="100,100">(if: $inventory contains all of (a: &quot;Soul Jar&quot;, &quot;Clump of Coal&quot;))[
(set: $arg to &quot;Clump of Coal&quot;)(display: &quot;LoseItem&quot;))
You throw a clump of coal to the ground.  When the Fire Ghost attempts to grab it, you attempt to pull it into your Soul Jar.
(if: (random: 0, $cunning) &gt; 3)[With an audible //shlorp//, you trap the Fire Ghost in the Soul Jar.(set: $daemons to it + (ds: &quot;Fire Ghost&quot;))
   (set: $inventory to it - (ds: &quot;Soul Jar&quot;))
   [[Next Encounter]] 
   ](else:)[ but you are unable to predict its movements.]
](else:)[You try to capture the Fire Ghost, but you need a Soul Jar and a Clump of Coal!]</tw-passagedata><tw-passagedata pid="98" name="Encounter: Fire Ghost" tags="daemon event westfires" position="4403,3655" size="100,100">A Fire Ghost blocks your path.  It locks its gaze with you and begins charging for an attack.  You have a few moments...
{(set: $enemyType to &quot;Fire Ghost&quot;)
(set: $deathReason to &quot;You are unable to make any more gestures of combat magic, as your very flesh has been consumed by the daemon&#39;s flames.  It is not quick, but at least it is incredibly painful.&quot;)
(set: $enemyHealth to 3)
(set: $enemyElementType to &quot;fire&quot;)
(set: $enemyBribeType to &quot;Clump of Coal&quot;)
(set: $options to (a:))
(if: $rumors contains &quot;Fire Ghosts Crave Coal&quot; and $inventory contains &quot;Clump of Coal&quot;)[(set: $options to it + (a: &quot;Bribe Daemon&quot;))
(if: $inventory contains all of (a: &quot;Soul Jar&quot;, &quot;Clump of Coal&quot;) and $cunning &gt; 3)[ (set: $options to it + (a: &quot;Capture Fire Ghost&quot;))]]}
(display: &quot;Encounter Daemon&quot;)</tw-passagedata><tw-passagedata pid="99" name="ExamineDaemon" tags="" position="4408,3222" size="100,100">(display: $itemName)
(link-undo: &quot;Back&quot;)</tw-passagedata><tw-passagedata pid="100" name="Sell a Daemon" tags="" position="4626,3221" size="100,100">The shopkeeper swaps your full Soul Jar for another that contains a handful of gold.
(set: _pay to (random: 2, 3) * ($reputation&#39;s ($neighborhood&#39;s name) + 1))
(set: $gold to it + _pay)
&lt;b&gt;Gold + _pay&lt;/b&gt;
(set: $inventory to it + (ds: &quot;Soul Jar&quot;))
(set: $daemons to it - (ds: $itemName))

(link-goto: &quot;Continue Browsing for Daemons&quot;, (history:)&#39;s last) 

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="101" name="Solar Spark" tags="daemon-description" position="4504,3441" size="100,100">These creatures appear to be mindlessly drifting through the air.  Sages argued endlessly about whether they are even alive or are a phenomena of the weather.

(if: $perception &gt; 7)[But a studious observer will note that they are actually performing exceedingly complicated math using the language of their movement.  The ultimate purpose behind the calculation is beyond you.]</tw-passagedata><tw-passagedata pid="102" name="Release Solar Spark" tags="" position="4840,3449" size="100,100">The Solar Spark sweeps away from the Soul Jar and leaves a wake of glowing, ionized air.

(set: $daemons to it - (ds: &quot;Solar Spark&quot;))
(set: $inventory to it + (ds: &quot;Soul Jar&quot;))
(if: $isDay)[(set: $arg to 5)(display: &quot;DealDamage&quot;)]
(else:)[(set: $arg to 2)(display: &quot;DealDamage&quot;)]</tw-passagedata><tw-passagedata pid="103" name="Encounter: Solar Spark" tags="daemon event uppercastlerock" position="4396,3440" size="100,100">You see a delicate collection of golden orbs hovering in the sun-dappled air.  They bob with maddening regularity, but just when you start to be able to predict their movements, the pattern changes to something entirely new.
{(set: $enemyType to &quot;Solar Spark&quot;)(set: $enemyHealth to 4)
(set: $deathReason to &quot;You accidentally stumbled into a convergence of all of the orbs in the Solar Spark into a pattern later referred to as Hell&#39;s Blender.  Bits of you are in a shrub.&quot;)
(set: $enemyElementType to &quot;holy&quot;)
(set: $enemyBribeType to &quot;None&quot;)
(set: $options to (a: &quot;Dodge Solar Spark&quot;))
(if: $inventory contains &quot;Soul Jar&quot;)[ (set: $options to $options + (a: &quot;Capture Solar Spark&quot;)) ]
}
(display: &quot;Encounter Daemon&quot;)</tw-passagedata><tw-passagedata pid="104" name="Capture Solar Spark" tags="" position="4728,3446" size="100,100">(if: $cunning + $perception &gt; (random: 5, 9))
[You deftly place the opening of the Soul Jar right where you predict it will be by the time you get there.  Then you just slide the lid back on and latch it in place.(set: $inventory to it - (ds: &quot;Soul Jar&quot;))(set: $daemons to it + (ds: &quot;Solar Spark&quot;))

[[Next Encounter]] 
]
(else:)
[You try grabbing at the Solar Spark, but you cannot predict its movements.  It nearly cauterizes off your most favorite thumb before you give up the chase.
(set: $arg to 1)(display: &quot;TakeDamage&quot;)
(if: $health &gt; 0)
[
[[Next Encounter]] 
]
(else:)
[It didn&#39;t hurt much, but the damned thing must have cut across something even more important than your thumb.
It was too much for your weakened form, and you succumb to [[Death]]]]</tw-passagedata><tw-passagedata pid="105" name="Dodge Solar Spark" tags="" position="4617,3445" size="100,100">(if: $perception + $cunning &gt; 6)[ 
You make your best guess about where the Spark will go next, and you manage to pass through with the slightest scorching of your topcoat. ](else:)[
As you walk past, the Solar Spark streaks right through you, leaving behind a searing trail and a vague smell of cooked pork.(set: $deathReason to &quot;The Solar Spark randomly penetrated an incredibly vital organ, and you expire with smell of cooked pork in your nostrils.&quot;)
(set: $arg to 1)(display: &quot;TakeDamage&quot;)
(if: $health &gt; 0)
[
You survive the superheated insult and move on.
]]

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="106" name="Fire Ghost" tags="daemon-description" position="4514,3656" size="100,100">A greedy creature made of fire that only loves to burn.  Becomes deliriously elated while devouring rich, delicious coal.</tw-passagedata><tw-passagedata pid="107" name="Release Fire Ghost" tags="" position="4831,3656" size="100,100">(if: $enemyType is &quot;Fire Ghost&quot;)
[
The two Fire Ghosts merge and become a larger Fire Ghost!
(set: $enemyHealth to 6)
(set: $daemons to it - (ds: &quot;Fire Ghost&quot;))
]
(else-if: $enemyType is &quot;fire&quot;)
[
The daemon refuses to attack!
(set: _dieroll to (random: 0, 6))
(if: $inventory contains &quot;Rack of Torment&quot;)[(set: _dieroll to it - 1)]
(if: _dieroll &gt; 3)[The daemon takes the opportunity to scarper!(set: $daemons to it - (ds: &quot;Fire Ghost&quot;))
]]
(else:)
[
(set: _dieroll to (random: 0, 6))
(if: $inventory contains &quot;Rack of Torment&quot;)[(set: _dieroll to it - 1)]
(if: _dieroll &gt; 3)[The daemon takes the opportunity to scarper!(set: $daemons to it - (ds: &quot;Fire Ghost&quot;))
]
(else:)[The daemon lashes out at the enemy!  You pull it back into its Soul Jar for next time. (set: $arg to 2 + (random: -1,1))(display: &quot;DealDamage&quot;)
]
]</tw-passagedata><tw-passagedata pid="108" name="Encounter: Living Shadow" tags="daemon lowerdepths event" position="4401,3331" size="100,100">A Living Shadow slips a loop of its shadow matter around your neck.  You have but a few moments...

{(set: $enemyType to &quot;Living Shadow&quot;)
(set: $deathReason to &quot;The strangulating effects of the Living Shadow&#39;s tentacles don&#39;t seem to affect your oxygen or bloodflow but something apparently even more essential, until your body is an empty shell that flops to the ground.&quot;)
(set: $enemyHealth to 3)
(set: $enemyElementType to &quot;shadow&quot;)
(set: $options to (a: &quot;Blood Sacrifice&quot;))
(if: $inventory contains &quot;Slice of Silver&quot;)[ (set: $options to $options + (a: &quot;Bribe Daemon&quot;))
]
(if: $inventory contains &quot;Cellar of Salt&quot; and (history:) contains &quot;Read Ex Nobilis Aetherium&quot; and $cunning &gt; 5)[ (set: $options to $options + (a: &quot;Capture Living Shadow&quot;))
]
}
(display: &quot;Encounter Daemon&quot;)</tw-passagedata><tw-passagedata pid="109" name="Capture Living Shadow" tags="" position="4729,3332" size="100,100">You quickly dash out a design on the ground that is intended to bind the shadow within.
(if: (random: 0, 6) is 0)[You use up the last of your Cellar of Salt doing it.  (set: $inventory to it - (ds: &quot;Cellar of Salt&quot;))]
(if: $inventory contains &quot;Soul Jar&quot;)[
   You attempt to capture it with your Soul jar,
   (if: $cunning &gt; 3)[ and succeed in entrapping a Living Shadow. 
   (set: $daemons to it + (ds: &quot;Living Shadow&quot;))
   (set: $inventory to it - (ds: &quot;Soul Jar&quot;)) ]
   (else:)[ but you are unable to predict its movements, and it slips between some cracks in the pavement.]
]
(else:)[It slips between some cracks in the pavement.]
[[Next Encounter]]</tw-passagedata><tw-passagedata pid="110" name="Rattle Bones" tags="daemon-description" position="4510,3544" size="100,100">This beast is an assemblage of skeletons, goat skulls, yarrow sticks, and scratched old coins.
When it gets riled up, it begins to spin around in a vortex.
It gets far more dangerous if it catches fire.
It cannot withstand compasses.  They make it impossible for it to move.</tw-passagedata><tw-passagedata pid="111" name="Encounter: Rattle Bones" tags="daemon event easternfortress" position="4403,3545" size="100,100">A loose collection of bones and mechanical detritus swirls up before you into a crude mockery of a man.
{(set: $enemyType to &quot;Rattle Bones&quot;)
(set: $deathReason to &quot;Long after your body is lifeless, the restless Rattle Bones continues to pelt it.  Once your corpse has been completely ruined, the daemon selects a single piece of your bone and adds it to its collection.&quot;)
(set: $enemyHealth to 7)
(set: $enemyElementType to &quot;bone&quot;)
(if: $inventory contains any of (a: &quot;Compass of Many Places&quot;, &quot;Lodestone&quot;))[(set: $enemyHealth to (ceil: it / 2))]
(set: $options to (a: &quot;Blood Sacrifice&quot;))
(if: $inventory contains &quot;Piece of Pitch&quot;)[ (set: $options to $options + (a: &quot;Bribe Daemon&quot;))
]
(if: $inventory contains &quot;Piece of Pitch&quot; and (history:) contains &quot;Read Ex Nobilis Aetherium&quot; and $cunning &gt; 5)[ (set: $options to $options + (a: &quot;Capture Rattle Bones&quot;))

]}
(set: _options to $options)(display: &quot;Encounter Daemon&quot;)</tw-passagedata><tw-passagedata pid="112" name="Release Rattle Bones" tags="" position="4835,3551" size="100,100">(set: $dieroll to (random: 0, 6) - ((count: (a: ...$inventory), &quot;Rack of Torment&quot;, &quot;Compass of Many Places&quot;, &quot;Lodestone&quot;)))
(if: $dieroll &gt; 4)[The daemon takes the opportunity to scarper!(set: $daemons to it - (ds: &quot;Rattle Bones&quot;))
]
(else:)[The daemon lashes out at the enemy!  You pull it back into its Soul Jar for next time. (set: $arg to 1)(display: &quot;DealDamage&quot;)
(if: $enemyElementType is &quot;fire&quot;)[Contact with its fiery foe has engulfed it in flames.  It shrivels into blackened ruins and ash.(set: $daemons to it - (ds: &quot;Rattle Bones&quot;))]
]</tw-passagedata><tw-passagedata pid="113" name="Golem" tags="daemon-description" position="4506,3780" size="100,100">A creature of clay, with an inscription on parchment tucked in its mouth animating it with murderous purpose.</tw-passagedata><tw-passagedata pid="114" name="Release Golem" tags="" position="4824,3769" size="100,100">You send the golem forth, with the name of your enemy written in its mouth.</tw-passagedata><tw-passagedata pid="115" name="Gnome" tags="daemon-description" position="4506,3899" size="100,100">An elemental creature of earth and rock, crudely assembled into a hominid form.</tw-passagedata><tw-passagedata pid="116" name="Capture Golem" tags="" position="4715,3764" size="100,100">You write down an unprocessable paradoxical statement on a bit of parchment and launch it down the golem&#39;s maw, rendering it pliant.  It willingly follows you around.

(set: $arg to &quot;Ink of Enchantment&quot;)(display: &quot;LoseItem&quot;)
(set: $arg to &quot;Blank Scroll&quot;)(display: &quot;LoseItem&quot;)
(set: $daemons to it + (ds: &quot;Golem&quot;))</tw-passagedata><tw-passagedata pid="117" name="Release Gnome" tags="" position="4823,3902" size="100,100">The gnome merges with any earth and stone it can contact and begins to shake the area apart, sending rocks crashing down on you and your opponent.</tw-passagedata><tw-passagedata pid="118" name="Encounter: Golem" tags="event daemon southquarry" position="4391,3777" size="100,100">A bipedal mass of dry clay with a frog-like mouth and two unblinking eyes scooped out its face confronts you.
{(set: $enemyType to &quot;Golem&quot;)
(set: $deathReason to &quot;You&#39;ve been smashed into pulp by the golem.  The instant you die, it ceases moving&quot;)
(set: $enemyHealth to 9)
(set: $enemyElementType to &quot;stone&quot;)
(set: $options to (a:))
(if: $inventory contains all of (ds: &quot;Blank Scroll&quot;, &quot;Ink of Enchantment&quot;) and (history:) contains &quot;Read Ex Nobilis Aetherium&quot; and $cunning &gt; 5)[(set: $options to $options + &quot;Capture Golem&quot;)]
}
(set: _options to $options)(display: &quot;Encounter Daemon&quot;)</tw-passagedata><tw-passagedata pid="119" name="Vulcan Avatar" tags="daemon" position="8115,682" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="120" name="Encounter: Sylph" tags="daemon" position="4394,4122" size="100,100">The wind picks up in a localized area around you.  It appears that a Sylph has been disturbed.
(if: $inventory contains &quot;Soul Jar&quot;)[
[[Capture the Sylph]]
]
[[Remain Calm-&gt;Next Encounter]]</tw-passagedata><tw-passagedata pid="121" name="Capture the Sylph" tags="" position="4724,4120" size="100,100">(if: (random: 0, $perception + $cunning) &gt; 5)[You manage to capture the Sylph in your Soul Jar.
(set: $arg to &quot;Soul Jar&quot;)(display: &quot;LoseItem&quot;)
(set: $arg to &quot;Sylph&quot;)(display: &quot;GainDaemon&quot;)]
(else:)[
The sylph is offended that you would attempt to capture it and smashes your Soul Jar in retaliation.
(set: $arg to &quot;Soul Jar&quot;)(display: &quot;LoseItem&quot;)
]

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="122" name="Sylph" tags="daemon-description" position="4513,4120" size="100,100">A nearly invisible pattern of wind that appears to be sentient and/or sapient.</tw-passagedata><tw-passagedata pid="123" name="Hungry Ghost" tags="daemon-description" position="4511,4007" size="100,100">A collection of pure hunger energy that tends to rupture into this world and demand tribute of food.</tw-passagedata><tw-passagedata pid="124" name="Encounter: Hungry Ghost" tags="event daemon" position="4397,4002" size="100,100">A wretched, tooth-ring mouth emerges from a surface that seemed completely solid.

&quot;So...  hungry...&quot; it gasped.
(set: $deathReason to &quot;Your life was drained out by a horrible, leech-like creature&quot;)
(if: $inventory contains &quot;Food&quot;)[
You can give it a little food...

(link-reveal: &quot;Or Not&quot;)[
It clamps on and drains you of a little blood.
(set: $arg to (random: 0, 2))(display: &quot;TakeDamage&quot;)

[[Next Encounter]] 
]
](else:)
[
You have nothing to give it, so it clamps on and drains you of a little blood.

(set: $arg to (random: 0, 2))(display: &quot;TakeDamage&quot;)

[[Next Encounter]] 
]</tw-passagedata><tw-passagedata pid="125" name="Encounter: Gnome" tags="daemon event" position="4394,3899" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="126" name="Ifriti" tags="daemon" position="8408,4445" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="127" name="Djinn" tags="daemon" position="8411,4554" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="128" name="Marid" tags="daemon" position="8415,4655" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="129" name="Capture Rattle Bones" tags="" position="4715,3547" size="100,100">(if: $inventory contains all of (a: &quot;Soul Jar&quot;, &quot;Piece of Pitch&quot;))[
(set: $arg to &quot;Piece of Pitch&quot;)(display: &quot;LoseItem&quot;))
You throw a Piece of Pitch to the ground.  Thin threads of pitch drape up and over the Rattle Bones, snaring its individual pieces into a cotton candy-like web, and you attempt to pull it into your Soul Jar.
(if: (random: 0, $cunning) &gt; 2)[With an audible //shlorp//, you trap the Rattle Bones in the Soul Jar.(set: $daemons to it + (ds: &quot;Rattle Bones&quot;))
   (set: $inventory to it - (ds: &quot;Soul Jar&quot;))
   [[Next Encounter]] 
   ](else:)[ but it tears free of the webbing, and it appears that the pitch reinforced it! (set: $enemyHealth to it + (random: 1,3))]
](else:)[You try to capture the Rattle Bones, but you haven&#39;t got a Soul Jar!]</tw-passagedata><tw-passagedata pid="130" name="Capture Gnome" tags="" position="4722,3902" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="131" name="Death" tags="" position="3895,2862" size="100,100">(goto: &quot;At the Veil of the Void&quot;)</tw-passagedata><tw-passagedata pid="132" name="At the Veil of the Void" tags="" position="3894,2742" size="100,100">(if: $LazarusBeaconCharges is 0)
[
You have now passed through the Veil of the Void, and there is no turning back.

(display: (either: &quot;True Death Ending&quot;, &quot;VR Ending&quot;, &quot;Bad Acid Trip Ending&quot;))

This is The End.
]
(else:)
[
(set: $health to $maxHealth)
(if: $cunning &lt; 1)[(set: $cunning to 1)]
(set: $LazarusBeaconCharges to it - 1)
You have died.
(if: $deathReason is not &quot;&quot;)[
$deathReason(set: $deathReason to &quot;&quot;)
]
(if: $contractCancelledOnDeath is 1)[
&lt;div style=&quot;display:none&quot;&gt;(display: &quot;Cancel Contract&quot;)&lt;/div&gt;
]
In the distance, but getting closer by the second is The Veil of the Void.

It is the thinnest of barriers between being merely Dead or Undead and being Really Dead.  No one has ever come back from beyond the Veil of the Void.

It is unspeakably beautiful, and you want to touch it.

Best not to get too close.  The natural beauty of the Veil is what makes it so dangerous.  Your Lazarus Beacon expends a charge to create a portal from the realm of Death to your (link-reveal-goto: &quot;Home Again&quot;)[(set: $cunning to $maxCunning)(set: $perception to $maxPerception)(set: $health to $maxHealth)].
]</tw-passagedata><tw-passagedata pid="133" name="Dunes" tags="location easternfortress southquarry" position="7264,4939" size="200,100">(display: &quot;Init Dunes&quot;)
Rolling yellow sand, covering ancient ruins.

// Random chance you&#39;ll find The Southern Gate to Eastern Fortress

(link-repeat: &quot;Search for The Southern Gate to Eastern Fortress&quot;)[
The sun beats down on you, mercilessly.
(set: $arg to (random: 0,1) + (random: 0,1))(display: &quot;TakeDamage&quot;)
(display: &quot;Tick&quot;)
(if: (random: 0, 10 - $perception) is 0)[
But it was worth it to find
[[The Southern Gate to Eastern Fortress]]
]]</tw-passagedata><tw-passagedata pid="134" name="Init Dunes" tags="function" position="7151,4929" size="100,100">{(set: $environmentMaterials to (a: &quot;stone&quot;, &quot;sandstone&quot;, &quot;sand&quot;,  &quot;fossilized wood&quot;, &quot;fossil&quot;, &quot;obsidian&quot;))
(set: $environmentColors to (a: &quot;tan&quot;, &quot;yellow&quot;, &quot;ochre&quot;))
(set: $clothingMaterials to (a: &quot;burlap&quot;, &quot;linen&quot;))
(set: $clothingColors to (a: &quot;yellowed&quot;, &quot;dun&quot;,&quot;sunbleached&quot;))
(set: $clothingTypes to (a: &quot;tunic&quot;, &quot;robe&quot;))
(set: $adornmentMaterials to (a: &quot;fossil&quot;, &quot;clay&quot;, &quot;glass&quot;))
(set: $adornmentTypes to (a: &quot;beads&quot;, &quot;amulets&quot;))
(set: $hairstyles to (a: &quot;a khaffia&quot;, &quot;a bald pate&quot;, &quot;a shaggy mane&quot;,&quot;long matted tendrils&quot;))

(set: $sizes to (a: &quot;wiry&quot;, &quot;solid&quot;))
(set: $races to (a: &quot;human&quot;, &quot;drake-kin&quot;, &quot;djinni&quot;, &quot;rakhshasa&quot;))
(set: $skinColors to (a: &quot;black&quot;, &quot;tan&quot;, &quot;brown&quot;, &quot;red&quot;, &quot;gray&quot;, &quot;golden&quot;, &quot;blue&quot;))
(set: $skinTypes to (a: &quot;smooth&quot;, &quot;lightly furred&quot;, &quot;fur-covered&quot;, &quot;scaled&quot;))
(set: $professions to (a: &quot;bandit&quot;, &quot;frankincense harvester&quot;, &quot;warlord&quot;))
}
{(set: $neighborhood to 
(dm: &quot;name&quot;, &quot;Dunes&quot;, 
&quot;tagname&quot;, &quot;dunes&quot;,
	&quot;locations&quot;, (a:),
&quot;contracts&quot;, (a:),
		&quot;events&quot;, (a:)))}</tw-passagedata><tw-passagedata pid="135" name="Eastern Fortress" tags="tick" position="7407,3199" size="200,200">(display: &quot;Init Eastern Fortress&quot;)
This neighborhood is built into the ruins of a fortress of some ancient species that was approximately three times as large as humans.  Accomodations have been made for human-sized creatures, including ramps across giant stairsteps and bedrooms converted into apartment blocks.

It is also an effective vault, so all of the City&#39;s major banks are here.

(for: each _item, ...($neighborhood&#39;s locations))[(if: (history:) contains _item and (passage: _item)&#39;s tags contains &quot;bookmark&quot;)[(link-goto: _item)

]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="136" name="Init Eastern Fortress" tags="function" position="7457,3081" size="100,100">{(set: $environmentMaterials to (a: &quot;stone&quot;, &quot;brick&quot;, &quot;charcoal&quot;, &quot;driftwood&quot;, &quot;log and post&quot;, &quot;concrete&quot;, &quot;flagstone&quot;, &quot;cobble&quot;, &quot;tile&quot;, &quot;recovered crossbeam&quot;))
(set: $environmentColors to (a: &quot;brown&quot;, &quot;ochre&quot;, &quot;tan&quot;, &quot;gray&quot;))
(set: $clothingMaterials to (a: &quot;silk&quot;, &quot;satin&quot;, &quot;linen&quot;, &quot;rag&quot;, &quot;wooden plate&quot;, &quot;leather&quot;, &quot;hemp&quot;))
(set: $clothingColors to (a: &quot;brown&quot;, &quot;dun&quot;, &quot;gray&quot;, &quot;yellowed&quot;, &quot;tawny&quot;))
(set: $clothingTypes to (a: &quot;kilt&quot;, &quot;apron&quot;, &quot;loincloth&quot;, &quot;girdle&quot;, &quot;tunic&quot;, &quot;dressing gown&quot;,&quot;coveralls&quot;, &quot;one-piece&quot;, &quot;armor&quot;))
(set: $adornmentMaterials to (a: &quot;stone&quot;, &quot;copper&quot;, &quot;ceramic&quot;, &quot;gold&quot;, &quot;silver&quot;, &quot;dolemite&quot;, &quot;pyrite&quot;, &quot;bronze&quot;,&quot;chitin&quot;))
(set: $adornmentTypes to (a: &quot;plate&quot;, &quot;plug&quot;, &quot;spool&quot;, &quot;ring&quot;, &quot;stud&quot;, &quot;chain&quot;))
(set: $hairstyles to (a: &quot;a shaven scalp&quot;, &quot;a bald pate&quot;, &quot;shaven sides and a top knot&quot;, &quot;a brief top knot&quot;, &quot;a top knot&quot;, &quot;a lacquered headdress&quot;, &quot;a shaggy mane&quot;))

(set: $sizes to (a: &quot;stout&quot;, &quot;scrawny&quot;, &quot;burly&quot;, &quot;rotund&quot;, &quot;gaunt&quot;, &quot;obese&quot;, &quot;muscular&quot;, &quot;sculpted&quot;, &quot;compact&quot;, &quot;lithe&quot;))
(set: $genders to (a: &quot;man&quot;, &quot;woman&quot;, &quot;non&quot;, &quot;herm&quot;))
(set: $races to (a: &quot;human&quot;, &quot;gnome&quot;, &quot;daemonkin&quot;, &quot;changeling&quot;, &quot;drakish&quot;, &quot;mekannin&quot;,&quot;insekvolk&quot;))
(set: $skinColors to (a: &quot;black&quot;, &quot;tan&quot;, &quot;brown&quot;, &quot;pink&quot;, &quot;pale&quot;, &quot;silver&quot;))
(set: $skinTypes to (a: &quot;smooth&quot;, &quot;lightly furred&quot;, &quot;fur-covered&quot;, &quot;scaled&quot;, &quot;chitinous&quot;))
(set: $professions to (a: &quot;soldier&quot;, &quot;thief&quot;, &quot;ragpicker&quot;, &quot;sineater&quot;, &quot;cursekeeper&quot;, &quot;prostitute&quot;, &quot;thug&quot;, &quot;student&quot;, &quot;alckymist&quot;, &quot;blacksmith&quot;,&quot;explorer&quot;,&quot;archeologist&quot;,&quot;technoresurrectionist&quot;))
}
{(set: $neighborhood to 
(dm: &quot;name&quot;, &quot;Eastern Fortress&quot;, 
&quot;tagname&quot;, &quot;easternfortress&quot;,
	&quot;locations&quot;, (altered: _item via _item&#39;s name, ...(find: _item where _item&#39;s tags contains all of (a: &quot;easternfortress&quot;, &quot;location&quot;), ...(passages:))),
&quot;contracts&quot;, (altered: _item via _item&#39;s name, ...(find: _item where _item&#39;s tags contains all of (a: &quot;easternfortress&quot;, &quot;contract&quot;), ...(passages:))),
		&quot;events&quot;, (altered: _item via _item&#39;s name, ...(find: _item where _item&#39;s tags contains all of (a: &quot;easternfortress&quot;, &quot;event&quot;), ...(passages:)))))}</tw-passagedata><tw-passagedata pid="137" name="Eastern Fortress Color" tags="" position="7618,3223" size="100,100">(either: &quot;Upstanding fortress dwellers.&quot;,
&quot;You see a group wearing loincloths or loose tunics playing a game played with stones on a board scratched into stones of the sidewalk.&quot;,
&quot;A gaggle of youngsters scampers by adorned in colorful ritual clothes.&quot;,
&quot;A frothing religious zealot writhes around on the ground, speaking in tongues.  If you were to dip down and listen, you&#39;d make out the sound of yesterday&#39;s stock market prices.&quot;,
((either: &quot;Gigantic birds&quot;, &quot;Broad-headed ruminants&quot;, &quot;Long-legged pachyderms&quot;, &quot;Stocky equines&quot;) + &quot;, &quot; + (either: &quot;about the size of an ostrich&quot;, &quot;about the size of a Buick&quot;, &quot;about the size of a camel&quot;, &quot;about the size of a mammoth&quot;) + &quot;, &quot; + (either: &quot;carrying packs of dry goods.&quot;, &quot;laden with oil for the temple&quot;, &quot;with saddlebags full of anthracite and frankincense&quot;)),
&quot;Monastic cohort with &quot; + (either: &quot;diagrammatic&quot;, &quot;elaborate&quot;, &quot;simple&quot;) + &quot; tonsures &quot; + (either: &quot;examing lost scrolls written in Low Enochian.&quot;,
&quot;sifting through potsherds engraved with elaborate geometric diagrams.&quot;,
&quot;burning incense and chanting prayers in Pig Latin.&quot;,
&quot;sprinkling water on the dusty street and reciting the Ineffable Names of the Void.&quot;,
&quot;staring directly at the giant eyeball that constantly watches everyone but we never talk about.&quot;),
&quot;a troupe of veil dancers with flaming batons&quot;,
&quot;whirling dervishes each with a Damascene sabre balanced on top of their heads&quot;,
&quot;street performers demonstrating balance and contortion to a radical degree&quot;,
&quot;a geometric swarm of very small mekannin insects&quot;,
&quot;a team of laborers dragging a cart overloaded with bales of alfalfa&quot;,
&quot;reams of parchment, piles of unopened crates, reams of silk, satin, lace, bubble wrap, fishnet&quot;,
&quot;remaindered shellac records of every permutation of &quot; + (either: &quot;The Ramones&#39;s Blitzkrieg Bop.&quot;, &quot;Ode To Joy.&quot;),
&quot;children playing knucklebones on top of a half-wall&quot;,
&quot;a tattoist has a small pop-up stand near an ornamental manticore sculpture a quick scan of their wares reveals weak toy charms and ineffectual curses.&quot;,
&quot;A street merchant is schlepping arthropods on a stick roasted in a brazier full of anthracite&quot;,
&quot;a puppet maker assembling sinew and bone into terrifying homunculi&quot;,
&quot;a &quot; + (either: ...$races ) + &quot; is currently getting their &quot; +(either: &quot;nostril&quot;, &quot;septum&quot;, &quot;lip&quot;, &quot;cheek&quot;, &quot;bridge&quot;, &quot;eyebrow&quot;, &quot;forehead&quot;, &quot;earlobe&quot;, &quot;conch&quot;, &quot;upper ear&quot;, &quot;tongue&quot;, &quot;sternum&quot;, &quot;chin&quot;, &quot;cheekbone&quot;, &quot;finger webbing&quot;) + &quot; pierced with a &quot; + (either: &quot;tiny &quot;, &quot;giant &quot;, &quot;&quot;)+&quot; &quot;+(either: &quot;spike&quot;, &quot;ring&quot;, &quot;barbell&quot;, &quot;bone&quot;, &quot;wooden needle&quot;) + &quot;.&quot;,
&quot;Two red-faced merchants are screaming at each other over imagined slights.  One wears a khaffia, and the other wears a cybernetic neural interface, but they are as like siblings.&quot;,
&quot;A group of off-duty mercenaries briefly make eye contact with you, but quickly wave you away.
\&quot;We&#39;re not taking any new jobs right now, friend.  Maybe later.\&quot;&quot;,
&quot;Old folk are doing the laundry and hanging it to dry on rebar jutting from a wall that is surely a ruined freeway overpass.&quot;,
&quot;A teacher is using the side of a building as a grand chalk board.  The gaggle of children arrayed before him are serious and attentive.&quot;

)</tw-passagedata><tw-passagedata pid="138" name="Fortuna&#39;s Tea House" tags="bookmark location easternfortress tick" position="7474,3522" size="100,100">Fortuna is an animated and sentient fortune teller novelty booth.  She eats and smokes cigarettes constantly.

&quot;I want some of your gold, but I won&#39;t tell you how much.  In exchange, I&#39;ll give you access to a future of your choosing!&quot;

[[Lady Fortuna&#39;s Predictions]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="139" name="Lady Fortuna&#39;s Predictions" tags="tick" position="7586,3522" size="100,100">(set: $arg to -(random: 0, $gold))(display: &quot;UpdateGold&quot;)
(set: _possibles to (find: _item where _item&#39;s tags contains &quot;event&quot;, ...(passages:)))
(for: each _i, ...(shuffled: ..._possibles)&#39;s (range: 1, (min: _possibles&#39;s length, $cunning + $perception)))[
(link-goto: _i&#39;s name)
]</tw-passagedata><tw-passagedata pid="140" name="Vivificarium" tags="bookmark location easternfortress tick" position="7481,3628" size="100,100">&quot;Please, enter the chamber and be renewed!&quot; a strangely well-preserved proprietor invokes.
Vivification chamber as a service.
(if: $gold &gt;= 30)[(link-reveal-goto: &quot;Use Vivification Chamber&quot;)[(set: $gold to it - 30)]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="141" name="Artefaktuen Ganga" tags="bookmark location easternfortress tick" position="7468,3411" size="100,100">Once a vault built into the mountain, used to hide away the most dangerous artifacts in the known worlds, now a luxurious shopping plaza.

(for: each _item, ...((shuffled: &quot;Sharpened Teeth&quot;, &quot;Vampir Krenk&quot;, &quot;Badge of Shame&quot;, &quot;Mark of the Goblins Lvl 1&quot;, &quot;Loaded Dice&quot;, &quot;Hell Money&quot;, &quot;Shadow Lantern&quot;, &quot;Everfull Flask&quot;, &quot;Deck of Cards&quot;, &quot;Chest Key&quot;)&#39;s (range: 1, 3)))[
(unless: $inventory contains _item)[(set: _cost to 35)(display: &quot;QuickBuy&quot;)]
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="142" name="Encounter: Guards" tags="event easternfortress uppercastlerock" position="3664,3968" size="100,100">{(set: $enemyHealth to 5)(set: $enemyType to &quot;Guards&quot;)(set: $deathReason to &quot;You are crushed to a thin, red gruel by the guards.  Justice served?!&quot;)
(set: $fightPattern to (a:(either: &quot;Strike&quot;,&quot;Block&quot;),(either: &quot;Strike&quot;, &quot;Throw&quot;)))(set: $enemyElementType to &quot;Holy&quot;)
(set: $fightIndex to 1)}
You see a guard in the imperial tabard approaching.

(if: $reputation&#39;s ($neighborhood&#39;s name) &gt; 7)[
They nod slightly as they pass you by.

[[Next Encounter]] 
]
(else-if: (random: 0, $reputation&#39;s ($neighborhood&#39;s name)) &lt; 5 or ($inventory contains &quot;Badge of Shame&quot;))[
They approach you with weapons drawn.  Either they have mistaken you for someone else, or they know exactly who you are.  Either is bad.
|output&gt;[]

|input&gt;[
(display: &quot;Fight&quot;)
(link-goto: &quot;Go Along Quietly&quot;, &quot;Magisterium Local Office&quot;)
]


](else:)[They push past you without even so much as making eye contact.
[[Next Encounter]]]

(event: when $enemyHealth &lt;= 0)[ (replace:?input)[ [[Next Encounter]] ]]</tw-passagedata><tw-passagedata pid="143" name="Encounter: Aura of Illusion" tags="eastfortress event" position="4243,4204" size="100,100">The City is full of magicians, witches, conjurors, warlocks, necromancers of all stripes.
Each one has spells, counterspells, wards, counterwards, and enchantments surrounding them at all times.
Any one of them would be dangerous on its own, but when they interact with each other, they can interfere with each other.
(either:
&quot;As you watch, the traces of enchantment become finer and more subtle.&quot;
,&quot;As if a fog has descended upon you, the lattice of enchantment that surrounds you becomes harder to discern.&quot;
,&quot;It feels as if someone has cast a cloaking spell to hide enchantments from mortal senses.&quot;)

(set: $enchantmentHidden to it + 1)Illusion + 1 ($enchantmentHidden)

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="144" name="Sameera&#39;s Superior Documents" tags="bookmark location easternfortress tick" position="7476,3857" size="100,100">Sameera invites you into her store with a delicate gesture.
You duck through the low entrance and are immediately intoxicated with the smell of old paper.

You peruse her excellent collection of antiquities and identify a few that hold your interest.

(set: _arg to &quot;Philomender&#39;s Book of Excellent Knots&quot;)
(unless: $inventory contains _arg)[(if: $perception &lt; 7)[(set: _item to _arg)(set: _cost to 150)(display: &quot;QuickBuy&quot;)]
(else:)[(set: _item to _arg)(set: _cost to 120)(display: &quot;QuickBuy&quot;)]]

(set: _arg to &quot;Ex Nobilis Aetherium&quot;)
(unless: $inventory contains _arg)[(if: $perception &lt; 7)[(set: _item to _arg)(set: _cost to 150)(display: &quot;QuickBuy&quot;)]
(else:)[(set: _item to _arg)(set: _cost to 120)(display: &quot;QuickBuy&quot;)]]

(set: _arg to &quot;The True History of Leng&quot;)
(unless: $inventory contains _arg)[(if: $perception &lt; 7)[(set: _item to _arg)(set: _cost to 150)(display: &quot;QuickBuy&quot;)]
(else:)[(set: _item to _arg)(set: _cost to 120)(display: &quot;QuickBuy&quot;)]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="145" name="Eastern Fortress Foray Gate" tags="tick location bookmark easternfortress" position="7478,3751" size="100,100">You are astride the Foray Gate.  Out there is untold treasure: both gold and forbidden scrolls.

Also death.  Mainly death.

[[Embark on a Foray]] 

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="146" name="Encounter: Sparring Duel" tags="encounter easternfortress" position="441,3710" size="100,100">Two wizards face off and challenge each other strictly within an arena and without attempting to harm their opponent.

The winner gains rank and the loser falls in rank.
|input&gt;[
(link-reveal: &quot;Accept the Loss&quot;)[(replace:?input)[
(display: &quot;An Embarassing Display&quot;)
[[Next Encounter]] ]
]
[[I&#39;d Rather Not Be Humiliated In Public-&gt;Encounter: Wizard Duel]]
]</tw-passagedata><tw-passagedata pid="147" name="Eternal Ephemera" tags="location easternfortress bookmark" position="7480,3980" size="100,100">(set: _cost to 1500)
(for: each _item, &quot;Cursed Mirror&quot;, &quot;God&#39;s Eye&quot;, &quot;Neighborhood Door to West Fires&quot;)[
(display: &quot;QuickBuy&quot;)
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="148" name="Zenoarcheological Society" tags="location easternfortress bookmark" position="7490,4097" size="100,100">Not to be confused with the &quot;Xenoarcheological Society&quot;.  Quite a different group of folk.


(if: (random: 0, 6) is 6)[(display:  &quot;Lord Hubris&quot;)]

(set: _recruitCost to 100)
(if: $reputation&#39;s ($neighborhood&#39;s name) &gt; 5 and $gold &gt;= _recruitCost)[
You can purchase supplies and provisions for a foray directly from the society&#39;s general store.
(link-reveal: &quot;Stock Up&quot;)[Supplies per worker per day will cost _recruitCost lucre.  This is non-refundable, but you can store supplies in between forays.

How much would you like to buy?
(cycling-link: bind _recruit, (altered: _i via (str: _i), ...(range: 1, $gold/_recruitCost)))
(link-reveal: &quot;Sold!&quot;)[
(set: $arg to -((num: _recruit) * _recruitCost))(display: &quot;UpdateGold&quot;)(set: $arg to (num: _recruit))(display: &quot;UpdateForaySupplies&quot;)
]]]

[[Embark on a Sanctioned Foray]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="149" name="Astrid Joiner" tags="easternfortress southquarry persona" position="7484,4205" size="100,100">Astrid is a determined digger, looking for the Ancestors who created Eastern Fortress.  Steely-grey eyes shaded by a sopping pith helmet, curly brown hair, and deeply tanned skin.

You&#39;re free to run off on a foray all by yourself, but you should be really careful.  If you don&#39;t have any supplies, you can starve to death in a very short amount of time.  If you don&#39;t have any crew, you&#39;re not going to get the most out of any discoveries you make.

We don&#39;t know who created this place.  Isn&#39;t it incredible that we, the apparent pinnacle of civilization, don&#39;t even know who created this place?  We call them The Ancients, and we find their trinkets and riddles all over the place, but we still don&#39;t really know who they really were.

You should go to Oasis Refreshments if you want to find folk to hire for your foray crew.  There&#39;s always a crowd of mysterious strangers who will work with anyone who has gold and doesn&#39;t ask questions.


I don&#39;t much have use for this anymore. //She hands you her Zenoarcheological Society membership card//  The name&#39;s all blurry, so they won&#39;t know it&#39;s not really yours.
Hey, I&#39;ll loan you one of my books so long as you promise to read it before you see me next, okay?  I&#39;m serious! //She hands you some rare book//
Hey, did you read the book or not? //If history contains &quot;Read &lt;Book Name&gt;&quot;//Very good, my friend.  I&#39;d love to dish with you over the details, but I&#39;m off on a very well researched, very well funded foray, and I need a partner along to do the dirty work.  She winks.
//else//You didn&#39;t even bother, did you?  Well, you missed out, innit? //She takes back the book//
//If you lost or sold the book// What?! &lt;legitimately furious&gt; You lost a book!  That is sacrilege!
//After successfully foraying with her//
Even though I am the rightful owner of this &lt;important artifact&gt;, I feel that you should have half of it. &lt;she proceeds to cut it in half and give you the slightly smaller piece&gt;  Don&#39;t worry, it&#39;s the material that the &lt;importan artifact&gt; is made out of, not the shape of it.  Half an artifact still works just fine.</tw-passagedata><tw-passagedata pid="150" name="Lord Hubris" tags="easternfortress persona" position="7487,4330" size="100,100">Mekannin head of the Zenoarcheological Society.

You should go to the Zenoarcheological Society if you wish to engage in a *Sanctioned* Foray.  None of that *winging it* nonsense.
No, not the Xenoarcheological Society.  Those are a completely different society.

My memories are etched onto unobtanium plates.  When they fill up, I have to determine which memory plate I must sacrifice if I must form new long term memories.  As a consequence, I rarely choose to form new long term memories.  Therefore, I will never remember this conversation.  Not to be rude, but you must understand my predicament.

We have evidence suggesting that I was created during the Era of The Ancients.  That means that I must have known them.  Alas, my irreplaceable memory plates are short precisely 7 plates, presumably stolen.</tw-passagedata><tw-passagedata pid="151" name="Oasis Refreshments" tags="location easternfortress bookmark" position="7488,4455" size="100,100">Friendly faces... mostly mercenaries.
(set: _roll to (random: 2,7))About _roll of them.

(if: (random: 0, 6) is 6)[(display:  &quot;Astrid Joiner&quot;)]

(link-reveal: &quot;Buy A Round&quot;)[(set: _roll to it * (random: 1, 3))(if: _roll &gt; $gold)[&quot;That ain&#39;t enough ducats, friend&quot;, sneers the barkeep.
(display: &quot;An Embarassing Display&quot;)](else:)[A round of watery, room temperature bhanga certainly lightens the mood.(set: $arg to -_roll)(display: &quot;UpdateGold&quot;)(set: $arg to (either: 0, 1,1))(display: &quot;UpdateReputation&quot;)]]
(set: _recruitCost to 100)
(if: $reputation&#39;s ($neighborhood&#39;s name) &gt; 5 and $gold &gt;= _recruitCost)[
You can recruit from the locals to attend your forays.
(link-reveal: &quot;Recruit&quot;)[Each foray worker will charge you _recruitCost lucre per foray.  If the foray doesn&#39;t produce enough treasure and ancient arcane knowledge to be profitable, that&#39;s not our problem.

How many would you like to recruit?
(cycling-link: bind _recruit, (altered: _i via (str: _i), ...(range: 1, (min: (random: 1, _roll), $gold/_recruitCost))))
(link-reveal: &quot;You&#39;re Hired!&quot;)[
(set: $arg to -((num: _recruit) * _recruitCost))(display: &quot;UpdateGold&quot;)(set: $arg to (num: _recruit))(display: &quot;UpdateForayCrew&quot;)
]]]


(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="152" name="Feorag&#39;s Fungibles" tags="location easternfortress tick bookmark" position="7490,4570" size="100,100">Feorag is a commodities broker for aetherial reagents, specifically:
(unless: $feorag is not 0)[
(set: $feorag to (dm: &quot;Shadow Threads&quot;, 90, &quot;Ethereal Threads&quot;, 90, &quot;Infernal Threads&quot;, 90, &quot;Mortal Threads&quot;, 90))]
|input&gt;[(for: each _i, ...(datanames: $feorag))[(set: _item to _i)(set: _value to $feorag&#39;s (_i))(print: _item) - (print: _value)
(if: $gold &gt;= _value + 5)[(unless: $inventory contains _item)[
(link-reveal: &quot;Buy For &quot; + (string: _value + 5))[(replace:?input)[Bought 1 _item for _value lucre.
(set: $arg to -(_value + 5))(display: &quot;UpdateGold&quot;)
(set: $arg to _item)(display: &quot;GetItem&quot;)
(set: $feorag to it + (dm: _item, _value + 5))]]]]
(if: $inventory contains _item)[
(link-reveal: &quot;Sell For &quot; + (string: _value))[(replace:?input)[Sold 1 _item for _value lucre.
(set: $arg to _value)(display: &quot;UpdateGold&quot;)
(set: $arg to _item)(display: &quot;LoseItem&quot;)
(set: $feorag to it + (dm: _item, (max: _value - 5, 5)))]]]
]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="153" name="Rare Crates Emporium" tags="location bookmark easternfortress" position="7495,4910" size="100,100">Stacked up in great, teetering towers are crates being offloaded from various excursions to and from the Eastern Fortress Foray Gate.  You can buy one for 75 coins, crack it open, and see what you&#39;ve bought!
(if: $gold &gt;= 75)[
(link-repeat: &quot;Crack Open a Crate&quot;)[
(if: $gold &gt;= 75)[(set: $arg to -75)(display: &quot;UpdateGold&quot;)
(set: _roll to (random: 0, 3))
(if: _roll is 0)[A load of pottery, but... ah! //This// jug happens to be a Soul Jar containing a (set: $arg to (either: &quot;Fire Ghost&quot;, &quot;Shadow Daemon&quot;))$arg.
(display: &quot;GetDaemon&quot;)]
(else-if: _roll is 1)[(set: $arg to (either: &quot;Piece of Pitch&quot;, &quot;Quaff of Quicksilver&quot;))(display: &quot;GetItem&quot;)]
(else:)[
It&#39;s mostly worthless rubbish, but there&#39;s enough valuables in there that you recover some of your investment.(set: $arg to (random: 1,74))(display: &quot;UpdateGold&quot;)
]](else:)[You&#39;ve gambled away all of your coins.]]](else:)[If you had any dosh, you could burn a little here.  But you don&#39;t, so you can&#39;t.]


(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="154" name="Spice Market" tags="location easternfortress bookmark tick" position="7495,4794" size="100,100">The Spice Market is the gathering of merchants from all over the branes.
You can get any reagent available to mortals such as yourself, and maybe a few more besides.
// \todo: make the price double each time you use it each day
The (either: &quot;odor&quot;, &quot;aroma&quot;, &quot;stench&quot;) is quite (either: &quot;terrible&quot;, &quot;delightful&quot;, &quot;sickly&quot;, &quot;invigorating&quot;, &quot;seductive&quot;, &quot;nauseating&quot;, &quot;heavenly&quot;, &quot;amazing&quot;).

(set: _options to (altered: _v via _v&#39;s name, ...(shuffled: ...(find: _i where _i&#39;s tags contains &quot;reagent&quot;, ...(passages:)))&#39;s (range: 1, 3)))

(for: each _item, ..._options)[
(unless: $inventory contains _item)[(set: _cost to (random: 5, 15) * 10)(display: &quot;QuickBuy&quot;)]
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="155" name="Encounter: Enchantment Trap Lock" tags="" position="3905,4594" size="100,100">You see the tracery of an Enchantment Lock.  This is a more cunning working than an Enchantment Trap, because if you don&#39;t unwind it in the correct order, it will either bind the object forever or spontaneously unravel through you, rendering you into thin slices of former wizard.

Which thread will you snip first?
{(set: _alphabet to (a: &quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;,&quot;E&quot;,&quot;F&quot;,&quot;G&quot;,&quot;H&quot;,&quot;I&quot;,&quot;J&quot;,&quot;K&quot;,&quot;L&quot;))
(set: $puzzleLength to $enchantmentHidden)
(set: _puzzle to (shuffled: ...((range: 1, $puzzleLength) + (repeated: 12 - $puzzleLength, 0))))
(set: $puzzleIndex to 1)
(set: _puzzleButtons to (a:))
(set: $puzzle to _puzzle)
(set: $remainingPuzzleAttempts to 2)
}
&lt;pre&gt;
(live: 0.5s)[(print: $puzzle&#39;s (1) + $puzzle&#39;s (3) + $puzzle&#39;s (4))] -(set: _index to 1)(display: &quot;PuzzleButton&quot;)- (live: 0.5s)[(print: $puzzle&#39;s (1) + $puzzle&#39;s (2) + $puzzle&#39;s (5))] -(set: _index to 2)(display: &quot;PuzzleButton&quot;)- (live: 0.5s)[(print: $puzzle&#39;s (7) + $puzzle&#39;s (2) + $puzzle&#39;s (6))]
| \   |   / |
|  (set: _index to 4)(display: &quot;PuzzleButton&quot;)  (set: _index to 5)(display: &quot;PuzzleButton&quot;)  (set: _index to 6)(display: &quot;PuzzleButton&quot;)  |
|   \ | /   |
(set: _index to 3)(display: &quot;PuzzleButton&quot;)     (live: 0.5s)[(print: $puzzle&#39;s (4) + $puzzle&#39;s (5) + $puzzle&#39;s (6) + $puzzle&#39;s (8) + $puzzle&#39;s (9) + $puzzle&#39;s (10))]     (set: _index to 7)(display: &quot;PuzzleButton&quot;)
|   / | \   |
|  (set: _index to 8)(display: &quot;PuzzleButton&quot;)  (set: _index to 9)(display: &quot;PuzzleButton&quot;)  (set: _index to 10)(display: &quot;PuzzleButton&quot;)  |
| /   |   \ |
(live: 0.5s)[(print: $puzzle&#39;s (3) + $puzzle&#39;s (8) + $puzzle&#39;s (11))] -(set: _index to 11)(display: &quot;PuzzleButton&quot;)- (live: 0.5s)[(print: $puzzle&#39;s (9) + $puzzle&#39;s (11) + $puzzle&#39;s (12))] -(set: _index to 12)(display: &quot;PuzzleButton&quot;)- (live: 0.5s)[(print: $puzzle&#39;s (7) + $puzzle&#39;s (10) + $puzzle&#39;s (12))]
&lt;/pre&gt;
|output&gt;[]

&lt;pre&gt;
0 -A- 0 -B- 0
| \   |   / |
|  D  E  F  |
|   \ | /   |
C     0     G
|   / | \   |
|  H  I  J  |
| /   |   \ |
0 -K- 0 -L- 0
&lt;/pre&gt;</tw-passagedata><tw-passagedata pid="156" name="PuzzleButton" tags="" position="4012,4595" size="100,100">{(set: _i to _index)(link: _alphabet&#39;s (_index))[*(if: $puzzle&#39;s (_i) is $puzzleIndex)[(replace:?output)[The strand loosens.(set: $puzzle&#39;s (_i) to 0)  (if: $puzzleIndex &gt;= $puzzleLength)[The enchantment slips apart. (set: $inventory to it + (ds: &quot;Ethereal Threads&quot;))    
[[Next Encounter]]]
(set: $puzzleIndex to it + 1)
(if: $puzzle contains ($puzzleIndex * -1))
[
	(set: $puzzleIndex to it + 1)
]
]
](else:)[(replace:?output)[
{(set: $remainingPuzzleAttempts to it - 1)
(if: $remainingPuzzleAttempts &lt;= 0 and $puzzle&#39;s (_i) is not 0)[
(if: (random: 0, $danger) &lt; 3)[The enchantment snaps along the wrong axis, causing a run of nodes to overtighten.  The object held in the enchantment is warped and ruined.  You would need to destroy the whole thing with an enchanted blade to get it open again.

[[Next Encounter]]](else:)[The enchantment violently ruptures, doing horrific damage to you.(set: $deathReason to &quot;The enchantment violently ruptures, tearing you into a pink ruin.&quot;)(set: $arg to $danger)(display: &quot;TakeDamage&quot;)

[[Next Encounter]]]]
(else:)[The thread thrums threateningly. (set: $puzzle&#39;s (_i) to it * -1) ]
}]]]}</tw-passagedata><tw-passagedata pid="157" name="VR Ending" tags="" position="8264,736" size="100,100">You take your VR helmet off to find that you are a wage slave in a dystopian future where everyone uses immersive sims to distract themselves from the horror that is their actual lives.</tw-passagedata><tw-passagedata pid="158" name="Bad Acid Trip Ending" tags="" position="8264,851" size="100,100">You were having a psychedelic experience the entire time.  You return to your old life, but the City never stops haunting you.</tw-passagedata><tw-passagedata pid="159" name="The Shadow Passenger Ending" tags="" position="8266,961" size="100,100">This time is different.
Instead of the vast, featureless plain of obsidian sand that you&#39;re used to, you&#39;re in the playroom of a creature that looks and dresses much like you.  Just everything slightly different, slightly off-kilter.  It grins at the same time as you and matches your stride around the room, each of you seeking an advantage over the other.
&quot;I have power here,&quot; the creature asks. &quot;And what would you say if I offered it to you?&quot;

(link-reveal: &quot;Let me live again!&quot;)[The creature grins, its teeth like broken razor blades.  &quot;Do you not remember, my wonderful treasure?  Who do you think gave you that wonderful Lazarus Beacon?&quot;

&quot;No, it is time for you pay for my investment.&quot;

A million years later, your torn and brutalized psychic essence is finally eroded thin enough that it can no longer suffer or feel anything else either.

The end.]</tw-passagedata><tw-passagedata pid="160" name="Big Loop Ending" tags="" position="8379,962" size="100,100">If you have the Silent Ansible and the Aleph and go to the Veil of the Void, you can safely go out there, where you meet an old version of yourself.

&quot;I&#39;ve been waiting,&quot; they say, pointing to an exhausted Silent Ansible next to them.

They take your Silent Ansible and start walking in the same direction you were going.

You sit down on the obsidian sand and start waiting for the next few hundred years or so.</tw-passagedata><tw-passagedata pid="161" name="The Sea Dayaks" tags="journey" position="5577,1044" size="100,100">Sea Dayaks are an ancient people who ply the world between the material plane and the land of the dead.  Their teeth are sharpened, and they bear enchantment marks that give them power in this tributary.
(if: (history:) contains &quot;Cannibalism&quot;)[
They are fierce people known to hunt heads and eat the flesh of their dead enemies.
They sense a kinship with you.
They insist on giving you a gift before you leave.
&lt;b&gt;+ Sharpened Teeth&lt;/b&gt;(set: $inventory to it + (ds: &quot;Sharpened Teeth&quot;))
](else:)[
They smile knowingly at your sea hag and let you get on your way.

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)
]

[[Next Journey]]</tw-passagedata><tw-passagedata pid="162" name="True Death Ending" tags="" position="4145,2654" size="100,100">You were told there would be choruses of angels and daemons triumphant in Heaven or Hell or wherever you were supposed to go.  Instead, there is nothingness eternal.</tw-passagedata><tw-passagedata pid="163" name="King of Hell Ending" tags="" position="8262,399" size="100,100">$playerHistory

You were all of these things.

But now you reign over the Multitudes as the King of Hell.</tw-passagedata><tw-passagedata pid="164" name="Magisterium Ending" tags="" position="8264,511" size="100,100">$playerHistory

You were all of these things.

But now you reign over the City as the freshly-minted Magisterium</tw-passagedata><tw-passagedata pid="165" name="Immortal Ending" tags="" position="8264,626" size="100,100">$playerHistory

You were all of these things.
 And now you are one of the Immortals who lives in the cracks between the worlds of Mortals and Gods.</tw-passagedata><tw-passagedata pid="166" name="UpdateForayCommand" tags="function" position="7893,3572" size="100,100">(set: $forayCommand to it + $arg)*Foray Command (if: $arg &gt;= 0)[+] $arg ($forayCommand)*</tw-passagedata><tw-passagedata pid="167" name="Foray Stats" tags="" position="7631,3985" size="100,100">Command: $forayCommand | Supplies: $foraySupplies | Crew: $forayCrew | Exploration: $forayExploration</tw-passagedata><tw-passagedata pid="168" name="Legally Distinct Stargate" tags="location" position="8402,4215" size="100,100">If powered with The Aleph, you can dial in a 3-digit number index to anywhere in the multiverse.</tw-passagedata><tw-passagedata pid="169" name="Entrance to the Minotaur&#39;s Labyrinth" tags="foray" position="8210,3613" size="100,100">(set: $chanceOfMinotaur to 0)
(if: (history:)&#39;s last is &quot;Minotaur&#39;s Labyrinth&quot;)[
The cave mouth collapses behind you.
]
(else:)
[
A gaping cave like a cannibal&#39;s maw awaits your ingress...
[[Enter-&gt;Minotaur&#39;s Labyrinth]]
]

(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="170" name="Minotaur&#39;s Labyrinth" tags="location" position="8361,3612" size="100,100">(set: $labyrinthStack to (a: &quot;Entrance to the Minotaur&#39;s Labyrinth&quot;))
(display: &quot;LabyrinthOptions&quot;)</tw-passagedata><tw-passagedata pid="171" name="Relic Chamber" tags="tick labyrinth" position="8600,3831" size="100,100">(if: visits is 1)[
You find a ritual dagger on an altar near a suspicious stain.

(set: $arg to &quot;Ritual Dagger&quot;)(display: &quot;GetItem&quot;)
](else:)[
You see an altar with a suspicious stain.
]

(display: &quot;LabyrinthOptions&quot;)</tw-passagedata><tw-passagedata pid="172" name="Palace of Mirage" tags="foray" position="8200,4789" size="100,100">Have you heard of tulpas?  A tulpa is a kind of thought entity created by very strong belief.  For example, a tale is told of a group of 10 highly skilled monks meditated together in a circle and formed a completely real human being in the middle, for as long as they continued to believe it.
Tales of the Palace of Mirage are so ubiquitous in Eastern Fortress foraying circles that some say that they have created a tulpa //place//!  As long as someone out there believes in the Palace of Mirage, it will continue to exist.

//Mini side quest with lots of succulent imagery//
delicate contortionists perform feats of acrobatics in the rafters for the amusement of the gathered guests 
Snake Eaters and Fire Tamers create a pyrokinetic display that nearly singes your eyeborws.
You never knew someone could own so many gongs.
A group of Djinnis are gossiping in an Arabic precursor that you happen to be fluent in: (set: $arg to (either: &quot;The Palace of Mirage drains the life of those who make merry within its halls.&quot;, &quot;Once they&#39;ve been drained of life, we can eat their bodies!&quot;))
Victuals are arrayed in front of you.  Tonight your crew will feast in the Great Hall of the Sultan of Mirage.  +Command -Supplies
//Can gain in knowledge, coin, command, but will be slowly burning supplies//

(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="173" name="Lion&#39;s Grave" tags="foray" position="8208,4910" size="100,100">(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="174" name="Cenotaph" tags="foray" position="8200,5034" size="100,100">(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="175" name="Mudbrick Dome" tags="foray" position="8201,5174" size="100,100">A reed fence surrounds a mudbrick dome.  A thin line of smoke curls from a chimney hole in the roof.

(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="176" name="Bandit Ambush" tags="foray" position="8203,5289" size="100,100">(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="177" name="Trade Caravan" tags="foray" position="8205,5402" size="100,100">(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="178" name="Caravansarai" tags="foray" position="8216,5525" size="100,100">The caravansarai is currently stopped in the shadow of the ruins of basalt monoliths of cyclopean proportions.  Each merchant has one or more pack beasts of various types laden with great bags of goods for the Eastern Fortress&#39;s Spice Market.

They are willing to sell you supplies and other wares to help out on your trip, but in return, you will be paying way over market prices.

(link-repeat: &quot;Buy a parcel of supplies&quot;)[(replace:?output)[(if: $gold &gt;= 10)[(set: $arg to 10)(display: &quot;UpdateForaySupplies&quot;)(set: $arg to -10)(display: &quot;UpdateGold&quot;)]](else:)[You have nothing with which to buy more supplies.]]
|output&gt;[]
(set: _item to &quot;Compass of Many Places&quot;)(set: _cost to 150)(display: &quot;QuickBuy&quot;)
(set: _roll to (random: 0, 3))
(if: _roll is 0 and $perception &gt; 3)[These &quot;merchants&quot; are clearly bandits disguised as the last merchants they ambushed.]
(link-reveal: &quot;Sleep Next to the Fire&quot;)[
(if: _roll is 0)[You are ambushed in the night!  You awake with a dagger plunged into your shoulder! (set: $arg to (random: 0, 2))(display: &quot;TakeDamage&quot;)
A display of pyrokinetics is enough to make the bandits flee.]
(else:)[You rest well in the company of your fellow travellers. (set: $arg to 1)(display: &quot;UpdateForayCommand&quot;)]
]

(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="179" name="Sandstorm" tags="foray" position="8208,5652" size="100,100">The furious wind blows hot, caustic grit into your eyes and sinuses, rendering you nearly blind and anosmic.  Not to mention almost deaf.
(if: (random: 0,$perception) &gt; 1)[(set: $arg to -1)(display: &quot;UpdatePerception&quot;)]
(set: $arg to -10)(display: &quot;UpdateForaySupplies&quot;)

(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="180" name="Waystation" tags="foray" position="8198,5762" size="100,100">(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="181" name="Watchtower" tags="foray" position="8203,5882" size="100,100">(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="182" name="Well" tags="foray" position="8198,5987" size="100,100">You come across a well.  Is it full or dry?  You could spend some time examining the well, as water would be a welcome addition to your dwindling supplies.
(set: $wellDepth to (random: 15, 30))
|input&gt;[
(link-repeat: &quot;Draw From the Well&quot;)[(replace:?output)[
(if: $wellDepth &lt;= 0)[(replace:?input)[The well is dry.]]
(set: $arg to (random: 1, 5))(display: &quot;UpdateForaySupplies&quot;)
(set: $wellDepth to it - 10)(display: &quot;Tick&quot;)
]]]
|output&gt;[]
(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="183" name="Trash Heap" tags="foray" position="8196,6099" size="100,100">It&#39;s a trash heap.  What was trash to the Ancients could be treasure to you.  In theory.


(set: $wellDepth to (random: 15, 30))
|input&gt;[
(link-repeat: &quot;Examine the Trash Heap&quot;)[(replace:?output)[(either: &quot;You find pottery shards that still have some text in &quot; + (either: &quot;Deep Hexed Rudimanian&quot;, &quot;Late Lower Bardswallian&quot;, &quot;Greater Thoraxic&quot;), &quot;You discover bits of sculpture and game pieces&quot;, &quot;You find tally marks and accounting tiles, &quot; + (either: &quot;establishing an economic system of usurious debt that eventually collapsed into hyperinflation so great that an entire new field of transcendental mathematics was necessary to do basic tax forms&quot;, &quot;showing how different archons owned different holdfasts.&quot;, &quot;all part of an elaborate practical joke by a late Mad Archon, who enjoyed elaborate mathematical contrivances to a hilarious degree.&quot;)).
(if: $wellDepth &lt;= 0)[(replace:?input)[All of the really interesting bits have been uncovered.]]
(set: $arg to (either: ...(range: 0, (max: 1, $forayCrew))))(display: &quot;UpdateForayExploration&quot;)
(set: $wellDepth to it - 10)(display: &quot;Tick&quot;)
]]]
|output&gt;[]

(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="184" name="Lost in the Dunes" tags="foray" position="8203,6210" size="100,100">(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="185" name="Pilgrimage" tags="foray" position="8184,6329" size="100,100">(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="186" name="Cairn" tags="foray" position="8173,6450" size="100,100">(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="187" name="Tomb" tags="foray" position="8174,6574" size="100,100">(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="188" name="Minotaur" tags="" position="8735,3867" size="100,100">This guardian beast roams the labyrinth, devouring all who enter.
It has been described as an unholy hybrid of man and bull, but the truth is more repulsive than described: it is the mean average of a standing man and a standing bull.

//todo: combat//</tw-passagedata><tw-passagedata pid="189" name="UpdateForaySupplies" tags="function" position="7770,3687" size="100,100">(set: $foraySupplies to it + $arg)*Supplies (if: $arg &gt;= 0)[+] $arg ($foraySupplies)*(if: $foraySupplies &lt;= 0)[(set: $deathReason to &quot;You starved to death.&quot;)(goto: &quot;Death&quot;)]</tw-passagedata><tw-passagedata pid="190" name="UpdateForayExploration" tags="function" position="7893,3690" size="100,100">(set: $forayExploration to it + $arg)*Exploration (if: $arg &gt;= 0)[+] $arg ($forayExploration)*</tw-passagedata><tw-passagedata pid="191" name="Treasure Chamber" tags="tick labyrinth" position="8606,3937" size="100,100">(if: visits is 1)[
You find a tidy pile of gold.
(set: $arg to 350)(display: &quot;UpdateGold&quot;)
](else:)[
You see an empty chamber.
]

(display: &quot;LabyrinthOptions&quot;)</tw-passagedata><tw-passagedata pid="192" name="ForayOptions" tags="" position="7635,3875" size="200,100">(display: &quot;Foray Stats&quot;)
(if: $forayIndex + 1 &gt; $forayStack&#39;s length)[Impassible cliffs rise up from the desert, denying you further progress.  The only way back is the way you came.]
(else:)[(link-reveal: &quot;Onward&quot;)[(set: $forayIndex to it + 1)(goto: $forayStack&#39;s ($forayIndex))]]
(link-reveal: &quot;Return&quot;)[(set: $forayIndex to it - 1)(goto: $forayStack&#39;s ($forayIndex))]</tw-passagedata><tw-passagedata pid="193" name="Empty Desert" tags="foray tick" position="8208,3737" size="100,100">Rolling dunes as far as the eye can see, and a cruel burning sun beating down on you.

(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="194" name="Oasis" tags="foray" position="8208,3864" size="100,100">(if: (random: 0,1) &gt; 0)[
You are able to refresh at this oasis.
(set: $arg to 10 + (random: 0, 10))(display: &quot;UpdateForaySupplies&quot;)
(link-reveal: &quot;Rest For the Day&quot;)[(set: $arg to -5)(display: &quot;UpdateForaySupplies&quot;)(set: $arg to 1 + (random: 0, 1))(display: &quot;UpdateForayCommand&quot;)]
]
(else:)[
It was a mirage.  Boo.
]

(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="195" name="UpdateForayCrew" tags="function" position="7771,3580" size="100,100">(set: $forayCrew to it + $arg)*Foray Crew (if: $arg &gt;= 0)[+] $arg ($forayCrew)*</tw-passagedata><tw-passagedata pid="196" name="Embark on a Sanctioned Foray" tags="" position="7626,4095" size="100,100">The Fortress is so large and elaborate that it still hasn&#39;t been fully explored.  In fact, the topology of the halls and chambers doesn&#39;t exactly mesh with Euclidean space.  Stone palace after stone holdfast, the scale and decoration shifting smoothly, usually, and sometimes quite suddenly and dangerously.

The Zenoarcheological Society has painstakingly mapped out an entry way into the fractal labyrinth.  
(set: _routeLength to (random: 3, 9))The current route planned has _routeLength stops.
(if: $inventory contains any of (a: &quot;Treasure Map&quot;, &quot;Map Fragment&quot;))[
(link-reveal: &quot;Would you like to donate any maps in exchange for longer foray routes?&quot;)[
(for: each _i, &quot;Treasure Map&quot;, &quot;Map Fragment&quot;)[
(set: _item to _i)(link-reveal: _item)[(set: $arg to _item)(display: &quot;LoseItem&quot;)(set: _roll to (either: 1, 1, 1, 2, 2, 3))
Route Bonus + _roll(set: _routeLength to it + _roll)]
]
]
]
(display: &quot;Foray Stats&quot;)
(link-reveal: &quot;Let&#39;s Go!&quot;)[
(set: $forayIndex to 2)(set: $forayExploration to 0)
(set: $forayStack to (a: &quot;Return to the Center of Eastern Fortress&quot;) +
((shuffled: ...(altered: _i via _i&#39;s name, ...(find: _i where _i&#39;s tags contains &quot;foray&quot;, ...(passages:))))&#39;s (range: 1, _routeLength)))

(goto: $forayStack&#39;s ($forayIndex))]

[[Zenoarcheological Society]]</tw-passagedata><tw-passagedata pid="197" name="Embark on a Foray" tags="tick" position="7607.333333333333,3751.6666666666665" size="100,100">The Fortress is so large and elaborate that it still hasn&#39;t been fully explored.  In fact, the topology of the halls and chambers doesn&#39;t exactly mesh with Euclidean space.  Stone palace after stone holdfast, the scale and decoration shifting smoothly, usually, and sometimes quite suddenly and dangerously.

(set: $forayIndex to 1)(set: $forayExploration to 0)
(set: $forayStack to (a: &quot;Return to the Center of Eastern Fortress&quot;) +
((shuffled: ...(altered: _i via _i&#39;s name, ...(find: _i where _i&#39;s tags contains &quot;foray&quot;, ...(passages:))))&#39;s (range: 1,3))
)

(display: &quot;ForayOptions&quot;)

[[Eastern Fortress Foray Gate]]</tw-passagedata><tw-passagedata pid="198" name="LabyrinthOptions" tags="" position="8235,3505" size="200,100">(if: (random: 0, 100) &lt; $chanceOfMinotaur)
[
(display: &quot;Minotaur&quot;)
]
(else:)[
(set: $options to (shuffled: ...(shuffled: ...(find: _i where _i&#39;s tags contains &quot;labyrinth&quot;, ...(passages:)))&#39;s (range: 1,3) + (a:(passage: $labyrinthStack&#39;s last))))

(for: each _i, ...$options)[(set: _item to _i&#39;s name)
(if: _item is $labyrinthStack&#39;s last)[(link-reveal-goto: _item)[(set: $chanceOfMinotaur to it + 5)
(set: $labyrinthStack to $labyrinthStack&#39;s (range: 1, $labyrinthStack&#39;s length - 1))] (if: $inventory contains &quot;Spool of Daedelus&quot;)[!]]
(else:)[(link-reveal-goto: _item)[(set: $chanceOfMinotaur to it + 2)(set: $labyrinthStack to it + (a: (passage:)&#39;s name))]]
]
]</tw-passagedata><tw-passagedata pid="199" name="A Room Full of Hallways" tags="tick labyrinth" position="8489,3618" size="100,100">You are in a stone room with hundreds of adjoining hallways.

(display: &quot;LabyrinthOptions&quot;)</tw-passagedata><tw-passagedata pid="200" name="A Hallway Full of Rooms" tags="tick labyrinth" position="8491,3725" size="100,100">You are in a hallway lined with doors to many small, identical rooms.

(display: &quot;LabyrinthOptions&quot;)</tw-passagedata><tw-passagedata pid="201" name="A Room Full of Rooms" tags="tick labyrinth" position="8494,3835" size="100,100">You are in a cubical room.  Its walls, ceiling, and floor are littered with an orderly distribution of perfectly square doors to other rooms and hallways.

(display: &quot;LabyrinthOptions&quot;)</tw-passagedata><tw-passagedata pid="202" name="A Hallway Full of Hallways" tags="tick labyrinth" position="8503,3943" size="100,100">You are in a hallway that is constantly subdividing every 20, 10, 5, 2.5, 1.75, etc. meters.  You see the withered corpses of a tortoise and a very large human.

(display: &quot;LabyrinthOptions&quot;)</tw-passagedata><tw-passagedata pid="203" name="Return to the Center of Eastern Fortress" tags="tick" position="7998,3497" size="100,100">As you turn each corner, the buildings become more and more familiar to you, until you realize that you&#39;re back in the known City, and the impossible maze is behind you.

(if: $forayCrew &gt; 0)[Your crew file off, having earned their coin, probably back to [[Oasis Refreshments]]. 
(set: $forayCrew to 0)]

[[Eastern Fortress]] 

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="204" name="Maze of Twisty Passages, All Alike" tags="tick labyrinth" position="8596,3622" size="100,100">You are in a maze of twisty passages, all alike.

(display: &quot;LabyrinthOptions&quot;)</tw-passagedata><tw-passagedata pid="205" name="Maze of Twisty Passages, All Different" tags="tick labyrinth" position="8597,3727" size="100,100">You are in a maze of twisty passages, all different.

(display: &quot;LabyrinthOptions&quot;)</tw-passagedata><tw-passagedata pid="206" name="Home of Lost Travellers" tags="foray" position="8208,3994" size="100,100">(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="207" name="Cliff City" tags="foray" position="8203,4100" size="100,100">(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="208" name="Mountain Hermitage" tags="foray" position="8201,4220" size="100,100">(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="209" name="Standing Stones" tags="foray" position="8200,4337" size="100,100">(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="210" name="Toppled Colossus" tags="foray" position="8198,4450" size="100,100">(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="211" name="Migrant Camp" tags="foray" position="8203,4560" size="100,100">(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="212" name="Half-Buried Cucurbit" tags="foray" position="8201,4669" size="100,100">Ifriti, Djinn, myrrh?

(display: &quot;ForayOptions&quot;)</tw-passagedata><tw-passagedata pid="213" name="Vault Heist" tags="heist easternfortress" position="8271,3201" size="100,100">{(set: $moments to 13)
(set: $cunning to 4)(set: $perception to 4)(set: $health to 5)
(set: $inventory to (ds: &quot;Sleeping Phial&quot;, &quot;Flask of Poison&quot;, &quot;Liter of Acid&quot;, &quot;Ritual Dagger&quot;, &quot;Damage Ward&quot;, &quot;Crystal of Detonation&quot;, &quot;Crystal Spyglass&quot;, &quot;Safecracking Kit&quot;, &quot;Belonging Sign&quot;))
(set: $daemons to (ds: &quot;Fire Ghost&quot;, &quot;Living Shadow&quot;))
(set: $disguise to 1)(set: $reputation to (dm: &quot;public&quot;, 7))
(set: $guardHealth to 4)(set: $tellerHealth to 3)(set: $barrierHealth to 0)(set: $vaultCode to 0)(set: $guardianHealth to 5)}
You&#39;re to enter the vault foyer posing as customers.
Once inside the building, you have $moments moments to subdue the two guards on duty.
The tellers will attempt to bring down the anti-theft shield, but we&#39;ve given you a Crystal of Detonation to blast through it.
They should be pretty shook up by that and will be unlikely to put up a fight.
We then have to crack the vault before offsite support becomes onsite support, and you get thrown in gaol.
Inside the vault may be a guardian creature.  Whatever moments remaining can be spent fighting the creature.
Remaining time is converted into liberated treasure.
If you can avoid getting caught, we&#39;ll pull you out with the same portal as all of that sweet, sweet treasure.

[[Let&#39;s Go!]]</tw-passagedata><tw-passagedata pid="214" name="Let&#39;s Go!" tags="" position="8419,3234" size="100,100">Moments Remaining: $moments

You are standing outside the vault office&#39;s front door.  (if: $inventory contains &quot;Belonging Sign&quot;)[ A glamour provides you with the requisite fineries.  Every passerby who sees you perceives you as someone different, someone they trust.  Someone who belongs.(set: $disguise to it + 5)]

In front of the foyer door, you note that your compatriots have inscribed invisible runes of a teleportation spell at the entrance.  If you can get back here with the treasure from the vault, they will transport you and the gold back to the safe house.
(set: $guardOutFront to (either: true, false))
(if: $guardOutFront is true)[
You see a courtesy guard at the front of the vault.(set: $guardHealth to it + 1)
(if: $disguise &gt; 3)[
They allow you to pass unmolested.

[[Enter the Foyer]]

](else:)[
They put up a stink right off the bat!
(set: $guardHealth to it + 2)
[[Fight the Guards]] 
]
](else:)[
[[Enter the Foyer]] 
]</tw-passagedata><tw-passagedata pid="215" name="Enter the Foyer" tags="" position="8543,3236" size="100,100">Moments Remaining: $moments

You press the intercom button and announce yourself.
The door unlocks itself and swings open to invite you into the foyer of the vault.
You stride into the foyer, and the door swings shut behind you.

You cannot back out now.  Next up is the front desk:
- Subdue the Two Guards
- Take out the Anti-Theft Barrier


[[Front Desk]]</tw-passagedata><tw-passagedata pid="216" name="Front Desk" tags="" position="8684,3236" size="100,100">(display: &quot;MomentTick&quot;)
|input&gt;[

You see two portly guards dozing off in front of a trio of bored tellers.
(if: $perception &gt; 3)[They don&#39;t even know, yet, that they&#39;re being robbed.

[[Surprise Attack!]]]

(if: $inventory contains &quot;Sleeping Phial&quot;)[
(link-reveal: &quot;Throw Sleeping Phial&quot;)[
(replace:?input)[You throw the glass phial full of compressed sleeping gas.  It shatters (if: (either: true, false))[in front of the guards, knocking them unconscious!  The tellers manage to drop the enchanted barrier.(set: $barrierHealth to 10)(set: $guardHealth to 0)
[[Examine the Enchanted Barrier]]](else:)[into the tellers&#39; pit, rendering them unconscious.(set: $tellerHealth to 0)
[[Fight the Guards]]]]]]

(if: $inventory contains &quot;Flask of Poison&quot;)[
(link-reveal: &quot;Throw Flask of Poison&quot;)[
(replace:?input)[You throw the glass flask full of compressed poison gas.  It shatters in the midst of the front desk, instantly killing everyone inside. (set: $guardHealth to 0)(set: $tellerHealth to 0)
&quot;A Shameful Display&quot;

[[Examine the Vault Door]] 
]]]]</tw-passagedata><tw-passagedata pid="217" name="Surprise Attack!" tags="" position="8883,3323" size="100,100">Moments Remaining: $moments

(set: $guardHealth to it - (random: 1, $guardHealth))
(if: $guardHealth &lt;= 0)[
You manage to dispatch all sentinels with a swift attack!

[[Subdue the Tellers]]
](else:)[The guard presence is somewhat reduced, but you&#39;ll still need to now fight them!

[[Fight the Guards]] 
]

[[Flee the Heist!]]</tw-passagedata><tw-passagedata pid="218" name="Examine the Enchanted Barrier" tags="" position="8997,3317" size="100,100">(display: &quot;MomentTick&quot;)

It&#39;s essentially a very large, very durable version of the enchantment traps that wizards place for each other in the back alleys of the West Fires.  Anything strong enough to smash through it will release a few tonnes of energy right back at the smasher.

(if: $inventory contains &quot;Crystal of Detonation&quot;)[
The Crystal of Detonation will cut a hole right through that barrier, and the folks on the other side will feel it, too.

[[Use the Crystal of Detonation on the Enchanted Barrier]]
]

In your other hand, you pull out a (set: _offHand to (either: ...($inventory - (ds: &quot;Crystal of Detonation&quot;))))_offHand.

If _offHand is something that can do damage, then you can attempt to destroy it with that and then body the blast.
[[Shatter the Enchanted Barrier]]

[[Flee the Heist!]]</tw-passagedata><tw-passagedata pid="219" name="Fight the Guards" tags="" position="8890,3214" size="100,100">(display: &quot;MomentTick&quot;)
(set: $guardHealth to it - (random: 1, 3))
(if: $tellerHealth &gt; 0 and (either: true, false))[
x(set: $barrierHealth to 10)]
(if: $guardHealth &lt;= 0)[
(if: $barrierHealth &gt; 0)[
While you were dealing with the guards, the tellers were able to get the Enchanted Barrier in place.
[[Examine the Enchanted Barrier]]](else:)[
You hop right over the teller desk.

(if: $tellerHealth &gt; 0)[
[[Subdue the Tellers]] ]

[[Examine the Vault Door]] 
] 
](else:)[
They&#39;re wounded, but still standing.

[[Fight the Guards]] 
]

[[Flee the Heist!]]</tw-passagedata><tw-passagedata pid="220" name="Use the Crystal of Detonation on the Enchanted Barrier" tags="" position="9105,3313" size="100,100">(display: &quot;MomentTick&quot;)
(set: $guardHealth to 0)(set: $tellerHealth to 0)(set: $inventory to it - (ds: &quot;Crystal of Detonation&quot;))(set: $barrierHealth to 0)
The barrier is obliterated in a wholly satisfying cascade of ruined threadwork.  Anyone in the room that had been standing are now in a stupor all about on the floor.  The front desk has been annihilated, allowing you to step through to the vault door beyond.

[[Examine the Vault Door]]</tw-passagedata><tw-passagedata pid="221" name="Shatter the Enchanted Barrier" tags="" position="8997,3467" size="100,100">(display: &quot;MomentTick&quot;)

(if: $inventory contains &quot;Crystal Spyglass&quot;)[
You could use your Crystal Spyglass to pluck on a harmonic flaw in the barrier.

[[Use the Crystal Spyglass to Shatter the Enchanted Barrier]]
](else:)[
You won&#39;t be able to summon enough focused energy to break a shield of that strength without something to use as a lens.
]

[[Flee the Heist!]]</tw-passagedata><tw-passagedata pid="222" name="Flee the Heist!" tags="" position="9147,3467" size="100,100">(if: $loot &gt; 0)[Once you hit the teleportation sigil, you and your haul are warped into the confines of the safe house, guarded by wards against true sight and seers.
[[In the Safe House]] ](else:)[
You leave empty-handed!
Reputation - 2
]</tw-passagedata><tw-passagedata pid="223" name="Examine the Vault Door" tags="" position="9262,3317" size="100,100">(display: &quot;MomentTick&quot;)

You are in front of a vast (either: &quot;stone&quot;, &quot;iron&quot;, &quot;steel&quot;, &quot;brass&quot;, &quot;vanadium&quot;, &quot;adamantium&quot;, &quot;fossil&quot;) vault door, inscribed with runes of protection, runes of safety.

(if: (either: true, false))[
But the runes of safety don&#39;t do much if they left the vault door open during business hours.

(if: (either: true, false))[
[[Loot the Vault-&gt;Fight the Vault Guardian]]
](else:)[
[[Loot the Vault]] 
]
](else:)[
(if: $inventory contains &quot;Crystal of Detonation&quot;)[
You still have the Crystal of Detonation left over.  You want to use it to shortcut this crappe?

[[Use the Crystal of Detonation to Blow The Vault Door]]
]

(if: $inventory contains &quot;Safecracking Kit&quot;)[
[[Crack the Safe]]
]

(if: $vaultCode is 1)[
Of course, you do have the vault code.
[[Loot the Vault]] 
]
]


[[Flee the Heist!]]</tw-passagedata><tw-passagedata pid="224" name="Loot the Vault" tags="" position="9272,3465" size="100,100">(set: $moments to it - (random: 0, 2))(display: &quot;MomentTick&quot;)

You grab a vague amount of treasure in satchels of slight-holding.
(set: $loot to it + (random: 10, 30) * 5)

[[Loot the Vault]] 

[[Flee the Heist!]]</tw-passagedata><tw-passagedata pid="225" name="Use the Crystal of Detonation to Blow The Vault Door" tags="" position="9387,3467" size="100,100">(display: &quot;MomentTick&quot;)
The vault door blows inward with a mighty GUFF!

(either: &quot;The vault had a guardian, but it&#39;s now crushed under three-tonne of vault door.&quot;, &quot;The vault was empty.&quot;)

[[Loot the Vault]]

[[Flee the Heist!]]</tw-passagedata><tw-passagedata pid="226" name="MomentTick" tags="" position="9277,3587" size="100,100">(set: $moments to it - 1)Moments Remaining: $moments(if: $moments &lt;= 0)[(goto: &quot;Down to the Gaol&quot;)]</tw-passagedata><tw-passagedata pid="227" name="Down to the Gaol" tags="" position="9397,3587" size="100,100">You dillied when you should&#39;ve been dallying, or vice versa, or neither.
Either way, you&#39;ve been clapped in irons and dragged through the crowded streets to the local gaol, where you&#39;ll rot for a while until they feel you&#39;ve learned your lesson or conveniently died.


The End?</tw-passagedata><tw-passagedata pid="228" name="Use the Crystal Spyglass to Shatter the Enchanted Barrier" tags="" position="8997,3617" size="100,100">You focus a beam of raw aetherium into what you think is a weak spot in the Barrier&#39;s Pattern.  You guessed right about the weak spot, but you did not correctly predict the subsequent reaction, as deadly forces.
(set: $arg to 5)(set: $deathReason to &quot;The Barrier ruptured outward towards you, shredding everything softer than an oak beam.&quot;)$deathReason
(display: &quot;TakeDamage&quot;)(set: $guardsHealth to 0)(set: $tellerHealth to 0)

[[Examine the Vault Door]] 

[[Flee the Heist!]]</tw-passagedata><tw-passagedata pid="229" name="Fight the Vault Guardian" tags="" position="9507,3467" size="100,100">(display: &quot;MomentTick&quot;)
(set: $guardianHealth to 5)

(display: &quot;Encounter Random Guardian Daemon&quot;)



(event: when $guardianHealth &lt;= 0)[
[[Loot the Vault]] ]

[[Flee the Heist!]] 

(event: when $health &lt;= 0)[(goto: &quot;Down to the Gaol&quot;)]</tw-passagedata><tw-passagedata pid="230" name="In the Safe House" tags="" position="9147,3617" size="100,100">You ended up holding $loot treasure.

After your fence takes their viggerish, your cut is (print: $loot * (1 + (random: 1, 5))) gold.

(if: $loot &gt; 300)[
Your fence throws in a bonus for you!
(set: $arg to &quot;M.C. Escher: Beginner&#39;s Embroidery&quot;)(display: &quot;GetItem&quot;)
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="231" name="Subdue the Tellers" tags="" position="8882,3468" size="100,100">(display: &quot;MomentTick&quot;)
You manage to cow the tellers with some flashy cantrips.  They quickly fill up your satchels with loose treasure that wasn&#39;t yet in the vault.
(set: $loot to it + (random: 2, 15))
Loot -&gt; $loot

[[Demand the Vault Code]]

[[Examine the Vault Door]] 

[[Flee the Heist!]]</tw-passagedata><tw-passagedata pid="232" name="Demand the Vault Code" tags="" position="8883,3623" size="100,100">(display: &quot;MomentTick&quot;)
You use a specialized technique to induce the truth from the terrified teller.

(if: (either: true, false))[
They quickly rattle off the vault code for you.
(set: $vaultCode to 1)
(if: (either: true, false))[ [[Loot the Vault-&gt;Fight the Vault Guardian]]](else:)[ [[Loot the Vault]]]
](else:)[
They don&#39;t seem to know the code!

[[Examine the Vault Door]] 

[[Demand the Vault Code]] 
]

[[Flee the Heist!]]</tw-passagedata><tw-passagedata pid="233" name="Encounter Random Guardian Daemon" tags="" position="9516,3577" size="100,100">|input&gt;[(link-repeat: &quot;Fight the Guardian Daemon&quot;)[
(display: &quot;MomentTick&quot;)
(set: $guardianHealth to it - (random: 0, 3))
(set: $health to it - (random: 0, 3))Health -&gt; $health
]
(event: when $guardianHealth &lt;= 0)[(replace:?input)[The guardian daemon slumps to the floor, its body crumbling into dust.]]]</tw-passagedata><tw-passagedata pid="234" name="Crack the Safe" tags="" position="9468,3279" size="100,100">//safecracking minigame//

(if: (either: true, false))[
[[Loot the Vault-&gt;Fight the Vault Guardian]]
](else:)[
[[Loot the Vault]] 
]</tw-passagedata><tw-passagedata pid="235" name="Hell Hole" tags="location westfires northharbor" position="2480,972" size="200,100">(display: &quot;Init Hell Hole&quot;)
Hot springs, geysers, fumaroles, etc. between West Fires and North Harbor.

You will encounter fire daemons, impassible terrain, and dangerous fumeroles in order to pass over into the other neighborhood.

(set: $pursued to false)
(set: $encounterStack to (shuffled: &quot;Encounter: Fire Ghost&quot;, &quot;Hell Hole: Impassible Cliff&quot;, &quot;Hell Hole: Uncrossable Shoreline&quot;, &quot;Hell Hole: Hot Spring&quot;, &quot;Hell Hole: Exit&quot;
))
(set: $encounterIndex to 1)
(if: $neighborhood&#39;s name is &quot;West Fires&quot;)[(set: $encounterStack to it + (a: &quot;Hell Hole: North Harbor Gate&quot;))]
(else:)[(set: $encounterStack to it + (a: &quot;Hell Hole: West Fires Gate&quot;))]

[[Sally Forth!-&gt;Next Encounter]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="236" name="Init Hell Hole" tags="function" position="2333,852" size="100,100">{(set: $environmentMaterials to (a: &quot;stone&quot;, &quot;stalagmite&quot;, &quot;sulfur&quot;, &quot;calcite&quot;, &quot;dirt&quot;, &quot;sand&quot;, &quot;fossilized wood&quot;, &quot;fossil&quot;))
(set: $environmentColors to (a: &quot;white&quot;, &quot;yellow&quot;, &quot;ochre&quot;, &quot;gray&quot;))
(set: $clothingMaterials to (a: &quot;fur&quot;, &quot;hide&quot;, &quot;flaxen&quot;, &quot;hair&quot;))
(set: $clothingColors to (a: &quot;brown&quot;, &quot;black&quot;, &quot;gray&quot;, &quot;yellowed&quot;, &quot;dun&quot;,&quot;sunbleached&quot;))
(set: $clothingTypes to (a: &quot;loincloth&quot;, &quot;tunic&quot;, &quot;skirt&quot;, &quot;bracers&quot;))
(set: $adornmentMaterials to (a: &quot;bone&quot;, &quot;fossil&quot;, &quot;clay&quot;, &quot;ochre&quot;, &quot;geode&quot;, &quot;glass&quot;))
(set: $adornmentTypes to (a: &quot;horns&quot;, &quot;tusks&quot;))
(set: $hairstyles to (a: &quot;a shaven scalp&quot;, &quot;a bald pate&quot;, &quot;a shaggy mane&quot;,&quot;long matted tendrils&quot;))

(set: $sizes to (a: &quot;scrawny&quot;, &quot;rawboned&quot;))
(set: $races to (a: &quot;human&quot;, &quot;drake-kin&quot;, &quot;goblin&quot;, &quot;devil&quot;))
(set: $skinColors to (a: &quot;black&quot;, &quot;tan&quot;, &quot;brown&quot;, &quot;red&quot;, &quot;gray&quot;))
(set: $skinTypes to (a: &quot;smooth&quot;, &quot;lightly furred&quot;, &quot;fur-covered&quot;, &quot;scaled&quot;))
(set: $professions to (a: &quot;hunter&quot;, &quot;gatherer&quot;, &quot;warlord&quot;))
}
{(set: $neighborhood to 
(dm: &quot;name&quot;, &quot;Hell Hole&quot;, 
&quot;tagname&quot;, &quot;hellhole&quot;,
	&quot;locations&quot;, (a:),
&quot;contracts&quot;, (a:),
		&quot;events&quot;, (a:)))}</tw-passagedata><tw-passagedata pid="237" name="Hell Hole: Impassible Cliff" tags="" position="2760,890" size="100,100">You&#39;ve come up against a cliff that is sheer.  You must retrace your steps and start over.

(set: $encounterStack to (shuffled: ...$encounterStack))
(set: $encounterIndex to 1)
[[Next Encounter]]</tw-passagedata><tw-passagedata pid="238" name="Hell Hole: Uncrossable Shoreline" tags="" position="2765,995" size="100,100">You come up to the shoreline of a vast, boiling lake.  You must retrace your steps and start over.

(set: $encounterStack to (shuffled: ...$encounterStack))
(set: $encounterIndex to 1)
[[Next Encounter]]</tw-passagedata><tw-passagedata pid="239" name="Hell Hole: Hot Spring" tags="" position="2630,1122" size="100,100">You find a hot spring.  You could try to soothe your aches and pains, or you could harvest some mineral samples.

[[Hell Hole: Relax in Hot Spring]]

[[Hell Hole: Harvest Minerals]]

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="240" name="Hell Hole: Exit" tags="" position="2510,1122" size="100,100">You find the exit that you desired.(set: $encounterStack to (a:))
(if: $neighborhood&#39;s name is &quot;West Fires&quot;)[(goto: &quot;Hell Hole: North Harbor Gate&quot;)]
(else:)
[(goto: &quot;Hell Hole: West Fires Gate&quot;)]</tw-passagedata><tw-passagedata pid="241" name="Hell Hole: Relax in Hot Spring" tags="" position="2555,1272" size="100,100">(set: _deadly to (random: 0, 1))
(if: _deadly &gt; 0 and $perception &gt; 2)[It&#39;s not safe to go in there.  You&#39;ll be boiled like a pudding.]
(else:)[It looks quite hot, but not dangerous.]

(link-reveal: &quot;Get In And Relax&quot;)[
(if: _deadly &gt; 0)[(set: $deathReason to &quot;That hot spring was way too hot.  You were boiled like a pudding.&quot;)(goto: &quot;Death&quot;)]
Your body is soothed by the hot, mineral-rich waters and the various extremophiles they support.
(set: $arg to 1)(display: &quot;GainHealth&quot;)
]

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="242" name="Hell Hole: Harvest Minerals" tags="" position="2705,1273" size="100,100">You find a bit of sulfur...  sulphur...  sulfer?

(set: $arg to &quot;Sack of Sulfur&quot;)(display: &quot;GetItem&quot;)

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="243" name="Hell Hole: North Harbor Gate" tags="" position="2526,845" size="100,100">You find the exit that you desired.(set: $encounterStack to (a:))
[[North Harbor]]</tw-passagedata><tw-passagedata pid="244" name="Hell Hole: West Fires Gate" tags="" position="2340,985" size="100,100">You find the exit that you desired.(set: $encounterStack to (a:))
[[West Fires]]</tw-passagedata><tw-passagedata pid="245" name="Damage Ward" tags="item" position="5053,3057" size="100,100">It is a lead damage ward that will block a single strike from a magical or mundane attack.  It&#39;s a good idea to keep one on your body at all times.</tw-passagedata><tw-passagedata pid="246" name="Pamphlet of Cunning" tags="book" position="6080,2124" size="100,100">(either: &quot;Dr.&quot;, &quot;Madame&quot;, &quot;The Magnificent&quot;) (either: &quot;Faustus&quot;, &quot;Cunningham&quot;, &quot;Oxlane-Slern&quot;)&#39;s (either: &quot;Exclusive&quot;, &quot;Impossible&quot;, &quot;Essential&quot;) Guide to Enchantments.

This appears to be a treatise on increasing your magical cunning.
(if: $cunning &gt; 3)[ You are already familiar with all of the techniques it has to offer. ]</tw-passagedata><tw-passagedata pid="247" name="Read Pamphlet of Cunning" tags="tick" position="6193,2123" size="100,100">(display: &quot;Pamphlet of Cunning&quot;)

(either: &quot;Enchantments come in different types: traps, locks, wards, etc.&quot;, &quot;Enchantments are a bit like knots.  See also: Philomender&#39;s Book of Excellent Knots&quot;)

(if: $maxCunning &lt; 3)[
It&#39;s a light pamphlet with only a few basic techniques, but you do learn a bit of cunning from it.

&lt;b&gt;Max Cunning + 1&lt;/b&gt;
(set: $maxCunning to it + 1)(set: $cunning to $maxCunning)
](else:)[It&#39;s a light pamphlet with only a few basic techniques, but you&#39;ve probably learned everything this book could possible offer.]

(link-goto: &quot;Put the Book Away&quot;, (history:)&#39;s last)</tw-passagedata><tw-passagedata pid="248" name="Soul Jar" tags="item" position="5378,2236" size="100,100">The seemingly-delicate blown glass orb has an intricate wrought-iron cage folded around it.  The lid is bone.  Don&#39;t be too curious about what kind.
(if: $perception &gt; 4)
[
Its purpose is to capture aethereal daemons and hold them fast until such time as they become useful, perhaps as a weapon.  A careful fellow will take care that the daemon does not turn on him after being released from captivity.]</tw-passagedata><tw-passagedata pid="249" name="Crystal Spyglass" tags="MagicWeapon item magic-weapon" position="5265,2116" size="100,100">It is a crystal spyglass, which can be used for tricks like focusing beams of sunlight to burn through things.  You&#39;ve never seen a serious wizard with one of these.

(if: $perception + $cunning &gt; 7)
[
You realize that the polarity of the crystal could be changed to make this a very effective sun-based weapon against almost any aethereal opponent.
]</tw-passagedata><tw-passagedata pid="250" name="Use Crystal Spyglass" tags="" position="5385,2112" size="100,100">You adjust the aperture and tesellation until a beam of pure aetherial light lances out from the crystal spyglass.(set: $arg to (random: 1,3))(display: &quot;DealDamage&quot;)
(if: $enemyHealth &lt;= 0)[
(if: $cunning &gt; 3)
[
You catch the light of the sun with the spyglass and refract it at such an angle, it becomes a shear beam of darkenss that deftly sears the $enemyType into pitch black threads.  You snatch a handful from the air before they slip between the photons.

(set: $arg to &quot;Shadow Threads&quot;)(display: &quot;GetItem&quot;)

]
(else:)
[
You wave the spyglass madly, chopping the $enemyType into thousands of tiny fibers that immediately slip away on the wind.
]
]</tw-passagedata><tw-passagedata pid="251" name="Ex Nobilis Aetherium" tags="book" position="6093,2903" size="100,100">A comprehensive guide to the field of practickal daemonology, including instructions on capturing a daemon.</tw-passagedata><tw-passagedata pid="252" name="Read Ex Nobilis Aetherium" tags="" position="6212,2902" size="100,100">&quot;In order to capture a Living Shadow, you will need a Cellar of Salt, this manual, and a Soul Jar in which to receive the aetherial creature.&quot;

(set: _daemon to (shuffled: ...(find: _i where _i&#39;s tags contains &quot;daemon-description&quot;, ...(passages:)))&#39;s 1st&#39;s name)
_daemon
(display: _daemon)

(link-goto: &quot;Put the Book Away&quot;, (history:)&#39;s last)</tw-passagedata><tw-passagedata pid="253" name="Slice of Silver" tags="reagent item" position="5741,2572" size="100,100">() A coin-like segment of silver that has been cut from a longer cylinder. It is heavy and cool.</tw-passagedata><tw-passagedata pid="254" name="Lump of Lead" tags="reagent item" position="5602,2130" size="100,100">() A modest lump of lead about the size of a baby&#39;s fist.
(if: $cunning &gt; 2)[You can trade one of these and a few gold for a Damage Ward in the Market.]</tw-passagedata><tw-passagedata pid="255" name="A Young Wizard&#39;s Primer" tags="book" position="6084,2243" size="100,100">It&#39;s a children&#39;s book.
(if: $perception &gt; 2)
[It was the only book your mother was ever able to afford you.  It is a rudimentary text on the fundamentals of magic.
]</tw-passagedata><tw-passagedata pid="256" name="Read A Young Wizard&#39;s Primer" tags="tick" position="6193,2247" size="100,100">(display: &quot;A Young Wizard&#39;s Primer&quot;)
(if: $perception &gt; 1)
[
(set: _roll to (random: 1, 6))
(if: _roll is 1 or _roll is 2)[
Daemons: Spirits of air and earth and all other elements, bound by their own perverse rules and not the Law of Man.(if: $perception &gt; 2)[
They can be captured by the use of Soul Jars, which can be purchased at the Daemonium in the Marketplace.](if: $perception &gt; 3)[Be forewarned, powerful Archdaemons do not look kindly on humans who imprison their offspring.]]
(else-if: _roll is 3 or _roll is 4)[
Enchantments: Hidden traceries of magical influence devised as a trap for those neither perceptive nor cunning.(if: $perception &gt; 2)[  They can be broken at the cost of blood, or they can be unwound and reused by those cunning enough.](if: $perception &gt; 3)[  A truly advanced wizard can reweave an enchantment as your Old Mother can unravel and reweave a scarf.]]
(else-if: _roll is 5 or _roll is 6)[
Alchemy: Foul chemicals and bilious smokes make for an unpleasant affair.(if: $perception &gt; 2)[  The market prices on potions are 5 times the price you would pay to make them at home.](if: $perception &gt; 3)[  And you&#39;re likely to blow your hands off as make anything useful if you don&#39;t know the recipe, and alchemists jealously guard their recipes.]
]]

[[Read A Young Wizard&#39;s Primer]]

(link-goto: &quot;Put the Book Away&quot;, &quot;Read a Book In Your Library&quot;)</tw-passagedata><tw-passagedata pid="257" name="Pocket Lint" tags="reagent item" position="5495,2234" size="100,100">Yes.  Pocket Lint.</tw-passagedata><tw-passagedata pid="258" name="Percepo de Cristal" tags="book" position="6088,2363" size="100,100">This appears to be a treatise on increasing your magical perception.
(if: $perception &gt; 3)[You are already familiar with all of the techniques it has to offer.]</tw-passagedata><tw-passagedata pid="259" name="Read Percepo de Cristal" tags="tick" position="6218,2359" size="100,100">(display: &quot;Percepo de Cristal&quot;)

It&#39;s a slim guide with a few basic techniques about the use of a Crystal Spyglass to perceive magical traceries.  (if: $maxPerception &lt; 4)[(if: $inventory contains &quot;Crystal Spyglass&quot;)[You use your spyglass to practice some techniques of magical perception.
&lt;b&gt;Perception + 1&lt;/b&gt;
(set: $maxPerception to it + 1)(set: $perception to $maxPerception)
](else:)[You really must have a spyglass to get any benefit from these techniques.
]](else:)[You&#39;ve already mastered these simple techniques, and the additional eye strain has the opposite of the intended effect.
&lt;b&gt;Perception - 1&lt;/b&gt;
(set: $maxPerception to it - 1)(set: $perception to $maxPerception)
]
[[Continue Reading-&gt;Read Percepo de Cristal]]
(link-goto: &quot;Put the Book Away&quot;, &quot;Read a Book In Your Library&quot;)</tw-passagedata><tw-passagedata pid="260" name="Vivification Chamber" tags="furniture" position="5381,2379" size="100,100">It&#39;s a glass cylinder with brass fittings large enough for a grown man to climb inside.  It&#39;s intended to bombard the user with eldritch energy, instantly refreshing their cunning, perception, and vitality.</tw-passagedata><tw-passagedata pid="261" name="Use Vivification Chamber" tags="" position="5489,2377" size="100,100">(set: $cunning to $maxCunning)(set: $perception to $maxPerception)(set: $health to $maxHealth)(display: &quot;UpdateClock&quot;)
You feel immediately rejuvenated.  You&#39;d rather not do this too often, because it does quite make your molars ache.

(link-goto: (history:)&#39;s last)</tw-passagedata><tw-passagedata pid="262" name="Scrying Stone" tags="furniture" position="5381,2497" size="100,100">It is a classic crystal ball on a wooden stand, perched on top of a little round table, covered in a velveteen table cloth.  Within it are shown glimpses of possibility-space.  Those with the perceptive skills can use this information to warn them of dangers.</tw-passagedata><tw-passagedata pid="263" name="Use Scrying Stone" tags="" position="5489,2498" size="100,100">(if: $currentContract is &quot;&quot;)[You have to have an active interest in someone for the stone to work.
]
(else:)[
(if: $ticks - $scryingStoneCooldown &gt; 13)[(set: $enchantmentHidden to it - 1)(set: $scryingStoneCooldown to $ticks)
You gaze into the stone and lock eyes with your quarry.  You see bits of their plan, the back side of their cunning, the weft of their enchantments.
]
(else:)[The part of your brain that can interface with this device is still in a state of mild shock from the last time you used it.  You should get more rest.
]
]

(link-goto: (history:)&#39;s last)</tw-passagedata><tw-passagedata pid="264" name="Potion Automixer" tags="furniture" position="5382,2605" size="100,100">This clever device takes two reagents and combines them into a specific alchemical potion, with no training or dexterity required.</tw-passagedata><tw-passagedata pid="265" name="Use Potion Automixer" tags="" position="5497,2606" size="100,100">First, select the left reagent.
Second, select the right reagent.
Third, light the burner.
Four, take the potion. 
|input&gt;[{
(if: (find: _item where (passage: _item)&#39;s tags contains &quot;reagent&quot;, ...$inventory)&#39;s length &lt; 2)[You&#39;ve got to get at least two reagents to rub together, my friend.](else:)[
Left Reagent:	(dropdown: bind _left, ...(find: _item where (passage: _item)&#39;s tags contains &quot;reagent&quot;, ...$inventory))	Right Reagent:	(dropdown: bind _right, ...(find: _item where (passage: _item)&#39;s tags contains &quot;reagent&quot;, ...$inventory))
&lt;br/&gt;&lt;br/&gt;
(link-reveal: &quot;Mix Reagents&quot;)[(replace:?input)[_left + _right = ]
(replace:?output)[
(set: $inventory to $inventory - (ds: _left, _right))
(if: (ds: _left, _right) contains all of (ds: &quot;Shadow Threads&quot;, &quot;Quaff of Quicksilver&quot;))[
(set: $inventory to it + (ds: &quot;Ink of Enchantment&quot;))You have produced
[[Ink of Enchantment]]
]
(if: (ds: _left, _right) contains all of (ds: &quot;Sack of Sulfur&quot;, &quot;Quaff of Quicksilver&quot;))[
(set: $inventory to it + (ds: &quot;Cunning Draught&quot;))You have produced
[[Cunning Draught]]
]
(else:)[
(if: (random: 0, 10) &gt; 5)[You have produced nothing.  Thankfully, you&#39;ve salvaged the reagents.(set: $inventory to $inventory + (ds: _left, _right))](else:)[You have produced a stinking mass of refuse instead of a potion or tincture. (set: $inventory to it + (ds: &quot;Stinking Mass&quot;))]]
]]]}]
*|output&gt;[]*

[[Home Again]]

*Recipes sold separately</tw-passagedata><tw-passagedata pid="266" name="Rack of Torment" tags="furniture" position="5378,2711" size="100,100">A wooden rack for storing daemons in Soul Jars.</tw-passagedata><tw-passagedata pid="267" name="Use Rack of Torment" tags="" position="5498,2717" size="100,100">The Rack of Torment is not the kind of the thing that you have to actively use.  You just keep your Soul Jar&#39;s full of daemons on it when you&#39;re not traipsing about casting lightning bolts at assassins.  It&#39;s special wood or something...  daemons seem to like it...

[[Home Again]]</tw-passagedata><tw-passagedata pid="268" name="Trap Book" tags="book" position="6088,2560" size="100,100">This is a book with a seemingly innocuous title that is secretly a hedgemaze style encounter.  It will be dangerous, but it will contain information relevant to a high level encounter.
(if: $perception &gt; 10)[Holy shit, it is dangerous, but totally worth it!]</tw-passagedata><tw-passagedata pid="269" name="Read Trap Book" tags="" position="6204,2535" size="100,100">(goto: &quot;Inside the Trap Book&quot;)</tw-passagedata><tw-passagedata pid="270" name="Inside the Trap Book" tags="tick" position="6203,2648" size="100,100">Add a weird branching encounter thing where the player has to use the Back button to get a passcode from one part of the maze to another.</tw-passagedata><tw-passagedata pid="271" name="Grimoire Alchemickal" tags="book" position="6088,2781" size="100,100">This foul-smelling tome has both water damage and scorch marks testifying to its authenticity as a book that belonged to a former alchemist, current scorch mark.</tw-passagedata><tw-passagedata pid="272" name="Read Grimoire Alchemickal" tags="tick" position="6207,2781" size="100,100">Even if the book hadn&#39;t been soaked in what appears to be urine, the handwriting is already borderline inscrutable.  The best you can find is a chart of which combinations didn&#39;t explode:

Lead + Saltpetre = (if: $perception &gt; 4)[Explosion!](else:)[????????]
Pocket Lint + Saltpetere = (if: $perception &gt; 4)[Explosion!](else:)[????????]
Lead + Pocket Lint = (if: $perception &gt; 4)[No Explosion :(](else:)[????????]

(link-goto: &quot;Put the Book Away&quot;, &quot;Read a Book In Your Library&quot;)</tw-passagedata><tw-passagedata pid="273" name="The Compleat History of Magickal Artifacts Vol. I" tags="book" position="6321,2123" size="100,100">(if: $perception &gt; 3)[The combination of exaggeration, inaccuracies, and outright lies in this book would probably completely ruin your brain if you thought you could trust anyone anymore.
(if: $cunning &gt; 4)[That said, there&#39;s the bones of a few good ideas here.  ]]
(else:)[It&#39;s a fairly respected guide to various magical artifacts and how they work.  You&#39;re really having trouble working out how half of these gimmicks are supposed to work. Perhaps a more perceptive wizard could make heads and/or tails of it.]</tw-passagedata><tw-passagedata pid="274" name="Read The Compleat History of Magickal Artifacts Vol. I" tags="tick" position="6429,2122" size="100,100">Crystal Spyglass: v. good magick for wanton enslayment of creatures aetherial and daemonick

(link-goto: &quot;Put the Book Away&quot;, &quot;Read a Book In Your Library&quot;)</tw-passagedata><tw-passagedata pid="275" name="The Complete History of History" tags="book" position="6327,2247" size="100,100">This tome purports to be an exhaustive history of the Universe from the time of the Really Big Explosion to the publication date of the book in the 25th year of the ancient (either: &quot;Blood&quot;, &quot;Dark&quot;, &quot;Cursed&quot;) (either: &quot;War&quot;, &quot;Ages&quot;, &quot;Times&quot;).</tw-passagedata><tw-passagedata pid="276" name="Read The Complete History of History" tags="tick" position="6435,2247" size="100,100">(unless: (history:) contains &quot;Read The Complete History of History&quot;)[Once, long ago, in a cloud of undifferentiated physical particles, one of the particles collided with another particle...]  
which collided with another particle...
[[Continue Reading-&gt;Read The Complete History of History]]

(link-goto: &quot;Put the Book Away&quot;, &quot;Read a Book In Your Library&quot;)</tw-passagedata><tw-passagedata pid="277" name="Sack of Sulfur" tags="reagent item" position="5607,2238" size="100,100">(|) Inside the coarse sack is lumps of yellow powder that reek of rotten eggs and the Gates of Hell.</tw-passagedata><tw-passagedata pid="278" name="Chunk of Chalk" tags="reagent item" position="5716,2130" size="100,100">A chunk of white chalk from the cliffs of a seaside village, composed of the uncountable skeletons of tiny sea creatures from beyond human comprehensible time.</tw-passagedata><tw-passagedata pid="279" name="Grain of Gold" tags="reagent item" position="5717,2237" size="100,100">() A small wax pouch with small pieces of pure gold.</tw-passagedata><tw-passagedata pid="280" name="Piece of Pitch" tags="reagent item" position="5609,2344" size="100,100">This black lump is technically a liquid, but it flows so slowly at room temperature that it appears to be completely motionless.</tw-passagedata><tw-passagedata pid="281" name="Quaff of Quicksilver" tags="reagent item" position="5718,2342" size="100,100">() A glass vial of quicksilver sold as a single-use quack remedy drink.</tw-passagedata><tw-passagedata pid="282" name="Healing Draught" tags="item potion" position="5848,2133" size="100,100">A single dose potion of healing is designed to knit your tissues back together.  There&#39;s a nonzero chance that it will knit them together too well and prevent your organs from functioning or your blood from flowing.
(if: $inventory contains &quot;Healing Draught&quot;)[ (link-reveal: &quot;Use Healing Draught&quot;)[(display: &quot;Use Healing Draught&quot;)] ]</tw-passagedata><tw-passagedata pid="283" name="Use Healing Draught" tags="" position="5958,2135" size="100,100">(if: ($ticks % $cunning) is 0)[(set: $health to 0)(set: $deathReason to &quot;Your organs sieze up, essentially strangling everything in your body simultaneously.  The triumphant never eat lotuses.&quot;)(goto: &quot;Death&quot;)]
(else:)[(set: $health to $maxHealth + 1)(set: $inventory to it - (ds: &quot;Healing Draught&quot;))You toss back the tiny potion and feel an immediate warming sensation flush through you.  You feel even better than you normally do.  You&#39;d quite fancy another.](display: &quot;UpdateClock&quot;)</tw-passagedata><tw-passagedata pid="284" name="Cunning Draught" tags="item potion" position="5848,2247" size="100,100">Some kind of patent medicine, a &quot;nootropic&quot;, guaranteed to give you enhanced cunning!  Unfortunately, one possible side effect is temporary death syndrome.

(if: $inventory contains &quot;Cunning Draught&quot;)[
(link-reveal: &quot;Use Cunning Draught&quot;)[(display: &quot;Use Cunning Draught&quot;)]]</tw-passagedata><tw-passagedata pid="285" name="Use Cunning Draught" tags="" position="5962,2248" size="100,100">(set: $inventory to it - (ds: &quot;Cunning Draught&quot;))You toss back the tiny potion and feel an immediate wave of cool clarity resolve your brain meat.
(if: ($ticks % $cunning) is 0)[Instead of doing anything useful, you wasted the brief moment of clarity contemplating your belly lint.
(set: $arg to -1)(display: &quot;UpdateCunning&quot;)
](else:)[(set: $arg to 4)(display: &quot;UpdateCunning&quot;)](display: &quot;UpdateClock&quot;)</tw-passagedata><tw-passagedata pid="286" name="Stimulating Draught" tags="item potion" position="5848,2350" size="100,100">A potion to improve perception.
(if: $inventory contains &quot;Stimulating Draught&quot;)[
(link-reveal: &quot;Use Stimulating Draught&quot;)[(display: &quot;Use Stimulating Draught&quot;)]]</tw-passagedata><tw-passagedata pid="287" name="Use Stimulating Draught" tags="" position="5964,2353" size="100,100">(if: ($ticks % $cunning) is 0)[(set: $perception to 0)Oh, goodness, you&#39;re blind.]
(else:)[(set: $perception to $perception + 4)(set: $inventory to it - (ds: &quot;Stimulating Draught&quot;))You toss back the tiny potion and feel as if you are suddenly aware of the very threads of energy flowing through the air.]
(display: &quot;UpdateClock&quot;)</tw-passagedata><tw-passagedata pid="288" name="Poison Flask" tags="item potion" position="5852,2463" size="100,100">A crystalline jar of swirling greenish gas.</tw-passagedata><tw-passagedata pid="289" name="Sleeping Phial" tags="item potion" position="5849,2571" size="100,100">A single dose of powerful sedative for creatures with lungs and blood.</tw-passagedata><tw-passagedata pid="290" name="Potion Replicator" tags="furniture" position="5388,2831" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="291" name="Use Potion Replicator" tags="" position="5500,2829" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="292" name="Gold Loom" tags="furniture" position="5385,2944" size="100,100">Late game item that makes money irrelevant.</tw-passagedata><tw-passagedata pid="293" name="Aleph" tags="furniture" position="4047,5725" size="100,100">A portal to every possible location in the Unity.</tw-passagedata><tw-passagedata pid="294" name="Mystery Draught" tags="item potion" position="5838,2691" size="100,100">This mysterious potion&#39;s color is constantly changing.

(if: $inventory contains &quot;Mystery Draught&quot;)[ [[Use Mystery Draught]]]</tw-passagedata><tw-passagedata pid="295" name="Ink of Enchantment" tags="reagent item" position="5618,2464" size="100,100">The aetherial substance used by mere mortals to physically bind fields of magic to objects and space.  Typically used to create traps, energy sources, prisons, and killing machines.  Also has some scholarly value, which is the only reason it&#39;s allowed on the market at all.</tw-passagedata><tw-passagedata pid="296" name="Read The Complete History of Your Time Since Moving to the City" tags="tick" position="6436,2361" size="100,100">Chapter I:
(for: each _item, ...(history:))[_item
]

(link-goto: &quot;Put the Book Away&quot;, &quot;Read a Book In Your Library&quot;)</tw-passagedata><tw-passagedata pid="297" name="The Complete History of Your Time Since Moving to the City" tags="book" position="6321,2364" size="100,100">A pamphlet entitled &quot;The Complete History of Your Time Since Moving to the City&quot;. From a cursory glance, it appears to be completely accurate in a somewhat workmanlike manner, more like a weird accounting of the details of your life than any kind of real narrative.</tw-passagedata><tw-passagedata pid="298" name="Shadow Threads" tags="reagent item" position="5738,2460" size="100,100">The strange fibers left behind if a daemon is slain in certain ways, such as with a magical weapon.  Known to be of some use in alchemical craft.</tw-passagedata><tw-passagedata pid="299" name="Ethereal Threads" tags="reagent item" position="5620,2572" size="100,100">The energized threads of magical energy that remain if the skein of an enchantment is unwoven without breaking any loops.  May also be held in this form prior to casting an echantment, such as when needing to quickly set a trap enchantment while being pursued.</tw-passagedata><tw-passagedata pid="300" name="Noble Cowl" tags="item" position="6498,2886" size="100,100">An accessory that signifies you are allowed to walk the streets in the Upper Castlerock.  They are hard to come by.

If you are of the class of people who are, perhaps not Nobles, but are allowed to live in Upper Castlerock *with* the Nobles.</tw-passagedata><tw-passagedata pid="301" name="Compass of Many Places" tags="item" position="5970,3360" size="100,100">This artifact tells you the relative direction to your least dangerous location in the current multiversal coordinates...  and the most.</tw-passagedata><tw-passagedata pid="302" name="Use Compass of Many Places" tags="" position="6087,3360" size="100,100">[[Compass of Many Places]]</tw-passagedata><tw-passagedata pid="303" name="Smoke Bomb" tags="item" position="5841,2801" size="100,100">A throwable potion bomb that both produces a blinding smoke and teleports you back home.
(if: $inventory contains &quot;Smoke Bomb&quot;)[ [[Use Smoke Bomb]] ]</tw-passagedata><tw-passagedata pid="304" name="Use Smoke Bomb" tags="" position="5963,2799" size="100,100">(set: $inventory to it - (ds: &quot;Smoke Bomb&quot;))You smash the smoke potion on the ground, producing a thick cloud of blinding smoke.
[[Teleport to Safety-&gt;Home Again]]</tw-passagedata><tw-passagedata pid="305" name="Badge of Shame" tags="item" position="6395,3200" size="100,100">As punishment for behavior unbecoming a mercenary magician, your face was mutilated with a razor for all to see.</tw-passagedata><tw-passagedata pid="306" name="Shadow Passenger" tags="item" position="6709,3202" size="100,100">Ever since you came back from the Afterlife, you&#39;ve noticed the feeling like you&#39;ve got a passenger riding around in your body with you.  You&#39;ve managed to use divination magic to determine that the passenger is real, but not what or who it is.</tw-passagedata><tw-passagedata pid="307" name="Hand of Glory" tags="item" position="5850,3133" size="100,100">This is the severed hand of a thief prepared with an appallingly specific and complicated technique that we won&#39;t bother describing.  It has the property of making you magically invisible to your enemies.  You can use it to bypass encounters.
(if: (history:)&#39;s last is &quot;Inventory&quot;)[
(link-reveal: &quot;Use Hand of Glory&quot;)[
With a cantrip, you light the Hand of Glory.  Its light somehow makes the air around you even gloomier.
(if: (random: 0, 6) is 0)[This is the last gasp of the Hand of Glory. (set: $inventory to it - (ds: &quot;Hand of Glory&quot;))](else:)[The old hand still has some fat left in it.]
[[Sneak Past-&gt;Next Encounter]] 
]]</tw-passagedata><tw-passagedata pid="308" name="Neighborhood Door to North Harbor" tags="furniture" position="5386,3062" size="100,100">When you want to move to a new neighborhood, you get yourself a new door.  Or, if you&#39;re mister fancypants, you can get multiple neighborhoods.

This door takes you to the neighborhood of North Harbor.</tw-passagedata><tw-passagedata pid="309" name="Use Neighborhood Door to North Harbor" tags="" position="5506,3052" size="100,100">You open the door to a brisk vista of the North Harbor, a part of the City where ships float through a howling rift in the space-time in search of treasure and adventure.

[[North Harbor]]</tw-passagedata><tw-passagedata pid="310" name="Neighborhood Door to South Quarry" tags="furniture" position="5386,3173" size="100,100">When you want to move to a new neighborhood, you get yourself a new door.  Or, if you&#39;re mister fancypants, you can get multiple neighborhoods.

This door takes you to the neighborhood of South Quarry.</tw-passagedata><tw-passagedata pid="311" name="Use Neighborhood Door to South Quarry" tags="" position="5499,3172" size="100,100">You open the door and a silty wind blows through and nearly knocks over your drinks cart.
Through the frame, you see a vast mining operation carved out of a transcendental mineral deposit.

[[South Quarry]]</tw-passagedata><tw-passagedata pid="312" name="Neighborhood Door to Eastern Fortress" tags="furniture" position="5383,3294" size="100,100">When you want to move to a new neighborhood, you get yourself a new door.  Or, if you&#39;re mister fancypants, you can get multiple neighborhoods.

This door takes you to the neighborhood of Eastern Fortress.</tw-passagedata><tw-passagedata pid="313" name="Use Neighborhood Door to Eastern Fortress" tags="" position="5502,3296" size="100,100">When you open the door, you are treated to the smell of fresh, hot food being slowly roasted over braziers.  Hallucinogenic resins are being burned for recreation by enchanted creatures in silver jewelry.

[[Eastern Fortress]]</tw-passagedata><tw-passagedata pid="314" name="Neighborhood Door to Upper Castlerock" tags="furniture" position="5383,3406" size="100,100">When you want to move to a new neighborhood, you get yourself a new door.  Or, if you&#39;re mister fancypants, you can get multiple neighborhoods.

This door takes you to the neighborhood of Upper Castlerock.</tw-passagedata><tw-passagedata pid="315" name="Use Neighborhood Door to Upper Castlerock" tags="" position="5502,3407" size="100,100">Everything you see through this door appears to be cast in a golden light, as if the air was full of invisible motes of gold dust.

[[Upper Castlerock]]</tw-passagedata><tw-passagedata pid="316" name="Random Bulk Scroll" tags="" position="3512.3333333333335,477.6666666666667" size="100,100">//(either: &quot;You scrape the barnacles off of a bale of scrolls and find the only legible text.&quot;, &quot;You crack open a scrollcase and find a fragment of text.&quot;, &quot;You open a dainty wooden box and find a document within.&quot;, &quot;You unroll a scroll made of troll parchment.&quot;)  
(either: &quot;The scroll is so badly soaked in &quot; + (either: &quot;cometmelt&quot;, &quot;narwhal oil&quot;, &quot;siren tears&quot;, &quot;blood&quot;, &quot;saltwater&quot;, &quot;ink&quot;) + &quot; that it is illegible.&quot;, &quot;The sodden logbook tells the tale of a &quot; + (either: &quot;doomed&quot;, &quot;cursed&quot;, &quot;foolhardy&quot;, &quot;forsaken&quot;, &quot;glorious&quot;, &quot;typical&quot;, &quot;relatively uneventful&quot;) + &quot; voyage through &quot; + (either: &quot;eternal&quot;, &quot;a short segment of&quot;, &quot;endless&quot;, &quot;rough and choppy&quot;, &quot;smooth&quot;, &quot;a realm of&quot;) + &quot; &quot; + (either: &quot;living&quot;, &quot;churning&quot;, &quot;synthetic&quot;, &quot;waves of&quot;, &quot;fractal branches of&quot;, &quot;incredibly hot&quot;, &quot;relentless&quot;) + &quot; &quot; + (either: &quot;darkness&quot;,&quot;light&quot;,&quot;ocean&quot;,&quot;warpscapes&quot;,&quot;possibility space&quot;,&quot;hellscape&quot;,&quot;beauty&quot;, &quot;terror&quot;, &quot;agony&quot;, &quot;adventure&quot;) + &quot;.  Mostly lies.&quot;, &quot;... &quot; + (either: &quot;mmMMam&quot;, &quot;madfMAdfm&quot;, &quot;MADfcvijcx&quot;, &quot;cometmelt&quot;, &quot;eternal&quot;, &quot;forsaken&quot;, &quot;incredibly hot&quot;) + &quot;... &quot; + (either: &quot;MmdasVC&quot;, &quot;CVCsddf&quot;, &quot;qwerZCVT&quot;, &quot;discovered the cure for&quot;, &quot;a rare and contagious&quot;, &quot;untold wealth&quot;, &quot;dire passages&quot;) + &quot;... &quot; + (either: &quot;ajkdfoslw&quot;, &quot;ADcvxfd&quot;, &quot;iozcosdkfja&quot;, &quot;interlocutions with archdaemons&quot;, &quot;forbidden steps of the shadow temple&quot;, &quot;honeyed halls of the bee queen&quot;) + &quot;... &quot;,
&quot;The fevered scratchings of a mad Riftrunner, with... &quot; + (either: &quot;someone&#39;s blood&quot;, &quot;shite&quot;, &quot;ashes&quot;) + &quot; as ink.  Sadly, it&#39;s in 3rd-Degree Post-factional Esperanto, which hardly anyone speaks.&quot;,
&quot;Memento Mori... Memores sumus vestri in viveret.&quot;,
&quot;I have discovered a truly marvelous proof of this, which this margin is too narrow to contain...&quot;,
&quot;...&quot; + (either: &quot;quid&quot;, &quot;bones&quot;, &quot;RATS&quot;) + &quot;...&quot; + (either: &quot;wouldn&#39;t stop screaming&quot;, &quot;begged but I wouldn&#39;t kill them&quot;, &quot;but we thought we could make it out in time&quot;) + &quot;...&quot; + (either: &quot;and then the whole thing started to loop again&quot;, &quot;beware the sirens and their lies&quot;, &quot;it wasn&#39;t an iceberg at all but a&quot;) + &quot;...&quot;
)//</tw-passagedata><tw-passagedata pid="317" name="Macro Caster" tags="furniture" position="5399,3871" size="100,100">A cute gimmick that let&#39;s you reproduce the events of someone&#39;s real history in the confines of your own home!

It contains blank gallium plates that you use to imprint an event.  It can then replay the events in any order you choose.

It is currently programmed thusly:
(print: $macroCasterPlates)</tw-passagedata><tw-passagedata pid="318" name="Use Gold Loom" tags="" position="5503,2940" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="319" name="Ward Press" tags="furniture" position="5387,3747" size="100,100">Lead goes in and Wards come out.</tw-passagedata><tw-passagedata pid="320" name="Use Ward Press" tags="" position="5503,3748" size="100,100">(if: $cunning + $perception &gt;= 7)[
First, select the left reagent ().
Second, select the right reagent ().
Third, light the burner.
Four, take the ward.*
 
(if: $inventory contains &quot;Lump of Lead&quot; and $inventory contains &quot;Quaff of Quicksilver&quot;)[(set: $inventory to it - (ds: &quot;Lump of Lead&quot;))(set: $inventory to it + (ds: &quot;Damage Ward&quot;))
You have produced
Damage Ward]

*Recipes sold separately
]
(else:)[
The instructions say that it&#39;s easy, but clearly there&#39;s some knack to doing it that you haven&#39;t cottoned to, yet.
]

(link-goto: (history:)&#39;s last)</tw-passagedata><tw-passagedata pid="321" name="Stinking Mass" tags="reagent item" position="5627,2682" size="100,100">This Stinking Mass is a fetid wad of waste product from a potion gone awry.</tw-passagedata><tw-passagedata pid="322" name="Love Potion" tags="item potion" position="5969,2580" size="100,100">A powerful placebo.</tw-passagedata><tw-passagedata pid="323" name="Witch Bottle" tags="item" position="5845,3471" size="100,100">Variations exist: Typically, a jar or bottle filled with a mix of pins and piss.  Make you one and hide it well above a door or beneath a floor.  Its presence is intended to confound and deter witches and witchcraft.</tw-passagedata><tw-passagedata pid="324" name="Riftrunner&#39;s Badge" tags="item" position="6498,2992" size="100,100">This is an enchanted tattoo inscribed on the skin of someone who wishes to cross the Rift to the North without its arcane energies tearing them to shreds.  Typically placed on the back of hand or the throat in glowing blue ink.  Some people complain that even after leaving the Rift, it keeps calling them back.</tw-passagedata><tw-passagedata pid="325" name="Slow Clock" tags="item" position="5841,2905" size="100,100">Trying to tell what time the clock is displaying will cause a severe migraine.  It is housed in an ornate silver case, with a chain that fades into the 4th spatial dimension and a convenient push button that activates its primary ability.
(if: $inventory contains &quot;Slow Clock&quot;)[ [[Use Slow Clock]] ]</tw-passagedata><tw-passagedata pid="326" name="Use Slow Clock" tags="" position="5961,2911" size="100,100">(if: $inventory contains &quot;Clockwork Key&quot;)[
You notice that your Clockwork Key fits perfectly into the keyslot in the back of the Clock.  You can set the amount of time.
|input&gt;[

Time: (cycling-link: bind $arg, 1, 2, 3)

(link-reveal: &quot;Recall To The Past&quot;)[(replace:?input)[
(set: $encounterIndex to it - (num: $arg))(set: $ticks to it - 3 * (num: $arg))
You get that rubber-faced feel as if falling from a great height as your local time frame moves several minutes into the past.

[[Next Encounter-&gt;Encounter]]
]]
(link-reveal: &quot;Transport To The Future&quot;)[(replace:?input)[
(set: $encounterIndex to it + (num: $arg))(set: $ticks to it + (num: $arg) * 3)
Your eyes and skin burn as you accelerate several minutes into the future.  Unfortunately, in this future, you no longer have the Slow Clock. (set: $inventory to it - (ds: &quot;Slow Clock&quot;))

[[Next Encounter-&gt;Encounter]]
]]]
]
(else:)[
(if: (random: 0, 1) is 0)[(set: $encounterIndex to it - 1)(set: $ticks to it - 3)
You get that rubber-faced feel as if falling from a great height as your local time frame moves several minutes into the past.

[[Next Encounter-&gt;Encounter]]
](else:)[(set: $encounterIndex to it + 1)(set: $ticks to it + 3)
Your eyes and skin burn as you accelerate several minutes into the future.  Unfortunately, in this future, you no longer have Slow Clock. (set: $inventory to it - (ds: &quot;Slow Clock&quot;))

[[Next Encounter-&gt;Encounter]]
]]</tw-passagedata><tw-passagedata pid="327" name="Passage Ticket" tags="item" position="6188,3239" size="100,100">Proof of payment for a full expedition:
- crew
- supplies
- a ship

You&#39;ll use this ticket to board the ship, and then you will be on your way into the transdimensional rift to see what exotic treasures you can hopefully return with.</tw-passagedata><tw-passagedata pid="328" name="Captain&#39;s Hat" tags="item" position="6201,3135" size="100,100">Owning this proves that you are capable of commanding a ship.  Worn with pride.</tw-passagedata><tw-passagedata pid="329" name="Cursed Mirror" tags="item" position="6210,3022" size="100,100">This mirror reflects a distorted version of the world. (if: $inventory contains &quot;Shadow Passenger&quot;)[  When you look at it, you see something that looks and dresses much like you.  Just everything slightly different, slightly off-kilter.  It grins at the same time as you, its teeth like broken razor blades. ](else:)[ When you look at it, you&#39;re upside down and backwards in the reflection.]</tw-passagedata><tw-passagedata pid="330" name="Philomender&#39;s Book of Excellent Knots" tags="book" position="6341,2535" size="100,100">A book full of excellent knots, both physical and in the form of enchantments.</tw-passagedata><tw-passagedata pid="331" name="Read Philomender&#39;s Book of Excellent Knots" tags="tick" position="6459,2540" size="100,100">You are fascinated by this book, which explains everything from simple concepts like the Gordian Knot to the true mysteries like why christmas tree lights get tangled even if you don&#39;t touch or move them for a year.

(link-goto: &quot;Put the Book Away&quot;, &quot;Read a Book In Your Library&quot;)</tw-passagedata><tw-passagedata pid="332" name="Hearthstone" tags="item" position="5970,3130" size="100,100">This slight-warm-to-the-touch red-orange gemstone can instantly transport you from any location in the universe, space and/or time, to your very home.  Self-destructs upon use.

(if: $inventory contains &quot;Hearthstone&quot;)[[Use Hearthstone]]]</tw-passagedata><tw-passagedata pid="333" name="Use Hearthstone" tags="" position="6096,3133" size="100,100">You crush the stone in your fist.  Each grain of dust in the stone binds with your elemental essence and then immediately collapses a suspended lode enchantment, returning you in your exact current condition back to your home.

(set: $arg to &quot;Hearthstone&quot;)(display: &quot;LoseItem&quot;)

[[Home Again]]</tw-passagedata><tw-passagedata pid="334" name="The True History of Leng" tags="book" position="6334,2649" size="100,100">A purported history of an ancient extinct semi-aquatic species of wizards.</tw-passagedata><tw-passagedata pid="335" name="Read The True History of Leng" tags="tick" position="6449,2656" size="100,100">Mostly rubbish.  Nice illustrations, though.

(link-goto: &quot;Put the Book Away&quot;, &quot;Read a Book In Your Library&quot;)</tw-passagedata><tw-passagedata pid="336" name="Litre of Saltpetre" tags="item reagent" position="5728,2679" size="100,100">(K2CO3) Keep away from open flame, unless you actually want a big dangerous fire, which is definitely something that comes in handy.</tw-passagedata><tw-passagedata pid="337" name="Sharpened Teeth" tags="item" position="6497,3097" size="100,100">You&#39;ve been given a fine set of sharpened teeth by a tribe of sea dayaks who share some of your hobbies.</tw-passagedata><tw-passagedata pid="338" name="Blank Scroll" tags="reagent book" position="5628,2802" size="100,100">This is a palimpsest, a page scraped as clean of its old words as possible so that it may be reused again.  Useful for inscribing spells and enchantments.</tw-passagedata><tw-passagedata pid="339" name="Read Blank Scroll" tags="" position="5736,2802" size="100,100">(display: &quot;Random Bulk Scroll&quot;)

[[Continue Reading-&gt;Read Blank Scroll]]

[[Read a Book In Your Library]]</tw-passagedata><tw-passagedata pid="340" name="Pirate&#39;s Cap" tags="item" position="6393,3095" size="100,100">It may be filthy, but the fleas don&#39;t mind it a bit.

Demonstrates a kinship with the ocean&#39;s sentient lampreys.

Owning one proves that you&#39;re a pirate and/or that you killed a pirate.</tw-passagedata><tw-passagedata pid="341" name="Tablet of Tin" tags="reagent item" position="5624,2920" size="100,100">() A unit of metallic tin in the industry standard tablet format.</tw-passagedata><tw-passagedata pid="342" name="Ingot of Iron" tags="reagent item" position="5738,2918" size="100,100">() This solid piece of pure iron can be forged into items and weapons efficacious against charm and enchantment.</tw-passagedata><tw-passagedata pid="343" name="Coil of Copper" tags="reagent item" position="5628,3031" size="100,100">()</tw-passagedata><tw-passagedata pid="344" name="Half Ounce of Antimony" tags="reagent item" position="5738,3030" size="100,100">()  A lustrous cluster of silvery crystals that looks like a miniature mountain range.</tw-passagedata><tw-passagedata pid="345" name="Elemental Arsenic" tags="reagent item" position="5628,3140" size="100,100">()</tw-passagedata><tw-passagedata pid="346" name="Bit of Bismuth" tags="reagent item" position="5738,3145" size="100,100">() Bismuth forms wonderfully labyrinthian cubic crystals in shimmering rainbow reflections.</tw-passagedata><tw-passagedata pid="347" name="Batch of Boron" tags="reagent item" position="5633,3251" size="100,100">(=)</tw-passagedata><tw-passagedata pid="348" name="Little Bit of Lithium" tags="reagent item" position="5741,3253" size="100,100">()</tw-passagedata><tw-passagedata pid="349" name="Metal Magnesium" tags="reagent item" position="5638,3368" size="100,100">() Magnesium tape in a convenient roll.  I&#39;m sure there&#39;s a practical use for them, but what&#39;s most entertaining is to set fire to one end of the roll, drop it, and try not to get burned.</tw-passagedata><tw-passagedata pid="350" name="Phial of Phosphorous" tags="reagent item" position="5744,3364" size="100,100">A glass phial of reddish granules, highly reactive reagent</tw-passagedata><tw-passagedata pid="351" name="Piece of Potassium" tags="reagent item" position="5641,3485" size="100,100">()</tw-passagedata><tw-passagedata pid="352" name="Platinum Platelet" tags="reagent item" position="5744,3485" size="100,100">() A small disk of platinum.</tw-passagedata><tw-passagedata pid="353" name="Zest of Zinc" tags="reagent item" position="5644,3597" size="100,100">() Shavings of zinc in a jute pouch.</tw-passagedata><tw-passagedata pid="354" name="Lodestone" tags="item" position="5853,3585" size="100,100">() Carrying one of these can potentially manipulate the magnetic fields around various objects and items.  Mainly, you know how to use them to cheat at dice.</tw-passagedata><tw-passagedata pid="355" name="Sal Ammoniac" tags="reagent item" position="5751,3597" size="100,100">()</tw-passagedata><tw-passagedata pid="356" name="Aqua Fortis" tags="reagent item" position="5650,3717" size="100,100">()</tw-passagedata><tw-passagedata pid="357" name="Aqua Regia" tags="reagent item" position="5766,3712" size="100,100">()</tw-passagedata><tw-passagedata pid="358" name="Aqua Vitae" tags="reagent item" position="5655,3830" size="100,100">()</tw-passagedata><tw-passagedata pid="359" name="Cinnabar, not Cinnamon" tags="reagent item" position="5765,3827" size="100,100">()</tw-passagedata><tw-passagedata pid="360" name="Vat of Vitriol" tags="reagent item" position="5665,3944" size="100,100">() Essential to the alchemical process inasmuch as it makes really cool reactions when you drop reagents into it.</tw-passagedata><tw-passagedata pid="361" name="Vial of Vinegar" tags="reagent item" position="5783,3944" size="100,100">() What can&#39;t vinegar do?  Mostly used to clean glass.</tw-passagedata><tw-passagedata pid="362" name="Spool of Daedelus" tags="item" position="5963,3587" size="100,100">This is a quite clever gimmick, consisting of a self-winding spool and a long, durable filament.
(if: $perception &gt; 3)[You&#39;d find it quite handy in a labyrinth.]</tw-passagedata><tw-passagedata pid="363" name="Perpetual Motion Machine" tags="item" position="6235,3630" size="100,100">You can&#39;t get this damned thing to turn off no matter how hard you try!</tw-passagedata><tw-passagedata pid="364" name="Brass Cauldron" tags="item" position="6355,3629" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="365" name="Lucky Horseshoe" tags="item" position="6355,3749" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="366" name="Iron Bell" tags="item" position="6223,3747" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="367" name="Silver Bell" tags="item" position="6227,3968" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="368" name="Gold Bell" tags="item" position="6221,3860" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="369" name="Enchanted Shackles" tags="item" position="6351,3857" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="370" name="Crown of Horns" tags="item" position="6601,3093" size="100,100">Horns erupting from the head.  Different numbers and formations can be found, from a single horn erupting from the center of the forehead to a literal crown of a dozen arched horns.  Frequently found in the classic balanced pair.</tw-passagedata><tw-passagedata pid="371" name="Philosopher&#39;s Stone" tags="item reagent" position="5671,4184" size="100,100">Fabled to grant immortality, it is actually just a precursor to the creation of a Lazarus Beacon charge.</tw-passagedata><tw-passagedata pid="372" name="Vorpal Blade" tags="item weapon magic-weapon" position="6078,4810" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="373" name="Everlasting Fire" tags="item reagent" position="5805,4054" size="100,100">This lovely bit of flame can&#39;t ever be extinguished, which means you should never use it to start a fire anywhere it could spread, because then you&#39;d only have more Everlasting Fire.  It is, in fact, far too dangerous an item to even exist.  It is also a lovely shade of blue.</tw-passagedata><tw-passagedata pid="374" name="Silver Quill" tags="item" position="6083,3590" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="375" name="Diamond Inkwell" tags="item" position="6475,3749" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="376" name="Shadow Lantern" tags="item magic-weapon" position="6361,4364" size="100,100">This device is a one-shot, grenade-like weapon that can damage creatures of light and fire.</tw-passagedata><tw-passagedata pid="377" name="Bone Pipes" tags="item musical" position="6478,3635" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="378" name="Loaded Dice" tags="item" position="6583,3636" size="100,100">If you had these and a Lodestone, you could win just about any dice game you&#39;d like.</tw-passagedata><tw-passagedata pid="379" name="Blow Dart" tags="item weapon" position="6100,5255" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="380" name="Bone Mask" tags="item" position="6113,3725" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="381" name="God&#39;s Eye" tags="item" position="6350,3972" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="382" name="Boondoggle" tags="item" position="6475,3980" size="100,100">(display: &quot;Tick&quot;)(display: &quot;Tick&quot;)(display: &quot;Tick&quot;)</tw-passagedata><tw-passagedata pid="383" name="Steel Needle" tags="item" position="6476,3864" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="384" name="Hell Money" tags="item" position="6588,3867" size="100,100">Frequently burned as an offering to the dead, certain vendors accept payment in this currency but not lucre.</tw-passagedata><tw-passagedata pid="385" name="Goat Skull" tags="item reagent" position="5691,4269" size="100,100">Certain kinds of sorcery depend on sympathies.  The more the ceremony resembles the intended act, the more coherent the sympathetic magic would be.   Props like Goat Skulls are intended to make the ceremony resemble a very convincing sorcery, thus amping up the magical juice.</tw-passagedata><tw-passagedata pid="386" name="Mechanical Arm" tags="item" position="6590,3982" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="387" name="Spider Silk Shawl" tags="item" position="6711,3867" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="388" name="Stone Blood" tags="item reagent" position="5796,4160" size="100,100">This ebon ichor can be used to bind false gods and add a kick of earth elemental energy to magical spells.</tw-passagedata><tw-passagedata pid="389" name="Deck of Cards" tags="item" position="6705,3632" size="100,100">A standard deck of playing cards: 1 through 13 in all 5 suits, the Minor Arcana, the Major Arcana, the two Trumps, the secret Anti-Trump, and the Dragon.</tw-passagedata><tw-passagedata pid="390" name="Theorbo" tags="item musical" position="6703,3982" size="100,100">One of the 14th centuries most badass inventions.</tw-passagedata><tw-passagedata pid="391" name="Straight Razor" tags="weapon item" position="6097,5152" size="100,100">A simple blade collapsed into a handle, commonly used by barbers but perfectly suited for wizards who wish to boost their attack power.</tw-passagedata><tw-passagedata pid="392" name="Copper Spring" tags="item" position="6086,3480" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="393" name="Enchanted Flashlight" tags="item magic-weapon" position="6066,4520" size="100,100">Casts a beam of pure light energy.</tw-passagedata><tw-passagedata pid="394" name="Everfull Flask" tags="item" position="6362,3517" size="100,100">This flask is eternally full of the last potion poured into it.
(if: $inventory contains &quot;Everfull Flask&quot;)[
(link-reveal: &quot;Drink From the Everfull Flask&quot;)[
You take a nice deep swig of $flaskType.
(display: &quot;Use &quot; + $flaskType)]

(link-reveal: &quot;Fill the Everfull Flask&quot;)[
(set: _potions to (find: _i where (passage: _i)&#39;s tags contains &quot;potion&quot;, ...$inventory))
(if: _potions&#39;s length &gt; 1)[
(cycling-link:  bind _item, ..._potions)
(link-reveal: &quot;Fill It Up!&quot;)[(set: $flaskType to _item)
You pour the $flaskType into the Everfull Flask.(set: $arg to $flaskType)(display: &quot;LoseItem&quot;)]](else-if: _potions&#39;s length is 1)[(set: $flaskType to _potions&#39;s 1st)$flaskType
(link-reveal: &quot;Fill It Up!&quot;)[You pour the $flaskType into the Everfull Flask.(set: $arg to $flaskType)(display: &quot;LoseItem&quot;)]](else:)[You don&#39;t have anything to fill up the flask.]
]]</tw-passagedata><tw-passagedata pid="395" name="Crystal Eye" tags="item" position="6481,3514" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="396" name="Blunderbuss" tags="item weapon" position="6093,5043" size="100,100">By stuffing the muzzle with random garbage, you can deal a tremendous blast of kinetic damage.</tw-passagedata><tw-passagedata pid="397" name="Ritual Dagger" tags="item weapon magic-weapon" position="6088,4929" size="100,100">Ah, a Phurpa, which can be used on both deamons, the living, and the Undead.</tw-passagedata><tw-passagedata pid="398" name="Mana Battery" tags="item" position="6238,3389" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="399" name="Infernal Lens" tags="item magic-weapon" position="6066,4290" size="100,100">Focuses beams of fire elemental energy.</tw-passagedata><tw-passagedata pid="400" name="Obsidian Lens" tags="item magic-weapon" position="6062,4407" size="100,100">Focuses beams of dark energy.</tw-passagedata><tw-passagedata pid="401" name="Crystal Prism" tags="item magic-weapon" position="6068,4180" size="100,100">The raw crystal used in a Crystal Spyglass, it is uncut and unground, which means that its elemental potential is even greater than a spyglass, but utterly out of your control.</tw-passagedata><tw-passagedata pid="402" name="Brass Mirror" tags="item" position="6226,3495" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="403" name="Fireworks" tags="item weapon" position="6374,4230" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="404" name="Pet Scorpion" tags="item weapon pet" position="6104,5707" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="405" name="Stiletto" tags="item weapon" position="6101,5475" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="406" name="Derringer" tags="item weapon" position="6107,5587" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="407" name="Lead Sap" tags="item weapon" position="6101,5364" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="408" name="Portable Pentacle" tags="item magic-weapon" position="6063,4630" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="409" name="Jar of Baby Teeth" tags="item reagent" position="5668,4064" size="100,100">Not sure whose teeth they were.  Hopefully they came from multiple sources, because this is a mason jar filled with small specimens.</tw-passagedata><tw-passagedata pid="410" name="Skeleton Key" tags="item" position="6703,3749" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="411" name="Nepenthe" tags="item incense" position="5922,3819" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="412" name="Sage" tags="item incense" position="6039,3858" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="413" name="Ambergris" tags="item reagent" position="5799,4275" size="100,100">So, it&#39;s made inside of whales.  It comes out of their bottoms, usually, but sometimes, they vomit it.  Smells of shite.

Used for... perfume?</tw-passagedata><tw-passagedata pid="414" name="Frankincense" tags="item incense" position="5927,3925" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="415" name="Ylang Ylang" tags="item incense" position="6039,3966" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="416" name="Lavender" tags="item incense" position="5927,4037" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="417" name="Bertram Russell&#39;s Teapot" tags="item" position="6918,3868" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="418" name="Apple of Eden" tags="item" position="6587,3749" size="100,100">A revealer of worlds.  Eating its flesh gives you great wisdom at the price of losing all illusions.</tw-passagedata><tw-passagedata pid="419" name="Cartiff&#39;s Complete Compendium of Codes" tags="item book" position="6690,2655" size="100,100">This guide contains the solution to every combination lock in the known universes.  If you have one of these on hand, no code can defy you.</tw-passagedata><tw-passagedata pid="420" name="Cartiff&#39;s Complete Compendium of Codes (Badly Burned)" tags="item book" position="6689,2769" size="100,100">This was a complete guide to all codes, but it barely survived a fire.  It might have the code for whatever lock you encounter.</tw-passagedata><tw-passagedata pid="421" name="Silphium" tags="item incense" position="6039,4076" size="100,100">This sacred panacaea grew only in the wild, and mankind&#39;s greed for it annihilated it in many worlds and timelines.

The precious bundle in your purse represents the vanishingly small amount available in this neighborhood.  There&#39;s maybe two or three more in the whole City.</tw-passagedata><tw-passagedata pid="422" name="Soul Jar Matryoshka" tags="item" position="5114,2240" size="100,100">Infinite nesting Soul Jars.</tw-passagedata><tw-passagedata pid="423" name="Tincture of Turmeric" tags="item" position="6083,2661" size="100,100">A restorative tonic that can be used to refresh yourself.</tw-passagedata><tw-passagedata pid="424" name="Chest Key" tags="item" position="6818,3752" size="100,100">It&#39;s an old-fashioned key, intended for the type of chest one might bury treasure in on a deserted island.</tw-passagedata><tw-passagedata pid="425" name="Treasure Map" tags="item" position="6816,3874" size="100,100">This treasure map is in a state of quantum prolapse.  If you bring it to an area with buried treasure, it will collapse down to the state that will let you find the treasure.  Once collapsed, it will lose its properties.</tw-passagedata><tw-passagedata pid="426" name="Belonging Sign" tags="item" position="6393,2993" size="100,100">With this enchanted mark upon you, sentient creatures are much more likely to assume that you are friendly and belong.  Not effective against any City-dwellers, as they are all far too jaded.</tw-passagedata><tw-passagedata pid="427" name="Skein of the Deep" tags="item" position="6394,2890" size="100,100">You&#39;ve been given this enchanted mark by a Sea Hag.  It allows you to communicate with rift monsters of Shoggoth-level 3 and higher.</tw-passagedata><tw-passagedata pid="428" name="Perfect Pearl" tags="item reagent" position="5611,2017" size="100,100">This elegant sphere of nacreous protein positively radiates with light.</tw-passagedata><tw-passagedata pid="429" name="Map Fragment" tags="item" position="6821,3980" size="100,100">Find another one, and you might end up with an entire map.</tw-passagedata><tw-passagedata pid="430" name="Chameleon Scarf" tags="item" position="6098,2440" size="100,100">Under the proper circumstances, allows you to replicate the effects of any hat.</tw-passagedata><tw-passagedata pid="431" name="Selkie Skin" tags="item" position="6081,2012" size="100,100">When worn, will allow incredibly agile swimming and the ability to hold ones breath for a prolonged period.</tw-passagedata><tw-passagedata pid="432" name="Cellar of Salt" tags="item reagent" position="5715,2020" size="100,100">Salt suitable for snacks or sorcery in a convenient cellar.</tw-passagedata><tw-passagedata pid="433" name="Vampir Krenk" tags="item" position="6603,3200" size="100,100">You&#39;ve contracted a mild case of vampirism.</tw-passagedata><tw-passagedata pid="434" name="Use Ritual Dagger" tags="" position="6203,4934" size="100,100">(if: $enemyElementType is &quot;Mortal&quot;)[
(set: _opponentMove to $fightPattern&#39;s ($fightIndex))
(replace:?output)[You swing your phurpa at your enemey.
(if: _opponentMove is &quot;Flee&quot;)[(replace:?input)[ [[Next Encounter]] ](replace:?output)[They turn and run away at top speed.]](else-if: _opponentMove is &quot;Block&quot;)[... but they bat your attack away.](else-if: _opponentMove is &quot;Throw&quot;)[  As they dip in to grab your arm, you slice something vulnerable.(set: $arg to 3)(display: &quot;DealDamage&quot;)](else-if: _opponentMove is &quot;Strike&quot;)[  They poke at you, and you cut off their poker.(set: $arg to 2)(display: &quot;DealDamage&quot;)(set: $arg to 1)(display: &quot;TakeDamage&quot;)](else:)[  They make no move to avoid it and take the full brunt of your blow.(set: $arg to 4)(display: &quot;DealDamage&quot;)]]
(set: $fightIndex to (it + 1))
(if: $fightIndex &gt; $fightPattern&#39;s length)[(set: $fightIndex to 1)]
(display: &quot;UpdateClock&quot;)
]
(else:)[
The phurpa can cut through both flesh and more aetherial stuff.

(if: (a: &quot;shadow&quot;, &quot;fire&quot;) contains $enemyElementType)[ 
You scratch a line through the daemon.
(set: $arg to (either: 0,1,1))(display: &quot;DealDamage&quot;)
(if: $enemyHealth &lt;= 0)[
(if: $cunning &gt; 3)
[The $enemyType is reduced to a filthy smoke.  You weave the smoke into
(set: $arg to &quot;Shadow Threads&quot;)(display: &quot;GetItem&quot;)
]
(else:)
[The $enemyType burns to filthy ash, and the wind blows away the remnants.
]]]
(else:)
[Your arcane weapon is ineffective against this type of enemy.
(set: $arg to 0)(display: &quot;DealDamage&quot;)]
]</tw-passagedata><tw-passagedata pid="435" name="Penny Dreadful" tags="item book" position="6191,2005" size="100,100">A slight periodical telling unlikely tales, highly sensationalized.
It has advertisements and a help wanted section.</tw-passagedata><tw-passagedata pid="436" name="Read Penny Dreadful" tags="" position="6313,2001" size="100,100">You slip the magazine a coin that it delicately champs up and swallows.

(set: $arg to -1)(display: &quot;UpdateGold&quot;)

//display random story//

{(set: $reputationTag to &quot;brass-level&quot;)}
(if: $currentContract is &quot;&quot;)[
(display: &quot;GenerateChar&quot;)(set: $clientDescription to $char)
{(set: $potentialContracts to (find: _item where (not ((passage: _item)&#39;s tags  contains &quot;unique&quot;) or not ((history:) contains _item)) and (passage: _item)&#39;s tags contains all of (a: &quot;contract&quot;, $reputationTag), ...($neighborhood&#39;s contracts)))}
You scan through the available jobs...&lt;br/&gt;
(if: $potentialContracts&#39;s length &gt; 0)[
(link-goto: (shuffled: ...$potentialContracts)&#39;s 1st)
](else:)[There&#39;s no work for you.]](else:)[You already have a job.]

{(set: _locations to (find: _item where not ((history:) contains _item and (passage: _item)&#39;s tags contains &quot;bookmark&quot;) and (passage: _item)&#39;s tags contains &quot;location&quot;, ...($neighborhood&#39;s locations)))}
(if: _locations&#39;s length &gt; 0)[Your eye skims past the various advertisements...  until you find (link-goto: _locations&#39;s 1st)]
(else:)[I guess you&#39;ve already seen everything in the (print: $neighborhood&#39;s name).]

[[Read a Book In Your Library]] 

[[Home Again]]</tw-passagedata><tw-passagedata pid="437" name="Bit of Bone" tags="item reagent" position="5670,4389" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="438" name="M.C. Escher: Beginner&#39;s Embroidery" tags="item book" position="6193,1890" size="100,100">In some timelines, M.C. Escher was an artist who created 2D representations of impossible 3D geometry.

In the timeline that produced this classic literature on the topic of enchantment, they were an artist that created 4D representations of impossible 5D geometry with Ethereal Thread embroidery.</tw-passagedata><tw-passagedata pid="439" name="Read M.C. Escher: Beginner&#39;s Embroidery" tags="" position="6318,1897" size="100,100">(if: $maxCunning &gt; 2)[(if:  $maxCunning &lt; 5)[(set: $maxCunning to it + 2)&lt;b&gt;Max Cunning + 2&lt;/b&gt;
Ahhhhh, now that you&#39;ve seen it from that perspective, it makes much more sense.](else:)[A classic, but you are too advanced to take any advantage of it.]](else:)[You are not truly cunning enough to understand the concepts in the book.]

[[Read a Book In Your Library]]</tw-passagedata><tw-passagedata pid="440" name="Use Infernal Lens" tags="" position="6180,4290" size="100,100">The lens catches the ambient light, projecting a beam of elemental infernium.

(if: (a: &quot;shadow&quot;, &quot;bone&quot;, &quot;flesh&quot;) contains $enemyElementType)[It arcs out, plowing through the center of the hostile daemon.
(set: $arg to (random: 1,3))(display: &quot;DealDamage&quot;)
(if: $enemyHealth &lt;= 0)[
(if: $cunning &gt; 3)
[The $enemyType is reduced to a filthy smoke.  You weave the smoke into
(set: $arg to &quot;Shadow Threads&quot;)(display: &quot;GetItem&quot;)
]
(else:)
[The $enemyType burns to filthy ash, and the wind blows away the remnants.
]]]
(else:)
[Your arcane weapon is ineffective against this type of enemy.
(set: $arg to 0)(display: &quot;DealDamage&quot;)]</tw-passagedata><tw-passagedata pid="441" name="Use Obsidian Lens" tags="" position="6178,4405" size="100,100">The lens catches the ambient light, projecting a beam of elemental infernium.

(if: (a: &quot;fire&quot;, &quot;holy&quot;, &quot;flesh&quot;) contains $enemyElementType)[
The daemon&#39;s form withers in the presence of an opposing element.
(set: $arg to (random: 1,3))(display: &quot;DealDamage&quot;)
(if: $enemyHealth &lt;= 0)[
(if: $cunning &gt; 3)
[The $enemyType is reduced to a wan glimmer.  You weave the glimmer into
(set: $arg to &quot;Shadow Threads&quot;)(display: &quot;GetItem&quot;)
]
(else:)
[The $enemyType shrivels into nothing and disappears with an audible //pfft//.
]]]
(else:)
[Your arcane weapon is ineffective against this type of enemy.
(set: $arg to 0)(display: &quot;DealDamage&quot;)]</tw-passagedata><tw-passagedata pid="442" name="Use Enchanted Flashlight" tags="" position="6185,4520" size="100,100">The lens catches the ambient light, projecting a beam of elemental infernium.

(if: (a: &quot;shadow&quot;, &quot;crystal&quot;) contains $enemyElementType)[ 
A brilliant shaft of purest hope erupts from the children&#39;s flashlight with duct tape and bailing wire modifications.  The enemy shrieks in terror.

(set: $arg to (random: 1,3))(display: &quot;DealDamage&quot;)
(if: $enemyHealth &lt;= 0)[
(if: $cunning &gt; 3)
[The $enemyType is reduced to a filthy smoke.  You weave the smoke into
(set: $arg to &quot;Shadow Threads&quot;)(display: &quot;GetItem&quot;)
]
(else:)
[The $enemyType burns to filthy ash, and the wind blows away the remnants.
]]]
(else:)
[Your arcane weapon is ineffective against this type of enemy.
(set: $arg to 0)(display: &quot;DealDamage&quot;)]</tw-passagedata><tw-passagedata pid="443" name="Use Portable Pentacle" tags="" position="6181,4632" size="100,100">You cast the pentacle out at the enemy.  Springs in the iron and silver apparatus cause it to pop open, surrounding your opponent.

(display: &quot;Capture &quot; + $enemyType)</tw-passagedata><tw-passagedata pid="444" name="Item Shelf" tags="furniture" position="5133,2684" size="100,100">Storage space for you to manage your inventory.</tw-passagedata><tw-passagedata pid="445" name="Use Item Shelf" tags="" position="5242,2682" size="100,100">Inventory:
(for: each _i, ...$inventory)[(link-reveal: &quot;Put &quot; + _i + &quot; on Shelf&quot;)[(set: $inventory to it - (ds: _i))(set: $storage to it + (ds: _i))(goto: &quot;Use Item Shelf&quot;)]
]

Storage:
(for: each _i, ...$storage)[(link-reveal: &quot;Take &quot; + _i + &quot; off Shelf&quot;)[(set: $inventory to it + (ds: _i))(set: $storage to it - (ds: _i))(goto: &quot;Use Item Shelf&quot;)]
]

[[Home Again]]</tw-passagedata><tw-passagedata pid="446" name="Use Crystal Prism" tags="" position="6173,4185" size="100,100">(set: _element to (either: &quot;shadow&quot;, &quot;bone&quot;, &quot;flesh&quot;, &quot;fire&quot;, &quot;holy&quot;))
The lens catches the ambient light, projecting a beam of _element elemental energy.

(if: $enemyElementType is not _element)[
An erratic sizzle of chaotic energy flings out from the prism, striking the enemy.
(set: $arg to (random: 0,4))(display: &quot;DealDamage&quot;)
(if: $enemyHealth &lt;= 0)[
(if: $cunning &gt; 3)
[The $enemyType is reduced to a swirl of raw chaos.  You weave the chaos into
(set: $arg to &quot;Shadow Threads&quot;)(display: &quot;GetItem&quot;)
]
(else:)
[The $enemyType is torn into rudimentary particles, like subquarks and demimuons.
]]]
(else:)
[Your arcane weapon is ineffective against this type of enemy.
(set: $arg to 0)(display: &quot;DealDamage&quot;)]</tw-passagedata><tw-passagedata pid="447" name="Golden Cage" tags="furniture" position="5143,2835" size="100,100">A delicate network of gold wire elaborately turned into a birdcage.  Perched inside is a little, sapphire bird automata, tweeting and retweeting all of the rumors you&#39;ve ever heard.</tw-passagedata><tw-passagedata pid="448" name="Use Golden Cage" tags="" position="5264,2838" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="449" name="Clump of Coal" tags="item reagent" position="5798,4397" size="100,100">A nice piece of anthracite the size of a baby&#39;s fist.</tw-passagedata><tw-passagedata pid="450" name="Use Macro Caster" tags="" position="5514,3868" size="100,100">You pull the lever, triggering a quick series of clicks.

The machine rapidly prints out a glitchy mass of hypertext:

(display: $macroCasterPlates&#39;s 1st)
(display: &quot;Tick&quot;)
(display: $macroCasterPlates&#39;s 2nd)
(display: &quot;Tick&quot;)
(display: $macroCasterPlates&#39;s 3rd)
(display: &quot;Tick&quot;)

[[Home Again]]</tw-passagedata><tw-passagedata pid="451" name="Read Cartiff&#39;s Complete Compendium of Codes" tags="" position="6813,2661" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="452" name="Read Cartiff&#39;s Complete Compendium of Codes (Badly Burned)" tags="" position="6809,2777" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="453" name="Use Vorpal Blade" tags="" position="6194,4812" size="100,100">{(set: _opponentMove to $fightPattern&#39;s ($fightIndex))
(replace:?output)[You swing the Vorpal Blade! Snicker-snack!
(set: $arg to 3)(display: &quot;DealDamage&quot;)
(if: _opponentMove is &quot;Flee&quot;)[(replace:?input)[ [[Next Encounter]] ](replace:?output)[They turn and run away at top speed.]](else-if: _opponentMove is &quot;Block&quot;)[They try to block, but it does nothing.](else-if: _opponentMove is &quot;Throw&quot;)[  As they dip in to grab your arm, the sword carves an extra line into them.(set: $arg to 2)(display: &quot;DealDamage&quot;)](else-if: _opponentMove is &quot;Strike&quot;)[  They get a strike in on you, at the cost of their own additional injury.(set: $arg to 1)(display: &quot;DealDamage&quot;)(display: &quot;TakeDamage&quot;)](else:)[  They make no move to avoid it and take the full brunt of your blow.(set: $arg to 2)(display: &quot;DealDamage&quot;)]]
(set: $fightIndex to (it + 1))
(if: $fightIndex &gt; $fightPattern&#39;s length)[(set: $fightIndex to 1)]
(display: &quot;UpdateClock&quot;)}</tw-passagedata><tw-passagedata pid="454" name="Clockwork Key" tags="item" position="5843,3023" size="100,100">It&#39;s a key designed for winding and toggling gear-based contraptions.</tw-passagedata><tw-passagedata pid="455" name="Indestructible Pickaxe" tags="item" position="5837,6404" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="456" name="Sleeping Mat" tags="item furniture" position="5405,4001" size="100,100">Barely fit for a human.  This is what you sleep on.
Consequently, you don&#39;t usually sleep on it.
You don&#39;t sleep much, anyway.  Bad Dreams.</tw-passagedata><tw-passagedata pid="457" name="Use Sleeping Mat" tags="" position="5513,4007" size="100,100">In between removing nits and cold water dripping on your face from the apartment above, you manage to (if: (random: 0, 1) &gt; 0)[get a bit of rest. (set: $arg to 1)(display: &quot;Heal&quot;)](else:)[not sleep at all.](display: &quot;Clock&quot;)

(link-goto: (history:)&#39;s last)</tw-passagedata><tw-passagedata pid="458" name="Pet Raven" tags="item pet" position="5848,3238" size="100,100">This Raven is named Nevermore.
It can read your mail for you anywhere in the world.

[[Use Pet Raven]]</tw-passagedata><tw-passagedata pid="459" name="Use Pet Raven" tags="" position="5978,3240" size="100,100">(display: &quot;Read Your Mail&quot;)</tw-passagedata><tw-passagedata pid="460" name="Dire Salon Calling Card" tags="item" position="4265,6564" size="100,100">It&#39;s a white rectangular card with the inscription: &quot;Dire Salon&quot;.
You&#39;ve heard that the inscription is unique for each person that is issued such a card, which makes forgeries... complicated.</tw-passagedata><tw-passagedata pid="461" name="Meteor Iron" tags="item reagent" position="5685,4505" size="100,100">This bit of iron is from a shooting star that was captured by a wizard.
It flew across unimaginable distances to be in your hands today.</tw-passagedata><tw-passagedata pid="462" name="Practical Thievery: A Young Rogue&#39;s Primer" tags="" position="4268,6452" size="100,100">Useful instructions on stealing things.</tw-passagedata><tw-passagedata pid="463" name="Read Practical Thievery: A Young Rogue&#39;s Primer" tags="" position="4380,6454" size="100,100">It contains useful details on stealing.</tw-passagedata><tw-passagedata pid="464" name="The Incredibly Secret Machine&#39;s User Manual" tags="item book" position="4405,6273" size="100,100">Codes for the Incredibly Secret Machine</tw-passagedata><tw-passagedata pid="465" name="Patent Filing for Experimental Rift Ship" tags="item" position="4529,6270" size="100,100">Describes a design for a rift ship based on 4 different rift dwellers.
It has a few missing details about those rift dwellers that you could fill in.
Reward is insanely good rift travel.</tw-passagedata><tw-passagedata pid="466" name="Mark of the Sea Dweller" tags="" position="3891.6666666666665,235.33333333333334" size="100,100">A full face tattoo that appears to shift as its viewed.  Depending on Longitude and Latitude, it could be interpreted as Tlingit, Maori, Riftish.</tw-passagedata><tw-passagedata pid="467" name="Use Blunderbuss" tags="" position="6210,5037" size="100,100">{(set: _opponentMove to $fightPattern&#39;s ($fightIndex))
(replace:?output)[You fire off a tremendous blast from your blunderbuss, sending shrapnel everywhere!
(set: $arg to 5)(display: &quot;DealDamage&quot;)
(if: _opponentMove is &quot;Flee&quot;)[(replace:?input)[ [[Next Encounter]] ](replace:?output)[They turn and run away at top speed.]](else-if: _opponentMove is &quot;Strike&quot;)[  They manage to get a strike in on you before being knocked back. (set: $arg to 1)(display: &quot;DealDamage&quot;)(display: &quot;TakeDamage&quot;)](else:)[  They make no move to avoid it and take the full brunt of your blow.(set: $arg to 2)(display: &quot;DealDamage&quot;)]]
(set: $fightIndex to (it + 1))
(if: $fightIndex &gt; $fightPattern&#39;s length)[(set: $fightIndex to 1)]
(display: &quot;UpdateClock&quot;)

(if: (random: 0, 6) is 0)[
You&#39;ve attracted the attention of the guards!
(set: $encounterStack to
($encounterStack&#39;s (range: 1, $encounterIndex)) + 
(a: &quot;Encounter: Guards&quot;) + 
($encounterStack&#39;s (range: $encounterIndex + 1, $encounterStack&#39;s length)))
]
}</tw-passagedata><tw-passagedata pid="468" name="Use Straight Razor" tags="" position="6207,5152" size="100,100">{(set: _opponentMove to $fightPattern&#39;s ($fightIndex))
(replace:?output)[You swing your straight razor (either: &quot;at your opponent&#39;s eyes&quot;, &quot;right at their throat&quot;, &quot;perilously close to their fingers&quot;)!
(if: _opponentMove is &quot;Flee&quot;)[(replace:?input)[ [[Next Encounter]] ](replace:?output)[They turn and run away at top speed.]](else-if: _opponentMove is &quot;Block&quot;)[... but they bat your attack away.](else-if: _opponentMove is &quot;Throw&quot;)[  As they dip in to grab your arm, you slice something vulnerable.(set: $arg to 3)(display: &quot;DealDamage&quot;)](else-if: _opponentMove is &quot;Strike&quot;)[  They poke at you, and you cut off their poker.(set: $arg to 2)(display: &quot;DealDamage&quot;)(set: $arg to 1)(display: &quot;TakeDamage&quot;)](else:)[  They make no move to avoid it and take the full brunt of your blow.(set: $arg to 4)(display: &quot;DealDamage&quot;)]]
(set: $fightIndex to (it + 1))
(if: $fightIndex &gt; $fightPattern&#39;s length)[(set: $fightIndex to 1)]
(display: &quot;UpdateClock&quot;)}</tw-passagedata><tw-passagedata pid="469" name="Use Blow Dart" tags="" position="6208,5257" size="100,100">{(set: _opponentMove to $fightPattern&#39;s ($fightIndex))
(replace:?output)[Swiftly, you raise the pipe to your lips an exhale a tiny blow dart at your opponent&#39;s carotid.(if: (random: 0, 3) is 0)[  Sadly, that was the last of your poisoned darts. (set: $arg to &quot;Blow Dart&quot;)(display: &quot;LoseItem&quot;)]
(if: _opponentMove is &quot;Flee&quot;)[(replace:?input)[ [[Next Encounter]] ](replace:?output)[They turn and run away at top speed.]](else-if: _opponentMove is &quot;Block&quot;)[The dart sticks in their clothing, delivering a much less effective dose of poison.](else-if: _opponentMove is &quot;Throw&quot;)[  They try to throw you, and the dart ends up in their hand.(set: $arg to 2)(display: &quot;DealDamage&quot;)](else-if: _opponentMove is &quot;Strike&quot;)[ They strike you while you&#39;re delivering the attack. (set: $arg to 1)(display: &quot;DealDamage&quot;)(display: &quot;TakeDamage&quot;)](else:)[  They make no move to avoid it and take the full brunt of your blow.(set: $arg to 2)(display: &quot;DealDamage&quot;)]]

They seem a bit groggy.

(display: &quot;UpdateClock&quot;)}</tw-passagedata><tw-passagedata pid="470" name="Use Lead Sap" tags="" position="6217,5365" size="100,100">{(set: _opponentMove to $fightPattern&#39;s ($fightIndex))
(replace:?output)[You strike the opponent with a lead sap.
(if: _opponentMove is &quot;Flee&quot;)[(replace:?input)[ [[Next Encounter]] ](replace:?output)[They turn and run away at top speed.]](else-if: _opponentMove is &quot;Block&quot;)[.. but they bat your fist away.](else-if: _opponentMove is &quot;Throw&quot;)[  As they dip in to grab your arm, you cosh them on the skull.(set: $arg to 3)(display: &quot;DealDamage&quot;)](else-if: _opponentMove is &quot;Strike&quot;)[  You trade clouts at each other, bloodying each other&#39;s foreheads.(set: $arg to 2)(display: &quot;DealDamage&quot;)(display: &quot;TakeDamage&quot;)](else:)[  They make no move to avoid it and take the full brunt of your blow.(set: $arg to 4)(display: &quot;DealDamage&quot;)]]

(set: $fightIndex to (random: 1, $fightPattern&#39;s length))

(display: &quot;UpdateClock&quot;)}</tw-passagedata><tw-passagedata pid="471" name="Use Stiletto" tags="" position="6217,5477" size="100,100">{(set: _opponentMove to $fightPattern&#39;s ($fightIndex))
(replace:?output)[You swing your stiletto (either: &quot;at your opponent&#39;s eyes&quot;, &quot;right at their throat&quot;, &quot;perilously close to their fingers&quot;)!
(if: _opponentMove is &quot;Flee&quot;)[(replace:?input)[ [[Next Encounter]] ](replace:?output)[They turn and run away at top speed.]](else-if: _opponentMove is &quot;Block&quot;)[... but they bat your attack away.](else-if: _opponentMove is &quot;Throw&quot;)[  As they dip in to grab your arm, you slice something vulnerable.(set: $arg to 3)(display: &quot;DealDamage&quot;)](else-if: _opponentMove is &quot;Strike&quot;)[  They poke at you, and you cut off their poker.(set: $arg to 2)(display: &quot;DealDamage&quot;)(set: $arg to 1)(display: &quot;TakeDamage&quot;)](else:)[  They make no move to avoid it and take the full brunt of your blow.(set: $arg to 4)(display: &quot;DealDamage&quot;)]]
(set: $fightIndex to (it + 1))
(if: $fightIndex &gt; $fightPattern&#39;s length)[(set: $fightIndex to 1)]
(display: &quot;UpdateClock&quot;)}</tw-passagedata><tw-passagedata pid="472" name="Use Derringer" tags="" position="6215,5585" size="100,100">{(set: _opponentMove to $fightPattern&#39;s ($fightIndex))
(replace:?output)[You blast away with your little derringer!
(set: $arg to 3)(display: &quot;DealDamage&quot;)
(if: _opponentMove is &quot;Flee&quot;)[(replace:?input)[ [[Next Encounter]] ](replace:?output)[They turn and run away at top speed.]](else-if: _opponentMove is &quot;Strike&quot;)[  They manage to get a strike in on you before being knocked back. (set: $arg to 1)(display: &quot;DealDamage&quot;)(display: &quot;TakeDamage&quot;)](else:)[  They make no move to avoid it and take the full brunt of your blow.(set: $arg to 2)(display: &quot;DealDamage&quot;)]]
(set: $fightIndex to (it + 1))
(if: $fightIndex &gt; $fightPattern&#39;s length)[(set: $fightIndex to 1)]
(display: &quot;UpdateClock&quot;)

(if: (random: 0, 6) is 0)[
You&#39;ve attracted the attention of the guards!
(set: $encounterStack to
($encounterStack&#39;s (range: 1, $encounterIndex)) + 
(a: &quot;Encounter: Guards&quot;) + 
($encounterStack&#39;s (range: $encounterIndex + 1, $encounterStack&#39;s length)))
]
}</tw-passagedata><tw-passagedata pid="473" name="Use Pet Scorpion" tags="" position="6225,5709" size="100,100">{(set: _opponentMove to $fightPattern&#39;s ($fightIndex))
(replace:?output)[You gently toss your pet scorpion at your opponent&#39;s shirt collar.
(if: _opponentMove is &quot;Flee&quot;)[(replace:?input)[ [[Next Encounter]] ](replace:?output)[They turn and run away at top speed.]](else-if: _opponentMove is &quot;Block&quot;)[The scorpion gets lost in their clothing, delivering a much less effective dose of poison.](else-if: _opponentMove is &quot;Throw&quot;)[  They try to throw you, and the scorpion&#39;s stinger ends up in their hand.(set: $arg to 2)(display: &quot;DealDamage&quot;)](else-if: _opponentMove is &quot;Strike&quot;)[ They strike you while you&#39;re delivering the attack. (set: $arg to 1)(display: &quot;DealDamage&quot;)(display: &quot;TakeDamage&quot;)](else:)[  They make no move to avoid it and take the full brunt of your blow.(set: $arg to 2)(display: &quot;DealDamage&quot;)]]

They seem a bit groggy.  (if: (random: 0, 3) is 0)[  Sadly, the scorpion buddy was squished. (set: $arg to &quot;Pet Scorpion&quot;)(display: &quot;LoseItem&quot;)]

(display: &quot;UpdateClock&quot;)}</tw-passagedata><tw-passagedata pid="474" name="Thorn Ward" tags="item" position="5161,3057" size="100,100">This causes the owner&#39;s skin to produce thorn-like spikes when attacked.</tw-passagedata><tw-passagedata pid="475" name="Maintenance Key" tags="item" position="6938,3750" size="100,100">This key can manipulate the infrastructure of the actual City itself.</tw-passagedata><tw-passagedata pid="476" name="Goofer Dust" tags="item" position="5276,1979" size="100,100">Protection against daemons and spirits.</tw-passagedata><tw-passagedata pid="477" name="Mark of the Goblins Lvl 1" tags="" position="6868,6552" size="100,100">The distinguishing mark of a group of goblins.</tw-passagedata><tw-passagedata pid="478" name="Marked Cards" tags="item" position="6816,3635" size="100,100">A standard deck of playing cards: 1 through 13 in all 5 suits, the Minor Arcana, the Major Arcana, the two Trumps, the secret Anti-Trump, and the Dragon.
The backs of each card are marked, allowing you to know what your opponent&#39;s hand is without requiring high perception.</tw-passagedata><tw-passagedata pid="479" name="Use Shadow Lantern" tags="" position="6477,4366" size="100,100">(set: $arg to &quot;Shadow Lantern&quot;)(display: &quot;LoseItem&quot;)
// damage to light, fire creatures //
(if: (a: &quot;light&quot;, &quot;fire&quot;) contains $enemyType)[(set: $arg to 5)(display: &quot;DealDamage&quot;)]
(else:)[This weapon is ineffective against this type of enemy.]</tw-passagedata><tw-passagedata pid="480" name="Use Mystery Draught" tags="" position="5971,2693" size="100,100">(display: (either: &quot;Use Healing Draught&quot;, &quot;Use Cunning Draught&quot;, &quot;Use Stimulating Draught&quot;))
(set: $arg to &quot;Mystery Draught&quot;)(display: &quot;LoseItem&quot;)</tw-passagedata><tw-passagedata pid="481" name="Dictionary of Unwritten Words" tags="book item" position="6566,2122" size="100,100">The Dictionary of Unwritten Words
Just like gently pressing on your closed eyelids during the day causes strange patterns and images to appear in your vision, so too does this book probe the part of your brain that grasps concepts and forms words.</tw-passagedata><tw-passagedata pid="482" name="Comfortable Bed" tags="item furniture" position="5393,4119" size="100,100"></tw-passagedata><tw-passagedata pid="483" name="Use Comfortable Bed" tags="" position="5520,4125" size="100,100">(set: _roll to (random: 1, 3))
(if: _roll is 1)[(set: $perception to $maxPerception)Perception MAX]
(else-if: _roll is 2)[(set: $cunning to $maxCunning)Cunning MAX]
(else-if: _roll is 3)[(set: $health to $maxHealth)Health MAX]


(link-goto: (history:)&#39;s last)</tw-passagedata><tw-passagedata pid="484" name="Sea Scum" tags="item reagent" position="5804.333333333333,4504.166666666667" size="100,100">This algae is secretly rich in carageenan, a substance that can give your potions a succulent mouth feel.</tw-passagedata><tw-passagedata pid="485" name="Rusted Key" tags="item" position="7051,3747.5000000000005" size="100,100">This might be the key you need!  Or, it might not.  It&#39;s hard to tell with all of the rust.</tw-passagedata><tw-passagedata pid="486" name="Plague Marks" tags="item" position="6496,3200" size="100,100">They appear to be buboes, but most buboes are not this...  animated.</tw-passagedata><tw-passagedata pid="487" name="Silent Ansible" tags="item" position="5845,3364" size="100,100">This curious device looks like a gyroscope covered in brass and crystals.  It never stops spinning.
(if: $perception &gt; 5)[The device is a spinning brass pyramid atop four tilted pyramids, each of a different material (ruby, sapphire, granite, sunstone) atop an obsidian pyramid.  In the center is a roiling chaos made of incredibly minute gears.]

(if: $perception &gt; 10)[Its purpose is to orient the possessor absolutely in space, allowing them to travel anywhere in the world if they know how to use it.

You also notice that inside the center is a much smaller version of itself.  When you look at the center of the smaller version, you get an unfathomable sense of vertigo.]</tw-passagedata><tw-passagedata pid="488" name="Neighborhood Door to Lower Depths" tags="furniture" position="5382,3518" size="100,100">Propped up on the wall, it looks more like a door and less like a coffin lid.  Quite slightly less.</tw-passagedata><tw-passagedata pid="489" name="Use Neighborhood Door to Lower Depths" tags="" position="5496,3526" size="100,100">Opening the door, you smell the disconcertingly pleasant smell of mummification.  Despite the Undead nature of the majority of the citizens of the Lower Depths, quite a clamor of noise comes through the portal.

[[Lower Depths]]</tw-passagedata><tw-passagedata pid="490" name="Neighborhood Door to West Fires" tags="furniture" position="5385,3642" size="100,100">Your apartment came furnished with a door.  Otherwise you&#39;d be unable to leave it.  As it happens, the door let out into the West Fires neighborhood.
Awful place, full of criminals.</tw-passagedata><tw-passagedata pid="491" name="Use Neighborhood Door to West Fires" tags="" position="5490,3644" size="100,100">(goto: &quot;West Fires&quot;)</tw-passagedata><tw-passagedata pid="492" name="Magisterium Head Office Calling Card" tags="item" position="4293,6278" size="100,100">If you are in possession of this, you could teleport to the Magisterium&#39;s Head Office whenever you liked.</tw-passagedata><tw-passagedata pid="493" name="Equatorial Iceberg" tags="journey" position="4209,902" size="100,100">The Rift Ship punches through to a tranquil, warm sea.  A fairly large iceberg bobs in an otherwise featureless ocean.
(set: _roll to (random: 0, 1))
|input&gt;[
(link-reveal: &quot;We could try to get some fresh water off of it.&quot;)[
(replace:?input)[
(if: $riftCommand &gt; 0)[
(if: _roll &gt; 0)[Your loyal crew breaks out shovels and buckets.  In no time flat, you&#39;ve given your fresh wather supplies a boost. (set: $riftSupplies to it + (random: 2,5) * 5)
&lt;b&gt;Supplies -&gt; $riftSupplies&lt;/b&gt;

[[Next Journey]]
](else:)[As your crew begins disembarking, the &quot;iceberg&quot; cracks open, revealing that it is actually the beak of a monstrously large squid.
Several of your crew are devoured before you&#39;re able to flee.
(set: $arg to -(random: 1,7))(display: &quot;UpdateRiftCrew&quot;)
(set: _commandDamage to (random: 0,2))(if: _commandDamage &gt; 0)[&lt;b&gt;Command - _commandDamage&lt;b/&gt;(set: $riftCommand to it - _commandDamage)](else:)[No one blames you for the loss, though.  Bad things happen on the sea.]

[[Next Journey]]
]](else:)[(if: _roll &gt; 0)[The ship&#39;s captain refuses to get close to that thing.  You all sail away uneventfully.
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]
](else:)[The crew captain commands you and the crew down to bring up water, when you are suddenly assaulted by a horrendous squid monster!
(set: $arg to -(random: 1,7))(display: &quot;UpdateRiftCrew&quot;)
(set: $arg to (random: 0,1))(display: &quot;TakeDamage&quot;)
[[Next Journey]]
]]]]

(link-reveal: &quot;It&#39;s obviously a trap, right?&quot;)[(replace:?input)[
(if: _roll &gt; 0)[You all sail away uneventfully.
&lt;b&gt;Distance + 1&lt;/b&gt;(set: $riftDistance to it + 1)
[[Next Journey]]  ](else:)[After an agonizing wait, an elephant seal is snapped up into a horrific squid&#39;s beak. Your fellows are glad they heeded your warning.
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)
(set: $riftCommand to it + 1)
&lt;b&gt;Command + 1&lt;b/&gt;

[[Next Journey]]]
]]
]</tw-passagedata><tw-passagedata pid="494" name="Stealing Starfire" tags="journey" position="4213,1040" size="100,100">The Rift Ship drifts between planetoids in an unusually small solar system.  The suns and planets are the same kind of red-hot machinery as our own world, only executed in exquisite miniature.


(set: _roll to (random: 0, 1))
|input&gt;[
(link-reveal: &quot;We could try to capture the sun to power our ship.&quot;)[
(replace:?input)[
(if: $riftCommand &gt; 0)[
(if: _roll &gt; 0)[Your loyal crew breaks out a winch, a pulley, and a swing boom. In no time flat, they&#39;ve loaded up and mounted the sun into the ship&#39;s drive train.
(set: $riftSupplies to it + (random: 3,7) * 5)
&lt;b&gt;Supplies -&gt; $riftSupplies&lt;/b&gt;
(set: $arg to 10)(display: &quot;UpdateRiftDistance&quot;)
(set: $riftTreasure to it + 30)
&lt;b&gt;Treasure + 30&lt;/b&gt;

[[Next Journey]]
](else:)[
As you drift by, your crew is unable to loop the little sun.

[[Next Journey]]
]](else:)[(if: _roll &gt; 0)[The ship&#39;s captain refuses to get close to that thing.  You all sail away uneventfully.
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)
[[Next Journey]]
](else:)[

[[Next Journey]]
]]]]

(link-reveal: &quot;It&#39;s obviously a trap, right?&quot;)[(replace:?input)[
(if: _roll &gt; 0)[You all sail away uneventfully.
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]  ](else:)[You sail away.
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]]
]]
]</tw-passagedata><tw-passagedata pid="495" name="Smooth Sailing" tags="journey" position="4216,1157" size="100,100">Nothing much happened today.  Lots of very same-y universes right after the other.  Decent winds.
(set: $arg to 2)(display: &quot;UpdateRiftDistance&quot;)
[[Next Journey]]</tw-passagedata><tw-passagedata pid="496" name="Rough Seas" tags="journey" position="4211,1375" size="100,100">This area is not particularly dangerous, but going is slow, and morale is poor.  Everyone is hopelessly nauseous.
&lt;b&gt;Command - 1&lt;/b&gt;(set: $riftCommand to it - 1)
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="497" name="Becalmed" tags="journey" position="4212,1263" size="100,100">No wind today.  You and your crew are stuck in some backwater universe with a very low magical potential.

(if: visits &gt; 2)[Getting stuck in places like this makes you quite worried, as if magic would no longer be real, and you&#39;d be one of these people in these alternate timelines with no way to return to the City.]
(else-if: visits &gt; 4)[In fact, it might be quite nice to just wander off and live with those people forever.  Forget about the City.]
(else-if: visits &gt; 6)[You could never forget about the City.  That&#39;s what keeps you on the ship even when it seems like it will never set sail ever again.  But what if you just got off?]
(else-if: visits &gt; 8)[You&#39;re afraid of what could have happened that one time.  You know, that one time that you got cabin fever during a becalming and left the ship.  (either: &quot;Turn your back for an instant&quot;, &quot;Stop to help one stranger&quot;, &quot;Try to collect some supplies for the crew&quot;), and you almost get trapped in a world where (either: &quot;the local theocracy has condemned you to death.&quot;, &quot;a hierarchical system of cannibalism has replaced fiat currency.&quot;, &quot;wizards are a rare delicacy.&quot;, &quot;everyone is a roboticized drone.&quot;)]
(else-if: visits &gt; 12)[
You&#39;ve gone a bit mad with anger at having to wait once again in some disgusting flyspeck in the middle of the unknown universe.

&lt;b&gt;Command - 1&lt;/b&gt;(set: $riftCommand to it - 1)
](else-if: visits &gt; 24)[
You take your time to study this world.  You moor the ship&#39;s anchor to this stem and go live with the world for a relative lifetime.  Then, you return no longer bent nor bearded with age, pull up the anchor, and set sail once again.

You never tell the crew what you saw, which for them was just a few minutes but for you was your entire universe.
]

(set: $arg to 0)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="498" name="Safe Atoll" tags="journey" position="4334,903" size="100,100">Your ship encounters a section of sea that changes only on geological time scales, making it stable enough to make minor repairs on your sail ship, forage for fresh supplies, and allow you turn around and go home.

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Forward to Glory!-&gt;Next Journey]]

[[Scrape Barnacles off of the Hull]] 

[[About to Aft, Return Home!]]</tw-passagedata><tw-passagedata pid="499" name="Monster Attack" tags="journey" position="4215,1492" size="100,100">A hideous beast arises from the sea, threatening to engulf you.

You have a crew of $riftCrew.  You can sacrifice any number of them to the beast, in order to increase the chance that the rest of them can get away.

How many do you sacrifice? (cycling-link: bind _sacrifice, ...(altered: _i via (str: _i), ...(range: 0, $riftCrew)))
(link-reveal: &quot;Sacrifice&quot;)[
(if: (num:_sacrifice) is 0)[You&#39;ll be sacrificing no one!  You and your crew insist on fighting on!
(set: _roll to (random: 0, $riftCrew + $riftCommand))
Roll: _roll
(if: _roll &gt; 20)[You capture the beast with a harpoon and drag it onto the decks where various hooks and knives make short work of it!
&lt;b&gt;Supplies + 100&lt;/b&gt;(set: $riftSupplies to it + 100)

[[Next Journey]] 
](else:)[
Sadly, your glory is ended somewhere in the lower intestine of a hideous transdimensional serpent.

[[Death]] 
]](else:)[
You send _sacrifice crew members into the awaiting maw!
(set: _roll to (random: 0, (pow: (num:_sacrifice), 2) * 5))
Roll: _roll
(if: _roll &gt; 20)[
The poor souls have bought you enough time to escape.

[[Next Journey]]
](else:)[
But the sacrifice was in vain, for you all have perished.

[[Death]]]
]
]</tw-passagedata><tw-passagedata pid="500" name="Stormy Weather" tags="journey" position="4331,1037" size="100,100">The ship is tossed about by ragged winds full of jagged shards of clashing realities.

You and your crew must risk your lives to avoid losing supplies!

How many are you willing to risk?  (dropdown: bind _sacrifice, ...(altered: _i via (str: _i), ...(range: 0, $riftCrew)))
(link-reveal: &quot;Batten Down The Hatches!&quot;)[
(if: (num:_sacrifice) is 0)[You rush out and begin lashing down loose cargo and tools. 
(if: (random: 0, $perception) &gt; 2)[
(set: _roll to (random: 0, $riftCrew + $riftCommand))
Roll: _roll
(if: _roll &gt; 20)[Your crew is inspired by your courage and follow your lead!
&lt;b&gt;Command + 1&lt;/b&gt;(set: $riftCommand to it + 1)
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

](else:)[You do a passable job and don&#39;t lose too many supplies.
(set: _lostSupplies to (random: 10, 30))
&lt;b&gt;Supplies - _lostSupplies&lt;/b&gt;(set: $riftSupplies to it - _lostSupplies)
]
[[Next Journey]]](else:)[You fail to see a swinging boom or mast or whatever those awful wooden swinging things are called.  You are struck over the guardrail and into the roaring sea!

[[Set Adrift]]]
](else:)[
You send _sacrifice crew members onto the decks to brave the storm!
(set: _roll to (random: 0, (pow: (num:_sacrifice), 2) * 5))
Roll: _roll
(set: _lostSupplies to (max: 0, 30 - _roll))
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)
&lt;b&gt;Supplies - _lostSupplies&lt;/b&gt;(set: $riftSupplies to it - _lostSupplies)
(set: $arg to -(abs: (min: 0, (random: 0, 10) - (num: _sacrifice))))
(display: &quot;UpdateRiftCrew&quot;)

[[Next Journey]] 
]
]</tw-passagedata><tw-passagedata pid="501" name="Set Adrift" tags="" position="4462,1025" size="100,100">You are adrift on the open Rift ocean, clinging precariously to a gyre of swirling wreckage.

(if: (random: 0,5) is 0)[
You don&#39;t have long before a massive wedge of dreadnought wreckage clears your tiny patch of safety like so many duck pins.  But where can you find safety?
](else:)[[[Wait-&gt;Set Adrift]]]
(link-reveal: &quot;Jump Down Into the Rift&quot;)[
(if: $inventory contains &quot;Silent Ansible&quot;)[
  An image appears in front of you, written in the spaces between the pieces of wreckage on which you bob over the ocean eternal.  It is the cabin of your flying sail ship, some minutes prior to your unfortunate departure from its safety.

  You could just walk right through and [[Pick Next Heading]] 
  ]
  (if: $inventory contains &quot;Compass of Many Places&quot;)
  [
	  You can make out the shape of [[Safe Harbor]] a short leap away.
  ]
  (if: $inventory contains &quot;Selkie Skin&quot;)[You could [[Dive In Headfirst-&gt;Next Journey]] while wearing your Selkie Skin.]
  (else:)[You could [[Dive In Headfirst-&gt;Death]](set: $deathReason to &quot;As you collide with the surface of raw riftspace, your very being is torn into infinitely thin slices.&quot;)
]]
(if: (history:) contains &quot;Read Philomender&#39;s Book of Excellent Knots&quot;)[
(link-reveal: &quot;Craft a Raft&quot;)[(if: $cunning &gt; 2)[Your little dinghy manages to get to a [[Safe Harbor]] where you can bring on a new crew.](else:)[(set: $deathReason to &quot;It seems that more cunning was required to craft a boat that could float.&quot;)(goto: &quot;Death&quot;)]]]</tw-passagedata><tw-passagedata pid="502" name="Siren&#39;s Call" tags="journey" position="4352,1158" size="100,100">(if: (history:) contains &quot;Read Philomender&#39;s Book of Excellent Knots&quot;)[You are able to secure your crew and yourself to the mast.  You&#39;d hoped that the sirens would reveal great secrets to you, but it&#39;s almost exclusively slanderous gossip.

(display: &quot;Baseless Rumors&quot;)

[[Next Journey]] 
](else:)[(if: $cunning + $perception &gt; 4)[You are able to resist the alluring call of the sirens.
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)
](else:)[(set: $deathReason to &quot;You are gulled by them ladies and dunk yourself headfirst into the ocean eternal.&quot;)(goto: &quot;Death&quot;)
]
(set: $arg to -(random: 1, (ceil: $riftCrew/2)))(display: &quot;UpdateRiftCrew&quot;)
Some of your crew throw themselves to the sirens.  They are snatched out of the air in the sirens&#39;s greedy claws.
(set: _riftCommandDamage to (random: 0, 1))&lt;b&gt;Command - _riftCommandDamage&lt;/b&gt;(set: $riftCommand to it - _riftCommandDamage)
[[Next Journey]] 
]</tw-passagedata><tw-passagedata pid="503" name="Maelstrom" tags="journey" position="4349,1266" size="100,100">A reality-bending experience where there are 3 hidden mutator dials.  One changes each turn.  The player must figure out how to navigate the changing states in order to proceed.  Big speed boost for quick success.

[[Next Journey]]</tw-passagedata><tw-passagedata pid="504" name="Attacked by Pirates" tags="journey" position="4356,1388" size="100,100">You are menaced by pirates.  You can attempt to fight them or abandon yourself to them.

They choose to either take your treasure and/or supplies, kill you, kidnap you, or join your crew depending on a number of factors.
{(set: $pirateAnger to 5)(set: $pirateHealth to 10)
(set: $crewAnger to 0)(set: $crewHealth to $riftCrew)
(set: $turnsResisted to 0)}

Crew: (live: )[$crewHealth] vs. Pirates: (live: )[$pirateHealth]
|input&gt;[(link-repeat: &quot;Fight!&quot;)[(replace:?output)[
{(set: $pirateAnger to it + 1)
(set: $turnsResisted to it + 1)
(set: $playerAttack to (random: 0, $riftCommand))
(set: $pirateAttack to (random: 0, $pirateHealth))}
(if: $playerAttack &gt; $pirateAttack )[
Your crew press the attack against the pirates!
&lt;b&gt;Pirate Damage + (print: $playerAttack - $pirateAttack)&lt;/b&gt;(set: $pirateHealth to it - ($playerAttack - $pirateAttack))
(if: $pirateHealth &lt;= 0)[You have defeated the pirates and pillage their loot!
(set: $riftTreasure to it + 100)&lt;b&gt;Treasure + 100&lt;/b&gt;
(set: $riftSupplies to it + 30)&lt;b&gt;Supplies + 30&lt;b/&gt;
[[A Fetching Ransom]]

[[Next Journey]] 
(replace:?input)[]
]
](else:)[
The pirates begin to overcome you!
&lt;b&gt;Crew Health - (print: $pirateAttack - $playerAttack)&lt;/b&gt;(set: $crewHealth to it - ($pirateAttack - $playerAttack))
(if: $crewHealth &lt;= 0)[(replace:?input)[]
[[Kidnapped!]] 

[[Set Adrift]] 

[[Stranded on a Deserted Island]] 

[[On the Lifeboat]]
]]]]

(link-reveal: &quot;Surrender!&quot;)[(replace:?input)[](replace:?output)[
(if: $turnsResisted &lt; 3)[(set: $crewAnger to it + 3 - $turnsResisted)]
[[Kidnapped!]] 

[[Set Adrift]] 

[[Stranded on a Deserted Island]] 

[[On the Lifeboat]]
]]

(if: $inventory contains &quot;Captain&#39;s Hat&quot;)[(link-reveal: &quot;Nail My Colors to the Mast!&quot;)[(replace:?output)[
{(set: $playerAttack to (random: 0, $riftCommand) + 1)
(set: $pirateAttack to (random: 0, $pirateHealth))}
(if: $playerAttack &gt;= $pirateAttack )[
You and your crew quickly overwhelm the pirates!

[[Recruit a Salty Crew]]

(set: $riftTreasure to it + 100)&lt;b&gt;Treasure + 100&lt;/b&gt;
(set: $riftSupplies to it + 30)&lt;b&gt;Supplies + 30&lt;b/&gt;
[[A Fetching Ransom]]

[[Next Journey]] 
(replace:?input)[]
]
]]
]]

(if: $inventory contains &quot;Pirate&#39;s Cap&quot;)[ [[Parlay with the Pirates]] ]

|output&gt;[]</tw-passagedata><tw-passagedata pid="505" name="Desert Island" tags="journey" position="4348,1498" size="100,100">No supplies on this island.

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]] 

[[Scrape Barnacles off of the Hull]] 

(if: $riftDirection is 1)[ [[About to Aft, Return Home!]] ]</tw-passagedata><tw-passagedata pid="506" name="Deserted Island" tags="journey" position="4348,1604" size="100,100">No one lives on this island, but it may have forage.

(link-reveal: &quot;Forage for Supplies&quot;)[
(set: $arg to (random: 0, 50))(display: &quot;UpdateRiftSupplies&quot;)]

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]] 

[[Scrape Barnacles off of the Hull]] 

(if: $riftDirection is 1)[ [[About to Aft, Return Home!]] ]</tw-passagedata><tw-passagedata pid="507" name="Abandoned Monolith" tags="journey" position="4454,904" size="100,100">Either explore the monolith and whatever traps and treasures are therein, or sail on.
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)
|input&gt;[
(link-reveal: &quot;Let&#39;s Explore!&quot;)[
(replace:?input)[(display: &quot;Explore Ancient Tombs&quot;)]
]
[[Let&#39;s Sail On-&gt;Next Journey]] ]</tw-passagedata><tw-passagedata pid="508" name="Inhabited Island" tags="journey" position="4483,1164" size="100,100">This island is inhabited,(if: (random: 0,1) is 1)[ and they guard the beach, forbidding you from landing.  They do not appear to be violent: they just want to be left alone.

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)
](else:)[and they are willing to share with you and hold palaver on the beach.

They feed you their best foods in exchange for tales of your journeys through this sea.
(set: _musicalItems to (find: _item where (passage: _item)&#39;s tags contains &quot;musical&quot;, ...$inventory))
(if: _musicalItems&#39;s length &gt; 0)[
With a bit of hasty preparation, you play a piece on your (either: ..._musicalItems) that tells in music what human language could not convey about your epic journey through the seas of infinity.  It&#39;s quite a hit with both the locals and your crew.
(set: $arg to 1)(display: &quot;UpdateRiftCommand&quot;)
(set: $arg to 25)(display: &quot;UpdateRiftSupplies&quot;)
](else:)[You do not know their language, and they have only a few fragments of your language, so you must resort to the universal languages.  You have no musical instruments, so you spend a few hours eating and doing math.
(set: $arg to 0)(display: &quot;UpdateRiftCommand&quot;)
(set: $arg to 10)(display: &quot;UpdateRiftSupplies&quot;)]

(if: $riftDirection is 1)[ [[About to Aft, Return Home!]] ]
]

[[Next Journey]]</tw-passagedata><tw-passagedata pid="509" name="Hunting Expedition" tags="journey" position="4487,1279" size="100,100">You&#39;ve made landfall and have sighted animals.  You can join a small team of crew members to hunt for game and forage.


Invest a certain amount of time, then pay supplies as food for your crew.
Can choose to invest more time.  Will return random amount of supplies from a limited cache.

[[Go Hunting]]

Or, you can sail right past!

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]] 

(if: $riftDirection is 1)[ [[About to Aft, Return Home!]] ]</tw-passagedata><tw-passagedata pid="510" name="Fishing Contest" tags="journey" position="4481,1388" size="100,100">The seas are calm, and a large school of fish is feeding on zooplankton beneath your hull.  You and some members of your crew decide to do some fishing.  There&#39;s a little wager on the side to make it extra interesting.

Commit bait resources to try to draw a superior fish.  Best fish after 3 rounds wins.

(set: $riftSupplies to it + 50)&lt;b&gt;Supplies + 50&lt;/b&gt;
[[Next Journey]]</tw-passagedata><tw-passagedata pid="511" name="Crossing the Meridian" tags="journey" position="4480,1503" size="100,100">A foul celebration performed by long-time members of the ship&#39;s crew for every swab who&#39;s never crossed this meridian before.
They have many of these foul celebrations for the many, many meridians in Zenospace.
&lt;b&gt;Command + 1&lt;/b&gt;(set: $riftCommand to it + 1)
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="512" name="Playing Cards Below Deck" tags="journey" position="4476,1614" size="100,100">The crew wants to play cards with you, because they do not seem to fully understand that you are a magician.
You could easily cheat to win.


Win
Lose
Catch Them Cheating
Cheat and Get Caught
Cheat and Win


[[Next Journey]]</tw-passagedata><tw-passagedata pid="513" name="Singing Chanties" tags="journey" position="4589,908" size="100,100">You and the crew are singing chanties and drinking grog.

(either: &quot;There once was a creature&quot;, &quot;Of very slight stature&quot;) (either: &quot;of curious nature&quot;, &quot;and not a bit bashful&quot;)!
(either: &quot;And fine, luxurious hair&quot;, &quot;Gentle sailors beware&quot;)!
(either: &quot;She fell in love with a sailor&quot;, &quot;He did her a favor&quot;) (either: &quot;who did hard labor&quot;, &quot;and he did save her&quot;)!
(either: &quot;Mermaid children, the males do bear&quot;, &quot;And he fell into her snare&quot;)!

(set: $arg to -10)(display: &quot;UpdateRiftSupplies&quot;)

(if: (random: 0, 10) is 0)[Actually, you might have had *too much* grog, if that&#39;s possible.
[[Wake Up In The Brig]] 
]
(else:)[
(set: $arg to 1)(display: &quot;UpdateRiftCommand&quot;)

[[Next Journey]] ]</tw-passagedata><tw-passagedata pid="514" name="Safe Harbor" tags="journey" position="4592,1023" size="100,100">Your ship comes to rest in the harbor of a small island.

&lt;b&gt;Command + 1&lt;/b&gt;(set: $riftCommand to it + 1)
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Scrape Barnacles off of the Hull]] 

[[Next Journey]] 

(if: $riftDirection is 1)[ [[About to Aft, Return Home!]] ]</tw-passagedata><tw-passagedata pid="515" name="Ancient Tombs" tags="journey" position="4596,1164" size="100,100">(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)
Your sailship has come across the stone ruins of an ancient tomb complex.
Great treasure could be found inside, but perhaps great danger as well.
Either explore the tombs and whatever traps and treasures are therein, or sail on.
|input&gt;[
(link-reveal: &quot;Let&#39;s Explore!&quot;)[
(replace:?input)[(display: &quot;Explore Ancient Tombs&quot;)]
]
[[Let&#39;s Sail On-&gt;Next Journey]] ]</tw-passagedata><tw-passagedata pid="516" name="Derelict Dreadnought" tags="journey" position="4352,438" size="100,100">You can choose to explore this vast dreadnought rift ship. 

[[Explore the Derelict Dreadnought]]

[[Sail Away-&gt;Smooth Sailing]]</tw-passagedata><tw-passagedata pid="517" name="Void Rays" tags="journey" position="4597,1388" size="100,100">Beautiful and elegant motion enchanters.  Careful study of them can be beneficial.

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="518" name="Dolphin&#39;s Guidance" tags="journey" position="4597,1495" size="100,100">As everyone knows, dolphins are highly-evolved hyper-sentient beings that are the only known organisms who can consciously plan their way through transdimensional space.

(set: $arg to 6)(display: &quot;UpdateRiftDistance&quot;)

They offer you an additional shortcut:
(if: $riftCommand &lt;= 0)[[[Go to Hell-&gt;Next Journey]]](else:)[
(set: _options to (shuffled: ...(find: _item where _item&#39;s tags contains &quot;journey&quot;, ...(passages:))))

(for: each _item, ...(subarray: _options, 1, $perception))
[
(link-goto: (_item&#39;s name), (_item&#39;s name))]]</tw-passagedata><tw-passagedata pid="519" name="Dive for Pearls" tags="journey" position="4597,1614" size="100,100">Your crew point out a valuable place to get Rift Pearls.  It&#39;s a press your luck game where you can take a smaller treasure or risk dying to get a bigger treasure.
(set: $breath to $health * 5)
(set: $currentDepth to 0)
|input&gt;[
(link-repeat: &quot;Dive Deeper&quot;)[(set: _nextDepth to $currentDepth + (random: 1, 5) * 10)
(set: $currentDepth to it + (random: 1, 5))
(set: $breath to it - 1)
(replace:?output)[Current Depth -&gt; $currentDepth
Breath -&gt; $breath
(if: (random: 0, 4) &gt;= 4)[(set: $riftPearlValue to (random: (ceil:$currentDepth/4), (ceil: $currentDepth/2)))You&#39;ve found a pearl worth approximately $riftPearlValue treasure units.
]]]
(link-repeat: &quot;Return to the Surface&quot;)[(set: _divingDirection to -1)(set: $breath to it - (random: 1,2))
(replace:?output)[(set: $currentDepth to it - (random: 1, 5))Current Depth -&gt; $currentDepth
Breath -&gt; $breath
(if: $currentDepth &lt;= 0)[(replace:?input)[You return to your ship, (if: $riftPearlValue &gt; 0)[victorious, treasure in hand.
(set: $arg to &quot;Perfect Pearl&quot;)(display: &quot;GetItem&quot;)](else:)[empty-handed.]
(set: $arg to $riftPearlValue)(display: &quot;UpdateRiftTreasure&quot;)

[[Next Journey]]](else:)[
(if: $breath &lt;= 0)[Your lungs are running low on vital oxygen and are overflowing with effluvium.
(set: $deathReason to &quot;You asphyxiated.&quot;)(set: $arg to 1)(display: &quot;TakeDamage&quot;)]]]]]
]

|output&gt;[]</tw-passagedata><tw-passagedata pid="520" name="Rolling Bones" tags="journey" position="4697,907" size="100,100">Your crew invites you to join their dice game.  They are seated belowdecks around a barrel littered with glimmering coins.  They extend you the dice cup.

(display: &quot;Dice Game #1&quot;)


[[Time For Me to Call it a Night-&gt;Next Journey]]</tw-passagedata><tw-passagedata pid="521" name="Swabbing Decks" tags="journey" position="4704,1023" size="100,100">It&#39;s time to swab the decks.  Everybody groans.
|input&gt;[
(link-reveal: &quot;Jump In and Start Working!&quot;)[(replace:?input)[The furious eye of the Rift, the Siren&#39;s Folly, is brutally hot today. (set: $deathReason to &quot;You were withered into a hideous flesh jerky by the unrelenting eye of the Rift.&quot;)(set: $arg to (either: 0,0, 1))(display: &quot;TakeDamage&quot;)
(if: (random: 0, 1) &gt; 0)[Your crew appreciate you throwing in your lot with them.
&lt;b&gt;Command + 1&lt;b/&gt;(set: $riftCommand to it + 1)]
]]
(link-reveal: &quot;Let the Crew Handle It&quot;)[(replace:?input)[
(if: (random: 0, $riftCommand) &lt; 1)[Your crew would have appreciated you throwing in your lot with them.
&lt;b&gt;Command - 1&lt;b/&gt;(set: $riftCommand to it - 1)](else:)[Your crew quickly go about their work.

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)]
]]
]

[[Next Journey]]</tw-passagedata><tw-passagedata pid="522" name="Sparring" tags="journey" position="4686,757" size="100,100">{(set: $enemyHealth to 9)(set: $koHealth to 6)
(set: $fightPattern to (a:&quot;Biff&quot;,(either: &quot;Boff&quot;, &quot;Bash&quot;),&quot;Biff&quot;,(either: &quot;Boff&quot;, &quot;Bash&quot;),&quot;Rest&quot;))
(set: $fightIndex to 1)
(set: $koReason to &quot;You biffed when you should have boffed.&quot;)
}You see a (either: &quot;swarthy&quot;, &quot;grinning&quot;, &quot;salty&quot;) (either: &quot;crewmate&quot;, &quot;fellow&quot;, &quot;bosun&quot;) with their dukes in the air.  They challenge you to a little biff-boff-bash!

|output&gt;[]

|input&gt;[
(display: &quot;Sparring Shuffle&quot;)
]</tw-passagedata><tw-passagedata pid="523" name="Palaver with the Captain" tags="journey" position="4710,1273" size="100,100">You and the captain trade chat during a quiet moment.
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)
(set: $riftCommand to it + (random: 0, 1))
(either: &quot;Some say Sirens will grant you secrets, should you listen to them.&quot;,
&quot;If you get a Compass of Many Places, it will help quite a bit out here.&quot;,
&quot;I don&#39;t think anyone has gone all of the way to the center of the Rift.&quot;,
&quot;Every time we see land, it could be even more dangerous than the open seas.&quot;,
&quot;Reality doesn&#39;t work the same way out here as it does in the City.&quot;,
&quot;I once saw an iceberg in the middle of the warmest of seas.  Turns out to have been the beak of a truly dire monster.&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="524" name="Your Turn in the Crow&#39;s Nest" tags="journey" position="4713,1390" size="100,100">Everyone takes a turn in the Crow&#39;s Nest, because staring into the raw, unfiltered eye of the Rift tends to cause folk to go mad.
(if: (random: 0, $perception) &gt;= 2)[By keeping your eyes open, you&#39;re able to pick a better route through the possibility sea.
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)
[[Pick Next Heading]] ](else:)[
By performing your job adequately, you help move the ship even faster through the sea.
(set: $arg to 2)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]]</tw-passagedata><tw-passagedata pid="525" name="Kidnapped!" tags="journey" position="4714,1502" size="100,100">You&#39;ve been taken captive but there&#39;s still time to make it back to your ship.

|input&gt;[(set: $ransom to (random: 1, 10) * 100)
(if: $gold &gt;= $ransom)[(link-reveal: &quot;Pay the Ransom ($ransom)&quot;)[
(set: $arg to -$ransom)(display: &quot;UpdateGold&quot;)
They release you on a lifeboat.
[[On the Lifeboat]]
]]
Try to fight your way to safety
[[Steal a Lifeboat]]]</tw-passagedata><tw-passagedata pid="526" name="A Fetching Ransom" tags="journey" position="4715,1611" size="100,100">You&#39;ve rescued an aristocratic tourist from people more wicked than yourselves.  They&#39;ll fetch a fine price upon their safe return?

|output&gt;[]
|input&gt;[(link-reveal: &quot;Abandon Them&quot;)[(replace:?input)[You leave them to their own devices.

[[Next Journey]] ]]
(link-reveal: &quot;Kidnap Them&quot;)[(replace:?input)[
\todo

[[Next Journey]] ]]
(link-reveal: &quot;Recruit Them&quot;)[(replace:?input)[
(set: $arg to 1)(display: &quot;UpdateRiftCrew&quot;)

[[Next Journey]] ]]]</tw-passagedata><tw-passagedata pid="527" name="Fast Current" tags="journey" position="4219,1603" size="100,100">The crew takes advantage of an advantageous current to boost speed through the area.

&lt;b&gt;Command + 1&lt;/b&gt;(set: $riftCommand to it + 1)
(set: $arg to 4)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="528" name="Buried Treasure" tags="journey" position="4822,911" size="100,100">If you have the map and the key, the treasure is yours to keep.

(if: $inventory contains all of (ds: &quot;Treasure Map&quot;, &quot;Chest Key&quot;))
[
(link-reveal: &quot;Dig Up the Treasure&quot;)[
(set: $inventory to it - (ds: &quot;Treasure Map&quot;, &quot;Chest Key&quot;))
(set: $arg to 250)(display: &quot;UpdateRiftSupplies&quot;)
(display: &quot;UpdateRiftTreasure&quot;)
]
]
(else-if: $inventory contains all of (ds: &quot;Treasure Map&quot;, &quot;Skeleton Key&quot;))
[
(link-reveal: &quot;Dig Up the Treasure&quot;)[
(set: $inventory to it - (ds: &quot;Treasure Map&quot;))
(if: (random: 0, 6) is 0)[The skeleton key has finally broken! And its broken off in the lock!
(set: $inventory to it - (ds: &quot;Skeleton Key&quot;))](else:)[
(set: $arg to 250)(display: &quot;UpdateRiftSupplies&quot;)
(display: &quot;UpdateRiftTreasure&quot;)
]]
]
(else:)
[Unfortunately, you have no such tools.]

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="529" name="Pirate&#39;s Cove" tags="journey" position="4817,1025" size="100,100">A spiky accretion of captured sail ships, spikes, electrical wires, and rudimentary pre-ansible stabilization technology forms the base of operations for rift pirates.

(if: $inventory contains any of (ds: &quot;Pirate Hat&quot;, &quot;Belonging Sign&quot;))[
If you&#39;re allied with the pirates, you can stay here and resupply, etc.

[[Recruit a Salty Crew]] 

[[Singing Chanties]] 

[[Purchase Supplies]]

[[Scrape Barnacles off of the Hull]] 

(if: $riftDirection is 1)[ [[About to Aft, Return Home!]] ]
]
(else:)
[
(if: (random: 0, 1) is 0)[
You cannot escape them!

[[Attacked by Pirates]] 
](else:)[

You sail off without interacting with them.
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]] 
]]</tw-passagedata><tw-passagedata pid="530" name="Colonial Fort" tags="journey" position="5681,1275" size="100,100">Your ship approaches a sizeable island with a small, well-maintained fort squatting on the highest point.  Serious-looking soldiers in light arms and armor approach your landing.
(unless: $inventory contains &quot;Pirate&#39;s Cap&quot;)[
One hails you, &quot;You can stay here and do basic maintenance as long as you&#39;re not a pirate.&quot;
(if: $inventory contains any of (ds: &quot;Noble Cowl&quot;, &quot;Belonging Sign&quot;))[
&quot;Ah! I didn&#39;t recognize you at first.  Please avail yourself of our surplus!&quot;
[[Purchase Supplies]]]

[[Scrape Barnacles off of the Hull]] 

Or, you can skedaddle.
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]] 

(if: $riftDirection is 1)[ [[About to Aft, Return Home!]] ]
](else:)[

You&#39;re a pirate, they&#39;re an anti-pirate.  You should just move along.

[[Next Journey]] 

Or, you can [[Raid the Colonial Fort]].

]</tw-passagedata><tw-passagedata pid="531" name="Something Follows in the Deep" tags="journey" position="4833,1275" size="100,100">(if: visits &lt; 3)[
You see a dark form in the eternal ocean below you.  It lurks but does not emerge.
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)
[[Next Journey]] ]
(else-if: visits is 3)[
The darkness below the surface erupts, engulfing your ship deep in its craw.

[[In the Literal Belly of the Literal Beast]]
]
(else:)[Not since that day have you seen the darkness follow you in the deep.  It is through with you.

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)
[[Next Journey]] ]</tw-passagedata><tw-passagedata pid="532" name="In the Literal Belly of the Literal Beast" tags="" position="4958,1276" size="100,100">Try to escape the inside of a giant transdimensional dragon whale before you are digested.

[[Next Journey]]</tw-passagedata><tw-passagedata pid="533" name="Learning the Laws of the Sea" tags="journey" position="4838,1396" size="100,100">The crew entreat you to learn an incredible cyclopaedia of absolute filth, including outright lies about basic anatomy.
(set: $arg to 1)(display: &quot;UpdateRiftCommand&quot;)
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="534" name="Trading Gossip with the Sea Hag" tags="journey" position="4835,1503" size="100,100">Every ship has its resident sea hag.  They are known to be liars, but it depends on when and how you talk to them.

Sea hags are beings who&#39;ve been specially enchanted to withstand repeated, prolonged exposure to transdimensional forces that would otherwise drive the crew mad.

They can give you enchantment marks that grant protection from the Rift.

(set: _cost to 1500)(set: $marketplace to (a: &quot;Belonging Sign&quot;, &quot;Skein of the Deep&quot;))(for: each _item, ...$marketplace)[(unless: $inventory contains _item)[
(display: &quot;QuickBuy&quot;)
]]

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]
ds [journey] {&quot;position&quot;:&quot;4952,913&quot;,&quot;size&quot;:&quot;100,100&quot;}
Several market stalls have been lashed together on top of some floats, creating a floating market that has crossed paths with you.

(set: $marketplace to (a: &quot;Supply Crate&quot;, &quot;Supply Crate&quot;, &quot;Supply Crate&quot;))
(set: $price to 100)
(for: each _item, ...$marketplace)[	(set: _t1 to _item)	(set: _t2 to $price)	(link-reveal: &quot;Buy &quot; + _t1 + &quot; For &quot; + (str: _t2) + &quot; Gold&quot;)[(if: $gold &gt; _t2)[You buy _t1 for _t2. 
	(set: $riftSupplies to it + 50)(set: $gold to it - _t2)
	(replace:?clock)[(display: &quot;RenderHeader&quot;)]](else:)[You don&#39;t have the dosh, mate.]]
	(set: $price to $price * 2)
]

[[Next Journey]]</tw-passagedata><tw-passagedata pid="535" name="Trade Winds" tags="journey" position="4952,913" size="100,100">Several market stalls have been lashed together on top of some floats, creating a floating market that has crossed paths with you.

(set: $marketplace to (a: &quot;Supply Crate&quot;, &quot;Supply Crate&quot;, &quot;Supply Crate&quot;))
(set: $price to 100)
(for: each _item, ...$marketplace)[	(set: _t1 to _item)	(set: _t2 to $price)	(link-reveal: &quot;Buy &quot; + _t1 + &quot; For &quot; + (str: _t2) + &quot; Gold&quot;)[(if: $gold &gt; _t2)[You buy _t1 for _t2. 
	(set: $riftSupplies to it + 50)(set: $gold to it - _t2)
	(replace:?clock)[(display: &quot;RenderHeader&quot;)]](else:)[You don&#39;t have the dosh, mate.]]
	(set: $price to $price * 2)
]

[[Next Journey]]</tw-passagedata><tw-passagedata pid="536" name="Scavenger Barge" tags="journey tick" position="4947,1036" size="100,100">A floating agglomeration of reclaimed materials, impromptu craftwork, and outright trash.  They sell the choicest pieces of their scavenging for fresh food and gold.

Random, semilegal items sold by a mobile heap of trinkets, knickknacks, wagon wheels, and presumably an actual person as wiry, grey arms do reach out with items for sale and to receive payment, although not always the stereotypical number we associate with humanoids.

{(set: $marketplace to (shuffled: &quot;Selkie Skin&quot;, &quot;Pirate&#39;s Cap&quot;, &quot;Map Fragment&quot;, &quot;Lodestone&quot;, &quot;Sea Scum&quot;)&#39;s (a: 1, 2))}
(for: each _item, ...$marketplace)[(unless: $inventory contains _item)[
(set: _cost to 10 + (random: 0, 6) * 5)(display: &quot;QuickBuy&quot;)
]]

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="537" name="Light House" tags="journey" position="4952,1154" size="100,100">A gigantic ansible, arranging rings of order out from it into the boiling chaos of the Rift.

(if: $inventory contains &quot;Silent Ansible&quot;)[
Your Silent Ansible harmonizes with the Light House, sending you forward a dramatic distance and granting you a selection of choice universes.

(set: $arg to 100)(display: &quot;UpdateRiftDistance&quot;)

(set: _options to (shuffled: ...(find: _item where _item&#39;s tags contains &quot;journey&quot;, ...(passages:))))

(for: each _item, ...(subarray: _options, 1, $riftCommand))
[
(link-goto: (_item&#39;s name), (_item&#39;s name))]]
(else-if: $inventory contains &quot;The Compass of Many Places&quot;)[
(set: _options to (shuffled: ...(find: _item where _item&#39;s tags contains &quot;journey&quot;, ...(passages:))))

(for: each _item, ...(subarray: _options, 1, 4))
[
(link-goto: (_item&#39;s name), (_item&#39;s name))]]
(else:)[
(set: $arg to 10)(display: &quot;UpdateRiftDistance&quot;)
]

[[Next Journey]]</tw-passagedata><tw-passagedata pid="538" name="Seafall" tags="journey" position="4959,1396" size="100,100">The world isn&#39;t flat, of course, but there are numerous places in this unnatural sea where it drops off and becomes an enormous waterfall for many leagues in either direction.

You must backtrack a bit to get to a place where you can safely maneuver.

&lt;b&gt;Command - 1&lt;/b&gt;(set: $riftCommand to it - 1)
(set: $arg to 0)(display: &quot;UpdateRiftDistance&quot;)
[[Next Journey]]</tw-passagedata><tw-passagedata pid="539" name="Run Aground" tags="journey" position="4971,1513" size="100,100">(if: (random: 0, $perception) &lt;= 2)[You&#39;ve run aground!  The crew are upset.  They desperately repair the ship before it submerges into transreality space.

&lt;b&gt;Command - 1&lt;/b&gt;(set: $riftCommand to it - 1)

(set: $arg to 0)(display: &quot;UpdateRiftDistance&quot;)

(if: $riftDirection is 1)[ [[About to Aft, Return Home!]] ]
](else:)[
You spot the shallows and alert the navigator in time to dodge them.

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)
]

[[Next Journey]]</tw-passagedata><tw-passagedata pid="540" name="In the Fog" tags="journey" position="4973,1622" size="100,100">All around you is impenetrable fog.  You can carefully drift in place until it is clear enough to see, or you can push forward and risk crashing into detritus or landfall.

|input&gt;[(link-reveal: &quot;Charge Ahead!&quot;)[(replace:?output)[](if: (random: 0, $perception) &gt; 2)[(set: $arg to 1.2)(display: &quot;UpdateRiftDistance&quot;)
[[Next Journey]]](else:)[ 
[[Run Aground]]]]]
|output&gt;[(if: (random: 0,1) is 0)[ [[Drift in Place-&gt;In the Fog]]](else:)[ 
(set: $arg to 0.1)(display: &quot;UpdateRiftDistance&quot;)(replace:?input)[]
[[Next Journey]]]
]</tw-passagedata><tw-passagedata pid="541" name="Reef Diving" tags="journey" position="5072,921" size="100,100">Some crew point out that you&#39;re sailing close to a famous coral reef, which may be entertaining to explore.

|input&gt;[
(link-reveal: &quot;Let&#39;s Explore&quot;)[(replace:?input)[

Down in the briny water, floating about like gravity is a myth or a mild inconvenience.  You and your crew can clearly see the vitality of this reef.  You see
(either: &quot;3D Mandelbrot coral&quot;, &quot;hyperbolic sponges&quot;, &quot;eels poking through cracks&quot;, &quot;the worms that make the wormholes&quot;).

It is an awe-inspiring journey.
(set: $arg to 1)(display: &quot;UpdateRiftCommand&quot;)

[[Next Journey]]
]]
(link-reveal: &quot;Let&#39;s Keep Going&quot;)[
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]] 
]
]</tw-passagedata><tw-passagedata pid="542" name="Rogue Wave" tags="journey" position="5070,1040" size="100,100">If you are going towards the eye of the Rift, will push you back towards the Rift.

(if: $riftDirection &gt; 0)[(set: $arg to -2)(display: &quot;UpdateRiftDistance&quot;)]

If you are going back to North Harbor, will push you closer to North Harbor.

(if: $riftDirection &lt; 0)[(set: $arg to 2)(display: &quot;UpdateRiftDistance&quot;)]

[[Next Journey]]</tw-passagedata><tw-passagedata pid="543" name="Mermaids" tags="journey" position="5681,1534" size="100,100">They will trade fresh supplies to borrow crew members.

Crew members who are &quot;borrowed&quot; will be returned the next time that the mermaids are encountered, but they will have thousands of mermaid eggs in their bellies.

(set: $arg to (dm: &quot;delay&quot;, 3, &quot;event&quot;, &quot;Mermaid Birth&quot;))(display: &quot;Schedule Event&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="544" name="Selkies" tags="journey" position="5082,1276" size="100,100">A group of selkies pops out of the sea near your vessel.  In their hands they hold the skin of a selkie outcast.  
(display: &quot;Selkie Skin&quot;)

(set: _item to &quot;Selkie Skin&quot;)(set: _cost to 350)(display: &quot;QuickBuy&quot;)

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="545" name="Ships of the Line" tags="journey" position="5077,1395" size="100,100">A pitched battle between two full navies.

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="546" name="Sargasso" tags="journey" position="5085,1513" size="100,100">A dangerous bloom of flora that prevents forward movement.

(set: $arg to 0)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="547" name="Cross Winds" tags="journey" position="5088,1635" size="100,100">The crosswinds here make going straight quite challenging.  If you&#39;re not cautious, you&#39;ll end up perpendicular in the sixth dimension AKA &quot;ass over teakettle&quot;.

(set: $arg to -1)(display: &quot;UpdateRiftCommand&quot;)
(set: $arg to 0)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="548" name="Domed City" tags="journey" position="5185,928" size="100,100">(if: (history:) contains &quot;Read The True History of Leng&quot;)[Ah, that belongs to the Leng-i-ans.  We could pillage that or sail away unharmed.

]
(else:)[Yonder domed city in the sea.  Who knows what that is?  The crew grow anxious and spout superstitious nonsense.
&lt;b&gt;Command - 1&lt;/b&gt;(set: $riftCommand to it - 1)
]
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="549" name="Yacht Race" tags="" position="5193,1048" size="100,100">You challenge a fellow riftrunner sail ship to a race.

&lt;b&gt;Command - 1&lt;/b&gt;(set: $riftCommand to it - 1)
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)
&lt;b&gt;Supplies - 1&lt;/b&gt;(set: $riftSupplies to it - 1)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="550" name="Assassins On Board!" tags="journey" position="5203,1280" size="100,100">You don&#39;t know how, but assassins have come on board and are here to kill you!

{(set: $enemyHealth to 3)
(set: $fightPattern to (a:&quot;Strike&quot;,&quot;Strike&quot;,(either: &quot;Strike&quot;, &quot;Throw&quot;),&quot;Rest&quot;))
(set: $fightIndex to 1)
(set: $deathReason to &quot;You were garrotted in your bunk by a professional killer.&quot;)
}You see a (either: &quot;cloaked&quot;, &quot;shadowy&quot;, &quot;zealous&quot;) (either: &quot;strangler&quot;, &quot;assassin&quot;, &quot;strongarm&quot;) with their weapon levelled at you.
They demand your life.

|output&gt;[]

|input&gt;[(display: &quot;Fight&quot;)]

(event: when $enemyHealth &lt;= 0)[ [[Next Journey]] ]</tw-passagedata><tw-passagedata pid="551" name="Stowaways" tags="journey" position="5198,1391" size="100,100">You&#39;ve somehow picked up stowaways.  With nowhere to drop them off, you press them into your service.

|output&gt;[(set: $arg to 2)(display: &quot;UpdateRiftCrew&quot;)]

[[Next Journey]]</tw-passagedata><tw-passagedata pid="552" name="Capture Merchant Ship" tags="" position="5198,1506" size="100,100">[[Next Journey]]</tw-passagedata><tw-passagedata pid="553" name="Flying Dutchman" tags="journey" position="5207,1636" size="100,100">It&#39;s the Flying Dutchman.  You can board it, but it has nothing to discover.

[[Next Journey]]</tw-passagedata><tw-passagedata pid="554" name="Trash Gyre" tags="journey" position="5307,962" size="100,100">Mudlarking in the ocean eternal. Try not to fall in!

(link-repeat: &quot;Search the Gyre&quot;)[(if: (random: 0, 25) is 0)[(goto: &quot;Monster Attack&quot;)](else:)[(replace:?output)[(display: &quot;RandomTrashGyre&quot;)]]]
|output&gt;[]

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="555" name="Cruise Ship" tags="journey" position="5310,1043" size="100,100">Transdimensional tourists getting drunk and taking photos of the Rift.


(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="556" name="The Angler" tags="journey" position="5307,1158" size="100,100">In what passes for night in this misbegotten Rift, the crew carry lanterns to illuminate and signal.

(if: $perception &gt; 3)[As you watch, something seems off with one of the lanterns.  You shout to your crew as a hideous, toothy maw erupts from the Rift Sea.  A giant Angler, with a hypnotic signal lamp on its brow.  
Some noble crew are devoured, but not as many as would have been without your warning.
(set: $arg to -(random: 1, 2))(display: &quot;UpdateRiftCrew&quot;)](else:)[
Without warning, a hideous, toothy maw erupts from the Rift Sea.  A giant Angler, with a hypnotic signal lamp on its brow, begins devouring your crew.
(set: $arg to -(random: 1, $riftCrew))(display: &quot;UpdateRiftCrew&quot;)
]
You escape, but barely.

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="557" name="Man o&#39;War Jelly" tags="journey" position="5323,1280" size="100,100">A great, gelatinous mass arises from the sea in front of your ship.  Deadly, stinging tentacles trail behind it in unseen winds.  You and your crew may be able to navigate through!
(if: (random: 0, $perception + $riftCommand) &gt; 1)[
You&#39;ve managed to escape!
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]
](else:)[
Sadly, you&#39;ve become entangled!

[[Monster Attack]] 
]</tw-passagedata><tw-passagedata pid="558" name="Fleet of Corsairs" tags="journey" position="5317,1393" size="100,100">The crew in the crow&#39;s nest hollers a &quot;Hallooo!&quot; to the small fleet of fast-moving warships approaching you.

(if: (random: 0, 3) is 0)[They&#39;ve decided to take you on.

[[Attacked by Pirates]]]
(else:)[
They must have been after someone else.

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]] 
]</tw-passagedata><tw-passagedata pid="559" name="Fire Below Decks" tags="journey" position="5307,1505" size="100,100">Existential threat to ship.
FIRE!!!

You and your crew must risk your lives to avoid losing supplies OR WORSE!

How many are you willing to risk?  (dropdown: bind _sacrifice, ...(altered: _i via (str: _i), ...(range: 0, $riftCrew)))
(link-reveal: &quot;Batten Down The Hatches!&quot;)[
(if: (num:_sacrifice) is 0)[You rush out and begin dousing the fire with water, spellcraft, and panic sweat.
(if: (random: 0, $perception) &gt; 2)[
(set: _roll to (random: 0, $riftCrew + $riftCommand))
Roll: _roll
(if: _roll &gt; 20)[Your crew is inspired by your courage and follow your lead!
(set: $arg to 1)(display: &quot;UpdateRiftCommand&quot;)
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

](else:)[You do a passable job and don&#39;t lose too many supplies.
(set: $arg to (random: 10, 20))(display: &quot;UpdateRiftSupplies&quot;)
]
[[Next Journey]]](else:)[The ship is lost.  You&#39;ve a chance to escape.

[[On the Lifeboat]] ]
](else:)[
You send _sacrifice crew members into the ship&#39;s coal bin!
(set: _roll to (random: 0, (pow: (num:_sacrifice), 2) * 5))
Roll: _roll
(set: $arg to (max: 0, 30 - _roll))(display: &quot;UpdateRiftSupplies&quot;)
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)
(set: $arg to -(abs: (min: 0, (random: 0, 10) - (num: _sacrifice))))
(display: &quot;UpdateRiftCrew&quot;)

[[Next Journey]] 
]]</tw-passagedata><tw-passagedata pid="560" name="Found Stranded Fellow" tags="journey" position="5327,1631" size="100,100">You happen upon a desperate, scrawny-looking fellow clinging to a chunk of detritus.  They have been set adrift.  You could easily pick them up, but it would cost you some travel time.

|input&gt;[(link-reveal: &quot;Rescue Them&quot;)[(replace:?input)[
(if: $inventory contains &quot;Selkie Skin&quot;)[They see you holding the Selkie Skin and explode with rage.
&quot;How dare you take that!&quot; they scream.
They grab the Selkie Skin from you, don it themselves, and then disappear beneath the waves.
(set: $inventory to it -(ds: &quot;Selkie Skin&quot;))
]
(else:)[
(set: $arg to 1)(display: &quot;UpdateRiftCrew&quot;)] ]]
(link-reveal: &quot;Keep Going&quot;)[(replace:?input)[(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)]]]
|output&gt;[]

[[Next Journey]]</tw-passagedata><tw-passagedata pid="561" name="Carving Scrimshaw" tags="" position="5437,928" size="100,100">Build an artifact.


(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="562" name="Submarine Excursion" tags="journey" position="5440,1046" size="100,100">Since it&#39;s not really water, you can fly your ships into the &quot;ocean&quot; in order to pick up treasure or supplies.
{(set: $breath to $health * 5)
(set: $currentDepth to 0)
|input&gt;[(set: _nextDepth to $currentDepth + (random: 1, 5) * 10)
(link-repeat: &quot;Return to the Surface&quot;)[(set: _divingDirection to -1)(replace:?input)[](set: $breath to it - (random: 1,2))
(replace:?output)[(set: $currentDepth to it - (random: 1, 5))Current Depth -&gt; $currentDepth
Breath -&gt; $breath
(if: $currentDepth &lt;= 0)[You return to your ship, victorious, treasure in hand.
&lt;b&gt;Treasure + $riftPearlValue&lt;b/&gt;(set: $riftTreasure to it + $riftPearlValue)](else:)[
(if: $breath &lt;= 0)[Your lungs are running low on vital oxygen and are overflowing with effluvium.
(set: $deathReason to &quot;You asphyxiated.&quot;)(set: $arg to 1)(display: &quot;TakeDamage&quot;)]]]]&lt;br/&gt;&lt;br/&gt;
(link-repeat: &quot;Dive Deeper&quot;)[
(set: $currentDepth to it + (random: 1, 5))
(set: $breath to it - 1)
(replace:?output)[Current Depth -&gt; $currentDepth
Breath -&gt; $breath
(if: (random: 0, 4) &gt;= 4)[(set: $riftPearlValue to (random: (ceil:$currentDepth/4), (ceil: $currentDepth/2)))You&#39;ve found a pearl worth approximately $riftPearlValue treasure units.
(link-reveal: &quot;Take it and Return to the Surface&quot;)[(replace:?input)[]]
]
]
]]

|output&gt;[]
}

[[Next Journey]]</tw-passagedata><tw-passagedata pid="563" name="Polar Passage" tags="journey" position="5437,1158" size="100,100">At risk to your supplies, you can attempt a shortcut.

(set: $arg to -(random: 0, $riftSupplies))(display: &quot;UpdateRiftSupplies&quot;)

(set: $arg to (random: 0, 10))(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="564" name="Penguins" tags="journey" position="5448,1271" size="100,100">Everyone thinks penguins are adorable.  Good feelings.


(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="565" name="Pillars of Hot Ocean" tags="journey" position="5438,1400" size="100,100">Giant pillars of steaming hot ocean erupt from the rift sea.  You could ride on them for a distance boost, but it&#39;s risky.

|input&gt;[(link-reveal: &quot;Charge Ahead!&quot;)[(replace:?output)[](if: (random: 0, $perception) &gt; 2)[(set: $arg to 10)(display: &quot;UpdateRiftDistance&quot;)
[[Next Journey]]](else:)[ 
[[Run Aground]]]]]
|output&gt;[It&#39;s pretty foggy down here.
[[Drift in Place-&gt;In the Fog]]]</tw-passagedata><tw-passagedata pid="566" name="Bilge Tank Overflow" tags="journey" position="5457,1520" size="100,100">Filthy and demoralizing.  Witch Jars everywhere!


(set: $arg to 0)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="567" name="Trade with Kayakers" tags="journey" position="5470,1638" size="100,100">Some sentients live full time out here on tiny ships.  
They will trade supplies for curiosities.
(set: _options to (find: _p where (passage: _p)&#39;s tags contains &quot;item&quot;, ...$inventory))
(if: _options&#39;s length &gt; 2)[
(for: each _item, ...(shuffled: ..._options&#39;s (a: 1, 2, 3)))[(set: _i to _item)
(link-reveal: &quot;Trade &quot; + _i)[(set: $inventory to it -(ds: _i))
(set: $arg to it + (random: 5, 50))(display: &quot;UpdateRiftSupplies&quot;)]
]]
(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="568" name="Whale Watching" tags="journey" position="5573,923" size="100,100">Super-sweet whales.


(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="569" name="The Ocean Laid Bare" tags="journey" position="5575,1275" size="100,100">Imagine you are sailing the greatest sea on your particular planet, and one day, all of the water is suddenly gone.  You are trapped on the bottom of the sea.
All around you is detritus, sea monsters, treasure.

You could leave the boat in search of bounty, but when will the water return?!

(set: $arg to 0)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="570" name="The Tavern Barge" tags="journey" position="5575,1390" size="100,100">Good currents have brought you to a place for seafaring crews like yours.  On great pontoons, an epic tavern has been erected.

[[Recruit a Salty Crew]] 

[[Singing Chanties]] 

[[Purchase Supplies]] 

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="571" name="Message in a Bottle" tags="journey" position="5566,1519" size="100,100">(display: &quot;Random Bulk Scroll&quot;)

(set: $arg to 1)(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="572" name="Tempest" tags="journey" position="5578,1632" size="100,100">Your ship is shifted random distances along the path to the Siren&#39;s Folly, the eye of the Rift.

(set: $arg to (random: -6, 6))(display: &quot;UpdateRiftDistance&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="573" name="Circled by Sharks" tags="journey" position="5695,920" size="100,100">You and your crew are surrounded by a sphere of hypersharks.</tw-passagedata><tw-passagedata pid="574" name="Above Decks #1" tags="" position="4586,350" size="100,100">(display: &quot;Explore Derelict&quot;)

[[Above Decks #2]] 

[[Below Decks #1]]</tw-passagedata><tw-passagedata pid="575" name="Above Decks #2" tags="" position="4713,336" size="100,100">(display: &quot;Explore Derelict&quot;)

[[Above Decks #1]] 

[[Above Decks #3]] 

[[Below Decks #2]]</tw-passagedata><tw-passagedata pid="576" name="Above Decks #3" tags="" position="4835,321" size="100,100">(display: &quot;Explore Derelict&quot;)

[[Above Decks #2]] 

[[Below Decks #3]]</tw-passagedata><tw-passagedata pid="577" name="Below Decks #1" tags="" position="4590,458" size="100,100">(display: &quot;Explore Derelict&quot;)

[[Above Decks #1]] 

[[Below Decks #2]]</tw-passagedata><tw-passagedata pid="578" name="Below Decks #2" tags="" position="4716,448" size="100,100">(display: &quot;Explore Derelict&quot;)

[[Above Decks #2]] 

[[Below Decks #1]] 

[[Below Decks #3]]</tw-passagedata><tw-passagedata pid="579" name="Below Decks #3" tags="" position="4836,431" size="100,100">(display: &quot;Explore Derelict&quot;)

[[Above Decks #3]] 

[[Below Decks #2]]</tw-passagedata><tw-passagedata pid="580" name="Explore the Derelict Dreadnought" tags="" position="4472,423" size="100,100">(set: _chambers to (shuffled:
&quot;Above Decks #1&quot;
,&quot;Above Decks #2&quot;
,&quot;Above Decks #3&quot;
,&quot;Below Decks #1&quot;
,&quot;Below Decks #2&quot;
,&quot;Below Decks #3&quot;))
(set: $derelictLevel to _chambers&#39;s (a: 1, 2, 3))
(set: $derelictIndex to 1)
(set: _temp to $derelictLevel&#39;s 3rd)(goto: _temp)</tw-passagedata><tw-passagedata pid="581" name="Explore Derelict" tags="" position="4718,235" size="100,100">(if: $derelictLevel contains (passage:)&#39;s name)[
(if: (passage:)&#39;s name is $derelictLevel&#39;s ($derelictIndex))[
(if: $derelictIndex is 1)[You find the key.  Now, find the safe and open it!]
(else-if: $derelictIndex is 2)[You find the safe.  You insert the key and take the treasure.
(set: $arg to (random: 10, 50))(display: &quot;UpdateRiftTreasure&quot;)
Now, find the exit and get out of here!]
(else-if: $derelictIndex is 3)[You and your crew bucket brigade the treasure through the porthole into your ship.  You wrap it up and kick off, letting the Derelict drift into the Rift Sea.

[[Next Journey]]]
(set: $derelictIndex to it + 1)
](else:)
[(if: (passage:)&#39;s name is $derelictLevel&#39;s 1st)[This is where you found the key.
]
(else-if: (passage:)&#39;s name is $derelictLevel&#39;s 2nd)[You see a safe.  A key would open it.

(if: $inventory contains &quot;Skeleton Key&quot;)[
Your Skeleton Key makes short work of the safe&#39;s lock.(set: $derelictIndex to 3)
(set: $arg to (random: 0, 50))(display: &quot;UpdateRiftTreasure&quot;)
Now, find the exit and get out of here!
]
]
(if: (passage:)&#39;s name is $derelictLevel&#39;s 3rd)[
You&#39;re at the exit.  You could just leave.

[[Next Journey]] 
]

(if: (passage:)&#39;s name is $derelictLevel&#39;s 4th)[
(if: (random: 0, 3) is 0)[(goto: &quot;Monster Attack&quot;)
]
]]

](else:)[
Nowhere in the grinding gears or vessels of exotic fuels are any of the components you need.
]</tw-passagedata><tw-passagedata pid="582" name="Explore Ancient Tombs" tags="" position="4713,1143" size="100,100">You and your crew stride up to the gate of the most impressive tomb and crack it open.  The glint of gold in the light from the Rift sparkles more beautifully than anything you&#39;ve ever seen before.
|output&gt;[]
(set: $EATdepth to 0)(set: $EATdeck to (shuffled: 1,2,2,3,3,3,4,4,4,4,5,5,5,5,5))(set: $EATdiscard to (ds:))
(link-repeat: &quot;Keep Exploring&quot;)[(append:?output)[(set: $EATdepth to it + 1)(set: _value to $EATdeck&#39;s ($EATdepth))(if: $EATdiscard contains _value)[(if: _value is 2)[A section of the ceiling comes crashing down! (set: $deathReason to &quot;Your poor brains were jellified by shoddy roofing materials.&quot;)(set: $arg to (random: 1, 2))(display: &quot;TakeDamage&quot;)
]
(if: _value is 3)[You found another vault key! (if: $EATdiscard contains 1)[(display: &quot;Open Ancient Tomb Vault&quot;)
]]
(if: _value is 4)[Blow-dart traps that had not yet claimed victims are launched and strike your crew!
(set: $arg to -(random: 1,3))(display: &quot;UpdateRiftCrew&quot;)]
(if: _value is 5)[You find some loose treasure.
(set: $arg to (random: 1, 5))(display: &quot;UpdateRiftTreasure&quot;)
]]
(else:)
[(if: _value is 1)[The vault is where all of the //real// treasure is kept.  It looks like you need some kind of key...
(if: $EATdiscard contains 3 or $inventory contains &quot;SkeletonKey&quot;)[(display: &quot;Open Ancient Tomb Vault&quot;)]]
(if: _value is 2)[You notice that the ceiling sections are getting loose.  If you see one more loose section, it will probably be your last.]

(if: _value is 3)[
You find a bit of some kind of gear.  It must be the key to the vault!
]
(if: _value is 4)[You notice some empty blow-dart traps near the entrance.  You&#39;re about a quarter of the way through the traps.]
(if: _value is 5)[You find a small pile of treasure.
(set: $arg to (random: 10, 15))(display: &quot;UpdateRiftTreasure&quot;)
]
(set: $EATdiscard to it + (ds: _value))
]]]

[[Abandon the Search-&gt;Next Journey]]</tw-passagedata><tw-passagedata pid="583" name="Open Ancient Tomb Vault" tags="" position="4833,1143" size="100,100">The vault swings open, groaning on its hinges.

(set: $arg to (random: 100, 250))(display: &quot;UpdateRiftTreasure&quot;)
(set: $arg to (random: 0,1))(display: &quot;UpdateRiftCommand&quot;)


[[Next Journey]]</tw-passagedata><tw-passagedata pid="584" name="Raid the Colonial Fort" tags="" position="5806,1280" size="100,100">{(set: $pirateAnger to 5)(set: $pirateHealth to 10)
(set: $crewAnger to 0)(set: $crewHealth to $riftCrew)
(set: $turnsResisted to 0)}

Crew: (live: )[$crewHealth] vs. Colonials: (live: )[$pirateHealth]
|input&gt;[(link-repeat: &quot;Fight!&quot;)[(replace:?output)[
{(set: $pirateAnger to it + 1)
(set: $turnsResisted to it + 1)
(set: $playerAttack to (random: 0, $riftCommand))
(set: $pirateAttack to (random: 0, $pirateHealth))}
(if: $playerAttack &gt; $pirateAttack )[
Your crew press the attack against the colonials!
&lt;b&gt;Colonial Damage + (print: $playerAttack - $pirateAttack)&lt;/b&gt;(set: $pirateHealth to it - ($playerAttack - $pirateAttack))
(if: $pirateHealth &lt;= 0)[You have defeated the colonials and pillage their loot!
(set: $arg to 100)(display: &quot;UpdateRiftTreasure&quot;)
(set: $arg to 30)(display: &quot;UpdateRiftSupplies&quot;)
[[A Fetching Ransom]]

[[Next Journey]] 
(replace:?input)[]
]
](else:)[
The colonials begin to overcome you!
&lt;b&gt;Crew Health - (print: $pirateAttack - $playerAttack)&lt;/b&gt;(set: $crewHealth to it - ($pirateAttack - $playerAttack))
(if: $crewHealth &lt;= 0)[(replace:?input)[]
[[Kidnapped!]] 

[[Death]]
]]]]

(link-reveal: &quot;Surrender!&quot;)[(replace:?input)[](replace:?output)[
(if: $turnsResisted &lt; 3)[(set: $crewAnger to it + 3 - $turnsResisted)]
[[Kidnapped!]] 

[[Set Adrift]] 

[[Death]]
]]]

|output&gt;[]</tw-passagedata><tw-passagedata pid="585" name="Mermaid Birth" tags="" position="5807,1532" size="100,100">Several members of your crew spontaneously erupt as the mer-babies in their abdomens abruptly mature.

(set: $arg to -(random: 3, 5))(display: &quot;UpdateRiftCrew&quot;)
(if: $riftCrew &gt; 0)[The remaining crew talks sense into the newly born mer-folk, and they decide to join you.
(set: $arg to (random: 5, 13))(display: &quot;UpdateRiftCrew&quot;)
]</tw-passagedata><tw-passagedata pid="586" name="Enter the Eye of the Rift" tags="" position="4013,1787" size="100,100">As you approach the Eye of the Rift, you realize that it is actually a mouth.
Various crewmembers shout commands that go unheard in the turgid dirge of waves rushing into the maw that opens like an eight-part squid beak.
Down, down, down you all go into a gulf that is greater and darker than Hell itself.
Long after your crew has been obliterated, the ship shattered and the sails torn, the remnant of wreckage you tied yourself to comes to rest on the shores of a beautiful tropical island with obsidian sand beaches.

Sunning themselves on the beach is a gentleman in a fine suit.  In one hand is a daiquiri.  In the other is a card that says

[[The Second Prestige]]</tw-passagedata><tw-passagedata pid="587" name="RandomTrashGyre" tags="" position="5297,842" size="100,100">{(display: &quot;Tick&quot;)(replace:?clock)[(display: &quot;RenderHeader&quot;)]
(set: _roll to (random: 0, $perception * 2))
(if: _roll is 0)[(either:&quot;You find some plastic wrap.&quot;, &quot;You find a box of rubber ducks.&quot;,&quot;Tons and tons of bullkelp.&quot;)]
(else-if: _roll is 1)[(either: &quot;You find an old coin.&quot;, &quot;You find a dainty bauble.&quot;,&quot;You find a small gemstone.&quot;)(set: _gold to (random: 1,5))
&lt;br/&gt;&lt;b&gt;Gold + _gold&lt;/b&gt;(set: $gold to it + _gold)]
(else-if: _roll is 2)[You find a shred of paper:
&lt;br/&gt;(display: &quot;Random Bulk Scroll&quot;) ]
(else-if: _roll &lt; 5)[You find a small piece of useful rubbish: (set: _reagent to (either: &quot;Amount of Ambergris&quot;, &quot;Rusted Key&quot;, &quot;Map Fragment&quot;))&lt;br/&gt;(set: $arg to _reagent)(display: &quot;GetItem&quot;)]
(else-if: _roll &lt; 7)[You find a valuable antique:
&lt;br/&gt;&lt;b&gt;Gold + 75&lt;b/&gt;(set: $gold to it + 75)]
(else:)[(if: $inventory contains &quot;Slow Clock&quot;)[You find a space where an object should be, but you&#39;ve already picked it up.](else:)[You find a Compass of Many Places.  It&#39;s badly sodden, but it appears to still be in working order.
(set: $arg to  &quot;Compass of Many Places&quot;)
(display: &quot;GetItem&quot;)]]}</tw-passagedata><tw-passagedata pid="588" name="Lower Depths" tags="tick" position="3698,5863" size="200,200">(display: &quot;Init Lower Depths&quot;)
The city below the city is both grim and artful. The albino, spooky, and the Undead live here.  They have chosen not to hide among the Abovedwellers but to develop a full society of their own within the light of reflected and stored moonlight in crystals.  Lighting their city entirely with magical moonlight crystals was chosen purely for aesthetic effect.  It&#39;s actually quite inefficient but stunningly beautiful.

(for: each _item, ...($neighborhood&#39;s locations))[(if: (history:) contains _item and (passage: _item)&#39;s tags contains &quot;bookmark&quot;)[(link-goto: _item)

]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="589" name="Init Lower Depths" tags="function" position="3741,5739" size="100,100">{(set: $environmentMaterials to (a: &quot;stone&quot;, &quot;brick&quot;, &quot;chalk&quot;, &quot;stalactite&quot;, &quot;stalagmite&quot;, &quot;crystal&quot;, &quot;earthen&quot;, &quot;marble&quot;))
(set: $environmentColors to (a: &quot;white&quot;, &quot;black&quot;, &quot;gray&quot;))
(set: $clothingMaterials to (a: &quot;fur&quot;, &quot;felt&quot;, &quot;linen&quot;, &quot;rag&quot;, &quot;metal plate&quot;, &quot;leather&quot;, &quot;wool&quot;))
(set: $clothingColors to (a: &quot;brown&quot;, &quot;black&quot;, &quot;gray&quot;, &quot;white&quot;, &quot;yellowed&quot;))
(set: $clothingTypes to (a: &quot;tabard&quot;,&quot;gown&quot;, &quot;shroud&quot;, &quot;loincloth&quot;, &quot;girdle&quot;, &quot;three-piece suit&quot;, &quot;robe&quot;))
(set: $adornmentMaterials to (a: &quot;bone&quot;, &quot;ivory&quot;, &quot;copper&quot;, &quot;clay&quot;, &quot;gold&quot;, &quot;silver&quot;, &quot;obsidian&quot;, &quot;iron&quot;, &quot;tin&quot;, &quot;lead&quot;))
(set: $adornmentTypes to (a: &quot;plate&quot;, &quot;plug&quot;, &quot;ring&quot;, &quot;stud&quot;))
(set: $hairstyles to (a: &quot;a shaven scalp&quot;, &quot;a bald pate&quot;, &quot;a tonsure&quot;, &quot;an elegant braid&quot;, &quot;a lacquered headdress&quot;, &quot;a shaggy mane&quot;))

(set: $sizes to (a: &quot;grand&quot;, &quot;stout&quot;, &quot;scrawny&quot;, &quot;burly&quot;, &quot;rotund&quot;, &quot;gaunt&quot;, &quot;obese&quot;, &quot;muscular&quot;, &quot;sculpted&quot;, &quot;lithe&quot;, &quot;slender&quot;, &quot;bloated&quot;, &quot;warped&quot;))
(set: $genders to (a: &quot;man&quot;, &quot;woman&quot;, &quot;non&quot;, &quot;herm&quot;))
(set: $races to (a: &quot;human&quot;, &quot;shade&quot;, &quot;daemonkin&quot;, &quot;changeling&quot;, &quot;Undead&quot;, &quot;zombie&quot;, &quot;lich&quot;, &quot;goblin&quot;, &quot;troll&quot;))
(set: $skinColors to (a: &quot;black&quot;, &quot;tan&quot;, &quot;brown&quot;, &quot;blue&quot;, &quot;green&quot;, &quot;yellow&quot;, &quot;silver&quot;, &quot;red&quot;, &quot;gray&quot;))
(set: $skinTypes to (a: &quot;smooth&quot;, &quot;lightly furred&quot;, &quot;fur-covered&quot;, &quot;scaled&quot;, &quot;faceted&quot;, &quot;marbled&quot;, &quot;translucent&quot;, &quot;gently burning&quot;))
(set: $professions to (a: &quot;soldier&quot;, &quot;thief&quot;, &quot;ragpicker&quot;, &quot;sineater&quot;, &quot;cursekeeper&quot;, &quot;prostitute&quot;, &quot;courtesan&quot;, &quot;thug&quot;, &quot;student&quot;, &quot;alckymist&quot;, &quot;resurrectionist&quot;, &quot;soulbroker&quot;))

(set: $neighborhood to 
(dm: &quot;name&quot;, &quot;Lower Depths&quot;,
&quot;tagname&quot;, &quot;lowerdepths&quot;,
	&quot;locations&quot;, (altered: _item via _item&#39;s name, ...(find: _item where _item&#39;s tags contains all of (a: &quot;lowerdepths&quot;, &quot;location&quot;), ...(passages:))),
&quot;contracts&quot;, (altered: _item via _item&#39;s name, ...(find: _item where _item&#39;s tags contains all of (a: &quot;lowerdepths&quot;, &quot;contract&quot;), ...(passages:))),
		&quot;events&quot;, (altered: _item via _item&#39;s name, ...(find: _item where _item&#39;s tags contains all of (a: &quot;lowerdepths&quot;, &quot;event&quot;), ...(passages:)))))}</tw-passagedata><tw-passagedata pid="590" name="Lower Depths Color" tags="" position="3585,5918" size="100,100">(either: &quot;The spooky and gloomy citizens of the True City Beneath The City.&quot;, &quot;Great crystal pillars loom overhead, diffusing the gloomy moonlight.&quot;, &quot;A few bright faces peer out at you from behind crowds of shambling Undead.&quot;, &quot;A shambler in front of you suddenly collapses Truly Dead.&quot;, &quot;When you first came to this place, you were as fresh as a babe.  Now, you feel like you fit in a little too well.&quot;)</tw-passagedata><tw-passagedata pid="591" name="Sanctum Nero" tags="lowerdepths location bookmark tick" position="3748,6066" size="100,100">The most precious artifact in the world is housed here, behind a garrison of wizards, soldiers, and daemons.


(set: _item to &quot;Aleph&quot;)(set: _cost to 1)(display: &quot;QuickBuy&quot;)

[[Begone!-&gt;Home Again]]</tw-passagedata><tw-passagedata pid="592" name="Godiva&#39;s Hearth" tags="location lowerdepths bookmark tick" position="3749,6176" size="100,100">Godiva, the proprietor is a large golden mask supported by a cloud of smoke approximating a human woman eight feet high and four feet wide.

They offer to tell your fortune in exchange for a small donation.

&quot;I can give you a choice of futures in exchange for an item of yours.  No, I won&#39;t tell you which item.&quot;

[[Buy A Fortune From Godiva]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="593" name="Buy A Fortune From Godiva" tags="" position="3857,6178" size="100,100">(set: _item to (either: ...$inventory))(display: &quot;LoseItem&quot;)
(set: _possibles to (find: _item where _item&#39;s tags contains &quot;contract&quot;, ...(passages:)))
(for: each _i, ...(shuffled: ..._possibles)&#39;s (range: 1, (min: _possibles&#39;s length, $cunning + $perception)))[
(link-goto: _i&#39;s name)
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="594" name="Fountain of Blood" tags="location lowerdepths tick" position="3750,6282" size="100,100">If you aren&#39;t the squeamish type, feel free to drink from yon spring of black blood, guaranteed to boost your life force.

(link-reveal: &quot;Let&#39;s Drink!&quot;)[
(set: $arg to 1)(display: &quot;GainHealth&quot;)
(if: (random: 0, 13) is 0)[Oops, you&#39;ve picked up a touch of vampirism.
(set: $arg to &quot;Vampir Krenk&quot;)(display: &quot;GetItem&quot;)]
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="595" name="Archives" tags="location bookmark lowerdepths tick" position="3751,6387" size="100,100">This place is both a library and a prison.
The creatures and books contained within are so contained, because they are too dangerous to be released.

So, naturally, you&#39;d like to know how to break in and get some really dangerous artifacts.

[[Enter the Archives]]

(if: (history:) contains any of (a: &quot;Read Practical Thievery: A Young Rogue&#39;s Primer&quot;))
[
[[Case the Archives]]
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="596" name="Enter the Archives" tags="" position="3876,6390" size="100,100">(set: _cost to 1500)
(for: each _item, &quot;Macro Caster&quot;, &quot;The Aleph&quot;, &quot;Gold Loom&quot;, &quot;Magisterium Head Office Calling Card&quot;, &quot;The Incredibly Secret Machine&#39;s User Manual&quot;, &quot;Patent Filing for Experimental Rift Ship&quot;)[
(display: &quot;QuickBuy&quot;)
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="597" name="Case the Archives" tags="tick" position="3994,6391" size="100,100">You find a (either: &quot;park bench&quot;, &quot;sausage vendor&quot;, &quot;obelisk&quot;) to casually wait around, observing the patterns of the workers, changing of the guards, etc.

// Feedback on guard patrols, etc. //

[[Case the Archives]] 

[[Enter the Archives]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="598" name="Encounter: Corpse Cart" tags="event lowerdepths" position="3655,4436" size="100,100">A creaking cart laden with diseased corpses rolls slowly by, pulled by a team of zombified corpses.

Do not touch the corpse cart, lest you risk a horrible infection.
|input&gt;[(link-reveal: &quot;Squeeze Past&quot;)[(replace:?input)[(if: (random: 0, $cunning + $perception) &gt; 2)[You manage to slip past between the wall and the cart without making contact with anything contagious.]
(else:)[Oh, gosh, you accidentally brushed up against a big, old diseased lump of dead flesh.
(set: $arg to &quot;Plague Marks&quot;)(display: &quot;GetItem&quot;)
]
[[Next Encounter]] ]]]
(link-reveal: &quot;Pick the Pockets of the Dead&quot;)[(replace:?input)[(if: (random: 0, $cunning + $perception) &gt; 4)[You delicately or luckily pick a piece of pocket dosh without contracting anything immediately unpleasant.
](else:)[Oh, gosh, you accidentally brushed up against a big, old diseased lump of dead flesh.
(set: $arg to &quot;Plague Marks&quot;)(display: &quot;GetItem&quot;)]
(display: &quot;An Embarassing Display&quot;)
(set: $arg to (random: 1, 3) * 15)(display: &quot;UpdateGold&quot;)
[[Next Encounter]] ]]</tw-passagedata><tw-passagedata pid="599" name="Lost Books" tags="location lowerdepths tick bookmark" position="3755,6495" size="100,100">The store is unnaturally cold and contains no visible staff.

(unless: $inventory contains &quot;Penny Dreadful&quot;)[A slim magazine lies on a dusty table, with a paper price tag attached by a length of string.
(set: _item to &quot;Penny Dreadful&quot;)(set: _cost to 150)(display: &quot;QuickBuy&quot;)]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="600" name="Ilgezin&#39;s Amusements" tags="location lowerdepths bookmark" position="3748,6611" size="100,100">(set: _cost to 150)
(for: each _item, &quot;Obsidian Lens&quot;, &quot;Stiletto&quot;)[
(display: &quot;QuickBuy&quot;)
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="601" name="Shade of Owl Feathers" tags="location lowerdepths" position="3753,6720" size="100,100">The Thieves Guild.  The Guild House is hidden to anyone but members of the Guild.  You can&#39;t become a member unless you can get to the head office of The Guild House.

[[Enter Shade of Owl Feathers]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="602" name="Enter Shade of Owl Feathers" tags="" position="3881,6715" size="100,100">A squinting rogue in a weathered cowl approaches you, apparently unarmed.

&quot;Can I help ye?&quot; they say.  Their one good eye appraises you with its blazing gaze.  &quot;Ah, a wizard.  You can&#39;t be both a wizard and a rogue, er, not //legally// in the sense of laws that you and I bother with, but...  it wouldn&#39;t hurt for you to do your homework...  know what options you have available.&quot;

(set: _cost to 150)
(for: each _item, &quot;Practical Thievery: A Young Rogue&#39;s Primer&quot;)[
(display: &quot;QuickBuy&quot;)
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="603" name="Dire Salon" tags="location bookmark lowerdepths" position="3754,6830" size="100,100">(if: $inventory contains any of (a: &quot;Vampire Krenk&quot;, &quot;Dire Salon Calling Card&quot;, &quot;Hell Money&quot;))[
The jet-black double doors swing wide open as you arrive, letting you pass into the ruddy light of the Dire Salon.  It is surprisingly warm and cozy.

[[Inside the Dire Salon]]
](else:)[
As you attempt to find the entrance, it appears to move before you arrive.
You never see it move, and the discreetly posted Undead bouncers mostly hide their bemusement at your plight.
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="604" name="Inside the Dire Salon" tags="" position="3880,6816" size="100,100">Within the pulsing walls of the Dire Salon are giant, transparent hearts.
Within the hearts are replicas of actual people from within The City.
Through sympathetic magic, you can speak to them as if they were really right there next to you.

In front of each heart is a small table with a little lamp and some light tea and snacks.  Sit down with the one you&#39;d like to chat.

(for: each _persona, ...(shuffled: ...(find: _i where _i&#39;s tags contains &quot;persona&quot;, ...(passages:)))&#39;s (range: 1,$perception))[
(link-goto: (either: &quot;Chat with &quot;, &quot;Speak to &quot;, &quot;Hold Palaver with &quot;)+ _persona&#39;s name, _persona&#39;s name)
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="605" name="Encounter: Local Personality" tags="event westfires easternfortress northharbor southquarry lowerdepths uppercastlerock" position="3650,4712" size="100,100">(set: _person to (shuffled:
...(find: 
_p where _p&#39;s tags contains all of (a: $neighborhood&#39;s tagname, &quot;persona&quot;)
, ...(passages:)))&#39;s 1st&#39;s name
)
You see _person walking towards you on the street.
(display:
_person
)

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="606" name="Bonepicker" tags="lowerdepths persona" position="3738,6955" size="100,100">Rag and bone man who cleans up the carcasses of Truly Dead off of the streets and pockets what little treasure they have.  

Will trade any 1 item for 1 random item (site unseen)</tw-passagedata><tw-passagedata pid="607" name="Inamorata" tags="lowerdepths persona" position="3868,6954" size="100,100">In her home country, she was a princess or some such, but being a vampire, she was driven from her home.

White hair and skin.  Red eyes and lips.


Inamorata
Low-Level:
    It is safe to drink from the Fountain of Blood, but there&#39;s a chance of contracting Vampirism.
    If I knew of a cure for Vampirism, I wouldn&#39;t have had to move into this Neighborhood.
Mid-Level (Player is a Vampire):
    Bladed weapons are more likely to draw blood in a fight, and that blood will feed you.
    We vampires aren&#39;t vulnerable to sunlight or anything like that.  We don&#39;t have any weaknesses at all, relative to humans, and that is why they hate us.
High-Level (Player has cure for Vampirism):
    You could restore my humanity and my royal position with a single draught.
    I&#39;ll pay you [very large amount of money] for it.</tw-passagedata><tw-passagedata pid="608" name="Encounter With An Archdaemon" tags="" position="8095,411" size="100,100">The strange geometric shape shifts and reorients itself in front of you in some infernal calculus.  It pulses as word forms force themselves into your speech center.

(if: (history:) contains &quot;Sell a Daemon&quot;)[&lt;i&gt;I see you think nothing of selling our many children as slaves of your kind&lt;/i&gt;, the voice bellows in your head.  It feels like something warm is leaking from your ears. (set: $maxCunning to it - 1)(set: $cunning to $maxCunning)(set: $maxPerception to it - 1)(set: $perception to $maxPerception)](else:)[&lt;i&gt;Your hands are free from sin&lt;/i&gt;, the voice says in your head.  After a brief pause, it continues, &lt;i&gt;Inasmuch as I am not concerned with what you do to your own kind.&lt;/i&gt;]
&lt;i&gt;Regardless, I shall not harm you this day.&lt;/i&gt;</tw-passagedata><tw-passagedata pid="609" name="Encounter With An Archdaemon 2" tags="" position="8097,522" size="100,100">The strange geometric shape shifts and reorients itself in front of you in some infernal calculus.  It pulses as word forms force themselves into your speech center.

(if: (history:) contains &quot;Sell a Daemon&quot;)[&lt;i&gt;I see you think nothing of selling our many children as slaves of your kind&lt;/i&gt;, the voice bellows in your head.  It feels like something warm is leaking from your ears. (set: $maxCunning to it - 1)(set: $cunning to $maxCunning)(set: $maxPerception to it - 1)(set: $perception to $maxPerception)](else:)[&lt;i&gt;Your hands are free from sin&lt;/i&gt;, the voice says in your head.  After a brief pause, it continues, &lt;i&gt;Inasmuch as I am not concerned with what you do to your own kind.&lt;/i&gt;]
&lt;i&gt;Regardless, I shall not harm you this day.&lt;/i&gt;</tw-passagedata><tw-passagedata pid="610" name="Magistratis Magisterium" tags="" position="8110,802" size="100,100">You are before the magistrate of the council of elders that presides over the magicians, wizards, Undead, and arcane in the whole of the empire.
(if: (history:) contains &quot;Say Hallo to the Semi-Legal Wards Broker&quot;)[&quot;You purchase black market Damage Wards instead of through imperially-approved Reliquariums?&quot;]</tw-passagedata><tw-passagedata pid="611" name="Rattlecart the Tinker" tags="northharbor location westfires easternfortress southquarry lowerdepths tick" position="4841,2224" size="100,100">Random, semilegal items sold by a mobile heap of trinkets, knickknacks, wagon wheels, and presumably an actual person as wiry, grey arms do reach out with items for sale and to receive payment, although not always the stereotypical number we associate with humanoids.

(if: visits % 2 is 1)[
{(set: $marketplace to (shuffled: &quot;Damage Ward&quot;, &quot;Noble Cowl&quot;, &quot;Mystery Draught&quot;, &quot;Lodestone&quot;, &quot;Pocket Lint&quot;)&#39;s (a: 1, 2))}
(for: each _item, ...$marketplace)[(unless: $inventory contains _item)[
(set: _cost to 10 + (random: 0, 6) * 5)(display: &quot;QuickBuy&quot;)
]]
(unless: $marketplace&#39;s length &gt;= 1)[Oh, I&#39;ve got something around here you might like.  Hold on, hold on!
[[Rattlecart the Tinker]] 
]](else:)[They&#39;ve nothing of interest for you today.]

(display: &quot;NavOptions&quot;)
(display: &quot;Tick&quot;)</tw-passagedata><tw-passagedata pid="612" name="EncounterRewind1or2" tags="" position="3658,3848" size="100,100">(set: $encounterIndex to it - (random: 1, 2))
(goto: &quot;Encounter&quot;)</tw-passagedata><tw-passagedata pid="613" name="Encounter Select Random Daemon Encounter" tags="" position="4117,3475" size="100,100">(goto: (either: &quot;Encounter: Solar Spark&quot;, &quot;Encounter: Fire Ghost&quot;, &quot;Encounter: Living Shadow&quot;, &quot;Encounter: Rattle Bones&quot;))</tw-passagedata><tw-passagedata pid="614" name="Encounter: Wizard Duel" tags="" position="3779,3969" size="100,100">(set: $enemyHealth to 5)(set: $enemyType to &quot;Wizard&quot;)(set: $enemyElementType to (either: &quot;Shadow&quot;, &quot;Fire&quot;, &quot;Bone&quot;, &quot;Holy&quot;, &quot;Stone&quot;, &quot;Water&quot;, &quot;Air&quot;, &quot;Poison&quot;, &quot;Curse&quot;, &quot;Rift&quot;))
Your opponent is another wizard for hire, a $enemyElementType mage.  You will fight until one of you succumbs.  The loser&#39;s fate is then up to the winner&#39;s discretion.


[[Wizard Duel: Grant Mercy]]
[[Wizard Duel: Finish Them]]
[[Wizard Duel: Beg for Mercy]]
[[Wizard Duel: Succumb]]</tw-passagedata><tw-passagedata pid="615" name="The Wandering Market" tags="location northharbor westfires easternfortress southquarry lowerdepths uppercastlerock" position="6668,4225" size="100,100">(display: &quot;Tick&quot;)
This street-long phenomena crawls through the City like a wyrm.  The shops available at The Wandering Market appear spontaneously in the place of the original buildings. The shopowners are not locals, and the shops sell items no one else sells.  As a new segment of The Wandering Market appears, a previous segment disappers, leaving behind the old shop and the old owner who has no recollection of the minutes spent &quot;away&quot;.

You must make your choice quickly:

(for: each _item, ...(subarray: (shuffled: &quot;Esso&#39;s Fine Goods&quot;,
&quot;Inglam &amp; Co, LLC etc.&quot;,
&quot;Forbidden Texts&quot;,
&quot;Nven&#39;s Primordial Essence Outlet&quot;,
&quot;Hilorco&#39;s Potionarium&quot;), 1, 3))[
(link-goto: _item)]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="616" name="Trigger Enchantment" tags="" position="4260,4485" size="100,100">You stumble across the tight web of an enchantment!  It whips up around you with a thousand thousand fine threads, threatening to slice you into as many ribbons.

(set: $arg to 3)(set: $deathReason to &quot;You stumble across the tight web of an enchantment!  It whips up around you with a thousand thousand fine threads, threatening to slice you into as many ribbons.

Your corrupt, human flesh is lashed by razor-wire fine strands of arcane energy that cannot be stopped by your mortal armor.

It&#39;s all too much.  You slump to the ground in a ragged, red mass.&quot;)(display: &quot;TakeDamage&quot;)

You survive the blast with blood to spare.  Next time, you might lose an eye, my good waif.

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="617" name="Encounter: Dropped Purse" tags="" position="3658,3740" size="100,100">A gentlecreature has dropped their coin purse on the ground.
|input&gt;[(link-reveal: &quot;Take the Coin Purse&quot;)[(replace:?input)[&quot;Take the Coin Purse&quot;](replace:?output)[(if: $cunning + $perception &gt; (random: 2, 7))[You deftly pocket the purse with none the wiser. (set: $gold to it + 10 * (random: 1, 10))](else:)[You are caught trying to pocket the purse and must scarper! (display: &quot;An Embarassing Display&quot;)]

[[Next Encounter]]]]
(link-reveal: &quot;Return the Coin Purse&quot;)[(replace:?input)[&quot;Return the Coin Purse&quot;](replace:?output)[You pick up the purse (if: $reputation + $perception &gt; (random: 0, 6))[and hand it to a grateful minor noble who rewards you with accolades and lucre. (set: $gold to it + 10)(set: $arg to 1)(display: &quot;UpdateReputation&quot;)](else:)[but they mistakenly believe that you are trying to steal the purse and chase you through the streets.  (display: &quot;An Embarassing Display&quot;)]

[[Next Encounter]]]]
(link-reveal: &quot;Leave the Coin Purse&quot;)[(replace:?input)[&quot;Leave the Coin Purse&quot;](replace:?output)[You studiously avoid making eye contact with anyone as you walk away from the purse.

[[Next Encounter]]]]]
|output&gt;[]</tw-passagedata><tw-passagedata pid="618" name="Esso&#39;s Fine Goods" tags="" position="6788,4338" size="100,100">A mekkannin woman composed of gold, brass, and ruby sells mechanisms of her own design.  (if: $inventory contains &quot;Ward Press&quot;)[You can personally attest to her skill, but you already have everything she has of interest to your particular domain.](else:)[She has devices of incredible complexity, but only one can you comprehend its purpose.]

(set: _item to &quot;Ward Press&quot;)(set: _cost to 200)(display: &quot;QuickBuy&quot;)

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="619" name="Inglam &amp; Co, LLC etc." tags="" position="6789,4453" size="100,100">An enchantment of such complexity that it became self-aware, it is naturally a Darwinian Capitalist.  That means &quot;It sells things&quot;.  (if: $inventory contains &quot;Silent Ansible&quot;)[It decided to sell you the Silent Ansible as the most perfect thing you could ever own.  No returns; no refunds.](else:)[It uses a highly advanced algorithm to decide which item it will sell to which person.  It never changes its mind about the correctness of its decision.  That means &quot;No refunds.&quot;]

(set: _item to &quot;Silent Ansible&quot;)(set: _cost to 1337)(display: &quot;QuickBuy&quot;)

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="620" name="Forbidden Texts" tags="" position="6783,4221" size="100,100">A strange, little creature burrows its way out of an ancient tome and offers you his wares.  (if: $inventory contains &quot;Trap Book&quot;)[It has nothing of value to offer you.](else:)[Only one book, off in the corner, is unravaged by this libriovore.]

(set: _item to &quot;Trap Book&quot;)(set: _cost to 150)(display: &quot;QuickBuy&quot;)

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="621" name="Nven&#39;s Primordial Essence Outlet" tags="tick" position="6793,4569" size="100,100">Nven offers you a bowl full of raw primordial essence.  It is a repellant but effective way to rejuvenate your body after enduring the rigors of your trade (e.g. being stabbed, burned, electrocuted, cursed, etc.).
(set: _cost to 15)
(if: $health &gt; $maxHealth + 2)[You&#39;re completely stuffed and don&#39;t think you could have another bite of...  whatever that is.](else:)[
(link-reveal: &quot;Buy a Bowl&quot;)[
(if: $gold &lt; _cost)[Nven hands you a bowl for free.  Clearly, you need the money more than he does.
You quaff the essense and immediately feel it stitch your meat and bones back together.
(set: $arg to 1)(display: &quot;UpdateHealth&quot;)](else:)[You quaff the essense and immediately feel it stitch your meat and bones back together.
(set: $arg to 1)(display: &quot;UpdateHealth&quot;)
(set: $arg to -(_cost))(display: &quot;UpdateGold&quot;)]
]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="622" name="Hilorco&#39;s Potionarium" tags="" position="6896,4222" size="100,100">A purple djinn sells various potions, but they aren&#39;t very organized.  Mostly, you buy directly from the bins of random bottles and pots.
(if: visits % 2 is 1)[
(set: _threshold to 8)
(for: each _item, ...(shuffled: &quot;Mystery Draught&quot;,
&quot;Cunning Draught&quot;,
&quot;Stimulating Draught&quot;,
&quot;Healing Draught&quot;,
&quot;Poison Flask&quot;,
&quot;Sleeping Phial&quot;,
&quot;Love Potion&quot;))[(if: (random: 0, 10) &lt; _threshold)[
(set: _cost to 10 + (random: 0,5) * 5)(display: &quot;QuickBuy&quot;)](set: _threshold to it / 2)]](else:)[Now that you&#39;ve made your purchase, they hastily wave you away.]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="623" name="Encounter: Assassin" tags="event easternfortress uppercastlerock westfires lowerdepths" position="3774,4090" size="100,100">{(set: $enemyHealth to 3)(set: $enemyType to &quot;Assassin&quot;)(set: $enemyElementType to (either: &quot;Mortal&quot;, &quot;Shadow&quot;, &quot;Poison&quot;))
(set: $fightPattern to (a:&quot;Strike&quot;,&quot;Strike&quot;,(either: &quot;Strike&quot;, &quot;Throw&quot;),&quot;Rest&quot;))
(set: $fightIndex to 1)
(set: $deathReason to &quot;You were garrotted in a back alley by a professional killer.&quot;)
}You see a (either: &quot;cloaked&quot;, &quot;shadowy&quot;, &quot;zealous&quot;) (either: &quot;strangler&quot;, &quot;assassin&quot;, &quot;strongarm&quot;) with their weapon levelled at you.
They demand your life.

|output&gt;[]

|input&gt;[(display: &quot;Fight&quot;)]

(event: when $enemyHealth &lt;= 0)[ (replace:?input)[ [[Next Encounter]] ]]</tw-passagedata><tw-passagedata pid="624" name="Suspiciously Cheap Meat Pies" tags="location westfires northharbor southquarry tick" position="4127,2428" size="100,100">Depending on how fresh the pies are, and how recently the protein was slain, largely determines whether the pie will be hot and wholesome or bordering on lethal.

(either: &quot;On the cutting board is a mass of&quot;, &quot;In the gutter next to the pop-up shop is&quot;, &quot;The garbage bin is stuffed to the brim with&quot;) (either: &quot;blood&quot;, &quot;bones&quot;, &quot;tripe&quot;) and (either: &quot;feathers&quot;, &quot;blubber&quot;, &quot;tentacles&quot;).

&quot;10 coins a pie, love,&quot; sez the vendor.
(set: _cost to 10)
(if: _cost &gt;= 10)[
(link-reveal: &quot;Buy A Pie&quot;)[
(set: $arg to -(_cost))(display: &quot;UpdateGold&quot;)
(if: $ticks % 32 is 0)[
You don&#39;t feel very well at all. (set: $deathReason to &quot;You have reason to believe that you were devoured by worms from the inside out.&quot;)
(set: $arg to 2)(display: &quot;TakeDamage&quot;)
](else:)[
Hot gravy and mysterious lumps make this pie an especial treat.
(if: $health &lt;= $maxHealth)[(set: $arg to 1)(display: &quot;GainHealth&quot;)](else:)[Oh, but you&#39;re far too full to indulge.]
]]](else:)[&quot;Sorry, love, no gold, no pies.&quot;]
(display: &quot;UpdateClock&quot;)
(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="625" name="Buy a Cup of Coffee" tags="tick" position="5203,5246" size="100,100">You sip gingerly at the coffee while eavesdropping on fevered courtesans.

(display: (either: &quot;Baseless Rumors&quot;, &quot;Interesting Rumors&quot;))
(if: $perception &lt;= $maxPerception)[(set: $arg to 1)]
(else:)[(set: $arg to (random: 0, 1))](display: &quot;UpdatePerception&quot;)
(set: $arg to (dm: &quot;delay&quot;, 13, &quot;event&quot;, &quot;Caffeine Wears Off&quot;))(display: &quot;Schedule Event&quot;)

(if: $perception &lt; 9)[

[[Buy a Cup of Coffee]] 

(display: &quot;NavOptions&quot;)]
(else:)
[
You pass out from the toxic amount of caffeine in your system.

(set: $perception to 1)
[[Home Again]] 
]</tw-passagedata><tw-passagedata pid="626" name="Some Careers" tags="" position="3393,3536" size="100,100">Death Seeker
Lizard Trainer
Bridge Troll
Trader of Fine Spices
Minion
Test Dummy
Butter Churner
Grave Robber
Blood Salesman
Horse-mounted Police
Professional Gambler
Evil Clone
Food Photographer
Animal Handler
Art Theft Coordinator
Unpaid Intern
Paranormal Detective
Wig Model
Battle Orc
Professional Mourner
Competitive Eater
Lute Player
Insurance Agent
Forest Witch
Ghost Therapist
Crafter of Fine Talismans
Soul Reaper
Drug Dealer
Singer
Bird Salesman
Cult Leader
Sad Clown
Animal Breeder
Pickle Artisan
Human Scarecrow
Capitalist Viking
Voodoo Priestess
Sentient Animal
Sentient Animal Groomer
Fortune Cookie Writer
Werewolf
Snail Expert
Time Wizard
Failed Artist
Hunger Artist
Construction Worker</tw-passagedata><tw-passagedata pid="627" name="Use Aleph" tags="tick" position="4164,5721" size="100,100">(link-goto: &quot;Random Point in My History&quot;, (shuffled: ...(history:))&#39;s 1st)

(link-goto: &quot;Random Point Anywhere In Time or Space&quot;, (shuffled: ...(altered: _i via _i&#39;s name, ...(find: _location where (passage: _location&#39;s name)&#39;s tags contains &quot;location&quot;, ...(passages:))))&#39;s 1st)

(if: $inventory contains &quot;Silent Ansible&quot;)[
(set: _possibleLocations to (find: _location where (passage: _location&#39;s name)&#39;s tags contains &quot;location&quot;, ...(passages:)))
(for: each _item, ...((shuffled: 
...(altered: _i via _i&#39;s name, ...(_possibleLocations&#39;s (range: 1, (min: _possibleLocations&#39;s length, $cunning)))))))[
(link-goto: _item)]
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="628" name="Hansom Cab" tags="location westfires northharbor easternfortress southquarry tick" position="4728,2437" size="100,100">(if: $gold &gt; 25)[
For the price of 25 gold, you could take a trip to any of the other neighborhoods.
             [[North Harbor]] 
[[West Fires]]               [[Eastern Fortress]] 
            [[South Quarry]] 
](else:)[
You take a step back as a hansom cab speeds by from one of the other neighborhoods.
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="629" name="Wizard Shuffle" tags="" position="3888,3969" size="100,100">{(set: _options to (shuffled: ...((a: &quot;Block&quot;, &quot;Throw&quot;, &quot;Strike&quot;) + (altered: _i via &quot;Release &quot; + _i, ...$daemons)))&#39;s (range: 1, $cunning))
(for: each _i, ..._options)[(set: _i2 to _i)&lt;br/&gt;&lt;br/&gt;
(link-reveal: _i)[(replace:?output)[(display: _i2)](replace:?input)[
(if: $enemyHealth &lt;= 0)[(replace:?input)[You&#39;ve defeated your enemy!(set: $deathReason to &quot;&quot;)]](else:)[Your enemy still lives.
{(if: $fightPattern&#39;s ($fightIndex) is &quot;Summon&quot;)[
(set: $encounterIndex to it - 1)(if: $encounterIndex &lt;= 0)[(set: $encounterIndex to 1)(goto: &quot;Encounter Select Random Daemon Encounter&quot;)
]]}
(display: &quot;Wizard Shuffle&quot;)]]]
]
}</tw-passagedata><tw-passagedata pid="630" name="Rotator Puzzle" tags="" position="9470,3159" size="100,100">(set: $dialLimit to (random: 1, 10))
(set: $dialValue to (shuffled: ...(range: 0, $dialLimit)))
|input&gt;[]
(replace:?input)[(display: &quot;Rotator Input&quot;)]</tw-passagedata><tw-passagedata pid="631" name="Rotator Input" tags="" position="9590,3194" size="100,100">(for: each _i, ...(range: 1, $dialValue&#39;s length))[(set: _temp to _i)(link-reveal: (str: $dialValue&#39;s (_temp)))[

(set: _nextIndex to (_temp - 1 + $dialValue&#39;s (_temp)) % $dialValue&#39;s length + 1)
(set: _swap to ($dialValue&#39;s (_nextIndex)))
(set: $dialValue&#39;s (_nextIndex) to ($dialValue&#39;s (_temp)))
(set: $dialValue&#39;s (_temp) to _swap)

(replace:?input)[(display: &quot;Rotator Input&quot;)(display: &quot;Rotator Puzzle Unlocked?&quot;)]] |- ]</tw-passagedata><tw-passagedata pid="632" name="Rotator Puzzle Unlocked?" tags="" position="9710,3195" size="100,100">(if: (range: 0, $dialLimit) matches $dialValue)[
You have unlocked the dial!
]</tw-passagedata><tw-passagedata pid="633" name="Card Game" tags="" position="4824,7410" size="100,100">{(set: $deck to (shuffled: &quot;A 1&quot;, &quot;B 1&quot;, &quot;A 2&quot;, &quot;B 2&quot;, &quot;A 3&quot;,&quot;B 3&quot;,&quot;A 4&quot;,&quot;B 4&quot;,&quot;A 5&quot;,&quot;B 5&quot;,&quot;A 6&quot;,&quot;B 6&quot;,&quot;A 7&quot;,&quot;B 7&quot;,&quot;A 8&quot;,&quot;B 8&quot;,&quot;A 9&quot;,&quot;B 9&quot;,&quot;A 10&quot;,&quot;B 10&quot;,&quot;A 11&quot;,&quot;B 11&quot;,&quot;A 12&quot;,&quot;B 12&quot;,&quot;A 13&quot;,&quot;B 13&quot;))
(set: $deckIndex to 1)
(set: $playerHand to (a:))
(set: $opponentHand to (a:))
(for: each _i, ...(range: 1,5))[
(set: $playerHand to it + (a: $deck&#39;s ($deckIndex)))
(set: $deckIndex to it + 1)
(set: $opponentHand to it + (a: $deck&#39;s ($deckIndex)))
(set: $deckIndex to it + 1)]
(set: $potTotal to 0)
(set: $playerScore to 4)
(set: $opponentScore to 4)
}
|input&gt;[
(display: &quot;Display Hand&quot;)
]

|output&gt;[You -&gt; $playerScore -+- Total -&gt; $potTotal -+- Them -&gt; $opponentScore]</tw-passagedata><tw-passagedata pid="634" name="Play Card" tags="" position="4942,7406" size="100,100">{(link-reveal: (str: _item))[(replace:?output)[You play the _item,
(set: $playerHand to it - (a: _item))
(set: $potTotal to (it + (num: (words: _item)&#39;s 2nd)) % 31)
making the pot total $potTotal.
(if: $potTotal is 0)[(set: $opponentScore to it - 1)You score a hit on your opponent with 31. Total reset to 0.]
(if: $potTotal is 15)[(set: $opponentScore to it - 1)You score a hit on your opponent with 15.]
(if: $opponentScore &lt;= 0)[You have won by knocking your opponent down to 0 points.]
(set: _opponentChoice to (either: ...$opponentHand))
Opponent plays _opponentChoice,
(set: $opponentHand to it - (a: _opponentChoice))
(set: $potTotal to (it + (num: (words: _opponentChoice)&#39;s 2nd)) % 31)
making the pot total $potTotal.
(if: $potTotal is 0)[(set: $playerScore to it - 1)They score a hit on you with 31.  Total reset to 0.]
(if: $potTotal is 15)[(set: $playerScore to it - 1)They score a hit on you with 15]
(if: $deckIndex &lt; $deck&#39;s length)[
(set: $playerHand to it + (a: $deck&#39;s ($deckIndex)))
(set: $deckIndex to it + 1)
(set: $opponentHand to it + (a: $deck&#39;s ($deckIndex)))
(set: $deckIndex to it + 1)
](else:)[
The deck is empty.
]
&lt;br/&gt;You -&gt; $playerScore -+- Total -&gt; $potTotal -+- Them -&gt; $opponentScore
You can see your opponent&#39;s cards through their eyes with a touch of clairvoyance -&gt; $opponentHand

(replace:?input)[(display: &quot;Display Hand&quot;)]
]]
}</tw-passagedata><tw-passagedata pid="635" name="Display Hand" tags="" position="5064,7415" size="100,100">(for: each _item, ...$playerHand)[(display: &quot;Play Card&quot;)
]</tw-passagedata><tw-passagedata pid="636" name="Card Game 2" tags="" position="4797,7520" size="100,100">{(set: $deck to (shuffled: &quot;A 1&quot;, &quot;B 1&quot;, &quot;A 2&quot;, &quot;B 2&quot;, &quot;A 3&quot;,&quot;B 3&quot;,&quot;A 4&quot;,&quot;B 4&quot;,&quot;A 5&quot;,&quot;B 5&quot;,&quot;A 6&quot;,&quot;B 6&quot;,&quot;A 7&quot;,&quot;B 7&quot;,&quot;A 8&quot;,&quot;B 8&quot;,&quot;A 9&quot;,&quot;B 9&quot;,&quot;A 10&quot;,&quot;B 10&quot;,&quot;A 11&quot;,&quot;B 11&quot;,&quot;A 12&quot;,&quot;B 12&quot;,&quot;A 13&quot;,&quot;B 13&quot;, &quot;A 1&quot;, &quot;B 1&quot;, &quot;A 2&quot;, &quot;B 2&quot;, &quot;A 3&quot;,&quot;B 3&quot;,&quot;A 4&quot;,&quot;B 4&quot;,&quot;A 5&quot;,&quot;B 5&quot;,&quot;A 6&quot;,&quot;B 6&quot;,&quot;A 7&quot;,&quot;B 7&quot;,&quot;A 8&quot;,&quot;B 8&quot;,&quot;A 9&quot;,&quot;B 9&quot;,&quot;A 10&quot;,&quot;B 10&quot;,&quot;A 11&quot;,&quot;B 11&quot;,&quot;A 12&quot;,&quot;B 12&quot;,&quot;A 13&quot;,&quot;B 13&quot;))
(set: $deckIndex to 1)
(set: $playerHand to (a:))
(set: $opponentHand to (a:))
(for: each _i, ...(range: 1,5))[
(set: $playerHand to it + (a: $deck&#39;s ($deckIndex)))
(set: $deckIndex to it + 1)
(set: $opponentHand to it + (a: $deck&#39;s ($deckIndex)))
(set: $deckIndex to it + 1)]
(set: $potTotal to (dm: &quot;A&quot;, 0, &quot;B&quot;, 0))
(set: $playerScore to 4)
(set: $opponentScore to 4)
}
|input&gt;[
(display: &quot;Display Hand2&quot;)
]

|output&gt;[You -&gt; $playerScore -+- Total A -&gt; 0 -+- Total B -&gt; 0 -+- Them -&gt; $opponentScore]</tw-passagedata><tw-passagedata pid="637" name="Display Hand2" tags="" position="5059,7525" size="100,100">(for: each _item, ...$playerHand)[(display: &quot;Play Card2&quot;)
]</tw-passagedata><tw-passagedata pid="638" name="Play Card2" tags="" position="4935,7521" size="100,100">{(link-reveal: (str: _item))[(replace:?output)[You play the _item,
(set: $playerHand to it - (a: _item))
(set: _potKey to (words: _item)&#39;s 1st)
(set: $potTotal&#39;s (_potKey) to (it + (num: (words: _item)&#39;s 2nd)) % 31)
making the pot total _potKey (print: $potTotal&#39;s (_potKey)).
(if: $potTotal&#39;s (_potKey) is 0)[(set: $opponentScore to it - 1)You score a hit on your opponent with 31. Total reset to 0.]
(if: $potTotal&#39;s (_potKey) is 15)[(set: $opponentScore to it - 1)You score a hit on your opponent with 15.]
(if: $opponentScore &lt;= 0)[You have won by knocking your opponent down to 0 points.]
(set: _opponentChoice to (either: ...$opponentHand))
Opponent plays _opponentChoice,

(set: _potKey to (words: _opponentChoice)&#39;s 1st)
(set: $opponentHand to it - (a: _opponentChoice))
(set: $potTotal&#39;s (_potKey) to (it + (num: (words: _opponentChoice)&#39;s 2nd)) % 31)
making the pot total _potKey (print: $potTotal&#39;s (_potKey)).
(if: $potTotal&#39;s (_potKey) is 0)[(set: $playerScore to it - 1)They score a hit on you with 31.  Total reset to 0.]
(if: $potTotal&#39;s (_potKey) is 15)[(set: $playerScore to it - 1)They score a hit on you with 15]
(if: $deckIndex &lt; $deck&#39;s length)[
(set: $playerHand to it + (a: $deck&#39;s ($deckIndex)))
(set: $deckIndex to it + 1)
(set: $opponentHand to it + (a: $deck&#39;s ($deckIndex)))
(set: $deckIndex to it + 1)
](else:)[
The deck is empty.
]
&lt;br/&gt;You -&gt; $playerScore -+- Total A -&gt; (print: $potTotal&#39;s A) -+- Total B -&gt; (print: $potTotal&#39;s B) -+- Them -&gt; $opponentScore
You can see your opponent&#39;s cards through their eyes with a touch of clairvoyance -&gt; $opponentHand

(replace:?input)[(display: &quot;Display Hand2&quot;)]
]]
}</tw-passagedata><tw-passagedata pid="639" name="Dice Game #1" tags="" position="5273,722" size="100,100">Roll your die.  They roll theirs.
Highest roll wins.
If you&#39;re carrying a Lodestone and Loaded Dice, you will add 1 to the roll.
{
(set: $ante to 3)(set: $opponentGold to 100)
(set: $pot to 0)}
|input&gt;[(display: &quot;Roll Dice #1&quot;)]

Gold: (live:)[$gold]  Their Gold: (live:)[$opponentGold]
Ante: (live:)[$ante] Pot: (live:)[$pot]
Yours -&gt;  (live:)[$yourRoll]  -+-  (live:)[$theirRoll]  &lt;- Theirs

|output&gt;[  ]</tw-passagedata><tw-passagedata pid="640" name="Roll Dice #1" tags="" position="5393,722" size="100,100">{(link-reveal: &quot;Roll the Bones!&quot;)[(replace:?output)[
(if: $gold &gt;= $ante)[(set: $pot to it + $ante * 2)(set: $gold to it - $ante)(set: $opponentGold to it - $ante)]
(set: $yourRoll to (random: 1, 6))
(if: $inventory contains all of (ds: &quot;Lodestone&quot;, &quot;Loaded Dice&quot;))[(set: $yourRoll to it + 1)]
(set: $theirRoll to (random: 1, 6))
(if: $yourRoll &gt; $theirRoll)[
  (if: $yourRoll is 7)[You&#39;ve been caught for a cheat!  &lt;b&gt;Command - 1&lt;/b&gt;(set: $riftCommand to it - 1)]
  (else:)[You win! (set: $arg to $pot)(display: &quot;UpdateGold&quot;)](set: $pot to 0)]
(else-if: $yourRoll &lt; $theirRoll)[They&#39;ve won the roll off! &lt;b&gt;Opponent Gold + $pot&lt;/b&gt;(set: $opponentGold to it + $pot)(set: $pot to 0)]
(else:)[You&#39;ve both tied!  If you have the gold, you can roll off for the combined pot.]
(set: $ante to it * 2)
(if: $opponentGold &lt;= 0 or $opponentGold &lt; $ante)[&lt;br/&gt;Your opponent pushes themselves away from the table with an exhausted sigh.
(if: $pot &gt; 0)[(set: $arg to $pot)(display: &quot;UpdateGold&quot;)]]
(else-if: $gold &lt;= 0 or $gold &lt; $ante)[&lt;br/&gt;You reach for your purse, but it is empty.  You retire for the time being.]
(else:)[
(replace:?input)[(display: &quot;Roll Dice #1&quot;)]]
]]
(display: &quot;UpdateClock&quot;)}</tw-passagedata><tw-passagedata pid="641" name="Encounter: The Lovers" tags="encounter" position="418,3390" size="100,100">(set: _idealMatch to (either: true, false))
(if: (random: 0, $perception) &gt; 0)[
They are a (if: _idealMatch)[fine couple who would be happy together.](else:)[terrible fit and would be at each others throats for decades if they were to be married.]
]
(else:)[
They are a (if: not _idealMatch)[fine couple who would be happy together.](else:)[terrible fit and would be at each others throats for decades if they were to be married.]
]

(if: $inventory contains &quot;Love Potion&quot;)[
??? \todo: you can only use the Love Potion to get them to break up?
]</tw-passagedata><tw-passagedata pid="642" name="Some Languages" tags="" position="3379,3664" size="100,100">Sir Thomas More&#39;s Utopian Alphabet</tw-passagedata><tw-passagedata pid="643" name="Encounter: Deranged Mob" tags="event" position="3655,4547" size="100,100"></tw-passagedata><tw-passagedata pid="644" name="Wizard Duel: Grant Mercy" tags="" position="4137,3771" size="100,100">You grant them mercy.  People applaud you.  
(set: $arg to (random: 0, 1, 1, 2))(display: &quot;UpdateReputation&quot;)

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="645" name="Wizard Duel: Finish Them" tags="" position="4005,3766" size="100,100">You finish them off with (either: &quot;professional&quot;, &quot;sadistic&quot;, &quot;maniacal&quot;, &quot;uncomfortable&quot;) (either: &quot;ease&quot;, &quot;glee&quot;, &quot;fervor&quot;).


[[Next Encounter]]</tw-passagedata><tw-passagedata pid="646" name="Wizard Duel: Beg for Mercy" tags="" position="4002,3886" size="100,100">They have you at their mercy and could kill you for the slightest provocation.

You beg for mercy.
(display: &quot;An Embarassing Display&quot;)

They allow you to live with your life and your humiliation.

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="647" name="Wizard Duel: Succumb" tags="" position="4140,3885" size="100,100">(set: $deathReason to &quot;You slump to the greedy earth for it to drink your heart&#39;s blood.  Your opponent wrenched the very life out of you.&quot;)
(goto: &quot;Death&quot;)</tw-passagedata><tw-passagedata pid="648" name="Encounter: Corrupt Guard" tags="event" position="3556,4064" size="100,100">The guard displays the universal symbol of an upturned palm.
How much lucre are you going to place in that palm.
(cycling-link: bind _factorA, ...(altered: _i via (string: _i), ...(range: 0, 10))) x (cycling-link: bind _factorB, &quot;1&quot;, &quot;5&quot;, &quot;10&quot;, &quot;100&quot;)

(link-reveal: &quot;Bribe Attempt&quot;)[
(set: _desiredBribe to $danger * 10)
(set: _offeredBribe to (num: _factorA ) * (num: _factorB))
(if: _factorA is &quot;0&quot;)[
(if: (random: 1, 100) is 1)[They smile and let you through.
[[Next Encounter]] 
](else:)[They are furious at your lack of understanding.  But you haven&#39;t actually committed a crime, so they can&#39;t arrest you.

[[Away With You!-&gt;Cancel Contract]] 
]]
(else-if: _offeredBribe &gt;= _desiredBribe * 10)
[
The guard takes your money, lets you through, and then drops a cage trap on you.

[[Kafka Gaol]] 
](else-if: _offeredBribe &lt; _desiredBribe / 5)
[
The guard is furious at the shameful amount you&#39;ve offered and calls for backup.

[[Encounter: Guards]]
](else:)[
The guard is satisfied with the amount of lucre you&#39;ve given them.

[[Next Encounter]] 
]]</tw-passagedata><tw-passagedata pid="649" name="Encounter Calamity" tags="" position="1579,6086" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="650" name="Take a postcard" tags="" position="1097,6098" size="100,100">You take the postcard wedged into the door and leave.
(set $inventory to it + &quot;Suspicious Postcard&quot;)
[[Next Encounter]]</tw-passagedata><tw-passagedata pid="651" name="Encounter: Guardian Beast (Mechanical)" tags="" position="3908,4324" size="100,100">{(set: $enemyType to &quot;Guardian Beast (Mechanical)&quot;)
(set: $deathReason to &quot;You are ground to shreds of meat by the cruel beasts uncaring gears.&quot;)
(set: $enemyHealth to 5)
(set: $enemyElementType to &quot;mechanical&quot;)
(set: $enemyBribeType to &quot;None&quot;)
(set: $options to (a:))
(if: $rumors contains &quot;Maintenance Key (Works on Everything)&quot; and $inventory contains &quot;Maintenance Key&quot;)[(set: $options to it + (a: &quot;Deactivate Beast&quot;))
(display: &quot;Encounter Guardian&quot;)</tw-passagedata><tw-passagedata pid="652" name="Encounter Guardian" tags="" position="4021,4319" size="100,100">|output&gt;[]
|input&gt;[(display: &quot;Guardian Shuffle&quot;)]

(event: when $enemyHealth &lt;= 0)[ (replace:?input)[ [[Next Encounter]] ]]</tw-passagedata><tw-passagedata pid="653" name="Guardian Shuffle" tags="" position="4142,4329" size="100,100">(set: _weapons to (find: _item where (passage: _item)&#39;s tags contains any of (a: &quot;magic-weapon&quot;, &quot;weapon&quot;), ...$inventory))
(set: $options to $options + (altered: _weapon via &quot;Use &quot; + _weapon, ..._weapons))
(set: $options to $options + (altered: _item via &quot;Release &quot; + _item, ...$daemons))
(if: $options&#39;s length &lt;= 0)[]
(else-if: $options&#39;s length &gt; 1)[
(set: $options to (shuffled: ...$options))]
(else:)[]

(replace:?input)[(if: $options&#39;s length &gt; 0)[(for: each _i, ...(range: 1, (min: $cunning, $options&#39;s length)))[
(set: _item to ($options&#39;s (_i)))
(link-reveal: _item)[(replace:?output)[(display: _item)(if: (passage: _item)&#39;s tags contains &quot;weapon&quot;)[Striking out at the guardian&#39;s armored surface causes you to be injured in kind.(set: $deathReason to &quot;Striking out at the guardian&#39;s armored surface causes you to be injured in kind.  You overextended so much, you practically fed yourself into it like it was a woodchipper.&quot;)(set: $arg to 1)(display: &quot;TakeDamage&quot;)]
]]]

(link-reveal: &quot;Shuffle&quot;)[(replace:?output)[You are torn and brutalized by your foe as you prepare for another assault.(set: $arg to (either: 0,1, 1))(display: &quot;TakeDamage&quot;)(set: $options to (a:))(display: &quot;Guardian Shuffle&quot;)
]]](else:)[
[[Succumb-&gt;Death]] 
]]</tw-passagedata><tw-passagedata pid="654" name="Magisterium Local Office" tags="location westfires easternfortress northharbor southquarry uppercastlerock unlisted" position="4553,2940" size="100,100">If you go here, you must prove your innocence before you&#39;re allowed to leave.  It doesn&#39;t matter if they brought you here, or you happened to come here yourself.

The style is cribbed from Roman Architecture, distilled down into Brutalism, with a hint of displeasure at the existence of the possibility of dissent.  It is beautiful in the same way that a praying mantis is beautiful.

//iterated prisoner&#39;s dilemma//

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="655" name="Cannibal&#39;s Feast" tags="location" position="4035,6174" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="656" name="Encounter: A Friendly Goblin" tags="event" position="6615,6442" size="100,100">The goblin greets you with your tribes secret handshake and passes you
(set: _roll to (random: 0,3))(if: _roll &lt; 3)[(set: $arg to (random: 5, 25))$arg coins.
(display: &quot;UpdateGold&quot;)](else:)[(set: $arg to (either: &quot;Crypt Key&quot;, &quot;Stone Blood&quot;, &quot;Jar of Baby Teeth&quot;))(display: &quot;GainItem&quot;)]</tw-passagedata><tw-passagedata pid="657" name="Encounter: An Angry Goblin" tags="event" position="6738,6445" size="100,100">The goblin looks familiar to you.  Remember when you were temporarily a member of a tribe of goblins, and you wondered why no one ever tried to leave?

This might be why.

{(set: $enemyHealth to 3)(set: $enemyType to &quot;Goblin&quot;)(set: $enemyElementType to (either: &quot;mortal&quot;, &quot;shadow&quot;, &quot;poison&quot;))
(set: $fightPattern to (a:&quot;Strike&quot;,(either: &quot;Strike&quot;, &quot;Throw&quot;),&quot;Block&quot;))
(set: $fightIndex to 1)
(set: $deathReason to &quot;You were torn to shreds by a furious goblin.&quot;)
}They prepare to attack!

|output&gt;[]

|input&gt;[(display: &quot;Fight&quot;)]

(event: when $enemyHealth &lt;= 0)[ (replace:?input)[ [[Next Encounter]] ]]</tw-passagedata><tw-passagedata pid="658" name="Untitled Passage" tags="" position="6681,2114" size="100,100">kraalspace, n.  The highest level of space, the physical realm of space that is the lowest energy of the electromagnetic spectrum, used in the scientific study of color.

Usage: &quot;a black-and-white image taken by a quantum quantum laser just reaches the kraalspace of visible light.

chokkaboo, n. a simple, thick, heavy knit Japanese shirt made of cloth, with a pattern of five buttons hanging behind the arm

 noun.
knotlock
knotlock

    the knotted knot that locks up a garment, especially one used for sewing
    &quot;he made his knotlock on her sweater&quot;

 adjective.
abaricious
abaricious

    (of a product) adulterated, including many adulterated varieties
    &quot;abaricious names and photographs&quot;

 noun.
harpophlemium
harpophlemium

    a sporangic freshwater fish of the canary family that has reddish plates on a broad body with spines on the tips. It typically lives near lakes and canyons
    &quot;a collection of the most endangered harpophlemiums&quot;

 adjective.
sorvicious
sorvicious

    characterized by a sinner or wickedness
    &quot;the sorvicious creatures that pursued them&quot;

You see a wizard accidentally drop an artifact into a pile of garbage.  The value of the artifact scales from trivial to priceless.
You can dig through the garbage to try to find the artifact, but if anyone sees you, your reputation will suffer.
You might also trigger an attack by a Rattle Bones.

Construction on the tower halted.  Where they had expected more open sky was a smooth, metallic dome studded with brilliant gemstones.
&quot;Get me the biggest diamond drill bit we have and the collected works of Ted Chiang!&quot; the fore boss cried.

Your ship crashes against an invisible wall as subtle as a soap bubble and as unyielding as the will of SuperGod.  Where you encounter the wall, it appears gently curved, so that your vessel is gravely damaged but possibly not mortally.

Deep below the nests of the (now extinct) Balrogs, your team has reached a layer of impenetrable earth.  Unable to continue down, they spread out in all directions.  Suddenly, a hew and cry rise up from one of the branches.  More crew rush to that branch to help clear it out.  With stunning efficiency, they dig out a 100 x 100 meter room, 10 meters high around a giant vault door.  Within a very complex series of physical leaf springs and enchantments sits a device that is unmistakably a lock.

Deep within the Eastern Fortress, you are on the edge of what appears to be an endless Emptiness.  The elaborate network of buildings terminates all above and all below you in a fractal sponge.  But in front of you for as far as you can see is nothing.  Colorless, oppressive Emptiness.

The distant suburbs all look the same.  It&#39;s easy to get turned around.  By the time you manage to untangle the loop, you end up right back where you started from.</tw-passagedata><tw-passagedata pid="659" name="Encounter: Shortcut" tags="" position="3658,3501" size="100,100">You&#39;ve come to a fork.  One of these is faster than the other, but which one?!
{
(set: $correctPath to (random: 0, 1))
(if: $correctPath is 0)[
	(if: $perception &gt; $enchantmentHidden)[&lt;br/&gt;(link-reveal-goto: &quot;This Way!&quot;, &quot;Encounter&quot;)[(set: $encounterIndex to it + 2)]]
	(else:)[&lt;br/&gt;(link-reveal-goto: &quot;This Way?&quot;, &quot;Encounter&quot;)[(set: $encounterIndex to it + 2)]]
	[[&lt;br/&gt;No, This Way?-&gt;Next Encounter]] 
](else:)[ &lt;br/&gt;[[This Way?-&gt;Next Encounter]]
(if: $perception &gt; $enchantmentHidden)[&lt;br/&gt;(link-reveal-goto: &quot;No, This Way!&quot;, &quot;Encounter&quot;)[(set: $encounterIndex to it + 2)]]
	(else:)[&lt;br/&gt;(link-reveal-goto: &quot;No, This Way?&quot;, &quot;Encounter&quot;)[(set: $encounterIndex to it + 2)]]
]}</tw-passagedata><tw-passagedata pid="660" name="Alckymie Inventory" tags="" position="1335,1690" size="100,100">The alckymists and their suppliers trade in vast open sacks and pots of chemical components of various toxicities and inflammibilities.  It says much about their trade that the free mix of various powdered chemicals around open flames have resulted in as many legitimate breakthroughs as the solitary efforts of a thousand alckymists working in their labs.

(set: _cost to 150)(set: $marketplace to (a: &quot;Lump of Lead&quot;, &quot;Sack of Sulfur&quot;, &quot;Chunk of Chalk&quot;, &quot;Grain of Gold&quot;, &quot;Quaff of Quicksilver&quot;))(for: each _item, ...$marketplace)[(unless: $inventory contains _item)[
(display: &quot;QuickBuy&quot;)
]]</tw-passagedata><tw-passagedata pid="661" name="Display Random Market Color" tags="" position="4239,3121" size="100,100">(set: _dieroll to (random: 0, 2))(if: _dieroll is 0)[(display: &quot;Display Random Color Person&quot;) offering to sell a (either: &quot;live&quot;, &quot;roast&quot;, &quot;metallic&quot;) (either: &quot;homunculus&quot;, &quot;pixie&quot;, &quot;dragon egg&quot;) to a (display: &quot;Display Random Color Person&quot;)](else-if: _dieroll is 1)[(display: &quot;Display Random Color Person&quot;) is haggling with a (either: &quot;furious&quot;, &quot;stone-faced&quot;, &quot;laughing&quot;, &quot;bored&quot;) (display: &quot;Display Random Color Person&quot;)]
(else-if: _dieroll is 2)[(either: &quot;smiling&quot;, &quot;bored&quot;, &quot;dozing&quot;, &quot;aggressive&quot;) (display: &quot;Display Random Color Person&quot;) hawking their (either: &quot;wares&quot;, &quot;false idols&quot;, &quot;scrolls&quot;, &quot;fish and chips&quot;)]</tw-passagedata><tw-passagedata pid="662" name="Display Random Color Person" tags="" position="4126,3113" size="100,100">(either: &quot;lady&quot;, &quot;gentleman&quot;, &quot;creature&quot;) of (either: (either: &quot;great&quot;, &quot;small&quot;) + &quot; size&quot;, (either: &quot;dark&quot;, &quot;ruddy&quot;, &quot;pale&quot;, &quot;blue&quot;, &quot;translucent&quot;, &quot;scaly&quot;, &quot;tattooed&quot;) + &quot; skin&quot;) (either: &quot;wearing&quot;, &quot;with&quot;, &quot;in&quot;) a (display: &quot;Random Jewelry&quot;)</tw-passagedata><tw-passagedata pid="663" name="Display Random Client" tags="" position="4451,3118" size="100,100">(set: $generalType to (a: &quot;slim fellow in a cheap suit&quot;, &quot;fat cephalopod with a beaver hat&quot;, &quot;plain lady in a brown dress&quot;, &quot;a spiny brownie in mouse leathers&quot;))
(set: $characteristics to (a: &quot;extremely regrettable facial tattoos&quot;, &quot;the subtle tracework of surgery scars&quot;, &quot;more pride than teeth&quot;, &quot;a pronounced limp&quot;, &quot;a probably very illegal weapon clutched behind their back&quot;))</tw-passagedata><tw-passagedata pid="664" name="Random Jewelry" tags="" position="4558,3114" size="100,100">(set: _material to (a: &quot;copper&quot;, &quot;gold&quot;, &quot;silver&quot;, &quot;ash&quot;, &quot;iron&quot;, &quot;clay&quot;, &quot;hardwood&quot;, &quot;bone&quot;, &quot;antler&quot;))(set: _dieroll to (random: 0, 2))(if: _dieroll is 0)[(either: ..._material) (either: &quot;bracelet&quot;, &quot;anklet&quot;, &quot;armlet&quot;, &quot;torque&quot;, &quot;girdle&quot;)](else-if: _dieroll is 1)[(either: &quot;ear&quot;, &quot;nose&quot;, &quot;lip&quot;, &quot;cheek&quot;, &quot;septum&quot;, &quot;conch&quot;, &quot;horn&quot;) (either: &quot;stud&quot;, &quot;ring&quot;, &quot;plug&quot;, &quot;tusk&quot;, &quot;plate&quot;)](else-if: _dieroll is 2)[(either: &quot;simple&quot;, &quot;intricate&quot;, &quot;delicate&quot;, &quot;chunky&quot;) amulet made of (either: ..._material)]</tw-passagedata><tw-passagedata pid="665" name="Market Color" tags="" position="4350,3102" size="100,100">You see (set: _dieroll to (random: 0, 2))(if: _dieroll is 0)[(display: &quot;Display Random Color Person&quot;) offering to sell a (either: &quot;live&quot;, &quot;roast&quot;, &quot;metallic&quot;) (either: &quot;homunculus&quot;, &quot;pixie&quot;, &quot;dragon egg&quot;) to a (display: &quot;Display Random Color Person&quot;)](else-if: _dieroll is 1)[(display: &quot;Display Random Color Person&quot;) is haggling with a (either: &quot;furious&quot;, &quot;stone-faced&quot;, &quot;laughing&quot;, &quot;bored&quot;) (display: &quot;Display Random Color Person&quot;)]
(else-if: _dieroll is 2)[(either: &quot;smiling&quot;, &quot;bored&quot;, &quot;dozing&quot;, &quot;aggressive&quot;) (display: &quot;Display Random Color Person&quot;) hawking their (either: &quot;wares&quot;, &quot;false idols&quot;, &quot;scrolls&quot;, &quot;fish and chips&quot;)].</tw-passagedata><tw-passagedata pid="666" name="Night Circus" tags="lowerdepths location" position="3748,7067" size="100,100">[[Night Circus: Tattooed Gentlebeing]]

[[Night Circus: The Relatively Strong Person]]

[[Night Circus: Xyll, the Saccharomancer]]

[[Night Circus: Fire Clown]]

[[Night Circus: Royalty of Torture]]</tw-passagedata><tw-passagedata pid="667" name="Night Circus: Tattooed Gentlebeing" tags="" position="3448,7217" size="100,100">Tattooed Lady|Gentleman|Gentleperson is inscribed with 
    the works of Junji Ito | Zeen Chin | M.C. Escher | George Plimpton | Gustav Klimt
    Pi|Tau|e to many decimal places | Library of Congress numbers for the major works in Advanced Reason
        the density of the numerals themselves making a second pattern of mesmerising fractals
    detailed architectural diagrams of 
        Borges&#39;s Library
        The Tower of Babel
        The Archives</tw-passagedata><tw-passagedata pid="668" name="Night Circus: The Relatively Strong Person" tags="" position="3598,7217" size="100,100">Is just slightly stronger than the strongest person near them.
    Is an inch tall, and is able to lift 100 lbs, which for an organism at that scale is very impressive.</tw-passagedata><tw-passagedata pid="669" name="Night Circus: Xyll, the Saccharomancer" tags="" position="3748,7217" size="100,100">Inserts a random event into the scheduler, generally good, but potentially embarrassing.
    Reads your future in the cotton candy left behind after you take a bite.</tw-passagedata><tw-passagedata pid="670" name="Night Circus: Fire Clown" tags="" position="3898,7217" size="100,100">A being of destructive energy in the form of a man-like clown beast.  Significantly more terrifying than a default clown.</tw-passagedata><tw-passagedata pid="671" name="Night Circus: Royalty of Torture" tags="" position="4048,7217" size="100,100">This creature&#39;s art is in the intense torture of their physical form.
    rumor is that they secretly feel no pain
    rumor is that they secretly enjoy pain
    rumor is that they feel pain just like everybody else, they&#39;ve just trained themselves to withstand it
    rumor is that they actually feel pain more sensitively than normal creatures, and that is their true art.</tw-passagedata><tw-passagedata pid="672" name="North Harbor" tags="tick" position="3342,998" size="200,200">(display: &quot;Init North Harbor&quot;)
This neighborhood is at the edge of the Northern Rift.  Rift-ships gently bob at the edge of the Abyss.  No one offers contracts out in the open here.  If you want a job, you&#39;ll have to go the Riftrunner&#39;s Guild.
(for: each _item, ...($neighborhood&#39;s locations))[(if: (history:) contains _item and (passage: _item)&#39;s tags contains &quot;bookmark&quot;)[(link-goto: _item)

]]
(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="673" name="Init North Harbor" tags="function" position="3220.6666666666665,888.6666666666666" size="100,100">{(set: $environmentMaterials to (a: &quot;stone&quot;, &quot;driftwood&quot;, &quot;coral&quot;, &quot;siltblock&quot;, &quot;concrete&quot;, &quot;flagstone&quot;, &quot;cobble&quot;, &quot;log&quot;))
(set: $environmentColors to (a: &quot;white&quot;, &quot;blue&quot;, &quot;seafoam&quot;, &quot;gray&quot;))
(set: $clothingMaterials to (a: &quot;fur&quot;, &quot;sealskin&quot;, &quot;crabshell&quot;, &quot;leather&quot;, &quot;flannel&quot;))
(set: $clothingColors to (a: &quot;brown&quot;, &quot;black&quot;, &quot;foxred&quot;, &quot;gray&quot;, &quot;white&quot;, &quot;yellowed&quot;, &quot;tawny&quot;,&quot;tan&quot;,&quot;seableached&quot;))
(set: $clothingTypes to (a: &quot;overall&quot;, &quot;apron&quot;, &quot;snowsuit&quot;, &quot;sou-ester&quot;, &quot;coveralls&quot;, &quot;one-piece&quot;,&quot;great coat&quot;))
(set: $adornmentMaterials to (a: &quot;bone&quot;, &quot;shell&quot;, &quot;ivory&quot;, &quot;clay&quot;, &quot;gold&quot;, &quot;silver&quot;, &quot;amethyst&quot;, &quot;rusty iron&quot;, &quot;tin&quot;, &quot;coral&quot;))
(set: $adornmentTypes to (a: &quot;plate&quot;, &quot;plug&quot;, &quot;tusk&quot;, &quot;ring&quot;, &quot;stud&quot;))
(set: $hairstyles to (a: &quot;a shaven scalp&quot;, &quot;a bald pate&quot;, &quot;a long pony tail&quot;, &quot;long dreadlocks&quot;, &quot;short dreadlocks&quot;, &quot;a pathetic combover&quot;, &quot;a shaggy mane&quot;,&quot;a fur wig&quot;))

(set: $sizes to (a: &quot;grand&quot;, &quot;stout&quot;, &quot;scrawny&quot;, &quot;burly&quot;, &quot;rotund&quot;, &quot;gaunt&quot;, &quot;obese&quot;, &quot;muscular&quot;, &quot;sculpted&quot;))
(set: $genders to (a: &quot;man&quot;, &quot;woman&quot;, &quot;non&quot;, &quot;herm&quot;))
(set: $races to (a: &quot;human&quot;, &quot;nereid&quot;, &quot;daemonkin&quot;, &quot;changeling&quot;, &quot;selkie&quot;, &quot;merfolk&quot;))
(set: $skinColors to (a: &quot;black&quot;, &quot;tan&quot;, &quot;brown&quot;, &quot;red&quot;, &quot;gray&quot;))
(set: $skinTypes to (a: &quot;smooth&quot;, &quot;lightly furred&quot;, &quot;fur-covered&quot;, &quot;scaled&quot;))
(set: $professions to (a: &quot;soldier&quot;, &quot;riftrunner&quot;, &quot;ragpicker&quot;, &quot;stevedore&quot;, &quot;insurance agent&quot;, &quot;prostitute&quot;, &quot;thug&quot;, &quot;sailor&quot;, &quot;medic&quot;, &quot;machine repairman&quot;))
}
{(set: $neighborhood to 
(dm: &quot;name&quot;, &quot;North Harbor&quot;, 
&quot;tagname&quot;, &quot;northharbor&quot;,
	&quot;locations&quot;, (altered: _item via _item&#39;s name, ...(find: _item where _item&#39;s tags contains all of (a: &quot;northharbor&quot;, &quot;location&quot;), ...(passages:))),
&quot;contracts&quot;, (a:),
		&quot;events&quot;, (altered: _item via _item&#39;s name, ...(find: _item where _item&#39;s tags contains all of (a: &quot;northharbor&quot;, &quot;event&quot;), ...(passages:)))))}</tw-passagedata><tw-passagedata pid="674" name="Apothecarium" tags="northharbor bookmark location tick" position="3404,352" size="100,100">(if: $ticks % 13 &gt;8)[
You&#39;ve come at the wrong time of the day for alchemical ingredients.  All of the alchemists and artificers have gone home to get deliriously high on their own concoctions.

(unless: $inventory contains &quot;Tincture of Turmeric&quot;)
[
You find a nice tincture of turmeric on the ground where the stalls were.  Finders = Keepers.  QED.
(set: $inventory to it + (ds: &quot;Tincture of Turmeric&quot;))
]
](else:)[(display: &quot;Apothecarium Inventory&quot;)
]
(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="675" name="Apothecarium Inventory" tags="" position="3520,355" size="100,100">Potions, weird powders, unguents.

(set: _cost to 25)(set: $marketplace to (a: &quot;Cellar of Salt&quot;, &quot;Piece of Pitch&quot;, &quot;Tincture of Turmeric&quot;))(for: each _item, ...$marketplace)[(unless: $inventory contains _item)[
(display: &quot;QuickBuy&quot;)
]]</tw-passagedata><tw-passagedata pid="676" name="Down The Pub" tags="bookmark northharbor location tick" position="3393,686.6666666666666" size="100,100">(if: $reputation&#39;s publican &gt; 0)[Jonathon, the Publican, greets you with a beaming smile as you enter.  Ah! A paying customer!]
(else:)[The publican makes brief eye contact with you as you enter their establishment and then returns to polishing a glass with a threadbare but clean rag.]

[[Buy a Round from The Publican]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="677" name="Buy a Round from The Publican" tags="tick" position="3503.6666666666665,686.6666666666666" size="100,100">(if: $gold &lt; 5)[You don&#39;t have two coppers to rub together, so you shan&#39;t be having any beer at all.]
(else:)[You buy a draught of some weak, overpriced beer.  It&#39;s fine stuff, it&#39;s just not strong enough to get drunk off of.  The Publican is in the business of trading information, not quality quaff.  The sale of alcohol is merely a cover for sale of information.
(set: $arg to -5)(display: &quot;UpdateGold&quot;)(set: $reputation&#39;s publican to it + 1)
(either: &quot;The publican looks you in the eye and says&quot;, &quot;The publican mutters as they polish the bar with a cloth&quot;, &quot;The publican talks to a patron next to you&quot;), (if: $reputation&#39;s publican + $reputation&#39;s ($neighborhood&#39;s name) &gt; 11)[
(set: _roll to (random: 0, 6))
(if: _roll &gt; 3)[Got some useful places here in town:
(set: _locations to (find: _item where not ((history:) contains _item and (passage: _item)&#39;s tags contains &quot;bookmark&quot;) and (passage: _item)&#39;s tags contains &quot;location&quot;, ...($neighborhood&#39;s locations)))
(if: _locations&#39;s length &gt; 0)[
(if: _locations&#39;s length is 1)[(link-goto: _locations&#39;s 1st)]
(else:)[
(for: each _i, ...((shuffled: ..._locations)&#39;s (range: 1, (min: 3, (ceil: $perception/2)))))[
(link-goto: _i)&lt;br/&gt;&lt;br/&gt;
]]](else:)[No, I guess you&#39;d already seen that, too.]
]
(else-if: _roll is 3)[(display: &quot;Interesting Rumors&quot;)
]
(else:)[
(if: $reputation&#39;s ($neighborhood&#39;s name) &lt; 5)[(set: $reputationTag to &quot;brass-level&quot;)]
(else-if: $reputation&#39;s ($neighborhood&#39;s name) &lt; 15)[(set: $reputationTag to &quot;silver-level&quot;)]
(else:)[(set: $reputationTag to &quot;gold-level&quot;)]

(if: $currentContract is &quot;&quot;)[
(display: &quot;GenerateChar&quot;)(set: $clientDescription to $char)
(set: $potentialContracts to (find: _item where (not ((passage: _item)&#39;s tags  contains &quot;unique&quot;) or not ((history:) contains _item)) and (passage: _item)&#39;s tags contains all of (a: &quot;contract&quot;, $reputationTag), ...($neighborhood&#39;s contracts)))
(if: $potentialContracts&#39;s length &gt; 0)[People have been asking around for ambitious wizards looking for work...&lt;br/&gt;
(for: each _i, ...((shuffled: ...$potentialContracts)&#39;s (range: 1, (min: 3, (ceil: $perception/2)))))[
(link-goto: _i)&lt;br/&gt;&lt;br/&gt;
]](else:)[(display: &quot;Baseless Rumors&quot;)]
]
]
](else:)[(display: &quot;Baseless Rumors&quot;)]
]

[[Buy a Round from The Publican]] 

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="678" name="Bulk Scrolls Liquidation Outlet" tags="bookmark location northharbor tick" position="3395.3333333333335,479.6666666666667" size="100,100">Buy scrolls by the stone.
These scrolls are brought in on rift ships from distant realms.
Sadly, they are frequently in completely unreadable languages.
Suitable for burning or the guest W.C.
1 coin to buy a try!

Let&#39;s take our chances and have some fun.
Maybe, just maybe, we&#39;ll find something very valuable.&lt;br/&gt;
(link-repeat: &quot;Buy A Batch of Bulk Scrolls&quot;)[(replace:?output)[
(if: $gold &gt; 1)[(set: $arg to -1)(display: &quot;UpdateGold&quot;)]
(unless: (random: 0, 20) &gt; 0 or $inventory contains &quot;The Complete History of Your Time Since Moving to the City&quot;)
[You find an incredible book in the pile of garbage.
(set: $arg to &quot;The Complete History of Your Time Since Moving to the City&quot;)(display: &quot;GetItem&quot;)
(replace:?output)[&quot;The Complete History of Your Time Since Moving to the City&quot;
(display: &quot;The Complete History of Your Time Since Moving to the City&quot;)
]](else:)[(unless: (random: 0, 13) is 0)[(set: $arg to &quot;Blank Scroll&quot;)(display: &quot;GetItem&quot;)(display: &quot;Random Bulk Scroll&quot;)](else:)[(set: $arg to &quot;Map Fragment&quot;)(display: &quot;GetItem&quot;)]]]]

|output&gt;[]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="679" name="Dockyard" tags="location northharbor bookmark tick" position="4019,935" size="100,100">(if: $inventory contains &quot;Passage Ticket&quot;)
[{
(display: &quot;Reset Rift Journey&quot;)
(set: $inventory to it - (ds: &quot;Passage Ticket&quot;))}
The scrub captain waves you through the gate and onto an awaiting sail ship.

[[Into the Rift]] 
]
(else:)
[
The scrub captain at the gate refuses you entry.  &quot;No entry without a Passage Ticket,&quot; they cry.  &quot;Go to the Riftrunner&#39;s Guild and get a Passage Ticket.&quot;

[[Riftrunner&#39;s Guild]] 
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="680" name="North Harbor Color" tags="" position="3211,1050" size="100,100">(either: &quot;The docks are a frigid hive of activity.  At various altitudes above and below the sea are the assorted vehicles of many nations.  Brisk trade in transdimensional assets occurs down at the Open Air Marketplace.  For those with a more adventurous bent, there is the Riftrunner&#39;s Guild.&quot;,
&quot;A &quot; + (either: &quot;Tlinkit&quot;, &quot;Norse&quot;, &quot;Ainu&quot;, &quot;Magyar&quot;, &quot;Khazakh&quot;) + &quot; trade delegation &quot; + (either: &quot;hails to you&quot;, &quot;jeers at you&quot;, &quot;regards you passively&quot;) + &quot; from their &quot; + (either: &quot;longboats&quot;, &quot;canoes&quot;, &quot;wooly mammoths&quot;, &quot;elephant seals&quot;, &quot;dolphins&quot;, &quot;whales&quot;) +&quot;.&quot;, &quot;Apparently, you can scrimshaw just about anything.&quot;)</tw-passagedata><tw-passagedata pid="681" name="Riftrunner&#39;s Guild" tags="bookmark northharbor location tick" position="3630,930" size="100,100">The Riftrunner&#39;s Guild works out of a ramshackle cabin that acts as a stile at the fence separating North Harbor proper from the Riftport where all of the flying sail ships are moored and anchored.

Tickets for Dockyard can only be accomplished by passage through the cabin.
(set: _item to &quot;Passage Ticket&quot;)(set: _cost to 10000)(display: &quot;QuickBuy&quot;)
(if: $inventory contains &quot;Passage Ticket&quot;)[ [[Dockyard]] ]

You can also hire yourself out as a Riftrunner, if you fancy a more rugged journey.
(unless: $inventory contains &quot;Riftrunner&#39;s Badge&quot;)[
[[Register for the Riftrunner&#39;s Guild]]
](else:)[
(set: $riftCommand to 0)

[[Riftrunner&#39;s Orientation]]
(if: (history:) contains &quot;Riftrunner&#39;s Orientation&quot;)[ [[Into the Rift]] ]
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="682" name="Register for the Riftrunner&#39;s Guild" tags="tick" position="3742,929" size="100,100">A woman with a large silver lip plug and a network of blue lines tattooed on all of her available surfaces scans you up and down with a cruelly appraising eye.

(if: $inventory contains &quot;Riftrunner&#39;s Badge&quot;)[Rita clicks her sharpened teeth together menacingly.  &quot;No, I can&#39;t take *off* the badge.  You wear it with pride until the end.&quot;](else:)[
(if: $health &lt; 4)[She sneers, exposing teeth filed to points.  &quot;Why don&#39;t you come back when you&#39;ve gotten a little meat on your bones?&quot;  She points the way out.](else:)[&quot;Welcome to the Riftrunner&#39;s Guild!  Let&#39;s get you signed up!&quot; she bellows.  &quot;I&#39;m the local sea hag, Rita.  It&#39;s my job to inscribe the cursemark that allows you to travel into the rift.&quot;

(set: _item to &quot;Riftrunner&#39;s Badge&quot;)(set: _cost to 0)(display: &quot;QuickBuy&quot;)]]

[[Riftrunner&#39;s Guild]] 

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="683" name="Encounter: Drunken Riftrunner" tags="event northharbor" position="3645,4201" size="100,100">{(set: $enemyHealth to 2)(set: $deathReason to &quot;You were pummeled to death by a blind-drunk riftrunner.&quot;)(set: $enemyType to &quot;Riftrunner&quot;)
(set: $fightPattern to (a:(either: &quot;Strike&quot;,&quot;Flee&quot;),(either: &quot;Strike&quot;, &quot;Dodge&quot;)))(set: $enemyElementType to &quot;mortal&quot;)
(set: $fightIndex to 1)}A drunken Riftrunner staggers down the lane.

(if: (random: 0, $reputation&#39;s ($neighborhood&#39;s name)) &lt; 5 and not ($inventory contains &quot;Badge of Shame&quot;))[
They approach you with abject terror in their eyes.
|output&gt;[]
|input&gt;[(display: &quot;Fight&quot;)]

](else:)[They squeeze past you without even so much as making eye contact.
[[Next Encounter]]]

(event: when $enemyHealth &lt;= 0)[ (replace:?input)[ [[Next Encounter]] ]]</tw-passagedata><tw-passagedata pid="684" name="Encounter with Weak Reality" tags="event northharbor" position="3634,1037" size="100,100">The reality around this corner is unusually weak today.

(if: $inventory contains &quot;Riftrunner&#39;s Badge&quot;)[Clear as day, a rift opens up around you, (if: (random: 0, $cunning) &lt; 2)[dragging you back to the Siren&#39;s Folly.
{(set: $riftSupplies to (random: 0, 100))
(set: $riftCrew to (random: 0, 10))
(set: $riftDistance to (random: 0, 10))
(set: $riftTreasure to (random: 0, 10))
(set: $riftCommand to 1)}
[[Into the Rift]]](else:)[ and you could reach right out and touch it if you wanted.
{(set: $riftSupplies to (random: 50, 100))
(set: $riftCrew to (random: 5, 10))
(set: $riftDistance to (random: 5, 10))
(set: $riftTreasure to (random: 5, 10))
(set: $riftCommand to 1)}
[[Into the Rift]]

(display: &quot;NavOptions&quot;)
]
](else:)[You feel quite nauseous, like you&#39;ve heard people get when they accidentally look directly into the Rift.

(display: &quot;NavOptions&quot;)]</tw-passagedata><tw-passagedata pid="685" name="Into the Rift" tags="" position="3741,1038" size="100,100">(display: &quot;Reset Rift Journey&quot;)
Your nervous system crackles with electric pain as you and your crew pass through the boundary of the Rift.  The City already looks incredibly small and far away as your flying sail ship begins to spiral faster and faster around the interdimensional maelstrom that you have decided to plunge yourself into.

(if: $inventory contains &quot;Riftrunner&#39;s Badge&quot;)[
The latent surge from the Rift boundary is grounded out into the aetherium by your guild tattoo.  It must be awful to travel thusly without a Riftrunner&#39;s Badge.

(if: $riftCommand &gt; 0)[The crew consult with you about your preferred heading.
[[Pick Next Heading]]
](else:)[You follow the lead of the crew captain, tying lines here, adjusting lodestones there.
(if: (history:) contains &quot;Read Philomender&#39;s Book of Excellent Knots&quot;)
[
You remember a handful of enchantment knots that gives the expedition an excellent starting boost.  (set: $riftDistance to it + 5)
]
[[Next Journey]]
]
](else:)[(set: $cunning to 1)(set: $perception to 1)(set: $health to (ceil: it / 2))
The intensity of the raw transdimensional energy whipping through you renders you deaf and dumb.  You&#39;re weak in the legs and need help down to your bunk.

(if: $riftCommand &gt; 5)[The crew consult with you about your preferred heading.
[[Pick Next Heading]]
](else:)[You uselessly bob about in your bunk, trying not to vomit all over the crew&#39;s belongings.
[[Next Journey]]
]

]</tw-passagedata><tw-passagedata pid="686" name="Riftrunner&#39;s Orientation" tags="tick" position="3851,930" size="100,100">Rita grins menacingly as she outlines what a Riftrun actually entails.
&quot;This is the Siren&#39;s Folly,&quot; she barks.  A heavily beringed hand points at a spot in what appears to be the center of the Rift.  &quot;This is your True North.  Our goal is to strive to reach the Siren&#39;s Folly and discover what is there.  It appears to be infinitely far away, but we&#39;re not sure which aleph-level of infinity we&#39;re dealing with.&quot;
She points at a crew of energetic sailors rapidly battening their ship for a rough launch.  &quot;Why don&#39;t you join them?&quot;

Board the ship [[Into the Rift]] 

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="687" name="The Northern Gate to East Fortress" tags="northharbor bookmark" position="5818,364" size="100,100">You come across a massive gate of tusk, driftwood, and stone.  It separates the North Harbor and Eastern Fortress neighborhoods.

[[North Harbor]] 

[[Eastern Fortress]] 

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="688" name="Driftwood Fine Rift Furniture" tags="location bookmark northharbor tick" position="3385.3333333333335,891.6666666666667" size="100,100">This store does not, in fact, sell furniture made out of driftwood from the Rift.
It sells furniture that drifted here from the Rift.

// \todo: if a player loses an item in the Rift, have it appear back here.

(for: each _i, &quot;Neighborhood Door to South Quarry&quot;, &quot;Item Shelf&quot;, &quot;Comfortable Bed&quot;)[(set: _item to _i)(set: _cost to 1500)
(display: &quot;QuickBuy&quot;)
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="689" name="Basic ChatterMob" tags="" position="3625.6666666666665,705.6666666666666" size="100,100">(set: $reputation to (dm:))
(set: $identity to &quot;Publican&quot;)
(unless: $reputation contains $identity)[(set: $reputation&#39;s ($identity) to -1)]
first, establish your reputation with them
if they don&#39;t know you, you&#39;ll have a reputation penalty on all interactions with them
If you buy from them and share rumors, your reputation with them will eventually become a bonus

(set: $playerRumors to (ds: &quot;Aleph&quot;, &quot;Fire Ghosts Are Hypnotized by Gold&quot;, &quot;I&#39;m new here.&quot;, &quot;My Garrett Is Secretly An Incredibly Powerful Artifact&quot;))

(set: $mobRumors to (ds: &quot;Fire Ghosts Are Hypnotized by Gold&quot;, &quot;Damage Ward Broker&quot;, &quot;Sirens Carry Great Wisdom&quot;, &quot;Industries of West Fires&quot;, &quot;Current Boss of West Fires&quot;, &quot;Crimes of West Fires&quot;, &quot;Ripper&#39;s Carnage&quot;))

[[Buy A Round]]

[[Tip the Publican]]</tw-passagedata><tw-passagedata pid="690" name="Buy A Round" tags="" position="3749.6666666666665,705.6666666666666" size="100,100">|input&gt;[(set: $reputation&#39;s ($identity) to it + (random: 0, 1))
(for: each _i, ...(shuffled: ...$playerRumors)&#39;s (range: 1,3))[
(set: _item to _i)(link-reveal: _item)[
(if: $mobRumors contains _item)[(replace:?input)[&quot;_item? I heard it before, friend.&quot;]]
(else:)[(replace:?input)[(set: $reputation&#39;s ($identity) to it + 1)(set: _newRumor to (either: ...$mobRumors))&quot;_item? Interesting... &quot;, they say. &quot;_newRumor&quot;(set: $playerRumors to it + (ds: _newRumor))(set: $mobRumors to it + (ds: _item))]]
]]]

(live:)[(print: $reputation&#39;s ($identity))]

[[Buy A Round]] 

[[Tip the Publican]]</tw-passagedata><tw-passagedata pid="691" name="Tip the Publican" tags="" position="3869.6666666666665,708.6666666666666" size="100,100">(if: (random: 0, $reputation&#39;s ($identity)) &gt; 0)[(set: $reputation&#39;s ($identity) to it + 1) The Publican shows their appreciation for your patronage by almost demonstrating any amount of emotion.
(set: _selectRumors to ($mobRumors - $playerRumors))
(if: _selectRumors&#39;s length is 0)[&quot;I&#39;ve told you all I know.&quot;]
(else:)[(set: _newRumor to (either: ..._selectRumors))&quot;_newRumor&quot;(set: $playerRumors to it + (ds: _newRumor))]
](else:)[The Publican is too busy polishing glasses to notice your paltry offering.]

(live:)[(print: $reputation&#39;s ($identity))]

[[Buy A Round]]</tw-passagedata><tw-passagedata pid="692" name="Fancy Lad Outfitter" tags="location northharbor bookmark" position="3388,1553.3333333333335" size="100,100">(set: _cost to 150)
(for: each _item, &quot;Blunderbuss&quot;, &quot;Crystal Prism&quot;, &quot;Loaded Dice&quot;)[
(display: &quot;QuickBuy&quot;)
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="693" name="Ghidra, the Sea Hag" tags="northharbor persona" position="3407.6666666666665,228.33333333333334" size="100,100">It&#39;s not often you see a Sea Hag not on a boat.
You&#39;ve also never seen one so intoxicated.

She challenges you to a drinking contest.

[[That Sounds Like a Superb Idea!!!-&gt;Ghidra: Drinking Contest]]</tw-passagedata><tw-passagedata pid="694" name="Ghidra: Drinking Contest" tags="" position="3537.6666666666665,229.33333333333334" size="100,100">(set: $stamina to $cunning + $perception + $health)
It&#39;s a very simple game.  Each person takes a drink.  If they fall down blind drunk, they lose.

[[Ghidra: Drink Contest (You Win)]]

[[Ghidra: Drink Contest (You Lose)]]</tw-passagedata><tw-passagedata pid="695" name="Ghidra: Drink Contest (You Win)" tags="" position="3776.6666666666665,244.33333333333334" size="100,100">You take about 500 coins worth of various knick knacks.
(set: $arg to 500)(display: &quot;UpdateGold&quot;)
(set: $arg to (random: -1, 0))(display: &quot;UpdateCunning&quot;)
(set: $arg to (random: -1, 0))(display: &quot;UpdatePerception&quot;)
[[Next Encounter]]</tw-passagedata><tw-passagedata pid="696" name="Ghidra: Drink Contest (You Lose)" tags="" position="3656.6666666666665,245.33333333333334" size="100,100">You wake up the next day in complete agony.  Not only do you have a headache, but apparently, you decided to get your entire face tattooed while drunk.

(set: $arg to &quot;Mark of the Sea Dweller&quot;)(display: &quot;GetItem&quot;)
(set: $arg to &quot;Riftrunner&#39;s Badge&quot;)(display: &quot;GetItem&quot;)
(set: $arg to (random: -1, 0))(display: &quot;UpdateCunning&quot;)
(set: $arg to (random: -1, 0))(display: &quot;UpdatePerception&quot;)
[[Next Encounter]]</tw-passagedata><tw-passagedata pid="697" name="Old Clem" tags="northharbor persona" position="3416.6666666666665,112.33333333333333" size="100,100">Clem has lost a bit of just about everything in his voyages.  He might as well have hooks on his hooks and pegs on his pegs.

(set: _selectedClemism to (either: &quot;Old Clem&#39;s Crazy Story&quot;, &quot;Old Clem&#39;s Crazy Advice&quot;, &quot;Old Clem&#39;s Crazy Theory&quot;))
(set: $rumors to it + (ds: _selectedClemism))
(display: _selectedClemism)</tw-passagedata><tw-passagedata pid="698" name="Sir Walter Reginald, Esquire, the III&#39;s School for Pugilism" tags="location bookmark northharbor" position="3387,1449" size="100,100">(if: $maxHealth &lt; 3)[
Basic Fitness Plan:
(set: $maxHealth to it + 1)]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="699" name="Old Clem&#39;s Crazy Story" tags="" position="3537.6666666666665,115.33333333333333" size="100,100">I ran runs on rift ships ever since I was a youngster, and I reckon I&#39;ll ride the Rift until I die.</tw-passagedata><tw-passagedata pid="700" name="Old Clem&#39;s Crazy Advice" tags="" position="3769.6666666666665,126.33333333333333" size="100,100">Get yourself a rift ship and ride it backwards, and you&#39;ll get back to where you got started faster.</tw-passagedata><tw-passagedata pid="701" name="Old Clem&#39;s Crazy Theory" tags="" position="3645.6666666666665,133.33333333333334" size="100,100">Just says crazy bat-shit nonsense, but it&#39;s all rumors that you can use later.</tw-passagedata><tw-passagedata pid="702" name="Tower Yard" tags="location bookmark northharbor" position="3394.333333333333,599.6666666666667" size="100,100">You&#39;ve seen docks.  Usually, they are parallel to the surface of your planet.  In this wondrous case, the dock is a towering edifice with graceful airships lashed to it.

In addition to its port on the Rift Sea, North Harbor also contains a port to the sky.

You can buy passage on a ship up to the Sylphian Archipelago, which lies between the rest of the City and Upper Castlerock.

[[Sylphian Archipelago]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="703" name="Magisterium Local Office: North Harbor" tags="location unlisted northharbor" position="3388.3333333333335,790" size="100,100">(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="704" name="Fisher&#39;s Wharf" tags="location northharbor bookmark" position="3384,1218" size="100,100">Not everyone throws themselves into punching out the Eye of the Rift.  Some folk stay relatively near the shores of the Rift Sea.  Not far off is a patch of relatively stable reality intersection that intersects the migratory path of a school of tuna on a world where no sapient beings ever evolved.  Those tuna produce the best sashimi in The City.  Closer still, you can do a bit of [[Sand Piping]], which is Mudlarking, but on the beach.  Perched on the fence are old salts mending nets.  Some of thems what learned directly from old Philomender, themselves.

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="705" name="Sand Piping" tags="location northharbor tick" position="3396,1330" size="100,100">Blue-ringed octopus: Not a creature of eldritch terror, but certainly just as dangerous.  The only smart thing to do would be to immediately walk away.  However, these are valuable creatures, and if you could trick one into going into a jar, you could get a lot of money.  Or, it could touch you, schedule a death sentence for you, have you think everything&#39;s fine for 10 turns, and then die.
Species of shellfish evolved to look exactly like the (either: &quot;Sydney Opera House&quot;, &quot;Guggenheim Museum&quot;, &quot;Burj Kalifa&quot;, &quot;State of Nebraska&quot;, &quot;Chevy Nova&quot;, &quot;moon&quot;, &quot;type of sailboat used around here&quot;)
Stinging jellies.  1 point of damage.  If you have a Witch Bottle, you can pour the urine on the wound to prevent damage.  This is a trick.  It does not work.  You will lose public reputation for pouring piss on your leg.
At night, phosphorescent algae cause the waters to glow
Bits of sea glass
Grains of sand, each of which has a just barely scrutable orb inside filled with galaxies.
Message Bottle
    (either: &quot;To whomever gets this letter,&quot;, &quot;To whoever gets this note,&quot;, &quot;Dear Stranger,&quot;, &quot;Please Help!&quot;) (either: &quot;I want to make an account of my time&quot;, &quot;I wish that someone knows of how I&#39;m&quot;, &quot;In the hopes that someone sees this before I am&quot;) (either: &quot;surviving on rainwater and moss while Set Adrift out in the Rift.&quot;, &quot;joining a tribe of islanders and using their support to make it back to port.&quot;, &quot;regretting to not purchase a Selkie Skin before being Set Adrift.&quot;).
	
(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="706" name="RandomMudlark" tags="" position="4386,2435" size="100,100">{(if: $ticks % 13 &lt; 7)[
(display: &quot;Tick&quot;)(replace:?clock)[(display: &quot;RenderHeader&quot;)]
(set: _roll to (random: 0, $perception * 2))
(if: _roll is 0)[(either:&quot;You find a few broken clay pipes.&quot;, &quot;You find some old rusty pins.&quot;,&quot;You find a mummified tobacco pouch.&quot;)]
(else-if: _roll is 1)[(either: &quot;You find an old coin.&quot;, &quot;You find a dainty bauble.&quot;,&quot;You find a small gemstone.&quot;)(set: _gold to (random: 1,5))
&lt;br/&gt;&lt;b&gt;Gold + _gold&lt;/b&gt;(set: $gold to it + _gold)]
(else-if: _roll is 2)[You find a shred of paper:
&lt;br/&gt;(display: &quot;Random Bulk Scroll&quot;) ]
(else-if: _roll &lt; 5)[You find a small piece of unused reagent: (set: _reagent to (either: &quot;Lump of Lead&quot;, &quot;Piece of Pitch&quot;, &quot;Grain of Gold&quot;))&lt;br/&gt;&lt;b&gt;+ _reagent&lt;/b&gt;(set: $inventory to it + (ds: _reagent))]
(else-if: _roll &lt; 7)[You find a valuable antique:
&lt;br/&gt;&lt;b&gt;Gold + 75&lt;b/&gt;(set: $gold to it + 75)]
(else:)[(if: $inventory contains &quot;Slow Clock&quot;)[You find a space where an object should be, but you&#39;ve already picked it up.](else:)[You find Slow Clock.  It&#39;s badly sodden, but it appears to still be in working order.
(set: $inventory to it + (ds: &quot;Slow Clock&quot;))
&lt;br/&gt;&lt;b&gt;+ Slow Clock&lt;/b&gt;]]
](else:)[(replace:?input)[The canal tide is high.  Come again in the morning if you want to try finding treasures in the mud.]]}</tw-passagedata><tw-passagedata pid="707" name="The First Prestige" tags="" position="8266,1085" size="100,100">You are handed an embossed calling card.  The darkness hides everything except for your hand and the card.  You turn to look at what is written on the card, and it says:

ETAOIN SHRDLU</tw-passagedata><tw-passagedata pid="708" name="The Second Prestige" tags="" position="4154,1788" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="709" name="The Third Prestige" tags="" position="1100,8850" size="100,100">Double-click this passage...</tw-passagedata><tw-passagedata pid="710" name="Reset Rift Journey" tags="function" position="3744,1158" size="100,100">{(set: $riftSupplies to 100)
(set: $riftCrew to 10)
(set: $riftDistance to 0)
(set: $riftTripDistance to 9999999)
(set: $riftTreasure to 0)
(set: $riftCommand to 1)
(set: $riftVoyageDirection to 1)}</tw-passagedata><tw-passagedata pid="711" name="Deliver a Rousing Speech to the Crew" tags="" position="3993,1164" size="100,100">You can try to lift the crew&#39;s spirits at the expense of some of your goodwill.
(cycling-link: bind _sacrifice, ...(altered: _i via (str: _i), ...(range: 0, $riftCommand)))

(link-reveal: &quot;Speechify&quot;)[
You take a deep breath and prepare to give forth:

(set: _roll to (random: 0, (pow: (num:_sacrifice), 2) * 5))
Roll: _roll
(if: _roll &gt; 20)[
Your speech is epic, and your crew is invigorated.

(set: $arg to 3)(display: &quot;UpdateRiftDistance&quot;)
(set: $arg to _roll)(display: &quot;UpdateRiftCommand&quot;)
](else:)[
Your speech is terrible, and your crew is demoralized.
(set: $arg to -(_roll + (num:_sacrifice)))(display: &quot;UpdateRiftCommand&quot;)
]]

[[Next Journey]]</tw-passagedata><tw-passagedata pid="712" name="Walk the Plank" tags="tick" position="3885,1412" size="100,100">The crew has had enough of you and forces you to walk the plank.

(if: $inventory contains &quot;Selkie Skin&quot;)[You could [[Dive In Headfirst-&gt;Next Journey]] while wearing your Selkie Skin.]
(else:)[You could [[Dive In Headfirst-&gt;Death]](set: $deathReason to &quot;As you collide with the surface of raw riftspace, your very being is torn into infinitely thin slices.&quot;)]</tw-passagedata><tw-passagedata pid="713" name="Recruit a Salty Crew" tags="" position="5576,1154" size="100,100">|output&gt;[(set: $arg to (random: 0, 5))(display: &quot;UpdateRiftCrew&quot;)]

[[Next Journey]]</tw-passagedata><tw-passagedata pid="714" name="Parlay with the Pirates" tags="" position="5694,1155" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="715" name="UpdateRiftCrew" tags="function" position="3628,1263" size="100,100">{(set: $riftCrew to it + $arg)(if: $riftCrew &gt; $riftMaxCrew)[Not everyone can fit on your merry boat.  Some, you have to leave behind. (set: $riftCrew to $riftMaxCrew)]
(if: $riftCrew &lt;= 0)[
(set: $riftCrew to 0)
It&#39;s just you now.
]}
&lt;b&gt;Crew (unless: $arg &lt; 0)[+] $arg ($riftCrew)&lt;/b&gt;</tw-passagedata><tw-passagedata pid="716" name="UpdateRiftSupplies" tags="function" position="3634,1369" size="100,100">(if: $riftSupplies + $arg &gt; $riftMaxSupplies)[You don&#39;t have enough room in the hold, and some supplies go to waste.]
{(set: $riftSupplies to (min: $riftMaxSupplies, it + $arg))&lt;b&gt;Supplies (if: $arg &gt;= 0)[+] $arg ($riftSupplies)
(if: $riftSupplies &lt; -20)[(set: $arg to -2)(display: &quot;UpdateRiftCommand&quot;)(set: $riftSupplies to -20)]
(else-if: $riftSupplies &lt;= 0)[(set: $arg to -1)(display: &quot;UpdateRiftCommand&quot;)]}</tw-passagedata><tw-passagedata pid="717" name="UpdateRiftCommand" tags="function" position="3635,1476" size="100,100">(set: $riftCommand to it + $arg)&lt;b&gt;Command (if: $arg &gt;= 0)[+] $arg ($riftCommand)</tw-passagedata><tw-passagedata pid="718" name="Steal a Lifeboat" tags="" position="4716,1731" size="100,100">(if: (random: 0, 1) is 0)[
[[On the Lifeboat]]
](else:)[
[[Set Adrift]] 
]</tw-passagedata><tw-passagedata pid="719" name="Sparring Shuffle" tags="" position="4806,754" size="100,100">{(set: $options to (shuffled: ...((a: &quot;Biff&quot;, &quot;Biff&quot;, &quot;Boff&quot;, &quot;Boff&quot;, &quot;Bash&quot;, &quot;Bash&quot;)))&#39;s (range: 1, $cunning))
(for: each _i, ...$options)[(set: _i2 to _i)&lt;br/&gt;&lt;br/&gt;
(link-reveal: _i)[(replace:?output)[(display: _i2)](replace:?input)[
(if: $enemyHealth &lt;= 0)[(replace:?input)[You&#39;ve clobbered your sparring partner but good!(set: $koReason to &quot;&quot;)

[[Next Journey]] ]](else:)[Your opponent is wounded, but they are still on their feet.
(display: &quot;Sparring Shuffle&quot;)]]]
]
}</tw-passagedata><tw-passagedata pid="720" name="Biff" tags="" position="4917,750" size="100,100">{(set: _opponentMove to $fightPattern&#39;s ($fightIndex))
(replace:?output)[You biff.(if: _opponentMove is &quot;Biff&quot;)[.. but they biff, too.  It&#39;s awkward.](else-if: _opponentMove is &quot;Boff&quot;)[  They grab at your biff and boff you about! (set: $arg to (random: 0, 1))(display: &quot;TakeKoDamage&quot;)](else-if: _opponentMove is &quot;Bash&quot;)[]]
(set: $fightIndex to (it + 1))
(if: $fightIndex &gt; $fightPattern&#39;s length)[(set: $fightIndex to 1)(replace:?clock)[(display: &quot;RenderHeader&quot;)]]
}</tw-passagedata><tw-passagedata pid="721" name="Boff" tags="" position="5027,755" size="100,100">{(set: _opponentMove to $fightPattern&#39;s ($fightIndex))
(replace:?output)[You launch a boff at your opponent&#39;s temple.(if: _opponentMove is &quot;Biff&quot;)[.. but they biff your fist away.](else-if: _opponentMove is &quot;Boff&quot;)[  As they dip in to boff your arm, you boff them in the throat.(set: $arg to 2)(display: &quot;DealKoDamage&quot;)](else-if: _opponentMove is &quot;Bash&quot;)[  You trade boffs and bashes at each other, bloodying each other&#39;s noses.(set: $arg to 1)(display: &quot;DealKoDamage&quot;)(display: &quot;TakeKoDamage&quot;)](else:)[  They make no move to avoid it and take the full brunt of your boff.(set: $arg to 2)(display: &quot;DealKoDamage&quot;)]]
(set: $fightIndex to (it + 1))
(if: $fightIndex &gt; $fightPattern&#39;s length)[(set: $fightIndex to 1)]
(replace:?clock)[(display: &quot;RenderHeader&quot;)]}</tw-passagedata><tw-passagedata pid="722" name="Bash" tags="" position="5151,762" size="100,100">{(set: _opponentMove to $fightPattern&#39;s ($fightIndex))
(replace:?output)[You attempt to bash them.(if: _opponentMove is &quot;Biff&quot;)[ You get a firm grip on their biff and bash them to the ground. (set: $arg to 1)(display: &quot;DealKoDamage&quot;)](else-if: _opponentMove is &quot;Boff&quot;)[  The two of you boff indecisively for a few seconds before pulling apart again.](else-if: _opponentMove is &quot;Bash&quot;)[As you attempt to bash them, they land a sharp counterbash to your liver. (set: $arg to 1)(display: &quot;TakeKoDamage&quot;)]]
(set: $fightIndex to (it + 1))
(if: $fightIndex &gt; $fightPattern&#39;s length)[(set: $fightIndex to 1)]
(replace:?clock)[(display: &quot;RenderHeader&quot;)]}</tw-passagedata><tw-passagedata pid="723" name="TakeKoDamage" tags="function" position="4810,644" size="100,100">&lt;br/&gt;&lt;b&gt;Consciousness - $arg&lt;/b&gt;(set: $koHealth to it - $arg)
(if: $koHealth &lt;= 0)[
(set: $riftCommand to it - 1)
(goto: &quot;Wake Up In The Brig&quot;)
]</tw-passagedata><tw-passagedata pid="724" name="Wake Up In The Brig" tags="" position="4563,771" size="100,100">Ugh, whatever happened last night...  (either: &quot;a rave?&quot;, &quot;a wake?&quot;, &quot;a fight?&quot;, &quot;tequila shots?&quot;, &quot;Vegas?&quot;)

[[Next Journey]]</tw-passagedata><tw-passagedata pid="725" name="DealKoDamage" tags="function" position="4918,646" size="100,100">(set: $enemyHealth to it - $arg)&lt;b&gt;Opponent - $arg&lt;/b&gt;
(if: $enemyHealth &lt;= 0)[Your formerly conscious crewmate gracefully pirouettes as they collapse bonelessly to the ground, your last strike finding its way to a secret nerve bundle under the chin.  &quot;Well fought, mate!&quot; you cheer.
(set: $arg to 1)(display: &quot;UpdateRiftCommand&quot;)
](else:)[Your opponent is visibly affected by your attack, but they remain on their feet.]</tw-passagedata><tw-passagedata pid="726" name="About to Aft, Return Home!" tags="" position="4440,690" size="100,100">(set: $riftDirection to -1)(set: $riftTripDistance to $riftDistance)(goto: &quot;Next Journey&quot;)</tw-passagedata><tw-passagedata pid="727" name="UpdateRiftTreasure" tags="function" position="3638,1589" size="100,100">(if: $riftTreasure + $arg &gt; $riftMaxTreasure)[You can&#39;t fit anymore treasure in the hold.  You&#39;ll have to leave some behind.]
(set: $riftTreasure to (min: $riftMaxTreasure, it + $arg))*Treasure (if: $arg &gt;= 0)[+] $arg ($riftTreasure)*</tw-passagedata><tw-passagedata pid="728" name="Go Hunting" tags="tick" position="4606,1277" size="100,100">(set: $arg to -1)(display: &quot;UpdateRiftSupplies&quot;)(set: _roll to (random: 1, 6))
(if: _roll is 1)[
You find a wild beast.
(if: (random: 0, 2) is 0)[(set: $deathReason to &quot;You were gored and trampled by a beast while on the hunt.&quot;)(set: $arg to 1)(display: &quot;TakeDamage&quot;)]
(set: $arg to (random: 5, 15) * 3)(display: &quot;UpdateRiftSupplies&quot;)
]
(else:)[
You don&#39;t find anything.
]

[[Go Hunting]]

[[Return to the Ship-&gt;Next Journey]]</tw-passagedata><tw-passagedata pid="729" name="Purchase Supplies" tags="" position="5812,1151" size="100,100">(set: $marketplace to (a: &quot;Supply Crate&quot;, &quot;Supply Crate&quot;, &quot;Supply Crate&quot;))
(set: $price to 100)
(for: each _item, ...$marketplace)[	(set: _t1 to _item)	(set: _t2 to $price)	(link-reveal: &quot;Buy &quot; + _t1 + &quot; For &quot; + (str: _t2) + &quot; Gold&quot;)[(if: $gold &gt; _t2)[You buy _t1 for _t2. 
	(set: $riftSupplies to it + 50)(set: $gold to it - _t2)
	(replace:?clock)[(display: &quot;RenderHeader&quot;)]](else:)[You don&#39;t have the dosh, mate.]]
	(set: $price to $price * 2)
]

[[Next Journey]]</tw-passagedata><tw-passagedata pid="730" name="Pick Next Heading" tags="" position="3855,1039" size="100,100">&quot;Here are the options, mate!&quot; a crewmember squacks at you.

(set: _options to (shuffled: ...(find: _item where _item&#39;s tags contains &quot;journey&quot;, ...(passages:))))
(set: _optionCount to $cunning)(if: $inventory contains &quot;Compass of Many Places&quot;)[(set: _optionCount to it + 4)]
(for: each _item, ...(subarray: _options, 1, $cunning))
[
(link-goto: (_item&#39;s name), (_item&#39;s name))]

(link-goto: &quot;Spin the Wheel!&quot;, (shuffled: ...(find: _item where _item&#39;s tags contains &quot;journey&quot;, ...(passages:)))&#39;s 1st&#39;s name)</tw-passagedata><tw-passagedata pid="731" name="Next Journey" tags="tick" position="3993,1053" size="200,100">(if: $riftCrew &gt; 0)[(set: $arg to -$riftCrew)(display: &quot;UpdateRiftSupplies&quot;)
(if: $riftSupplies &lt;= -15)[You&#39;ve scavanged everything of value on the ship.  Every belt has been boiled into soup, every pet has been slaughtered and their skeleton&#39;s picked clean. You are now starving. 

(if: $riftCommand &lt; 0)[(set: $riftNextJourney to (either: &quot;Mutiny!&quot;, &quot;Cannibalism&quot;))]]
(else-if: $riftSupplies &lt;= 0)[You&#39;re completely out of supplies.  The crew is terrified.

(if: $riftCommand &lt; 0)[(set: $riftNextJourney to (either: &quot;Mutiny!&quot;, &quot;Cannibalism&quot;, &quot;Walk the Plank&quot;))]
]
(else-if: $riftSupplies &lt;= $riftCrew)[The crew is quite anxious about the lack of supplies.
(if: (random: 0,1) &gt; 0)[(set: $riftNextJourney to &quot;Scurvy&quot;)]]
(else-if: $riftSupplies &lt;= $riftCrew * 3)[Your crew is starting to get worried about the lack of supplies.
(if: $riftDirection is 1)[
[[About to Aft, Return Home!]]

[[Deliver a Rousing Speech to the Crew]]
]]
(else:)[Your crew is quite sanguine about their supplies.
(set: $arg to (random: 0, 1))(display: &quot;UpdateRiftCommand&quot;)]
Supplies -&gt; $riftSupplies
Crew -&gt; $riftCrew
Treasure -&gt; $riftTreasure
Command -&gt; $riftCommand
(if: $riftDirection is 1)[Distance -&gt; $riftDistance/$riftTripDistance
You are sailing into the eye of the Rift.](else:)[Distance -&gt; (print: $riftDistance-$riftTripDistance)/$riftTripDistance
You are heading back to North Harbor.

(if: $riftDistance &gt;= $riftTripDistance * 2)[You&#39;ve returned to this place after untold years for you and your crew, but mere hours or days for the citizens of North Harbor.

[[Unload the Ship]] ]
]
(if: $riftDistance &lt; $riftTripDistance * 2)[
(if: $riftCommand &gt; 7 or $inventory contains &quot;Captain&#39;s Hat&quot;)[You command this crew.
[[Pick Next Heading]] 
]
(else:)
[(if: $riftNextJourney is &quot;&quot;)[(link-goto: (shuffled: ...(find: _item where _item&#39;s tags contains &quot;journey&quot;, ...(passages:)))&#39;s 1st&#39;s name)]
(else:)[(link-goto: $riftNextJourney)]]]]
(else:)[(set: $arg to -1)(display: &quot;UpdateRiftSupplies&quot;)
(if: $riftSupplies &lt;= -15)[You&#39;ve scavanged everything of value on the ship.  Every belt has been boiled into soup, every pet has been slaughtered and their skeleton&#39;s picked clean. You are now starving. 
(set: $arg to -1)(display: &quot;UpdateRiftCommand&quot;)
(if: (random: 0,1) &gt; 0)[Your hunger pains begin to signal real physical damage.
(set: $arg to 1)(display: &quot;TakeDamage&quot;)]]

Supplies -&gt; $riftSupplies
Crew -&gt; $riftCrew
Treasure -&gt; $riftTreasure
Command -&gt; $riftCommand

You are the only one left on this ship.  It is completely rudderless!
(set: $riftDirection to (random: 0, 1))
(if: $riftDirection is 1)[Distance -&gt; $riftDistance/$riftTripDistance
You are sailing into the eye of the Rift.](else:)[Distance -&gt; (print: $riftDistance-$riftTripDistance)/$riftTripDistance
You are heading back to North Harbor.

(if: $riftDistance &gt;= $riftTripDistance * 2)[You&#39;ve returned to this place after untold years for you and your crew, but mere hours or days for the citizens of North Harbor.

[[Unload the Ship]] ]
]

(link-goto: (shuffled: ...(find: _item where _item&#39;s tags contains &quot;journey&quot;, ...(passages:)))&#39;s 1st&#39;s name)]</tw-passagedata><tw-passagedata pid="732" name="Mutiny!" tags="" position="4012,1284" size="100,100">(set: $riftNextJourney to &quot;&quot;)
(set: _roll to (random: 1, 6))
The crew begin to riot.  Without clear leadership, the situation becomes completely chaotic.

(if: _roll &lt; 3)[
[[Set Adrift]] 
]
(else-if: _roll &lt; 6)[
[[Stranded on a Deserted Island]]
]
(else:)[
[[Come out on Top of the Uprising]]
]</tw-passagedata><tw-passagedata pid="733" name="Cannibalism" tags="" position="4017,1539" size="100,100">(if: $riftCrew &gt; 1)[Your crew has created an innovative solution to both the supply and overpopulation problem simultaneously!

(set: $arg to -1)(display: &quot;UpdateRiftCommand&quot;)
(set: $arg to (ceil: $riftCrew / 2) * 10)(display: &quot;UpdateRiftSupplies&quot;)
(set: $arg to -(ceil: $riftCrew / 2))(display: &quot;UpdateRiftCrew&quot;)
|output&gt;[]
(set: $riftNextJourney to &quot;&quot;)
(if: (history:)&#39;s last is &quot;On the Lifeboat&quot;)[ [[Next Journey-&gt;On the Lifeboat]] ]
(else:)[
[[Next Journey]] ]
(set: $health to it + 1)](else-if: $riftCrew is 1)[Only one crew member remains, and they&#39;re hankering for a hunk of your haunches.
{
(set: $enemyHealth to 2)(set: $deathReason to &quot;What&#39;s worse than being killed by a former crew mate is still feeling the teeth as they eat you while the old nervous system powers down.&quot;)(set: $enemyType to &quot;Riftrunner&quot;)
(set: $fightPattern to (a:(either: &quot;Strike&quot;,&quot;Throw&quot;),(either: &quot;Strike&quot;, &quot;Dodge&quot;)))(set: $enemyElementType to &quot;mortal&quot;)
(set: $fightIndex to 1)}
|output&gt;[]
|input&gt;[(display: &quot;Fight&quot;)]

(event: when $enemyHealth &lt;= 0)[ (set: $arg to -1)(display: &quot;UpdateRiftCrew&quot;)(replace:?input)[ (if: (history:)&#39;s last is &quot;On the Lifeboat&quot;)[ [[Next Journey-&gt;On the Lifeboat]] ]
(else:)[
[[Next Journey]] ] ]]
]</tw-passagedata><tw-passagedata pid="734" name="Scurvy" tags="" position="4017,1658" size="100,100">(set: $deathReason to &quot;Nutrition has been sacrificed, which has reduced your effective crew capacity.&quot;)$deathReason

(set: $arg to (random: -1, -(ceil: $riftCrew / 2)))(display: &quot;UpdateRiftCrew&quot;)
(set: $riftNextJourney to &quot;&quot;)
You also go hungry.
(display: &quot;TakeDamage&quot;)

(if: (history:)&#39;s last is &quot;On the Lifeboat&quot;)[ [[Next Journey-&gt;On the Lifeboat]] ]
(else:)[
[[Next Journey]] ]</tw-passagedata><tw-passagedata pid="735" name="Stranded on a Deserted Island" tags="" position="3880,1287" size="100,100">(set: $riftNextJourney to &quot;&quot;)
You&#39;ve been deposited on a deserted island to take care of yourself.  Quite a favor.  You could have been keelhauled.
(set: _item to &quot;Captain&#39;s Hat&quot;)(display: &quot;LoseItem&quot;)

|output&gt;[]
(set: $resources to 3)
(link-repeat: &quot;Establish Camp&quot;)[(append:?output)[(display: &quot;Tick&quot;)
(set: $resources to it + (random: 0, 2))(set: $riftSupplies to it + (random: 0, 5))You build up fuel for a signal fire, gather what meager food and water you can find, and prepare for signs of a rescue.
]]

(link-repeat: &quot;Try to Escape&quot;)[(append:?output)[(display: &quot;Tick&quot;)You attempt a grand signal fire. (set: $resources to (ceil: it / 2))
(if: (random: 0, 10) &lt; $resources)[
You are saved by a passing crew in a lifeboat!

[[On the Lifeboat]]
]]]</tw-passagedata><tw-passagedata pid="736" name="Come out on Top of the Uprising" tags="" position="4015,1413" size="100,100">(set: $riftNextJourney to &quot;&quot;)

(set: $inventory to it + (ds: &quot;Captain&#39;s Hat&quot;))
You&#39;ve somehow managed to come out on top in this battle, and your crew have a newfound respect for you!
(set: $riftCommand to (max: $riftCommand, 11))

(if: (history:)&#39;s last is &quot;On the Lifeboat&quot;)[ [[Next Journey-&gt;On the Lifeboat]] ]
(else:)[
[[Next Journey]] ]</tw-passagedata><tw-passagedata pid="737" name="Unload the Ship" tags="" position="3889,1150" size="100,100">Convert all of your treasure and distance into gold, items, and/or reputation.
(set: _totalBuyback to 0)
Supply Buyback: (set: _buyback to (ceil: $riftSupplies/2))_buyback(set: _totalBuyback to it + _buyback)(set: $riftSupplies to 0)
Crew Bonus: (set: _buyback to $riftCrew * 10)_buyback(set: _totalBuyback to it + _buyback)(set: $riftCrew to 0)
Distance Bonus: (set: _buyback to $riftDistance)_buyback(set: _totalBuyback to it + _buyback)
Treasure Bonus: (set: _buyback to $riftTreasure * 5)_buyback(set: _totalBuyback to it + _buyback)
(for: each _item, ...(shuffled: &quot;Hand of Glory&quot;,&quot;Slow Clock&quot;,&quot;Grain of Gold&quot;,&quot;Perfect Pearl&quot;,&quot;Noble Cowl&quot;))[
(if: (random: 0, $riftTreasure) &gt; 10)[(set: $arg to _item)(display: &quot;GetItem&quot;)]
]
(set: $arg to  _totalBuyback)
(display: &quot;UpdateGold&quot;)
[[Riftrunner&#39;s Guild]] 
(display: &quot;Reset Rift Journey&quot;)
(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="738" name="Scrape Barnacles off of the Hull" tags="" position="4832,1615" size="100,100">Unpopular, tiresome work that nevertheless gives an immediate distance boost.

&lt;b&gt;Command - 1&lt;/b&gt;(set: $riftCommand to it - 1)
(set: $arg to 3)(display: &quot;UpdateRiftDistance&quot;)
[[Next Journey]]</tw-passagedata><tw-passagedata pid="739" name="On the Lifeboat" tags="tick" position="5198,1163" size="100,100">You (if: $riftCrew &gt; 0)[and the $riftCrew remaining crew are on a lifeboat together](else:)[are on a lifeboat alone], awaiting rescue.
(set: $arg to -1)(display: &quot;UpdateRiftCommand&quot;)
(display: &quot;UpdateRiftSupplies&quot;)
(if: $riftCrew &gt; 0 and $riftSupplies &lt; 0 and $riftCommand &lt; 0)[(goto: (either: &quot;Mutiny!&quot;, &quot;Cannibalism&quot;, &quot;Scurvy&quot;))](else:)[
(set: $arg to (either: 0, 1, 1))(display: &quot;UpdateRiftDistance&quot;)
(if: (random: 0, 100) is 0)[ [[Safe Harbor]]]
(if: $riftDistance &gt;= $riftTripDistance * 2)[ [[North Harbor]] ](else:)[
[[On the Lifeboat]]]](set: $riftTreasure to 0)</tw-passagedata><tw-passagedata pid="740" name="UpdateRiftDistance" tags="function" position="3630,1158" size="100,100">(set: _i to (ceil: $arg * $riftCrew))&lt;br/&gt;&lt;b&gt;Distance (if: _i &gt;= 0)[+ ]_i&lt;b/&gt;(set: $riftDistance to it + _i)</tw-passagedata><tw-passagedata pid="741" name="Interesting Rumors" tags="" position="5300,6502" size="100,100">(if: (random: 0, 1) &gt; 0)[
(set: _newRumor to (either: &quot;Fire Ghosts Crave Coal&quot;, &quot;Fire Ghosts Crave Coal&quot;))
(set: $arg to _newRumor)(display: &quot;GainRumor&quot;)
]
(else:)[
(either: &quot;A Compass of Many Places is a fine thing to have if you&#39;re a Riftrunner!&quot;, &quot;Get yourself a copy of Philomender&#39;s Book of Excellent Knots at any price!&quot;, &quot;Potions can be quite dangerous at certain times of day, but those times aren&#39;t labelled anywhere.&quot;)]</tw-passagedata><tw-passagedata pid="742" name="Baseless Rumors" tags="" position="4798,6505" size="100,100">&quot;(either: &quot;Sirens will trade secrets of great value with you.&quot;, &quot;Witch Bottles are an excellent protective ward for your home.&quot;, &quot;I&#39;m a natural blonde!&quot;)&quot;</tw-passagedata><tw-passagedata pid="743" name="Fire Ghosts Crave Coal" tags="rumor" position="5305,6607" size="100,100">A Fire Ghost just wants to devour anything they can.  A small piece of coal could easily distract them.</tw-passagedata><tw-passagedata pid="744" name="Iceberg Spiders" tags="rumor" position="5416,6604" size="100,100">You&#39;ve heard of trap-door spiders, but have you heard of the Great Northern Iceberg Spiders?</tw-passagedata><tw-passagedata pid="745" name="North Harbor Has Massive Fleets of Treasure Hunters" tags="rumor" position="5667,6606" size="100,100">Get yourself to North Harbor and register to be a Rift Runner.  You&#39;ll be able to bring back vast fortunes from distant branes.</tw-passagedata><tw-passagedata pid="746" name="South Quarry" tags="tick" position="5144,4590" size="200,200">(display: &quot;Init South Quarry&quot;)
This neighborhood is carved out of a vast nearly cubical deposit of living rock halfway beneath the surface of the Earth.  It has an extensive Catacombs(unless: (history:) contains &quot;Entrance to the Catacombs&quot;)[, but you&#39;ve yet to find them].

(for: each _item, ...($neighborhood&#39;s locations))[(if: (history:) contains _item and (passage: _item)&#39;s tags contains &quot;bookmark&quot;)[(link-goto: _item)

]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="747" name="South Quarry Color" tags="" position="5024,4646" size="100,100">Wonderful South Quarry denizens</tw-passagedata><tw-passagedata pid="748" name="Pandaemonium" tags="bookmark southquarry location tick" position="5196,4806" size="100,100">(for: each _item, &quot;Rattle Bones&quot;, &quot;Gnome&quot;, &quot;Golem&quot;)[(unless: $daemons contains _item)[
(set: $itemName to _item)_item - (link-reveal-goto: &quot;Buy &quot; + _item, &quot;Buy a Daemon&quot;)[(set: $itemName to _item)]]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="749" name="Unlicensed Potion Broker" tags="southquarry location tick lowerdepths" position="4532,2215" size="100,100">Random, nasty, and cheap!  Affordable potions and alchemical components sold by a creature that seems to be a large hat and cloak with many, many satchels.
(if: visits % 2 is 1)[
(set: $marketplace to (shuffled: ...(find: _i where _i&#39;s tags contains any of (a: &quot;potion&quot;, &quot;reagent&quot;), ...(passages:)))&#39;s (range: 1, 3))(for: each _i, ...$marketplace)[(set: _item to _i&#39;s name)(unless: $inventory contains _item)[(set: _cost to 75)(display: &quot;QuickBuy&quot;)]]]
(else:)[The broker dashes away before the Magisterium Guards can catch him doing business.]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="750" name="999th Hand Book Store" tags="bookmark southquarry location tick" position="5201,5027" size="100,100">The books in this store are incredibly worn and fuzzy.  They&#39;ve been through so many owners that most are virtually palimpsest.
(unless: $inventory contains &quot;Percepo de Cristal&quot;)[
One appears to still be legible:
(if: $perception &lt; 7)
[(set: _item to &quot;Percepo de Cristal&quot;)(set: _cost to 150)(display: &quot;QuickBuy&quot;)]
(else:)[(set: _item to &quot;Percepo de Cristal&quot;)(set: _cost to 20)(display: &quot;QuickBuy&quot;)]]

(unless: $inventory contains &quot;Grimoire Alchemickal&quot;)[
One appears to still be legible:
(if: $perception &lt; 7)
[(set: _item to &quot;Grimoire Alchemickal&quot;)(set: _cost to 150)(display: &quot;QuickBuy&quot;)]
(else:)[(set: _item to &quot;Grimoire Alchemickal&quot;)(set: _cost to 20)(display: &quot;QuickBuy&quot;)]]

(unless: $inventory contains &quot;Ex Nobilis Aetherium&quot;)[
One appears to still be legible:
(if: $perception &lt; 7)
[(set: _item to &quot;Ex Nobilis Aetherium&quot;)(set: _cost to 150)(display: &quot;QuickBuy&quot;)]
(else:)[(set: _item to &quot;&quot;)(set: _cost to 20)(display: &quot;QuickBuy&quot;)]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="751" name="Mystique Boutique" tags="bookmark southquarry location tick" position="5200,4917" size="100,100">Consuela greets you at the front of the store.
&quot;Ah, yes, a discerning customer who recognizes the superiority of our merchandise.&quot;  As she adjusts her massive and ornate wig, she adds, &quot;Our prices may have risen recently due to our increasing popularity.&quot;
(set: $goldCost to 350)
(for: each _item, ...(a: &quot;Scrying Stone&quot;, &quot;Potion Automixer&quot;,
, &quot;Neighborhood Door to Eastern Fortress&quot;))[(if: $inventory contains _item)[(set: $goldCost to (floor: it * 1.5))]]
(for: each _item, ...(a: &quot;Scrying Stone&quot;, &quot;Potion Automixer&quot;,
, &quot;Neighborhood Door to Eastern Fortress&quot;))[(unless: $inventory contains _item)[(link-reveal-goto: &quot;Examine the &quot; + _item, &quot;Furniture For Sale&quot;)[(set: $itemName to _item)]
]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="752" name="Entrance to the Catacombs" tags="bookmark southquarry tick unlisted location" position="4687,5292" size="100,100">Here is the entrace to the Lower Depths, the Catacomb city beneath the City.

[[Catacombs]]

[[South Quarry]] 

[[Home Again]]</tw-passagedata><tw-passagedata pid="753" name="Coffee Shop" tags="location bookmark southquarry tick" position="5201,5134" size="100,100">Information and stimulants delivered hot and fast.  The place is packed with aggressively conversing creatures regardless of the time of day or night.

You find a seat at one of the crowded tables to listen in on the conversation of the hour.

A server arrives with a tray of cups and a steaming pot of fresh coffee.

[[Buy a Cup of Coffee]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="754" name="Dig Site #1" tags="southquarry bookmark location tick" position="5544,4633" size="100,100">The area is roped off, preventing the extremely clumsy or dispossessed from falling into a vast, eerily regular crater.

A crew of uniformed workers make continuous lines into and out of the crater, down a series of steps and rungs cut into the living stone.  They carry down picks, ropes, and wands and come out with enormous treasures.

Vast winches reach down into the crater&#39;s yawning guts and pull up impossibly large gemstones, vaults, enchanted artifacts, amphorae.

(display: &quot;QuickChar&quot;)

The yard leader for the current shift approaches you.

&quot;You look like the kind of person who&#39;s looking to make an investment,&quot; they say. &quot;You can finance a dig and get a percentage on the return.&quot;

They trace a line around the perfectly square-edge portal that leads to a universe made entirely out of rock and treasure.  You&#39;ve heard of these kinds of deals:
You put up the money for a crew and their supplies.
You negotiate how long they will spend mining before returning.
The crew will use their tools to dig as much as they can.
Some crews are careful, some are reckless.
They might encounter monsters, traps, lava, poison gas, etc.  So, you may be asked to pay more to keep the dig going.
You can visit the dig site, but doing so is time-consuming and potentially dangerous.

(if: $miningCommand &gt; 0)[
[[Visit Your Dig Site #1 Lease]]]
(else:)[
[[Finance a Dig at Site #1]]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="755" name="Finance a Dig at Site #1" tags="" position="5547,4743" size="100,100">The industry is pretty well standardized for this kind of operation.
You buy at a certain gold price.
Your crew exhausts your gold mining through a sector of the portal you&#39;ve leased from the Portal Authority.
That portal lease comes right off the top.  The rest of the price is spent on supplies and insurance.

(link-reveal: &quot;Trial Plan&quot;)[(set: $portalSupplies to 100)
(set: $portalDistance to 0)
(set: $miningCommand to 10)
(set: $portalCrew to 10)
(set: $portalTreasure to 0)
(set: $currentDigSiteOneTick to $ticks)
[[Visit Your Dig Site #1 Lease]]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="756" name="Dig Site #2" tags="bookmark southquarry location tick" position="5526,5193" size="100,100">Near the portal at Dig Site #1 is another crater, this one much smaller.

(display: &quot;QuickChar&quot;)
The yard foreman points out that this area is centered at the edge of the portal.  The stone and materials regenerate more slowly, and tunneling through the rock here has opened up the Catacombs, a more or less permanent fixture at the edge of the portal.

&quot;You can more or less dig up whatever you want in this area.  It runs pretty dry.  Bring your own shovel, and you can dig all you want.&quot;
(set: $plotDepth to 0)
[[Start Digging-&gt;Dig Your Plot]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="757" name="The Southern Gate to Eastern Fortress" tags="southquarry bookmark tick easternfortress location unlisted" position="7070,4741" size="100,100">When the gates open, a cloud of incense and stone dust mix in the middle.

[[South Quarry]] 

[[Eastern Fortress]] 

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="758" name="Visit Your Dig Site #1 Lease" tags="" position="5546,4866" size="100,100">(set: $previousDigSiteOneTick to $currentDigSiteOneTick)
(set: $currentDigSiteOneTick to $ticks)
(set: _tickDiff to $currentDigSiteOneTick - $previousDigSiteOneTick)
It&#39;s been _tickDiff ticks since your last visit.
(set: $portalSupplies to it - _tickDiff)
You have $portalSupplies supplies left.
(set: _portalDistanceGained to _tickDiff * $portalCrew * (1+($miningCommand/10)))
You have gained _portalDistanceGained meters of distance into the living stone.
(set: $portalDistance to it + _portalDistanceGained)
For a total of $portalDistance meters.
(if: (random: 0, 1) &gt; 0)[(set: $miningCommand to it - 1)Your crew are annoyed at you for interrupting their work.](else:)[Your crew acknowledge your presence and go right back to their work.]
!Secret! Your current portalCommand is $miningCommand.
(set: _earnedIncome to (ceil: (random: 0, _portalDistanceGained)))
Your crew has gathered _earnedIncome kilograms of raw treasure boulders.
(set: $portalTreasure to it + _earnedIncome)
For a total of $portalTreasure currently in the hopper.

[[Empty Treasure Hopper]]

[[Resupply Crew]]

[[Bring the Crew Coffee and Doughnuts]]

[[Reprimand the Crew]]

[[Cancel the Dig]] 

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="759" name="Empty Treasure Hopper" tags="" position="5366,4884" size="100,100">Your crew has gathered $portalTreasure kilograms of raw treasure boulders.

You can pull a lever to convert $portalTreasure to gold in your pocket, but that means that your crew will not be mining for more treasure for the rest of the week, as they process your treasure ore.
(set: $arg to $portalTreasure * (random: 1, 10))(display: &quot;UpdateGold&quot;)
Treasure ore is made of all kinds of rubbish:
(for: each _i, ...(range: 0, (ceil: $portalTreasure / 100)))[
(display: &quot;Random Treasure Hopper Item&quot;)]
(if: $portalDistanceBonus &gt; 0)[Distance Bonus Paid: (ceil: $portalDistance * $portalDistanceBonus)(set: $gold to it - (ceil: $portalDistance * $portalDistanceBonus))]
(set: $portalTreasure to 0)(display: &quot;UpdateClock&quot;)

Total Gold: $gold

[[Resupply Crew]]

[[Bring the Crew Coffee and Doughnuts]]

[[Reprimand the Crew]]

[[Cancel the Dig]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="760" name="Resupply Crew" tags="" position="5351,5027" size="100,100">You are negotiating with the lead of your crew.  They have certain expectations based on their own sense of worth.
(if: $gold &gt;= 1000)[
(link-reveal: &quot;Extend Contract for 1000 Gold&quot;)[
(set: $portalSupplies to 100)
(set: $miningCommand to it + (random: 0, 1))
(set: $arg to -1000)(display: &quot;UpdateGold&quot;)
!SECRET! $miningCommand
]]

[[Empty Treasure Hopper]] 

[[Bring the Crew Coffee and Doughnuts]]

[[Reprimand the Crew]]

[[Cancel the Dig]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="761" name="Bring the Crew Coffee and Doughnuts" tags="" position="5699,5015" size="100,100">You order your crew their favorite stimulants and hypercaloric food stuffs.
(set: $gold to it - 20)&lt;b&gt;Gold - 20&lt;b/&gt;
(if: $miningCommand &lt;= 0)[They wait until after you&#39;ve started to leave before they eat them. (set: $miningCommand to it - (random: 0, 1))]
(else-if: $miningCommand &lt;=5)[They appreciate the effort you put in to show your appreciation of them. (set: $miningCommand to it + (random: 0, 1))]
(else-if: $miningCommand &lt; 10)[Your crew enthusiastically grabs doughnuts and coffee from you.  One of them even attempts an awkward high-five before realizing that you are not the kind of person who &quot;highs five&quot;.(set: $miningCommand to it + (either: ...(range: 0,2)))]
(else:)[They are too busy working to even notice you stopping by.]
!SECRET! $miningCommand

[[Empty Treasure Hopper]]

[[Resupply Crew]]

[[Reprimand the Crew]]

[[Cancel the Dig]] 

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="762" name="Reprimand the Crew" tags="" position="5537,5028" size="100,100">If you reprimand a crew that is low in morale, they may quit, but your command level will possibly increase for the remaining crew.

(if: (random: 0, $miningCommand) &lt; 2)[The crew feel like your rebuke was stern but fair.  They are a little more confident in your command.(set: $miningCommand to it + (random: 1, 2))]
(else:)[The crew feels like your rebuke was unfair and slanderous.
(set: $miningCommand to it - (random: 1, 2))]

!SECRET! $miningCommand
(if: $miningCommand &gt; 0)[
(set: _walkouts to (ceil: (random: 0, $portalCrew) / $miningCommand))
_walkouts crew members have decided it is time for them to leave the project.
(set: $portalCrew to it - _walkouts)]
(else:)[Too much or too little, but definitely too late.  Regardless of your words, all $portalCrew have walked out on you.
(set: $portalCrew to 0)
]
 Crew: $portalCrew
 
[[Empty Treasure Hopper]]

[[Resupply Crew]]

[[Bring the Crew Coffee and Doughnuts]]

[[Reprimand the Crew]]

[[Cancel the Dig]] 

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="763" name="Random Treasure Hopper Item" tags="" position="5371,4764" size="100,100">(either: &quot;A golden helmet with wings&quot;, &quot;a ruby the size of a canteloupe...  no, I mean an antelope&quot;, &quot;dragon bones&quot;, &quot;gold bricks&quot;, &quot;ancient pottery&quot;, &quot;sand dollars&quot;, &quot;totems&quot;, &quot;abstract sculpture&quot;)</tw-passagedata><tw-passagedata pid="764" name="Cancel the Dig" tags="" position="5704,4869" size="100,100">You call off the dig.

(set: $portalSupplies to 0)
(set: $portalDistance to 0)
(set: $miningCommand to 0)
(set: $portalCrew to 0)
(set: $portalTreasure to 0)
(set: $currentDigSiteOneTick to 0)

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="765" name="Encounter: Falling Rock!" tags="event southquarry" position="4974,4965" size="100,100">(if: $perception &gt; 3)[You see a section of rock teetering above you and are able to get out of the way before it hits you.](else:)[You don&#39;t see the rock falling in time to get out of the way.

(if: (random: 0, 1) is 0)[Sharp, heavy rock rains down on you.

(set: $deathReason to &quot;You were obliterated by a combination of bad safety protocol and tons and tons of megaliths precariously stacked around the neighborhood.&quot;)(set: $arg to 1)(display: &quot;TakeDamage&quot;)]

[[Next Encounter]] ]
(else:)
[
You are clouted on the head, causing you to stagger down a blind alley.

[[Staggering Through The Alleys]] 
]</tw-passagedata><tw-passagedata pid="766" name="Dig Your Plot" tags="tick" position="5512,5349" size="100,100">You dig and...
(set: _roll to (random: 1, 4))
(if: _roll is 1)[find dirt.]
(else-if: _roll is 2)[find rocks.]
(else-if: _roll is 3)[(set: $plotDepth to it + 1)(if: (random: 0, $plotDepth) &gt; 9)[You&#39;ve found the [[Entrance to the Catacombs]] !](else:)[find dirt and rocks.]]
(else-if: _roll is 4)[find a little gold and gemstone.
(set: $arg to (random: 1, 20))(display: &quot;UpdateGold&quot;)]

[[Dig Your Plot]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="767" name="Cave-In!" tags="mining-incident" position="5846,4873" size="100,100">The mines cave-in, injuring your crew.</tw-passagedata><tw-passagedata pid="768" name="Markov&#39;s Munitions" tags="location southquarry bookmark" position="5203,5358" size="100,100">(set: _cost to 150)
(for: each _item, &quot;Enchanted Flashlight&quot;, &quot;Blunderbuss&quot;)[
(display: &quot;QuickBuy&quot;)
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="769" name="Init South Quarry" tags="function" position="5168,4464" size="100,100">{(set: $environmentMaterials to (a: &quot;stone&quot;, &quot;brick&quot;, &quot;charcoal&quot;, &quot;cinderbrine&quot;, &quot;obsidian&quot;, &quot;flagstone&quot;, &quot;cobble&quot;, &quot;chalk&quot;))
(set: $environmentColors to (a: &quot;white&quot;, &quot;tan&quot;, &quot;black&quot;, &quot;gray&quot;))
(set: $clothingMaterials to (a: &quot;fur&quot;, &quot;felt&quot;, &quot;linen&quot;, &quot;rag&quot;, &quot;metal plate&quot;, &quot;leather&quot;))
(set: $clothingColors to (a: &quot;brown&quot;, &quot;black&quot;, &quot;dun&quot;, &quot;gray&quot;,  &quot;yellowed&quot;))
(set: $clothingTypes to (a: &quot;kilt&quot;, &quot;apron&quot;, &quot;loincloth&quot;, &quot;girdle&quot;, &quot;three-piece suit&quot;, &quot;coveralls&quot;, &quot;one-piece&quot;))
(set: $adornmentMaterials to (a: &quot;bone&quot;, &quot;shell&quot;, &quot;copper&quot;, &quot;clay&quot;, &quot;gold&quot;, &quot;silver&quot;, &quot;citrine&quot;, &quot;iron&quot;, &quot;bronze&quot;, &quot;brass&quot;))
(set: $adornmentTypes to (a: &quot;plate&quot;, &quot;plug&quot;, &quot;tusk&quot;, &quot;ring&quot;, &quot;stud&quot;))
(set: $hairstyles to (a: &quot;a shaven scalp&quot;, &quot;a bald pate&quot;, &quot;shaven sides and spiked top&quot;, &quot;long dreadlocks&quot;, &quot;long bangs&quot;, &quot;a lacquered headdress&quot;, &quot;a shaggy mane&quot;))

(set: $sizes to (a: &quot;grand&quot;, &quot;stout&quot;, &quot;scrawny&quot;, &quot;burly&quot;, &quot;rotund&quot;, &quot;gaunt&quot;, &quot;obese&quot;, &quot;muscular&quot;, &quot;sculpted&quot;))
(set: $genders to (a: &quot;man&quot;, &quot;woman&quot;, &quot;non&quot;, &quot;herm&quot;))
(set: $races to (a: &quot;human&quot;, &quot;gnome&quot;, &quot;daemonkin&quot;, &quot;changeling&quot;, &quot;golem&quot;, &quot;mekannin&quot;))
(set: $skinColors to (a: &quot;black&quot;, &quot;tan&quot;, &quot;brown&quot;, &quot;red&quot;, &quot;gray&quot;, &quot;white&quot;,&quot;pink&quot;))
(set: $skinTypes to (a: &quot;smooth&quot;, &quot;lightly furred&quot;, &quot;fur-covered&quot;, &quot;scaled&quot;, &quot;faceted&quot;))
(set: $professions to (a: &quot;soldier&quot;, &quot;thief&quot;, &quot;ragpicker&quot;, &quot;sineater&quot;, &quot;cursekeeper&quot;, &quot;prostitute&quot;, &quot;thug&quot;, &quot;miner&quot;, &quot;alckymist&quot;, &quot;blacksmith&quot;,&quot;gemcutter&quot;,&quot;engineer&quot;))
}
{(set: $neighborhood to 
(dm: &quot;name&quot;, &quot;South Quarry&quot;, 
&quot;tagname&quot;, &quot;southquarry&quot;,
	&quot;locations&quot;, (altered: _item via _item&#39;s name, ...(find: _item where _item&#39;s tags contains all of (a: &quot;southquarry&quot;, &quot;location&quot;), ...(passages:))),
&quot;contracts&quot;, (altered: _item via _item&#39;s name, ...(find: _item where _item&#39;s tags contains all of (a: &quot;southquarry&quot;, &quot;contract&quot;), ...(passages:))),
		&quot;events&quot;, (altered: _item via _item&#39;s name, ...(find: _item where _item&#39;s tags contains all of (a: &quot;southquarry&quot;, &quot;event&quot;), ...(passages:)))))
		
(if: (history:) contains &quot;Trove: Join the Goblins&quot;)
[
(if: $inventory contains any of (a: &quot;Mark of the Goblins Lvl 1&quot;))[
(set: $neighborhood&#39;s events to $neighborhood&#39;s events + (a: &quot;Encounter: A Friendly Goblin&quot;))
]
(else:)[
(set: $neighborhood&#39;s events to $neighborhood&#39;s events + (a: &quot;Encounter: An Angry Goblin&quot;))
]
]
		}</tw-passagedata><tw-passagedata pid="770" name="Garagalg&#39;s Glint" tags="location southquarry bookmark" position="5204,5472" size="100,100">Garagalg is a fairly enormous elemental creature made of stone inlayed with precious stones.  They are continuously replacing stones with superior specimens.

(if: not ($requests contains &quot;Garagalg&quot;))[
// Initializing Garagalg //
(set: $requests to it + (dm: &quot;Garagalg&quot;, (either: &quot;Damage Ward&quot;, &quot;Ex Nobilis Aetherium&quot;, &quot;Crystal Prism&quot;)))
]
Garagalg is currently looking for (print: $requests&#39;s &quot;Garagalg&quot;).
(if: $inventory contains $requests&#39;s &quot;Garagalg&quot;)[
You happen to have one of those.  Would you be willing to part with it for 150 gold?
(link-reveal: &quot;Sell It&quot;)[
(set: $arg to $requests&#39;s &quot;Garagalg&quot;)(display: &quot;LoseItem&quot;)
(set: $arg to 150)(display: &quot;UpdateGold&quot;)
(set: $requests&#39;s &quot;Garagalg&quot; to (either: &quot;Damage Ward&quot;, &quot;Ex Nobilis Aetherium&quot;, &quot;Crystal Prism&quot;))
]]

//Trade treasure for better treasure//
(set: $arg to &quot;Macro Caster&quot;)(display: &quot;GetItem&quot;)

//Buy rare materials//

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="771" name="Umber Gorr" tags="southquarry persona" position="5206,5602" size="100,100">Umber is a gnome, an earth elemental.


You can be digging along, finding plenty of gold, when bam, goblins all up in your business!  Don&#39;t know where they come from.  They&#39;re always found in impossible bubbles of tunnels deep under the surface.  No way hominids could develop in those conditions.  Worst of all is that one time, an old salt told me that a feller they lost to a goblin raid was seen again, years later, living with the goblins, and he helped the goblins attack!

Oh, you should head right over to Dig Site #2 if you&#39;re new to all of this kind of business.  You can put in an honest days work, and if you&#39;re lucky, you&#39;ll go home with a tidy sum.

Well, someone in your tax bracket could fund a dig over at Dig Site #3.  They&#39;re always looking for venture capital.

I&#39;m sure your competitors wouldn&#39;t tell you this, but here&#39;s how to upgrade your mining equipment for maximum efficiency.

If you&#39;re like me, you&#39;ve been in the mining game so long, there aren&#39;t any more surprises.  But, I still want a constant flow of money.  That&#39;s why I mine through Dig Site #1.</tw-passagedata><tw-passagedata pid="772" name="Dig Site #3" tags="location southquarry tick bookmark" position="5162,6848" size="100,100">This dig site is a hive of activity for workers and wizards alike.

(if: $reputation&#39;s (&quot;House Guild Mechanika&quot;) &gt; 0)[The House Guild Meckanicka has spread their mechanical technology all over the place, ostensibly making it a more efficient operation.]
(if: $miningCommand &lt;= 0)[
[[Start A New Dig]]
]
(else:)[

[[Cancel The Dig-&gt;Dig Cancelled]]

[[Visit The Dig]]
]


// debug //
(link-repeat: &quot;TickMining&quot;)[(display: &quot;TickMining&quot;)]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="773" name="Start A New Dig" tags="" position="5159,7078" size="100,100">|input&gt;[
(link-reveal: &quot;Trial Plan - 1 gold&quot;)[(replace:?input)[
(set: $miningCommand to 1)
(set: $miningCrew to 1)
(set: $miningWage to 1)
(set: $miningDistance to 0)
(set: $miningDanger to 1)

(set: $miningGoldYieldRate to 0)
(set: $miningEvents to (a: &quot;Deeper We Dig...  But No Yield&quot;,
&quot;Deeper We Dig...  But No Yield&quot;,
&quot;Deeper We Dig...  But No Yield&quot;,
&quot;Deeper We Dig...  But No Yield&quot;,
&quot;Deeper We Dig...  With Some Yield&quot;))
(display: &quot;TickMining&quot;)
[[Visit The Dig]]
]]

(link-reveal: &quot;Standard Plan - 80 gold&quot;)[(replace:?input)[
(set: $miningCommand to 5)
(set: $miningCrew to 20)
(set: $miningWage to 4)
(set: $miningDistance to 0)
(set: $miningDanger to 3)
(set: $miningGoldYieldRate to 0)
(set: $miningEvents to (a: &quot;Deeper We Dig...  But No Yield&quot;,
&quot;Deeper We Dig...  But No Yield&quot;,
&quot;Deeper We Dig...  With Some Yield&quot;))
(display: &quot;TickMining&quot;)
[[Visit The Dig]]
]]

(link-reveal: &quot;Premium Plan - 1600 gold&quot;)[(replace:?input)[
(set: $miningDanger to 1)
(set: $miningCommand to 10)
(set: $miningCrew to 100)
(set: $miningWage to 16)
(set: $miningDistance to 0)
(set: $miningGoldYieldRate to 0)
(set: $miningEvents to (a: &quot;Deeper We Dig...  But No Yield&quot;,
&quot;Deeper We Dig...  With Some Yield&quot;, 
&quot;Deeper We Dig...  And We Found A Vein!&quot;))
(display: &quot;TickMining&quot;)
[[Visit The Dig]]]]
]

[[Dig Site #3]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="774" name="Visit The Dig" tags="" position="5321,7026" size="100,100">(if: $miningEvent != &quot;&quot;)[
(goto: $miningEvent)]
(else:)
[
The workers are milling about the entrance to the mine: some entering, some leaving, with the fruit of their labor piling up in heaps near the refinery.
]

[[Dig Site #3]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="775" name="Deeper We Dig...  But No Yield" tags="mining-status" position="5519,6945" size="100,100">(if: (passage:)&#39;s name is not &quot;Deeper We Dig...  But No Yield&quot;)
[
(set: $miningGoldYieldRate to 0)
(set: $miningEvents to (a: &quot;Deeper We Dig...  But No Yield&quot;,
&quot;Deeper We Dig...  But No Yield&quot;,
&quot;Deeper We Dig...  But No Yield&quot;,
&quot;Deeper We Dig...  But No Yield&quot;,
&quot;Trove Discovered&quot;,
&quot;Deeper We Dig...  With Some Yield&quot;))
(set: $miningDistance to it + 1)
(set: $miningEvents to it + (repeated: $miningDistance / 10, &quot;We Dug Too Deep&quot;))


]
(else:)
[
This patch of earth appears barren of the materials you are after:
No gold, no ore, no coal.

Only loose dirt and flawed lumps of silicates are to be found in this accursed patch.

Your stalwart crew continues to strain against the yoke to go deeper and deeper in an effort to find treasure.

]

[[Dig Site #3]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="776" name="Deeper We Dig...  With Some Yield" tags="mining-status" position="5749,6941" size="100,100">(if: (passage:)&#39;s name is not &quot;Deeper We Dig...  With Some Yield&quot;)
[
(set: $miningGoldYieldRate to 1)
(set: $miningEvents to (a: &quot;Deeper We Dig...  But No Yield&quot;,
&quot;Deeper We Dig...  With Some Yield&quot;,
&quot;Deeper We Dig...  With Some Yield&quot;,
&quot;Deeper We Dig...  And We Found A Vein!&quot;
))
(set: $miningDistance to it + 1)

]
(else:)
[
The crew has encountered a patch of dirt that yields up some fine powder of gold.

Your stalwart crew continues to strain against the yoke to go deeper and deeper in an effort to find greater treasure.

[[Dig Site #3]]

(display: &quot;NavOptions&quot;)
]</tw-passagedata><tw-passagedata pid="777" name="Deeper We Dig...  And We Found A Vein!" tags="mining-status" position="5633,6936" size="100,100">(if: (passage:)&#39;s name is not &quot;Deeper We Dig...  And We Found A Vein!&quot;)
[
(set: $miningGoldYieldRate to 5)
(set: $miningEvents to (a: &quot;Working The Vein&quot;, &quot;Working The Vein&quot;))
(set: $miningDistance to it + 1)
(set: $miningCommand to it + 1)
]
(else:)
[
The crew has encountered a vein of gold with enviable purity.

Your stalwart crew continues to strain against the yoke to go deeper and deeper in an effort to find greater treasure.

]
[[Dig Site #3]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="778" name="Working The Vein" tags="mining-status" position="5861,6941" size="100,100">(if: (passage:)&#39;s name is not &quot;Working The Vein&quot;)
[
(set: $miningGoldYieldRate to 10)
(set: $miningEvents to (a: &quot;Working The Vein&quot;,
&quot;Deeper We Dig...  With Some Yield&quot;))
(set: $miningDistance to it + 1)

]
(else:)
[The vein has begun to yield up great chunks of precious metals.

[[Dig Site #3]]

(display: &quot;NavOptions&quot;)
]</tw-passagedata><tw-passagedata pid="779" name="Cave-In" tags="mining-status" position="5447,7076" size="100,100">(if: (passage:)&#39;s name is not &quot;Cave-In&quot;)
[
// Send mail //
(set: $miningEvents to (a: &quot;Digging Out The Cave-In&quot;, &quot;Digging Out The Cave-In&quot;))
(set: $miningGoldYieldRate to 0)
(set: $miningDanger to it + 1)
(set: $miningCrew to it - (random: 0, 2))
(set: $mail to it + (a:
(dm: &quot;sender&quot;, &quot;Dig Site #3&quot;,
     &quot;message&quot;, &quot;A cave-in has injured some workers.  Work has halted until they have been rescued from beneath the rocks.&quot;,
	 &quot;attachment&quot;, &quot;Nothing&quot;
)
))
]
(else:)
[During excavation, the rocks forming the wall and ceiling of a branch have become unstable.

All work has ceased until the crew have been dug out.

(if: $daemons contains &quot;Gnome&quot;)[
(display: &quot;Have Your Gnome Clean Up The Cave-In&quot;)
]

|input&gt;[
[[Threaten to Fire Them If They Don&#39;t Continue Working-&gt;Disgruntlement]]
]
[[Dig Site #3]]

(display: &quot;NavOptions&quot;)
]</tw-passagedata><tw-passagedata pid="780" name="Gas Leak" tags="mining-status" position="5587,7077" size="100,100">(if: (passage:)&#39;s name is not &quot;Gas Leak&quot;)
[(set: $miningEvents to (a: ))
(set: $miningGoldYieldRate to 0)
(set: $miningDanger to it + 1)
// Send mail //
(set: $mail to it + (a:
(dm: &quot;sender&quot;, &quot;Dig Site #3&quot;,
     &quot;message&quot;, &quot;A gas leak has flooded the tunnels, making it unsafe to work.  Work has halted until we receive your instructions in person.&quot;,
	 &quot;attachment&quot;, &quot;Nothing&quot;
)
))
]
(else:)
[Flammable, noxious gasses have flooded the shafts, leading to a complete work stoppage.

(if: $gold &gt; 500)[// Safe, expensive solution //
(link-reveal: &quot;Spend Money To Fix Problem&quot;)[
(set: $arg to -500)(display: &quot;UpdateGold&quot;)
You shell out a significant sum of lucre for a combination of contraption work and wind spirits to purify the air in your mine.
(set: $miningEvent to &quot;Deeper We Dig...  But No Yield&quot;)
]]

(if: $inventory contains &quot;Infernal Lens&quot; or $daemons contains &quot;Fire Ghost&quot;)[
// Dangerous, cheap solution -&gt; Potentially Injure yourself and/or crew //
(link-reveal: &quot;What If We Burn the Gas?!&quot;)[
Hark, y&#39;all, and witness this tomfoolery!  You hand your drink to a dumbstruck worker and use flame to detonate the gas.

(if: (random: 0, $cunning) &gt; 4)[All of the flammable gas ignites with a satisfying WOOMP.  A few of your crew were standing too close without the proper precautions and have lost some eyebrows.
(set: $miningEvent to &quot;Deeper We Dig...  But No Yield&quot;)

]
(else:)[
With a hellish crack, the gas detonates, sending rock and raw fragments of support beams through your group like Satan&#39;s blunderbuss!

(set: $miningCommand to (floor: it / 2))
(set: $miningCrew to (floor: it / 2))
(set: $deathReason to &quot;With a hellish crack, the gas detonates, sending rock and raw fragments of support beams through your group like Satan&#39;s blunderbuss!
You are torn to shreds in the ensuing chaos.&quot;)
(set: $arg to (random: 0, 3))(display: &quot;TakeDamage&quot;)
(set: $miningEvents to (a: &quot;Cave-In&quot;, &quot;Deeper We Dig...  But No Yield&quot;))
]
]]

[[Threaten to Fire Them If They Don&#39;t Continue Working-&gt;Disgruntlement]]
]

[[Dig Site #3]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="781" name="We Dug Too Deep" tags="mining-status" position="5729,7072" size="100,100">(if: (passage:)&#39;s name is not &quot;We Dug Too Deep&quot;)
[
// Send mail //
(set: $miningGoldYieldRate to 0)
(set: $miningEvents to (a:
&quot;Cave-In&quot;,
&quot;Gas Leak&quot;,
&quot;Monster Attack&quot;,
&quot;Deeper We Dig...  And We Found A Vein!&quot;,
&quot;Deeper We Dig...  And We Found A Vein!&quot;,
&quot;Deeper We Dig...  With Some Yield&quot;,
&quot;Deeper We Dig...  But No Yield&quot;

))
(set: $miningDistance to it + 10)
(set: $miningDanger to it + 2)
(set: $mail to it + (a:
(dm: &quot;sender&quot;, &quot;Dig Site #3&quot;,
     &quot;message&quot;, &quot;We regret to inform you that we encountered Elder Wards during today&#39;s excavation.  Usually, we explicitly avoid them, but in this case, a worker unfortunately desecrated them with a pickaxe, angering the Deep Spirits.&quot;,
	 &quot;attachment&quot;, &quot;Nothing&quot;
)
))
]
(else:)
[Your crew is quite concerned that they have dug too deep into the living stone and fear retribution from whatever lives below.
]
[[Dig Site #3]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="782" name="Union Dues" tags="mining-status" position="5558,7348" size="100,100">(if: (passage:)&#39;s name is not &quot;Union Dues&quot;)
[
// Send mail //
(set: $mail to it + (a:
(dm: &quot;sender&quot;, &quot;Dig Site #3&quot;,
     &quot;message&quot;, &quot;It&#39;s a list of demands from your workers&#39; union.  They want to meet and negotiate.&quot;,
	 &quot;attachment&quot;, &quot;Nothing&quot;
)
))
(set: $miningEvents to (a: ))
(set: $miningGoldYieldRate to 0)
]
(else:)
[
(set: _desiredRaise to (floor: $miningWage * ($miningDanger/10)))
// Increase their wages to include a higher percentage of profits and hazard pay //
(link-reveal: &quot;Increase Wages to &quot; + (str: $miningWage + _desiredRaise))[
(set: $miningWage to it + _desiredRaise)
(set: $miningCommand to it + 10)
The crew is pleased that you&#39;ve given in to their demands.
]
(link-reveal: &quot;Increase Wages to &quot; + (str: $miningWage + _desiredRaise/2))
[
(if: (random: 0, $miningCommand) &gt; 1)[
Considering your popularity, you are able to negotiate a better rate with your crew.
(set: $miningWage to it + _desiredRaise/2)
]
(else:)[(goto: &quot;Disgruntlement&quot;)]
]
[[No Raise-&gt;Disgruntlement]] 
]

[[Dig Site #3]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="783" name="Disgruntlement" tags="mining-status" position="5604,7228" size="100,100">{(set: $miningEvents to (a: &quot;Deeper We Dig...  But No Yield&quot;,
&quot;Deeper We Dig...  But No Yield&quot;,
&quot;Workers On Strike&quot;,
&quot;Workers On Strike&quot;,
&quot;Trove Discovered&quot;,
&quot;Deeper We Dig...  With Some Yield&quot;))
(set: $miningGoldYieldRate to it / 2)
(set: $miningCommand to it - 1)
}
The crew is unhappy, and their unhappiness is beginning to affect their work.

(if: $miningCommand &lt;= 0)
[(display: &quot;Dig Cancelled&quot;)]
(else-if: (random: 0, $miningCommand) &lt;= 0)
[(goto: &quot;Union Dues&quot;)]

[[Dig Site #3]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="784" name="Trove Discovered" tags="mining-status" position="5983,6928" size="100,100">(if: (passage:)&#39;s name is not &quot;Trove Discovered&quot;)
[
(set: $miningGoldYieldRate to 0)
(set: $miningEvents to (a: ))
(set: $miningDistance to it + 5)
(set: $miningCommand to it + 1)
// Send mail //
(set: $mail to it + (a:
(dm: &quot;sender&quot;, &quot;Dig Site #3&quot;,
     &quot;message&quot;, &quot;A trove has been uncovered.  Work has halted until we receive your instructions in person.&quot;,
	 &quot;attachment&quot;, &quot;Nothing&quot;
)
))
]
(else:)
[In among the precious materials, your crew has uncovered a trove of treasure suspended like a bubble in the living rock.

This is no mere nugget of gold, but the detritus of an ancient civilization, perhaps a tomb of a once-great emperor.

They have begun cataloging the site and await your arrival to choose the greatest among treasures for your personal collection.

They would also like you around just in case there are &quot;residents&quot;, like murderous spiders or barrow wights.

[[Seal Up The Trove]]

[[Enter the Trove]]

(display: &quot;NavOptions&quot;)
]</tw-passagedata><tw-passagedata pid="785" name="Dig Cancelled" tags="mining-status" position="5860,7225" size="100,100">// Send mail //
(set: $miningCommand to 0)
(set: $miningSupplies to 0)
(set: $miningDistance to 0)
(set: $miningCrew to 0)

(set: $miningGoldYieldRate to 0)
(set: $miningEvents to (a: ))
(set: $mail to it + (a:
(dm: &quot;sender&quot;, &quot;Dig Site #3&quot;,
     &quot;message&quot;, &quot;Your excavation project at Dig Site #3 is hereby cancelled.  All work has been halted.&quot;,
	 &quot;attachment&quot;, &quot;Indestructible Pickaxe&quot;
)
))

The dig has been cancelled.

[[Dig Site #3]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="786" name="Workers On Strike" tags="" position="5734,7224" size="100,100">// Send mail //
(set: $miningEvents to (a: &quot;Disgruntlement&quot;, &quot;Workers On Strike&quot;, &quot;Workers On Strike&quot;, &quot;Workers On Strike&quot;))
(set: $miningGoldYieldRate to 0)
(set: $miningCrew to it - (random: 0, 2))
(set: $mail to it + (a:
(dm: &quot;sender&quot;, &quot;Dig Site #3&quot;,
     &quot;message&quot;, &quot;It&#39;s a flyer for a general strike and demonstration by your crew at your mine.&quot;,
	 &quot;attachment&quot;, &quot;Nothing&quot;
)
))

Your mine is being actively picketed by your workers over slights both real and percieved, an unsafe work environment, and problems getting their wages on time and in the correct amounts.

(set: $arg to (random: 0, 1) + (random: 0, 1))
(display: &quot;LoseReputation&quot;)

[[Negotiate Contract-&gt;Union Dues]] 

[[Dig Site #3]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="787" name="TickMining" tags="function" position="5022,6852" size="100,100">{(set: _crewWages to $miningCrew * $miningWage)
(set: _profits to $miningCrew * (ceil: $miningGoldYieldRate * (1 + $reputation&#39;s (&quot;House Guild Mechanika&quot;)/10)))
(if: _profits + $gold &lt; _crewWages)
[(display: &quot;Disgruntlement&quot;)
(set: $gold to it + _profits)
]
(else:)
[
(set: $gold to it + _profits - _crewWages)
]
(if: $miningEvents&#39;s length &gt; 0)[(set: $miningEvent to (shuffled: ...$miningEvents)&#39;s 1st)
&lt;p style=&quot;display:none&quot;&gt;(display: $miningEvent)&lt;/p&gt; 
]

(if: $miningCommand &gt; 0 and $miningCrew &lt;= 0)[(goto: &quot;Dig Cancelled&quot;)]
(if: $miningCommand &gt; 0)[
// Send mail //
(set: $mail to it + (a:
(dm: &quot;sender&quot;, &quot;Dig Site #3&quot;,
     &quot;message&quot;, &quot;Invoice: [&quot;+(str: (floor: $ticks / 169))+&quot;:&quot;+(str: (floor: $ticks / 13 % 13))+&quot;:&quot;+(str: $ticks % 13)+&quot;] &quot; + (str: $miningGoldYieldRate) + &quot; GPH/Yield, &quot; + (str: $miningDistance) + &quot; MGMs/Depth, &quot; + (str: $miningEvent),
	 &quot;attachment&quot;, &quot;Nothing&quot;
)
))]
}</tw-passagedata><tw-passagedata pid="788" name="Digging Out The Cave-In" tags="" position="5460,7195" size="100,100">(if: (passage:)&#39;s name is not &quot;Digging Out The Cave-In&quot;)
[
(set: $miningEvents to (a: &quot;Digging Out The Cave-In&quot;, &quot;Digging Out The Cave-In&quot;, &quot;We Dug Too Deep&quot;, &quot;Cave-In&quot;, &quot;Deeper We Dig...  But No Yield&quot;))
(set: $miningGoldYieldRate to 0)
(set: $miningDanger to it + 0)
]
(else:)
[During excavation, the rocks forming the wall and ceiling of a branch have become unstable.

All work has ceased until the crew have been dug out.


(if: $daemons contains &quot;Gnome&quot;)[
(display: &quot;Have Your Gnome Clean Up The Cave-In&quot;)
]

[[Threaten to Fire Them If They Don&#39;t Continue Working-&gt;Disgruntlement]]

[[Dig Site #3]]

(display: &quot;NavOptions&quot;)
]</tw-passagedata><tw-passagedata pid="789" name="South Quarry Mines" tags="rumor" position="5548,6605" size="100,100">In South Quarry, you can mine to your heart&#39;s content...  infinitely deep mines of fabulous treasure!  We would definitely have infinite hyperinflation if it wasn&#39;t for the Accounting Wayes of the Ancient El-Dar.</tw-passagedata><tw-passagedata pid="790" name="Magisterium Local Office: South Quarry" tags="location unlisted southquarry" position="5206,5722" size="100,100">(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="791" name="Sylphian Archipelago" tags="location" position="6430,235" size="200,100">(display: &quot;Init Sylphian Archipelago&quot;)
Ancient towers of a buoyant stone converted into luxury apartments reminiscent of Venice.
Between Upper Castlerock and the four Main Neighborhoods.

You also see the ruins of Lower Castlerock, which was originally just called Castlerock until...  you know....  they built the upper one.

[[Lower Castlerock]]

[[North Harbor]]</tw-passagedata><tw-passagedata pid="792" name="Init Sylphian Archipelago" tags="function" position="6458,100" size="100,100">{(set: $environmentMaterials to (a: &quot;float stone&quot;, &quot;lift wood&quot;))
(set: $environmentColors to (a: &quot;white&quot;, &quot;yellow&quot;, &quot;ochre&quot;, &quot;gray&quot;))
(set: $clothingMaterials to (a: &quot;fur&quot;, &quot;hide&quot;, &quot;flaxen&quot;, &quot;hair&quot;))
(set: $clothingColors to (a: &quot;brown&quot;, &quot;black&quot;, &quot;gray&quot;, &quot;yellowed&quot;, &quot;dun&quot;,&quot;sunbleached&quot;))
(set: $clothingTypes to (a: &quot;loincloth&quot;, &quot;tunic&quot;, &quot;skirt&quot;, &quot;bracers&quot;))
(set: $adornmentMaterials to (a: &quot;leather&quot;, &quot;cord&quot;, &quot;beaded&quot;))
(set: $adornmentTypes to (a: &quot;earrings&quot;, &quot;bracelets&quot;, &quot;utility belt&quot;))
(set: $hairstyles to (a: &quot;a shaven scalp&quot;, &quot;a bald pate&quot;, &quot;mussed-up mane&quot;,&quot;a majestic crest&quot;))

(set: $sizes to (a: &quot;scrawny&quot;, &quot;rawboned&quot;))
(set: $races to (a: &quot;human&quot;, &quot;drake-kin&quot;, &quot;sylph&quot;, &quot;hawk-kin&quot;))
(set: $skinColors to (a: &quot;black&quot;, &quot;tan&quot;, &quot;brown&quot;, &quot;red&quot;, &quot;gray&quot;))
(set: $skinTypes to (a: &quot;smooth&quot;, &quot;lightly feathered&quot;, &quot;fur-covered&quot;, &quot;scaled&quot;))
(set: $professions to (a: &quot;sky pilot&quot;, &quot;street sweeper&quot;, &quot;messenger&quot;))
}
{(set: $neighborhood to 
(dm: &quot;name&quot;, &quot;Sylphian Archipelago&quot;, 
&quot;tagname&quot;, &quot;sylphianarchipelago&quot;,
	&quot;locations&quot;, (a:),
&quot;contracts&quot;, (a:),
		&quot;events&quot;, (a:)))}</tw-passagedata><tw-passagedata pid="793" name="Trove: Monster Attack" tags="mining-status" position="6195,7100" size="100,100">(if: (passage:)&#39;s name is not &quot;Monster Attack&quot;)
[(set: $miningEvents to (a: ))
(set: $miningGoldYieldRate to 0)
(set: $miningDanger to it + 5)
(set: $miningCrew to it - (random: 1, 3))
// Send mail //
(set: $mail to it + (a:
(dm: &quot;sender&quot;, &quot;Dig Site #3&quot;,
     &quot;message&quot;, &quot;Health &amp; Safety has shut down the dig site until you clear out a guardian beast infestation.&quot;,
	 &quot;attachment&quot;, &quot;Nothing&quot;
)
))
]
(else:)
[Something has begun picking off members of your crew!
They refuse to work until you fend off the creature.

// Fight with a guardian monster/daemon/automaton, etc. //
[[Slay The Beast In The Mines!]]


[[Seal off the Mine-&gt;Dig Cancelled]]
]</tw-passagedata><tw-passagedata pid="794" name="Slay The Beast In The Mines!" tags="" position="6319,7107" size="100,100">[[Trove: Army of the Dead]] 
[[Trove: Basilisk]] 
[[Trove: Blind Cave Serpent]] 
[[Trove: Giant Mechanical Homonculus]] 
[[Trove: Elder Gnome]] 
[[Trove: Sentient Arachnid]]</tw-passagedata><tw-passagedata pid="795" name="Seal Up The Trove" tags="" position="6078,6685" size="100,100">You order the foreman and a large portion of your crew to seal off the trove.

(set: $miningEvents to (a: &quot;Deeper We Dig...  But No Yield&quot;,
&quot;Deeper We Dig...  But No Yield&quot;,
&quot;Deeper We Dig...  But No Yield&quot;,
&quot;Deeper We Dig...  But No Yield&quot;,
&quot;Trove Discovered&quot;,
&quot;Deeper We Dig...  With Some Yield&quot;))
(display: &quot;TickMining&quot;)
(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="796" name="Enter the Trove" tags="" position="6286,6807" size="100,100">You set out with an expeditionary force of your most seasoned crew.
They wear sturdy mining helmets and padding quite like a suit of leather armor.  They are armed with pickaxes and shovels, with a demolitions expert also carrying various high explosives in a durable case.

// Random chance of encountering a monster //
[[Trove: Army of the Dead]]
[[Trove: Basilisk]]
[[Trove: Blind Cave Serpent]]
[[Trove: Giant Mechanical Homonculus]]
// Random chance of finding gold //
[[Trove: Gold Cache]]
// Random chance of finding items //
[[Trove: Treasure Cache]]
// Random chance of meeting a special encounter //
[[Trove: Shop Keeper]]
[[Trove: Elder Gnome]]
[[Trove: Sentient Arachnid]]
[[Trove: Goblin Chieftain]]</tw-passagedata><tw-passagedata pid="797" name="Trove: Army of the Dead" tags="" position="6209,7332" size="100,100">Each individual member of the army has weak, paper-like limbs, but their collective mass could trap and kill a living being and then recruit them into their ranks.</tw-passagedata><tw-passagedata pid="798" name="Trove: Basilisk" tags="" position="6203,7212" size="100,100">A single, small, ungainly creature in a dense hydra of tunnels.  A single touch will kill you.</tw-passagedata><tw-passagedata pid="799" name="Trove: Blind Cave Serpent" tags="" position="6454,7333" size="100,100">// Fight a creature that is a big damage sponge that rarely hits, but when it does, hits hard //</tw-passagedata><tw-passagedata pid="800" name="Trove: Giant Mechanical Homonculus" tags="" position="6323,7214" size="100,100">// The giant metal homonculus must either be fought (high health; hits for 1 each turn) or reprogrammed/sabotaged //</tw-passagedata><tw-passagedata pid="801" name="Trove: Gold Cache" tags="" position="6619,7110" size="100,100">(set: _value to (random: 1, 10) * 100)
(set: $gold to it + _value)
You find a random amount (~_value coins worth) of gold in a (either: &quot;small&quot;, &quot;large&quot;) (either: &quot;chest&quot;, &quot;barrel&quot;, &quot;heap&quot;)

[[Seal Up The Trove]]

[[Dig Site #3]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="802" name="Trove: Treasure Cache" tags="" position="6612,7222" size="100,100">You see a pile of treasure.  It is cleverly trapped such that you may only take one item, and the rest will be pulverised under an enormous stone hammer.  Not sure why the Ancients thought that was a good idea, but you play the hand you&#39;re dealt.

|input&gt;[
(for: each _item, ...(shuffled: ...(find: _i where _i&#39;s tags contains &quot;item&quot;, ...(passages:)))&#39;s (range: 1,3))[
(set: _chosen to _item)(link-reveal: _item)[(replace:?input)[(set: $arg to _chosen)(display: &quot;GetItem&quot;)
]]]]

[[Seal Up The Trove]]

[[Dig Site #3]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="803" name="Trove: Shop Keeper" tags="" position="6630,6978" size="100,100">A strange, wizened creature in a hooded robe sits on a threadbare flying carpet arrayed with items for sale.

// Stuff for Sale //

[[Seal Up The Trove]]

[[Dig Site #3]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="804" name="Trove: Elder Gnome" tags="" position="6327,7334" size="100,100">This creature of animated earth was asleep.
50% of big fight.
50% you agree to dig around it, and it returns to sleep.</tw-passagedata><tw-passagedata pid="805" name="Trove: Sentient Arachnid" tags="" position="6445,7222" size="100,100">50% chance of a fight
25% chance you are poisoned and trapped in a web
25% chance you can talk your way out of it</tw-passagedata><tw-passagedata pid="806" name="Trove: Goblin Chieftain" tags="" position="6530,6690" size="100,100">Goblins are curious folk.  Once completely human, they willingly joined or were abducted into a goblish tribe.  Through a series of rituals and surgeries, they are slowly converted into a goblin.  It is thought to be an irreversible process, but it is hard to say, as no one has ever willingly left a goblin tribe once they joined.

Each tribe has their own aesthetic, ranging from &quot;basically humans but with pointy ears and teeth&quot; to &quot;absolutely speciated underdweller&quot;.  They have no sense of personal property, so they may steal items from you.

You make contact with the local tribe&#39;s chieftain, a (either: &quot;old&quot;, &quot;middle-aged&quot;, &quot;surprisingly young&quot;) intersexed member furthest along in the direction of the local&#39;s aesthetic.

(either: &quot;They are still obviously human in origin.&quot;,
&quot;They are halfway between human and goblin states, belonging still to both worlds.&quot;,
&quot;If you did not know that goblins are a transpeciated human, you wouldn&#39;t believe that the creature had come from your kind.&quot;)

(either: &quot;This local group goes in for large jewelry.  Earlobes, nostrils, lips, random patches of flesh, all sporting thick plugs and plates made from bone and quartz.&quot;,
&quot;This local group wears needles of titanium coated with psychoactive toad juices in their lips and septum.  Chains hang from their earlobes.  They file their teeth to points.&quot;,
&quot;They are positively covered in blue-black tattooes.  They start by tattooing the wrists, throat, and ankles.  As time passes, they have regular ritual tattooing.  The tattoos spread from the origin sites until the person is completely covered.  At this time, the sclera of their eyes will inexplicably turn black.&quot;,
&quot;Miniature horns erupt from their foreheads in various numbers: usually 2 or 4, but sometimes 1, 3, 7, 20!  The chieftain has a crown of nine horns shaped like kris blades.  Instead of incisors, they bear small curved tusks.&quot;,
&quot;They are assigned a color of edible fungus to eat, and they eat that fungus exclusively.  The nutritional content is about the same for any given mushroom, but the pigments convert the eater&#39;s skin a vivid blue, red, green, black in response.&quot;,
&quot;Vestigial wings have sprouted from their backs.  Most members have either fewer than the typical 5 fingers and toes or more and webbing between them all.  They mutilate their noses with a series of symmetrical cuts.&quot;)

Goblins and Wizards get along just fine.  This goblin is wielding a very powerful magical staff.

// You can be a dick and try to steal from the goblins, but they&#39;ll rush you and try to kill and eat you //
[[Trove: Steal the Goblin Chieftain&#39;s Staff]]

//  You can trade rumors and possibly get good items //
// Randomly lose items to the goblin tribe //
[[Trove: Hold Palaver With the Goblin Chieftain]]


// Become a Goblin //
[[Trove: Join the Goblins]]</tw-passagedata><tw-passagedata pid="807" name="Trove: Steal the Goblin Chieftain&#39;s Staff" tags="" position="6667,6831" size="100,100">You and the Goblin Chieftain hold palaver while the rest of the clan surrounds you.

Goblins, as a society, don&#39;t have a concept of personal property outside of the clan.

So, outsiders cannot steal from them, but they can steal from outsiders.

// Randomly lose item //

(if: $inventory contains any of (a: &quot;Mark of the Goblins Lvl 1&quot;, &quot;Mark of the Goblins Lvl 2&quot;, &quot;Mark of the Goblins Lvl 3&quot;))
[They gladly hand over their wand to a member of the tribe.  Use it for as long as you need it.
(set: $inventory to it + (either: &quot;Frozen Icicle&quot;, &quot;Warding Wand&quot;, &quot;Diadem of Digging&quot;))

[[Seal Up The Trove]]

[[Dig Site #3]]

(display: &quot;NavOptions&quot;)
](else:)
[
You are savagely attacked by the entire tribe.

[[Death]] 
]</tw-passagedata><tw-passagedata pid="808" name="Trove: Hold Palaver With the Goblin Chieftain" tags="" position="6647,6710" size="100,100">You and the Goblin Chieftain hold palaver while the rest of the clan surrounds you.

Goblins, as a society, don&#39;t have a concept of personal property outside of the clan.

So, outsiders cannot steal from them, but they can steal from outsiders.

// Randomly lose item //

(if: $inventory contains any of (a: &quot;Mark of the Goblin Lvl 1&quot;, &quot;Mark of the Goblin Lvl 2&quot;, &quot;Mark of the Goblin Lvl 3&quot;))
[
// Get goblin rumors //
](else:)
[
// Get normal rumors //
]

[[Seal Up The Trove]]

[[Dig Site #3]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="809" name="Trove: Join the Goblins" tags="" position="6647,6600" size="100,100">(set: $inventory to it + (ds: &quot;Mark of the Goblins Lvl 1&quot;))
The process is horrifically painful, but once it is complete, you are an honorary member of the tribe.  They understand that you have a life in the greater world, they just ask that you come by to visit every now and then.

[[Seal Up The Trove]]

[[Dig Site #3]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="810" name="Have Your Gnome Clean Up The Cave-In" tags="" position="5323,7199" size="100,100">You so happen to have a wee daemon who especially excels at digging.
(link-reveal: &quot;Have Your Gnome Clean Up The Cave-In&quot;)[(replace:?input)[]
(set: $miningEvent to &quot;Deeper We Dig...  With Some Yield&quot;)
(display: &quot;TickMining&quot;)
The Gnome quickly restores the tunnel to excellent condition, freeing all of the trapped crew.
(if: (random: 0, 1) &gt; 0)[It scarpers right afterwards, feeling like it did its job properly. (set: $arg to &quot;Gnome&quot;)(display: &quot;LoseDaemon&quot;)]
(else:)[You manage to herd it right back into the Soul Jar after it performed its work.]
]</tw-passagedata><tw-passagedata pid="811" name="Init Upper Castlerock" tags="function" position="7640,289" size="100,100">{(set: $environmentMaterials to (a: &quot;stone&quot;, &quot;brick&quot;, &quot;mahogany&quot;, &quot;marble&quot;, &quot;gold-veined quartz&quot;, &quot;ivory&quot;, &quot;ebony&quot;, &quot;raw glass&quot;))
(set: $environmentColors to (a: &quot;white&quot;, &quot;blue&quot;, &quot;emerald green&quot;, &quot;black&quot;, &quot;gold-leafed&quot;))
(set: $clothingMaterials to (a: &quot;leather&quot;, &quot;linen&quot;, &quot;cotton&quot;, &quot;fleece&quot;, &quot;down&quot;, &quot;tailfeather&quot;))
(set: $clothingColors to (a: &quot;tan&quot;, &quot;white&quot;, &quot;cyan&quot;, &quot;golden&quot;, &quot;black&quot;))
(set: $clothingTypes to (a: &quot;tabard&quot;, &quot;toga&quot;, &quot;dressing gown&quot;, &quot;uniform&quot;, &quot;evening dress&quot;, &quot;gown&quot;, &quot;pant suit&quot;, &quot;girdle&quot;))
(set: $adornmentMaterials to (a: &quot;ivory&quot;, &quot;gold&quot;, &quot;silver&quot;, &quot;pearl&quot;, &quot;gold&quot;, &quot;silver&quot;, &quot;sapphire&quot;, &quot;platinum&quot;, &quot;ebony&quot;, &quot;lead&quot;))
(set: $adornmentTypes to (a: &quot;spool&quot;, &quot;ring&quot;, &quot;stud&quot;, &quot;implant&quot;))
(set: $hairstyles to (a: &quot;a shaven scalp&quot;, &quot;a tonsured pate&quot;, &quot;a short bob&quot;, &quot;an elegant braid&quot;, &quot;waist-length locks&quot;, &quot;a lacquered headdress&quot;, &quot;a shaggy mane&quot;))

(set: $sizes to (a: &quot;grand&quot;, &quot;stout&quot;, &quot;muscular&quot;, &quot;sculpted&quot;, &quot;slender&quot;, &quot;twisted&quot;))
(set: $genders to (a: &quot;man&quot;, &quot;woman&quot;, &quot;non&quot;, &quot;herm&quot;))
(set: $races to (a: &quot;human&quot;, &quot;sylph&quot;, &quot;daemonkin&quot;, &quot;changeling&quot;, &quot;angelic&quot;, &quot;mekannin&quot;, &quot;archdaemon&quot;))
(set: $skinColors to (a: &quot;black&quot;, &quot;blue&quot;, &quot;green&quot;, &quot;golden&quot;, &quot;tan&quot;, &quot;brown&quot;, &quot;red&quot;, &quot;gray&quot;))
(set: $skinTypes to (a: &quot;smooth&quot;, &quot;lightly furred&quot;, &quot;fur-covered&quot;, &quot;scaled&quot;, &quot;lightly feathered&quot;))
(set: $professions to (a: &quot;soldier&quot;, &quot;courtesan&quot;, &quot;clerk&quot;, &quot;beaureaucrat&quot;, &quot;cursekeeper&quot;, &quot;accountant&quot;, &quot;reformed thug&quot;, &quot;student&quot;, &quot;bodyguard&quot;, &quot;minor noble&quot;))
(set: $neighborhood to 
(dm: &quot;name&quot;, &quot;Upper Castlerock&quot;, 
&quot;tagname&quot;, &quot;uppercastlerock&quot;,
	&quot;locations&quot;, (altered: _item via _item&#39;s name, ...(find: _item where _item&#39;s tags contains all of (a: &quot;uppercastlerock&quot;, &quot;location&quot;), ...(passages:))),
&quot;contracts&quot;, (altered: _item via _item&#39;s name, ...(find: _item where _item&#39;s tags contains all of (a: &quot;uppercastlerock&quot;, &quot;contract&quot;), ...(passages:))),
		&quot;events&quot;, (altered: _item via _item&#39;s name, ...(find: _item where _item&#39;s tags contains all of (a: &quot;uppercastlerock&quot;, &quot;event&quot;), ...(passages:)))))}</tw-passagedata><tw-passagedata pid="812" name="Madame Shireen&#39;s Salon" tags="bookmark location uppercastlerock tick" position="7637,725" size="100,100">[[Sip a Dainty Liquer in Madam Shireen&#39;s Salon]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="813" name="Sip a Dainty Liquer in Madam Shireen&#39;s Salon" tags="tick" position="7783,724" size="100,100">...(display: &quot;Baseless Rumors&quot;)...


[[Sip a Dainty Liquer in Madam Shireen&#39;s Salon]] 

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="814" name="Donec Inferos" tags="bookmark uppercastlerock location tick" position="7634,619" size="100,100">The Donec Inferos, the Department of the Infernal, has its majestic halls here in Upper Castlerock.

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="815" name="Sanctum Sanctorum" tags="bookmark uppercastlerock location tick" position="7638,841" size="100,100">The most precious artifact in the world is housed here, behind a garrison of wizards, soldiers, and daemons.

(set: _item to &quot;Aleph&quot;)(set: _cost to 1)(display: &quot;QuickBuy&quot;)

[[Begone!-&gt;Home Again]]</tw-passagedata><tw-passagedata pid="816" name="Upper Castlerock" tags="tick" position="7577,412" size="200,200">(display: &quot;Init Upper Castlerock&quot;)
If the Noble City were the Emperor, Upper Castlerock would be his mitre crown.  The rocky spire hovers, slowly rotating, held aloft by magic or powerful electromagnets or enslaved Ifriti (or maybe all three).  The gates are well-guarded and relatively inaccessible. You will need a Gate Pass and a Rift Ship or Ferry to access it.
Uninvited guests are given a short walk off the ramparts back to the City below.

(for: each _item, ...($neighborhood&#39;s locations))[(if: (history:) contains _item and (passage: _item)&#39;s tags contains &quot;bookmark&quot;)[(link-goto: _item)

]]

[[Board the Upper Castlerock Tram]]

(if: $gold &gt; 99999 or $inventory contains &quot;Noble Cowl&quot;)[ [[Explore the Neighborhood]] ](else:)[This is a gated community.  It&#39;s at least partially gated by money.  Of which, you don&#39;t have enough.
[[Home Again]] 
]</tw-passagedata><tw-passagedata pid="817" name="Upper Castlerock Color" tags="" position="7453,458" size="100,100">Elegant aristocrats.</tw-passagedata><tw-passagedata pid="818" name="Encounter: Danger Boost" tags="event uppercastlerock" position="3658,4330" size="100,100">(set: $danger to it + 1)
You feel a shiver of electric fear run through you, as you become suddenly aware of the giant eye in the sky that is always watching the citizens of the City.  Moments later, you have once again forgotten about its existence.
[[Next Encounter]]</tw-passagedata><tw-passagedata pid="819" name="Kafka Gaol" tags="uppercastlerock bookmark tick" position="7638,953" size="100,100">Iterated Prisoner&#39;s Dilemma
Iterated Knights &amp; Knaves

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="820" name="Board the Upper Castlerock Tram" tags="tick" position="7852,445" size="100,100">All citizens of the City in good standing, regardless of neighborhood, are allowed on the Upper Castlerock Tram.  

(if: $inventory contains &quot;Badge of Shame&quot; or $reptuation&#39;s public &lt; 1)[
Sadly, you are not in good standing, and you are being sent [[Home Again]].
](else:)[
You enter the tram and walk over to the control panel.  It thrums as you make contact with the keyboard.
Enter your station # and click GO.



[[Never Mind!-&gt;Home Again]]
]</tw-passagedata><tw-passagedata pid="821" name="Climb the Tower" tags="tick" position="8099,253" size="100,100">The tower to the throne is infinitely tall, but a clever magician like you ought to be able to find a loophole.

[[Climb the Tower]]</tw-passagedata><tw-passagedata pid="822" name="Ludvig&#39;s Palace" tags="uppercastlerock tick" position="7638,1070" size="100,100">Mad King Ludwig via Jorge Luis Borges

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="823" name="Corpus, The Master Librarian" tags="uppercastlerock tick persona" position="7636,1183" size="100,100">Corpus wears books, scrolls, cuneiform tablets all over their body like an articulated suit of armor.</tw-passagedata><tw-passagedata pid="824" name="Borges Memorial Library" tags="location uppercastlerock tick" position="7505,1365" size="100,100">The best part of the Borges Memorial Library is that it has every possible book within its walls.

The worst part of the Borges Memorial Library is that it has every possible biography (and autobiography) of Jorge Luis Borges within its walls but no card catalog.

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="825" name="Cell A64 of The Library of Borges" tags="tick" position="7630,1371" size="100,100">(for: each _book, ...(find: _item where _item&#39;s tags contains &quot;book&quot;, ...(passages:)))[(link-goto: &quot;Read &quot; + _book&#39;s name)
]

[[Borges Memorial Library]]</tw-passagedata><tw-passagedata pid="826" name="Tram Station #1" tags="tick" position="7858,342" size="100,100">The station is a smooth stone monolith suspended over darkness and void without end.  The tram gently approaches, the doors slide open, and you are ushered off by the mekkanin porters.

Here you are to wait until the next tram arrives.</tw-passagedata><tw-passagedata pid="827" name="Tram Station #2" tags="tick" position="7893,230" size="100,100">This station feels identical to the previous, except for the number 2 emblazoned on the plinth.  With no other feature in sight, you wait here for the next tram to pick you up.</tw-passagedata><tw-passagedata pid="828" name="Tram Station #N" tags="tick" position="7955,15" size="100,100">No more stations lie before you.  Only the void remains.

And the return line.

[[Upper Castlerock]]</tw-passagedata><tw-passagedata pid="829" name="Tram Station #..." tags="tick" position="7925,117" size="100,100">You&#39;ve completely lost track of the station numbers.  Long ago, they stopped being represented in standard Arabic numerals and were replaced with scientific notation, and then &quot;Tower of Power&quot; notation.  Now, it&#39;s all Elder runes.  You really should have studied Elder runes at university.</tw-passagedata><tw-passagedata pid="830" name="Sky Dock" tags="location uppercastlerock bookmark tick" position="7378,700" size="100,100">Free passage to [[North Harbor]].</tw-passagedata><tw-passagedata pid="831" name="Glorious Goods" tags="location uppercastlerock bookmark" position="7630,1484" size="100,100">(set: _cost to 1500)
(for: each _item, &quot;Brass Mirror&quot;, &quot;Mana Battery&quot;)[
(display: &quot;QuickBuy&quot;)
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="832" name="Mavis, Lady of the Sun" tags="uppercastlerock persona" position="7485,1182" size="100,100">Emerging from thick, metallic curls is a crown of gold.  Her gold cloth toga is draped over a body kept physically perfect by a concert of powerful enchantments.  And by &quot;physically perfect&quot;, I mean &quot;a sphere&quot;.</tw-passagedata><tw-passagedata pid="833" name="Build A Floor" tags="" position="8245,147" size="100,100">Build the tower higher and higher.</tw-passagedata><tw-passagedata pid="834" name="Lower Castlerock" tags="" position="7026,327.66666666666663" size="100,100">(display: &quot;Init Upper Castlerock&quot;)

[[Upper Castlerock]] 

[[Sylphian Archipelago]]</tw-passagedata><tw-passagedata pid="835" name="Magisterium Head Office" tags="location unlisted uppercastlerock" position="7824,1012" size="100,100">(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="836" name="Magisterium Local Office: Upper Castlerock" tags="location unlisted uppercastlerock" position="7823,1149" size="100,100">(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="837" name="Wastelands" tags="location westfires southquarry" position="2408,4057" size="200,100">(display: &quot;Init Wastelands&quot;)
Factories deposit their waste materials, slag, expended reagents.
Skeletons of dead trees. 
Mechanical vultures eternally pivoting through the air, tirelessly riding hot updrafts, 
while you are choking on toxic dust and being staggered by dusty billows racing across the hardpan.

The shortest route between West Fires and South Quarry.

(set: $pursued to 0)
(set: $stamina to $health * 10)

(set: $encounterStack to (shuffled: &quot;Wastelands: Waystation&quot;, &quot;Wastelands: Waystation&quot;, &quot;Wastelands: Waystation&quot;, &quot;Wastelands: Dust Storm&quot;,&quot;Wastelands: Dust Storm&quot;,&quot;Wastelands: Dust Storm&quot;, &quot;Wastelands: Dust Storm&quot;,&quot;Wastelands: Dust Storm&quot;, &quot;Wastelands: Arackne Patrol&quot;,&quot;Wastelands: Arackne Patrol&quot;,&quot;Wastelands: Arackne Patrol&quot;,&quot;Wastelands: Arackne Patrol&quot;,  &quot;Wastelands: Standing Stones&quot;, &quot;Wastelands: Standing Stones&quot;, &quot;Wastelands: Trudging Through the Wastelands&quot;, &quot;Wastelands: Trudging Through the Wastelands&quot;, &quot;Wastelands: Trudging Through the Wastelands&quot;, &quot;Wastelands: Trudging Through the Wastelands&quot;, &quot;Wastelands: Trudging Through the Wastelands&quot;, &quot;Wastelands: Trudging Through the Wastelands&quot;)&#39;s (range: 1, (random: 9, 13)))
(set: $encounterIndex to 1)
(if: $neighborhood&#39;s name is &quot;South Quarry&quot;)[(set: $encounterStack to it + (a: &quot;Wastelands: West Fires Gate&quot;))]
(else:)[(set: $encounterStack to it + (a: &quot;Wastelands: South Quarry Gate&quot;))]


[[Sally Forth!-&gt;Next Encounter]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="838" name="Init Wastelands" tags="function" position="2450,3939" size="100,100">{(set: $environmentMaterials to (a: &quot;stone&quot;, &quot;stalagmite&quot;, &quot;sulfur&quot;, &quot;calcite&quot;, &quot;dirt&quot;, &quot;sand&quot;, &quot;fossilized wood&quot;, &quot;fossil&quot;))
(set: $environmentColors to (a: &quot;white&quot;, &quot;yellow&quot;, &quot;ochre&quot;, &quot;gray&quot;))
(set: $clothingMaterials to (a: &quot;fur&quot;, &quot;hide&quot;, &quot;flaxen&quot;, &quot;hair&quot;))
(set: $clothingColors to (a: &quot;brown&quot;, &quot;black&quot;, &quot;gray&quot;, &quot;yellowed&quot;, &quot;dun&quot;,&quot;sunbleached&quot;))
(set: $clothingTypes to (a: &quot;loincloth&quot;, &quot;tunic&quot;, &quot;skirt&quot;, &quot;bracers&quot;))
(set: $adornmentMaterials to (a: &quot;bone&quot;, &quot;fossil&quot;, &quot;clay&quot;, &quot;ochre&quot;, &quot;geode&quot;, &quot;glass&quot;))
(set: $adornmentTypes to (a: &quot;horns&quot;, &quot;tusks&quot;))
(set: $hairstyles to (a: &quot;a shaven scalp&quot;, &quot;a bald pate&quot;, &quot;a shaggy mane&quot;,&quot;long matted tendrils&quot;))

(set: $sizes to (a: &quot;scrawny&quot;, &quot;rawboned&quot;))
(set: $races to (a: &quot;human&quot;, &quot;drake-kin&quot;, &quot;goblin&quot;, &quot;devil&quot;))
(set: $skinColors to (a: &quot;black&quot;, &quot;tan&quot;, &quot;brown&quot;, &quot;red&quot;, &quot;gray&quot;))
(set: $skinTypes to (a: &quot;smooth&quot;, &quot;lightly furred&quot;, &quot;fur-covered&quot;, &quot;scaled&quot;))
(set: $professions to (a: &quot;hunter&quot;, &quot;gatherer&quot;, &quot;warlord&quot;))
}
{(set: $neighborhood to 
(dm: &quot;name&quot;, &quot;Wastelands&quot;, 
&quot;tagname&quot;, &quot;wastelands&quot;,
	&quot;locations&quot;, (a:),
&quot;contracts&quot;, (a:),
		&quot;events&quot;, (a:)))}</tw-passagedata><tw-passagedata pid="839" name="Wastelands: Waystation" tags="" position="1958,4205" size="100,100">You see a domed mudbrick shelter up ahead.
(if: $pursued is 1)[Your pursuers won&#39;t be able to see you inside.(set: $pursued to 0)]

You should be safe here from all of the //known// hostilities.

In fact, there&#39;s a reasonable cot and a trickle of fresh water from a little pump in the back.

(link-reveal: &quot;Refresh Myself&quot;)[
You feel marginally better.
(set: $arg to 10)(display: &quot;UpdateStamina&quot;)
(if: (random: 0, 100) is 0)[Scratched into the wall is &quot;Jake wuz here&quot;.]
]

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="840" name="Wastelands: Dust Storm" tags="" position="2108,4207" size="100,100">The furious wind blows hot, caustic grit into your eyes and sinuses, rendering you nearly blind and anosmic.  Not to mention almost deaf.
(if: (random: 0,$perception) &gt; 1)[(set: $arg to -1)(display: &quot;UpdatePerception&quot;)]
(set: $arg to -10)(display: &quot;UpdateStamina&quot;)

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="841" name="Wastelands: Arackne Patrol" tags="" position="2258,4207" size="100,100">As you cross the flat plain of the Wasteland, you&#39;ve grown accustomed to seeing the metal carcasses of giant mechanical spiders.
(if: $pursued &lt; 0)[The immobile giants stand over you in ominous silence.]
(else-if: $pursued &gt;= 0)[
Now, you&#39;ve blundered into a group of giant mechanical spiders that are very much still animated!
(if: (random: 0, $cunning + $perception) &gt; 2)[You manage to sneak right past them without their detection.](else:)[
(either: &quot;The loose crust of the hardpan cracks under your foot like a clay roof tile.&quot;,
&quot;A different spider that you hadn&#39;t seen has spotted you from far above.&quot;,
&quot;A bag full of garbage has blown into the wall of a building near your hiding place.  The noise causes the spider machines to swarm around you&quot;)
(set: $pursued to 1)The spiders are now chasing you!
]]
(set: $arg to -1)(display: &quot;UpdateStamina&quot;)

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="842" name="Wastelands: West Fires Gate" tags="" position="2408,4207" size="100,100">You arrive at the gate to West Fires.

[[West Fires]]</tw-passagedata><tw-passagedata pid="843" name="Wastelands: South Quarry Gate" tags="" position="2559,4207" size="100,100">You arrive at the gate to [[South Quarry]].</tw-passagedata><tw-passagedata pid="844" name="Wastelands: Standing Stones" tags="" position="2708,4208" size="100,100">(either: &quot;Great basalt obelisks just out from the ground, with piles of rubbish creating ramps at their bases.&quot;, &quot;You find a labyrinthian structure made from regular stone rectangular solids.&quot;)

(if: $pursued &lt; 1)[
[[Wastelands: Explore the Standing Stones]]
](else:)[Sadly, you are too hotly pursued to explore them.]

(set: $arg to -1)(display: &quot;UpdateStamina&quot;)

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="845" name="Wastelands: Trudging Through the Wastelands" tags="" position="2858,4207" size="100,100">(set: $arg to -1)(display: &quot;UpdateStamina&quot;)
It grows tiresome walking the virtually identical after virtually identical miles in this wretched place.  Still, you cannot stop.
If the gigantic, mechanical vultures that maintain their position above you constantly sensed you flagging or growing weak for even a moment, they would swoop down and tear you to pieces.
(if: $pursued is 1)[Behind you, the relentless clinking of the giant mechanical spiders pursuing you gives you an extra incentive to move.]

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="846" name="UpdateStamina" tags="function" position="2206,4082" size="100,100">(if: $pursued is 1 and $arg is &lt; 0)[(set: $arg to it * 2)]
(set: $stamina to it + $arg)*Stamina (if: $arg &gt;= 0)[+] $arg*
(if: $stamina &lt; 0)[(goto: &quot;Wastelands: Succumb to Exhaustion&quot;)]</tw-passagedata><tw-passagedata pid="847" name="Wastelands: Explore the Standing Stones" tags="" position="2708,4357" size="100,100">(set: _roll to (either: &quot;spiders&quot;, &quot;supplies&quot;, &quot;remnant&quot;))
(if: _roll is &quot;spiders&quot;)[You find a switch that is labelled &quot;Spiders&quot;.  Do you want to throw the switch?
(link-reveal: &quot;Yes, it definitely seems like a good idea to throw a switch labelled Spiders&quot;)[(if: (random: 0, 1) &gt; 0)[
(set: $pursued to 1)You hear the distinct sound of a bunch of mechanical spiders suddenly powering on.
](else:)[You don&#39;t hear anything.  Nothing appears to happen.  (set: $pursued to -1)]]]
(else-if: _roll is &quot;supplies&quot;)[You find a few bits and pieces here and there that will actually help with your supplies.  Old cloth...  dried beans... flashlight batteries...
(set: $arg to (random: 1, 10))(display: &quot;UpdateStamina&quot;)]
(else-if: _roll is &quot;remnant&quot;)[(either:&quot;Creepypasta of a dead world&quot;, &quot;Creepypasta of a dead world #2&quot;)]

[[Next Encounter]]</tw-passagedata><tw-passagedata pid="848" name="Wastelands: Succumb to Exhaustion" tags="" position="2061,4094" size="100,100">(set: $encounterStack to (a:))(set: $encounterIndex to 1)
(if: $stamina &lt; -9)[
(set: $deathReason to &quot;You literally ran out of energy to continue living, so your body just stopped.&quot;)
(if: $pursued is 1)[
(set: $deathReason to &quot;The spiders quickly kill you.  At first, you think you&#39;re being vivisected, but then you realize that they mean no harm.  They are simply disassembling you.&quot;)(goto: &quot;Death&quot;)
](goto: &quot;Death&quot;)
]

(if: (random: 0, 100) is 0)[
A kindly hermit has found you out here in the nightmare and has brought you somewhere safe.
[[Hermits Passage]] 
](else:)[
[[Wastelands: Vulture Attack]]
]</tw-passagedata><tw-passagedata pid="849" name="Wastelands: Vulture Attack" tags="" position="1804,4207" size="100,100">(set: $guardianHealth to 5)(set: $deathReason to &quot;You were torn to shreds, dried, then converted to food for a ravenous, mechanical vulture.&quot;)
(display: &quot;Encounter: Guardian Beast (Mechanical)&quot;)
(event: when $health &lt;= 0)[(goto: &quot;Death&quot;)]

(event: when $guardianHealth &lt;= 0)[(replace:?input)[The killing machine slumps to the ground, its body ceasing to animate.

[[Next Encounter]] 

]]</tw-passagedata><tw-passagedata pid="850" name="Hermits Passage" tags="location" position="1401,5900" size="100,100">You encounter a small cottage in the middle of the intersection of various biomes, you peek inside the window. Alas, you see merely (either: &quot;steampunk machinery of the future&quot;(set: $hermitpass to &quot;steampunk&quot;), &quot;magic wares from millenia ago&quot;(set: $hermitpass to &quot;millenia&quot;), &quot;a mirror&quot;(set: $hermitpass to &quot;mirror&quot;)). You: [[Go Through the Hermits Passage]] or [[Nope...-&gt;Next Encounter]]</tw-passagedata><tw-passagedata pid="851" name="Go Through the Hermits Passage" tags="" position="1397,6051" size="100,100">(if: $hermitpass is &quot;steampunk&quot;)[You search through all the bit of machinery, you find so many trinkets, you are smarter than everyone else in the entirety of the universe combined.
(set $perception to 99999999999)]
(else:)
[
(if: $hermitpass is &quot;millenia&quot;)[You poke and prod a jar made of melted snake and monkey bones. While you are at it, a spider crawls onto your back and applies a curse so fatal, it makes the victim suffer eternally. [[Encounter Calamity]]]
]
(else:)
[
(if: $hermitpass is &quot;mirror&quot;)[You stare at your reflection for quite some time. You are amazed to see that your own reflection decided to put his hand on your face.(set: $LazarusBeaconCharges to it + 999999999999999)
]
(if: $hermitpass is not &quot;millenia)[[Take a postcard]]</tw-passagedata><tw-passagedata pid="852" name="West Fires" tags="tick" position="1182,1374" size="200,200">&lt;script&gt;document.getElementById(&quot;stylesheet&quot;).href=&quot;pd_style_west_fires.css&quot;;&lt;/script&gt;
(display: &quot;Init West Fires&quot;)
This neighborhood is known as the West Fires, because it is to the West and it is constantly on fire.  The supernatural flames are useful for the various industries in that region.
(for: each _item, ...($neighborhood&#39;s locations))[(if: (history:) contains _item and (passage: _item)&#39;s tags contains &quot;bookmark&quot;)[(link-goto: _item)

]]

[[Explore the Neighborhood]] 

[[Home Again]] 

(display: &quot;Contract Status&quot;)</tw-passagedata><tw-passagedata pid="853" name="Init West Fires" tags="function" position="1226,1254" size="100,100">{(set: $environmentMaterials to (a: &quot;stone&quot;, &quot;brick&quot;, &quot;charcoal&quot;, &quot;cinderbrine&quot;, &quot;quartz&quot;, &quot;concrete&quot;, &quot;flagstone&quot;, &quot;cobble&quot;))
(set: $environmentColors to (a: &quot;white&quot;, &quot;red&quot;, &quot;black&quot;, &quot;gray&quot;))
(set: $clothingMaterials to (a: &quot;fur&quot;, &quot;felt&quot;, &quot;linen&quot;, &quot;rag&quot;, &quot;metal plate&quot;, &quot;leather&quot;))
(set: $clothingColors to (a: &quot;brown&quot;, &quot;black&quot;, &quot;foxred&quot;, &quot;gray&quot;, &quot;grey&quot;, &quot;yellowed&quot;, &quot;tawny&quot;))
(set: $clothingTypes to (a: &quot;kilt&quot;, &quot;apron&quot;, &quot;loincloth&quot;, &quot;girdle&quot;, &quot;three-piece suit&quot;, &quot;coveralls&quot;, &quot;one-piece&quot;))
(set: $adornmentMaterials to (a: &quot;bone&quot;, &quot;shell&quot;, &quot;copper&quot;, &quot;clay&quot;, &quot;gold&quot;, &quot;silver&quot;, &quot;emerald&quot;, &quot;iron&quot;, &quot;tin&quot;, &quot;brass&quot;))
(set: $adornmentTypes to (a: &quot;plate&quot;, &quot;plug&quot;, &quot;tusk&quot;, &quot;ring&quot;, &quot;stud&quot;))
(set: $hairstyles to (a: &quot;a shaven scalp&quot;, &quot;a bald pate&quot;, &quot;shaven sides and spiked top&quot;, &quot;long dreadlocks&quot;, &quot;long bangs&quot;, &quot;a lacquered headdress&quot;, &quot;a shaggy mane&quot;))

(set: $sizes to (a: &quot;grand&quot;, &quot;stout&quot;, &quot;scrawny&quot;, &quot;burly&quot;, &quot;rotund&quot;, &quot;gaunt&quot;, &quot;obese&quot;, &quot;muscular&quot;, &quot;sculpted&quot;))
(set: $genders to (a: &quot;man&quot;, &quot;woman&quot;, &quot;non&quot;, &quot;herm&quot;))
(set: $races to (a: &quot;human&quot;, &quot;vulcan&quot;, &quot;daemonkin&quot;, &quot;changeling&quot;, &quot;drakish&quot;, &quot;mekannin&quot;))
(set: $skinColors to (a: &quot;black&quot;, &quot;tan&quot;, &quot;brown&quot;, &quot;red&quot;, &quot;gray&quot;))
(set: $skinTypes to (a: &quot;smooth&quot;, &quot;lightly furred&quot;, &quot;fur-covered&quot;, &quot;scaled&quot;))
(set: $professions to (a: &quot;soldier&quot;, &quot;thief&quot;, &quot;ragpicker&quot;, &quot;sineater&quot;, &quot;cursekeeper&quot;, &quot;prostitute&quot;, &quot;thug&quot;, &quot;student&quot;, &quot;alckymist&quot;, &quot;blacksmith&quot;))
}
{
(set: $events to (altered: _item via _item&#39;s name, ...(find: _item where _item&#39;s tags contains all of (a: &quot;westfires&quot;, &quot;event&quot;), ...(passages:))))
(if: (history:) contains &quot;Fulfilled: Slaying The Beast&quot;)[(set: $events to $events + (a: &quot;Ripper&#39;s Carnage&quot;))]
(set: $neighborhood to 
(dm: &quot;tagname&quot;, &quot;westfires&quot;,
&quot;name&quot;, &quot;West Fires&quot;, 
	&quot;locations&quot;, (altered: _item via _item&#39;s name, ...(find: _item where _item&#39;s tags contains all of (a: &quot;westfires&quot;, &quot;location&quot;), ...(passages:))),
&quot;contracts&quot;, (altered: _item via _item&#39;s name, ...(find: _item where _item&#39;s tags contains all of (a: &quot;westfires&quot;, &quot;contract&quot;), ...(passages:))),
		&quot;events&quot;, $events))
}</tw-passagedata><tw-passagedata pid="854" name="West Fires Color" tags="" position="1061,1422" size="100,100">{(either: &quot;In front of a &quot;, &quot;Sat in front of a &quot;, &quot;Hanging out near a &quot;)(display: &quot;QuickSetting&quot;) a (if: (random: 0,1)&gt;0)[ (either: &quot;lady&quot;, &quot;gentleman&quot;, &quot;creature&quot;) of (either: (either: &quot;great&quot;, &quot;small&quot;) + &quot; size&quot;, (either: &quot;dark&quot;, &quot;ruddy&quot;, &quot;pale&quot;, &quot;blue&quot;, &quot;translucent&quot;, &quot;scaly&quot;, &quot;tattooed&quot;) + &quot; skin&quot;) (either: &quot;wearing&quot;, &quot;with&quot;, &quot;in&quot;) a (display: &quot;Random Jewelry&quot;) (either: &quot; beckons you into their abode.&quot;,&quot; waves you over to their shop.&quot;, &quot;regards you with indifference.&quot;, &quot; dozes against the wall.&quot;,&quot; chats with their twin.&quot;,&quot; sips at a disreputable-looking pipe.&quot;, &quot; glares at you from across the road but takes no action.&quot;)](else:)[(display: &quot;QuickChar&quot;)(either: &quot; beckons you into their abode.&quot;,&quot; waves you over to their shop.&quot;, &quot;regards you with indifference.&quot;, &quot; dozes against the wall.&quot;,&quot; chats with their twin.&quot;,&quot; sips at a disreputable-looking pipe.&quot;, &quot; glares at you from across the road but takes no action.&quot;, &quot; roughly pushes you aside as it passes by.&quot;)]}</tw-passagedata><tw-passagedata pid="855" name="Daemonium" tags="bookmark westfires location tick" position="1230,1586" size="100,100">(if: $inventory contains &quot;Soul Jar&quot;)[&quot;No more freebies&quot;, rasps the wraith-like owner of this disreputable shop.
]
(else:)[The shop owner hands over a Soul Jar in their slender talons.  They instruct you in its use and promise you great rewards should you successfully capture a Daemon with it.
&quot;The first one is aaaaaaaaaalways free.&quot;
(set: $inventory to it + (ds: &quot;Soul Jar&quot;))
]
(set: _cost to 100)
(if: $daemons&#39;s length &gt; 0)[&quot;But if you&#39;ve come to trade in Daemons with me, then I could be paying you quite handsomely,&quot; they say.
(for: each _item, ...$daemons)[
(link-reveal: &quot;Examine &quot; + _item)[
(set: $itemName to _item)(display: _item)] - (link-reveal-goto: &quot;Sell &quot; + _item, &quot;Sell a Daemon&quot;)[(set: $itemName to _item)]
]
]
(for: each _item, &quot;Fire Ghost&quot;, &quot;Living Shadow&quot;, &quot;Solar Spark&quot;)[(unless: $daemons contains _item)[(display: &quot;QuickBuyDaemon&quot;)]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="856" name="Semi-Legal Wards Broker" tags="westfires northharbor location tick" position="4129,2199" size="100,100">{(set: _price to 15)}
(if: $inventory contains &quot;Lump of Lead&quot; and $gold &gt; _price)[
You hand over the Lump of Lead and a mite bit of gold, and your dealer quickly stamps you a Damage Ward on an amulet cord.  It emanates a thick, metallic aura in the ethereal plane and should offer a single shot of magical damage protection.
{(set: $inventory to $inventory - (ds: &quot;Lump of Lead&quot;))
(set: $arg to _price * -1)(display: &quot;UpdateGold&quot;)
(set: $arg to &quot;Damage Ward&quot;)(display: &quot;GetItem&quot;)}
](else:)[
If you want to get yourself a Damage Ward, you need a Lump of Lead and about _price gold coins to trade with a dealer in this kind of barely legal artificery.  Come back with the metal, and you&#39;ll get the goods.
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="857" name="Friendly Neighborhood Fire Ghost" tags="tick" position="1554,1985" size="100,100">(if: (history:) contains &quot;A Little Tip From a Fire Ghost&quot;)
[
You&#39;re not going to let yourself be fooled again by an creature that doesn&#39;t even have a substance, and it&#39;s not going to let itself be cut to ribbons with a crystal spyglass.
]
(else:)
[A fire ghost sleazes up beside you as you prop yourself up against a lamp post. It meets your gaze and reaches out a flimsy hand for your filthy lucre.

&quot;You want a tip, buddy? 10 coins,&quot; it hisses at you.
[[Pay the Creature-&gt;A Little Tip From a Fire Ghost]]
]
(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="858" name="Alckymie Werkz" tags="bookmark location westfires tick" position="1229,1696" size="100,100">(if: $ticks / 13 % 13 &gt; 8)[
You&#39;ve come at the wrong time of the day for alchemical ingredients.  All of the alchemists and artificers have gone home to get deliriously high on their own concoctions.

(unless: $inventory contains &quot;Lump of Lead&quot;)
[
You find a nice lump of lead on the ground where the stalls were.  Finders = Keepers.  QED.
(set: $inventory to it + (ds: &quot;Lump of Lead&quot;))
]
](else:)[(display: &quot;Alckymie Inventory&quot;)
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="859" name="A Little Tip From a Fire Ghost" tags="" position="1661,1983" size="100,100">(if: $gold &gt; 9)
[
The fire ghost whispers into your ear, &quot;You should know that living fire cares only about burning foolish mortals...&quot;

(if: $gold &gt; 19)[(set: $arg to -20)](else-if: $gold &gt; 0 and $gold &lt;= 19)[(set: $arg to $gold)](display: &quot;UpdateGold&quot;)

](else:)[
It sneers at your lack of coin and lashes out at you.
(set: $arg to 1) (display: &quot;TakeDamage&quot;)
]

And then it&#39;s gone in a puff of smoke.  You&#39;re chagrined, and you&#39;d rather hope no one saw that.

(display: &quot;An Embarassing Display&quot;)

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="860" name="Next Encounter" tags="tick" position="3821,3038" size="100,100">(if: $encounterStack ($encounterIndex) is (history:)&#39;s last)[
(set: $encounterIndex to it + 1)
(set: $encounterLength to it + 1)]
(go-to: &quot;Encounter&quot;)</tw-passagedata><tw-passagedata pid="861" name="Gideon&#39;s Furniture Boutique" tags="bookmark westfires location tick" position="1224,1911" size="100,100">Gideon greets you at the front of the store.
&quot;Ah, yes, a discerning customer who recognizes the superiority of our merchandise,&quot; they say, displaying their shimmering teeth. &quot;Prices may have increased recently due to our popularity.&quot;
{(set: $goldCost to 1500)

(for: each _item, ...(a: &quot;Vivification Chamber&quot;, &quot;Neighborhood Door to North Harbor&quot;, &quot;Rack of Torment&quot;))[(if: $inventory contains _item)[(set: $goldCost to it * 2)]]}

(for: each _item, ...(a: &quot;Vivification Chamber&quot;, &quot;Neighborhood Door to North Harbor&quot;, &quot;Rack of Torment&quot;))[(unless: $inventory contains _item)[(link-reveal-goto: &quot;Examine the &quot; + _item, &quot;Furniture For Sale&quot;)[(set: $itemName to _item)]
]]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="862" name="Examine Furniture" tags="" position="3633,2716" size="100,100">(display: &quot;Tick&quot;)
(display: $itemName)

(link-reveal: &quot;Use &quot; + $itemName)[
(display: &quot;Use &quot; + $itemName)]
(link-goto: &quot;Return&quot;, (history:)&#39;s last)</tw-passagedata><tw-passagedata pid="863" name="Farlywell&#39;s Inimitable Trinkets" tags="location westfires bookmark" position="1215,2479" size="100,100">(set: _cost to 150)
(for: each _item, &quot;Infernal Lens&quot;, &quot;Straight Razor&quot;, &quot;Thorn Ward&quot;)[
(display: &quot;QuickBuy&quot;)
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="864" name="Burning Hammer" tags="location westfires bookmark" position="1215,2710" size="100,100">Like the kind of bells that a god would ring, giant piston-powered hammers smashing down on anvils the size of houses.
Industrial productivity is clearly being executed at an epic scale, using the energy of the eternal firestorm below to manufacture possible item.
In practice, most of those items tend to be only infinitesimally different from each other.

They have a street-level shop where you can buy samples:
(set: _cost to 150)(set: $marketplace to (a: &quot;Aqua Regia&quot;, &quot;Platinum Platelet&quot;, &quot;Meteor Iron&quot;, &quot;Damage Ward&quot;))(for: each _item, ...$marketplace)[(unless: $inventory contains _item)[
(display: &quot;QuickBuy&quot;)
]]

(if: $reputation contains &quot;House Guild Mechanika&quot; and $reputation&#39;s (&quot;House Guild Mechanika&quot;) &gt; 0)[
You have some favor with the House Guild Mechanicka, which runs this majestic beast.
](else:)[The House Guild Mechanicka runs this majestic beast.]

[[House Guild Mechanika]] 

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="865" name="House Guild Mechanika" tags="location westfires bookmark" position="1218,2830" size="100,100">It is built up from the stones out of steaming pipes and clattering gears.  It is hideously dangerous.  The workers entering and exiting are often conspicuously burn-scarred or missing digits.

You can hire their boffins to update your available tech wherever they have an outpost.  

(link-repeat: &quot;Buy 1 Unit of Science/Engineering&quot;)[
(if: $gold &gt; 100)[
(set: $arg to &quot;House Guild Mechanika&quot;)(display: &quot;ImproveReputation&quot;)
(set: $arg to -100)(display: &quot;UpdateGold&quot;)
+ Science/Engineering
Of course, you can bottle lightning.  It&#39;s called a Leyden jar.  Well, what about magic essence?  Only one way to find out.  Here, hold my ale.
It seems that his heart stopped.  Perfect opportunity for the Leyden jar!
]
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="866" name="Phil &quot;Itchy&quot; Palm" tags="westfires persona" position="1331,2592" size="100,100">Scabrous, overgrown nails, two eyes like piss holes in a snowbank if the pisser had a life-threatening kidney infection.
He&#39;s constantly trying not to scratch his itches, because his flesh is so delicate and his nails so sharp.
Wears ruined finery.  Accepts gold for information.  Always a gamble with him.  If you don&#39;t give him enough gold, he&#39;ll give you garbage information.</tw-passagedata><tw-passagedata pid="867" name="Librem Perditus Bookstore" tags="bookmark westfires location tick" position="1226,2026" size="100,100">(if: $perception &lt; 5)
[
Some books in this room could kill you.
Some of them give you a migraine if you try to comprehend the very first page.
One gave you a nosebleed when you so much as looked at its spine.

(set: _item to &quot;Pamphlet of Cunning&quot;)(set: _cost to 15)(display: &quot;QuickBuy&quot;)

(set: _item to &quot;Percepo de Cristal&quot;)(set: _cost to 750)(display: &quot;QuickBuy&quot;)

(set: _item to &quot;The Complete History of History&quot;)(set: _cost to 400)(display: &quot;QuickBuy&quot;)
]
(else:)[You realize that these books are purely theoretical and academical, dealing with domains of High Magick that have nothing to do with earning gold coins or slaying your enemies. (if: $perception &gt; 5)[And even more than half of those have a glamour on them to make them seem more worthwhile than they really are.]
(set: _item to &quot;Pamphlet of Cunning&quot;)(set: _cost to 15)(display: &quot;QuickBuy&quot;)

(set: _item to &quot;Percepo de Cristal&quot;)(set: _cost to 20)(display: &quot;QuickBuy&quot;)

(set: _item to &quot;The Complete History of History&quot;)(set: _cost to 1)(display: &quot;QuickBuy&quot;)
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="868" name="Encounter: Thug" tags="event westfires" position="3533,4200" size="100,100">{(set: $enemyHealth to 2)(set: $enemyType to &quot;Thug&quot;)
(set: $fightPattern to (a:&quot;Strike&quot;,&quot;Block&quot;,(either: &quot;Strike&quot;, &quot;Throw&quot;)))
(set: $fightIndex to 1)(set: $enemyElementType to &quot;Mortal&quot;)
(set: $deathReason to &quot;You were garrotted in a back alley by a street urchin.&quot;)
}You see a (either: &quot;right&quot;, &quot;nasty&quot;, &quot;poxy&quot;) (either: &quot;prick&quot;, &quot;lout&quot;, &quot;bastard&quot;) waving their knife about at you. 
They demand your purse.

|output&gt;[]
|input&gt;[(display: &quot;Fight&quot;)
(link-reveal-goto: &quot;Hand Over A Purse&quot;, &quot;Home Again&quot;)[(set: $gold to it - (floor: $gold/4))(set: $deathReason to &quot;&quot;)]]

(event: when $enemyHealth &lt;= 0)[ (replace:?input)[ [[Next Encounter]] ]]</tw-passagedata><tw-passagedata pid="869" name="Den of Untouchables" tags="westfires location tick bookmark" position="1223,2138" size="100,100">(if: $inventory contains any of (a: &quot;Badge of Shame&quot;, &quot;Plague Marks&quot;))[At the entrance to the Den of Untouchables is Manky, the bouncer.  They are 8 cubits tall and adorned in a patchwork of rags.

&quot;Got jobs what you could do&quot;, they say:
(for: each _persona, ...(shuffled: ...(find: _i where _i&#39;s tags contains &quot;brass-level&quot;, ...(passages:)))&#39;s (range: 1,$cunning))[
(link-goto: _persona&#39;s name)
]

]
(else:)[At the entrance to a boisterous club is a (display: &quot;QuickChar&quot;), pointing at a series of gruesome scars on their face.  Then they point towards your unlined and unscarred visage.
&quot;You aren&#39;t one of us, and you aren&#39;t welcome here,&quot; they intone.

&quot;We&#39;ve heard rumors,&quot; they say.  &quot;Want to buy some?&quot;
(link-repeat: &quot;Buy Rumor&quot;)[(set: $gold to it - 1)(replace:?output)[
(if: (random: 0, 10) &gt; 7)[(display: &quot;Interesting Rumors&quot;)]
(else:)[(display: &quot;Baseless Rumors&quot;)]]]
|output&gt;[]
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="870" name="A Beggar&#39;s Bowl" tags="westfires event" position="3778,3716" size="100,100">A beggar is sleeping on the ground.  In front of him is a bowl full of coins.
|input&gt;[
(link-reveal: &quot;Take a Few&quot;)[(replace:?input)[&quot;Take a Few&quot;](replace:?output)[(if: $gold &lt; 15)[(set: $arg to 15)(display: &quot;UpdateGold&quot;)
You take just as much as you need.](else:)[Despite having no need for the poor man&#39;s meagre lucre, you have been caught debasing yourself in front of the gentry.
(display: &quot;An Embarassing Display&quot;)

[[Next Encounter]]]]]
(link-reveal: &quot;Take Them All&quot;)[(replace:?input)[&quot;Take Them All&quot;](replace:?output)[(set: $arg to 150)(display: &quot;UpdateGold&quot;)
He had an amazing amount of money for such a pathetic old man.
Despite having no need for the poor man&#39;s meagre lucre, you have been caught debasing yourself in front of the gentry.
(display: &quot;An Embarassing Display&quot;)
(replace:?clock)[(display: &quot;RenderHeader&quot;)]
[[Next Encounter]]]]
(link-reveal: &quot;Leave Them Be&quot;)[(replace:?input)[&quot;Leave Them Be&quot;](replace:?output)[You studiously avoid them.  It is uncertain if the buboes on his lymph nodes are merely lethal to him or will they erupt and spray virulent slime on everyone nearby.

[[Next Encounter]]]]

(if: $gold &gt; 0)[(link-reveal: &quot;Give Them A Coin&quot;)[(replace:?input)[&quot;Give Them A Coin&quot;](replace:?output)[You quickly toss them a coin without checking to see who&#39;s watching you.
(set: $arg to (random: -1, 1))(display: &quot;UpdateReputation&quot;)
(set: $arg to -1)(display: &quot;UpdateGold&quot;)
[[Next Encounter]]]]

(link-reveal: &quot;Give Them All Your Gold&quot;)[(replace:?input)[&quot;Give Them All Your Gold&quot;](replace:?output)[
(if: (random: 0, 10) &gt; 1)[You offer this wretched creature all of your lucre.  You suddenly feel no need for it.
It is then revealed to you that this is no mere beggar.  It is a holy monk down from the Mountain.
The humble monk refuses your kind offer.  They are not a beggar at all.
Everyone can see what a kind person you truly are.
(set: $arg to 10)(display: &quot;UpdateReputation&quot;)
[[Next Encounter]]]
(else:)[(set: $gold to 0)Not sure why you did that.  You feel cheated but would feel even worse if you tried getting your money back.

[[Next Encounter]]
]]]

]]
|output&gt;[]</tw-passagedata><tw-passagedata pid="871" name="Encounter: Pickpocket" tags="westfires event" position="3781,3836" size="100,100">A gerning thug bumps into you.  His deft hands get a hold of one of your coin purses (if: $perception + (random: -1,1) &gt; 4)[but you intercept him before he makes off with your lucre.

[[Next Encounter]]](else:)[before you&#39;re aware of it, and you&#39;re now lighter in the wallet. 
(set: $arg to -(random: 0, (ceil:$gold/4)))(display: &quot;UpdateGold&quot;)

[[Next Encounter]] 
]</tw-passagedata><tw-passagedata pid="872" name="Mudlarking" tags="location westfires" position="4278,2437" size="100,100">(if: $ticks % 13 &lt; 7)[Along the canal, the tide is low.  Rich mounds of sediment on the canal bottom are embedded with detritus from millenia of the City Past.
|input&gt;[
(link-repeat: &quot;Search for Trinkets&quot;)[(replace:?output)[(display: &quot;RandomMudlark&quot;)]]]](else:)[The canal tide is high.  Come again in the morning if you want to try finding treasures in the mud.]
|output&gt;[]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="873" name="Delilah&#39;s Bar" tags="location westfires bookmark tick" position="1216,2365" size="100,100">This wreck of a place reeks of cheap beer, whiskey, vomit, and hope.

Young wizards looking to get a leg up come here for liquid courage.

Old wizards looking to forget come here for the same.

(if: (random: 0, 3) is 3)[ A drunk old man slides over to you at the bar.
&quot;You look like you could use a friend in this big, scary place,&quot; he slurs.  &quot;How&#39;d you like to buy a friend...  a drink?&quot;
[[Buy Erno a Drink]]
]

(for: each _i, (random: 1, 8), (random: 1, 8), (random: 1, 8))[{(set: _cost to _i)(set: _cup to (either: &quot;Dram&quot;, &quot;Chalice&quot;, &quot;Mug&quot;, &quot;Flute&quot;))(set: _drink to (either: &quot;Lager&quot;, &quot;Wine&quot;, &quot;Brandy&quot;, &quot;Port&quot;, &quot;Ichor&quot;, &quot;Elixir&quot;, &quot;Cocktail&quot;))}
(link-reveal: &quot;Buy a &quot; + _cup + &quot; of &quot; + _drink + &quot; for &quot; + (str:_cost) + &quot; gold&quot;)[:
//(display: &quot;Buy an X of Y&quot;)//]
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="874" name="Buy an X of Y" tags="" position="1326,2363" size="100,100">{(if: $gold &gt; _cost)[(set: $gold to it - _cost)
As you polish off your _cup of _drink, Delilah regales you with some recent gossip.
(if: _cost &gt; 6)[
They tell you about a great new place in the neighborhood.
(set: _locations to (find: _item where not ((history:) contains _item and (passage: _item)&#39;s tags contains &quot;bookmark&quot;) and (passage: _item)&#39;s tags contains &quot;location&quot;, ...($neighborhood&#39;s locations)))
(if: _locations&#39;s length &gt; 0)[
(if: _locations&#39;s length is 1)[(link-goto: _locations&#39;s 1st)]
(else:)[
(for: each _i, ...((shuffled: ..._locations)&#39;s (range: 1, (min: 3, (ceil: $perception/2)))))[
(link-goto: _i)&lt;br/&gt;&lt;br/&gt;
]]](else:)[No, I guess you&#39;d already seen that, too.]
]
(else-if: _cost &gt; 3)[(display: &quot;Interesting Rumors&quot;)
]
(else:)[

(if: $reputation&#39;s ($neighborhood&#39;s name) &lt; 5)[(set: $reputationTag to &quot;brass-level&quot;)]
(else-if: $reputation&#39;s ($neighborhood&#39;s name) &lt; 15)[(set: $reputationTag to &quot;silver-level&quot;)]
(else:)[(set: $reputationTag to &quot;gold-level&quot;)]

(if: $currentContract is &quot;&quot;)[
(display: &quot;GenerateChar&quot;)(set: $clientDescription to $char)
(set: $potentialContracts to (find: _item where (not ((passage: _item)&#39;s tags  contains &quot;unique&quot;) or not ((history:) contains _item)) and (passage: _item)&#39;s tags contains all of (a: &quot;contract&quot;, $reputationTag), ...($neighborhood&#39;s contracts)))
(if: $potentialContracts&#39;s length &gt; 0)[People have been asking around for ambitious wizards looking for work...&lt;br/&gt;
(for: each _i, ...((shuffled: ...$potentialContracts)&#39;s (range: 1, (min: 3, (ceil: $perception/2)))))[
(link-goto: _i)&lt;br/&gt;&lt;br/&gt;
]](else:)[(display: &quot;Baseless Rumors&quot;)]
]
]
](else:)[
&quot;Sorry, darling, but you haven&#39;t the gold to spare.&quot;
]}</tw-passagedata><tw-passagedata pid="875" name="Erno, The Enchanter" tags="westfires persona" position="1221,2593" size="100,100">A doddering old man wobbles drunkenly about.  He grins keenly when you make eye contact with him.

(if: (passage:)&#39;s name != &quot;Delilah&#39;s Bar&quot;)[
Oh, you should take me over to [[Delilah&#39;s Bar]] and buy me a drink or two.
]
(else:)[
Shattering an enchantment trap will risk your body.  Unweaving an enchantment trap will risk your mind.  Whichever is currently the strongest, just use that to get through the trap.  If neither are strong, like in my case, you might just run away.

Let&#39;s just say you&#39;ve disassembled some other wizard&#39;s enchantment.  You&#39;ll get the Ethereal threads that make up that trap.  You can sell them or use them for your own enchantments.

Hey, are you going to [[Delilah&#39;s Bar]]?  I&#39;ll tag along!

Ah! You got a ward press.  Very clever.  These stamp an enchantment very quickly into a piece of reagent.  It turns out that for the simpler enchantments, this works just fine.  Here&#39;s instructions for a new ward type:

You&#39;re my best friend, he sobs, maybe in the whole world.  No one ever treated me as good as you.

Here&#39;s my favorite book M.C. Escher: Beginner&#39;s Embroidery.  You can have it.  Tell me that you&#39;ll read it, and I&#39;ll let you have it.
]</tw-passagedata><tw-passagedata pid="876" name="Buy Erno a Drink" tags="" position="1449,2358" size="100,100">(if: visits % 3 is 0)[
Erno got drunk and violated the toilet once again.  No one can use it, because he laid a complex and dangerous enchantment trap across it, claiming (either: &quot;that&#39;ll sort the bastards out.&quot;, &quot;the albino alligators were coming to get him.&quot;, &quot;it was a right laugh.&quot;)

Delilah kicks you both out!
[[Get Out!-&gt;Staggering Through The Alleys]] 
]
(else:)[
Delilah frowns slightly but overserves him, anyway.
&quot;Oh, most excellent virtue!  I&#39;ll tell you a bit of the helpful.&quot;

(display: &quot;Erno, The Enchanter&quot;)

[[Buy Erno a Drink]] ]</tw-passagedata><tw-passagedata pid="877" name="Reliquarium" tags="bookmark westfires lowerdepths location tick" position="4131,2316" size="100,100">This is the Reliquarium, a place where the Undead can purchase the kinds of things that an Undead thing needs.
(if: ((history:) contains &quot;Death&quot;))
[
The purse-faced thug at the door steps back as you approach.  A pursed grin appears on his face.
&quot;Come right on in, my brother,&quot; he mutters.
The pegs and cords stitching his lips together must be keeping his soul inside his somewhat decayed corpse.
[[Enter the Reliquarium]]
[[Home Again]] 
]
(else:)
[
The purse-faced thug at the door refuses your passage.  His nostrils flare in a manner designed to express a very specific disgust.  You notice by his general condition that he is at least partially or recently deceased.
&quot;You stink like someone who&#39;s never passed by the Veil,&quot; he sneers.  &quot;Turn around and go [[Home Again]], because the Reliquarium only accepts custom from the Undead.&quot;
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="878" name="Enter the Reliquarium" tags="" position="4241,2304" size="100,100">Within the reliquary, you meet Lilah, the head curator.
She grins at you with teeth filed to points.
&quot;Welcome to the reliquary.  You&#39;re finally ready to see what we have to offer.&quot;

(if: $LazarusBeaconCharges &lt; 10)
[
[[Relics for Initiates-&gt;Reliquary Display Case #1]]
]
(if: $LazarusBeaconCharges &lt; 9)
[
[[Relics for Novices-&gt;Reliquary Display Case #2]]
]
(if: $LazarusBeaconCharges &lt; 6)
[
[[Relics for Journeymen-&gt;Reliquary Display Case #3]] 
]

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="879" name="Exit the Reliquarium" tags="" position="4356,2177" size="100,100">In what is surely designed to be pure showmanship, as soon as you&#39;ve finished your purchase, you find yourself with it in your hands, back [[Home Again]].</tw-passagedata><tw-passagedata pid="880" name="Reliquary Display Case #1" tags="" position="4460,2316" size="100,100">Lilah waves one clawed hand over to a display case with three items.
&quot;These are our introductory items, for the recently deceased.&quot;

(for: each _item, ...(a: &quot;Crystal Spyglass&quot;, &quot;Damage Ward&quot;))[
(unless: $inventory contains _item)[(set: _cost to 35 + ($LazarusBeaconCharges * 5))(display: &quot;QuickBuy&quot;)]
]

[[Reliquarium]] 

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="881" name="Reliquary Display Case #2" tags="" position="4565,2316" size="100,100">Lilah waves one clawed hand over to a display case with two items.
&quot;These are our next-level items, for the maturely departed.&quot;

(for: each _item, ...(a: &quot;Slow Clock&quot;, &quot;Chameleon Scarf&quot;))[
(unless: $inventory contains _item)[(set: _cost to 170)(display: &quot;QuickBuy&quot;)]
]

[[Reliquarium]] 

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="882" name="Reliquary Display Case #3" tags="" position="4674,2309" size="100,100">Lilah waves one clawed hand over to a display case with two items.
&quot;These are our ultimate items, for the frequently deceased.&quot;

(for: each _item, ...(a: &quot;Silent Ansible&quot;, &quot;Neighborhood Door to Lower Depths&quot;))[
(unless: $inventory contains _item)[(set: _cost to 750)(display: &quot;QuickBuy&quot;)]
]

[[Reliquarium]] 

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="883" name="Ripper&#39;s Carnage" tags="tick" position="1222,2250" size="100,100">A shocked gasp arises from the crowd when someone stumbles across a mutilated corpse.  You&#39;ve heard about a serial murderer terrorising the (print: $neighborhood&#39;s name), and now you&#39;ve seen it for yourself.

(if: visits + $perception &gt; 7)[Hunched over the body is the twisted form of the killer, blood still on their hands.

[[The Beast Ripper]]]
(else:)[
(display: &quot;NavOptions&quot;)]</tw-passagedata><tw-passagedata pid="884" name="The Beast Ripper" tags="tick" position="1327,2247" size="100,100">You finally meet The Ripper face-to-face, and it is a face that you recognize.  This is the face of a man you killed yourself, his face now discolored and bloated from the effects of the poison you used to kill him.

He has somehow been brought back to life in some gruesome form of Undeath.
&quot;I can live,&quot; he says, &quot;but I must kill in order to survive.  My new form is an obligate predator.  I was a monster before, but now I&#39;ve done far worse things, and more!&quot;

[[Encounter: Rattle Bones]]</tw-passagedata><tw-passagedata pid="885" name="Encounter: Card Sharks" tags="encounter westfires" position="3768,4332" size="100,100">(display: &quot;Card Game&quot;)

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="886" name="Hexonium, the Alckymickematician" tags="westfires persona" position="1433,2594" size="100,100">Will definitely try to convince you to invest in their lead into gold scheme.

Hexonium, the Alckymickematician,
Your reputation with them can give access to alchemical secrets and recipes
Low-Level: 
    Ward Presses are a cheap way to make Damage Wards and other charms
    The Alckymickal district keeps regular hours.  If they are closed when you visit, come again later.
Mid-Level:
    Never mix X and Y, unless you are trying to make a noxious explosion.  In that case, you definitely want to mix X and Y.
    You can go [[Mudlarking]] for reagents.
High-Level:
    New Ward Press recipe</tw-passagedata><tw-passagedata pid="887" name="Magisterium Local Office: West Fires" tags="location unlisted westfires" position="1230,1807" size="100,100">(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="888" name="Init" tags="startup" position="3375,2469" size="100,100">{(set: $LazarusBeaconCharges to 10)

(set: $gold to 1337)
(set: $reputation to (dm: &quot;West Fires&quot;, 0, &quot;South Quarry&quot;, 0, &quot;North Harbor&quot;, 0, &quot;Eastern Fortress&quot;, 0, &quot;Lower Depths&quot;, 0, &quot;Upper Castlerock&quot;, 0, &quot;publican&quot;, -1, &quot;House Guild Mechanika&quot;, 0))

(set: $daemons to (ds: &quot;Living Shadow&quot; ))
(set: $inventory to (ds: &quot;Everfull Flask&quot;, &quot;Ethereal Threads&quot;, &quot;Blank Scroll&quot;, &quot;Ink of Enchantment&quot;, &quot;Maintenance Key&quot;, &quot;Map Fragment&quot;, &quot;Treasure Map&quot;, &quot;Damage Ward&quot;, &quot;Ex Nobilis Aetherium&quot;, &quot;Crystal Prism&quot;))
(set: $storage to (ds:))

(set: $macroCasterPlates to (a: &quot;Use Ward Press&quot;, &quot;Capture Fire Ghost&quot;, &quot;Use Healing Draught&quot;))

(set: $mail to (a:
(dm: &quot;sender&quot;, &quot;No one&quot;,
     &quot;message&quot;, &quot;My dearest, For you I have found a copy of your favorite childhood book.  Let it remind you of happier days.  &lt;The Signature has been obliterated with tears.&gt;&quot;,
	 &quot;attachment&quot;, &quot;A Young Wizard&#39;s Primer&quot;
)
))

(set: $requests to (dm:))
(set: $scheduledEvents to (dm:))
(set: $maxPerception to 2)
(set: $perception to $maxPerception)

(set: $maxCunning to 5)
(set: $cunning to $maxCunning)

(set: $maxHealth to 2)
(set: $health to $maxHealth)

(set: $client to (dm:))
(set: $clientDescription to &quot;&quot;)
(set: $currentContract to &quot;&quot;)
(set: $currentContractStatus to 0)
(set: $encounterStack to (a:))
(set: $encounterIndex to 0)
(set: $encounterPayout to 0)
(set: $encounterLength to 0)
(set: $encounterTimeLimit to 15)
(set: $encounterLocation to &quot;&quot;)

(set: $riftMaxSupplies to 200)
(set: $riftMaxCrew to 1)
(set: $riftMaxTreasure to 500)
(set: $riftSupplies to -20)
(set: $riftCrew to 10)
(set: $riftDistance to 0)
(set: $riftTripDistance to 9999999)
(set: $riftTreasure to 0)
(set: $riftCommand to -1)
(set: $riftNextJourney to &quot;&quot;)
(set: $riftDirection to 1)


(set: $miningCommand to 0)
(set: $miningCrew to 0)
(set: $miningWage to 0)
(set: $miningDistance to 0)
(set: $miningEvent to &quot;&quot;)
(set: $miningEvents to (a:))
(set: $miningDanger to 0)


(set: $forayStack to (a:))
(set: $forayExploration to 0)
(set: $forayCommand to 0)
(set: $forayCrew to 0)

(set: $labyrinthStack to (a:))

(set: $flaskType to &quot;Mystery Draught&quot;)

(set: $danger to 1)
(set: $rumors to (ds:))
(set: $scryingStoneCooldown to -13)

(set: $element to (either: &quot;fire&quot;, &quot;earth&quot;, &quot;water&quot;, &quot;air&quot;))
(if: $element is &quot;fire&quot;)[
(set: $inventory to it + (ds: &quot;Neighborhood Door to West Fires&quot;))
(display: &quot;Init West Fires&quot;)]
(else-if: $element is &quot;earth&quot;)[(set: $inventory to it + (ds: &quot;Neighborhood Door to South Quarry&quot;))
(display: &quot;Init South Quarry&quot;)]
(else-if: $element is &quot;water&quot;)[
(set: $inventory to it + (ds: &quot;Neighborhood Door to North Harbor&quot;))
(display: &quot;Init North Harbor&quot;)]
(else-if: $element is &quot;air&quot;)[
(set: $inventory to it + (ds: &quot;Neighborhood Door to Eastern Fortress&quot;))
(display: &quot;Init Eastern Fortress&quot;)]
}</tw-passagedata><tw-passagedata pid="889" name="Prelude" tags="" position="3506,2468" size="100,100">You are a wizard.
You are a wizard in a world where magic is common.
You are a two-bit hack of a wizard in the gritty underbelly of the capital city of a decadent empire on the edge of ruin.
(set: $playerHistory to (display: &quot;RandomPlayerHistory&quot;))
$playerHistory

Now, you&#39;ve moved into this garrett with nought, determined to make this place your home.

Let&#39;s get into it, then...
[[Home Again]]





























[[Use the Incredibly Secret Machine]]</tw-passagedata><tw-passagedata pid="890" name="Home Again" tags="tick" position="3632,2406" size="200,200">{(set: _library to (find: _item where (passage: _item)&#39;s tags contains &quot;book&quot;, ...$inventory))
(set: _furniture to (find: _item where (passage: _item)&#39;s tags contains &quot;furniture&quot;, ...$inventory))}

Home-sweet-home.

You enter via the secret door in the back.  You never use the door in the front.
A quick check on your [[Lazarus Beacon]] shows you have $LazarusBeaconCharges charges left.  (if: $LazarusBeaconCharges is 0)[ The next time is for real, tough guy.  You&#39;d best not slip. ](else-if: $LazarusBeaconCharges &lt; 3)[ You&#39;re running low.  Be careful out there, and get some money to the artificer for a recharge as soon as you can. ](else-if: $LazarusBeaconCharges &lt; 7)[ You&#39;ve taken a few hits, but you&#39;re still plenty hale! ](else:)[ You are alive with the raw power afforded you by your arcane artifact! ]
(if: $currentContract is not &quot;&quot;)[$currentContract: (link-goto: &quot;Continue Contract&quot;, &quot;Encounter&quot;)]
(unless: _furniture contains &quot;Secret Compartment&quot;)[(if: $perception &gt; 3)[You never noticed a loose panel near the floor board before. [[Check the Loose Panel in Your Floor]]]]

(if: $mail&#39;s length  &gt; 0)[ [[Read Your Mail]] ]

(if: _library&#39;s length &gt; 0)[ [[Read a Book In Your Library]] ]

(if: _furniture&#39;s length &gt; 0)[(for: each _item, ..._furniture)[ (link-goto: &quot;Use &quot; + _item)
]]







Oh, what&#39;s this?
[[Nest of Box Adders]]</tw-passagedata><tw-passagedata pid="891" name="Encounter" tags="" position="2550,2395" size="200,100">{(if: $encounterIndex &gt; $encounterStack&#39;s length)[
	(if: $neighborhood&#39;s name is &quot;&quot;)[(goto: &quot;Home Again&quot;)]
	(goto: &quot;Explore the Neighborhood&quot;)
]
(display: &quot;Tick&quot;)
(goto: $encounterStack&#39;s ($encounterIndex))
}</tw-passagedata><tw-passagedata pid="892" name="Display Random Color" tags="" position="4121,2990" size="100,100">You press through the crowd in the (either: &quot;Liar&#39;s&quot;, &quot;Fool&#39;s&quot;, &quot;Murderer&#39;s&quot;, &quot;Bastard&#39;s&quot;, &quot;Sweet&quot;, $element) (either: &quot;Market&quot;, &quot;Bazaar&quot;, &quot;Exchange&quot;, &quot;Soukh&quot;), keeping an eye out for your quarry and any traps or henchmen they&#39;ve put in your path.
(either: &quot;Shady transactions.&quot;, &quot;Steamy eye contact.&quot;, &quot;Little dogs eating rats.&quot;)
(display: &quot;Display Random Color Person&quot;)</tw-passagedata><tw-passagedata pid="893" name="RenderHeader" tags="" position="3390,2175" size="100,100">&lt;p id=&quot;header&quot;&gt;ASTUS: $cunning SENSU: $perception VITAE: $health KRONO: (print: (floor: $ticks / 169)):(print: (floor: $ticks / 13 % 13)):(print: $ticks % 13) OROS: $gold &lt;a href=&quot;#inventory&quot;&gt;+&lt;/a&gt;
&lt;b&gt;(print: (passage:)&#39;s name)&lt;/b&gt;
---
&lt;/p&gt;</tw-passagedata><tw-passagedata pid="894" name="Tick" tags="function" position="3503,2175" size="100,100">{(set: $ticks to it + 1)(display: &quot;Execute Scheduled Events&quot;)
(if: $ticks % 13 is 7)[(display: &quot;TickMining&quot;)]
(if: $ticks % 13 is 3)[//It is Dawn.//(set: $isDay to 1)&lt;br/&gt;]
(if: $ticks % 13 is 9)[//It is Dusk.//(set: $isDay to 0)&lt;br/&gt;]
}</tw-passagedata><tw-passagedata pid="895" name="Inventory" tags="" position="3605,2085" size="100,100">(if: $inventory&#39;s length &gt; 0)[The contents of your various pockets, hidey-holes, and secret pouches contains $gold gold coins and
(for: each _item, ...($inventory))[(link-reveal: _item)[
&lt;i&gt;(display: _item)&lt;/i&gt;]
]
](else:)[You haven&#39;t a solitary thing other than your $gold gold coins and the clothes on your back.  Your library is quite bare at the moment.  A spider has written a message in a cobweb for you, but you don&#39;t read Lost Veringian pictograms.
]

(if: $daemons&#39;s length &gt; 0)[You currently have the following daemons in your thrall:
(for: each _daemon, ...$daemons)[(link-reveal: _daemon)[: //(display: _daemon)//]
]
](else:)[//You currently have no daemons in your thrall.//
]

(if: $currentContract != &quot;&quot;)[You currently are engaged in the following business:
$currentContract
(display: &quot;Description &quot; + $currentContract)
](else:)[//You are currently looking for employment.//
]</tw-passagedata><tw-passagedata pid="896" name="Clock" tags="" position="3617,2166" size="100,100">(display: &quot;Tick&quot;)(display: &quot;RenderHeader&quot;) (link-goto: &quot;Inventory&quot;)</tw-passagedata><tw-passagedata pid="897" name="Item For Sale" tags="" position="5257,2244" size="100,100">(set: _i1 to _item)(set: _i2 to _cost)
_i1
(display: _i1)
It will cost you _i2 gold.(if: $gold &gt;= _i2)[  You can afford it, though.]
(link-reveal-goto: &quot;Buy It&quot;, (history:)&#39;s last)[(set: $inventory to it + (ds: _i1))(set: $gold to it - _i2)](else:)[  Quite a bit too rich for your blood.]

(link-goto: (history:)&#39;s last)</tw-passagedata><tw-passagedata pid="898" name="Read a Book In Your Library" tags="" position="3654,2609" size="100,100">A well-kept library makes for a well-kept mind.  Even rereading favorite old tomes can yield surpising new fruit.
(for: each _item, ...$inventory)[(if: (passage: _item)&#39;s tags contains &quot;book&quot;)[
(link-goto: _item, &quot;Read &quot; + _item)
]]

[[Home Again]]</tw-passagedata><tw-passagedata pid="899" name="Furniture For Sale" tags="" position="4583,2437" size="100,100">$itemName
(display: $itemName)
It will cost you $goldCost gold.
(if: $gold &gt;= $goldCost)[You can afford it, though.
(link-reveal-goto: &quot;Buy It&quot;, (history:)&#39;s last)
[(set: $inventory to it + (ds: $itemName))
(set: $gold to it - $goldCost)
]]
(else:)[Quite a bit too rich for your blood.
]
(link-goto: &quot;Continue Browsing for Furniture&quot;, (history:)&#39;s last) 

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="900" name="RandomPlayerHistory" tags="" position="3284,2285" size="100,100">(either: &quot;You were a country bumpkin who was orphaned.  You sold your family farm for a pittance to try your luck in the big city.&quot;,
&quot;You were a minor aristocrat of some means, but you disgraced yourself by failing at University.&quot;,
&quot;You came to the city to take a clerking job, but the job did not exist, and your recruiter turned out to be a con artist who took most of your money.&quot;)</tw-passagedata><tw-passagedata pid="901" name="Play With Your Calculator" tags="" position="3517,2583" size="100,100">The garrett came with this brass contraption, as the previous occupant had died with it in their possession, and no one could be arsed to move the unspeakably heavy thing that occupies a good fifth of your habitable space.

(set: $d to (dm: &quot;foo&quot;, 0))
(link-repeat: &quot;Adding to Data Maps&quot;)[(set: $d&#39;s foo to $d&#39;s foo + 1)(replace:?output)[$d]]
|output&gt;[$d]

(set: $a to (a: (dm: &quot;foo&quot;, 0)))
(link-repeat: &quot;Adding to Array of Data Maps&quot;)[(set: $a to it + (a:(dm: &quot;foo&quot;, (random: 0, 9999))))(replace:?output2)[$a]]
|output2&gt;[$a]

(set: $s to (ds: (random: 0,999)))(link-repeat: &quot;Adding to Dataset&quot;)[
(set: $s to it + (ds: (random: 0,999)))
(replace:?output3)[$s]]
|output3&gt;[$s]</tw-passagedata><tw-passagedata pid="902" name="TakeDamage" tags="function" position="3616,2286" size="100,100">{(if: $inventory contains &quot;Damage Ward&quot;)
[
Your steadfast Damage Ward glows hot and bright for a moment as waves of death lash out at you, and once the danger passes, it becomes once again an inert lump of lead.
(set: $inventory to $inventory - (ds: &quot;Damage Ward&quot;))
(set: $inventory to $inventory + (ds: &quot;Lump of Lead&quot;))
]
(else:)
[
&lt;br/&gt;&lt;b&gt;Health - $arg&lt;/b&gt;(set: $health to it - $arg)(if: $deathReason is &quot;&quot;)[(set: $deathReason to &quot;Health - &quot; + (str:$arg))]
]
(if: $health &lt;= 0)[(goto: &quot;Death&quot;)]}
(replace:?clock)[(display: &quot;Tick&quot;)(display:&quot;RenderHeader&quot;)]</tw-passagedata><tw-passagedata pid="903" name="DealDamage" tags="function" position="5210,3372" size="100,100">&lt;br/&gt;&lt;b&gt;Damage + $arg&lt;/b&gt;
{(set: $enemyHealth to it - $arg)(if: $enemyHealth &lt;= 0)[(replace:?input)[You&#39;ve defeated your enemy!(set: $deathReason to &quot;&quot;)(set: $enemyType to &quot;&quot;)]](else:)[Your enemy yet lives.]}</tw-passagedata><tw-passagedata pid="904" name="QuickBuy" tags="" position="5260,2352" size="100,100">(unless: $inventory contains _item)[_item
(display: _item)(set: _i1 to _item)(set: _i2 to _cost)  It will cost you _i2 gold.(if: $gold &gt;= _i2)[ You can afford it. (link-reveal-goto: &quot;Buy It&quot;, (passage:)&#39;s name)[(set: $inventory to it + (ds: _i1))(set: $gold to it - _i2)]
](else:)[ Quite a bit too rich for your blood.]]</tw-passagedata><tw-passagedata pid="905" name="Wander the Neighborhood" tags="" position="3134,1377" size="200,200">{(display: &quot;Tick&quot;)}
(display: $neighborhood&#39;s name + &quot; Color&quot;)
(set: _reputationTag to &quot;brass-level&quot;)
{(set: _availableContracts to (find: _item where not ((passage: _item)&#39;s tags  contains &quot;unique&quot;) or not ((history:) contains _item and (passage: _item)&#39;s tags contains &quot;contract&quot;), ...($neighborhood&#39;s contracts)))
(set: _roll to (random: 0, 10))}
(if: _availableContracts&#39;s length &gt; 0 and $currentContract is &quot;&quot; and _roll &lt; 3)[(set: _potentialContract to (either: ..._availableContracts))
{(display: &quot;GenerateChar&quot;)(set: $clientDescription to $char)(set: _char to $char)}
&lt;br/&gt;
(display: (text: ...(a: &quot;Description &quot;, _potentialContract)))

(link-goto: &quot;Accept Contract&quot;, _potentialContract)

(display: &quot;NavOptions&quot;)
](else-if: _roll &lt; 6)[Something happens!

(goto: (either: ...($neighborhood&#39;s events)))](else:)[

(either: &quot;You happen across something interesting...&quot;, &quot;You unearth a hidden secret of the market...&quot;, &quot;You hadn&#39;t seen this here before...&quot;)
(set: _locations to (find: _item where not ((history:) contains _item and (passage: _item)&#39;s tags contains &quot;bookmark&quot;) and (passage: _item)&#39;s tags contains &quot;location&quot;, ...($neighborhood&#39;s locations)))

(if: _locations&#39;s length &gt; 0)[(link-goto: (either: ..._locations))](else:)[No, I guess you&#39;d already seen that, too.]

(display: &quot;NavOptions&quot;) ]</tw-passagedata><tw-passagedata pid="906" name="QuickChar" tags="" position="4010,2662" size="100,100">(if: (random: 0,2) &gt; 1)[
(either: ...$sizes) (either: ...$genders) (either: ...$races) with (either: ...$clothingColors) (either: ...$clothingMaterials) (either: ...$clothingTypes) and (either: ((either: ...$adornmentMaterials), (either: ...$adornmentTypes)), (either: ...$hairstyles))
](else-if: (random: 0,2) &gt; 0)[
(either: ((either: ...$sizes) + &quot; &quot; + (either: ...$genders)), ((either: ...$races) + &quot; &quot; +  (either: ...$genders)), ((either: ...$sizes) + &quot; &quot; +  (either: ...$races)), ((either: ...$sizes) + &quot; &quot; + (either: ...$races) + &quot; &quot; + (either: ...$genders))) with (either: ...$clothingColors) (either: ...$clothingMaterials) (either: ...$clothingTypes) and (either: ((either: ...$adornmentMaterials) + &quot; &quot; + (either: &quot;lip&quot;, &quot;ear&quot;, &quot;nose&quot;, &quot;cheek&quot;) + &quot; &quot; + (either: ...$adornmentTypes) + &quot;s&quot;), 
(&quot;a(n) &quot; + (either: ...$adornmentMaterials) + &quot; &quot; + (either: &quot;lip&quot;, &quot;ear&quot;, &quot;nose&quot;, &quot;cheek&quot;) + &quot; &quot; + (either: ...$adornmentTypes)),
(either: ...$hairstyles))
](else:)[(display: &quot;GenerateChar&quot;)(set: _char to $char)(display: &quot;DescribeChar&quot;)]</tw-passagedata><tw-passagedata pid="907" name="GenerateChar" tags="" position="4012,2766" size="100,100">{(set: $char to 
	(dm: &quot;size&quot;, (either: ...$sizes),
	     &quot;gender&quot;, (either: ...$genders),
		 &quot;race&quot;, (either: ...$races),
		 &quot;skinColor&quot;, (either: ...$skinColors),
		 &quot;skinType&quot;,  (either: ...$skinTypes),
		 &quot;hairstyle&quot;, (either: ...$hairstyles),
		 &quot;clothingMaterial&quot;, (either: ...$clothingMaterials),
		 &quot;clothingColor&quot;, (either: ...$clothingColors),
		&quot;clothingType&quot;, (either: ...$clothingTypes),
		&quot;adornmentMaterial&quot;, (either: ...$adornmentMaterials),
		&quot;adornmentType&quot;, (either: &quot;lip&quot;, &quot;ear&quot;, &quot;upper ear&quot;, &quot;nose&quot;, &quot;septum&quot;, &quot;cheek&quot;, &quot;neck&quot;, &quot;wrist&quot;, &quot;upper arm&quot;, &quot;ankle&quot;) + &quot; &quot; + (either: ...$adornmentTypes),
		&quot;profession&quot;, (either: ...$professions)))
}</tw-passagedata><tw-passagedata pid="908" name="DescribeChar" tags="" position="4013,2869" size="100,100">{(set: _generalDescription to (either: ((_char&#39;s size) + &quot; &quot; + (_char&#39;s gender)), ((_char&#39;s race) + &quot; &quot; + (_char&#39;s gender)), ((_char&#39;s size) + &quot; &quot; + (_char&#39;s race)), ((_char&#39;s size) + &quot; &quot; + (_char&#39;s race) + &quot; &quot; + (_char&#39;s gender))))
(set: _skinDescription to (either: ((_char&#39;s skinType) + &quot; &quot; + (_char&#39;s skinColor)), (_char&#39;s skinColor), (_char&#39;s skinType))+&quot;-skinned&quot;)
(set: _adornmentDescription to (either: &quot;a &quot;+(_char&#39;s adornmentMaterial)+&quot; &quot;+(_char&#39;s adornmentType), (_char&#39;s adornmentMaterial)+&quot; &quot;+(_char&#39;s adornmentType)+&quot;s&quot;))
(set: _clothingDescription to (either:
((_char&#39;s clothingColor),
(&quot;a &quot;+(_char&#39;s clothingMaterial)+&quot; &quot;+(_char&#39;s clothingType))),
((&quot;a &quot;+_char&#39;s clothingColor)+&quot; &quot;+(_char&#39;s clothingType))))

(if: (random: 0, 1) &gt; 0)[
_skinDescription _generalDescription with _adornmentDescription, _clothingDescription, and (print: _char&#39;s hairstyle)(either: &quot; that appears to be a &quot; + (_char&#39;s profession), &quot;&quot;,&quot;&quot;)
](else:)[
(either: _skinDescription+&quot; &quot;,&quot;&quot;,&quot;&quot;)_generalDescription (either: (_char&#39;s profession)+&quot; &quot;, &quot;&quot;,&quot;&quot;)wearing (either: _adornmentDescription, &quot;a &quot;+_clothingDescription, _char&#39;s hairstyle)]
}</tw-passagedata><tw-passagedata pid="909" name="QuickSetting" tags="" position="4014,2986" size="100,100">(either: &quot;naturally &quot; + (either: ...$environmentColors) + &quot; &quot;, (either: ...$environmentColors) + &quot;painted &quot;, &quot;&quot;)(either: ...$environmentMaterials) (either: &quot;garrett&quot;, &quot;workshop&quot;, &quot;brothel&quot;, &quot;tannery&quot;, &quot;kiln&quot;, &quot;restaurant&quot;, &quot;barber&quot;,&quot;atelier&quot;)</tw-passagedata><tw-passagedata pid="910" name="UpdateReputation" tags="function" position="3842,2403" size="100,100">{(if: $neighborhood is 0)[ERROR]
(else:)[ //(print: $neighborhood&#39;s name) Reputation (if: $arg &gt;= 0)[+] $arg//
(set: $reputation&#39;s ($neighborhood&#39;s name) to $reputation&#39;s ($neighborhood&#39;s name) + $arg)&lt;br/&gt;&lt;br/&gt;
(if: $reputation&#39;s ($neighborhood&#39;s name) &gt; 9)[People know they can count on you.](else-if: $reputation&#39;s ($neighborhood&#39;s name) &gt; 5)[You&#39;re a bit of a known entity about these parts.](else-if: $reputation&#39;s ($neighborhood&#39;s name) &gt; 0)[You&#39;re not particularly well known.](else-if: $reputation&#39;s ($neighborhood&#39;s name) &gt; -5)[You&#39;re a bit of a shifty dodger, innit?]
(else:)[
(if: $inventory contains &quot;Badge of Shame&quot;)[People know you&#39;re not to be trusted.](else:)[You&#39;ve gone back on your word too many times, and a few of the locals have ganged up to make sure everyone else knows it.  They cut you up with a razor.&lt;br/&gt;&lt;br/&gt;(set: $arg to &quot;Badge of Shame&quot;)(display: &quot;GetItem&quot;)]
]]}</tw-passagedata><tw-passagedata pid="911" name="header" tags="header" position="3262,2470" size="100,100">|clock&gt;[](if: (passage:)&#39;s tags contains &quot;tick&quot;)(display: &quot;Tick&quot;)</tw-passagedata><tw-passagedata pid="912" name="footer" tags="footer" position="3272,2582" size="100,100">&lt;br/&gt;
---
&lt;p id=&quot;inventory&quot;&gt;&lt;a href=&quot;#header&quot;&gt;^&lt;/a&gt;
(display: &quot;Inventory&quot;)&lt;/p&gt;
(display: &quot;UpdateClock&quot;)</tw-passagedata><tw-passagedata pid="913" name="Fight" tags="" position="3778,4206" size="100,100">{(set: _deck to (a: &quot;Block&quot;, &quot;Throw&quot;, &quot;Strike&quot;) +
(altered: _i via &quot;Release &quot; + _i, ...$daemons) + 
(altered: _i via &quot;Use &quot; + _i, ...(find: _i where (passage: _i)&#39;s tags contains &quot;weapon&quot;, ...$inventory)))
(set: _deck to (shuffled: ..._deck)&#39;s (range: 1, (min: $cunning, _deck&#39;s length)))}
(for: each _d, ..._deck)[(set: _id to _d)
(link-reveal: _id)[(replace:?output)[(display: _id)](replace:?input)[(display: &quot;Fight&quot;)]
]]</tw-passagedata><tw-passagedata pid="914" name="Use the Incredibly Secret Machine" tags="" position="3380,2579" size="100,100">You see a bank of dials and a lever.
(cycling-link: bind _a, &quot;E&quot;,&quot;A&quot;,&quot;T&quot;,&quot;O&quot;,&quot;I&quot;,&quot;N&quot;,&quot;S&quot;,&quot;H&quot;,&quot;R&quot;,&quot;D&quot;,&quot;L&quot;,&quot;U&quot;)
(cycling-link: bind _b, &quot;E&quot;,&quot;A&quot;,&quot;T&quot;,&quot;O&quot;,&quot;I&quot;,&quot;N&quot;,&quot;S&quot;,&quot;H&quot;,&quot;R&quot;,&quot;D&quot;,&quot;L&quot;,&quot;U&quot;)
(cycling-link: bind _c, &quot;E&quot;,&quot;A&quot;,&quot;T&quot;,&quot;O&quot;,&quot;I&quot;,&quot;N&quot;,&quot;S&quot;,&quot;H&quot;,&quot;R&quot;,&quot;D&quot;,&quot;L&quot;,&quot;U&quot;)
(cycling-link: bind _d, &quot;E&quot;,&quot;A&quot;,&quot;T&quot;,&quot;O&quot;,&quot;I&quot;,&quot;N&quot;,&quot;S&quot;,&quot;H&quot;,&quot;R&quot;,&quot;D&quot;,&quot;L&quot;,&quot;U&quot;)
(cycling-link: bind _e, &quot;E&quot;,&quot;A&quot;,&quot;T&quot;,&quot;O&quot;,&quot;I&quot;,&quot;N&quot;,&quot;S&quot;,&quot;H&quot;,&quot;R&quot;,&quot;D&quot;,&quot;L&quot;,&quot;U&quot;)
(cycling-link: bind _f, &quot;E&quot;,&quot;A&quot;,&quot;T&quot;,&quot;O&quot;,&quot;I&quot;,&quot;N&quot;,&quot;S&quot;,&quot;H&quot;,&quot;R&quot;,&quot;D&quot;,&quot;L&quot;,&quot;U&quot;)
(link-repeat: &quot;Pull Lever&quot;)[(if: (a: _a, _b, _c, _d, _e, _f) is (a:&quot;E&quot;,&quot;A&quot;,&quot;T&quot;,&quot;O&quot;,&quot;I&quot;,&quot;N&quot;))[Ah, the First Prestige!  You have made quite shrewd investments in the world of transdimensional enchanted finance, and so you shall begin this story with an embarassment of wealth.
(set: $gold to 9999999)]
(else-if: (a: _a, _b, _c, _d, _e, _f) is (a:&quot;S&quot;,&quot;H&quot;,&quot;R&quot;,&quot;D&quot;,&quot;L&quot;,&quot;U&quot;))[Ah, the Second Prestige!  Known to all neighborhoods, a real cosmopolitan!
(for: each _item, &quot;West Fires&quot;, &quot;Eastern Fortress&quot;, &quot;North Harbor&quot;, &quot;South Quarry&quot;, &quot;Lower Depths&quot;, &quot;Upper Castlerock&quot;)[(set: $arg to &quot;Neighborhood Door to &quot; + _item)(display: &quot;GetItem&quot;)]]
(else-if: (a: _a, _b, _c, _d, _e, _f) is (a:&quot;T&quot;,&quot;R&quot;,&quot;E&quot;,&quot;A&quot;,&quot;T&quot;,&quot;S&quot;))[
Everything you could ever want is yours.
(set: $inventory to (ds: (altered: via its name, ...(find: _i where _i&#39;s tags contain &quot;item&quot;))))
]
(else-if: (a: _a, _b, _c, _d, _e, _f) is (a:&quot;E&quot;,&quot;T&quot;,&quot;E&quot;,&quot;R&quot;,&quot;N&quot;,&quot;A&quot;))[
You&#39;ve killed Death itself!
(set: $maxHealth to 9999)(set: $health to $maxHealth)(set: $LazarusBeaconCharges to 9999)
]
(else-if: (a: _a, _b, _c, _d, _e, _f) is (a:&quot;S&quot;,&quot;A&quot;,&quot;I&quot;,&quot;N&quot;,&quot;T&quot;,&quot;S&quot;))[
Universally beloved, if only due to an incredibly powerful glamour.
(set: $reputation to (dm: &quot;public&quot;, 9999))
]
(else-if: (a: _a, _b, _c, _d, _e, _f) is (a:&quot;U&quot;,&quot;L&quot;,&quot;T&quot;,&quot;R&quot;,&quot;A&quot;,&quot;S&quot;))[
You are the ultimate Magician!
(set: $maxCunning to 9999)(set: $maxPerception to 9999)
(set: $cunning to $maxCunning)(set: $perception to $maxPerception)
]
(else:)[
The gears clink and grind in an unpleasant manner, but no result is forthcoming from the machine.
]
]

// debug //

(set: $gold to 9999999)
(set: $inventory to (ds: ...(altered: via its name, ...(passages: where its tags contains any of (a: &quot;item&quot;, &quot;book&quot;, &quot;furniture&quot;)))))

(set: $maxHealth to 9999)(set: $health to $maxHealth)(set: $LazarusBeaconCharges to 9999)
(set: $reputation&#39;s ($neighborhood&#39;s name)  9999)
(set: $maxCunning to 9999)(set: $maxPerception to 9999)
(set: $cunning to $maxCunning)(set: $perception to $maxPerception)

[[Home Again]]</tw-passagedata><tw-passagedata pid="915" name="Check the Loose Panel in Your Floor" tags="" position="3513,2705" size="100,100">(set: $inventory to it + (ds: &quot;Secret Compartment&quot;))
You&#39;ve found some kind of Secret Compartment in the floor of your apartment.  The loose panel slides apart, revealing a little cranny.

(display: &quot;Secret Compartment&quot;)

[[Use Secret Compartment]]</tw-passagedata><tw-passagedata pid="916" name="Use Secret Compartment" tags="" position="3508,2852" size="100,100">You reach your hand into the secret compartment and find a Witch Bottle.
Gross! You try to put it back, but the secret compartment is already full.  Unfortunately, it looks like the compartment is covered up so that an infinite amount of witch bottles from the dimension where everything is witch bottles doesn&#39;t accidentally spill over into this universe.
(set: $arg to &quot;Witch Bottle&quot;)(display: &quot;GetItem&quot;)
[[Home Again]]</tw-passagedata><tw-passagedata pid="917" name="Secret Compartment" tags="furniture" position="3398,2853" size="100,100">A hidey-hole in the floor of your apartment that you found some time ago.</tw-passagedata><tw-passagedata pid="918" name="NavOptions" tags="" position="3831,2286" size="100,100">[[Explore the Neighborhood]]

(link-goto: $neighborhood&#39;s name)

[[Home Again]]</tw-passagedata><tw-passagedata pid="919" name="UpdateGold" tags="function" position="3835,2179" size="100,100">(set: $gold to it + $arg)&lt;br/&gt;&lt;b&gt;Gold (if: $arg &gt;= 0)[+ ]$arg&lt;/b&gt;(display: &quot;UpdateClock&quot;)(if: $gold &lt; 0)[You&#39;ve one into debt!(display: &quot;An Embarassing Display&quot;)]</tw-passagedata><tw-passagedata pid="920" name="GetItem" tags="function" position="3946,2177" size="100,100">(if: $arg is &quot;Map Fragment&quot; and $inventory contains &quot;Map Fragment&quot;)[
(display: &quot;LoseItem&quot;)(set: $arg to &quot;Treasure Map&quot;)(display: &quot;GetItem&quot;)
You assemble the Map Fragments into an approximation of a Treasure Map.
]
(else:)[(set: $inventory to it + (ds: $arg))&lt;br/&gt;&lt;b&gt;+ $arg&lt;/b&gt;]</tw-passagedata><tw-passagedata pid="921" name="LoseItem" tags="function" position="3946,2285" size="100,100">(if: $inventory contains $arg)[(set: $inventory to it - (ds: $arg))&lt;br/&gt;&lt;b&gt;- $arg&lt;/b&gt;]</tw-passagedata><tw-passagedata pid="922" name="Explore the Neighborhood" tags="tick" position="3421,1866" size="200,200">{
(if: $perception &lt;= 0)[
(goto: &quot;Staggering Through The Alleys&quot;)
]
(if: (random: 0, 3) is 0)[(goto: (either: ...($neighborhood&#39;s events)))]
(display: $neighborhood&#39;s name + &quot; Color&quot;)&lt;br/&gt;
(if: $reputation&#39;s ($neighborhood&#39;s name) &lt; 5)[(set: $reputationTag to &quot;brass-level&quot;)]
(else-if: $reputation&#39;s ($neighborhood&#39;s name) &lt; 15)[(set: $reputationTag to &quot;silver-level&quot;)]
(else:)[(set: $reputationTag to &quot;gold-level&quot;)]

(if: $currentContract is &quot;&quot;)[
(display: &quot;GenerateChar&quot;)(set: $clientDescription to $char)
(set: $potentialContracts to (find: _item where (not ((passage: _item)&#39;s tags  contains &quot;unique&quot;) or not ((history:) contains _item)) and (passage: _item)&#39;s tags contains all of (a: &quot;contract&quot;, $reputationTag), ...($neighborhood&#39;s contracts)))
(if: $potentialContracts&#39;s length &gt; 1)[Exploring the neighborhood, you meet many prospective clients...&lt;br/&gt;
(for: each _i, ...((shuffled: ...$potentialContracts)&#39;s (range: 1, (min: 3, (ceil: $perception/2)))))[
(link-goto: _i)&lt;br/&gt;&lt;br/&gt;
]](else-if: $potentialContracts&#39;s length is 1)[Exploring the neighborhood, you make contact with a client...&lt;br/&gt;
(link-goto: $potentialContracts&#39;s 1st)]
](else:)[Either no one&#39;s looking for contractors or no one&#39;s looking for *you*.  Either way, there&#39;s no work to be had.]
}

And you encounter many interesting locations...
{(set: _locations to (find: _item where not ((history:) contains _item and (passage: _item)&#39;s tags contains &quot;bookmark&quot;) and not ((passage: _item)&#39;s tags contains &quot;unlisted&quot;), ...($neighborhood&#39;s locations)))
(if: _locations&#39;s length &gt; 0)[
(if: _locations&#39;s length is 1)[(link-goto: _locations&#39;s 1st)]
(else:)[
(for: each _i, ...((shuffled: ..._locations)&#39;s (range: 1, (min: 3, (ceil: $perception/2)))))[
(link-goto: _i)&lt;br/&gt;&lt;br/&gt;
]]](else:)[No, I guess you&#39;d already seen that, too.]}

(display: &quot;NavOptions&quot;)</tw-passagedata><tw-passagedata pid="923" name="Block" tags="" position="3996,4089" size="100,100">{(set: _opponentMove to $fightPattern&#39;s ($fightIndex))
(replace:?output)[(if: _opponentMove is &quot;Flee&quot;)[(replace:?input)[  ](replace:?output)[They turn and run away at top speed.
(set: $enemyHealth to 0)]](else-if: _opponentMove is &quot;Block&quot;)[You block their attack... but they block, too.  It&#39;s awkward.](else-if: _opponentMove is &quot;Throw&quot;)[You anticipate an attack and block.  They grab at your locked wrists and throw you about! (set: $arg to (random: 0, 1))(display: &quot;TakeDamage&quot;)(if: $inventory contains &quot;Thorn Ward&quot;)[Your thorn ward produces sharp spines(set: $arg to (random: 0, 1))(display: &quot;DealDamage&quot;)]](else-if: _opponentMove is &quot;Strike&quot;)[They strike at you, but you block their attack!
(if: $inventory contains &quot;Thorn Ward&quot;)[Your thorn ward produces sharp spines(set: $arg to (random: 0, 1))(display: &quot;DealDamage&quot;)]]]
(set: $fightIndex to (it + 1))
(if: $fightIndex &gt; $fightPattern&#39;s length)[(set: $fightIndex to 1)(display: &quot;UpdateClock&quot;)]
(if: $inventory contains &quot;Thorn Ward&quot; and (random: 0, 4) is 0)[Your Thorn Ward shatters!&lt;br/&gt;(set: $arg to &quot;Thorn Ward&quot;)(display: &quot;LoseItem&quot;)]
}</tw-passagedata><tw-passagedata pid="924" name="Strike" tags="" position="4104,4089" size="100,100">{(set: _opponentMove to $fightPattern&#39;s ($fightIndex))
(replace:?output)[You launch a strike at your opponent&#39;s temple.(if: _opponentMove is &quot;Flee&quot;)[(replace:?input)[ [[Next Encounter]] ](replace:?output)[They turn and run away at top speed.]](else-if: _opponentMove is &quot;Block&quot;)[.. but they bat your fist away.](else-if: _opponentMove is &quot;Throw&quot;)[  As they dip in to grab your arm, you pop them in the throat.(set: $arg to 2)(display: &quot;DealDamage&quot;)](else-if: _opponentMove is &quot;Strike&quot;)[  You trade slaps at each other, bloodying each other&#39;s noses.(set: $arg to 1)(display: &quot;DealDamage&quot;)(display: &quot;TakeDamage&quot;)](else:)[  They make no move to avoid it and take the full brunt of your blow.(set: $arg to 2)(display: &quot;DealDamage&quot;)]]
(set: $fightIndex to (it + 1))
(if: $fightIndex &gt; $fightPattern&#39;s length)[(set: $fightIndex to 1)]
(display: &quot;UpdateClock&quot;)}</tw-passagedata><tw-passagedata pid="925" name="Throw" tags="" position="4210,4089" size="100,100">{(set: _opponentMove to $fightPattern&#39;s ($fightIndex))
(replace:?output)[You attempt to throw them.(if: _opponentMove is &quot;Flee&quot;)[(replace:?input)[ [[Next Encounter]] ](replace:?output)[They turn and run away at top speed.]](else-if: _opponentMove is &quot;Block&quot;)[ You get a firm grip on their leg and throw them to the ground. (set: $arg to 1)(display: &quot;DealDamage&quot;)](else-if: _opponentMove is &quot;Throw&quot;)[  The two of you grapple indecisively for a few seconds before pulling apart again.](else-if: _opponentMove is &quot;Strike&quot;)[As you attempt to grapple them, they land a sharp punch to your liver. (set: $arg to 1)(display: &quot;TakeDamage&quot;)]]
(else:)[You flip your opponent onto their back.
(set: $arg to (random: 0, 1))(display: &quot;DealDamage&quot;)]
(set: $fightIndex to (it + 1))
(if: $fightIndex &gt; $fightPattern&#39;s length)[(set: $fightIndex to 1)]
(display: &quot;UpdateClock&quot;)}</tw-passagedata><tw-passagedata pid="926" name="Lazarus Beacon" tags="" position="3878,2598" size="100,100">The first night you woke up in this squalid apartment, you found an actual Lazarus Beacon hidden inside a hideous desk lamp.  Once attuned with its owner, it can use a single charge to return them to life.

In a word, you are immortal.

Caveat: These charges are expended each time you are resurrected.  You currently have $LazarusBeaconCharges of them.

(link-goto: (history:)&#39;s last)</tw-passagedata><tw-passagedata pid="927" name="UpdateClock" tags="function" position="3711,2054" size="100,100">(replace:?clock)[(display: &quot;RenderHeader&quot;)]</tw-passagedata><tw-passagedata pid="928" name="GainHealth" tags="function" position="3499,2293" size="100,100">&lt;br/&gt;&lt;b&gt;Health + $arg&lt;/b&gt;(set: $health to it + $arg)
(display: &quot;UpdateClock&quot;)</tw-passagedata><tw-passagedata pid="929" name="UpdateCunning" tags="function" position="3825,2055" size="100,100">(set: $cunning to it + $arg)&lt;b&gt;Cunning (if: $arg &gt;= 0)[+] $arg ($cunning)&lt;/b&gt;(if: $cunning &lt;= 0)[(set: $deathReason to &quot;It turns out that there is a level of stupidity so great that you become too stupid to keep breathing.  Whatever you&#39;ve done to yourself, my treasure: That is what killed you this time.&quot;)(goto: &quot;Death&quot;)]</tw-passagedata><tw-passagedata pid="930" name="Math Test" tags="function" position="4878,2672" size="100,100">(set: $val to 0)
&lt;div style=&quot;display:none&quot;&gt;(set: $val to 1)&lt;/div&gt;
-&gt; $val</tw-passagedata><tw-passagedata pid="931" name="UpdatePerception" tags="function" position="3943,2060" size="100,100">(set: $perception to (max: 1, it + $arg))&lt;b&gt;Perception (if: $arg &gt;= 0)[+] $arg&lt;/b&gt;</tw-passagedata><tw-passagedata pid="932" name="Execute Scheduled Events" tags="function" position="3119,2755" size="100,100">(set: _key to (str: $ticks))
(if: (datanames: $scheduledEvents) contains _key)[
(if: ($scheduledEvents&#39;s (_key))&#39;s length &gt; 0)[
(for: each _i, ...($scheduledEvents&#39;s (_key)))[
(display: _i)]]]</tw-passagedata><tw-passagedata pid="933" name="Schedule Event" tags="function" position="3119,2862" size="100,100">(set: _nextTick to (str: $ticks + $arg&#39;s delay))(unless: (datanames: $scheduledEvents) contains _nextTick)[(set: ($scheduledEvents&#39;s (_nextTick) to (a:)))]
(set: ($scheduledEvents&#39;s (_nextTick) to it + (a: $arg&#39;s event)))
!! EVENT SCHEDULED !!
(print: $arg&#39;s event) at _nextTick</tw-passagedata><tw-passagedata pid="934" name="UpdateHealth" tags="function" position="4054,2059" size="100,100">(set: $health to it + $arg)&lt;b&gt;Health (if: $arg &gt;= 0)[+ ]$arg&lt;/b&gt;(display: &quot;UpdateClock&quot;)</tw-passagedata><tw-passagedata pid="935" name="GainRumor" tags="function" position="5075,6360" size="100,100">$arg
(display: $arg)
(set: $rumors to it + (ds: $arg))</tw-passagedata><tw-passagedata pid="936" name="Read Your Mail" tags="" position="3632,2836" size="100,100">(for: each _mail, ...(reversed: ...$mail))[
From: (print: _mail&#39;s sender)
Message: (print: _mail&#39;s message)

(if: _mail&#39;s attachment is not &quot;Nothing&quot;)[
(set: $arg to _mail&#39;s attachment)(display: &quot;GetItem&quot;)
(set: _mail&#39;s attachment to &quot;Nothing&quot;)
]
]

(set: $mail to (a:))

[[Home Again]]</tw-passagedata><tw-passagedata pid="937" name="Caffeine Wears Off" tags="" position="5313,5244" size="100,100">Your head certainly doesn&#39;t feel well.
Your mouth is dry, and your limbs have an ague.
The caffeine has worn off.

(set: $arg to -1)(display: &quot;UpdatePerception&quot;)</tw-passagedata><tw-passagedata pid="938" name="Staggering Through The Alleys" tags="" position="3050,1845" size="100,100">(goto: (either: ...($neighborhood&#39;s events)))</tw-passagedata><tw-passagedata pid="939" name="LoseReputation" tags="function" position="3947,2397" size="100,100">(if: $arg is 0)[No seems to notice the faux pas, but if they had, you might have been in a bit of a bind.]
(else-if: $arg is 1)[Everyone seems a little miffed at you, lately.]
(else-if: $arg is 2)[People seem to be extra passive-aggressive-aggressive lately.]
(else-if: $arg &gt; 3)[You might as well have shat your pants.]
(set: $reputation&#39;s ($neighborhood&#39;s name) to $reputation&#39;s ($neighborhood&#39;s name) - $arg)</tw-passagedata><tw-passagedata pid="940" name="An Embarassing Display" tags="" position="3757,2717" size="100,100">You (either: &quot;quickly&quot;, &quot;slyly&quot;, &quot;shyly&quot;, &quot;stealthily&quot;, &quot;unobtrusively&quot;, &quot;awkwardly&quot;) look around to see if anyone saw you.
(if: (random: 0, 6) &gt; $danger)[No one saw anything, or if they did, they aren&#39;t saying anything.](else:)[You briefly make eye contact with an accuser.
(set: $arg to -1)(display: &quot;UpdateReputation&quot;)]</tw-passagedata><tw-passagedata pid="941" name="Heal" tags="function" position="4183,2047" size="100,100">(if: $health &gt;= $maxHealth)[You cannot heal anymore.  You are, in fact, in peak condition.
]
(else:)[
(set: $health to (min: $health + $arg, $maxHealth))
*Health + $arg -&gt; $health*
]</tw-passagedata><tw-passagedata pid="942" name="ImproveReputation" tags="function" position="1488,2842" size="100,100">{(unless: $reputation contains $arg)[(set: $reputation&#39;s ($arg) to 0)]
(set: $reputation&#39;s ($arg) to it + 1)}
*$arg + 1*</tw-passagedata><tw-passagedata pid="943" name="InsertEncounter" tags="function" position="4318,2037" size="100,100">{(set: $encounterStack to
($encounterStack&#39;s (range: 1, $encounterIndex)) + 
(a: $arg) + 
($encounterStack&#39;s (range: $encounterIndex + 1, $encounterStack&#39;s length)))}</tw-passagedata></tw-storydata>

<script title="Twine engine code" data-main="harlowe">"use strict";function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}var _slicedToArray=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){/**
 * @license almond 0.3.3 Copyright jQuery Foundation and other contributors.
 * Released under MIT license, http://github.com/requirejs/almond/LICENSE
 */
var requirejs,require,define;!function(e){function t(e,t){return v.call(e,t)}function n(e,t){var n,r,i,o,a,s,c,u,l,f,p,d,h=t&&t.split("/"),g=y.map,m=g&&g["*"]||{};if(e){for(e=e.split("/"),a=e.length-1,y.nodeIdCompat&&w.test(e[a])&&(e[a]=e[a].replace(w,"")),"."===e[0].charAt(0)&&h&&(d=h.slice(0,h.length-1),e=d.concat(e)),l=0;l<e.length;l++)if("."===(p=e[l]))e.splice(l,1),l-=1;else if(".."===p){if(0===l||1===l&&".."===e[2]||".."===e[l-1])continue;l>0&&(e.splice(l-1,2),l-=2)}e=e.join("/")}if((h||m)&&g){for(n=e.split("/"),l=n.length;l>0;l-=1){if(r=n.slice(0,l).join("/"),h)for(f=h.length;f>0;f-=1)if((i=g[h.slice(0,f).join("/")])&&(i=i[r])){o=i,s=l;break}if(o)break;!c&&m&&m[r]&&(c=m[r],u=l)}!o&&c&&(o=c,s=u),o&&(n.splice(0,s,o),e=n.join("/"))}return e}function r(t,n){return function(){var r=b.call(arguments,0);return"string"!=typeof r[0]&&1===r.length&&r.push(null),f.apply(e,r.concat([t,n]))}}function i(e){return function(t){return n(t,e)}}function o(e){return function(t){h[e]=t}}function a(n){if(t(g,n)){var r=g[n];delete g[n],m[n]=!0,l.apply(e,r)}if(!t(h,n)&&!t(m,n))throw new Error("No "+n);return h[n]}function s(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function c(e){return e?s(e):[]}function u(e){return function(){return y&&y.config&&y.config[e]||{}}}var l,f,p,d,h={},g={},y={},m={},v=Object.prototype.hasOwnProperty,b=[].slice,w=/\.js$/;p=function(e,t){var r,o=s(e),c=o[0],u=t[1];return e=o[1],c&&(c=n(c,u),r=a(c)),c?e=r&&r.normalize?r.normalize(e,i(u)):n(e,u):(e=n(e,u),o=s(e),c=o[0],e=o[1],c&&(r=a(c))),{f:c?c+"!"+e:e,n:e,pr:c,p:r}},d={require:function(e){return r(e)},exports:function(e){var t=h[e];return void 0!==t?t:h[e]={}},module:function(e){return{id:e,uri:"",exports:h[e],config:u(e)}}},l=function(n,i,s,u){var l,f,y,v,b,w,x,T=[],S=void 0===s?"undefined":_typeof(s);if(u=u||n,w=c(u),"undefined"===S||"function"===S){for(i=!i.length&&s.length?["require","exports","module"]:i,b=0;b<i.length;b+=1)if(v=p(i[b],w),"require"===(f=v.f))T[b]=d.require(n);else if("exports"===f)T[b]=d.exports(n),x=!0;else if("module"===f)l=T[b]=d.module(n);else if(t(h,f)||t(g,f)||t(m,f))T[b]=a(f);else{if(!v.p)throw new Error(n+" missing "+f);v.p.load(v.n,r(u,!0),o(f),{}),T[b]=h[f]}y=s?s.apply(h[n],T):void 0,n&&(l&&l.exports!==e&&l.exports!==h[n]?h[n]=l.exports:y===e&&x||(h[n]=y))}else n&&(h[n]=s)},requirejs=require=f=function(t,n,r,i,o){if("string"==typeof t)return d[t]?d[t](n):a(p(t,c(n)).f);if(!t.splice){if(y=t,y.deps&&f(y.deps,y.callback),!n)return;n.splice?(t=n,n=r,r=null):t=e}return n=n||function(){},"function"==typeof r&&(r=i,i=o),i?l(e,t,n,r):setTimeout(function(){l(e,t,n,r)},4),f},f.config=function(e){return f(e)},requirejs._defined=h,define=function(e,n,r){if("string"!=typeof e)throw new Error("See almond README: incorrect module build, no module name");n.splice||(r=n,n=[]),t(h,e)||t(g,e)||(g[e]=[e,n,r])},define.amd={jQuery:!0}}(),define("almond",function(){}),function(e,t){"object"===("undefined"==typeof module?"undefined":_typeof(module))&&"object"===_typeof(module.exports)?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(e,t){function n(e,t,n){n=n||ce;var r,i,o=n.createElement("script");if(o.text=e,t)for(r in Te)(i=t[r]||t.getAttribute&&t.getAttribute(r))&&o.setAttribute(r,i);n.head.appendChild(o).parentNode.removeChild(o)}function r(e){return null==e?e+"":"object"===(void 0===e?"undefined":_typeof(e))||"function"==typeof e?he[ge.call(e)]||"object":void 0===e?"undefined":_typeof(e)}function i(e){var t=!!e&&"length"in e&&e.length,n=r(e);return!we(e)&&!xe(e)&&("array"===n||0===t||"number"==typeof t&&t>0&&t-1 in e)}function o(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()}function a(e,t,n){return we(t)?Se.grep(e,function(e,r){return!!t.call(e,r,e)!==n}):t.nodeType?Se.grep(e,function(e){return e===t!==n}):"string"!=typeof t?Se.grep(e,function(e){return de.call(t,e)>-1!==n}):Se.filter(t,e,n)}function s(e,t){for(;(e=e[t])&&1!==e.nodeType;);return e}function c(e){var t={};return Se.each(e.match(Me)||[],function(e,n){t[n]=!0}),t}function u(e){return e}function l(e){throw e}function f(e,t,n,r){var i;try{e&&we(i=e.promise)?i.call(e).done(t).fail(n):e&&we(i=e.then)?i.call(e,t,n):t.apply(void 0,[e].slice(r))}catch(e){n.apply(void 0,[e])}}function p(){ce.removeEventListener("DOMContentLoaded",p),e.removeEventListener("load",p),Se.ready()}function d(e,t){return t.toUpperCase()}function h(e){return e.replace(qe,"ms-").replace(Fe,d)}function g(){this.expando=Se.expando+g.uid++}function y(e){return"true"===e||"false"!==e&&("null"===e?null:e===+e+""?+e:Be.test(e)?JSON.parse(e):e)}function m(e,t,n){var r;if(void 0===n&&1===e.nodeType)if(r="data-"+t.replace(We,"-$&").toLowerCase(),"string"==typeof(n=e.getAttribute(r))){try{n=y(n)}catch(e){}$e.set(e,t,n)}else n=void 0;return n}function v(e,t,n,r){var i,o,a=20,s=r?function(){return r.cur()}:function(){return Se.css(e,t,"")},c=s(),u=n&&n[3]||(Se.cssNumber[t]?"":"px"),l=e.nodeType&&(Se.cssNumber[t]||"px"!==u&&+c)&&Ue.exec(Se.css(e,t));if(l&&l[3]!==u){for(c/=2,u=u||l[3],l=+c||1;a--;)Se.style(e,t,l+u),(1-o)*(1-(o=s()/c||.5))<=0&&(a=0),l/=o;l*=2,Se.style(e,t,l+u),n=n||[]}return n&&(l=+l||+c||0,i=n[1]?l+(n[1]+1)*n[2]:+n[2],r&&(r.unit=u,r.start=l,r.end=i)),i}function b(e){var t,n=e.ownerDocument,r=e.nodeName,i=Ke[r];return i||(t=n.body.appendChild(n.createElement(r)),i=Se.css(t,"display"),t.parentNode.removeChild(t),"none"===i&&(i="block"),Ke[r]=i,i)}function w(e,t){for(var n,r,i=[],o=0,a=e.length;o<a;o++)r=e[o],r.style&&(n=r.style.display,t?("none"===n&&(i[o]=Ve.get(r,"display")||null,i[o]||(r.style.display="")),""===r.style.display&&Ze(r)&&(i[o]=b(r))):"none"!==n&&(i[o]="none",Ve.set(r,"display",n)));for(o=0;o<a;o++)null!=i[o]&&(e[o].style.display=i[o]);return e}function x(e,t){var n;return n=void 0!==e.getElementsByTagName?e.getElementsByTagName(t||"*"):void 0!==e.querySelectorAll?e.querySelectorAll(t||"*"):[],void 0===t||t&&o(e,t)?Se.merge([e],n):n}function T(e,t){for(var n=0,r=e.length;n<r;n++)Ve.set(e[n],"globalEval",!t||Ve.get(t[n],"globalEval"))}function S(e,t,n,i,o){for(var a,s,c,u,l,f,p=t.createDocumentFragment(),d=[],h=0,g=e.length;h<g;h++)if((a=e[h])||0===a)if("object"===r(a))Se.merge(d,a.nodeType?[a]:a);else if(it.test(a)){for(s=s||p.appendChild(t.createElement("div")),c=(tt.exec(a)||["",""])[1].toLowerCase(),u=rt[c]||rt._default,s.innerHTML=u[1]+Se.htmlPrefilter(a)+u[2],f=u[0];f--;)s=s.lastChild;Se.merge(d,s.childNodes),s=p.firstChild,s.textContent=""}else d.push(t.createTextNode(a));for(p.textContent="",h=0;a=d[h++];)if(i&&Se.inArray(a,i)>-1)o&&o.push(a);else if(l=Xe(a),s=x(p.appendChild(a),"script"),l&&T(s),n)for(f=0;a=s[f++];)nt.test(a.type||"")&&n.push(a);return p}function k(){return!0}function O(){return!1}function j(e,t){return e===A()==("focus"===t)}function A(){try{return ce.activeElement}catch(e){}}function C(e,t,n,r,i,o){var a,s;if("object"===(void 0===t?"undefined":_typeof(t))){"string"!=typeof n&&(r=r||n,n=void 0);for(s in t)C(e,s,n,r,t[s],o);return e}if(null==r&&null==i?(i=n,r=n=void 0):null==i&&("string"==typeof n?(i=r,r=void 0):(i=r,r=n,n=void 0)),!1===i)i=O;else if(!i)return e;return 1===o&&(a=i,i=function(e){return Se().off(e),a.apply(this,arguments)},i.guid=a.guid||(a.guid=Se.guid++)),e.each(function(){Se.event.add(this,t,i,r,n)})}function E(e,t,n){if(!n)return void(void 0===Ve.get(e,t)&&Se.event.add(e,t,k));Ve.set(e,t,!1),Se.event.add(e,t,{namespace:!1,handler:function(e){var r,i,o=Ve.get(this,t);if(1&e.isTrigger&&this[t]){if(o.length)(Se.event.special[t]||{}).delegateType&&e.stopPropagation();else if(o=le.call(arguments),Ve.set(this,t,o),r=n(this,t),this[t](),i=Ve.get(this,t),o!==i||r?Ve.set(this,t,!1):i={},o!==i)return e.stopImmediatePropagation(),e.preventDefault(),i.value}else o.length&&(Ve.set(this,t,{value:Se.event.trigger(Se.extend(o[0],Se.Event.prototype),o.slice(1),this)}),e.stopImmediatePropagation())}})}function N(e,t){return o(e,"table")&&o(11!==t.nodeType?t:t.firstChild,"tr")?Se(e).children("tbody")[0]||e:e}function _(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function P(e){return"true/"===(e.type||"").slice(0,5)?e.type=e.type.slice(5):e.removeAttribute("type"),e}function I(e,t){var n,r,i,o,a,s,c,u;if(1===t.nodeType){if(Ve.hasData(e)&&(o=Ve.access(e),a=Ve.set(t,o),u=o.events)){delete a.handle,a.events={};for(i in u)for(n=0,r=u[i].length;n<r;n++)Se.event.add(t,i,u[i][n])}$e.hasData(e)&&(s=$e.access(e),c=Se.extend({},s),$e.set(t,c))}}function M(e,t){var n=t.nodeName.toLowerCase();"input"===n&&et.test(e.type)?t.checked=e.checked:"input"!==n&&"textarea"!==n||(t.defaultValue=e.defaultValue)}function D(e,t,r,i){t=fe.apply([],t);var o,a,s,c,u,l,f=0,p=e.length,d=p-1,h=t[0],g=we(h);if(g||p>1&&"string"==typeof h&&!be.checkClone&&lt.test(h))return e.each(function(n){var o=e.eq(n);g&&(t[0]=h.call(this,n,o.html())),D(o,t,r,i)});if(p&&(o=S(t,e[0].ownerDocument,!1,e,i),a=o.firstChild,1===o.childNodes.length&&(o=a),a||i)){for(s=Se.map(x(o,"script"),_),c=s.length;f<p;f++)u=o,f!==d&&(u=Se.clone(u,!0,!0),c&&Se.merge(s,x(u,"script"))),r.call(e[f],u,f);if(c)for(l=s[s.length-1].ownerDocument,Se.map(s,P),f=0;f<c;f++)u=s[f],nt.test(u.type||"")&&!Ve.access(u,"globalEval")&&Se.contains(l,u)&&(u.src&&"module"!==(u.type||"").toLowerCase()?Se._evalUrl&&!u.noModule&&Se._evalUrl(u.src,{nonce:u.nonce||u.getAttribute("nonce")}):n(u.textContent.replace(ft,""),u,l))}return e}function L(e,t,n){for(var r,i=t?Se.filter(t,e):e,o=0;null!=(r=i[o]);o++)n||1!==r.nodeType||Se.cleanData(x(r)),r.parentNode&&(n&&Xe(r)&&T(x(r,"script")),r.parentNode.removeChild(r));return e}function R(e,t,n){var r,i,o,a,s=e.style;return n=n||dt(e),n&&(a=n.getPropertyValue(t)||n[t],""!==a||Xe(e)||(a=Se.style(e,t)),!be.pixelBoxStyles()&&pt.test(a)&&ht.test(t)&&(r=s.width,i=s.minWidth,o=s.maxWidth,s.minWidth=s.maxWidth=s.width=a,a=n.width,s.width=r,s.minWidth=i,s.maxWidth=o)),void 0!==a?a+"":a}function q(e,t){return{get:function(){return e()?void delete this.get:(this.get=t).apply(this,arguments)}}}function F(e){for(var t=e[0].toUpperCase()+e.slice(1),n=gt.length;n--;)if((e=gt[n]+t)in yt)return e}function H(e){var t=Se.cssProps[e]||mt[e];return t||(e in yt?e:mt[e]=F(e)||e)}function V(e,t,n){var r=Ue.exec(t);return r?Math.max(0,r[2]-(n||0))+(r[3]||"px"):t}function $(e,t,n,r,i,o){var a="width"===t?1:0,s=0,c=0;if(n===(r?"border":"content"))return 0;for(;a<4;a+=2)"margin"===n&&(c+=Se.css(e,n+Ge[a],!0,i)),r?("content"===n&&(c-=Se.css(e,"padding"+Ge[a],!0,i)),"margin"!==n&&(c-=Se.css(e,"border"+Ge[a]+"Width",!0,i))):(c+=Se.css(e,"padding"+Ge[a],!0,i),"padding"!==n?c+=Se.css(e,"border"+Ge[a]+"Width",!0,i):s+=Se.css(e,"border"+Ge[a]+"Width",!0,i));return!r&&o>=0&&(c+=Math.max(0,Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-o-c-s-.5))||0),c}function B(e,t,n){var r=dt(e),i=!be.boxSizingReliable()||n,o=i&&"border-box"===Se.css(e,"boxSizing",!1,r),a=o,s=R(e,t,r),c="offset"+t[0].toUpperCase()+t.slice(1);if(pt.test(s)){if(!n)return s;s="auto"}return(!be.boxSizingReliable()&&o||"auto"===s||!parseFloat(s)&&"inline"===Se.css(e,"display",!1,r))&&e.getClientRects().length&&(o="border-box"===Se.css(e,"boxSizing",!1,r),(a=c in e)&&(s=e[c])),(s=parseFloat(s)||0)+$(e,t,n||(o?"border":"content"),a,r,s)+"px"}function W(e,t,n,r,i){return new W.prototype.init(e,t,n,r,i)}function z(){St&&(!1===ce.hidden&&e.requestAnimationFrame?e.requestAnimationFrame(z):e.setTimeout(z,Se.fx.interval),Se.fx.tick())}function U(){return e.setTimeout(function(){Tt=void 0}),Tt=Date.now()}function G(e,t){var n,r=0,i={height:e};for(t=t?1:0;r<4;r+=2-t)n=Ge[r],i["margin"+n]=i["padding"+n]=e;return t&&(i.opacity=i.width=e),i}function J(e,t,n){for(var r,i=(Z.tweeners[t]||[]).concat(Z.tweeners["*"]),o=0,a=i.length;o<a;o++)if(r=i[o].call(n,t,e))return r}function X(e,t,n){var r,i,o,a,s,c,u,l,f="width"in t||"height"in t,p=this,d={},h=e.style,g=e.nodeType&&Ze(e),y=Ve.get(e,"fxshow");n.queue||(a=Se._queueHooks(e,"fx"),null==a.unqueued&&(a.unqueued=0,s=a.empty.fire,a.empty.fire=function(){a.unqueued||s()}),a.unqueued++,p.always(function(){p.always(function(){a.unqueued--,Se.queue(e,"fx").length||a.empty.fire()})}));for(r in t)if(i=t[r],kt.test(i)){if(delete t[r],o=o||"toggle"===i,i===(g?"hide":"show")){if("show"!==i||!y||void 0===y[r])continue;g=!0}d[r]=y&&y[r]||Se.style(e,r)}if((c=!Se.isEmptyObject(t))||!Se.isEmptyObject(d)){f&&1===e.nodeType&&(n.overflow=[h.overflow,h.overflowX,h.overflowY],u=y&&y.display,null==u&&(u=Ve.get(e,"display")),l=Se.css(e,"display"),"none"===l&&(u?l=u:(w([e],!0),u=e.style.display||u,l=Se.css(e,"display"),w([e]))),("inline"===l||"inline-block"===l&&null!=u)&&"none"===Se.css(e,"float")&&(c||(p.done(function(){h.display=u}),null==u&&(l=h.display,u="none"===l?"":l)),h.display="inline-block")),n.overflow&&(h.overflow="hidden",p.always(function(){h.overflow=n.overflow[0],h.overflowX=n.overflow[1],h.overflowY=n.overflow[2]})),c=!1;for(r in d)c||(y?"hidden"in y&&(g=y.hidden):y=Ve.access(e,"fxshow",{display:u}),o&&(y.hidden=!g),g&&w([e],!0),p.done(function(){g||w([e]),Ve.remove(e,"fxshow");for(r in d)Se.style(e,r,d[r])})),c=J(g?y[r]:0,r,p),r in y||(y[r]=c.start,g&&(c.end=c.start,c.start=0))}}function Y(e,t){var n,r,i,o,a;for(n in e)if(r=h(n),i=t[r],o=e[n],Array.isArray(o)&&(i=o[1],o=e[n]=o[0]),n!==r&&(e[r]=o,delete e[n]),(a=Se.cssHooks[r])&&"expand"in a){o=a.expand(o),delete e[r];for(n in o)n in e||(e[n]=o[n],t[n]=i)}else t[r]=i}function Z(e,t,n){var r,i,o=0,a=Z.prefilters.length,s=Se.Deferred().always(function(){delete c.elem}),c=function(){if(i)return!1;for(var t=Tt||U(),n=Math.max(0,u.startTime+u.duration-t),r=n/u.duration||0,o=1-r,a=0,c=u.tweens.length;a<c;a++)u.tweens[a].run(o);return s.notifyWith(e,[u,o,n]),o<1&&c?n:(c||s.notifyWith(e,[u,1,0]),s.resolveWith(e,[u]),!1)},u=s.promise({elem:e,props:Se.extend({},t),opts:Se.extend(!0,{specialEasing:{},easing:Se.easing._default},n),originalProperties:t,originalOptions:n,startTime:Tt||U(),duration:n.duration,tweens:[],createTween:function(t,n){var r=Se.Tween(e,u.opts,t,n,u.opts.specialEasing[t]||u.opts.easing);return u.tweens.push(r),r},stop:function(t){var n=0,r=t?u.tweens.length:0;if(i)return this;for(i=!0;n<r;n++)u.tweens[n].run(1);return t?(s.notifyWith(e,[u,1,0]),s.resolveWith(e,[u,t])):s.rejectWith(e,[u,t]),this}}),l=u.props;for(Y(l,u.opts.specialEasing);o<a;o++)if(r=Z.prefilters[o].call(u,e,l,u.opts))return we(r.stop)&&(Se._queueHooks(u.elem,u.opts.queue).stop=r.stop.bind(r)),r;return Se.map(l,J,u),we(u.opts.start)&&u.opts.start.call(e,u),u.progress(u.opts.progress).done(u.opts.done,u.opts.complete).fail(u.opts.fail).always(u.opts.always),Se.fx.timer(Se.extend(c,{elem:e,anim:u,queue:u.opts.queue})),u}function Q(e){return(e.match(Me)||[]).join(" ")}function K(e){return e.getAttribute&&e.getAttribute("class")||""}function ee(e){return Array.isArray(e)?e:"string"==typeof e?e.match(Me)||[]:[]}function te(e,t,n,i){var o;if(Array.isArray(t))Se.each(t,function(t,r){n||Lt.test(e)?i(e,r):te(e+"["+("object"===(void 0===r?"undefined":_typeof(r))&&null!=r?t:"")+"]",r,n,i)});else if(n||"object"!==r(t))i(e,t);else for(o in t)te(e+"["+o+"]",t[o],n,i)}function ne(e){return function(t,n){"string"!=typeof t&&(n=t,t="*");var r,i=0,o=t.toLowerCase().match(Me)||[];if(we(n))for(;r=o[i++];)"+"===r[0]?(r=r.slice(1)||"*",(e[r]=e[r]||[]).unshift(n)):(e[r]=e[r]||[]).push(n)}}function re(e,t,n,r){function i(s){var c;return o[s]=!0,Se.each(e[s]||[],function(e,s){var u=s(t,n,r);return"string"!=typeof u||a||o[u]?a?!(c=u):void 0:(t.dataTypes.unshift(u),i(u),!1)}),c}var o={},a=e===Jt;return i(t.dataTypes[0])||!o["*"]&&i("*")}function ie(e,t){var n,r,i=Se.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((i[n]?e:r||(r={}))[n]=t[n]);return r&&Se.extend(!0,e,r),e}function oe(e,t,n){for(var r,i,o,a,s=e.contents,c=e.dataTypes;"*"===c[0];)c.shift(),void 0===r&&(r=e.mimeType||t.getResponseHeader("Content-Type"));if(r)for(i in s)if(s[i]&&s[i].test(r)){c.unshift(i);break}if(c[0]in n)o=c[0];else{for(i in n){if(!c[0]||e.converters[i+" "+c[0]]){o=i;break}a||(a=i)}o=o||a}if(o)return o!==c[0]&&c.unshift(o),n[o]}function ae(e,t,n,r){var i,o,a,s,c,u={},l=e.dataTypes.slice();if(l[1])for(a in e.converters)u[a.toLowerCase()]=e.converters[a];for(o=l.shift();o;)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!c&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),c=o,o=l.shift())if("*"===o)o=c;else if("*"!==c&&c!==o){if(!(a=u[c+" "+o]||u["* "+o]))for(i in u)if(s=i.split(" "),s[1]===o&&(a=u[c+" "+s[0]]||u["* "+s[0]])){!0===a?a=u[i]:!0!==u[i]&&(o=s[0],l.unshift(s[1]));break}if(!0!==a)if(a&&e.throws)t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+c+" to "+o}}}return{state:"success",data:t}}var se=[],ce=e.document,ue=Object.getPrototypeOf,le=se.slice,fe=se.concat,pe=se.push,de=se.indexOf,he={},ge=he.toString,ye=he.hasOwnProperty,me=ye.toString,ve=me.call(Object),be={},we=function(e){return"function"==typeof e&&"number"!=typeof e.nodeType},xe=function(e){return null!=e&&e===e.window},Te={type:!0,src:!0,nonce:!0,noModule:!0},Se=function e(t,n){return new e.fn.init(t,n)},ke=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;Se.fn=Se.prototype={jquery:"3.4.1",constructor:Se,length:0,toArray:function(){return le.call(this)},get:function(e){return null==e?le.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=Se.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return Se.each(this,e)},map:function(e){return this.pushStack(Se.map(this,function(t,n){return e.call(t,n,t)}))},slice:function(){return this.pushStack(le.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(n>=0&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:pe,sort:se.sort,splice:se.splice},Se.extend=Se.fn.extend=function(){var e,t,n,r,i,o,a=arguments[0]||{},s=1,c=arguments.length,u=!1;for("boolean"==typeof a&&(u=a,a=arguments[s]||{},s++),"object"===(void 0===a?"undefined":_typeof(a))||we(a)||(a={}),s===c&&(a=this,s--);s<c;s++)if(null!=(e=arguments[s]))for(t in e)r=e[t],"__proto__"!==t&&a!==r&&(u&&r&&(Se.isPlainObject(r)||(i=Array.isArray(r)))?(n=a[t],o=i&&!Array.isArray(n)?[]:i||Se.isPlainObject(n)?n:{},i=!1,a[t]=Se.extend(u,o,r)):void 0!==r&&(a[t]=r));return a},Se.extend({expando:"jQuery"+("3.4.1"+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isPlainObject:function(e){var t,n;return!(!e||"[object Object]"!==ge.call(e))&&(!(t=ue(e))||"function"==typeof(n=ye.call(t,"constructor")&&t.constructor)&&me.call(n)===ve)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},globalEval:function(e,t){n(e,{nonce:t&&t.nonce})},each:function(e,t){var n,r=0;if(i(e))for(n=e.length;r<n&&!1!==t.call(e[r],r,e[r]);r++);else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},trim:function(e){return null==e?"":(e+"").replace(ke,"")},makeArray:function(e,t){var n=t||[];return null!=e&&(i(Object(e))?Se.merge(n,"string"==typeof e?[e]:e):pe.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:de.call(t,e,n)},merge:function(e,t){for(var n=+t.length,r=0,i=e.length;r<n;r++)e[i++]=t[r];return e.length=i,e},grep:function(e,t,n){for(var r=[],i=0,o=e.length,a=!n;i<o;i++)!t(e[i],i)!==a&&r.push(e[i]);return r},map:function(e,t,n){var r,o,a=0,s=[];if(i(e))for(r=e.length;a<r;a++)null!=(o=t(e[a],a,n))&&s.push(o);else for(a in e)null!=(o=t(e[a],a,n))&&s.push(o);return fe.apply([],s)},guid:1,support:be}),"function"==typeof Symbol&&(Se.fn[Symbol.iterator]=se[Symbol.iterator]),Se.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(e,t){he["[object "+t+"]"]=t.toLowerCase()});var Oe=function(e){function t(e,t,n,r){var i,o,a,s,c,l,p,d=t&&t.ownerDocument,h=t?t.nodeType:9;if(n=n||[],"string"!=typeof e||!e||1!==h&&9!==h&&11!==h)return n;if(!r&&((t?t.ownerDocument||t:F)!==_&&N(t),t=t||_,I)){if(11!==h&&(c=me.exec(e)))if(i=c[1]){if(9===h){if(!(a=t.getElementById(i)))return n;if(a.id===i)return n.push(a),n}else if(d&&(a=d.getElementById(i))&&R(t,a)&&a.id===i)return n.push(a),n}else{if(c[2])return Z.apply(n,t.getElementsByTagName(e)),n;if((i=c[3])&&w.getElementsByClassName&&t.getElementsByClassName)return Z.apply(n,t.getElementsByClassName(i)),n}if(w.qsa&&!z[e+" "]&&(!M||!M.test(e))&&(1!==h||"object"!==t.nodeName.toLowerCase())){if(p=e,d=t,1===h&&ue.test(e)){for((s=t.getAttribute("id"))?s=s.replace(xe,Te):t.setAttribute("id",s=q),l=k(e),o=l.length;o--;)l[o]="#"+s+" "+f(l[o]);p=l.join(","),d=ve.test(e)&&u(t.parentNode)||t}try{return Z.apply(n,d.querySelectorAll(p)),n}catch(t){z(e,!0)}finally{s===q&&t.removeAttribute("id")}}}return j(e.replace(ae,"$1"),t,n,r)}function n(){function e(n,r){return t.push(n+" ")>x.cacheLength&&delete e[t.shift()],e[n+" "]=r}var t=[];return e}function r(e){return e[q]=!0,e}function i(e){var t=_.createElement("fieldset");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function o(e,t){for(var n=e.split("|"),r=n.length;r--;)x.attrHandle[n[r]]=t}function a(e,t){var n=t&&e,r=n&&1===e.nodeType&&1===t.nodeType&&e.sourceIndex-t.sourceIndex;if(r)return r;if(n)for(;n=n.nextSibling;)if(n===t)return-1;return e?1:-1}function s(e){return function(t){return"form"in t?t.parentNode&&!1===t.disabled?"label"in t?"label"in t.parentNode?t.parentNode.disabled===e:t.disabled===e:t.isDisabled===e||t.isDisabled!==!e&&ke(t)===e:t.disabled===e:"label"in t&&t.disabled===e}}function c(e){return r(function(t){return t=+t,r(function(n,r){for(var i,o=e([],n.length,t),a=o.length;a--;)n[i=o[a]]&&(n[i]=!(r[i]=n[i]))})})}function u(e){return e&&void 0!==e.getElementsByTagName&&e}function l(){}function f(e){for(var t=0,n=e.length,r="";t<n;t++)r+=e[t].value;return r}function p(e,t,n){var r=t.dir,i=t.next,o=i||r,a=n&&"parentNode"===o,s=V++;return t.first?function(t,n,i){for(;t=t[r];)if(1===t.nodeType||a)return e(t,n,i);return!1}:function(t,n,c){var u,l,f,p=[H,s];if(c){for(;t=t[r];)if((1===t.nodeType||a)&&e(t,n,c))return!0}else for(;t=t[r];)if(1===t.nodeType||a)if(f=t[q]||(t[q]={}),l=f[t.uniqueID]||(f[t.uniqueID]={}),i&&i===t.nodeName.toLowerCase())t=t[r]||t;else{if((u=l[o])&&u[0]===H&&u[1]===s)return p[2]=u[2];if(l[o]=p,p[2]=e(t,n,c))return!0}return!1}}function d(e){return e.length>1?function(t,n,r){for(var i=e.length;i--;)if(!e[i](t,n,r))return!1;return!0}:e[0]}function h(e,n,r){for(var i=0,o=n.length;i<o;i++)t(e,n[i],r);return r}function g(e,t,n,r,i){for(var o,a=[],s=0,c=e.length,u=null!=t;s<c;s++)(o=e[s])&&(n&&!n(o,r,i)||(a.push(o),u&&t.push(s)));return a}function y(e,t,n,i,o,a){return i&&!i[q]&&(i=y(i)),o&&!o[q]&&(o=y(o,a)),r(function(r,a,s,c){var u,l,f,p=[],d=[],y=a.length,m=r||h(t||"*",s.nodeType?[s]:s,[]),v=!e||!r&&t?m:g(m,p,e,s,c),b=n?o||(r?e:y||i)?[]:a:v;if(n&&n(v,b,s,c),i)for(u=g(b,d),i(u,[],s,c),l=u.length;l--;)(f=u[l])&&(b[d[l]]=!(v[d[l]]=f));if(r){if(o||e){if(o){for(u=[],l=b.length;l--;)(f=b[l])&&u.push(v[l]=f);o(null,b=[],u,c)}for(l=b.length;l--;)(f=b[l])&&(u=o?K(r,f):p[l])>-1&&(r[u]=!(a[u]=f))}}else b=g(b===a?b.splice(y,b.length):b),o?o(null,a,b,c):Z.apply(a,b)})}function m(e){for(var t,n,r,i=e.length,o=x.relative[e[0].type],a=o||x.relative[" "],s=o?1:0,c=p(function(e){return e===t},a,!0),u=p(function(e){return K(t,e)>-1},a,!0),l=[function(e,n,r){var i=!o&&(r||n!==A)||((t=n).nodeType?c(e,n,r):u(e,n,r));return t=null,i}];s<i;s++)if(n=x.relative[e[s].type])l=[p(d(l),n)];else{if(n=x.filter[e[s].type].apply(null,e[s].matches),n[q]){for(r=++s;r<i&&!x.relative[e[r].type];r++);return y(s>1&&d(l),s>1&&f(e.slice(0,s-1).concat({value:" "===e[s-2].type?"*":""})).replace(ae,"$1"),n,s<r&&m(e.slice(s,r)),r<i&&m(e=e.slice(r)),r<i&&f(e))}l.push(n)}return d(l)}function v(e,n){var i=n.length>0,o=e.length>0,a=function(r,a,s,c,u){var l,f,p,d=0,h="0",y=r&&[],m=[],v=A,b=r||o&&x.find.TAG("*",u),w=H+=null==v?1:Math.random()||.1,T=b.length;for(u&&(A=a===_||a||u);h!==T&&null!=(l=b[h]);h++){if(o&&l){for(f=0,a||l.ownerDocument===_||(N(l),s=!I);p=e[f++];)if(p(l,a||_,s)){c.push(l);break}u&&(H=w)}i&&((l=!p&&l)&&d--,r&&y.push(l))}if(d+=h,i&&h!==d){for(f=0;p=n[f++];)p(y,m,a,s);if(r){if(d>0)for(;h--;)y[h]||m[h]||(m[h]=X.call(c));m=g(m)}Z.apply(c,m),u&&!r&&m.length>0&&d+n.length>1&&t.uniqueSort(c)}return u&&(H=w,A=v),y};return i?r(a):a}var b,w,x,T,S,k,O,j,A,C,E,N,_,P,I,M,D,L,R,q="sizzle"+1*new Date,F=e.document,H=0,V=0,$=n(),B=n(),W=n(),z=n(),U=function(e,t){return e===t&&(E=!0),0},G={}.hasOwnProperty,J=[],X=J.pop,Y=J.push,Z=J.push,Q=J.slice,K=function(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},ee="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",te="[\\x20\\t\\r\\n\\f]",ne="(?:\\\\.|[\\w-]|[^\0-\\xa0])+",re="\\["+te+"*("+ne+")(?:"+te+"*([*^$|!~]?=)"+te+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+ne+"))|)"+te+"*\\]",ie=":("+ne+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+re+")*)|.*)\\)|)",oe=new RegExp(te+"+","g"),ae=new RegExp("^"+te+"+|((?:^|[^\\\\])(?:\\\\.)*)"+te+"+$","g"),se=new RegExp("^"+te+"*,"+te+"*"),ce=new RegExp("^"+te+"*([>+~]|"+te+")"+te+"*"),ue=new RegExp(te+"|>"),le=new RegExp(ie),fe=new RegExp("^"+ne+"$"),pe={ID:new RegExp("^#("+ne+")"),CLASS:new RegExp("^\\.("+ne+")"),TAG:new RegExp("^("+ne+"|[*])"),ATTR:new RegExp("^"+re),PSEUDO:new RegExp("^"+ie),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+te+"*(even|odd|(([+-]|)(\\d*)n|)"+te+"*(?:([+-]|)"+te+"*(\\d+)|))"+te+"*\\)|)","i"),bool:new RegExp("^(?:"+ee+")$","i"),needsContext:new RegExp("^"+te+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+te+"*((?:-\\d)?\\d*)"+te+"*\\)|)(?=[^-]|$)","i")},de=/HTML$/i,he=/^(?:input|select|textarea|button)$/i,ge=/^h\d$/i,ye=/^[^{]+\{\s*\[native \w/,me=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,ve=/[+~]/,be=new RegExp("\\\\([\\da-f]{1,6}"+te+"?|("+te+")|.)","ig"),we=function(e,t,n){var r="0x"+t-65536;return r!==r||n?t:r<0?String.fromCharCode(r+65536):String.fromCharCode(r>>10|55296,1023&r|56320)},xe=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g,Te=function(e,t){return t?"\0"===e?"\ufffd":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e},Se=function(){N()},ke=p(function(e){return!0===e.disabled&&"fieldset"===e.nodeName.toLowerCase()},{dir:"parentNode",next:"legend"});try{Z.apply(J=Q.call(F.childNodes),F.childNodes),J[F.childNodes.length].nodeType}catch(e){Z={apply:J.length?function(e,t){Y.apply(e,Q.call(t))}:function(e,t){for(var n=e.length,r=0;e[n++]=t[r++];);e.length=n-1}}}w=t.support={},S=t.isXML=function(e){var t=e.namespaceURI,n=(e.ownerDocument||e).documentElement;return!de.test(t||n&&n.nodeName||"HTML")},N=t.setDocument=function(e){var t,n,r=e?e.ownerDocument||e:F;return r!==_&&9===r.nodeType&&r.documentElement?(_=r,P=_.documentElement,I=!S(_),F!==_&&(n=_.defaultView)&&n.top!==n&&(n.addEventListener?n.addEventListener("unload",Se,!1):n.attachEvent&&n.attachEvent("onunload",Se)),w.attributes=i(function(e){return e.className="i",!e.getAttribute("className")}),w.getElementsByTagName=i(function(e){return e.appendChild(_.createComment("")),!e.getElementsByTagName("*").length}),w.getElementsByClassName=ye.test(_.getElementsByClassName),w.getById=i(function(e){return P.appendChild(e).id=q,!_.getElementsByName||!_.getElementsByName(q).length}),w.getById?(x.filter.ID=function(e){var t=e.replace(be,we);return function(e){return e.getAttribute("id")===t}},x.find.ID=function(e,t){if(void 0!==t.getElementById&&I){var n=t.getElementById(e);return n?[n]:[]}}):(x.filter.ID=function(e){var t=e.replace(be,we);return function(e){var n=void 0!==e.getAttributeNode&&e.getAttributeNode("id");return n&&n.value===t}},x.find.ID=function(e,t){if(void 0!==t.getElementById&&I){var n,r,i,o=t.getElementById(e);if(o){if((n=o.getAttributeNode("id"))&&n.value===e)return[o];for(i=t.getElementsByName(e),r=0;o=i[r++];)if((n=o.getAttributeNode("id"))&&n.value===e)return[o]}return[]}}),x.find.TAG=w.getElementsByTagName?function(e,t){return void 0!==t.getElementsByTagName?t.getElementsByTagName(e):w.qsa?t.querySelectorAll(e):void 0}:function(e,t){var n,r=[],i=0,o=t.getElementsByTagName(e);if("*"===e){for(;n=o[i++];)1===n.nodeType&&r.push(n);return r}return o},x.find.CLASS=w.getElementsByClassName&&function(e,t){if(void 0!==t.getElementsByClassName&&I)return t.getElementsByClassName(e)},D=[],M=[],(w.qsa=ye.test(_.querySelectorAll))&&(i(function(e){P.appendChild(e).innerHTML="<a id='"+q+"'></a><select id='"+q+"-\r\\' msallowcapture=''><option selected=''></option></select>",e.querySelectorAll("[msallowcapture^='']").length&&M.push("[*^$]="+te+"*(?:''|\"\")"),e.querySelectorAll("[selected]").length||M.push("\\["+te+"*(?:value|"+ee+")"),e.querySelectorAll("[id~="+q+"-]").length||M.push("~="),e.querySelectorAll(":checked").length||M.push(":checked"),e.querySelectorAll("a#"+q+"+*").length||M.push(".#.+[+~]")}),i(function(e){e.innerHTML="<a href='' disabled='disabled'></a><select disabled='disabled'><option/></select>";var t=_.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),e.querySelectorAll("[name=d]").length&&M.push("name"+te+"*[*^$|!~]?="),2!==e.querySelectorAll(":enabled").length&&M.push(":enabled",":disabled"),P.appendChild(e).disabled=!0,2!==e.querySelectorAll(":disabled").length&&M.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),M.push(",.*:")})),(w.matchesSelector=ye.test(L=P.matches||P.webkitMatchesSelector||P.mozMatchesSelector||P.oMatchesSelector||P.msMatchesSelector))&&i(function(e){w.disconnectedMatch=L.call(e,"*"),L.call(e,"[s!='']:x"),D.push("!=",ie)}),M=M.length&&new RegExp(M.join("|")),D=D.length&&new RegExp(D.join("|")),t=ye.test(P.compareDocumentPosition),R=t||ye.test(P.contains)?function(e,t){var n=9===e.nodeType?e.documentElement:e,r=t&&t.parentNode;return e===r||!(!r||1!==r.nodeType||!(n.contains?n.contains(r):e.compareDocumentPosition&&16&e.compareDocumentPosition(r)))}:function(e,t){if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},U=t?function(e,t){if(e===t)return E=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n||(n=(e.ownerDocument||e)===(t.ownerDocument||t)?e.compareDocumentPosition(t):1,1&n||!w.sortDetached&&t.compareDocumentPosition(e)===n?e===_||e.ownerDocument===F&&R(F,e)?-1:t===_||t.ownerDocument===F&&R(F,t)?1:C?K(C,e)-K(C,t):0:4&n?-1:1)}:function(e,t){if(e===t)return E=!0,0;var n,r=0,i=e.parentNode,o=t.parentNode,s=[e],c=[t];if(!i||!o)return e===_?-1:t===_?1:i?-1:o?1:C?K(C,e)-K(C,t):0;if(i===o)return a(e,t);for(n=e;n=n.parentNode;)s.unshift(n);for(n=t;n=n.parentNode;)c.unshift(n);for(;s[r]===c[r];)r++;return r?a(s[r],c[r]):s[r]===F?-1:c[r]===F?1:0},_):_},t.matches=function(e,n){return t(e,null,null,n)},t.matchesSelector=function(e,n){if((e.ownerDocument||e)!==_&&N(e),w.matchesSelector&&I&&!z[n+" "]&&(!D||!D.test(n))&&(!M||!M.test(n)))try{var r=L.call(e,n);if(r||w.disconnectedMatch||e.document&&11!==e.document.nodeType)return r}catch(e){z(n,!0)}return t(n,_,null,[e]).length>0},t.contains=function(e,t){return(e.ownerDocument||e)!==_&&N(e),R(e,t)},t.attr=function(e,t){(e.ownerDocument||e)!==_&&N(e);var n=x.attrHandle[t.toLowerCase()],r=n&&G.call(x.attrHandle,t.toLowerCase())?n(e,t,!I):void 0;return void 0!==r?r:w.attributes||!I?e.getAttribute(t):(r=e.getAttributeNode(t))&&r.specified?r.value:null},t.escape=function(e){return(e+"").replace(xe,Te)},t.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},t.uniqueSort=function(e){var t,n=[],r=0,i=0;if(E=!w.detectDuplicates,C=!w.sortStable&&e.slice(0),e.sort(U),E){for(;t=e[i++];)t===e[i]&&(r=n.push(i));for(;r--;)e.splice(n[r],1)}return C=null,e},T=t.getText=function(e){var t,n="",r=0,i=e.nodeType;if(i){if(1===i||9===i||11===i){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=T(e)}else if(3===i||4===i)return e.nodeValue}else for(;t=e[r++];)n+=T(t);return n},
x=t.selectors={cacheLength:50,createPseudo:r,match:pe,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(be,we),e[3]=(e[3]||e[4]||e[5]||"").replace(be,we),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||t.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&t.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return pe.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&le.test(n)&&(t=k(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(be,we).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=$[e+" "];return t||(t=new RegExp("(^|"+te+")"+e+"("+te+"|$)"))&&$(e,function(e){return t.test("string"==typeof e.className&&e.className||void 0!==e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(e,n,r){return function(i){var o=t.attr(i,e);return null==o?"!="===n:!n||(o+="","="===n?o===r:"!="===n?o!==r:"^="===n?r&&0===o.indexOf(r):"*="===n?r&&o.indexOf(r)>-1:"$="===n?r&&o.slice(-r.length)===r:"~="===n?(" "+o.replace(oe," ")+" ").indexOf(r)>-1:"|="===n&&(o===r||o.slice(0,r.length+1)===r+"-"))}},CHILD:function(e,t,n,r,i){var o="nth"!==e.slice(0,3),a="last"!==e.slice(-4),s="of-type"===t;return 1===r&&0===i?function(e){return!!e.parentNode}:function(t,n,c){var u,l,f,p,d,h,g=o!==a?"nextSibling":"previousSibling",y=t.parentNode,m=s&&t.nodeName.toLowerCase(),v=!c&&!s,b=!1;if(y){if(o){for(;g;){for(p=t;p=p[g];)if(s?p.nodeName.toLowerCase()===m:1===p.nodeType)return!1;h=g="only"===e&&!h&&"nextSibling"}return!0}if(h=[a?y.firstChild:y.lastChild],a&&v){for(p=y,f=p[q]||(p[q]={}),l=f[p.uniqueID]||(f[p.uniqueID]={}),u=l[e]||[],d=u[0]===H&&u[1],b=d&&u[2],p=d&&y.childNodes[d];p=++d&&p&&p[g]||(b=d=0)||h.pop();)if(1===p.nodeType&&++b&&p===t){l[e]=[H,d,b];break}}else if(v&&(p=t,f=p[q]||(p[q]={}),l=f[p.uniqueID]||(f[p.uniqueID]={}),u=l[e]||[],d=u[0]===H&&u[1],b=d),!1===b)for(;(p=++d&&p&&p[g]||(b=d=0)||h.pop())&&((s?p.nodeName.toLowerCase()!==m:1!==p.nodeType)||!++b||(v&&(f=p[q]||(p[q]={}),l=f[p.uniqueID]||(f[p.uniqueID]={}),l[e]=[H,b]),p!==t)););return(b-=i)===r||b%r==0&&b/r>=0}}},PSEUDO:function(e,n){var i,o=x.pseudos[e]||x.setFilters[e.toLowerCase()]||t.error("unsupported pseudo: "+e);return o[q]?o(n):o.length>1?(i=[e,e,"",n],x.setFilters.hasOwnProperty(e.toLowerCase())?r(function(e,t){for(var r,i=o(e,n),a=i.length;a--;)r=K(e,i[a]),e[r]=!(t[r]=i[a])}):function(e){return o(e,0,i)}):o}},pseudos:{not:r(function(e){var t=[],n=[],i=O(e.replace(ae,"$1"));return i[q]?r(function(e,t,n,r){for(var o,a=i(e,null,r,[]),s=e.length;s--;)(o=a[s])&&(e[s]=!(t[s]=o))}):function(e,r,o){return t[0]=e,i(t,null,o,n),t[0]=null,!n.pop()}}),has:r(function(e){return function(n){return t(e,n).length>0}}),contains:r(function(e){return e=e.replace(be,we),function(t){return(t.textContent||T(t)).indexOf(e)>-1}}),lang:r(function(e){return fe.test(e||"")||t.error("unsupported lang: "+e),e=e.replace(be,we).toLowerCase(),function(t){var n;do{if(n=I?t.lang:t.getAttribute("xml:lang")||t.getAttribute("lang"))return(n=n.toLowerCase())===e||0===n.indexOf(e+"-")}while((t=t.parentNode)&&1===t.nodeType);return!1}}),target:function(t){var n=e.location&&e.location.hash;return n&&n.slice(1)===t.id},root:function(e){return e===P},focus:function(e){return e===_.activeElement&&(!_.hasFocus||_.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:s(!1),disabled:s(!0),checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!x.pseudos.empty(e)},header:function(e){return ge.test(e.nodeName)},input:function(e){return he.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:c(function(){return[0]}),last:c(function(e,t){return[t-1]}),eq:c(function(e,t,n){return[n<0?n+t:n]}),even:c(function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e}),odd:c(function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e}),lt:c(function(e,t,n){for(var r=n<0?n+t:n>t?t:n;--r>=0;)e.push(r);return e}),gt:c(function(e,t,n){for(var r=n<0?n+t:n;++r<t;)e.push(r);return e})}},x.pseudos.nth=x.pseudos.eq;for(b in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})x.pseudos[b]=function(e){return function(t){return"input"===t.nodeName.toLowerCase()&&t.type===e}}(b);for(b in{submit:!0,reset:!0})x.pseudos[b]=function(e){return function(t){var n=t.nodeName.toLowerCase();return("input"===n||"button"===n)&&t.type===e}}(b);return l.prototype=x.filters=x.pseudos,x.setFilters=new l,k=t.tokenize=function(e,n){var r,i,o,a,s,c,u,l=B[e+" "];if(l)return n?0:l.slice(0);for(s=e,c=[],u=x.preFilter;s;){r&&!(i=se.exec(s))||(i&&(s=s.slice(i[0].length)||s),c.push(o=[])),r=!1,(i=ce.exec(s))&&(r=i.shift(),o.push({value:r,type:i[0].replace(ae," ")}),s=s.slice(r.length));for(a in x.filter)!(i=pe[a].exec(s))||u[a]&&!(i=u[a](i))||(r=i.shift(),o.push({value:r,type:a,matches:i}),s=s.slice(r.length));if(!r)break}return n?s.length:s?t.error(e):B(e,c).slice(0)},O=t.compile=function(e,t){var n,r=[],i=[],o=W[e+" "];if(!o){for(t||(t=k(e)),n=t.length;n--;)o=m(t[n]),o[q]?r.push(o):i.push(o);o=W(e,v(i,r)),o.selector=e}return o},j=t.select=function(e,t,n,r){var i,o,a,s,c,l="function"==typeof e&&e,p=!r&&k(e=l.selector||e);if(n=n||[],1===p.length){if(o=p[0]=p[0].slice(0),o.length>2&&"ID"===(a=o[0]).type&&9===t.nodeType&&I&&x.relative[o[1].type]){if(!(t=(x.find.ID(a.matches[0].replace(be,we),t)||[])[0]))return n;l&&(t=t.parentNode),e=e.slice(o.shift().value.length)}for(i=pe.needsContext.test(e)?0:o.length;i--&&(a=o[i],!x.relative[s=a.type]);)if((c=x.find[s])&&(r=c(a.matches[0].replace(be,we),ve.test(o[0].type)&&u(t.parentNode)||t))){if(o.splice(i,1),!(e=r.length&&f(o)))return Z.apply(n,r),n;break}}return(l||O(e,p))(r,t,!I,n,!t||ve.test(e)&&u(t.parentNode)||t),n},w.sortStable=q.split("").sort(U).join("")===q,w.detectDuplicates=!!E,N(),w.sortDetached=i(function(e){return 1&e.compareDocumentPosition(_.createElement("fieldset"))}),i(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||o("type|href|height|width",function(e,t,n){if(!n)return e.getAttribute(t,"type"===t.toLowerCase()?1:2)}),w.attributes&&i(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||o("value",function(e,t,n){if(!n&&"input"===e.nodeName.toLowerCase())return e.defaultValue}),i(function(e){return null==e.getAttribute("disabled")})||o(ee,function(e,t,n){var r;if(!n)return!0===e[t]?t.toLowerCase():(r=e.getAttributeNode(t))&&r.specified?r.value:null}),t}(e);Se.find=Oe,Se.expr=Oe.selectors,Se.expr[":"]=Se.expr.pseudos,Se.uniqueSort=Se.unique=Oe.uniqueSort,Se.text=Oe.getText,Se.isXMLDoc=Oe.isXML,Se.contains=Oe.contains,Se.escapeSelector=Oe.escape;var je=function(e,t,n){for(var r=[],i=void 0!==n;(e=e[t])&&9!==e.nodeType;)if(1===e.nodeType){if(i&&Se(e).is(n))break;r.push(e)}return r},Ae=function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n},Ce=Se.expr.match.needsContext,Ee=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;Se.filter=function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?Se.find.matchesSelector(r,e)?[r]:[]:Se.find.matches(e,Se.grep(t,function(e){return 1===e.nodeType}))},Se.fn.extend({find:function(e){var t,n,r=this.length,i=this;if("string"!=typeof e)return this.pushStack(Se(e).filter(function(){for(t=0;t<r;t++)if(Se.contains(i[t],this))return!0}));for(n=this.pushStack([]),t=0;t<r;t++)Se.find(e,i[t],n);return r>1?Se.uniqueSort(n):n},filter:function(e){return this.pushStack(a(this,e||[],!1))},not:function(e){return this.pushStack(a(this,e||[],!0))},is:function(e){return!!a(this,"string"==typeof e&&Ce.test(e)?Se(e):e||[],!1).length}});var Ne,_e=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;(Se.fn.init=function(e,t,n){var r,i;if(!e)return this;if(n=n||Ne,"string"==typeof e){if(!(r="<"===e[0]&&">"===e[e.length-1]&&e.length>=3?[null,e,null]:_e.exec(e))||!r[1]&&t)return!t||t.jquery?(t||n).find(e):this.constructor(t).find(e);if(r[1]){if(t=t instanceof Se?t[0]:t,Se.merge(this,Se.parseHTML(r[1],t&&t.nodeType?t.ownerDocument||t:ce,!0)),Ee.test(r[1])&&Se.isPlainObject(t))for(r in t)we(this[r])?this[r](t[r]):this.attr(r,t[r]);return this}return i=ce.getElementById(r[2]),i&&(this[0]=i,this.length=1),this}return e.nodeType?(this[0]=e,this.length=1,this):we(e)?void 0!==n.ready?n.ready(e):e(Se):Se.makeArray(e,this)}).prototype=Se.fn,Ne=Se(ce);var Pe=/^(?:parents|prev(?:Until|All))/,Ie={children:!0,contents:!0,next:!0,prev:!0};Se.fn.extend({has:function(e){var t=Se(e,this),n=t.length;return this.filter(function(){for(var e=0;e<n;e++)if(Se.contains(this,t[e]))return!0})},closest:function(e,t){var n,r=0,i=this.length,o=[],a="string"!=typeof e&&Se(e);if(!Ce.test(e))for(;r<i;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(a?a.index(n)>-1:1===n.nodeType&&Se.find.matchesSelector(n,e))){o.push(n);break}return this.pushStack(o.length>1?Se.uniqueSort(o):o)},index:function(e){return e?"string"==typeof e?de.call(Se(e),this[0]):de.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(Se.uniqueSort(Se.merge(this.get(),Se(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),Se.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return je(e,"parentNode")},parentsUntil:function(e,t,n){return je(e,"parentNode",n)},next:function(e){return s(e,"nextSibling")},prev:function(e){return s(e,"previousSibling")},nextAll:function(e){return je(e,"nextSibling")},prevAll:function(e){return je(e,"previousSibling")},nextUntil:function(e,t,n){return je(e,"nextSibling",n)},prevUntil:function(e,t,n){return je(e,"previousSibling",n)},siblings:function(e){return Ae((e.parentNode||{}).firstChild,e)},children:function(e){return Ae(e.firstChild)},contents:function(e){return void 0!==e.contentDocument?e.contentDocument:(o(e,"template")&&(e=e.content||e),Se.merge([],e.childNodes))}},function(e,t){Se.fn[e]=function(n,r){var i=Se.map(this,t,n);return"Until"!==e.slice(-5)&&(r=n),r&&"string"==typeof r&&(i=Se.filter(r,i)),this.length>1&&(Ie[e]||Se.uniqueSort(i),Pe.test(e)&&i.reverse()),this.pushStack(i)}});var Me=/[^\x20\t\r\n\f]+/g;Se.Callbacks=function(e){e="string"==typeof e?c(e):Se.extend({},e);var t,n,i,o,a=[],s=[],u=-1,l=function(){for(o=o||e.once,i=t=!0;s.length;u=-1)for(n=s.shift();++u<a.length;)!1===a[u].apply(n[0],n[1])&&e.stopOnFalse&&(u=a.length,n=!1);e.memory||(n=!1),t=!1,o&&(a=n?[]:"")},f={add:function(){return a&&(n&&!t&&(u=a.length-1,s.push(n)),function t(n){Se.each(n,function(n,i){we(i)?e.unique&&f.has(i)||a.push(i):i&&i.length&&"string"!==r(i)&&t(i)})}(arguments),n&&!t&&l()),this},remove:function(){return Se.each(arguments,function(e,t){for(var n;(n=Se.inArray(t,a,n))>-1;)a.splice(n,1),n<=u&&u--}),this},has:function(e){return e?Se.inArray(e,a)>-1:a.length>0},empty:function(){return a&&(a=[]),this},disable:function(){return o=s=[],a=n="",this},disabled:function(){return!a},lock:function(){return o=s=[],n||t||(a=n=""),this},locked:function(){return!!o},fireWith:function(e,n){return o||(n=n||[],n=[e,n.slice?n.slice():n],s.push(n),t||l()),this},fire:function(){return f.fireWith(this,arguments),this},fired:function(){return!!i}};return f},Se.extend({Deferred:function(t){var n=[["notify","progress",Se.Callbacks("memory"),Se.Callbacks("memory"),2],["resolve","done",Se.Callbacks("once memory"),Se.Callbacks("once memory"),0,"resolved"],["reject","fail",Se.Callbacks("once memory"),Se.Callbacks("once memory"),1,"rejected"]],r="pending",i={state:function(){return r},always:function(){return o.done(arguments).fail(arguments),this},catch:function(e){return i.then(null,e)},pipe:function(){var e=arguments;return Se.Deferred(function(t){Se.each(n,function(n,r){var i=we(e[r[4]])&&e[r[4]];o[r[1]](function(){var e=i&&i.apply(this,arguments);e&&we(e.promise)?e.promise().progress(t.notify).done(t.resolve).fail(t.reject):t[r[0]+"With"](this,i?[e]:arguments)})}),e=null}).promise()},then:function(t,r,i){function o(t,n,r,i){return function(){var s=this,c=arguments,f=function(){var e,f;if(!(t<a)){if((e=r.apply(s,c))===n.promise())throw new TypeError("Thenable self-resolution");f=e&&("object"===(void 0===e?"undefined":_typeof(e))||"function"==typeof e)&&e.then,we(f)?i?f.call(e,o(a,n,u,i),o(a,n,l,i)):(a++,f.call(e,o(a,n,u,i),o(a,n,l,i),o(a,n,u,n.notifyWith))):(r!==u&&(s=void 0,c=[e]),(i||n.resolveWith)(s,c))}},p=i?f:function(){try{f()}catch(e){Se.Deferred.exceptionHook&&Se.Deferred.exceptionHook(e,p.stackTrace),t+1>=a&&(r!==l&&(s=void 0,c=[e]),n.rejectWith(s,c))}};t?p():(Se.Deferred.getStackHook&&(p.stackTrace=Se.Deferred.getStackHook()),e.setTimeout(p))}}var a=0;return Se.Deferred(function(e){n[0][3].add(o(0,e,we(i)?i:u,e.notifyWith)),n[1][3].add(o(0,e,we(t)?t:u)),n[2][3].add(o(0,e,we(r)?r:l))}).promise()},promise:function(e){return null!=e?Se.extend(e,i):i}},o={};return Se.each(n,function(e,t){var a=t[2],s=t[5];i[t[1]]=a.add,s&&a.add(function(){r=s},n[3-e][2].disable,n[3-e][3].disable,n[0][2].lock,n[0][3].lock),a.add(t[3].fire),o[t[0]]=function(){return o[t[0]+"With"](this===o?void 0:this,arguments),this},o[t[0]+"With"]=a.fireWith}),i.promise(o),t&&t.call(o,o),o},when:function(e){var t=arguments.length,n=t,r=Array(n),i=le.call(arguments),o=Se.Deferred(),a=function(e){return function(n){r[e]=this,i[e]=arguments.length>1?le.call(arguments):n,--t||o.resolveWith(r,i)}};if(t<=1&&(f(e,o.done(a(n)).resolve,o.reject,!t),"pending"===o.state()||we(i[n]&&i[n].then)))return o.then();for(;n--;)f(i[n],a(n),o.reject);return o.promise()}});var De=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;Se.Deferred.exceptionHook=function(t,n){e.console&&e.console.warn&&t&&De.test(t.name)&&e.console.warn("jQuery.Deferred exception: "+t.message,t.stack,n)},Se.readyException=function(t){e.setTimeout(function(){throw t})};var Le=Se.Deferred();Se.fn.ready=function(e){return Le.then(e).catch(function(e){Se.readyException(e)}),this},Se.extend({isReady:!1,readyWait:1,ready:function(e){(!0===e?--Se.readyWait:Se.isReady)||(Se.isReady=!0,!0!==e&&--Se.readyWait>0||Le.resolveWith(ce,[Se]))}}),Se.ready.then=Le.then,"complete"===ce.readyState||"loading"!==ce.readyState&&!ce.documentElement.doScroll?e.setTimeout(Se.ready):(ce.addEventListener("DOMContentLoaded",p),e.addEventListener("load",p));var Re=function e(t,n,i,o,a,s,c){var u=0,l=t.length,f=null==i;if("object"===r(i)){a=!0;for(u in i)e(t,n,u,i[u],!0,s,c)}else if(void 0!==o&&(a=!0,we(o)||(c=!0),f&&(c?(n.call(t,o),n=null):(f=n,n=function(e,t,n){return f.call(Se(e),n)})),n))for(;u<l;u++)n(t[u],i,c?o:o.call(t[u],u,n(t[u],i)));return a?t:f?n.call(t):l?n(t[0],i):s},qe=/^-ms-/,Fe=/-([a-z])/g,He=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType};g.uid=1,g.prototype={cache:function(e){var t=e[this.expando];return t||(t={},He(e)&&(e.nodeType?e[this.expando]=t:Object.defineProperty(e,this.expando,{value:t,configurable:!0}))),t},set:function(e,t,n){var r,i=this.cache(e);if("string"==typeof t)i[h(t)]=n;else for(r in t)i[h(r)]=t[r];return i},get:function(e,t){return void 0===t?this.cache(e):e[this.expando]&&e[this.expando][h(t)]},access:function(e,t,n){return void 0===t||t&&"string"==typeof t&&void 0===n?this.get(e,t):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,r=e[this.expando];if(void 0!==r){if(void 0!==t){Array.isArray(t)?t=t.map(h):(t=h(t),t=t in r?[t]:t.match(Me)||[]),n=t.length;for(;n--;)delete r[t[n]]}(void 0===t||Se.isEmptyObject(r))&&(e.nodeType?e[this.expando]=void 0:delete e[this.expando])}},hasData:function(e){var t=e[this.expando];return void 0!==t&&!Se.isEmptyObject(t)}};var Ve=new g,$e=new g,Be=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,We=/[A-Z]/g;Se.extend({hasData:function(e){return $e.hasData(e)||Ve.hasData(e)},data:function(e,t,n){return $e.access(e,t,n)},removeData:function(e,t){$e.remove(e,t)},_data:function(e,t,n){return Ve.access(e,t,n)},_removeData:function(e,t){Ve.remove(e,t)}}),Se.fn.extend({data:function(e,t){var n,r,i,o=this[0],a=o&&o.attributes;if(void 0===e){if(this.length&&(i=$e.get(o),1===o.nodeType&&!Ve.get(o,"hasDataAttrs"))){for(n=a.length;n--;)a[n]&&(r=a[n].name,0===r.indexOf("data-")&&(r=h(r.slice(5)),m(o,r,i[r])));Ve.set(o,"hasDataAttrs",!0)}return i}return"object"===(void 0===e?"undefined":_typeof(e))?this.each(function(){$e.set(this,e)}):Re(this,function(t){var n;if(o&&void 0===t){if(void 0!==(n=$e.get(o,e)))return n;if(void 0!==(n=m(o,e)))return n}else this.each(function(){$e.set(this,e,t)})},null,t,arguments.length>1,null,!0)},removeData:function(e){return this.each(function(){$e.remove(this,e)})}}),Se.extend({queue:function(e,t,n){var r;if(e)return t=(t||"fx")+"queue",r=Ve.get(e,t),n&&(!r||Array.isArray(n)?r=Ve.access(e,t,Se.makeArray(n)):r.push(n)),r||[]},dequeue:function(e,t){t=t||"fx";var n=Se.queue(e,t),r=n.length,i=n.shift(),o=Se._queueHooks(e,t),a=function(){Se.dequeue(e,t)};"inprogress"===i&&(i=n.shift(),r--),i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,a,o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return Ve.get(e,n)||Ve.access(e,n,{empty:Se.Callbacks("once memory").add(function(){Ve.remove(e,[t+"queue",n])})})}}),Se.fn.extend({queue:function(e,t){var n=2;return"string"!=typeof e&&(t=e,e="fx",n--),arguments.length<n?Se.queue(this[0],e):void 0===t?this:this.each(function(){var n=Se.queue(this,e,t);Se._queueHooks(this,e),"fx"===e&&"inprogress"!==n[0]&&Se.dequeue(this,e)})},dequeue:function(e){return this.each(function(){Se.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,r=1,i=Se.Deferred(),o=this,a=this.length,s=function(){--r||i.resolveWith(o,[o])};for("string"!=typeof e&&(t=e,e=void 0),e=e||"fx";a--;)(n=Ve.get(o[a],e+"queueHooks"))&&n.empty&&(r++,n.empty.add(s));return s(),i.promise(t)}});var ze=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,Ue=new RegExp("^(?:([+-])=|)("+ze+")([a-z%]*)$","i"),Ge=["Top","Right","Bottom","Left"],Je=ce.documentElement,Xe=function(e){return Se.contains(e.ownerDocument,e)},Ye={composed:!0};Je.getRootNode&&(Xe=function(e){return Se.contains(e.ownerDocument,e)||e.getRootNode(Ye)===e.ownerDocument});var Ze=function(e,t){return e=t||e,"none"===e.style.display||""===e.style.display&&Xe(e)&&"none"===Se.css(e,"display")},Qe=function(e,t,n,r){var i,o,a={};for(o in t)a[o]=e.style[o],e.style[o]=t[o];i=n.apply(e,r||[]);for(o in t)e.style[o]=a[o];return i},Ke={};Se.fn.extend({show:function(){return w(this,!0)},hide:function(){return w(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){Ze(this)?Se(this).show():Se(this).hide()})}});var et=/^(?:checkbox|radio)$/i,tt=/<([a-z][^\/\0>\x20\t\r\n\f]*)/i,nt=/^$|^module$|\/(?:java|ecma)script/i,rt={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};rt.optgroup=rt.option,rt.tbody=rt.tfoot=rt.colgroup=rt.caption=rt.thead,rt.th=rt.td;var it=/<|&#?\w+;/;!function(){var e=ce.createDocumentFragment(),t=e.appendChild(ce.createElement("div")),n=ce.createElement("input");n.setAttribute("type","radio"),n.setAttribute("checked","checked"),n.setAttribute("name","t"),t.appendChild(n),be.checkClone=t.cloneNode(!0).cloneNode(!0).lastChild.checked,t.innerHTML="<textarea>x</textarea>",be.noCloneChecked=!!t.cloneNode(!0).lastChild.defaultValue}();var ot=/^key/,at=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,st=/^([^.]*)(?:\.(.+)|)/;Se.event={global:{},add:function(e,t,n,r,i){var o,a,s,c,u,l,f,p,d,h,g,y=Ve.get(e);if(y)for(n.handler&&(o=n,n=o.handler,i=o.selector),i&&Se.find.matchesSelector(Je,i),n.guid||(n.guid=Se.guid++),(c=y.events)||(c=y.events={}),(a=y.handle)||(a=y.handle=function(t){return void 0!==Se&&Se.event.triggered!==t.type?Se.event.dispatch.apply(e,arguments):void 0}),t=(t||"").match(Me)||[""],u=t.length;u--;)s=st.exec(t[u])||[],d=g=s[1],h=(s[2]||"").split(".").sort(),d&&(f=Se.event.special[d]||{},d=(i?f.delegateType:f.bindType)||d,f=Se.event.special[d]||{},l=Se.extend({type:d,origType:g,data:r,handler:n,guid:n.guid,selector:i,needsContext:i&&Se.expr.match.needsContext.test(i),namespace:h.join(".")},o),(p=c[d])||(p=c[d]=[],p.delegateCount=0,f.setup&&!1!==f.setup.call(e,r,h,a)||e.addEventListener&&e.addEventListener(d,a)),f.add&&(f.add.call(e,l),l.handler.guid||(l.handler.guid=n.guid)),i?p.splice(p.delegateCount++,0,l):p.push(l),Se.event.global[d]=!0)},remove:function(e,t,n,r,i){var o,a,s,c,u,l,f,p,d,h,g,y=Ve.hasData(e)&&Ve.get(e);if(y&&(c=y.events)){for(t=(t||"").match(Me)||[""],u=t.length;u--;)if(s=st.exec(t[u])||[],d=g=s[1],h=(s[2]||"").split(".").sort(),d){for(f=Se.event.special[d]||{},d=(r?f.delegateType:f.bindType)||d,p=c[d]||[],s=s[2]&&new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=p.length;o--;)l=p[o],!i&&g!==l.origType||n&&n.guid!==l.guid||s&&!s.test(l.namespace)||r&&r!==l.selector&&("**"!==r||!l.selector)||(p.splice(o,1),l.selector&&p.delegateCount--,f.remove&&f.remove.call(e,l));a&&!p.length&&(f.teardown&&!1!==f.teardown.call(e,h,y.handle)||Se.removeEvent(e,d,y.handle),delete c[d])}else for(d in c)Se.event.remove(e,d+t[u],n,r,!0);Se.isEmptyObject(c)&&Ve.remove(e,"handle events")}},dispatch:function(e){var t,n,r,i,o,a,s=Se.event.fix(e),c=new Array(arguments.length),u=(Ve.get(this,"events")||{})[s.type]||[],l=Se.event.special[s.type]||{};for(c[0]=s,t=1;t<arguments.length;t++)c[t]=arguments[t];if(s.delegateTarget=this,!l.preDispatch||!1!==l.preDispatch.call(this,s)){for(a=Se.event.handlers.call(this,s,u),t=0;(i=a[t++])&&!s.isPropagationStopped();)for(s.currentTarget=i.elem,n=0;(o=i.handlers[n++])&&!s.isImmediatePropagationStopped();)s.rnamespace&&!1!==o.namespace&&!s.rnamespace.test(o.namespace)||(s.handleObj=o,s.data=o.data,void 0!==(r=((Se.event.special[o.origType]||{}).handle||o.handler).apply(i.elem,c))&&!1===(s.result=r)&&(s.preventDefault(),s.stopPropagation()));return l.postDispatch&&l.postDispatch.call(this,s),s.result}},handlers:function(e,t){var n,r,i,o,a,s=[],c=t.delegateCount,u=e.target;if(c&&u.nodeType&&!("click"===e.type&&e.button>=1))for(;u!==this;u=u.parentNode||this)if(1===u.nodeType&&("click"!==e.type||!0!==u.disabled)){for(o=[],a={},n=0;n<c;n++)r=t[n],i=r.selector+" ",void 0===a[i]&&(a[i]=r.needsContext?Se(i,this).index(u)>-1:Se.find(i,this,null,[u]).length),a[i]&&o.push(r);o.length&&s.push({elem:u,handlers:o})}return u=this,c<t.length&&s.push({elem:u,handlers:t.slice(c)}),s},addProp:function(e,t){Object.defineProperty(Se.Event.prototype,e,{enumerable:!0,configurable:!0,get:we(t)?function(){if(this.originalEvent)return t(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[e]},set:function(t){Object.defineProperty(this,e,{enumerable:!0,configurable:!0,writable:!0,value:t})}})},fix:function(e){return e[Se.expando]?e:new Se.Event(e)},special:{load:{noBubble:!0},click:{setup:function(e){var t=this||e;return et.test(t.type)&&t.click&&o(t,"input")&&E(t,"click",k),!1},trigger:function(e){var t=this||e;return et.test(t.type)&&t.click&&o(t,"input")&&E(t,"click"),!0},_default:function(e){var t=e.target;return et.test(t.type)&&t.click&&o(t,"input")&&Ve.get(t,"click")||o(t,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}}},Se.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n)},Se.Event=function(e,t){if(!(this instanceof Se.Event))return new Se.Event(e,t);e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?k:O,this.target=e.target&&3===e.target.nodeType?e.target.parentNode:e.target,this.currentTarget=e.currentTarget,this.relatedTarget=e.relatedTarget):this.type=e,t&&Se.extend(this,t),this.timeStamp=e&&e.timeStamp||Date.now(),this[Se.expando]=!0},Se.Event.prototype={constructor:Se.Event,isDefaultPrevented:O,isPropagationStopped:O,isImmediatePropagationStopped:O,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=k,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=k,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=k,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},Se.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,char:!0,code:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:function(e){var t=e.button;return null==e.which&&ot.test(e.type)?null!=e.charCode?e.charCode:e.keyCode:!e.which&&void 0!==t&&at.test(e.type)?1&t?1:2&t?3:4&t?2:0:e.which}},Se.event.addProp),Se.each({focus:"focusin",blur:"focusout"},function(e,t){Se.event.special[e]={setup:function(){return E(this,e,j),!1},trigger:function(){return E(this,e),!0},delegateType:t}}),Se.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,t){Se.event.special[e]={delegateType:t,bindType:t,handle:function(e){var n,r=this,i=e.relatedTarget,o=e.handleObj;return i&&(i===r||Se.contains(r,i))||(e.type=o.origType,n=o.handler.apply(this,arguments),e.type=t),n}}}),Se.fn.extend({on:function(e,t,n,r){return C(this,e,t,n,r)},one:function(e,t,n,r){return C(this,e,t,n,r,1)},off:function(e,t,n){var r,i;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,Se(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"===(void 0===e?"undefined":_typeof(e))){for(i in e)this.off(i,t,e[i]);return this}return!1!==t&&"function"!=typeof t||(n=t,t=void 0),!1===n&&(n=O),this.each(function(){Se.event.remove(this,e,n,t)})}});var ct=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^\/\0>\x20\t\r\n\f]*)[^>]*)\/>/gi,ut=/<script|<style|<link/i,lt=/checked\s*(?:[^=]|=\s*.checked.)/i,ft=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;Se.extend({htmlPrefilter:function(e){return e.replace(ct,"<$1></$2>")},clone:function(e,t,n){var r,i,o,a,s=e.cloneNode(!0),c=Xe(e);if(!(be.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||Se.isXMLDoc(e)))for(a=x(s),o=x(e),r=0,i=o.length;r<i;r++)M(o[r],a[r]);if(t)if(n)for(o=o||x(e),a=a||x(s),r=0,i=o.length;r<i;r++)I(o[r],a[r]);else I(e,s);return a=x(s,"script"),a.length>0&&T(a,!c&&x(e,"script")),s},cleanData:function(e){for(var t,n,r,i=Se.event.special,o=0;void 0!==(n=e[o]);o++)if(He(n)){if(t=n[Ve.expando]){if(t.events)for(r in t.events)i[r]?Se.event.remove(n,r):Se.removeEvent(n,r,t.handle);n[Ve.expando]=void 0}n[$e.expando]&&(n[$e.expando]=void 0)}}}),Se.fn.extend({detach:function(e){return L(this,e,!0)},remove:function(e){return L(this,e)},text:function(e){return Re(this,function(e){return void 0===e?Se.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=e)})},null,e,arguments.length)},append:function(){return D(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){N(this,e).appendChild(e)}})},prepend:function(){return D(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=N(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return D(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return D(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(Se.cleanData(x(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return Se.clone(this,e,t)})},html:function(e){return Re(this,function(e){var t=this[0]||{},n=0,r=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!ut.test(e)&&!rt[(tt.exec(e)||["",""])[1].toLowerCase()]){e=Se.htmlPrefilter(e);try{for(;n<r;n++)t=this[n]||{},1===t.nodeType&&(Se.cleanData(x(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var e=[];return D(this,arguments,function(t){var n=this.parentNode;Se.inArray(this,e)<0&&(Se.cleanData(x(this)),n&&n.replaceChild(t,this))},e)}}),Se.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,t){Se.fn[e]=function(e){for(var n,r=[],i=Se(e),o=i.length-1,a=0;a<=o;a++)n=a===o?this:this.clone(!0),Se(i[a])[t](n),pe.apply(r,n.get());return this.pushStack(r)}});var pt=new RegExp("^("+ze+")(?!px)[a-z%]+$","i"),dt=function(t){var n=t.ownerDocument.defaultView;return n&&n.opener||(n=e),n.getComputedStyle(t)},ht=new RegExp(Ge.join("|"),"i");!function(){function t(){if(u){c.style.cssText="position:absolute;left:-11111px;width:60px;margin-top:1px;padding:0;border:0",u.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;margin:auto;border:1px;padding:1px;width:60%;top:1%",Je.appendChild(c).appendChild(u);var t=e.getComputedStyle(u);r="1%"!==t.top,s=12===n(t.marginLeft),u.style.right="60%",a=36===n(t.right),i=36===n(t.width),u.style.position="absolute",o=12===n(u.offsetWidth/3),Je.removeChild(c),u=null}}function n(e){return Math.round(parseFloat(e))}var r,i,o,a,s,c=ce.createElement("div"),u=ce.createElement("div");u.style&&(u.style.backgroundClip="content-box",u.cloneNode(!0).style.backgroundClip="",be.clearCloneStyle="content-box"===u.style.backgroundClip,Se.extend(be,{boxSizingReliable:function(){return t(),i},pixelBoxStyles:function(){return t(),a},pixelPosition:function(){return t(),r},reliableMarginLeft:function(){return t(),s},scrollboxSize:function(){return t(),o}}))}();var gt=["Webkit","Moz","ms"],yt=ce.createElement("div").style,mt={},vt=/^(none|table(?!-c[ea]).+)/,bt=/^--/,wt={position:"absolute",visibility:"hidden",display:"block"},xt={letterSpacing:"0",fontWeight:"400"};Se.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=R(e,"opacity");return""===n?"1":n}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,gridArea:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnStart:!0,gridRow:!0,gridRowEnd:!0,gridRowStart:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,o,a,s=h(t),c=bt.test(t),u=e.style;if(c||(t=H(s)),a=Se.cssHooks[t]||Se.cssHooks[s],void 0===n)return a&&"get"in a&&void 0!==(i=a.get(e,!1,r))?i:u[t];o=void 0===n?"undefined":_typeof(n),"string"===o&&(i=Ue.exec(n))&&i[1]&&(n=v(e,t,i),o="number"),null!=n&&n===n&&("number"!==o||c||(n+=i&&i[3]||(Se.cssNumber[s]?"":"px")),be.clearCloneStyle||""!==n||0!==t.indexOf("background")||(u[t]="inherit"),a&&"set"in a&&void 0===(n=a.set(e,n,r))||(c?u.setProperty(t,n):u[t]=n))}},css:function(e,t,n,r){var i,o,a,s=h(t);return bt.test(t)||(t=H(s)),a=Se.cssHooks[t]||Se.cssHooks[s],
a&&"get"in a&&(i=a.get(e,!0,n)),void 0===i&&(i=R(e,t,r)),"normal"===i&&t in xt&&(i=xt[t]),""===n||n?(o=parseFloat(i),!0===n||isFinite(o)?o||0:i):i}}),Se.each(["height","width"],function(e,t){Se.cssHooks[t]={get:function(e,n,r){if(n)return!vt.test(Se.css(e,"display"))||e.getClientRects().length&&e.getBoundingClientRect().width?B(e,t,r):Qe(e,wt,function(){return B(e,t,r)})},set:function(e,n,r){var i,o=dt(e),a=!be.scrollboxSize()&&"absolute"===o.position,s=a||r,c=s&&"border-box"===Se.css(e,"boxSizing",!1,o),u=r?$(e,t,r,c,o):0;return c&&a&&(u-=Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-parseFloat(o[t])-$(e,t,"border",!1,o)-.5)),u&&(i=Ue.exec(n))&&"px"!==(i[3]||"px")&&(e.style[t]=n,n=Se.css(e,t)),V(e,n,u)}}}),Se.cssHooks.marginLeft=q(be.reliableMarginLeft,function(e,t){if(t)return(parseFloat(R(e,"marginLeft"))||e.getBoundingClientRect().left-Qe(e,{marginLeft:0},function(){return e.getBoundingClientRect().left}))+"px"}),Se.each({margin:"",padding:"",border:"Width"},function(e,t){Se.cssHooks[e+t]={expand:function(n){for(var r=0,i={},o="string"==typeof n?n.split(" "):[n];r<4;r++)i[e+Ge[r]+t]=o[r]||o[r-2]||o[0];return i}},"margin"!==e&&(Se.cssHooks[e+t].set=V)}),Se.fn.extend({css:function(e,t){return Re(this,function(e,t,n){var r,i,o={},a=0;if(Array.isArray(t)){for(r=dt(e),i=t.length;a<i;a++)o[t[a]]=Se.css(e,t[a],!1,r);return o}return void 0!==n?Se.style(e,t,n):Se.css(e,t)},e,t,arguments.length>1)}}),Se.Tween=W,W.prototype={constructor:W,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||Se.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(Se.cssNumber[n]?"":"px")},cur:function(){var e=W.propHooks[this.prop];return e&&e.get?e.get(this):W.propHooks._default.get(this)},run:function(e){var t,n=W.propHooks[this.prop];return this.options.duration?this.pos=t=Se.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):W.propHooks._default.set(this),this}},W.prototype.init.prototype=W.prototype,W.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=Se.css(e.elem,e.prop,""),t&&"auto"!==t?t:0)},set:function(e){Se.fx.step[e.prop]?Se.fx.step[e.prop](e):1!==e.elem.nodeType||!Se.cssHooks[e.prop]&&null==e.elem.style[H(e.prop)]?e.elem[e.prop]=e.now:Se.style(e.elem,e.prop,e.now+e.unit)}}},W.propHooks.scrollTop=W.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},Se.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},Se.fx=W.prototype.init,Se.fx.step={};var Tt,St,kt=/^(?:toggle|show|hide)$/,Ot=/queueHooks$/;Se.Animation=Se.extend(Z,{tweeners:{"*":[function(e,t){var n=this.createTween(e,t);return v(n.elem,e,Ue.exec(t),n),n}]},tweener:function(e,t){we(e)?(t=e,e=["*"]):e=e.match(Me);for(var n,r=0,i=e.length;r<i;r++)n=e[r],Z.tweeners[n]=Z.tweeners[n]||[],Z.tweeners[n].unshift(t)},prefilters:[X],prefilter:function(e,t){t?Z.prefilters.unshift(e):Z.prefilters.push(e)}}),Se.speed=function(e,t,n){var r=e&&"object"===(void 0===e?"undefined":_typeof(e))?Se.extend({},e):{complete:n||!n&&t||we(e)&&e,duration:e,easing:n&&t||t&&!we(t)&&t};return Se.fx.off?r.duration=0:"number"!=typeof r.duration&&(r.duration in Se.fx.speeds?r.duration=Se.fx.speeds[r.duration]:r.duration=Se.fx.speeds._default),null!=r.queue&&!0!==r.queue||(r.queue="fx"),r.old=r.complete,r.complete=function(){we(r.old)&&r.old.call(this),r.queue&&Se.dequeue(this,r.queue)},r},Se.fn.extend({fadeTo:function(e,t,n,r){return this.filter(Ze).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(e,t,n,r){var i=Se.isEmptyObject(e),o=Se.speed(t,n,r),a=function(){var t=Z(this,Se.extend({},e),o);(i||Ve.get(this,"finish"))&&t.stop(!0)};return a.finish=a,i||!1===o.queue?this.each(a):this.queue(o.queue,a)},stop:function(e,t,n){var r=function(e){var t=e.stop;delete e.stop,t(n)};return"string"!=typeof e&&(n=t,t=e,e=void 0),t&&!1!==e&&this.queue(e||"fx",[]),this.each(function(){var t=!0,i=null!=e&&e+"queueHooks",o=Se.timers,a=Ve.get(this);if(i)a[i]&&a[i].stop&&r(a[i]);else for(i in a)a[i]&&a[i].stop&&Ot.test(i)&&r(a[i]);for(i=o.length;i--;)o[i].elem!==this||null!=e&&o[i].queue!==e||(o[i].anim.stop(n),t=!1,o.splice(i,1));!t&&n||Se.dequeue(this,e)})},finish:function(e){return!1!==e&&(e=e||"fx"),this.each(function(){var t,n=Ve.get(this),r=n[e+"queue"],i=n[e+"queueHooks"],o=Se.timers,a=r?r.length:0;for(n.finish=!0,Se.queue(this,e,[]),i&&i.stop&&i.stop.call(this,!0),t=o.length;t--;)o[t].elem===this&&o[t].queue===e&&(o[t].anim.stop(!0),o.splice(t,1));for(t=0;t<a;t++)r[t]&&r[t].finish&&r[t].finish.call(this);delete n.finish})}}),Se.each(["toggle","show","hide"],function(e,t){var n=Se.fn[t];Se.fn[t]=function(e,r,i){return null==e||"boolean"==typeof e?n.apply(this,arguments):this.animate(G(t,!0),e,r,i)}}),Se.each({slideDown:G("show"),slideUp:G("hide"),slideToggle:G("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,t){Se.fn[e]=function(e,n,r){return this.animate(t,e,n,r)}}),Se.timers=[],Se.fx.tick=function(){var e,t=0,n=Se.timers;for(Tt=Date.now();t<n.length;t++)(e=n[t])()||n[t]!==e||n.splice(t--,1);n.length||Se.fx.stop(),Tt=void 0},Se.fx.timer=function(e){Se.timers.push(e),Se.fx.start()},Se.fx.interval=13,Se.fx.start=function(){St||(St=!0,z())},Se.fx.stop=function(){St=null},Se.fx.speeds={slow:600,fast:200,_default:400},Se.fn.delay=function(t,n){return t=Se.fx?Se.fx.speeds[t]||t:t,n=n||"fx",this.queue(n,function(n,r){var i=e.setTimeout(n,t);r.stop=function(){e.clearTimeout(i)}})},function(){var e=ce.createElement("input"),t=ce.createElement("select"),n=t.appendChild(ce.createElement("option"));e.type="checkbox",be.checkOn=""!==e.value,be.optSelected=n.selected,e=ce.createElement("input"),e.value="t",e.type="radio",be.radioValue="t"===e.value}();var jt,At=Se.expr.attrHandle;Se.fn.extend({attr:function(e,t){return Re(this,Se.attr,e,t,arguments.length>1)},removeAttr:function(e){return this.each(function(){Se.removeAttr(this,e)})}}),Se.extend({attr:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return void 0===e.getAttribute?Se.prop(e,t,n):(1===o&&Se.isXMLDoc(e)||(i=Se.attrHooks[t.toLowerCase()]||(Se.expr.match.bool.test(t)?jt:void 0)),void 0!==n?null===n?void Se.removeAttr(e,t):i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:(e.setAttribute(t,n+""),n):i&&"get"in i&&null!==(r=i.get(e,t))?r:(r=Se.find.attr(e,t),null==r?void 0:r))},attrHooks:{type:{set:function(e,t){if(!be.radioValue&&"radio"===t&&o(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},removeAttr:function(e,t){var n,r=0,i=t&&t.match(Me);if(i&&1===e.nodeType)for(;n=i[r++];)e.removeAttribute(n)}}),jt={set:function(e,t,n){return!1===t?Se.removeAttr(e,n):e.setAttribute(n,n),n}},Se.each(Se.expr.match.bool.source.match(/\w+/g),function(e,t){var n=At[t]||Se.find.attr;At[t]=function(e,t,r){var i,o,a=t.toLowerCase();return r||(o=At[a],At[a]=i,i=null!=n(e,t,r)?a:null,At[a]=o),i}});var Ct=/^(?:input|select|textarea|button)$/i,Et=/^(?:a|area)$/i;Se.fn.extend({prop:function(e,t){return Re(this,Se.prop,e,t,arguments.length>1)},removeProp:function(e){return this.each(function(){delete this[Se.propFix[e]||e]})}}),Se.extend({prop:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return 1===o&&Se.isXMLDoc(e)||(t=Se.propFix[t]||t,i=Se.propHooks[t]),void 0!==n?i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:e[t]=n:i&&"get"in i&&null!==(r=i.get(e,t))?r:e[t]},propHooks:{tabIndex:{get:function(e){var t=Se.find.attr(e,"tabindex");return t?parseInt(t,10):Ct.test(e.nodeName)||Et.test(e.nodeName)&&e.href?0:-1}}},propFix:{for:"htmlFor",class:"className"}}),be.optSelected||(Se.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null},set:function(e){var t=e.parentNode;t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex)}}),Se.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){Se.propFix[this.toLowerCase()]=this}),Se.fn.extend({addClass:function(e){var t,n,r,i,o,a,s,c=0;if(we(e))return this.each(function(t){Se(this).addClass(e.call(this,t,K(this)))});if(t=ee(e),t.length)for(;n=this[c++];)if(i=K(n),r=1===n.nodeType&&" "+Q(i)+" "){for(a=0;o=t[a++];)r.indexOf(" "+o+" ")<0&&(r+=o+" ");s=Q(r),i!==s&&n.setAttribute("class",s)}return this},removeClass:function(e){var t,n,r,i,o,a,s,c=0;if(we(e))return this.each(function(t){Se(this).removeClass(e.call(this,t,K(this)))});if(!arguments.length)return this.attr("class","");if(t=ee(e),t.length)for(;n=this[c++];)if(i=K(n),r=1===n.nodeType&&" "+Q(i)+" "){for(a=0;o=t[a++];)for(;r.indexOf(" "+o+" ")>-1;)r=r.replace(" "+o+" "," ");s=Q(r),i!==s&&n.setAttribute("class",s)}return this},toggleClass:function(e,t){var n=void 0===e?"undefined":_typeof(e),r="string"===n||Array.isArray(e);return"boolean"==typeof t&&r?t?this.addClass(e):this.removeClass(e):we(e)?this.each(function(n){Se(this).toggleClass(e.call(this,n,K(this),t),t)}):this.each(function(){var t,i,o,a;if(r)for(i=0,o=Se(this),a=ee(e);t=a[i++];)o.hasClass(t)?o.removeClass(t):o.addClass(t);else void 0!==e&&"boolean"!==n||(t=K(this),t&&Ve.set(this,"__className__",t),this.setAttribute&&this.setAttribute("class",t||!1===e?"":Ve.get(this,"__className__")||""))})},hasClass:function(e){var t,n,r=0;for(t=" "+e+" ";n=this[r++];)if(1===n.nodeType&&(" "+Q(K(n))+" ").indexOf(t)>-1)return!0;return!1}});var Nt=/\r/g;Se.fn.extend({val:function(e){var t,n,r,i=this[0];{if(arguments.length)return r=we(e),this.each(function(n){var i;1===this.nodeType&&(i=r?e.call(this,n,Se(this).val()):e,null==i?i="":"number"==typeof i?i+="":Array.isArray(i)&&(i=Se.map(i,function(e){return null==e?"":e+""})),(t=Se.valHooks[this.type]||Se.valHooks[this.nodeName.toLowerCase()])&&"set"in t&&void 0!==t.set(this,i,"value")||(this.value=i))});if(i)return(t=Se.valHooks[i.type]||Se.valHooks[i.nodeName.toLowerCase()])&&"get"in t&&void 0!==(n=t.get(i,"value"))?n:(n=i.value,"string"==typeof n?n.replace(Nt,""):null==n?"":n)}}}),Se.extend({valHooks:{option:{get:function(e){var t=Se.find.attr(e,"value");return null!=t?t:Q(Se.text(e))}},select:{get:function(e){var t,n,r,i=e.options,a=e.selectedIndex,s="select-one"===e.type,c=s?null:[],u=s?a+1:i.length;for(r=a<0?u:s?a:0;r<u;r++)if(n=i[r],(n.selected||r===a)&&!n.disabled&&(!n.parentNode.disabled||!o(n.parentNode,"optgroup"))){if(t=Se(n).val(),s)return t;c.push(t)}return c},set:function(e,t){for(var n,r,i=e.options,o=Se.makeArray(t),a=i.length;a--;)r=i[a],(r.selected=Se.inArray(Se.valHooks.option.get(r),o)>-1)&&(n=!0);return n||(e.selectedIndex=-1),o}}}}),Se.each(["radio","checkbox"],function(){Se.valHooks[this]={set:function(e,t){if(Array.isArray(t))return e.checked=Se.inArray(Se(e).val(),t)>-1}},be.checkOn||(Se.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})}),be.focusin="onfocusin"in e;var _t=/^(?:focusinfocus|focusoutblur)$/,Pt=function(e){e.stopPropagation()};Se.extend(Se.event,{trigger:function(t,n,r,i){var o,a,s,c,u,l,f,p,d=[r||ce],h=ye.call(t,"type")?t.type:t,g=ye.call(t,"namespace")?t.namespace.split("."):[];if(a=p=s=r=r||ce,3!==r.nodeType&&8!==r.nodeType&&!_t.test(h+Se.event.triggered)&&(h.indexOf(".")>-1&&(g=h.split("."),h=g.shift(),g.sort()),u=h.indexOf(":")<0&&"on"+h,t=t[Se.expando]?t:new Se.Event(h,"object"===(void 0===t?"undefined":_typeof(t))&&t),t.isTrigger=i?2:3,t.namespace=g.join("."),t.rnamespace=t.namespace?new RegExp("(^|\\.)"+g.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,t.result=void 0,t.target||(t.target=r),n=null==n?[t]:Se.makeArray(n,[t]),f=Se.event.special[h]||{},i||!f.trigger||!1!==f.trigger.apply(r,n))){if(!i&&!f.noBubble&&!xe(r)){for(c=f.delegateType||h,_t.test(c+h)||(a=a.parentNode);a;a=a.parentNode)d.push(a),s=a;s===(r.ownerDocument||ce)&&d.push(s.defaultView||s.parentWindow||e)}for(o=0;(a=d[o++])&&!t.isPropagationStopped();)p=a,t.type=o>1?c:f.bindType||h,l=(Ve.get(a,"events")||{})[t.type]&&Ve.get(a,"handle"),l&&l.apply(a,n),(l=u&&a[u])&&l.apply&&He(a)&&(t.result=l.apply(a,n),!1===t.result&&t.preventDefault());return t.type=h,i||t.isDefaultPrevented()||f._default&&!1!==f._default.apply(d.pop(),n)||!He(r)||u&&we(r[h])&&!xe(r)&&(s=r[u],s&&(r[u]=null),Se.event.triggered=h,t.isPropagationStopped()&&p.addEventListener(h,Pt),r[h](),t.isPropagationStopped()&&p.removeEventListener(h,Pt),Se.event.triggered=void 0,s&&(r[u]=s)),t.result}},simulate:function(e,t,n){var r=Se.extend(new Se.Event,n,{type:e,isSimulated:!0});Se.event.trigger(r,null,t)}}),Se.fn.extend({trigger:function(e,t){return this.each(function(){Se.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];if(n)return Se.event.trigger(e,t,n,!0)}}),be.focusin||Se.each({focus:"focusin",blur:"focusout"},function(e,t){var n=function(e){Se.event.simulate(t,e.target,Se.event.fix(e))};Se.event.special[t]={setup:function(){var r=this.ownerDocument||this,i=Ve.access(r,t);i||r.addEventListener(e,n,!0),Ve.access(r,t,(i||0)+1)},teardown:function(){var r=this.ownerDocument||this,i=Ve.access(r,t)-1;i?Ve.access(r,t,i):(r.removeEventListener(e,n,!0),Ve.remove(r,t))}}});var It=e.location,Mt=Date.now(),Dt=/\?/;Se.parseXML=function(t){var n;if(!t||"string"!=typeof t)return null;try{n=(new e.DOMParser).parseFromString(t,"text/xml")}catch(e){n=void 0}return n&&!n.getElementsByTagName("parsererror").length||Se.error("Invalid XML: "+t),n};var Lt=/\[\]$/,Rt=/\r?\n/g,qt=/^(?:submit|button|image|reset|file)$/i,Ft=/^(?:input|select|textarea|keygen)/i;Se.param=function(e,t){var n,r=[],i=function(e,t){var n=we(t)?t():t;r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(null==n?"":n)};if(null==e)return"";if(Array.isArray(e)||e.jquery&&!Se.isPlainObject(e))Se.each(e,function(){i(this.name,this.value)});else for(n in e)te(n,e[n],t,i);return r.join("&")},Se.fn.extend({serialize:function(){return Se.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=Se.prop(this,"elements");return e?Se.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!Se(this).is(":disabled")&&Ft.test(this.nodeName)&&!qt.test(e)&&(this.checked||!et.test(e))}).map(function(e,t){var n=Se(this).val();return null==n?null:Array.isArray(n)?Se.map(n,function(e){return{name:t.name,value:e.replace(Rt,"\r\n")}}):{name:t.name,value:n.replace(Rt,"\r\n")}}).get()}});var Ht=/%20/g,Vt=/#.*$/,$t=/([?&])_=[^&]*/,Bt=/^(.*?):[ \t]*([^\r\n]*)$/gm,Wt=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,zt=/^(?:GET|HEAD)$/,Ut=/^\/\//,Gt={},Jt={},Xt="*/".concat("*"),Yt=ce.createElement("a");Yt.href=It.href,Se.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:It.href,type:"GET",isLocal:Wt.test(It.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Xt,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":Se.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?ie(ie(e,Se.ajaxSettings),t):ie(Se.ajaxSettings,e)},ajaxPrefilter:ne(Gt),ajaxTransport:ne(Jt),ajax:function(t,n){function r(t,n,r,s){var u,p,d,w,x,T=n;l||(l=!0,c&&e.clearTimeout(c),i=void 0,a=s||"",S.readyState=t>0?4:0,u=t>=200&&t<300||304===t,r&&(w=oe(h,S,r)),w=ae(h,w,S,u),u?(h.ifModified&&(x=S.getResponseHeader("Last-Modified"),x&&(Se.lastModified[o]=x),(x=S.getResponseHeader("etag"))&&(Se.etag[o]=x)),204===t||"HEAD"===h.type?T="nocontent":304===t?T="notmodified":(T=w.state,p=w.data,d=w.error,u=!d)):(d=T,!t&&T||(T="error",t<0&&(t=0))),S.status=t,S.statusText=(n||T)+"",u?m.resolveWith(g,[p,T,S]):m.rejectWith(g,[S,T,d]),S.statusCode(b),b=void 0,f&&y.trigger(u?"ajaxSuccess":"ajaxError",[S,h,u?p:d]),v.fireWith(g,[S,T]),f&&(y.trigger("ajaxComplete",[S,h]),--Se.active||Se.event.trigger("ajaxStop")))}"object"===(void 0===t?"undefined":_typeof(t))&&(n=t,t=void 0),n=n||{};var i,o,a,s,c,u,l,f,p,d,h=Se.ajaxSetup({},n),g=h.context||h,y=h.context&&(g.nodeType||g.jquery)?Se(g):Se.event,m=Se.Deferred(),v=Se.Callbacks("once memory"),b=h.statusCode||{},w={},x={},T="canceled",S={readyState:0,getResponseHeader:function(e){var t;if(l){if(!s)for(s={};t=Bt.exec(a);)s[t[1].toLowerCase()+" "]=(s[t[1].toLowerCase()+" "]||[]).concat(t[2]);t=s[e.toLowerCase()+" "]}return null==t?null:t.join(", ")},getAllResponseHeaders:function(){return l?a:null},setRequestHeader:function(e,t){return null==l&&(e=x[e.toLowerCase()]=x[e.toLowerCase()]||e,w[e]=t),this},overrideMimeType:function(e){return null==l&&(h.mimeType=e),this},statusCode:function(e){var t;if(e)if(l)S.always(e[S.status]);else for(t in e)b[t]=[b[t],e[t]];return this},abort:function(e){var t=e||T;return i&&i.abort(t),r(0,t),this}};if(m.promise(S),h.url=((t||h.url||It.href)+"").replace(Ut,It.protocol+"//"),h.type=n.method||n.type||h.method||h.type,h.dataTypes=(h.dataType||"*").toLowerCase().match(Me)||[""],null==h.crossDomain){u=ce.createElement("a");try{u.href=h.url,u.href=u.href,h.crossDomain=Yt.protocol+"//"+Yt.host!=u.protocol+"//"+u.host}catch(e){h.crossDomain=!0}}if(h.data&&h.processData&&"string"!=typeof h.data&&(h.data=Se.param(h.data,h.traditional)),re(Gt,h,n,S),l)return S;f=Se.event&&h.global,f&&0==Se.active++&&Se.event.trigger("ajaxStart"),h.type=h.type.toUpperCase(),h.hasContent=!zt.test(h.type),o=h.url.replace(Vt,""),h.hasContent?h.data&&h.processData&&0===(h.contentType||"").indexOf("application/x-www-form-urlencoded")&&(h.data=h.data.replace(Ht,"+")):(d=h.url.slice(o.length),h.data&&(h.processData||"string"==typeof h.data)&&(o+=(Dt.test(o)?"&":"?")+h.data,delete h.data),!1===h.cache&&(o=o.replace($t,"$1"),d=(Dt.test(o)?"&":"?")+"_="+Mt+++d),h.url=o+d),h.ifModified&&(Se.lastModified[o]&&S.setRequestHeader("If-Modified-Since",Se.lastModified[o]),Se.etag[o]&&S.setRequestHeader("If-None-Match",Se.etag[o])),(h.data&&h.hasContent&&!1!==h.contentType||n.contentType)&&S.setRequestHeader("Content-Type",h.contentType),S.setRequestHeader("Accept",h.dataTypes[0]&&h.accepts[h.dataTypes[0]]?h.accepts[h.dataTypes[0]]+("*"!==h.dataTypes[0]?", "+Xt+"; q=0.01":""):h.accepts["*"]);for(p in h.headers)S.setRequestHeader(p,h.headers[p]);if(h.beforeSend&&(!1===h.beforeSend.call(g,S,h)||l))return S.abort();if(T="abort",v.add(h.complete),S.done(h.success),S.fail(h.error),i=re(Jt,h,n,S)){if(S.readyState=1,f&&y.trigger("ajaxSend",[S,h]),l)return S;h.async&&h.timeout>0&&(c=e.setTimeout(function(){S.abort("timeout")},h.timeout));try{l=!1,i.send(w,r)}catch(e){if(l)throw e;r(-1,e)}}else r(-1,"No Transport");return S},getJSON:function(e,t,n){return Se.get(e,t,n,"json")},getScript:function(e,t){return Se.get(e,void 0,t,"script")}}),Se.each(["get","post"],function(e,t){Se[t]=function(e,n,r,i){return we(n)&&(i=i||r,r=n,n=void 0),Se.ajax(Se.extend({url:e,type:t,dataType:i,data:n,success:r},Se.isPlainObject(e)&&e))}}),Se._evalUrl=function(e,t){return Se.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,converters:{"text script":function(){}},dataFilter:function(e){Se.globalEval(e,t)}})},Se.fn.extend({wrapAll:function(e){var t;return this[0]&&(we(e)&&(e=e.call(this[0])),t=Se(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){for(var e=this;e.firstElementChild;)e=e.firstElementChild;return e}).append(this)),this},wrapInner:function(e){return we(e)?this.each(function(t){Se(this).wrapInner(e.call(this,t))}):this.each(function(){var t=Se(this),n=t.contents();n.length?n.wrapAll(e):t.append(e)})},wrap:function(e){var t=we(e);return this.each(function(n){Se(this).wrapAll(t?e.call(this,n):e)})},unwrap:function(e){return this.parent(e).not("body").each(function(){Se(this).replaceWith(this.childNodes)}),this}}),Se.expr.pseudos.hidden=function(e){return!Se.expr.pseudos.visible(e)},Se.expr.pseudos.visible=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},Se.ajaxSettings.xhr=function(){try{return new e.XMLHttpRequest}catch(e){}};var Zt={0:200,1223:204},Qt=Se.ajaxSettings.xhr();be.cors=!!Qt&&"withCredentials"in Qt,be.ajax=Qt=!!Qt,Se.ajaxTransport(function(t){var n,r;if(be.cors||Qt&&!t.crossDomain)return{send:function(i,o){var a,s=t.xhr();if(s.open(t.type,t.url,t.async,t.username,t.password),t.xhrFields)for(a in t.xhrFields)s[a]=t.xhrFields[a];t.mimeType&&s.overrideMimeType&&s.overrideMimeType(t.mimeType),t.crossDomain||i["X-Requested-With"]||(i["X-Requested-With"]="XMLHttpRequest");for(a in i)s.setRequestHeader(a,i[a]);n=function(e){return function(){n&&(n=r=s.onload=s.onerror=s.onabort=s.ontimeout=s.onreadystatechange=null,"abort"===e?s.abort():"error"===e?"number"!=typeof s.status?o(0,"error"):o(s.status,s.statusText):o(Zt[s.status]||s.status,s.statusText,"text"!==(s.responseType||"text")||"string"!=typeof s.responseText?{binary:s.response}:{text:s.responseText},s.getAllResponseHeaders()))}},s.onload=n(),r=s.onerror=s.ontimeout=n("error"),void 0!==s.onabort?s.onabort=r:s.onreadystatechange=function(){4===s.readyState&&e.setTimeout(function(){n&&r()})},n=n("abort");try{s.send(t.hasContent&&t.data||null)}catch(e){if(n)throw e}},abort:function(){n&&n()}}}),Se.ajaxPrefilter(function(e){e.crossDomain&&(e.contents.script=!1)}),Se.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return Se.globalEval(e),e}}}),Se.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),Se.ajaxTransport("script",function(e){if(e.crossDomain||e.scriptAttrs){var t,n;return{send:function(r,i){t=Se("<script>").attr(e.scriptAttrs||{}).prop({charset:e.scriptCharset,src:e.url}).on("load error",n=function(e){t.remove(),n=null,e&&i("error"===e.type?404:200,e.type)}),ce.head.appendChild(t[0])},abort:function(){n&&n()}}}});var Kt=[],en=/(=)\?(?=&|$)|\?\?/;Se.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Kt.pop()||Se.expando+"_"+Mt++;return this[e]=!0,e}}),Se.ajaxPrefilter("json jsonp",function(t,n,r){var i,o,a,s=!1!==t.jsonp&&(en.test(t.url)?"url":"string"==typeof t.data&&0===(t.contentType||"").indexOf("application/x-www-form-urlencoded")&&en.test(t.data)&&"data");if(s||"jsonp"===t.dataTypes[0])return i=t.jsonpCallback=we(t.jsonpCallback)?t.jsonpCallback():t.jsonpCallback,s?t[s]=t[s].replace(en,"$1"+i):!1!==t.jsonp&&(t.url+=(Dt.test(t.url)?"&":"?")+t.jsonp+"="+i),t.converters["script json"]=function(){return a||Se.error(i+" was not called"),a[0]},t.dataTypes[0]="json",o=e[i],e[i]=function(){a=arguments},r.always(function(){void 0===o?Se(e).removeProp(i):e[i]=o,t[i]&&(t.jsonpCallback=n.jsonpCallback,Kt.push(i)),a&&we(o)&&o(a[0]),a=o=void 0}),"script"}),be.createHTMLDocument=function(){var e=ce.implementation.createHTMLDocument("").body;return e.innerHTML="<form></form><form></form>",2===e.childNodes.length}(),Se.parseHTML=function(e,t,n){if("string"!=typeof e)return[];"boolean"==typeof t&&(n=t,t=!1);var r,i,o;return t||(be.createHTMLDocument?(t=ce.implementation.createHTMLDocument(""),r=t.createElement("base"),r.href=ce.location.href,t.head.appendChild(r)):t=ce),i=Ee.exec(e),o=!n&&[],i?[t.createElement(i[1])]:(i=S([e],t,o),o&&o.length&&Se(o).remove(),Se.merge([],i.childNodes))},Se.fn.load=function(e,t,n){var r,i,o,a=this,s=e.indexOf(" ");return s>-1&&(r=Q(e.slice(s)),e=e.slice(0,s)),we(t)?(n=t,t=void 0):t&&"object"===(void 0===t?"undefined":_typeof(t))&&(i="POST"),a.length>0&&Se.ajax({url:e,type:i||"GET",dataType:"html",data:t}).done(function(e){o=arguments,a.html(r?Se("<div>").append(Se.parseHTML(e)).find(r):e)}).always(n&&function(e,t){a.each(function(){n.apply(this,o||[e.responseText,t,e])})}),this},Se.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){Se.fn[t]=function(e){return this.on(t,e)}}),Se.expr.pseudos.animated=function(e){return Se.grep(Se.timers,function(t){return e===t.elem}).length},Se.offset={setOffset:function(e,t,n){var r,i,o,a,s,c,u,l=Se.css(e,"position"),f=Se(e),p={};"static"===l&&(e.style.position="relative"),s=f.offset(),o=Se.css(e,"top"),c=Se.css(e,"left"),u=("absolute"===l||"fixed"===l)&&(o+c).indexOf("auto")>-1,u?(r=f.position(),a=r.top,i=r.left):(a=parseFloat(o)||0,i=parseFloat(c)||0),we(t)&&(t=t.call(e,n,Se.extend({},s))),null!=t.top&&(p.top=t.top-s.top+a),null!=t.left&&(p.left=t.left-s.left+i),"using"in t?t.using.call(e,p):f.css(p)}},Se.fn.extend({offset:function(e){if(arguments.length)return void 0===e?this:this.each(function(t){Se.offset.setOffset(this,e,t)});var t,n,r=this[0];if(r)return r.getClientRects().length?(t=r.getBoundingClientRect(),n=r.ownerDocument.defaultView,{top:t.top+n.pageYOffset,left:t.left+n.pageXOffset}):{top:0,left:0}},position:function(){if(this[0]){var e,t,n,r=this[0],i={top:0,left:0};if("fixed"===Se.css(r,"position"))t=r.getBoundingClientRect();else{for(t=this.offset(),n=r.ownerDocument,e=r.offsetParent||n.documentElement;e&&(e===n.body||e===n.documentElement)&&"static"===Se.css(e,"position");)e=e.parentNode;e&&e!==r&&1===e.nodeType&&(i=Se(e).offset(),i.top+=Se.css(e,"borderTopWidth",!0),i.left+=Se.css(e,"borderLeftWidth",!0))}return{top:t.top-i.top-Se.css(r,"marginTop",!0),left:t.left-i.left-Se.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var e=this.offsetParent;e&&"static"===Se.css(e,"position");)e=e.offsetParent;return e||Je})}}),Se.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(e,t){var n="pageYOffset"===t;Se.fn[e]=function(r){return Re(this,function(e,r,i){var o;if(xe(e)?o=e:9===e.nodeType&&(o=e.defaultView),void 0===i)return o?o[t]:e[r];o?o.scrollTo(n?o.pageXOffset:i,n?i:o.pageYOffset):e[r]=i},e,r,arguments.length)}}),Se.each(["top","left"],function(e,t){Se.cssHooks[t]=q(be.pixelPosition,function(e,n){if(n)return n=R(e,t),pt.test(n)?Se(e).position()[t]+"px":n})}),Se.each({Height:"height",Width:"width"},function(e,t){Se.each({padding:"inner"+e,content:t,"":"outer"+e},function(n,r){Se.fn[r]=function(i,o){var a=arguments.length&&(n||"boolean"!=typeof i),s=n||(!0===i||!0===o?"margin":"border");return Re(this,function(t,n,i){var o;return xe(t)?0===r.indexOf("outer")?t["inner"+e]:t.document.documentElement["client"+e]:9===t.nodeType?(o=t.documentElement,Math.max(t.body["scroll"+e],o["scroll"+e],t.body["offset"+e],o["offset"+e],o["client"+e])):void 0===i?Se.css(t,n,s):Se.style(t,n,i,s)},t,a?i:void 0,a)}})}),Se.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(e,t){Se.fn[t]=function(e,n){return arguments.length>0?this.on(t,null,e,n):this.trigger(t)}}),Se.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)}}),Se.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)}}),Se.proxy=function(e,t){var n,r,i;if("string"==typeof t&&(n=e[t],t=e,e=n),we(e))return r=le.call(arguments,2),i=function(){return e.apply(t||this,r.concat(le.call(arguments)))},i.guid=e.guid=e.guid||Se.guid++,i},Se.holdReady=function(e){e?Se.readyWait++:Se.ready(!0)},Se.isArray=Array.isArray,Se.parseJSON=JSON.parse,Se.nodeName=o,Se.isFunction=we,Se.isWindow=xe,Se.camelCase=h,Se.type=r,Se.now=Date.now,Se.isNumeric=function(e){var t=Se.type(e);return("number"===t||"string"===t)&&!isNaN(e-parseFloat(e))},"function"==typeof define&&define.amd&&define("jquery",[],function(){return Se});var tn=e.jQuery,nn=e.$;return Se.noConflict=function(t){return e.$===Se&&(e.$=nn),t&&e.jQuery===Se&&(e.jQuery=tn),Se},t||(e.jQuery=e.$=Se),Se}),/*!
 * https://github.com/paulmillr/es6-shim
 * @license es6-shim Copyright 2013-2016 by Paul Miller (http://paulmillr.com)
 *   and contributors,  MIT License
 * es6-shim: v0.35.4
 * see https://github.com/paulmillr/es6-shim/blob/0.35.3/LICENSE
 * Details and documentation:
 * https://github.com/paulmillr/es6-shim/
 */
function(e,t){"function"==typeof define&&define.amd?define("es6-shim",t):"object"===("undefined"==typeof exports?"undefined":_typeof(exports))?module.exports=t():e.returnExports=t()}(this,function(){var e,t=Function.call.bind(Function.apply),n=Function.call.bind(Function.call),r=Array.isArray,i=Object.keys,o=function(e){try{return e(),!1}catch(e){return!0}},a=function(e){try{return e()}catch(e){return!1}},s=function(e){return function(){return!t(e,this,arguments)}}(o),c=!!Object.defineProperty&&function(){return!o(function(){return Object.defineProperty({},"x",{get:function(){}})})}(),u="foo"===function(){}.name,l=Function.call.bind(Array.prototype.forEach),f=Function.call.bind(Array.prototype.reduce),p=Function.call.bind(Array.prototype.filter),d=Function.call.bind(Array.prototype.some),h=function(e,t,n,r){!r&&t in e||(c?Object.defineProperty(e,t,{configurable:!0,enumerable:!1,writable:!0,value:n}):e[t]=n)},g=function(e,t,n){l(i(t),function(r){var i=t[r];h(e,r,i,!!n)})},y=Function.call.bind(Object.prototype.toString),m="function"==typeof/abc/?function(e){return"function"==typeof e&&"[object Function]"===y(e)}:function(e){return"function"==typeof e},v={getter:function(e,t,n){if(!c)throw new TypeError("getters require true ES5 support");Object.defineProperty(e,t,{configurable:!0,enumerable:!1,get:n})},proxy:function(e,t,n){if(!c)throw new TypeError("getters require true ES5 support");var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,{configurable:r.configurable,enumerable:r.enumerable,get:function(){return e[t]},set:function(n){e[t]=n}})},redefine:function(e,t,n){if(c){var r=Object.getOwnPropertyDescriptor(e,t);r.value=n,Object.defineProperty(e,t,r)}else e[t]=n},defineByDescriptor:function(e,t,n){c?Object.defineProperty(e,t,n):"value"in n&&(e[t]=n.value)},preserveToString:function(e,t){t&&m(t.toString)&&h(e,"toString",t.toString.bind(t),!0)}},b=Object.create||function(e,t){var n=function(){};n.prototype=e;var r=new n;return void 0!==t&&i(t).forEach(function(e){v.defineByDescriptor(r,e,t[e])}),r},w=function(e,t){return!!Object.setPrototypeOf&&a(function(){var n=function t(n){var r=new e(n);return Object.setPrototypeOf(r,t.prototype),r};return Object.setPrototypeOf(n,e),n.prototype=b(e.prototype,{constructor:{value:n}}),t(n)})},x=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}(),T=x.isFinite,S=Function.call.bind(String.prototype.indexOf),k=Function.apply.bind(Array.prototype.indexOf),O=Function.call.bind(Array.prototype.concat),j=Function.call.bind(String.prototype.slice),A=Function.call.bind(Array.prototype.push),C=Function.apply.bind(Array.prototype.push),E=Function.call.bind(Array.prototype.shift),N=Math.max,_=Math.min,P=Math.floor,I=Math.abs,M=Math.exp,D=Math.log,L=Math.sqrt,R=Function.call.bind(Object.prototype.hasOwnProperty),q=function(){},F=x.Map,H=F&&F.prototype.delete,V=F&&F.prototype.get,$=F&&F.prototype.has,B=F&&F.prototype.set,W=x.Symbol||{},z=W.species||"@@species",U=Number.isNaN||function(e){return e!==e},G=Number.isFinite||function(e){return"number"==typeof e&&T(e)},J=m(Math.sign)?Math.sign:function(e){var t=Number(e);return 0===t?t:U(t)?t:t<0?-1:1},X=function(e){var t=Number(e);return t<-1||U(t)?NaN:0===t||t===1/0?t:-1===t?-1/0:1+t-1==0?t:t*(D(1+t)/(1+t-1))},Y=function(e){return"[object Arguments]"===y(e)},Z=function(e){return null!==e&&"object"===(void 0===e?"undefined":_typeof(e))&&"number"==typeof e.length&&e.length>=0&&"[object Array]"!==y(e)&&"[object Function]"===y(e.callee)},Q=Y(arguments)?Y:Z,K={primitive:function(e){return null===e||"function"!=typeof e&&"object"!==(void 0===e?"undefined":_typeof(e))},string:function(e){return"[object String]"===y(e)},regex:function(e){return"[object RegExp]"===y(e)},symbol:function(e){return"function"==typeof x.Symbol&&"symbol"===(void 0===e?"undefined":_typeof(e))}},ee=function(e,t,n){var r=e[t];h(e,t,n,!0),v.preserveToString(e[t],r)},te="function"==typeof W&&"function"==typeof W.for&&K.symbol(W()),ne=K.symbol(W.iterator)?W.iterator:"_es6-shim iterator_";x.Set&&"function"==typeof(new x.Set)["@@iterator"]&&(ne="@@iterator"),x.Reflect||h(x,"Reflect",{},!0);var re=x.Reflect,ie=String,oe="undefined"!=typeof document&&document?document.all:null,ae=null==oe?function(e){return null==e}:function(e){return null==e&&e!==oe},se={Call:function(e,n){var r=arguments.length>2?arguments[2]:[];if(!se.IsCallable(e))throw new TypeError(e+" is not a function");return t(e,n,r)},RequireObjectCoercible:function(e,t){if(ae(e))throw new TypeError(t||"Cannot call method on "+e);return e},TypeIsObject:function(e){return void 0!==e&&null!==e&&!0!==e&&!1!==e&&("function"==typeof e||"object"===(void 0===e?"undefined":_typeof(e))||e===oe)},ToObject:function(e,t){return Object(se.RequireObjectCoercible(e,t))},IsCallable:m,IsConstructor:function(e){return se.IsCallable(e)},ToInt32:function(e){return se.ToNumber(e)>>0},ToUint32:function(e){return se.ToNumber(e)>>>0},ToNumber:function(e){if("[object Symbol]"===y(e))throw new TypeError("Cannot convert a Symbol value to a number");return+e},ToInteger:function(e){var t=se.ToNumber(e);return U(t)?0:0!==t&&G(t)?(t>0?1:-1)*P(I(t)):t},ToLength:function(e){var t=se.ToInteger(e);return t<=0?0:t>Number.MAX_SAFE_INTEGER?Number.MAX_SAFE_INTEGER:t},SameValue:function(e,t){return e===t?0!==e||1/e==1/t:U(e)&&U(t)},SameValueZero:function(e,t){return e===t||U(e)&&U(t)},IsIterable:function(e){return se.TypeIsObject(e)&&(void 0!==e[ne]||Q(e))},GetIterator:function(t){if(Q(t))return new e(t,"value");var n=se.GetMethod(t,ne);if(!se.IsCallable(n))throw new TypeError("value is not an iterable");var r=se.Call(n,t);if(!se.TypeIsObject(r))throw new TypeError("bad iterator");return r},GetMethod:function(e,t){var n=se.ToObject(e)[t];if(!ae(n)){if(!se.IsCallable(n))throw new TypeError("Method not callable: "+t);return n}},IteratorComplete:function(e){return!!e.done},IteratorClose:function(e,t){var n=se.GetMethod(e,"return");if(void 0!==n){var r,i;try{r=se.Call(n,e)}catch(e){i=e}if(!t){if(i)throw i;if(!se.TypeIsObject(r))throw new TypeError("Iterator's return method returned a non-object.")}}},IteratorNext:function(e){var t=arguments.length>1?e.next(arguments[1]):e.next();if(!se.TypeIsObject(t))throw new TypeError("bad iterator");return t},IteratorStep:function(e){var t=se.IteratorNext(e);return!se.IteratorComplete(t)&&t},Construct:function(e,t,n,r){var i=void 0===n?e:n;if(!r&&re.construct)return re.construct(e,t,i);var o=i.prototype;se.TypeIsObject(o)||(o=Object.prototype);var a=b(o),s=se.Call(e,a,t);return se.TypeIsObject(s)?s:a},SpeciesConstructor:function(e,t){var n=e.constructor;if(void 0===n)return t;if(!se.TypeIsObject(n))throw new TypeError("Bad constructor");var r=n[z];if(ae(r))return t;if(!se.IsConstructor(r))throw new TypeError("Bad @@species");return r},CreateHTML:function(e,t,n,r){var i=se.ToString(e),o="<"+t;if(""!==n){o+=" "+n+'="'+se.ToString(r).replace(/"/g,"&quot;")+'"'}return o+">"+i+"</"+t+">"},IsRegExp:function(e){if(!se.TypeIsObject(e))return!1;var t=e[W.match];return void 0!==t?!!t:K.regex(e)},ToString:function(e){return ie(e)}};if(c&&te){var ce=function(e){if(K.symbol(W[e]))return W[e];var t=W.for("Symbol."+e);return Object.defineProperty(W,e,{configurable:!1,enumerable:!1,writable:!1,value:t}),t};if(!K.symbol(W.search)){var ue=ce("search"),le=String.prototype.search;h(RegExp.prototype,ue,function(e){return se.Call(le,e,[this])});var fe=function(e){var t=se.RequireObjectCoercible(this);if(!ae(e)){var n=se.GetMethod(e,ue);if(void 0!==n)return se.Call(n,e,[t])}return se.Call(le,t,[se.ToString(e)])};ee(String.prototype,"search",fe)}if(!K.symbol(W.replace)){var pe=ce("replace"),de=String.prototype.replace;h(RegExp.prototype,pe,function(e,t){return se.Call(de,e,[this,t])});var he=function(e,t){var n=se.RequireObjectCoercible(this);if(!ae(e)){var r=se.GetMethod(e,pe);if(void 0!==r)return se.Call(r,e,[n,t])}return se.Call(de,n,[se.ToString(e),t])};ee(String.prototype,"replace",he)}if(!K.symbol(W.split)){var ge=ce("split"),ye=String.prototype.split;h(RegExp.prototype,ge,function(e,t){return se.Call(ye,e,[this,t])});var me=function(e,t){var n=se.RequireObjectCoercible(this);if(!ae(e)){var r=se.GetMethod(e,ge);if(void 0!==r)return se.Call(r,e,[n,t])}return se.Call(ye,n,[se.ToString(e),t])};ee(String.prototype,"split",me)}var ve=K.symbol(W.match),be=ve&&function(){var e={};return e[W.match]=function(){return 42},42!=="a".match(e)}();if(!ve||be){var we=ce("match"),xe=String.prototype.match;h(RegExp.prototype,we,function(e){return se.Call(xe,e,[this])});var Te=function(e){var t=se.RequireObjectCoercible(this);if(!ae(e)){var n=se.GetMethod(e,we);if(void 0!==n)return se.Call(n,e,[t])}return se.Call(xe,t,[se.ToString(e)])};ee(String.prototype,"match",Te)}}var Se=function(e,t,n){v.preserveToString(t,e),Object.setPrototypeOf&&Object.setPrototypeOf(e,t),c?l(Object.getOwnPropertyNames(e),function(r){r in q||n[r]||v.proxy(e,r,t)}):l(Object.keys(e),function(r){r in q||n[r]||(t[r]=e[r])}),t.prototype=e.prototype,v.redefine(e.prototype,"constructor",t)},ke=function(){return this},Oe=function(e){c&&!R(e,z)&&v.getter(e,z,ke)},je=function(e,t){var n=t||function(){return this};h(e,ne,n),!e[ne]&&K.symbol(ne)&&(e[ne]=n)},Ae=function(e,t,n){c?Object.defineProperty(e,t,{configurable:!0,enumerable:!0,writable:!0,value:n}):e[t]=n},Ce=function(e,t,n){if(Ae(e,t,n),!se.SameValue(e[t],n))throw new TypeError("property is nonconfigurable")},Ee=function(e,t,n,r){if(!se.TypeIsObject(e))throw new TypeError("Constructor requires `new`: "+t.name);var i=t.prototype;se.TypeIsObject(i)||(i=n);var o=b(i);for(var a in r)if(R(r,a)){var s=r[a];h(o,a,s,!0)}return o};if(String.fromCodePoint&&1!==String.fromCodePoint.length){var Ne=String.fromCodePoint;ee(String,"fromCodePoint",function(e){return se.Call(Ne,this,arguments)})}var _e={fromCodePoint:function(e){for(var t,n=[],r=0,i=arguments.length;r<i;r++){if(t=Number(arguments[r]),!se.SameValue(t,se.ToInteger(t))||t<0||t>1114111)throw new RangeError("Invalid code point "+t);t<65536?A(n,String.fromCharCode(t)):(t-=65536,A(n,String.fromCharCode(55296+(t>>10))),A(n,String.fromCharCode(t%1024+56320)))}return n.join("")},raw:function(e){var t=se.ToObject(e,"bad callSite"),n=se.ToObject(t.raw,"bad raw value"),r=n.length,i=se.ToLength(r);if(i<=0)return"";for(var o,a,s,c,u=[],l=0;l<i&&(o=se.ToString(l),s=se.ToString(n[o]),A(u,s),!(l+1>=i));)a=l+1<arguments.length?arguments[l+1]:"",c=se.ToString(a),A(u,c),l+=1;return u.join("")}};String.raw&&"xy"!==String.raw({raw:{0:"x",1:"y",length:2}})&&ee(String,"raw",_e.raw),g(String,_e);var Pe=function e(t,n){if(n<1)return"";if(n%2)return e(t,n-1)+t;var r=e(t,n/2);return r+r},Ie={repeat:function(e){var t=se.ToString(se.RequireObjectCoercible(this)),n=se.ToInteger(e);if(n<0||n>=1/0)throw new RangeError("repeat count must be less than infinity and not overflow maximum string size");return Pe(t,n)},startsWith:function(e){var t=se.ToString(se.RequireObjectCoercible(this));if(se.IsRegExp(e))throw new TypeError('Cannot call method "startsWith" with a regex');var n,r=se.ToString(e);arguments.length>1&&(n=arguments[1]);var i=N(se.ToInteger(n),0);return j(t,i,i+r.length)===r},endsWith:function(e){var t=se.ToString(se.RequireObjectCoercible(this));if(se.IsRegExp(e))throw new TypeError('Cannot call method "endsWith" with a regex');var n,r=se.ToString(e),i=t.length;arguments.length>1&&(n=arguments[1]);var o=void 0===n?i:se.ToInteger(n),a=_(N(o,0),i);return j(t,a-r.length,a)===r},includes:function(e){if(se.IsRegExp(e))throw new TypeError('"includes" does not accept a RegExp');var t,n=se.ToString(e);return arguments.length>1&&(t=arguments[1]),-1!==S(this,n,t)},codePointAt:function(e){var t=se.ToString(se.RequireObjectCoercible(this)),n=se.ToInteger(e),r=t.length;if(n>=0&&n<r){var i=t.charCodeAt(n),o=n+1===r;if(i<55296||i>56319||o)return i;var a=t.charCodeAt(n+1);return a<56320||a>57343?i:1024*(i-55296)+(a-56320)+65536}}};if(String.prototype.includes&&!1!=="a".includes("a",1/0)&&ee(String.prototype,"includes",Ie.includes),String.prototype.startsWith&&String.prototype.endsWith){var Me=o(function(){return"/a/".startsWith(/a/)}),De=a(function(){return!1==="abc".startsWith("a",1/0)});Me&&De||(ee(String.prototype,"startsWith",Ie.startsWith),ee(String.prototype,"endsWith",Ie.endsWith))}if(te){a(function(){var e=/a/;return e[W.match]=!1,"/a/".startsWith(e)})||ee(String.prototype,"startsWith",Ie.startsWith);a(function(){var e=/a/;return e[W.match]=!1,"/a/".endsWith(e)})||ee(String.prototype,"endsWith",Ie.endsWith);a(function(){var e=/a/;return e[W.match]=!1,"/a/".includes(e)})||ee(String.prototype,"includes",Ie.includes)}g(String.prototype,Ie);var Le=["\t\n\v\f\r \xa0\u1680\u180e\u2000\u2001\u2002\u2003","\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028","\u2029\ufeff"].join(""),Re=new RegExp("(^["+Le+"]+)|(["+Le+"]+$)","g"),qe=function(){return se.ToString(se.RequireObjectCoercible(this)).replace(Re,"")},Fe=["\x85","\u200b","\ufffe"].join(""),He=new RegExp("["+Fe+"]","g"),Ve=/^[-+]0x[0-9a-f]+$/i,$e=Fe.trim().length!==Fe.length;h(String.prototype,"trim",qe,$e);var Be=function(e){return{value:e,done:0===arguments.length}},We=function(e){se.RequireObjectCoercible(e),this._s=se.ToString(e),this._i=0};We.prototype.next=function(){var e=this._s,t=this._i;if(void 0===e||t>=e.length)return this._s=void 0,Be();var n,r,i=e.charCodeAt(t);return i<55296||i>56319||t+1===e.length?r=1:(n=e.charCodeAt(t+1),r=n<56320||n>57343?1:2),this._i=t+r,Be(e.substr(t,r))},je(We.prototype),je(String.prototype,function(){return new We(this)});var ze={from:function(e){var t,r=this;arguments.length>1&&(t=arguments[1]);var i,o;if(void 0===t)i=!1;else{if(!se.IsCallable(t))throw new TypeError("Array.from: when provided, the second argument must be a function");arguments.length>2&&(o=arguments[2]),i=!0}var a,s,c,u=void 0!==(Q(e)||se.GetMethod(e,ne));if(u){s=se.IsConstructor(r)?Object(new r):[];var l,f,p=se.GetIterator(e);for(c=0;;){if(!1===(l=se.IteratorStep(p)))break;f=l.value;try{i&&(f=void 0===o?t(f,c):n(t,o,f,c)),s[c]=f}catch(e){throw se.IteratorClose(p,!0),e}c+=1}a=c}else{var d=se.ToObject(e);a=se.ToLength(d.length),s=se.IsConstructor(r)?Object(new r(a)):new Array(a);var h;for(c=0;c<a;++c)h=d[c],i&&(h=void 0===o?t(h,c):n(t,o,h,c)),Ce(s,c,h)}return s.length=a,s},of:function(){for(var e=arguments.length,t=this,n=r(t)||!se.IsCallable(t)?new Array(e):se.Construct(t,[e]),i=0;i<e;++i)Ce(n,i,arguments[i]);return n.length=e,n}};g(Array,ze),Oe(Array),e=function(e,t){this.i=0,this.array=e,this.kind=t},g(e.prototype,{next:function(){var t=this.i,n=this.array;if(!(this instanceof e))throw new TypeError("Not an ArrayIterator");if(void 0!==n)for(var r=se.ToLength(n.length);t<r;t++){var i,o=this.kind;return"key"===o?i=t:"value"===o?i=n[t]:"entry"===o&&(i=[t,n[t]]),this.i=t+1,Be(i)}return this.array=void 0,Be()}}),je(e.prototype),Array.of===ze.of||function(){var e=function(e){this.length=e};e.prototype=[];var t=Array.of.apply(e,[1,2]);return t instanceof e&&2===t.length}()||ee(Array,"of",ze.of);var Ue={copyWithin:function(e,t){var n,r=se.ToObject(this),i=se.ToLength(r.length),o=se.ToInteger(e),a=se.ToInteger(t),s=o<0?N(i+o,0):_(o,i),c=a<0?N(i+a,0):_(a,i);arguments.length>2&&(n=arguments[2]);var u=void 0===n?i:se.ToInteger(n),l=u<0?N(i+u,0):_(u,i),f=_(l-c,i-s),p=1;for(c<s&&s<c+f&&(p=-1,c+=f-1,s+=f-1);f>0;)c in r?r[s]=r[c]:delete r[s],c+=p,s+=p,f-=1;return r},fill:function(e){var t;arguments.length>1&&(t=arguments[1]);var n;arguments.length>2&&(n=arguments[2]);var r=se.ToObject(this),i=se.ToLength(r.length);t=se.ToInteger(void 0===t?0:t),n=se.ToInteger(void 0===n?i:n);for(var o=t<0?N(i+t,0):_(t,i),a=n<0?i+n:n,s=o;s<i&&s<a;++s)r[s]=e;return r},find:function(e){var t=se.ToObject(this),r=se.ToLength(t.length);if(!se.IsCallable(e))throw new TypeError("Array#find: predicate must be a function");for(var i,o=arguments.length>1?arguments[1]:null,a=0;a<r;a++)if(i=t[a],o){if(n(e,o,i,a,t))return i}else if(e(i,a,t))return i},findIndex:function(e){var t=se.ToObject(this),r=se.ToLength(t.length);if(!se.IsCallable(e))throw new TypeError("Array#findIndex: predicate must be a function");for(var i=arguments.length>1?arguments[1]:null,o=0;o<r;o++)if(i){if(n(e,i,t[o],o,t))return o}else if(e(t[o],o,t))return o;return-1},keys:function(){return new e(this,"key")},values:function(){return new e(this,"value")},entries:function(){return new e(this,"entry")}};if(Array.prototype.keys&&!se.IsCallable([1].keys().next)&&delete Array.prototype.keys,Array.prototype.entries&&!se.IsCallable([1].entries().next)&&delete Array.prototype.entries,Array.prototype.keys&&Array.prototype.entries&&!Array.prototype.values&&Array.prototype[ne]&&(g(Array.prototype,{values:Array.prototype[ne]}),K.symbol(W.unscopables)&&(Array.prototype[W.unscopables].values=!0)),u&&Array.prototype.values&&"values"!==Array.prototype.values.name){var Ge=Array.prototype.values;ee(Array.prototype,"values",function(){return se.Call(Ge,this,arguments)}),h(Array.prototype,ne,Array.prototype.values,!0)}g(Array.prototype,Ue),1/[!0].indexOf(!0,-0)<0&&h(Array.prototype,"indexOf",function(e){var t=k(this,arguments);return 0===t&&1/t<0?0:t},!0),je(Array.prototype,function(){return this.values()}),Object.getPrototypeOf&&je(Object.getPrototypeOf([].values()));var Je=function(){return a(function(){return 0===Array.from({length:-1}).length})}(),Xe=function(){var e=Array.from([0].entries());return 1===e.length&&r(e[0])&&0===e[0][0]&&0===e[0][1]}();if(Je&&Xe||ee(Array,"from",ze.from),!function(){return a(function(){return Array.from([0],void 0)})}()){var Ye=Array.from;ee(Array,"from",function(e){return arguments.length>1&&void 0!==arguments[1]?se.Call(Ye,this,arguments):n(Ye,this,e)})}var Ze=-(Math.pow(2,32)-1),Qe=function(e,t){var r={length:Ze};return r[t?(r.length>>>0)-1:0]=!0,a(function(){return n(e,r,function(){throw new RangeError("should not reach here")},[]),!0})};if(!Qe(Array.prototype.forEach)){var Ke=Array.prototype.forEach;ee(Array.prototype,"forEach",function(e){return se.Call(Ke,this.length>=0?this:[],arguments)})}if(!Qe(Array.prototype.map)){var et=Array.prototype.map;ee(Array.prototype,"map",function(e){return se.Call(et,this.length>=0?this:[],arguments)})}if(!Qe(Array.prototype.filter)){var tt=Array.prototype.filter;ee(Array.prototype,"filter",function(e){return se.Call(tt,this.length>=0?this:[],arguments)})}if(!Qe(Array.prototype.some)){var nt=Array.prototype.some;ee(Array.prototype,"some",function(e){return se.Call(nt,this.length>=0?this:[],arguments)})}if(!Qe(Array.prototype.every)){var rt=Array.prototype.every;ee(Array.prototype,"every",function(e){return se.Call(rt,this.length>=0?this:[],arguments)})}if(!Qe(Array.prototype.reduce)){var it=Array.prototype.reduce;ee(Array.prototype,"reduce",function(e){return se.Call(it,this.length>=0?this:[],arguments)})}if(!Qe(Array.prototype.reduceRight,!0)){var ot=Array.prototype.reduceRight;ee(Array.prototype,"reduceRight",function(e){return se.Call(ot,this.length>=0?this:[],arguments)})}var at=8!==Number("0o10"),st=2!==Number("0b10"),ct=d(Fe,function(e){return 0===Number(e+0+e)});if(at||st||ct){var ut=Number,lt=/^0b[01]+$/i,ft=/^0o[0-7]+$/i,pt=lt.test.bind(lt),dt=ft.test.bind(ft),ht=function(e){var t;if("function"==typeof e.valueOf&&(t=e.valueOf(),K.primitive(t)))return t;if("function"==typeof e.toString&&(t=e.toString(),K.primitive(t)))return t;throw new TypeError("No default value")},gt=He.test.bind(He),yt=Ve.test.bind(Ve),mt=function(){var e=function(t){var n;"string"==typeof(n=arguments.length>0?K.primitive(t)?t:ht(t):0)&&(n=se.Call(qe,n),pt(n)?n=parseInt(j(n,2),2):dt(n)?n=parseInt(j(n,2),8):(gt(n)||yt(n))&&(n=NaN));var r=this,i=a(function(){return ut.prototype.valueOf.call(r),!0});return r instanceof e&&!i?new ut(n):ut(n)};return e}();Se(ut,mt,{}),g(mt,{NaN:ut.NaN,MAX_VALUE:ut.MAX_VALUE,MIN_VALUE:ut.MIN_VALUE,NEGATIVE_INFINITY:ut.NEGATIVE_INFINITY,POSITIVE_INFINITY:ut.POSITIVE_INFINITY}),Number=mt,v.redefine(x,"Number",mt)}var vt=Math.pow(2,53)-1;g(Number,{MAX_SAFE_INTEGER:vt,MIN_SAFE_INTEGER:-vt,EPSILON:2.220446049250313e-16,parseInt:x.parseInt,parseFloat:x.parseFloat,isFinite:G,isInteger:function(e){return G(e)&&se.ToInteger(e)===e},isSafeInteger:function(e){return Number.isInteger(e)&&I(e)<=Number.MAX_SAFE_INTEGER},isNaN:U}),h(Number,"parseInt",x.parseInt,Number.parseInt!==x.parseInt),1===[,1].find(function(){return!0})&&ee(Array.prototype,"find",Ue.find),0!==[,1].findIndex(function(){return!0})&&ee(Array.prototype,"findIndex",Ue.findIndex);var bt=Function.bind.call(Function.bind,Object.prototype.propertyIsEnumerable),wt=function(e,t){c&&bt(e,t)&&Object.defineProperty(e,t,{enumerable:!1})},xt=function(){for(var e=Number(this),t=arguments.length,n=t-e,r=new Array(n<0?0:n),i=e;i<t;++i)r[i-e]=arguments[i];return r},Tt=function(e){return function(t,n){return t[n]=e[n],t}},St=function(e,t){var n,r=i(Object(t));return se.IsCallable(Object.getOwnPropertySymbols)&&(n=p(Object.getOwnPropertySymbols(Object(t)),bt(t))),f(O(r,n||[]),Tt(t),e)},kt={assign:function(e,t){var n=se.ToObject(e,"Cannot convert undefined or null to object");return f(se.Call(xt,1,arguments),St,n)},is:function(e,t){return se.SameValue(e,t)}};if(Object.assign&&Object.preventExtensions&&function(){var e=Object.preventExtensions({1:2});try{Object.assign(e,"xy")}catch(t){return"y"===e[1]}}()&&ee(Object,"assign",kt.assign),g(Object,kt),c){var Ot={setPrototypeOf:function(e,t){var r,i=function(e,t){if(!se.TypeIsObject(e))throw new TypeError("cannot set prototype on a non-object");if(null!==t&&!se.TypeIsObject(t))throw new TypeError("can only set prototype to an object or null"+t)},o=function(e,t){return i(e,t),n(r,e,t),e};try{r=e.getOwnPropertyDescriptor(e.prototype,"__proto__").set,n(r,{},null)}catch(t){if(e.prototype!=={}.__proto__)return;r=function(e){this.__proto__=e},o.polyfill=o(o({},null),e.prototype)instanceof e}return o}(Object)};g(Object,Ot)}if(Object.setPrototypeOf&&Object.getPrototypeOf&&null!==Object.getPrototypeOf(Object.setPrototypeOf({},null))&&null===Object.getPrototypeOf(Object.create(null))&&function(){var e=Object.create(null),t=Object.getPrototypeOf,n=Object.setPrototypeOf;Object.getPrototypeOf=function(n){var r=t(n);return r===e?null:r},Object.setPrototypeOf=function(t,r){return n(t,null===r?e:r)},Object.setPrototypeOf.polyfill=!1}(),!!o(function(){return Object.keys("foo")})){var jt=Object.keys;ee(Object,"keys",function(e){return jt(se.ToObject(e))}),i=Object.keys}if(o(function(){return Object.keys(/a/g)})){var At=Object.keys;ee(Object,"keys",function(e){if(K.regex(e)){var t=[];for(var n in e)R(e,n)&&A(t,n);return t}return At(e)}),i=Object.keys}if(Object.getOwnPropertyNames){if(!!o(function(){return Object.getOwnPropertyNames("foo")})){var Ct="object"===("undefined"==typeof window?"undefined":_typeof(window))?Object.getOwnPropertyNames(window):[],Et=Object.getOwnPropertyNames;ee(Object,"getOwnPropertyNames",function(e){var t=se.ToObject(e);if("[object Window]"===y(t))try{return Et(t)}catch(e){return O([],Ct)}return Et(t)})}}if(Object.getOwnPropertyDescriptor){if(!!o(function(){return Object.getOwnPropertyDescriptor("foo","bar")})){var Nt=Object.getOwnPropertyDescriptor;ee(Object,"getOwnPropertyDescriptor",function(e,t){return Nt(se.ToObject(e),t)})}}if(Object.seal){if(!!o(function(){return Object.seal("foo")})){var _t=Object.seal;ee(Object,"seal",function(e){return se.TypeIsObject(e)?_t(e):e})}}if(Object.isSealed){if(!!o(function(){return Object.isSealed("foo")})){var Pt=Object.isSealed;ee(Object,"isSealed",function(e){return!se.TypeIsObject(e)||Pt(e)})}}if(Object.freeze){if(!!o(function(){return Object.freeze("foo")})){var It=Object.freeze;ee(Object,"freeze",function(e){return se.TypeIsObject(e)?It(e):e})}}if(Object.isFrozen){if(!!o(function(){return Object.isFrozen("foo")})){var Mt=Object.isFrozen;ee(Object,"isFrozen",function(e){return!se.TypeIsObject(e)||Mt(e)})}}if(Object.preventExtensions){if(!!o(function(){return Object.preventExtensions("foo")})){var Dt=Object.preventExtensions;ee(Object,"preventExtensions",function(e){return se.TypeIsObject(e)?Dt(e):e})}}if(Object.isExtensible){if(!!o(function(){return Object.isExtensible("foo")})){var Lt=Object.isExtensible;ee(Object,"isExtensible",function(e){return!!se.TypeIsObject(e)&&Lt(e)})}}if(Object.getPrototypeOf){if(!!o(function(){return Object.getPrototypeOf("foo")})){var Rt=Object.getPrototypeOf;ee(Object,"getPrototypeOf",function(e){return Rt(se.ToObject(e))})}}var qt=c&&function(){var e=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags");return e&&se.IsCallable(e.get)}();if(c&&!qt){var Ft=function(){if(!se.TypeIsObject(this))throw new TypeError("Method called on incompatible type: must be an object.");var e="";return this.global&&(e+="g"),this.ignoreCase&&(e+="i"),this.multiline&&(e+="m"),this.unicode&&(e+="u"),this.sticky&&(e+="y"),e};v.getter(RegExp.prototype,"flags",Ft)}var Ht=c&&a(function(){return"/a/i"===String(new RegExp(/a/g,"i"))}),Vt=te&&c&&function(){var e=/./;return e[W.match]=!1,RegExp(e)===e}(),$t=a(function(){return"/abc/"===RegExp.prototype.toString.call({source:"abc"})}),Bt=$t&&a(function(){return"/a/b"===RegExp.prototype.toString.call({source:"a",flags:"b"})});if(!$t||!Bt){var Wt=RegExp.prototype.toString;h(RegExp.prototype,"toString",function(){var e=se.RequireObjectCoercible(this);return K.regex(e)?n(Wt,e):"/"+ie(e.source)+"/"+ie(e.flags)},!0),v.preserveToString(RegExp.prototype.toString,Wt)}if(c&&(!Ht||Vt)){var zt=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags").get,Ut=Object.getOwnPropertyDescriptor(RegExp.prototype,"source")||{},Gt=function(){return this.source},Jt=se.IsCallable(Ut.get)?Ut.get:Gt,Xt=RegExp,Yt=function(){return function e(t,n){var r=se.IsRegExp(t);if(!(this instanceof e)&&r&&void 0===n&&t.constructor===e)return t;var i=t,o=n;return K.regex(t)?(i=se.Call(Jt,t),o=void 0===n?se.Call(zt,t):n,new e(i,o)):(r&&(i=t.source,o=void 0===n?t.flags:n),new Xt(t,n))}}();Se(Xt,Yt,{$input:!0}),RegExp=Yt,v.redefine(x,"RegExp",Yt)}if(c){var Zt={input:"$_",lastMatch:"$&",lastParen:"$+",leftContext:"$`",rightContext:"$'"};l(i(Zt),function(e){e in RegExp&&!(Zt[e]in RegExp)&&v.getter(RegExp,Zt[e],function(){return RegExp[e]})})}Oe(RegExp);var Qt=1/Number.EPSILON,Kt=function(e){return e+Qt-Qt},en=Math.pow(2,-23),tn=Math.pow(2,127)*(2-en),nn=Math.pow(2,-126),rn=Math.E,on=Math.LOG2E,an=Math.LOG10E,sn=Number.prototype.clz;delete Number.prototype.clz;var cn={acosh:function(e){var t=Number(e);if(U(t)||e<1)return NaN;if(1===t)return 0;if(t===1/0)return t;var n=1/(t*t);if(t<2)return X(t-1+L(1-n)*t);var r=t/2;return X(r+L(1-n)*r-1)+1/on},asinh:function(e){var t=Number(e);if(0===t||!T(t))return t;var n=I(t),r=n*n,i=J(t);return n<1?i*X(n+r/(L(r+1)+1)):i*(X(n/2+L(1+1/r)*n/2-1)+1/on)},atanh:function(e){var t=Number(e);if(0===t)return t;if(-1===t)return-1/0;if(1===t)return 1/0;if(U(t)||t<-1||t>1)return NaN;var n=I(t);return J(t)*X(2*n/(1-n))/2},cbrt:function(e){var t=Number(e);if(0===t)return t;var n,r=t<0;return r&&(t=-t),t===1/0?n=1/0:(n=M(D(t)/3),n=(t/(n*n)+2*n)/3),r?-n:n},clz32:function(e){var t=Number(e),n=se.ToUint32(t);return 0===n?32:sn?se.Call(sn,n):31-P(D(n+.5)*on)},cosh:function(e){var t=Number(e);if(0===t)return 1;if(U(t))return NaN;if(!T(t))return 1/0;var n=M(I(t)-1);return(n+1/(n*rn*rn))*(rn/2)},expm1:function(e){var t=Number(e);if(t===-1/0)return-1;if(!T(t)||0===t)return t;if(I(t)>.5)return M(t)-1;for(var n=t,r=0,i=1;r+n!==r;)r+=n,i+=1,n*=t/i;return r},hypot:function(e,t){for(var n=0,r=0,i=0;i<arguments.length;++i){var o=I(Number(arguments[i]));r<o?(n*=r/o*(r/o),n+=1,r=o):n+=o>0?o/r*(o/r):o}return r===1/0?1/0:r*L(n)},log2:function(e){return D(e)*on},log10:function(e){return D(e)*an},log1p:X,sign:J,sinh:function(e){var t=Number(e);if(!T(t)||0===t)return t;var n=I(t);if(n<1){var r=Math.expm1(n);return J(t)*r*(1+1/(r+1))/2}var i=M(n-1);return J(t)*(i-1/(i*rn*rn))*(rn/2)},tanh:function(e){var t=Number(e);return U(t)||0===t?t:t>=20?1:t<=-20?-1:(Math.expm1(t)-Math.expm1(-t))/(M(t)+M(-t))},trunc:function(e){var t=Number(e);return t<0?-P(-t):P(t)},imul:function(e,t){var n=se.ToUint32(e),r=se.ToUint32(t),i=n>>>16&65535,o=65535&n,a=r>>>16&65535,s=65535&r;return o*s+(i*s+o*a<<16>>>0)|0},fround:function(e){var t=Number(e);if(0===t||t===1/0||t===-1/0||U(t))return t;var n=J(t),r=I(t);if(r<nn)return n*Kt(r/nn/en)*nn*en;var i=(1+en/Number.EPSILON)*r,o=i-(i-r);return o>tn||U(o)?n*(1/0):n*o}},un=function(e,t,n){return I(1-e/t)/Number.EPSILON<(n||8)};g(Math,cn),h(Math,"sinh",cn.sinh,Math.sinh(710)===1/0),h(Math,"cosh",cn.cosh,Math.cosh(710)===1/0),h(Math,"log1p",cn.log1p,-1e-17!==Math.log1p(-1e-17)),h(Math,"asinh",cn.asinh,Math.asinh(-1e7)!==-Math.asinh(1e7)),h(Math,"asinh",cn.asinh,Math.asinh(1e300)===1/0),h(Math,"atanh",cn.atanh,0===Math.atanh(1e-300)),h(Math,"tanh",cn.tanh,-2e-17!==Math.tanh(-2e-17)),h(Math,"acosh",cn.acosh,Math.acosh(Number.MAX_VALUE)===1/0),h(Math,"acosh",cn.acosh,!un(Math.acosh(1+Number.EPSILON),Math.sqrt(2*Number.EPSILON))),h(Math,"cbrt",cn.cbrt,!un(Math.cbrt(1e-300),1e-100)),h(Math,"sinh",cn.sinh,-2e-17!==Math.sinh(-2e-17));var ln=Math.expm1(10);h(Math,"expm1",cn.expm1,ln>22025.465794806718||ln<22025.465794806718);var fn=Math.round,pn=0===Math.round(.5-Number.EPSILON/4)&&1===Math.round(Number.EPSILON/3.99-.5),dn=Qt+1,hn=2*Qt-1,gn=[dn,hn].every(function(e){return Math.round(e)===e});h(Math,"round",function(e){var t=P(e),n=-1===t?-0:t+1;return e-t<.5?t:n},!pn||!gn),v.preserveToString(Math.round,fn);var yn=Math.imul;-5!==Math.imul(4294967295,5)&&(Math.imul=cn.imul,v.preserveToString(Math.imul,yn)),2!==Math.imul.length&&ee(Math,"imul",function(e,t){return se.Call(yn,Math,arguments)});var mn=function(){var e=x.setTimeout;if("function"==typeof e||"object"===(void 0===e?"undefined":_typeof(e))){se.IsPromise=function(e){return!!se.TypeIsObject(e)&&void 0!==e._promise};var t,r=function(e){if(!se.IsConstructor(e))throw new TypeError("Bad promise constructor");var t=this,n=function(e,n){if(void 0!==t.resolve||void 0!==t.reject)throw new TypeError("Bad Promise implementation!");t.resolve=e,t.reject=n};if(t.resolve=void 0,t.reject=void 0,t.promise=new e(n),!se.IsCallable(t.resolve)||!se.IsCallable(t.reject))throw new TypeError("Bad promise constructor")};"undefined"!=typeof window&&se.IsCallable(window.postMessage)&&(t=function(){var e=[],t=function(t){A(e,t),window.postMessage("zero-timeout-message","*")},n=function(t){if(t.source===window&&"zero-timeout-message"===t.data){if(t.stopPropagation(),0===e.length)return;E(e)()}};return window.addEventListener("message",n,!0),t});var i,o,a=se.IsCallable(x.setImmediate)?x.setImmediate:"object"===("undefined"==typeof process?"undefined":_typeof(process))&&process.nextTick?process.nextTick:function(){var e=x.Promise,t=e&&e.resolve&&e.resolve();return t&&function(e){return t.then(e)}}()||(se.IsCallable(t)?t():function(t){e(t,0)}),s=function(e){return e},c=function(e){throw e},u={},l=function(e,t,n){a(function(){f(e,t,n)})},f=function(e,t,n){var r,i;if(t===u)return e(n);try{r=e(n),i=t.resolve}catch(e){r=e,i=t.reject}i(r)},p=function(e,t){var n=e._promise,r=n.reactionLength;if(r>0&&(l(n.fulfillReactionHandler0,n.reactionCapability0,t),n.fulfillReactionHandler0=void 0,n.rejectReactions0=void 0,n.reactionCapability0=void 0,r>1))for(var i=1,o=0;i<r;i++,o+=3)l(n[o+0],n[o+2],t),e[o+0]=void 0,e[o+1]=void 0,e[o+2]=void 0;n.result=t,n.state=1,n.reactionLength=0},d=function(e,t){var n=e._promise,r=n.reactionLength;if(r>0&&(l(n.rejectReactionHandler0,n.reactionCapability0,t),n.fulfillReactionHandler0=void 0,n.rejectReactions0=void 0,n.reactionCapability0=void 0,r>1))for(var i=1,o=0;i<r;i++,o+=3)l(n[o+1],n[o+2],t),e[o+0]=void 0,e[o+1]=void 0,e[o+2]=void 0;n.result=t,n.state=2,n.reactionLength=0},h=function(e){var t=!1;return{resolve:function(n){var r;if(!t){if(t=!0,n===e)return d(e,new TypeError("Self resolution"));if(!se.TypeIsObject(n))return p(e,n);try{r=n.then}catch(t){return d(e,t)}if(!se.IsCallable(r))return p(e,n);a(function(){m(e,n,r)})}},reject:function(n){if(!t)return t=!0,d(e,n)}}
},y=function(e,t,r,i){e===o?n(e,t,r,i,u):n(e,t,r,i)},m=function(e,t,n){var r=h(e),i=r.resolve,o=r.reject;try{y(n,t,i,o)}catch(e){o(e)}},v=function(){var e=function(t){if(!(this instanceof e))throw new TypeError('Constructor Promise requires "new"');if(this&&this._promise)throw new TypeError("Bad construction");if(!se.IsCallable(t))throw new TypeError("not a valid resolver");var n=Ee(this,e,i,{_promise:{result:void 0,state:0,reactionLength:0,fulfillReactionHandler0:void 0,rejectReactionHandler0:void 0,reactionCapability0:void 0}}),r=h(n),o=r.reject;try{t(r.resolve,o)}catch(e){o(e)}return n};return e}();i=v.prototype;var b=function(e,t,n,r){var i=!1;return function(o){if(!i&&(i=!0,t[e]=o,0==--r.count)){(0,n.resolve)(t)}}},w=function(e,t,n){for(var r,i,o=e.iterator,a=[],s={count:1},c=0;;){try{if(!1===(r=se.IteratorStep(o))){e.done=!0;break}i=r.value}catch(t){throw e.done=!0,t}a[c]=void 0;var u=t.resolve(i),l=b(c,a,n,s);s.count+=1,y(u.then,u,l,n.reject),c+=1}if(0==--s.count){(0,n.resolve)(a)}return n.promise},T=function(e,t,n){for(var r,i,o,a=e.iterator;;){try{if(!1===(r=se.IteratorStep(a))){e.done=!0;break}i=r.value}catch(t){throw e.done=!0,t}o=t.resolve(i),y(o.then,o,n.resolve,n.reject)}return n.promise};return g(v,{all:function(e){var t=this;if(!se.TypeIsObject(t))throw new TypeError("Promise is not object");var n,i,o=new r(t);try{return n=se.GetIterator(e),i={iterator:n,done:!1},w(i,t,o)}catch(e){var a=e;if(i&&!i.done)try{se.IteratorClose(n,!0)}catch(e){a=e}var s=o.reject;return s(a),o.promise}},race:function(e){var t=this;if(!se.TypeIsObject(t))throw new TypeError("Promise is not object");var n,i,o=new r(t);try{return n=se.GetIterator(e),i={iterator:n,done:!1},T(i,t,o)}catch(e){var a=e;if(i&&!i.done)try{se.IteratorClose(n,!0)}catch(e){a=e}var s=o.reject;return s(a),o.promise}},reject:function(e){var t=this;if(!se.TypeIsObject(t))throw new TypeError("Bad promise constructor");var n=new r(t);return(0,n.reject)(e),n.promise},resolve:function(e){var t=this;if(!se.TypeIsObject(t))throw new TypeError("Bad promise constructor");if(se.IsPromise(e)){var n=e.constructor;if(n===t)return e}var i=new r(t);return(0,i.resolve)(e),i.promise}}),g(i,{catch:function(e){return this.then(null,e)},then:function(e,t){var n=this;if(!se.IsPromise(n))throw new TypeError("not a promise");var i,o=se.SpeciesConstructor(n,v);i=arguments.length>2&&arguments[2]===u&&o===v?u:new r(o);var a,f=se.IsCallable(e)?e:s,p=se.IsCallable(t)?t:c,d=n._promise;if(0===d.state){if(0===d.reactionLength)d.fulfillReactionHandler0=f,d.rejectReactionHandler0=p,d.reactionCapability0=i;else{var h=3*(d.reactionLength-1);d[h+0]=f,d[h+1]=p,d[h+2]=i}d.reactionLength+=1}else if(1===d.state)a=d.result,l(f,i,a);else{if(2!==d.state)throw new TypeError("unexpected Promise state");a=d.result,l(p,i,a)}return i.promise}}),u=new r(v),o=i.then,v}}();if(x.Promise&&(delete x.Promise.accept,delete x.Promise.defer,delete x.Promise.prototype.chain),"function"==typeof mn){g(x,{Promise:mn});var vn=w(x.Promise,function(e){return e.resolve(42).then(function(){})instanceof e}),bn=!o(function(){return x.Promise.reject(42).then(null,5).then(null,q)}),wn=o(function(){return x.Promise.call(3,q)}),xn=function(e){var t=e.resolve(5);t.constructor={};var n=e.resolve(t);try{n.then(null,q).then(null,q)}catch(e){return!0}return t===n}(x.Promise),Tn=c&&function(){var e=0,t=Object.defineProperty({},"then",{get:function(){e+=1}});return Promise.resolve(t),1===e}(),Sn=function e(t){var n=new Promise(t);t(3,function(){}),this.then=n.then,this.constructor=e};Sn.prototype=Promise.prototype,Sn.all=Promise.all;var kn=a(function(){return!!Sn.all([1,2])});if(vn&&bn&&wn&&!xn&&Tn&&!kn||(Promise=mn,ee(x,"Promise",mn)),1!==Promise.all.length){var On=Promise.all;ee(Promise,"all",function(e){return se.Call(On,this,arguments)})}if(1!==Promise.race.length){var jn=Promise.race;ee(Promise,"race",function(e){return se.Call(jn,this,arguments)})}if(1!==Promise.resolve.length){var An=Promise.resolve;ee(Promise,"resolve",function(e){return se.Call(An,this,arguments)})}if(1!==Promise.reject.length){var Cn=Promise.reject;ee(Promise,"reject",function(e){return se.Call(Cn,this,arguments)})}wt(Promise,"all"),wt(Promise,"race"),wt(Promise,"resolve"),wt(Promise,"reject"),Oe(Promise)}var En=function(e){var t=i(f(e,function(e,t){return e[t]=!0,e},{}));return e.join(":")===t.join(":")},Nn=En(["z","a","bb"]),_n=En(["z",1,"a","3",2]);if(c){var Pn=function(e,t){return t||Nn?ae(e)?"^"+se.ToString(e):"string"==typeof e?"$"+e:"number"==typeof e?_n?e:"n"+e:"boolean"==typeof e?"b"+e:null:null},In=function(){return Object.create?Object.create(null):{}},Mn=function(e,t,i){if(r(i)||K.string(i))l(i,function(e){if(!se.TypeIsObject(e))throw new TypeError("Iterator value "+e+" is not an entry object");t.set(e[0],e[1])});else if(i instanceof e)n(e.prototype.forEach,i,function(e,n){t.set(n,e)});else{var o,a;if(!ae(i)){if(a=t.set,!se.IsCallable(a))throw new TypeError("bad map");o=se.GetIterator(i)}if(void 0!==o)for(;;){var s=se.IteratorStep(o);if(!1===s)break;var c=s.value;try{if(!se.TypeIsObject(c))throw new TypeError("Iterator value "+c+" is not an entry object");n(a,t,c[0],c[1])}catch(e){throw se.IteratorClose(o,!0),e}}}},Dn=function(e,t,i){if(r(i)||K.string(i))l(i,function(e){t.add(e)});else if(i instanceof e)n(e.prototype.forEach,i,function(e){t.add(e)});else{var o,a;if(!ae(i)){if(a=t.add,!se.IsCallable(a))throw new TypeError("bad set");o=se.GetIterator(i)}if(void 0!==o)for(;;){var s=se.IteratorStep(o);if(!1===s)break;var c=s.value;try{n(a,t,c)}catch(e){throw se.IteratorClose(o,!0),e}}}},Ln={Map:function(){var e={},t=function(e,t){this.key=e,this.value=t,this.next=null,this.prev=null};t.prototype.isRemoved=function(){return this.key===e};var r=function(e){return!!e._es6map},i=function(e,t){if(!se.TypeIsObject(e)||!r(e))throw new TypeError("Method Map.prototype."+t+" called on incompatible receiver "+se.ToString(e))},o=function(e,t){i(e,"[[MapIterator]]"),this.head=e._head,this.i=this.head,this.kind=t};o.prototype={isMapIterator:!0,next:function(){if(!this.isMapIterator)throw new TypeError("Not a MapIterator");var e=this.i,t=this.kind,n=this.head;if(void 0===this.i)return Be();for(;e.isRemoved()&&e!==n;)e=e.prev;for(var r;e.next!==n;)if(e=e.next,!e.isRemoved())return r="key"===t?e.key:"value"===t?e.value:[e.key,e.value],this.i=e,Be(r);return this.i=void 0,Be()}},je(o.prototype);var a,s=function e(){if(!(this instanceof e))throw new TypeError('Constructor Map requires "new"');if(this&&this._es6map)throw new TypeError("Bad construction");var n=Ee(this,e,a,{_es6map:!0,_head:null,_map:F?new F:null,_size:0,_storage:In()}),r=new t(null,null);return r.next=r.prev=r,n._head=r,arguments.length>0&&Mn(e,n,arguments[0]),n};return a=s.prototype,v.getter(a,"size",function(){if(void 0===this._size)throw new TypeError("size method called on incompatible Map");return this._size}),g(a,{get:function(e){i(this,"get");var t,n=Pn(e,!0);if(null!==n)return t=this._storage[n],t?t.value:void 0;if(this._map)return t=V.call(this._map,e),t?t.value:void 0;for(var r=this._head,o=r;(o=o.next)!==r;)if(se.SameValueZero(o.key,e))return o.value},has:function(e){i(this,"has");var t=Pn(e,!0);if(null!==t)return void 0!==this._storage[t];if(this._map)return $.call(this._map,e);for(var n=this._head,r=n;(r=r.next)!==n;)if(se.SameValueZero(r.key,e))return!0;return!1},set:function(e,n){i(this,"set");var r,o=this._head,a=o,s=Pn(e,!0);if(null!==s){if(void 0!==this._storage[s])return this._storage[s].value=n,this;r=this._storage[s]=new t(e,n),a=o.prev}else this._map&&($.call(this._map,e)?V.call(this._map,e).value=n:(r=new t(e,n),B.call(this._map,e,r),a=o.prev));for(;(a=a.next)!==o;)if(se.SameValueZero(a.key,e))return a.value=n,this;return r=r||new t(e,n),se.SameValue(-0,e)&&(r.key=0),r.next=this._head,r.prev=this._head.prev,r.prev.next=r,r.next.prev=r,this._size+=1,this},delete:function(t){i(this,"delete");var n=this._head,r=n,o=Pn(t,!0);if(null!==o){if(void 0===this._storage[o])return!1;r=this._storage[o].prev,delete this._storage[o]}else if(this._map){if(!$.call(this._map,t))return!1;r=V.call(this._map,t).prev,H.call(this._map,t)}for(;(r=r.next)!==n;)if(se.SameValueZero(r.key,t))return r.key=e,r.value=e,r.prev.next=r.next,r.next.prev=r.prev,this._size-=1,!0;return!1},clear:function(){i(this,"clear"),this._map=F?new F:null,this._size=0,this._storage=In();for(var t=this._head,n=t,r=n.next;(n=r)!==t;)n.key=e,n.value=e,r=n.next,n.next=n.prev=t;t.next=t.prev=t},keys:function(){return i(this,"keys"),new o(this,"key")},values:function(){return i(this,"values"),new o(this,"value")},entries:function(){return i(this,"entries"),new o(this,"key+value")},forEach:function(e){i(this,"forEach");for(var t=arguments.length>1?arguments[1]:null,r=this.entries(),o=r.next();!o.done;o=r.next())t?n(e,t,o.value[1],o.value[0],this):e(o.value[1],o.value[0],this)}}),je(a,a.entries),s}(),Set:function(){var e,t=function(e){return e._es6set&&void 0!==e._storage},r=function(e,n){if(!se.TypeIsObject(e)||!t(e))throw new TypeError("Set.prototype."+n+" called on incompatible receiver "+se.ToString(e))},o=function t(){if(!(this instanceof t))throw new TypeError('Constructor Set requires "new"');if(this&&this._es6set)throw new TypeError("Bad construction");var n=Ee(this,t,e,{_es6set:!0,"[[SetData]]":null,_storage:In()});if(!n._es6set)throw new TypeError("bad set");return arguments.length>0&&Dn(t,n,arguments[0]),n};e=o.prototype;var a=function(e){var t=e;if("^null"===t)return null;if("^undefined"!==t){var n=t.charAt(0);return"$"===n?j(t,1):"n"===n?+j(t,1):"b"===n?"btrue"===t:+t}},s=function(e){if(!e["[[SetData]]"]){var t=new Ln.Map;e["[[SetData]]"]=t,l(i(e._storage),function(e){var n=a(e);t.set(n,n)}),e["[[SetData]]"]=t}e._storage=null};v.getter(o.prototype,"size",function(){return r(this,"size"),this._storage?i(this._storage).length:(s(this),this["[[SetData]]"].size)}),g(o.prototype,{has:function(e){r(this,"has");var t;return this._storage&&null!==(t=Pn(e))?!!this._storage[t]:(s(this),this["[[SetData]]"].has(e))},add:function(e){r(this,"add");var t;return this._storage&&null!==(t=Pn(e))?(this._storage[t]=!0,this):(s(this),this["[[SetData]]"].set(e,e),this)},delete:function(e){r(this,"delete");var t;if(this._storage&&null!==(t=Pn(e))){var n=R(this._storage,t);return delete this._storage[t]&&n}return s(this),this["[[SetData]]"].delete(e)},clear:function(){r(this,"clear"),this._storage&&(this._storage=In()),this["[[SetData]]"]&&this["[[SetData]]"].clear()},values:function(){return r(this,"values"),s(this),new c(this["[[SetData]]"].values())},entries:function(){return r(this,"entries"),s(this),new c(this["[[SetData]]"].entries())},forEach:function(e){r(this,"forEach");var t=arguments.length>1?arguments[1]:null,i=this;s(i),this["[[SetData]]"].forEach(function(r,o){t?n(e,t,o,o,i):e(o,o,i)})}}),h(o.prototype,"keys",o.prototype.values,!0),je(o.prototype,o.prototype.values);var c=function(e){this.it=e};return c.prototype={isSetIterator:!0,next:function(){if(!this.isSetIterator)throw new TypeError("Not a SetIterator");return this.it.next()}},je(c.prototype),o}()};if(x.Set&&!Set.prototype.delete&&Set.prototype.remove&&Set.prototype.items&&Set.prototype.map&&Array.isArray((new Set).keys)&&(x.Set=Ln.Set),x.Map||x.Set){a(function(){return 2===new Map([[1,2]]).get(1)})||(x.Map=function e(){if(!(this instanceof e))throw new TypeError('Constructor Map requires "new"');var t=new F;return arguments.length>0&&Mn(e,t,arguments[0]),delete t.constructor,Object.setPrototypeOf(t,x.Map.prototype),t},x.Map.prototype=b(F.prototype),h(x.Map.prototype,"constructor",x.Map,!0),v.preserveToString(x.Map,F));var Rn=new Map,qn=function(){var e=new Map([[1,0],[2,0],[3,0],[4,0]]);return e.set(-0,e),e.get(0)===e&&e.get(-0)===e&&e.has(0)&&e.has(-0)}(),Fn=Rn.set(1,2)===Rn;qn&&Fn||ee(Map.prototype,"set",function(e,t){return n(B,this,0===e?0:e,t),this}),qn||(g(Map.prototype,{get:function(e){return n(V,this,0===e?0:e)},has:function(e){return n($,this,0===e?0:e)}},!0),v.preserveToString(Map.prototype.get,V),v.preserveToString(Map.prototype.has,$));var Hn=new Set,Vn=Set.prototype.delete&&Set.prototype.add&&Set.prototype.has&&function(e){return e.delete(0),e.add(-0),!e.has(0)}(Hn),$n=Hn.add(1)===Hn;if(!Vn||!$n){var Bn=Set.prototype.add;Set.prototype.add=function(e){return n(Bn,this,0===e?0:e),this},v.preserveToString(Set.prototype.add,Bn)}if(!Vn){var Wn=Set.prototype.has;Set.prototype.has=function(e){return n(Wn,this,0===e?0:e)},v.preserveToString(Set.prototype.has,Wn);var zn=Set.prototype.delete;Set.prototype.delete=function(e){return n(zn,this,0===e?0:e)},v.preserveToString(Set.prototype.delete,zn)}var Un=w(x.Map,function(e){var t=new e([]);return t.set(42,42),t instanceof e}),Gn=Object.setPrototypeOf&&!Un,Jn=function(){try{return!(x.Map()instanceof x.Map)}catch(e){return e instanceof TypeError}}();0===x.Map.length&&!Gn&&Jn||(x.Map=function e(){if(!(this instanceof e))throw new TypeError('Constructor Map requires "new"');var t=new F;return arguments.length>0&&Mn(e,t,arguments[0]),delete t.constructor,Object.setPrototypeOf(t,e.prototype),t},x.Map.prototype=F.prototype,h(x.Map.prototype,"constructor",x.Map,!0),v.preserveToString(x.Map,F));var Xn=w(x.Set,function(e){var t=new e([]);return t.add(42,42),t instanceof e}),Yn=Object.setPrototypeOf&&!Xn,Zn=function(){try{return!(x.Set()instanceof x.Set)}catch(e){return e instanceof TypeError}}();if(0!==x.Set.length||Yn||!Zn){var Qn=x.Set;x.Set=function e(){if(!(this instanceof e))throw new TypeError('Constructor Set requires "new"');var t=new Qn;return arguments.length>0&&Dn(e,t,arguments[0]),delete t.constructor,Object.setPrototypeOf(t,e.prototype),t},x.Set.prototype=Qn.prototype,h(x.Set.prototype,"constructor",x.Set,!0),v.preserveToString(x.Set,Qn)}var Kn=new x.Map,er=!a(function(){return Kn.keys().next().done});if(("function"!=typeof x.Map.prototype.clear||0!==(new x.Set).size||0!==Kn.size||"function"!=typeof x.Map.prototype.keys||"function"!=typeof x.Set.prototype.keys||"function"!=typeof x.Map.prototype.forEach||"function"!=typeof x.Set.prototype.forEach||s(x.Map)||s(x.Set)||"function"!=typeof Kn.keys().next||er||!Un)&&g(x,{Map:Ln.Map,Set:Ln.Set},!0),x.Set.prototype.keys!==x.Set.prototype.values&&h(x.Set.prototype,"keys",x.Set.prototype.values,!0),je(Object.getPrototypeOf((new x.Map).keys())),je(Object.getPrototypeOf((new x.Set).keys())),u&&"has"!==x.Set.prototype.has.name){var tr=x.Set.prototype.has;ee(x.Set.prototype,"has",function(e){return n(tr,this,e)})}}g(x,Ln),Oe(x.Map),Oe(x.Set)}var nr=function(e){if(!se.TypeIsObject(e))throw new TypeError("target must be an object")},rr={apply:function(){return se.Call(se.Call,null,arguments)},construct:function(e,t){if(!se.IsConstructor(e))throw new TypeError("First argument must be a constructor.");var n=arguments.length>2?arguments[2]:e;if(!se.IsConstructor(n))throw new TypeError("new.target must be a constructor.");return se.Construct(e,t,n,"internal")},deleteProperty:function(e,t){if(nr(e),c){var n=Object.getOwnPropertyDescriptor(e,t);if(n&&!n.configurable)return!1}return delete e[t]},has:function(e,t){return nr(e),t in e}};Object.getOwnPropertyNames&&Object.assign(rr,{ownKeys:function(e){nr(e);var t=Object.getOwnPropertyNames(e);return se.IsCallable(Object.getOwnPropertySymbols)&&C(t,Object.getOwnPropertySymbols(e)),t}});var ir=function(e){return!o(e)};if(Object.preventExtensions&&Object.assign(rr,{isExtensible:function(e){return nr(e),Object.isExtensible(e)},preventExtensions:function(e){return nr(e),ir(function(){return Object.preventExtensions(e)})}}),c){var or=function(e,t,n){var r=Object.getOwnPropertyDescriptor(e,t);if(!r){var i=Object.getPrototypeOf(e);if(null===i)return;return or(i,t,n)}return"value"in r?r.value:r.get?se.Call(r.get,n):void 0},ar=function(e,t,r,i){var o=Object.getOwnPropertyDescriptor(e,t);if(!o){var a=Object.getPrototypeOf(e);if(null!==a)return ar(a,t,r,i);o={value:void 0,writable:!0,enumerable:!0,configurable:!0}}if("value"in o){if(!o.writable)return!1;if(!se.TypeIsObject(i))return!1;return Object.getOwnPropertyDescriptor(i,t)?re.defineProperty(i,t,{value:r}):re.defineProperty(i,t,{value:r,writable:!0,enumerable:!0,configurable:!0})}return!!o.set&&(n(o.set,i,r),!0)};Object.assign(rr,{defineProperty:function(e,t,n){return nr(e),ir(function(){return Object.defineProperty(e,t,n)})},getOwnPropertyDescriptor:function(e,t){return nr(e),Object.getOwnPropertyDescriptor(e,t)},get:function(e,t){nr(e);var n=arguments.length>2?arguments[2]:e;return or(e,t,n)},set:function(e,t,n){nr(e);var r=arguments.length>3?arguments[3]:e;return ar(e,t,n,r)}})}if(Object.getPrototypeOf){var sr=Object.getPrototypeOf;rr.getPrototypeOf=function(e){return nr(e),sr(e)}}if(Object.setPrototypeOf&&rr.getPrototypeOf){var cr=function(e,t){for(var n=t;n;){if(e===n)return!0;n=rr.getPrototypeOf(n)}return!1};Object.assign(rr,{setPrototypeOf:function(e,t){if(nr(e),null!==t&&!se.TypeIsObject(t))throw new TypeError("proto must be an object or null");return t===re.getPrototypeOf(e)||!(re.isExtensible&&!re.isExtensible(e))&&(!cr(e,t)&&(Object.setPrototypeOf(e,t),!0))}})}var ur=function(e,t){if(se.IsCallable(x.Reflect[e])){a(function(){return x.Reflect[e](1),x.Reflect[e](NaN),x.Reflect[e](!0),!0})&&ee(x.Reflect,e,t)}else h(x.Reflect,e,t)};Object.keys(rr).forEach(function(e){ur(e,rr[e])});var lr=x.Reflect.getPrototypeOf;if(u&&lr&&"getPrototypeOf"!==lr.name&&ee(x.Reflect,"getPrototypeOf",function(e){return n(lr,x.Reflect,e)}),x.Reflect.setPrototypeOf&&a(function(){return x.Reflect.setPrototypeOf(1,{}),!0})&&ee(x.Reflect,"setPrototypeOf",rr.setPrototypeOf),x.Reflect.defineProperty&&(a(function(){var e=!x.Reflect.defineProperty(1,"test",{value:1}),t="function"!=typeof Object.preventExtensions||!x.Reflect.defineProperty(Object.preventExtensions({}),"test",{});return e&&t})||ee(x.Reflect,"defineProperty",rr.defineProperty)),x.Reflect.construct&&(a(function(){var e=function(){};return x.Reflect.construct(function(){},[],e)instanceof e})||ee(x.Reflect,"construct",rr.construct)),"Invalid Date"!==String(new Date(NaN))){var fr=Date.prototype.toString,pr=function(){var e=+this;return e!==e?"Invalid Date":se.Call(fr,this)};ee(Date.prototype,"toString",pr)}var dr={anchor:function(e){return se.CreateHTML(this,"a","name",e)},big:function(){return se.CreateHTML(this,"big","","")},blink:function(){return se.CreateHTML(this,"blink","","")},bold:function(){return se.CreateHTML(this,"b","","")},fixed:function(){return se.CreateHTML(this,"tt","","")},fontcolor:function(e){return se.CreateHTML(this,"font","color",e)},fontsize:function(e){return se.CreateHTML(this,"font","size",e)},italics:function(){return se.CreateHTML(this,"i","","")},link:function(e){return se.CreateHTML(this,"a","href",e)},small:function(){return se.CreateHTML(this,"small","","")},strike:function(){return se.CreateHTML(this,"strike","","")},sub:function(){return se.CreateHTML(this,"sub","","")},sup:function(){return se.CreateHTML(this,"sup","","")}};l(Object.keys(dr),function(e){var t=String.prototype[e],r=!1;if(se.IsCallable(t)){var i=n(t,"",' " '),o=O([],i.match(/"/g)).length;r=i!==i.toLowerCase()||o>2}else r=!0;r&&ee(String.prototype,e,dr[e])});var hr=function(){if(!te)return!1;var e="object"===("undefined"==typeof JSON?"undefined":_typeof(JSON))&&"function"==typeof JSON.stringify?JSON.stringify:null;if(!e)return!1;if(void 0!==e(W()))return!0;if("[null]"!==e([W()]))return!0;var t={a:W()};return t[W()]=!0,"{}"!==e(t)}(),gr=a(function(){return!te||"{}"===JSON.stringify(Object(W()))&&"[{}]"===JSON.stringify([Object(W())])});if(hr||!gr){var yr=JSON.stringify;ee(JSON,"stringify",function(e){if("symbol"!==(void 0===e?"undefined":_typeof(e))){var t;arguments.length>1&&(t=arguments[1]);var i=[e];if(r(t))i.push(t);else{var o=se.IsCallable(t)?t:null,a=function(e,t){var r=o?n(o,this,e,t):t;if("symbol"!==(void 0===r?"undefined":_typeof(r)))return K.symbol(r)?Tt({})(r):r};i.push(a)}return arguments.length>2&&i.push(arguments[2]),yr.apply(this,i)}})}return x}),define("jqueryplugins",["jquery"],function(e){e.prototype.extend({popAttr:function(e){var t=this.attr(e);return this.removeAttr(e),t},popData:function(e){var t=this.data(e);return this.removeData(e),t},tag:function(){return this[0]&&this[0].tagName&&this[0].tagName.toLowerCase()},textNodes:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"*";return 1===this.length&&this[0]instanceof Text?[this[0]]:Array.from(this.add(this.contents().add(this.find(e).contents())).filter(function(){return this instanceof Text})).sort(function(e,t){return 2&e.compareDocumentPosition(t)?1:-1})},findAndFilter:function(e){return this.filter(e).add(this.find(e))}})}),function(){function e(){for(var e=0;e<arguments.length;e++)for(var t in arguments[e])this[t]=arguments[e][t]}function t(e,t){e.childAt=e.childAt||{};for(var n=t.start;n<t.end;n+=1)e.childAt[n]=t}function n(e,t,n,r){return!(e.canFollow&&!(e.canFollow.indexOf(n&&n.type)>-1)||e.cannotFollow&&(-1!==e.cannotFollow.indexOf(n&&n.type)||e.cannotFollow.indexOf("text")>-1&&r)||e.peek&&e.peek.toLowerCase()!==t.slice(0,e.peek.length).toLowerCase())}function r(e){for(var t=e.innerText,r=[],o=0,s=o,c=t.length,u=null;o<c;){for(var l=t.slice(o),f=(r.length?r[0]:e).innerMode,p=0,d=f.length;p<d;p+=1){var h=a[f[p]];if(n(h,l,u,s<o)&&h.pattern.test(l)){var g=h.pattern.exec(l),y=h.fn(g),m=!1,v=0;if(y.matches){for(;v<r.length;v+=1){var b=r[v].type;if(b in y.matches){m=!0;break}0===b.indexOf("verbatim")&&(b="verbatimOpener"),y.cannotCross&&y.cannotCross.indexOf(b)>-1&&(v=r.length-1)}if(v>=r.length&&!y.isFront)continue}s<o&&e.addChild({type:"text",text:t.slice(s,o),innerMode:f}),u=e.addChild(y),o+=u.text.length,s=o,m&&(i(e,u,r[v]),r=r.slice(v+1)),u.isFrontToken()&&r.unshift(u);break}}p===d&&(o+=1,null===u&&(u={type:"text"}))}for(s<o&&e.addChild({type:"text",text:t.slice(s,o),innerMode:(r.length?r[0]:e).innerMode});r.length>0;)r.shift().demote();return e}function i(e,n,r){var i=e.children.indexOf(n),o=e.children.indexOf(r);n.children=e.children.splice(o+1,i-(o+1)),n.children.forEach(function(e){t(n,e)}),n.type=n.matches[r.type],n.innerText="";for(var a=0,s=n.children.length;a<s;a++)n.innerText+=n.children[a].text;n.start=r.start,n.text=r.text+n.innerText+n.text,Object.keys(r).forEach(function(e){Object.hasOwnProperty.call(n,e)||(n[e]=r[e])}),n.isFront&&(n.isFront=!1),e.children.splice(o,1),t(e,n)}var o=void 0,a={};e.prototype={constructor:e,addChild:function(n){var i=this.lastChildEnd(),o=new e({start:i,end:n.text&&i+n.text.length,children:[]},n);return o.innerText&&r(o),this.children.push(o),t(this,o),o},firstChild:function(){return this.children?this.children[0]||null:null},lastChild:function(){return this.children?this.children[this.children.length-1]||null:null},lastChildEnd:function(){var e=this.lastChild();return e?e.end:this.start+Math.max(0,this.text.indexOf(this.innerText))},tokenAt:function(e){if(e<this.start||e>=this.end)return null;if(this.childAt)return this.childAt[e]&&this.childAt[e].tokenAt(e)||this;if(this.children.length)for(var t=0;t<this.children.length;t+=1){var n=this.children[t].tokenAt(e);if(n)return n}return this},pathAt:function(e){if(e<this.start||e>=this.end)return[];if(this.childAt)return(this.childAt[e]&&this.childAt[e].pathAt(e)||[]).concat(this);var t=[];if(this.children.length)for(var n=0;n<this.children.length;n+=1){var r=this.children[n].pathAt(e);if(r.length){t.concat(r);break}}return t.concat(this)},nearestTokenAt:function(e){return e<this.start||e>=this.end?null:this.children?this.children.reduce(function(t,n){return t||(e>=n.start&&e<n.end?n:null)},null):this},everyLeaf:function(e){return this.children&&0!==this.children.length?this.children.reduce(function(t,n){return n.everyLeaf(e)&&t},!0):!!e(this)},isWhitespace:function(){return this.everyLeaf(function(e){return"whitespace"===e.type||!e.text.trim()})},isFrontToken:function(){return this.isFront},isBackToken:function(){return"matches"in this},demote:function(){this.type="text"},error:function(e){this.type="error",this.message=e},toString:function(){var e=this.type+"("+this.start+"\u2192"+this.end+")";return this.children&&this.children.length>0&&(e+="["+this.children+"]"),e}},o={lex:function(t,n){return r(new e({type:"root",start:n||0,end:t.length,text:t,innerText:t,children:[],childAt:{},innerMode:o.modes.start}))},rules:a,modes:{}},"object"===("undefined"==typeof module?"undefined":_typeof(module))?module.exports=o:"function"==typeof define&&define.amd?define("lexer",[],function(){return o}):this&&this.loaded?(this.modules||(this.modules={}),this.modules.Lexer=o):this.TwineLexer=o}.call(eval("this")||("undefined"!=typeof global?global:window)),function(){function e(t){return t&&"object"===(void 0===t?"undefined":_typeof(t))?(Object.keys(t).forEach(function(n){t[n]=e(t[n])}),t):(t+"").replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}function t(e){return function(){return"("+e+Array.apply(0,arguments).join("|")+")"}}var n=void 0,r=t("?:"),i=t("?!"),o=t("?="),a="[ \\f\\t\\v\\u00a0\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000]*",s=a.replace("*","+"),c="\\b",u="[\\w\\-\\u00c0-\\u00de\\u00df-\\u00ff\\u0150\\u0170\\u0151\\u0171\\uD800-\\uDFFF]",l=u.replace("\\-",""),f=r("\\n","$"),p="("+r("\\\\\\n\\\\?|\\n\\\\","[^\\n]")+"+)",d=a+"(\\*+)"+s+p+f,h=a+"((?:0\\.)+)"+s+p+f,g=a+"-{3,}"+a+f,y=a+"(#{1,6})"+a+p+f,m=a+"(==+>|<=+|=+><=+|<==+>)"+a+f,v=a+"(=+\\|+|\\|+=+|=+\\|+=+|\\|=+\\|)"+a+f,b={opener:"\\[\\[(?!\\[)",text:"("+function(){return"[^"+Array.apply(0,arguments).map(e).join("")+"]*"}("]")+")",rightSeparator:r("\\->","\\|"),leftSeparator:"<\\-",closer:"\\]\\]",legacySeparator:"\\|",legacyText:"("+r("[^\\|\\]]","\\]"+i("\\]"))+"+)"},w=l+"*"+l.replace("\\w","a-zA-Z")+l+"*",x="\\$("+w+")",T="'s"+s+"("+w+")",S="("+w+")"+s+"of"+c+i("it\\b"),k="'s"+s,O=r("it","time","visits?","exits?")+c,j="its"+s+"("+w+")",A="its"+s,C="("+w+")"+s+"of"+s+"it"+c,E="of\\b"+s+"it"+c,N={opener:"\\(",name:"("+r(u+"+",x)+"):"+i("\\/"),closer:"\\)"},_=r("=<","=>","[gl]te?\\b","n?eq\\b","isnot\\b","are\\b","x\\b","isa\\b","or"+s+"a"+c),P={name:"[a-zA-Z][\\w\\-]*",attrs:"(?:\"[^\"]*\"|'[^']*'|[^'\">])*?"},I="\\|("+u+"+)(>|\\))",M="(<|\\()("+u+"+)\\|",D="_("+w+")"+c,L="\\b(\\d+(?:\\.\\d+)?(?:[eE][+\\-]?\\d+)?)"+i("m?s")+c;b.main=b.opener+r(b.text+b.rightSeparator,b.text.replace("*","*?")+b.leftSeparator)+b.text,n={upperLetter:"[A-Z\\u00c0-\\u00de\\u0150\\u0170]",lowerLetter:"[a-z0-9_\\-\\u00df-\\u00ff\\u0151\\u0171]",anyLetter:u,anyLetterStrict:l,whitespace:s,escapedLine:"\\\\\\n\\\\?|\\n\\\\",br:"\\n(?!\\\\)",commentFront:"\x3c!--",commentBack:"--\x3e",tag:"<\\/?"+P.name+P.attrs+">",tagPeek:"<",scriptStyleTag:"<("+r("script","style","textarea")+")"+P.attrs+">[^]*?<\\/\\1>",scriptStyleTagOpener:"<",url:"("+r("https?","mailto","javascript","ftp","data")+":\\/\\/[^\\s<]+[^<.,:;\"')\\]\\s])",bullet:"\\*",hr:g,heading:y,align:m,column:v,bulleted:d,numbered:h,strikeOpener:e("~~"),italicOpener:e("//"),boldOpener:e("''"),supOpener:e("^^"),strongFront:e("**"),strongBack:e("**"),emFront:e("*"),emBack:e("*"),verbatimOpener:"`+",collapsedFront:"{",collapsedBack:"}",hookAppendedFront:"\\["+i("=+"),hookPrependedFront:I+"\\["+i("=+"),hookFront:"\\["+i("=+"),hookBack:"\\]"+i(M),hookAppendedBack:"\\]"+M,unclosedHook:"\\[=+",unclosedHookPrepended:I+"\\[=+",passageLink:b.main+b.closer,passageLinkPeek:"[[",legacyLink:b.opener+b.legacyText+b.legacySeparator+b.legacyText+b.closer,legacyLinkPeek:"[[",simpleLink:b.opener+b.legacyText+b.closer,simpleLinkPeek:"[[",macroFront:N.opener+o(N.name),macroFrontPeek:"(",macroName:N.name,groupingFront:"\\("+i(N.name),groupingFrontPeek:"(",groupingBack:"\\)",twine1Macro:"<<[^>\\s]+\\s*(?:\\\\.|'(?:[^'\\\\]*\\\\.)*[^'\\\\]*'|\"(?:[^\"\\\\]*\\\\.)*[^\"\\\\]*\"|[^'\"\\\\>]|>(?!>))*>>",twine1MacroPeek:"<<",property:T,propertyPeek:"'s",belongingProperty:S,possessiveOperator:k,belongingOperator:"of\\b",belongingOperatorPeek:"of",itsOperator:A,itsOperatorPeek:"its",belongingItOperator:E,belongingItOperatorPeek:"of",variable:x,variablePeek:"$",tempVariable:D,tempVariablePeek:"_",hookRef:"\\?("+u+"+)\\b",hookRefPeek:"?",cssTime:"(\\d+\\.?\\d*|\\d*\\.?\\d+)(m?s)\\b",colour:r(r("Red","Orange","Yellow","Lime","Green","Cyan","Aqua","Blue","Navy","Purple","Fuchsia","Magenta","White","Gray","Grey","Black"),"#[\\dA-Fa-f]{3}(?:[\\dA-Fa-f]{3})?"),datatype:r("array","boolean","changer","colour","gradient","color","command","dm","datamap","ds","dataset","number","num","string","str"),number:L,boolean:r("true","false")+c,identifier:O,itsProperty:j,itsPropertyPeek:"its",belongingItProperty:C,escapedStringChar:"\\\\[^\\n]",singleStringOpener:"'",doubleStringOpener:'"',is:"is"+i(s+"not"+c,s+"an?"+c,s+"in"+c,s+"<",s+">")+c,isNot:"is"+s+"not"+i(s+"a"+c)+c,isA:"is"+s+"an?"+c,isNotA:"is"+s+"not"+s+"an?"+c,matches:"matches"+s,and:"and\\b",or:"or\\b",not:"not\\b",inequality:"((?:is(?:"+s+"not)?"+a+")*)("+r("<(?!=)","<=",">(?!=)",">=")+")",isIn:"is"+s+"in"+c,contains:"contains\\b",addition:e("+")+i("="),subtraction:e("-")+i("="),multiplication:e("*")+i("="),division:r("/","%")+i("="),comma:",",spread:"\\.\\.\\."+i("\\."),to:r("to\\b","="),into:"into\\b",making:"making\\b",where:"where\\b",when:"when\\b",via:"via\\b",with:"with\\b",each:"each\\b",augmentedAssign:r("\\+","\\-","\\*","\\/","%")+"=",bind:"bind\\b",incorrectOperator:_},"object"===("undefined"==typeof module?"undefined":_typeof(module))?module.exports=n:"function"==typeof define&&define.amd?define("patterns",[],function(){return n}):this&&this.loaded?(this.modules||(this.modules={}),this.modules.Patterns=n):this.Patterns=n}.call(eval("this")||("undefined"!=typeof global?global:window)),function(){function e(e){function t(e){return e=e||"innerText",function(t){var n=t.reduceRight(function(e,t,n){return e||(n?t:"")},""),r={};return r[e]=n,r}}function r(e,t){var n={};return n[e]=t,function(){return{isFront:!0,matches:n,cannotCross:["verbatimOpener"]}}}function i(e,t){return Object.keys(t).forEach(function(n){var r=t[n].fn;t[n].fn=function(t){var i=r(t);return i.text||(i.text=t[0]),i.type||(i.type=n),i.innerMode||(i.innerMode=e),i}}),t}var o=Object.bind(0,null),a=[],s=[],c=i(a,{hr:{fn:o},bulleted:{fn:function(e){return{depth:e[1].length,innerText:e[2]}}},numbered:{fn:function(e){return{depth:e[1].length/2,innerText:e[2]}}},heading:{fn:function(e){return{depth:e[1].length,innerText:e[2]}}},align:{fn:function(e){var t=void 0,n=e[1],r=n.indexOf("><");return~r?25===(t=Math.round(r/(n.length-2)*50))&&(t="center"):"<"===n[0]&&">"===n.slice(-1)?t="justify":n.indexOf(">")>-1?t="right":n.indexOf("<")>-1&&(t="left"),{align:t}}},column:{fn:function(e){var t=void 0,n=e[1],r=n.indexOf("|");return r&&r<n.length-1?t="center":"|"===n[0]&&"|"===n.slice(-1)?t="none":r===n.length-1?t="right":r||(t="left"),{column:t,width:/\|+/.exec(n)[0].length,marginLeft:/^=*/.exec(n)[0].length,marginRight:/=*$/.exec(n)[0].length}}}});Object.keys(c).forEach(function(e){c[e].canFollow=[null,"br","hr","bulleted","numbered","heading","align"],c[e].cannotFollow=["text"]});var u=i(a,{twine1Macro:{fn:function(){return{type:"error",message:"Harlowe macros use a different syntax to Twine 1 and SugarCube macros."}}},emBack:{fn:function(){return{matches:{emFront:"em"},cannotCross:["verbatimOpener"]}}},strongBack:{fn:function(){return{matches:{strongFront:"strong"},cannotCross:["verbatimOpener"]}}},strongFront:{fn:function(){return{isFront:!0}}},emFront:{fn:function(){return{isFront:!0}}},boldOpener:{fn:r("boldOpener","bold")},italicOpener:{fn:r("italicOpener","italic")},strikeOpener:{fn:r("strikeOpener","strike")},supOpener:{fn:r("supOpener","sup")},commentFront:{fn:function(){return{isFront:!0}}},commentBack:{fn:function(){return{matches:{commentFront:"comment"}}}},scriptStyleTag:{fn:o},tag:{fn:o},url:{fn:o},hookPrependedFront:{fn:function(e){return{name:e[1],hidden:")"===e[2],isFront:!0,tagPosition:"prepended"}}},hookFront:{fn:function(){return{isFront:!0}}},hookBack:{fn:function(){return{matches:{hookPrependedFront:"hook",hookFront:"hook"},cannotCross:["verbatimOpener"]}}},hookAppendedBack:{fn:function(e){return{name:e[2],hidden:"("===e[1],tagPosition:"appended",matches:{
hookFront:"hook"},cannotCross:["verbatimOpener"]}}},unclosedHook:{fn:o},unclosedHookPrepended:{fn:function(e){return{type:"unclosedHook",name:e[1],hidden:")"===e[2]}}},verbatimOpener:{fn:function(e){var t=e[0].length,n={};return n["verbatim"+t]="verbatim",{type:"verbatim"+t,isFront:!0,matches:n}}},collapsedFront:{fn:function(){return{isFront:!0}}},collapsedBack:{fn:function(){return{matches:{collapsedFront:"collapsed"},cannotCross:["verbatimOpener"]}}},escapedLine:{fn:o},legacyLink:{fn:function(e){return{type:"twineLink",innerText:e[1],passage:e[2]}}},br:{fn:o}}),l=i(s,{macroFront:{fn:function(e){return{isFront:!0,name:e[1]}}},groupingBack:{fn:function(){return{matches:{groupingFront:"grouping",macroFront:"macro"},cannotCross:["singleStringOpener","doubleStringOpener"]}}},passageLink:{fn:function(e){var t=e[1]||"",n=e[2]||"",r=e[3]||"";return{type:"twineLink",innerText:n?r:t,passage:t?r:n}}},simpleLink:{fn:function(e){return{type:"twineLink",innerText:e[1]||"",passage:e[1]||""}}},variable:{fn:t("name")},tempVariable:{fn:t("name")}}),f=i(s,Object.assign({macroName:{canFollow:["macroFront"],fn:function(e){return e[2]?{isMethodCall:!0,innerText:e[2]}:{isMethodCall:!1}}},groupingFront:{fn:function(){return{isFront:!0}}},property:{fn:t("name"),canFollow:["variable","hookRef","property","tempVariable","colour","itsProperty","belongingItProperty","macro","grouping","string","boolean","number"]},possessiveOperator:{fn:o},itsProperty:{cannotFollow:["text"],fn:t("name")},itsOperator:{cannotFollow:["text"],fn:o},belongingItProperty:{cannotFollow:["text"],fn:t("name")},belongingItOperator:{cannotFollow:["text"],fn:o},belongingProperty:{cannotFollow:["text"],fn:t("name")},belongingOperator:{cannotFollow:["text"],fn:o},escapedStringChar:{fn:function(){return{type:"text"}}},singleStringOpener:{fn:function(){return{isFront:!0,matches:{singleStringOpener:"string"}}}},doubleStringOpener:{fn:function(){return{isFront:!0,matches:{doubleStringOpener:"string"}}}},hookRef:{fn:t("name")},cssTime:{fn:function(e){return{value:+e[1]*("s"===e[2].toLowerCase()?1e3:1)}}},datatype:{cannotFollow:["text"],fn:function(e){return{name:e[0].toLowerCase()}}},colour:{cannotFollow:["text"],fn:function(e){var t,n=e[0].toLowerCase(),r={red:"e61919",orange:"e68019",yellow:"e5e619",lime:"80e619",green:"19e619",cyan:"19e5e6",aqua:"19e5e6",blue:"197fe6",navy:"1919e6",purple:"7f19e6",fuchsia:"e619e5",magenta:"e619e5",white:"fff",black:"000",gray:"888",grey:"888"};return t=Object.hasOwnProperty.call(r,n)?"#"+r[n]:n,{colour:t}}},number:{fn:function(e){return{value:parseFloat(e[0])}}},inequality:{fn:function(e){return{operator:e[2],negate:e[1].indexOf("not")>-1}}},augmentedAssign:{fn:function(e){return{operator:e[0][0]}}},identifier:{fn:t("name"),cannotFollow:["text"]},whitespace:{fn:o,cannotFollow:"text"},incorrectOperator:{fn:function(e){var t={"=>":">=","=<":"<=",gte:">=",lte:"<=",gt:">",lt:"<",eq:"is",isnot:"is not",neq:"is not",isa:"is a",are:"is",x:"*","or a":"or"}[e[0].toLowerCase().replace(/\s+/g," ")];return{type:"error",message:"Please say "+(t?"'"+t+"'":"something else")+" instead of '"+e[0]+"'.",explanation:"In the interests of readability, I want certain operators to be in a specific form."}},cannotFollow:"text"}},["boolean","is","to","into","where","when","via","with","making","each","and","or","not","isNot","contains","isIn","isA","isNotA","matches","bind"].reduce(function(e,t){return e[t]={fn:o,cannotFollow:["text"]},e},{}),["comma","spread","addition","subtraction","multiplication","division"].reduce(function(e,t){return e[t]={fn:o},e},{})));a.push.apply(a,_toConsumableArray(Object.keys(c)).concat(_toConsumableArray(Object.keys(l)),_toConsumableArray(Object.keys(u)))),s.push.apply(s,_toConsumableArray(Object.keys(l)).concat(_toConsumableArray(Object.keys(f))));var p=Object.assign({},c,u,l,f);return Object.keys(p).forEach(function(e){var t=n[e];p[e].pattern="string"!=typeof t?t:new RegExp("^(?:"+t+")","i"),n[e+"Peek"]&&(p[e].peek=n[e+"Peek"])}),Object.assign(e.rules,p),e.modes.start=e.modes.markup=a,e.modes.macro=s,e}function t(t){return Object.freeze({lex:e(t).lex,Patterns:n})}var n=void 0;Object.assign=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},"object"===("undefined"==typeof module?"undefined":_typeof(module))?(n=require("./patterns"),module.exports=t(require("./lexer"))):"function"==typeof define&&define.amd?define("markup",["lexer","patterns"],function(e,r){return n=r,t(e)}):this&&this.loaded&&this.modules?(n=this.modules.Patterns,this.modules.Markup=t(this.modules.Lexer)):(n=this.Patterns,this.TwineMarkup=t(this.TwineLexer))}.call(eval("this")||("undefined"!=typeof global?global:window)),define("utils/selectors",[],function(){return Object.freeze({passage:"tw-passage",story:"tw-story",sidebar:"tw-sidebar",internalLink:"tw-link",brokenLink:"tw-broken-link",hook:"tw-hook",enchantment:"tw-enchantment",expression:"tw-expression",script:"[role=script]",stylesheet:"[role=stylesheet]",storyData:"tw-storydata",passageData:"tw-passagedata",collapsed:"tw-collapsed",backdrop:"tw-backdrop",dialog:"tw-dialog",error:"tw-error"})}),define("utils/polyfills",[],function(){var e=Array.prototype;"function"!=typeof e.includes&&(e.includes=function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!Number.isNaN(t)&&Number.isFinite(n)&&void 0!==t)return e.indexOf.call(this,t,n)>-1;var r=Object(this),i=parseInt(r.length);if(i<=0)return!1;for(var o=n>=0?n:Math.max(0,i+n);o<i;){if(Object.is(t,r[o]))return!0;o+=1}return!1})}),define("utils",["jquery","markup","utils/selectors","utils/polyfills"],function(e,t,n){function r(t,n){var r=o[n];if(!r[t]){var i=e("<p>").appendTo(document.body).attr("data-t8n",t).addClass(n);r[t]=u.cssTimeUnit(i.css("animation-duration"))+u.cssTimeUnit(i.css("animation-delay")),i.remove()}return r[t]}var i={configurable:0,writable:0},o={"transition-in":Object.create(null),"transition-out":Object.create(null)},a="audio,blockquote,canvas,div,h1,h2,h3,h4,h5,hr,ol,p,pre,table,ul,video,tw-align,tw-story,tw-passage".split(","),s="a,b,i,em,strong,sup,sub,abbr,acronym,s,strike,del,big,small,script,img,button,input,tw-link,tw-broken-link,tw-verbatim,tw-collapsed,tw-error".split(","),c=["audio"],u=void 0,l=void 0,f=[];return u={lockProperty:function(e,t,n){var r=Object.create(i);return n&&(r.value=n),Object.defineProperty(e,t,r),e},permutations:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var r=t.length,i=[[].concat(t)],o=Array(r).fill(0),a=1,s=void 0,c=void 0;a<r;)o[a]<a?(s=a%2&&o[a],c=t[a],t[a]=t[s],t[s]=c,++o[a],a=1,i.push([].concat(t))):(o[a]=0,++a);return i},toJSLiteral:function(e){return e instanceof Map?"(new Map("+u.toJSLiteral([].concat(_toConsumableArray(e.entries())))+"))":e instanceof Set?"(new Set("+u.toJSLiteral([].concat(_toConsumableArray(e.values())))+"))":JSON.stringify(e)},cssTimeUnit:function(e){return e=e.toLowerCase(),"ms"===e.slice(-2)?+e.slice(0,-2)||0:"s"===e.slice(-1)?1e3*+e.slice(0,-1)||0:0},nth:function(e){var t=(+e+"").slice(-1);return e+("1"===t?"st":"2"===t?"nd":"3"===t?"rd":"th")},plural:function(e,t){return e+" "+t+(e>1?"s":"")},andList:function(e){return 1===e.length?e[0]:e.slice(0,-1).join(", ")+" and "+e[e.length-1]},realWhitespace:"[ \\n\\r\\f\\t\\v\\u00a0\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000]",anyRealLetter:"[\\dA-Za-z\\u00c0-\\u00de\\u00df-\\u00ff\\u0150\\u0170\\u0151\\u0171\\uD800-\\uDFFF]",unescape:function(e){return e.replace(/&(?:amp|lt|gt|quot|nbsp|zwnj|#39|#96);/g,function(e){return{"&amp;":"&","&gt;":">","&lt;":"<","&quot;":'"',"&#39;":"'","&nbsp;":String.fromCharCode(160),"&zwnj;":String.fromCharCode(8204)}[e]})},escape:function(e){return e.replace(/[&><"']/g,function(e){return{"&":"&amp;",">":"&gt;","<":"&lt;",'"':"&quot;","'":"&#39;"}[e]})},insensitiveName:function(e){return(e+"").toLowerCase().replace(/-|_/g,"")},childrenProbablyInline:function(e){var t=[];return Array.prototype.every.call(e.find("*"),function(e){return!(!e.hidden&&!/none|inline/.test(e.style.display))||!a.includes(e.tagName.toLowerCase())&&!/none|inline/.test(e.style.display)&&(!!s.includes(e.tagName.toLowerCase())||(t.push(e),!0))})&&t.every(function(e){return/none|inline/.test(e.style.display)})},transitionReplace:function(t,r,i){var o=t.closest(n.hook);o.length>0&&(t=o);var a=e("<tw-transition-container>").css("position","relative");a.insertBefore(t.first());var s=void 0;r&&(s=e("<tw-transition-container>").appendTo(a),r.appendTo(s));var c=e("<tw-transition-container>").css("position","absolute").prependTo(a);t.detach().appendTo(c),u.transitionOut(c,i),r&&u.transitionIn(s,i,function(){s.unwrap().children().first().unwrap()})},transitionOut:function(e,t,n){function i(){e.remove()}if(0!==e.length){var o=u.childrenProbablyInline(e);(e.length>1||!o||!["tw-hook","tw-passage"].includes(e.tag()))&&(e=e.wrapAll("<tw-transition-container>").parent()),e.attr("data-t8n",t).addClass("transition-out"),u.childrenProbablyInline(e)&&e.css("display","inline-block"),"number"==typeof n&&e.css("animation-duration",n+"ms");var a=n||r(t,"transition-out");a?window.setTimeout(i,a):i()}},transitionIn:function(e,t,n){function i(){var t=0===e.findAndFilter(c.join(",")).length;a&&t?e.contents().unwrap():e.removeClass("transition-in").removeAttr("data-t8n")}if(0!==e.length){var o=u.childrenProbablyInline(e),a=e.length>1||!o||!["tw-hook","tw-passage"].includes(e.tag());a&&(e=e.wrapAll("<tw-transition-container>").parent()),e.attr("data-t8n",t).addClass("transition-in"),"number"==typeof n&&e.css("animation-duration",n+"ms"),u.childrenProbablyInline(e)&&e.css("display","inline-block");var s=n||r(t,"transition-in");s?window.setTimeout(i,s):i()}},$:function(t,n){return e(t,n||u.storyElement).not(".transition-out, .transition-out *")},impossible:function(e,t){window.console&&console.error(e+"(): "+t)},assertMustHave:function(e,t){if(window.console)for(var n=0;n<t.length;n+=1)t[n]in e||console.error("Assertion failed: object lacks property "+t[n])},assertOnlyHas:function(e,t){if(window.console)for(var n in e)t.includes(n)||console.error("Assertion failed: object had unexpected property '"+n+"'!")},onStartup:function(e){f?f.push(e):e()},get storyElement(){return l}},e(function(){l=e(n.story),f.forEach(function(e){return e()}),f=null}),Object.freeze(u)}),define("utils/naturalsort",[],function(){return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:String;return function(n,r){var i,o,a,s,c=/(^-?[0-9]+(\.?[0-9]*)[df]?e?[0-9]?$|^0x[0-9a-f]+$|[0-9]+)/gi,u=/(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[\/\-]\d{1,4}[\/\-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,l=/^0x[0-9a-f]+$/i,f=/^0/,p=t(n).trim(),d=t(r).trim(),h=p.replace(c,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),g=d.replace(c,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),y=parseInt(p.match(l))||1!==h.length&&p.match(u)&&Date.parse(p),m=parseInt(d.match(l))||y&&d.match(u)&&Date.parse(d)||null;if(e&&window.Intl&&window.Intl.Collator&&(a=window.Intl.Collator(e)),m){if(y<m)return-1;if(y>m)return 1}for(var v=0,b=Math.max(h.length,g.length);v<b;v++){if(i=!(h[v]||"").match(f)&&parseFloat(h[v])||h[v]||0,o=!(g[v]||"").match(f)&&parseFloat(g[v])||g[v]||0,isNaN(i)!==isNaN(o))return isNaN(i)?1:-1;if((void 0===i?"undefined":_typeof(i))!==(void 0===o?"undefined":_typeof(o)))i+="",o+="";else if("string"==typeof i&&a&&0!==(s=a.compare(i,o)))return s;if(i<o)return-1;if(i>o)return 1}return 0}}}),define("passages",["jquery","utils/naturalsort","utils","utils/selectors"],function(e,t,n,r){function i(e){return Object.assign(new Map([["source",o(e.html())],["tags",(e.attr("tags")||"").split(/\s/)||[]],["name",e.attr("name")]]),{TwineScript_TypeName:"a passage datamap",TwineScript_ObjectName:"a passage datamap"})}var o=n.unescape,a=n.onStartup,s=Object.assign(new Map,{TwineScript_ObjectName:"the Passages datamap",getTagged:function(e){var n=t("en",function(e){return e.get("name")}),r=[];return this.forEach(function(t){var n=t instanceof Map&&t.get("tags");Array.isArray(n)&&n.includes(e)&&r.push(t)}),r.sort(n)},hasValid:function(e){var t=this.get(e);return t&&t instanceof Map&&t.has("source")},create:i});return a(function(){Array.from(e(r.storyData+" > "+r.passageData)).forEach(function(t){t=e(t),s.set(t.attr("name"),new i(t))})}),s}),define("datatypes/hookset",["jquery","utils","utils/selectors","markup"],function(e,t,n,r){function i(e){var t=[].concat(_toConsumableArray(e.textContent));return 1===t.length?[e]:t.reduce(function(e,t){return t.match(p)&&e[e.length-1].match(p)?e[e.length-1]+=t:e.push(t),e},[]).reduce(function(t,n){var r=e;return n.length<e.textContent.length&&(e=e.splitText(n.length)),t.concat(r)},[])}function o(e,t,n){var r=e.textContent.length;if(!(t>=r)){var i=void 0,o=[i=0===t?e:e.splitText(t)];return n&&(n<=0&&(n=r-n),n<r&&o.push(i.splitText(n-t))),o}}function a(e,t){var n=[],r="",i=[];if(!e.length||!t)return i;for(;e.length>0;){n.push(e[0]),r+=e[0].textContent,e.shift();var s=r.indexOf(t);if(s>-1){for(var c,u=r.length-(s+t.length);s>=n[0].textContent.length;)s-=n[0].textContent.length,n.shift();if(1===n.length){var l=o(n[0],s,s+t.length);i.push(l[0]),l[1]&&e.unshift(l[1]);break}i.push(o(n[0],s,n[0].length)[0]),(c=i).push.apply(c,_toConsumableArray(n.slice(1,-1)));var f=o(n[n.length-1],0,n[n.length-1].textContent.length-u);i.push(f[0]),f[1]&&e.unshift(f[1]),i=i.filter(Boolean);break}}return[i].concat(_toConsumableArray(a(e,t)))}function s(t,n){var r=a(n.textNodes(),t),i=e();return r.forEach(function(t){i=i.add(e(t).wrapAll("<tw-pseudo-hook>").parent())}),i}function c(e){e=t.insensitiveName(e).replace(/\?/g,"").replace(/"/g,"&quot;");var r=n.hook+'[name="'+e+'"]';return r+={page:", tw-story",passage:", tw-passage",sidebar:", tw-sidebar",link:", tw-link, .enchantment-link"}[e]||""}function u(n){var r=n.dom,o=e();this.prev&&(o=o.add(u.call(this.prev,{dom:r})));var a=function(t,n){if(Array.isArray(n))return n.reduce(function(e,n){return e.add(t.get(n))},e());if(n&&"object"===(void 0===n?"undefined":_typeof(n))&&"first"in n&&"last"in n){var r=n.first,o=n.last,a=t.length;r<0&&(r+=a),o<0&&(o+=a);for(var s=e(t.get(r));r!==o;)r+=Math.sign(o-r),s=s.add(t.get(r));return s}if("string"==typeof n){if("chars"===n){var c=e();return t.textNodes().forEach(function(e){return i(e).forEach(function(e){return c=c.add(e)})}),c}if("links"===n)return t.find("tw-link, .enchantment-link");if("lines"===n){var u=t.findAndFilter("br:not(tw-sidebar *)").get(),l=[e()],f=e();return t.textNodes(":not(tw-sidebar):not(tw-sidebar *)").forEach(function(t){2&t.compareDocumentPosition(u[0])&&(u.shift(),l.push(e())),l[l.length-1]=l[l.length-1].add(t)}),l.forEach(function(e){return f=f.add(e.wrapAll("<tw-pseudo-hook>").parent())}),f}}return e(t.get(n))};if(this.selector){var l=void 0;l=this.selector.match("^"+f.hookRef+"$")?r.add(r.parentsUntil(t.storyElement.parent())).findAndFilter(c(this.selector)):s(this.selector,r),o=this.properties.length?o.add(this.properties.reduce(a,l)):o.add(l)}return this.base&&(o=o.add(this.properties.reduce(a,u.call(this.base,{dom:r})))),o}function l(e){if(!e)return[];var n=e.selector,r=e.base,i=e.properties,o=e.prev;return[JSON.stringify([t.insensitiveName(n)||"",l(r),[].concat(_toConsumableArray(i)).sort()])].concat(_toConsumableArray(l(o))).sort()}var f=r.Patterns,p=new RegExp(t.realWhitespace+"+"),d=Object.freeze({forEach:function(t,n){var r=u.call(this,t).each(function(t){n(e(this),t)});return t.dom.findAndFilter("tw-pseudo-hook").contents().unwrap(),r},hooks:function(e){return u.call(this,e)},get TwineScript_ObjectName(){return this.properties.length>0||this.prev?"a complex hook name":this.selector+" (a hook name)"},TwineScript_TypeName:"a hook name (like ?this)",TwineScript_Unstorable:!0,"TwineScript_+":function(e){var t=e.TwineScript_Clone();return t.prev=this,t},TwineScript_is:function(e){return l(this)+""==l(e)+""},TwineScript_GetProperty:function(e){return d.create(void 0,this,[e],void 0)},TwineScript_Properties:["chars","links","lines"],TwineScript_Clone:function(){return d.create(this.selector,this.base,this.properties,this.prev)},create:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:void 0;return Object.assign(Object.create(this||d),{selector:e,base:t,properties:n,prev:r})},from:function(e){return d.isPrototypeOf(e)?e:d.create(e)}});return d}),define("internaltypes/twineerror",["jquery","utils"],function(e,t){var n=t.impossible,r=t.escape,i={syntax:"The markup seems to contain a mistake.",saving:"I tried to save or load the game, but I couldn't do it.",operation:"I tried to perform an operation on some data, but the data's type was incorrect.",macrocall:"I tried to use a macro, but its call wasn't written correctly.",datatype:"I tried to use a macro, but was given the wrong type of data to it.",infinite:"I almost ended up doing the same thing over and over, forever.",property:"I tried to access a value in a string/array/datamap, but I couldn't find it.",unimplemented:"I currently don't have this particular feature. I'm sorry.",javascript:"This error message was reported by your browser's Javascript engine. I don't understand it either, but it usually means that an expression was badly written."},o={error:[],warning:[]},a={create:function(e,t,r){return t||n("TwineError.create","called with only 1 string."),r||e in i||n("TwineError.create","no error explanation given"),Object.assign(Object.create(this),{type:e,message:t,explanation:r})},fromError:function(e){return a.create("javascript","\u2615 "+e.message)},containsError:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.reduce(function(e,t){return e||(t instanceof Error?t:a.isPrototypeOf(t)?t:!!Array.isArray(t)&&a.containsError.apply(a,_toConsumableArray(t)))},!1)},createWarning:function(e,t){return Object.assign(this.create(e,t),{warning:!0})},render:function(t){var n=this;t=t||"";var a=e("<tw-error class='"+("javascript"===this.type?"javascript ":"")+(this.warning?"warning":"error")+"' title='"+r(t)+"'>"+r(this.message)+"</tw-error>"),s=e("<tw-error-explanation>").text(this.explanation||i[this.type]).hide(),c=e("<tw-error-explanation-button tabindex=0>").html("<span class='folddown-arrowhead'>&#9658;</span>");return c.on("click",function(){s.toggle(),c.children(".folddown-arrowhead").css("transform","rotate("+(s.is(":visible")?"90deg":"0deg")+")")}),a.append(c).append(s),a.data("TwineError",this),o.error.forEach(function(e){return e(n,t)}),a},on:function(e,t){return e in o?("function"!=typeof t||o[e].includes(t)||o[e].push(t),a):void n("TwineError.on","invalid event name")}};return a}),define("utils/operationutils",["jquery","utils","datatypes/hookset","internaltypes/twineerror"],function(e,t,n,r){function i(e){return!!e&&("object"===(void 0===e?"undefined":_typeof(e))||"function"==typeof e)}function o(e){return Array.isArray(e)?"array":e instanceof Map?"datamap":e instanceof Set?"dataset":"string"==typeof e?"string":e&&"object"===(void 0===e?"undefined":_typeof(e))?"object":""}function a(e,t){if(e instanceof Map||b("isValidDatamapName","called with non-Map"),r.containsError(t))return t;if("string"!=typeof t&&"number"!=typeof t)return r.create("property","Only strings and numbers can be used as data names for "+l(e)+", not "+l(t)+".");var n="string"==typeof t?+t:""+t;return!(!Number.isNaN(n)&&e.has(n))||r.create("property","You mustn't use both "+l(t)+" and "+l(n)+" as data names in the same datamap.")}function s(e,t){if(null===t)return void 0===e;if(t.innerType){if("optional"===t.pattern||"zero or more"===t.pattern)return void 0===e||s(e,t.innerType);if("either"===t.pattern)return t.innerType.some(function(t){return s(e,t)});if("lambda"===t.pattern&&s(e,t.innerType))return"string"!=typeof t.clauses&&b("singleTypeCheck","lambda signature had non-string clauses"),t.clauses.includes("where")==="where"in e&&t.clauses.includes("making")==="making"in e&&t.clauses.includes("via")==="via"in e&&t.clauses.includes("with")==="with"in e;if("wrapped"===t.pattern)return s(e,t.innerType)}return(void 0===t||void 0!==e)&&("anything"===t.TwineScript_TypeName&&void 0!==e&&!e.TwineScript_Unstorable||(t===String?"string"==typeof e:t===Boolean?"boolean"==typeof e:t===parseInt?"number"==typeof e&&!Number.isNaN(e)&&!(e+"").includes("."):t===Number?"number"==typeof e&&!Number.isNaN(e):t===Array?Array.isArray(e):t===Map||t===Set?e instanceof t:Object.isPrototypeOf.call(t,e)))}function c(e){return"string"==typeof e||Array.isArray(e)||n.isPrototypeOf(e)}function u(e){if(!i(e))return e;if("function"==typeof e.TwineScript_Clone)return e.TwineScript_Clone();if(Array.isArray(e))return[].concat(_toConsumableArray(e));if(e instanceof Map)return new Map(e);if(e instanceof Set)return new Set(e);if("function"==typeof e)return Object.assign(e.bind(),e);switch(Object.getPrototypeOf(e)){case Object.prototype:return Object.assign({},e);case null:return Object.assign(Object.create(null),e)}return b("OperationUtils.clone","The value "+(e.toSource?e.toSource():e)+" cannot be cloned!"),e}function l(e){return i(e)&&"TwineScript_ObjectName"in e?e.TwineScript_ObjectName:Array.isArray(e)?"an array":e instanceof Map?"a datamap":e instanceof Set?"a dataset":"boolean"==typeof e?"the boolean value '"+e+"'":"string"==typeof e||"number"==typeof e?"the "+(void 0===e?"undefined":_typeof(e))+" "+x(e):void 0===e?"an empty variable":"...whatever this is"}function f(e){return Object.getPrototypeOf(e)===Object.prototype&&e.innerType?e.typeName?e.typeName:"either"===e.pattern?(Array.isArray(e.innerType)||b("typeName",'"either" pattern had non-array inner type'),e.innerType.map(f).join(" or ")):"optional"===e.pattern?"(optional) "+f(e.innerType):f(e.innerType):e===String||e===Number||e===Boolean?"a "+_typeof(e()):e===parseInt?"a whole number":e===Map?"a datamap":e===Set?"a dataset":e===Array?"an array":i(e)&&"TwineScript_TypeName"in e?e.TwineScript_TypeName:l(e)}function p(e,t){return"object"!==(void 0===e?"undefined":_typeof(e))&&"object"!==(void 0===t?"undefined":_typeof(t))?e===t:Array.isArray(e)&&Array.isArray(t)?e.length===t.length&&e.every(function(e,n){return p(t[n],e)}):e instanceof Map&&t instanceof Map?p(Array.from(e.entries()).sort(),Array.from(t.entries()).sort()):e instanceof Set&&t instanceof Set?p([].concat(_toConsumableArray(e)),[].concat(_toConsumableArray(t))):e&&"function"==typeof e.TwineScript_is?e.TwineScript_is(t):e&&"object"===(void 0===e?"undefined":_typeof(e))&&t&&"object"===(void 0===t?"undefined":_typeof(t))&&Object.getPrototypeOf(e)===Object.prototype&&Object.getPrototypeOf(t)===Object.prototype?p(Object.getOwnPropertyNames(e).map(function(t){return[t,e[t]]}),Object.getOwnPropertyNames(t).map(function(e){return[e,t[e]]})):Object.is(e,t)}function d(e,t){if(e||""===e){if("string"==typeof e)return e.includes(t);if(Array.isArray(e))return e.some(function(e){return p(e,t)});if(e instanceof Set||e instanceof Map)return Array.from(e.keys()).some(function(e){return p(e,t)})}return r.create("operation",l(e)+" cannot contain any values, let alone "+l(t))}function h(e,t){return"function"==typeof t.TwineScript_IsTypeOf?t.TwineScript_IsTypeOf(e):r.create("operation",'"is a" should only be used to compare type names, not '+l(t)+".")}function g(e,t){return e&&"function"==typeof e.TwineScript_IsTypeOf?e.TwineScript_IsTypeOf(t):t&&"function"==typeof t.TwineScript_IsTypeOf?t.TwineScript_IsTypeOf(e):Array.isArray(e)&&Array.isArray(t)?e.length===t.length&&e.every(function(e,n){return g(e,t[n])}):e instanceof Map&&t instanceof Map?g(Array.from(e.entries()).sort(),Array.from(t.entries()).sort()):e instanceof Set&&t instanceof Set?(e=[].concat(_toConsumableArray(e)),w.apply(void 0,_toConsumableArray(t)).some(function(t){return g(e,t)})):p(e,t)}function y(e,t,n){if(!t||!n)return r.create("macrocall","The sub"+o(e)+" index values must not be 0 or NaN.");var i="string"==typeof e;if(i&&(e=Array.from(e)),t<0&&(t=e.length+t+1),n<0&&(n=e.length+n+1),t>n)return y(arguments[0],n,t);var a=e.slice(t>0?t-1:t,n).map(u);return i?a.join(""):a}function m(t){return r.containsError(t)?t:t&&"function"==typeof t.TwineScript_Print?t.TwineScript_Print():t instanceof Map?(t=Array.from(t.entries()),r.containsError(t)?t:t.reduce(function(e,t){var n=_slicedToArray(t,2),r=n[0],i=n[1];return e+"<tr><td>`"+m(r)+"`</td><td>`"+m(i)+"`</td></tr>"},"<table class=datamap>")+"</table>"):t instanceof Set?Array.from(t.values()).map(m)+"":Array.isArray(t)?t.map(m)+"":t instanceof e?t:i(t)?r.create("unimplemented","I don't know how to print this value yet."):t+""}function v(e,t){if(e>t)return v(t,e);var n=[e];for(t-=e;t-- >0;)n.push(++e);return n}var b=t.impossible,w=t.permutations,x=t.toJSLiteral;return Object.freeze({isObject:i,singleTypeCheck:s,isValidDatamapName:a,collectionType:o,isSequential:c,clone:u,objectName:l,typeName:f,is:p,contains:d,isA:h,matches:g,subset:y,range:v,printBuiltinValue:m,numericIndex:/^(?:[1-9]\d*|0)$/,unique:function(e,t,n){return!n.slice(t+1).some(function(t){return p(e,t)})}})}),define("twinescript/compiler",["utils"],function(e){function t(e,t){for(var n=0;n<e.length;n+=1)if(t.includes(e[n].type))return n;return NaN}function n(e,n){return e.length-1-t.apply(void 0,[[].concat(_toConsumableArray(e)).reverse(),n])}function r(e,r){var i=[];return e.length?([["error"],["comma"],{rightAssociative:["spread","bind"]},["to"],["into"],["where","when","via"],["with","making","each"],["augmentedAssign"],["and","or"],["is","isNot"],["contains","isIn"],["isA","isNotA"],["matches"],["inequality"],["addition","subtraction"],["multiplication","division"],{rightAssociative:["not","positive","negative"]},{rightAssociative:["belongingProperty"]},{rightAssociative:["belongingOperator","belongingItOperator"]},["property"],["itsProperty"],{rightAssociative:["belongingItProperty"]},["possessiveOperator","itsOperator"],["twineLink"],["macro"],["grouping"]]["most"===r?"reverse":"valueOf"]().some(function(r){var o=void 0;if(o=r.rightAssociative?t(e,r.rightAssociative):n(e,r),!Number.isNaN(o)&&o>-1)return i=[e[o],o],!0}),i):i}function i(e){if("inequality"===e.type){var t=e.operator;return e.negate?{">":"<=","<":">=",">=":"<","<=":">"}[t]:t}return e.type}function o(e){var t=i(e);return{">":"<","<":">",">=":"<=","<=":">=",contains:"isIn",isIn:"contains",isA:"typifies",typifies:"isA",isNotA:"untypifies",untypifies:"isNotA"}[t]||t}function a(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.isVarRef,u=t.whitespaceError,l=t.elidedComparison,f=t.testNeedsRight;if(e=[].concat(e),!e.length)return n&&u?"TwineError.create('operation',"+s(u)+")":"";var p=e[0];if(1===e.length){if("identifier"===p.type)return n?"VarRef.create(Operations.Identifiers,"+s(p.text)+")":" Operations.Identifiers."+p.text.toLowerCase()+" ";if("variable"===p.type)return"VarRef.create(State.variables,"+s(p.name)+")"+(n?"":".get()");if("tempVariable"===p.type)return"VarRef.create(section.stack[0].tempVariables,"+s(p.name)+")"+(n?"":".get()");if("hookRef"===p.type)return" HookSet.create('?"+p.name+"') ";if("string"===p.type)return p.text.replace(/\n/g,"\\n");if("colour"===p.type)return"Colour.create("+s(p.colour)+")";if("datatype"===p.type)return"Datatype.create("+s(p.name)+")";if("blockedValue"===p.type)return"section.blockedValue()";if("root"===p.type)return a(p.children);if("whitespace"===p.type&&n&&u)return"TwineError.create('operation',"+s(u)+")"}var d=void 0,h=r(e,"least"),g=_slicedToArray(h,2);p=g[0],d=g[1];var y=(p||{}).type,m=function(e){return{isVarRef:!0,whitespaceError:"I need usable data to be on the "+e+' of "'+p.text+'".'}},v=void 0,b=void 0,w=void 0,x=void 0,T=void 0,S=void 0,k=!0,O=!0,j=!1;if(y){if("error"===y)return"TwineError.create('syntax',"+s(p.message)+")";if("comma"===y)w=",",O=!1;else if("spread"===y)w="Operations.makeSpreader(",b=a(e.slice(d+1))+")",k=!1;else if("bind"===y)w="VarBind.create(",b=a(e.slice(d+1),m("right"))+")",k=!1;else if("to"===y)T="to",b=a(e.slice(d+1),m("right")),v="Operations.setIt("+a(e.slice(0,d),m("left"))+")";else if("into"===y)T="into",b=a(e.slice(0,d),m("left")),v="Operations.setIt("+a(e.slice(d+1),m("right"))+")";else if("where"===y||"when"===y||"via"===y)v="Lambda.create("+(a(e.slice(0,d),{isVarRef:!0,whitespaceError:null}).trim()||"undefined")+",",w=s(p.type)+",",b=s(a(e.slice(d+1)))+")";else if("with"===y||"making"===y||"each"===y){var A=e.slice(d+1);![2,3].includes(A.length)||"whitespace"!==A[0].type||"tempVariable"!==A[1].type||A[2]&&"whitespace"!==A[2].type?(v="TwineError.create('operation','I need a temporary variable to the right of \\'",w=p.type,b="\\'.')"):"each"===y?(v="Lambda.create(",w=a(A,m("right")).trim(),b=",'where','true')"):(v="Lambda.create("+(a(e.slice(0,d),{isVarRef:!0,whitespaceError:null}).trim()||"undefined")+",",w=s(p.type)+",",b=s(A[1].name)+")")}else if("augmentedAssign"===y)T=p.operator,v=a(e.slice(0,d),m("left")),b="Operations['"+T+"']("+a(e.slice(0,d))+","+a(e.slice(d+1))+")";else if("and"===y||"or"===y){var C=function e(t){var n=r(t,"least"),i=_slicedToArray(n,2),o=i[0],a=i[1];if(o)return["inequality","is","isNot","isIn","contains","isA","typifies","isNotA","untypifies","matches"].includes(o.type)?o:["and","or"].includes(o.type)?e(t.slice(0,a))||e(t.slice(a+1)):void 0},E=C(e.slice(0,d)),N=C(e.slice(d+1)),_="TwineError.create('operation', 'This use of \"is not\" and \""+y+"\" is grammatically ambiguous','Maybe try rewriting this as \"__ is not __ "+y+" __ is not __\"') ";if(x=p.type,l===p.type)x="",v=a(e.slice(0,d),{isVarRef:n,elidedComparison:l}).trim(),w=",",b=a(e.slice(d+1),{elidedComparison:l}).trim();else if(E&&!N){var P=E,I=s(i(P));if("isNot"===P.type||"isNotA"===P.type||"untypifies"===P.type)return _;b="Operations.elidedComparisonOperator("+s(p.type)+","+I+","+a(e.slice(d+1),{elidedComparison:y})+")"}else if(!E&&N){var M=N,D=e.indexOf(M),L=s(o(M));if("isNot"===M.type||"isNotA"===M.type||"untypifies"===M.type)return _;b="Operations.elidedComparisonOperator("+s(p.type)+","+L+","+a(e.slice(0,d),{elidedComparison:y})+")",v=a([].concat(_toConsumableArray(e.slice(D+1)),[Object.assign(Object.create(M),_defineProperty({},"inequality"===M.type?"operator":"type",o(M)))],_toConsumableArray(e.slice(d+1,D))))}}else if("is"===y||"isNot"===y||"contains"===y||"isIn"===y||"inequality"===y||"isA"===y||"typifies"===y||"isNotA"===y||"untypifies"===y||"matches"===y)j=!0,x=i(p);else if("addition"===y||"subtraction"===y){var R=a(e.slice(0,d),{testNeedsRight:!0}).trim();if(!R)return p.type={addition:"positive",subtraction:"negative"}[y],a(e,{isVarRef:n,whitespaceError:u,elidedComparison:l,testNeedsRight:f});x=p.text}else if("multiplication"===y||"division"===y)x=p.text;else if("positive"===y||"negative"===y)x="*",v="negative"===y?"-1":"1";else if("not"===y)w=" ",b="Operations.not("+a(e.slice(d+1))+")",k=!1;else if("belongingProperty"===y)b="VarRef.create("+a(e.slice(d+1),m("right"))+","+s(p.name)+")"+(n?"":".get()"),w=" ",k=O=!1;else if("belongingOperator"===y||"belongingItOperator"===y)p.type.includes("It")?(b="Operations.Identifiers.it",O=!1):b=a(e.slice(d+1),m("right")),S="belonging";else if("property"===y)v="VarRef.create("+a(e.slice(0,d),m("left"))+","+s(p.name)+")"+(n?"":".get()"),w=" ",k=O=!1;else if("itsProperty"===y||"belongingItProperty"===y)v="VarRef.create(Operations.Identifiers.it,"+s(p.name)+").get()",w=" ",k=O=!1;else if("possessiveOperator"===y||"itsOperator"===y)p.type.includes("it")&&(v="Operations.Identifiers.it",k=!1),S="possessive";else if("twineLink"===y)w='Macros.run("link-goto", [section,'+s(p.innerText)+","+s(p.passage)+"])",k=O=!1;else if("macro"===y){var q=p.children[0];"macroName"!==q.type&&c("Compiler.compile","macro token had no macroName child token"),w="Macros.run("+(q.isMethodCall?a(q.children):'"'+p.name+'"')+", [section,"+a(p.children.slice(1))+"])",k=O=!1}else"grouping"===y&&(w="("+a(p.children,{isVarRef:n})+")",k=O=!1)}else;return d>-1?(x&&(n=!1),v=v||a(e.slice(0,d),{isVarRef:n
}).trim(),b=b||a(e.slice(d+1)).trim(),j&&!v&&(v=" Operations.Identifiers.it "),k&&!v||O&&!b?f&&O&&!b?"":"TwineError.create('operation','I need some code to be "+(k?"left ":"")+(k&&O?"and ":"")+(O?"right ":"")+'of "'+p.text+"\"')":w?v+w+b:T?"Operations.makeAssignmentRequest("+[v,b,s(T)]+")":S?"VarRef.create("+("belonging"===S?b:v)+",{computed:true,value:"+("belonging"===S?v:b)+"})"+(n?"":".get()"):x?" Operations["+s(x)+"]("+v+","+b+") ":""):1===e.length?(("value"in e[0]?e[0].value:e[0].text)+"").trim()||" ":e.reduce(function(e,t){return e+a(t,{isVarRef:n})},"")}var s=e.toJSLiteral,c=e.impossible;return a}),define("renderer",["utils","markup","twinescript/compiler","internaltypes/twineerror"],function(e,t,n,r){function i(e,t){return"<"+t+">"+e+"</"+t+">"}function o(e,t){var n=f.render(e.children);return n&&i(n,t)}function a(e){var t=[];if("string"!==e.type)for(var n=0;n<e.children.length;n+=1)t.push.apply(t,_toConsumableArray(a(e.children[n])));var r=e.firstChild();return"macro"===e.type&&r&&"macroName"===r.type&&f.options.blockerMacros.includes(l(r.text.slice(0,-1)))&&t.push(e),t}var s=e.escape,c=e.impossible,u=e.toJSLiteral,l=e.insensitiveName,f=void 0,p="text-align: center; max-width:50%; ";return f={options:{blockerMacros:[]},exec:function(){var e=void 0,n=void 0;return function(r){return"string"!=typeof r?(c("Renderer.exec","source was not a string, but "+(void 0===r?"undefined":_typeof(r))),""):r===e?n:(e=r,n=f.render(t.lex(r).children))}}(),render:function e(c){var d="",h=[];if(!c)return d;for(var g=c.length,y=0;y<g;y+=1){var m=c[y];switch(m.type){case"error":d+=r.create("syntax",m.message).render(s(m.text))[0].outerHTML;break;case"numbered":case"bulleted":var v="numbered"===m.type?"ol":"ul";d+="<"+v+">";for(var b=1;y<g&&c[y]&&c[y].type===m.type;)d+=("<"+v+">").repeat(Math.max(0,c[y].depth-b)),d+=("</"+v+">").repeat(Math.max(0,b-c[y].depth)),b=c[y].depth,d+=o(c[y],"li"),y+=1;y-=1,d+=("</"+v+">").repeat(b+1);break;case"align":for(;m&&"align"===m.type;){var w=m,x=w.align,T=y+=1;if("left"===x){y-=1;break}for(;y<g&&c[y]&&"align"!==c[y].type;)y+=1;var S=e(c.slice(T,y)),k="";switch(x){case"center":k+=p+"margin-left: auto; margin-right: auto;";break;case"justify":case"right":k+="text-align: "+x+";";break;default:+x&&(k+=p+"margin-left: "+x+"%;")}d+="<tw-align "+(k?'style="'+k+'"':"")+(f.options.debug?' title="'+m.text+'"':"")+">"+S+"</tw-align>\n",m=c[y]}break;case"column":for(var O=[];m&&"column"===m.type;){var j=m,A=j.column,C=y+=1;if("none"===A){y-=1;break}for(;y<g&&c[y]&&"column"!==c[y].type;)y+=1;O.push({text:m.text,type:A,body:e(c.slice(C,y)),width:m.width,marginLeft:m.marginLeft,marginRight:m.marginRight}),m=c[y]}O.length&&function(){var e=O.reduce(function(e,t){return e+t.width},0);d+="<tw-columns>"+O.map(function(t){return"<tw-column type="+t.type+'  style="width:'+t.width/e*100+"%; margin-left: "+t.marginLeft+"em; margin-right: "+t.marginRight+'em;" '+(f.options.debug?' title="'+t.text+'"':"")+">"+t.body+"</tw-column>\n"}).join("")+"</tw-columns>"}();break;case"heading":d+=o(m,"h"+m.depth);break;case"br":if(!h.length||/td|th/.test(h[0])){d+="<br>";for(var E=c[y+1];E&&("br"===E.type||"tag"===E.type&&/^<br\b/i.test(E.text));)d+="<br data-cons "+("tag"===E.type?"data-raw":"")+">",y+=1,E=c[y+1]}break;case"hr":d+="<hr>";break;case"escapedLine":case"comment":break;case"inlineUrl":d+='<a class="link" href="'+s(m.text)+'">'+m.text+"</a>";break;case"scriptStyleTag":case"tag":var N=m.text.toLowerCase();/^<\/?(?:table|thead|tbody|tr|tfoot|td|th)\b/.test(N)&&h[m.text.startsWith("</")?"shift":"unshift"](N),d+=m.text.startsWith("</")?m.text:m.text.replace(/>$/," data-raw>");break;case"sub":case"sup":case"strong":case"em":d+=o(m,m.type);break;case"strike":d+=o(m,"s");break;case"bold":d+=o(m,"b");break;case"italic":d+=o(m,"i");break;case"twineLink":var _=_slicedToArray(t.lex("(link-goto:"+u(m.innerText)+","+u(m.passage)+")").children,1),P=_[0];d+='<tw-expression type="macro" name="link-goto"'+(f.options.debug?' title="'+s(m.text)+'"':"")+' js="'+s(n(P))+'"></tw-expression>';break;case"hook":d+="<tw-hook "+(m.hidden?"hidden ":"")+(m.name?'name="'+l(m.name)+'"':"")+(f.options.debug&&m.name?' title="Hook: ?'+m.name+'"':"")+' source="'+s(m.innerText)+'"></tw-hook>';break;case"unclosedHook":return d+="<tw-hook "+(m.hidden?"hidden ":"")+(m.name?'name="'+l(m.name)+'"':"")+'source="'+s(c.slice(y+1,g).map(function(e){return e.text}).join(""))+'"></tw-hook>';case"verbatim":d+=i(s(m.innerText).replace(/\n/g,"<br>"),"tw-verbatim");break;case"collapsed":d+=o(m,"tw-collapsed");break;case"variable":case"tempVariable":case"macro":var I="macro"===m.type?a(m):[],M=I.map(function(e){var t=n(e);return e.type="blockedValue",t});d+='<tw-expression type="'+m.type+'" name="'+s(m.name||m.text)+'"'+(f.options.debug?' title="'+s(m.text)+'"':"")+(I.length?' blockers="'+s(JSON.stringify(M))+'"':"")+' js="'+s(n(m))+'"></tw-expression>',I.forEach(function(e){return e.type="macro"});break;default:d+=m.children&&m.children.length?e(m.children):m.text}}return d}},Object.freeze(f)}),define("internaltypes/changedescriptor",["jquery","utils","renderer","datatypes/hookset"],function(e,t,n,r){var i=t.assertOnlyHas,o=t.impossible,a=t.transitionIn,s=n.exec,c=void 0,u={source:"",innerSource:"",enabled:!0,target:null,append:"append",newTargets:null,transition:"instant",transitionTime:null,transitionDeferred:!1,loopVars:null,styles:null,attr:null,data:null,section:null,summary:function(){var e=this;return["source","innerSource","enabled","target","append","newTargets","transition","transitionTime"].filter(function(t){return e.hasOwnProperty(t)}).concat([this.attr.length&&"attr",this.styles.length&&"styles",Object.keys(this.loopVars).length&&"loopVars",Object.keys(this.data).length&&"data"].filter(Boolean))},create:function(e,t){var n=Object.assign(Object.create(this),{attr:[].concat(this.attr||[]),styles:[].concat(this.styles||[]),loopVars:this.loopVars||{},data:this.data||{}},e);return t&&t.run(n),n},update:function(){var e=this,t=this.section,n=this.newTargets,i=this.target,o=function(t){if(Array.isArray(e.styles)&&e.styles.length>0){var n=e.styles.reduce(function(e,t){return Object.keys(t).forEach(function(n){var r=t[n];e[+("function"==typeof r)][n]=r}),e},[{},{}]),r=_slicedToArray(n,2),i=r[0],o=r[1];t.css(i),setTimeout(function(){return t.css(o)})}e.attr&&e.attr.forEach(function(e){return t.attr(e)}),e.data&&t.data(e.data)};Array.isArray(n)&&n.length&&(i=n.map(function(e){return e.target})),[].concat(i).forEach(function(e){r.isPrototypeOf(e)?e.forEach(t,o):o(e)})},render:function(){var t=this,n=this.source,l=this.transition,f=this.transitionTime,p=this.transitionDeferred,d=this.enabled,h=this.data,g=this.section,y=this.newTargets,m=this.target,v=this.target,b=this.append;if(i(this,c),!d||void 0!==m.popAttr("hidden"))return u.create({target:m,data:Object.assign({},h,{hiddenSource:n})}).update(),e();if(Array.isArray(y)&&y.length&&(m=y),!m)return o("ChangeDescriptor.render","ChangeDescriptor has source but not a target!"),e();var w=e();if([].concat(m).filter(function(e){return!e.jquery}).map(function(e){var t=b,n=void 0;if(e.target&&e.append){var r=e;t=r.append,n=r.before,e=e.target}return{elements:e.hooks(g,v).filter(function(){return!(n&&1&this.compareDocumentPosition(document)&&2&this.compareDocumentPosition(v[0]))}),append:t}},[]).forEach(function(n){var r=n.elements,i=n.append;r.each(function(n,r){r=e(r),w=w.add(t.create({target:r,append:i,newTargets:null}).render()),r.filter("tw-pseudo-hook").contents().unwrap()})}),w.length||Array.isArray(m)||r.isPrototypeOf(m))return w;if(!(b in m)){if("replace"!==b)return o("Section.render","The target doesn't have a '"+b+"' method."),e();m[0]instanceof Text?b="replaceWith":(m.empty(),b="append")}return m[0]instanceof Text&&("append"===b&&(b="after"),"prepend"===b&&(b="before")),w=e(n&&e.parseHTML(s(n),document,!0)),m[b](w.length?w:void 0),this.update(),l&&!p&&a("replace"===b?m:w,l,f),w}};return c=Object.keys(u),Object.seal(u)}),define("datatypes/changercommand",["utils","utils/operationutils","internaltypes/changedescriptor","internaltypes/twineerror"],function(e,t,n,r){var i=e.impossible,o=t.is,a={},s={changer:!0,TwineScript_TypeName:"a changer command",TwineScript_Print:function(){return"`[A ('"+this.macroName+"':) command]`"},summary:function(){var e=n.create();return this.run(e),e.summary()},create:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return Array.isArray(t)||i("ChangerCommand.create","params was not an array"),Object.assign(Object.create(this),{macroName:e,params:t,next:n,TwineScript_ObjectName:"a ("+e+":) command"})},"TwineScript_+":function(e){for(var t=this.TwineScript_Clone(),n=t;n.next;)n=n.next;return n.next=e,t},TwineScript_is:function(e){if(s.isPrototypeOf(e))return this.macroName===e.macroName&&o(this.params,e.params)&&o(this.next,e.next)},TwineScript_Clone:function(){return this.create(this.macroName,this.params,this.next)},run:function(e){var t=a[this.macroName].apply(a,[e].concat(_toConsumableArray(this.params)));if(r.containsError(t))return t;this.next&&this.next.run(e)},register:function(e,t){a[e]=t}};return Object.freeze(s)}),define("state",["utils","passages","datatypes/changercommand","internaltypes/twineerror","utils/operationutils"],function(e,t,n,r,i){function o(){if(m.hasSessionStorage){var e=m.serialise();if("string"==typeof e)try{sessionStorage.setItem("Saved Session",e)}catch(e){return}}}function a(e){h=(p[d]||f).create(e),o()}var s=e.impossible,c=i.objectName,u=["localStorage","sessionStorage"].map(function(e){try{return!!window[e]&&function(){return window[e].setItem("test","1"),window[e].removeItem("test"),!0}()}catch(e){return!1}}),l={TwineScript_ObjectName:"this story's variables",TwineScript_VariableStore:!0},f={passage:"",variables:l,create:function(e,t){var n=Object.create(f);return n.passage=e||"",n.variables=Object.assign(Object.create(this.variables),t),n}},p=[],d=-1,h=f.create(),g=void 0,y={forward:[],back:[],load:[]},m=void 0;return m=Object.assign({get passage(){return h.passage},get variables(){return h.variables},get pastLength(){return d},get futureLength(){return p.length-1-d},passageNameVisited:function(e){var n=0;if(!t.get(e))return 0;for(var r=0;r<=d;r++)n+=+(e===p[r].passage);return n},passageNameLastVisited:function(e){if(!t.get(e))return 1/0;if(e===h.passage)return 0;for(var n=d;n>0;n--)if(p[n].passage===e)return d-n+1;return 1/0},pastPassageNames:function(){for(var e=[],t=d-1;t>=0;t--)e.unshift(p[t].passage);return e},play:function(e){h||s("State.play","present is undefined!"),h.passage=e,p=p.slice(0,d+1).concat(h),d+=1,a(e),y.forward.forEach(function(t){return t(e)})},rewind:function(e){var t=1,n=!1;if(e)if("string"==typeof e){if((t=this.passageNameLastVisited(e))===1/0)return}else"number"==typeof e&&(t=e);for(;t>0&&d>0;t--)n=!0,d-=1;return n&&(a(p[d].passage),y.back.forEach(function(e){return e()})),n},fastForward:function(e){var t=1,n=!1;for("number"==typeof e&&(t=e);t>0&&p.length>0;t--)n=!0,d+=1;return n&&(a(p[d].passage),y.forward.forEach(function(e){return e(p[d].passage,"fastForward")})),n},on:function(e,t){return e in y?("function"!=typeof t||y[e].includes(t)||y[e].push(t),m):void s("State.on","invalid event name")},reset:function(){window.jasmine&&(p=[],d=-1,h=f.create(),g=void 0,y.load.forEach(function(e){return e(p)}))},hasStorage:u[0],hasSessionStorage:u[1]},function(){function e(t){return"number"==typeof t||"boolean"==typeof t||"string"==typeof t||null===t||Array.isArray(t)&&t.every(e)||t instanceof Set&&Array.from(t).every(e)||t instanceof Map&&Array.from(t.values()).every(e)||n.isPrototypeOf(t)}function i(e,t){return t instanceof Set?{"(dataset:)":Array.from(t)}:t instanceof Map?{"(datamap:)":Array.from(t)}:n.isPrototypeOf(t)?{changer:{name:t.macroName,params:t.params,next:t.next}}:t}function o(e,t){if(t&&"object"===(void 0===t?"undefined":_typeof(t))){if(Array.isArray(t["(dataset:)"]))return new Set(t["(dataset:)"]);if(Array.isArray(t["(datamap:)"]))return new Map(t["(datamap:)"]);if(t.changer&&"object"===_typeof(t.changer)){var r=t.changer,i=r.name,o=r.params,a=r.next;return n.create(i,o,a)}}return t}function s(){var t=p.slice(0,d+1),n=t.map(function(t){return Object.keys(t.variables).filter(function(n){return t.variables[n]&&!e(t.variables[n])}).map(function(e){return[e,t.variables[e]]})});if(g||(g=n.reduce(function(e,t,n){var r=_slicedToArray(t,2),i=r[0],o=r[1];return e||i&&[i,o,n+1]},void 0)),g){var o=g,a=_slicedToArray(o,3),s=a[0],u=a[1],l=a[2];return r.create("saving","The variable $"+s+" holds "+c(u)+" (which is, or contains, a complex data value) on turn "+l+"; the game can no longer be saved.")}try{return JSON.stringify(t,i)}catch(e){return!1}}function u(e){var n=void 0,r=l,i="The save data is unintelligible.";try{n=JSON.parse(e,o)}catch(e){return Error(i)}if(!Array.isArray(n))return Error(i);var s=void 0;return(s=(n=n.map(function(e){return"object"===(void 0===e?"undefined":_typeof(e))&&e.hasOwnProperty("passage")&&e.hasOwnProperty("variables")?t.hasValid(e.passage)?(e.variables=Object.assign(Object.create(r),e.variables),r=e.variables,Object.assign(Object.create(f),e)):Error("The data refers to a passage named '"+e.passage+"', but it isn't in this story."):Error(i)})).find(function(e){return e instanceof Error}))?s:(p=n,y.load.forEach(function(e){return e(p)}),d=p.length-1,a(p[d].passage),!0)}return{serialise:s,deserialise:u}}()),Object.seal(f),Object.freeze(m)}),define("datatypes/colour",["jquery"],function(e){function t(t){if(t in s)return s[t];var n=e("<p>").css("background-color",t).css("background-color");return n=n.startsWith("rgb")?n.match(/\d+/g).reduce(function(e,t,n){return e["rgb"[n]]=+t,e},{}):{r:192,g:192,b:192},s[t]=n,n}function n(e){return"string"!=typeof e?e:(e=e.replace("#",""),e=e.replace(o,"$1$1$2$2$3$3"),{r:parseInt(e.slice(0,2),16),g:parseInt(e.slice(2,4),16),b:parseInt(e.slice(4,6),16)})}function r(e){var t=e.r,n=e.g,r=e.b,i=e.a;t/=255,n/=255,r/=255;var o=Math.max(t,n,r),a=Math.min(t,n,r),s=(o+a)/2,c=o-a;if(o===a)return{h:0,s:0,l:s};var u=void 0;switch(o){case t:u=(n-r)/c+(n<r?6:0);break;case n:u=(r-t)/c+2;break;case r:u=(t-n)/c+4}return u=Math.round(60*u),{h:u,s:s>.5?c/(2-o-a):c/(o+a),l:s,a:i}}function i(e){function t(e){return e<0&&(e+=1),e>1&&(e-=1),e<1/6?c+6*(s-c)*e:e<.5?s:e<2/3?c+(s-c)*(2/3-e)*6:c}var n=e.h,r=e.s,i=e.l,o=e.a;if(0===r){var a=Math.floor(255*i);return{r:a,g:a,b:a}}n/=360;var s=i<.5?i*(1+r):i+r-i*r,c=2*i-s;return{r:Math.floor(255*t(n+1/3)),g:Math.floor(255*t(n)),b:Math.floor(255*t(n-1/3)),a:o}}var o=/^([\da-fA-F])([\da-fA-F])([\da-fA-F])$/,a=/^([\da-fA-F])([\da-fA-F])([\da-fA-F])([\da-fA-F])([\da-fA-F])([\da-fA-F])$/,s=Object.create(null),c=Object.freeze({TwineScript_TypeName:"a colour",TwineScript_ObjectName:"a colour",TwineScript_DebugName:function(){return"a colour "+this.TwineScript_Print()},"TwineScript_+":function(e){var t=this,n=e;return c.create({r:Math.min(Math.round(.6*(t.r+n.r)),255),g:Math.min(Math.round(.6*(t.g+n.g)),255),b:Math.min(Math.round(.6*(t.b+n.b)),255),a:(t.a+n.a)/2})},TwineScript_Print:function(){return"<tw-colour style='background-color:rgba("+[this.r,this.g,this.b,this.a].join(",")+");'></span>"},TwineScript_is:function(e){return c.isPrototypeOf(e)&&e.r===this.r&&e.g===this.g&&e.b===this.b&&e.a===this.a},TwineScript_Clone:function(){return c.create(this)},toRGBAString:function(){return"rgba("+this.r+", "+this.g+", "+this.b+", "+this.a+")"},TwineScript_GetProperty:function(e){return"h"===e||"s"===e||"l"===e?r(this)[e]:"r"===e||"g"===e||"b"===e?this[e]:void 0},TwineScript_Properties:["h","s","l","r","g","b"],create:function(e){return"string"==typeof e?c.isHexString(e)?this.create(n(e)):this.create(t(e)):!("h"in e&&"s"in e&&"l"in e)||"r"in e||"g"in e||"b"in e?("a"in e&&"number"==typeof e.a||(e.a=1),Object.assign(Object.create(this),e)):this.create(i(e))},isHexString:function(e){return"string"==typeof e&&"#"===e[0]&&(e.slice(1).match(o)||e.slice(1).match(a))},isCSS3Function:function(e){return"string"==typeof e&&/^(?:rgb|hsl)a?\(\s*\d+\s*,\s*\d+%?\s*,\s*\d+%?(?:,\s*\d+(?:\.\d+)?\s*)?\)$/.test(e)}});return c}),define("datatypes/gradient",[],function(){var e=Object.freeze({TwineScript_TypeName:"a gradient",TwineScript_ObjectName:"a gradient",TwineScript_DebugName:function(){return"a gradient "+this.TwineScript_Print()},TwineScript_GetProperty:function(e){return"angle"===e?this.angle:"stops"===e?this.stops.map(function(e){return new Map([["percent",e.stop],["colour",e.colour.TwineScript_Clone()]])}):void 0},TwineScript_Properties:["angle","stops"],TwineScript_is:function(e){var t=this;return e.angle===this.angle&&e.stops.length===this.stops.length&&e.stops.every(function(e,n){var r=e.colour,i=e.stop;return t.stops[n].stop===i&&t.stops[n].colour.TwineScript_is(r)})},TwineScript_Clone:function(){return e.create(this.angle,[].concat(_toConsumableArray(this.stops)))},TwineScript_Print:function(){return"<tw-colour style='background:"+this.toLinearGradientString()+"'></tw-colour>"},create:function(e,t){return Object.assign(Object.create(this),{angle:e,stops:t.sort(function(e,t){return e.stop-t.stop})})},toLinearGradientString:function(){return"linear-gradient("+this.angle+"deg, "+this.stops.reduce(function(e,t){var n=t.colour,r=t.stop;return e+n.toRGBAString()+" "+100*r+"%,"},"").slice(0,-1)+")"}});return e}),define("internaltypes/varref",["state","internaltypes/twineerror","utils","utils/operationutils","datatypes/hookset","datatypes/colour","datatypes/gradient"],function(e,t,n,r,i,o,a){function s(e,n){var r=void 0;if(e instanceof Map&&(r=t.containsError(A(e,n))))return r;if(T(e)){var o=void 0,a="You can only access position strings/numbers ('4th', 'last', '2ndlast', (2), etc.) or slices ('1stTo2ndlast', '3rdTo5th'), ";if("number"==typeof n){if(0===n)return t.create("property","You can't access elements at position 0 of "+S(e)+".","Only positive and negative position values exist.");n>0&&(n-=1)}else if("string"==typeof n&&(o=/^(\d+)(?:st|[nr]d|th)last$/i.exec(n)))n=-o[1];else if("string"==typeof n&&(o=/^(\d+)(?:st|[nr]d|th)$/i.exec(n)))n=o[1]-1;else if("string"==typeof n&&(o=/^(?:(\d+)(?:st|[nr]d|th)(last)?|last)to(?:(\d+)(?:st|[nr]d|th)(last)?|last)$/i.exec(n))){var s=o,c=_slicedToArray(s,5),u=c[1],l=void 0===u?0:u,f=c[2],p=c[3],d=void 0===p?0:p,h=c[4];l=f?-l:l-1,d=h?-d:d-1,n={last:d,first:l}}else if("last"===n)n=-1;else{if(i.isPrototypeOf(e)&&!i.TwineScript_Properties.includes(n))return t.create("property",a+w(i.TwineScript_Properties.map(function(e){return"'"+e+"'"}))+" of "+S(e)+", not "+S(n)+".");if(!["length","any","all"].includes(n)&&!i.isPrototypeOf(e))return t.create("property",a+"'length', 'any' and 'all' of "+S(e)+", not "+S(n)+".")}}else if(e instanceof Set){if(!["length","any","all"].includes(n))return t.create("property","You can only get the 'length', 'any' and 'all' of "+S(e)+".","To check contained values, use the 'contains' operator.");"length"===n&&(n="size")}else{if(Array.isArray(e.TwineScript_Properties)&&!e.TwineScript_Properties.includes(n))return t.create("property","You can only get the "+w(e.TwineScript_Properties.map(function(e){return"'"+e+"'"}))+" of "+S(e)+", not "+S(n)+".");if("number"==typeof e||"boolean"==typeof e)return t.create("property","You can't get data values from "+S(e)+".")}return n}function c(e,n){return{compiledPropertyChain:n.reduce(function(r,i,o){i.computed&&(i=i.value),E.isPrototypeOf(i)&&(i=i.get()),i=Array.isArray(i)?i.map(function(t){return s(e,t)}):s(e,i);var a=void 0;return(a=t.containsError(r,i))?a:(o<n.length-1&&(e=m(e,i)),r.push(i),r)},[]),deepestObject:e}}function u(e,t){return t-0<0&&Math.abs(t)<=e.length?e.length+(t-0):t}function l(e,t){var n="'"+t+"' value"+("any"===t?"":"s")+" of ";return{determiner:t,array:[].concat(_toConsumableArray(e)),TwineScript_ObjectName:n+S(e),TwineScript_TypeName:n+"a data structure",TwineScript_Unstorable:!0,TwineScript_Print:function(){return"`["+this.TwineScript_TypeName+"]`"}}}function f(e,t){if(void 0===e)return e;if(e instanceof Map||e.varref)return e.get(t);if(T(e)&&Number.isFinite(t)&&(t=u(e,t)),"any"===t||"all"===t)return l(e,t);if(e.TwineScript_GetProperty)return e.TwineScript_GetProperty(t);var n=e[t];return"function"!=typeof n?n:void 0}function p(e){return e.computed?"string"==typeof e.value?"('"+e.value+"')":"("+e.value+")":"'"+e+"'"}function d(e,n){if(Array.isArray(n))return n.map(function(t){return d(e,t)});if(i.isPrototypeOf(e))return t.create("operation","I can't modify "+S(e),"You should alter hooks indirectly using macros like (replace:) or (enchant:).");if(e instanceof Set)return t.create("operation","I can't modify "+S(e),"You should use an (array:) if you need to modify the data inside this dataset.");if(o.isPrototypeOf(e)||a.isPrototypeOf(e))return t.create("operation","I can't modify the components of "+S(e)+".");if(e instanceof Map)return"string"==typeof n||t.create("operation",S(e)+" can only have string data names, not "+S(n)+".");if(T(e)){if(["length","any","all"].includes(n))return t.create("operation","I can't forcibly alter the '"+n+"' of "+S(e)+".");if(+n!=(0|n))return t.create("property",S(e)+" can only have position keys ('3rd', '1st', (5), etc.), not "+p(n)+".")}return e.TwineScript_Identifiers&&n in e?t.create("keyword","I can't alter the value of the '"+n+"' identifier.","You can only alter data in variables and hooks, not fixed identifiers."):"number"!=typeof e&&"boolean"!=typeof e||t.create("operation","You can't alter the data values of "+S(e)+".")}function h(e,t,n){var r=t;e instanceof Map?e.set(t,n):(T(e)&&(t=u(e,t)),e.TwineScript_Set?e.TwineScript_Set(t):e[t]=n),_.set.forEach(function(t){return t(e,r,n)})}function g(e,t){var n=t;T(e)&&(t=u(e,t)),Array.isArray(e)&&j.exec(t)?e.splice(t,1):e instanceof Map||e instanceof Set?e.delete(t):delete e[t],_.delete.forEach(function(t){return t(e,n)})}function y(e){function t(){return e}return{get:t,set:t,delete:t,varref:!0}}function m(n,r,o){if(r&&"object"===(void 0===r?"undefined":_typeof(r))&&"last"in r&&"first"in r){if(i.isPrototypeOf(n))return n.TwineScript_GetProperty(r);var a=r.first,s=r.last;return C(n,a+(a>=0),s+(s>=0))}if(Array.isArray(r))return i.isPrototypeOf(n)?n.TwineScript_GetProperty(r):r.map(function(e){return m(n,e,e)})["string"==typeof n?"join":"valueOf"]("");"string"==typeof n&&(n=[].concat(_toConsumableArray(n)));var c=f(n,r);return void 0===c?n===e.variables?N:n.TwineScript_VariableStore?t.create("property","There isn't a temp variable named _"+o+" in this place.","Temp variables only exist inside the same passage and hook in which they're (set:)."):t.create("property","I can't find a "+p(o)+" data name in "+S(n)):c}function v(e,n){var r=this,i=this.compiledPropertyChain.reduce(function(e,t){var n=void 0;return n=0===e.length?r.object:m.apply(void 0,_toConsumableArray(e[e.length-1])),e.push([n,t])&&e},[]).reduceRight(e,n);return t.containsError(i)?i:void 0}var b=n.impossible,w=n.andList,x=r.isObject,T=r.isSequential,S=r.objectName,k=r.typeName,O=r.clone,j=r.numericIndex,A=r.isValidDatamapName,C=r.subset,E=void 0,N=0,_={set:[],delete:[]};return E=Object.freeze({varref:!0,get:function(){return m(this.deepestObject,this.compiledPropertyChain.slice(-1)[0],this.propertyChain.slice(-1)[0])},set:function(e){return!this.object||this.object.TwineScript_VariableStore||this.object.TwineScript_Identifiers?v.call(this,function(e,n,r){var i=_slicedToArray(n,2),o=i[0],a=i[1],s=void 0;if(s=t.containsError(e,o,a)||t.containsError(d(o,a)))return s;if(e&&e.TwineScript_Unstorable)return t.create("operation",k(e)+" can't be stored.");if(r>0&&(o=O(o)),"string"==typeof o){if("string"!=typeof e||e.length!==(Array.isArray(a)?a.length:1))return t.create("datatype","I can't put this non-string value, "+S(e)+", in a string.");o=[].concat(_toConsumableArray(o));var c=[].concat(_toConsumableArray(e));[].concat(a).forEach(function(e){0+e<0&&(e=o.length+(0+e)),o=[].concat(_toConsumableArray(o.slice(0,e)),[c.shift()],_toConsumableArray(o.slice(e+1)))}),o=o.join("")}else x(o)&&(Array.isArray(a)&&T(e)?("string"==typeof e&&(e=[].concat(_toConsumableArray(e))),a.map(function(t,n){return[t,e[n]]}).forEach(function(e){var t=_slicedToArray(e,2),n=t[0],r=t[1];return h(o,n,r)})):h(o,a,e));return o},e):t.create("macrocall","I can't (set:) "+S(this)+", if the "+(S(this.object).match(/ (.+$)/)||["","value"])[1]+" isn't stored in a variable.","Modifying data structures that aren't in variables won't change the game state at all.")},delete:function(){return v.call(this,function(e,n,r){var i=_slicedToArray(n,2),o=i[0],a=i[1],s=void 0;if(s=t.containsError(e,o,a)||t.containsError(d(o,a)))return s;if(r>0&&(o=O(o)),null===e){var c="string"==typeof o;c&&(o=[].concat(_toConsumableArray(o))),Array.isArray(a)?(T(o)&&(a=[].concat(_toConsumableArray(new Set(a))),a.sort(function(e,t){return u(o,t)-u(o,e)})),a.forEach(function(e){return g(o,e)})):g(o,a),c&&(o=o.join(""))}else h(o,a,e);return o},null)},create:function(e,n){var r=void 0;if(r=t.containsError(e))return y(r);n=[].concat(n),E.isPrototypeOf(e)&&(n=e.propertyChain.concat(n),e=e.object);var i=c(e,n),o=i.compiledPropertyChain,a=i.deepestObject;return(r=t.containsError(o,a))?y(r):Object.assign(Object.create(E),{object:e,propertyChain:n,compiledPropertyChain:o,deepestObject:a})},get TwineScript_ObjectName(){var t=this,n=function(n,r){return r||t.object!==e.variables&&!t.object.TwineScript_VariableStore?p(n):n};return(this.object===e.variables?"$":this.object.TwineScript_VariableStore?"_":S(this.object)+"'s ")+(1===this.propertyChain.length?n(this.propertyChain[0]):this.propertyChain.reduce(function(e,t,r){return e+"'s "+n(t,r)}))+(this.object.TwineScript_VariableStoreName?" in "+this.object.TwineScript_VariableStoreName:"")},on:function(e,t){return e in _?("function"!=typeof t||_[e].includes(t)||_[e].push(t),E):void b("VarRef.on","invalid event name")}})}),define("internaltypes/varscope",[],function(){return{TwineScript_ObjectName:"the temporary variables",TwineScript_VariableStore:!0}}),define("datatypes/lambda",["utils","utils/operationutils","internaltypes/varscope","internaltypes/twineerror"],function(e,t,n,r){var i=e.toJSLiteral,o=e.insensitiveName,a=(e.plural,t.typeName,t.objectName,t.singleTypeCheck,Object.freeze({lambda:!0,TwineScript_TypeName:"a lambda",get TwineScript_ObjectName(){return'a "'+("making"in this?"making ... ":"")+("with"in this?"with ... ":"")+("where"in this?"where ... ":"")+("when"in this?"when ... ":"")+("via"in this?"via ... ":"")+'" lambda'},TwineScript_Print:function(){return"`[A lambda]`"},TwineScript_is:function(e){return e===this},TypeSignature:function(e){return{pattern:"lambda",innerType:a,clauses:e,typeName:'a "'+e.split().concat("").join(" ...")+'" lambda'}},create:function(e,t,i){var s=void 0;if(r.containsError(e))return e;if(a.isPrototypeOf(e)){if("when"===t||"when"in e)return r.create("syntax","A 'when' lambda cannot have any other clauses, such as '"+t+"'.");if(t in e&&("where"!==t||"true"!==e[t]))return r.create("syntax","This lambda has two '"+t+"' clauses.");s=e}else{if("when"===t&&void 0!==e)return r.create("syntax","A 'when' lambda shouldn't begin with a temporary variable (just use 'when' followed by the condition).");if(void 0!==e&&(!e||!e.varref||!n.isPrototypeOf(e.object)||e.propertyChain.length>1))return r.create("syntax","This lambda needs to start with a single temporary variable.");s=Object.create(this),s.loop=e?e.propertyChain[0]:""}s[t]=i;var c=[s.making,s.with,s.loop].filter(function(e,t,n){return e&&n.indexOf(o(e))!==t});return c.length?r.create("syntax","This lambda has two variables named '"+c[0]+"'.","Lambdas should have all-unique parameter names."):s},apply:function(e,t){var o=t.loop,a=t.with,s=t.making,c=t.fail,u=t.pass,l=t.ignoreVia,f=t.tempVariables;f=f||Object.create(e.stack.length?e.stack[0].tempVariables:n),[[this.loop,o],[this.with,a],[this.making,s]].forEach(function(e){var t=_slicedToArray(e,2),n=t[0],r=t[1];return n&&(f[n]=r)}),e.stack.unshift(Object.assign(Object.create(null),{tempVariables:f})),!o||this.with||this.making||this.when?e.eval("Operations").initialiseIt(r.create("operation","I can't use 'it', or an implied 'it', in "+this.TwineScript_ObjectName)):e.eval("Operations").initialiseIt(o);var p=!l&&this.via,d=e.eval("where"in this||"when"in this?"Operations.where("+(this.where||this.when)+","+(p||i(u))+","+i(c)+")":p||i(u));return e.stack.shift(),d},filter:function(e,t){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=void 0,a=t.reduce(function(t,a){if(o=r.containsError(t))return o;var s=n.apply(e,{loop:a,pass:!0,fail:!1,ignoreVia:!0,tempVariables:i});return(o=r.containsError(s))?o:t.concat(s?[a]:[])},[]);return(o=r.containsError(a))?o:a}}));return a}),define("macros",["jquery","utils/naturalsort","utils","utils/operationutils","datatypes/changercommand","datatypes/lambda","datatypes/hookset","internaltypes/changedescriptor","internaltypes/twineerror"],function(e,t,n,r,i,o,a,s,c){function u(e){return function(n){n=n.reduce(function(e,n){if(n&&!0===n.spreader){var r=n.value,i=c.containsError(r);if(i)return i;if(Array.isArray(r)||"string"==typeof r)for(var o=0;o<r.length;o++)e.push(r[o]);else r instanceof Set?e.push.apply(e,_toConsumableArray(Array.from(r).sort(t("en")))):e.push(c.create("operation","I can't spread out "+m(r)+", because it is not a string, dataset, or array."))}else e.push(n);return e},[]);var r=c.containsError(n);return r||e.apply(void 0,_toConsumableArray(n))}}function l(e,t,n){n=[].concat(n||[]),e="("+(Array.isArray(e)&&e.length>1?e[0]:e)+":)";var r=void 0;return r=n.length>0?"The "+e+" macro must only be given "+g(n.map(v))+(n.length>1?", in that order":"."):"The macro must not be given any data - just write "+e+".",function(i){for(var a=arguments.length,s=Array(a>1?a-1:0),u=1;u<a;u++)s[u-1]=arguments[u];for(var l=void 0,f=0,p=Math.max(s.length,n.length);f<p;f+=1){var y=function(t,i){var a=n[t],u=s[t];return t>=n.length&&!l?{v:c.create("datatype",s.length-n.length+" too many values were given to this "+e+" macro.",r)}:(a||(a=l),!a.innerType||"rest"!==a.pattern&&"zero or more"!==a.pattern||(l=a.innerType,"rest"===a.pattern&&(a=a.innerType)),b(u,a)?void 0:void 0===u?{v:c.create("datatype","The "+e+" macro needs "+h(n.length-t,"more value")+".",r)}:u&&u.TwineScript_Unstorable&&(a===w.TypeSignature.Any||a.innerType&&a.innerType===w.TypeSignature.Any)?{v:c.create("datatype",e+"'s "+d(t+1)+" value, "+m(u)+", is not valid data for this macro.",r)}:u&&o.isPrototypeOf(u)&&"lambda"===a.pattern?{v:c.create("datatype",e+"'s "+d(t+1)+" value (a lambda) should have "+g(["where","when","making","via","with"].filter(function(e){return a.clauses.includes(e)}).map(function(e){return"a '"+e+"' clause"}))+", not "+g(["where","when","making","via","with"].filter(function(e){return e in u}).map(function(e){return"a '"+e+"' clause"}))+".")}:{v:c.create("datatype",e+"'s "+d(t+1)+" value is "+m(u)+", but should be "+v(a)+".",a.message||r)})}(f);if("object"===(void 0===y?"undefined":_typeof(y)))return y.v}return t.apply(void 0,[i].concat(s))}}function f(e,t){Array.isArray(e)?e.forEach(function(e){return y(x,p(e),t)}):y(x,p(e),t)}var p=n.insensitiveName,d=n.nth,h=n.plural,g=n.andList,y=n.lockProperty,m=r.objectName,v=r.typeName,b=r.singleTypeCheck,w=void 0,x={},T=function(e,t,n,r){return function(){for(var i=arguments.length,o=Array(i),a=0;a<i;a++)o[a]=arguments[a];o=o.slice(1);var c=t.apply(void 0,_toConsumableArray(o));if(c)return c;var u=s.create(),l=Object.assign({TwineScript_ObjectName:"a ("+e+":) command",TwineScript_TypeName:"a ("+e+":) command",TwineScript_Print:function(){return"`[A ("+e+":) command]`"}},r?{TwineScript_Attach:function(e){return e.run(u),l},TwineScript_Run:function(e){return n.apply(void 0,[u,e].concat(_toConsumableArray(o)))}}:{TwineScript_Run:function(e){return n.apply(void 0,[e].concat(_toConsumableArray(o)))}});return l}};return w={has:function(e){return e=p(e),x.hasOwnProperty(e)},get:function(e){return e=p(e),x.hasOwnProperty(e)&&x[e]},
add:function e(t,n,r){return f(t,u(l(t,n,r))),e},addChanger:function e(t,n,r,o){return f(t,u(l(t,n,o))),i.register(Array.isArray(t)?t[0]:t,r),e},addCommand:function e(t,n,r,i){var o=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],a=[].concat(t)[0];return f(t,u(l(t,T(a,n,r,o),i))),e},TypeSignature:{optional:function(e){return{pattern:"optional",innerType:e}},zeroOrMore:function(e){return{pattern:"zero or more",innerType:e}},either:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return{pattern:"either",innerType:t}},rest:function(e){return{pattern:"rest",innerType:e}},wrapped:function(e,t){return{pattern:"wrapped",innerType:e,message:t}},Any:{TwineScript_TypeName:"anything"}},run:function(e,t){return c.containsError(e)?e:w.has(e)?w.get(e)(t):c.create("macrocall","I can't run the macro '"+e+"' because it doesn't exist.","Did you mean to run a macro? If you have a word written like (this:), it is regarded as a macro name.")}},Object.freeze(w)}),define("datatypes/datatype",["datatypes/changercommand","datatypes/colour","datatypes/gradient"],function(e,t,n){var r=Object.freeze({datatype:!0,TwineScript_TypeName:"a datatype",TwineScript_Print:function(){return"`["+this.TwineScript_ObjectName+"]`"},TwineScript_is:function(e){return r.isPrototypeOf(e)&&e.name===this.name},TwineScript_Clone:function(){return r.create(this.name)},TwineScript_IsTypeOf:function(e){return this.name===(Array.isArray(e)?"array":e instanceof Map?"datamap":e instanceof Set?"dataset":t.isPrototypeOf(e)?"colour":n.isPrototypeOf(e)?"gradient":"string"==typeof e?"string":"number"==typeof e?"number":"boolean"==typeof e?"boolean":"unknown")},create:function(e){return e="dm"===e?"datamap":"ds"===e?"dataset":"num"===e?"number":"str"===e?"string":"color"===e?"colour":e,Object.assign(Object.create(this),{name:e,TwineScript_ObjectName:"the "+e+" datatype"})}});return r}),define("datatypes/varbind",["utils","utils/operationutils","internaltypes/varref","internaltypes/twineerror"],function(e,t,n,r){var i=t.objectName;return Object.freeze({TwineScript_TypeName:"a bound variable",TwineScript_ObjectName:"a bound variable",TwineScript_Unstorable:!0,set:function(e){var t=this.varRef.set(e),n=void 0;if(n=r.containsError(t))return n},create:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"one way";return n.isPrototypeOf(e)||e.varref?Object.assign(Object.create(this),{varRef:e,bind:t}):r.create("operation","I can only 'bind' a variable, not "+i(e)+".")}})}),define("datatypes/assignmentrequest",["utils"],function(e){var t=e.assertMustHave;return Object.freeze({assignmentRequest:!0,TwineScript_TypeName:"a 'to' or 'into' expression",TwineScript_ObjectName:"a 'to' or 'into' expression",TwineScript_Unstorable:!0,create:function(e,n,r){return t(e,["varref"]),Object.assign(Object.create(this),{dest:e,src:n,operator:r})}})}),define("twinescript/operations",["jquery","state","datatypes/assignmentrequest","utils/operationutils","internaltypes/twineerror"],function(e,t,n,r,i){function o(e,t,n,r){return n=n||"do this to",function(o,a){1===t.length&&(a=o);var s=void 0;return(s=i.containsError(o,a))?s:(void 0===o?"undefined":_typeof(o))!==e||(void 0===a?"undefined":_typeof(a))!==e?i.create("operation","I can only "+n+" "+e+"s, not "+y((void 0===o?"undefined":_typeof(o))!==e?o:a)+".",r):t(o,a)}}function a(e){return function(t,n){var r=void 0;return(r=i.containsError(t,n))?r:t&&t.varref?i.create("operation","I can't give an expression a new value."):(void 0===t?"undefined":_typeof(t))!==(void 0===n?"undefined":_typeof(n))||c(t)&&"TwineScript_TypeName"in t&&c(n)&&"TwineScript_TypeName"in n&&t.TwineScript_TypeName!==n.TwineScript_TypeName||u(t)!==u(n)?i.create("operation",y(t)+" isn't the same type of data as "+y(n)):e(t,n)}}function s(e){return function t(n,r){var o=void 0;if(o=i.containsError(n,r))return o;if(v=n,n.determiner){var a="all"===n.determiner;return n.array.reduce(function(e,n){var o=void 0,s=t(n,r);return(o=i.containsError(e,s))?o:a?e&&s:e||s},a)}if(r.determiner){var s="all"===r.determiner;return r.array.reduce(function(e,r){var o=void 0,a=t(n,r);return(o=i.containsError(e,a))?o:s?e&&a:e||a},s)}return e(n,r)}}var c=r.isObject,u=r.collectionType,l=r.is,f=r.isA,p=r.clone,d=r.unique,h=r.contains,g=r.matches,y=(r.typeName,r.objectName),m=void 0,v=0,b="If one of these values is a number, you may want to write a check that it 'is not 0'. Also, if one is a string, you may want to write a check that it 'is not \"\" '.";return m={create:function(n){var r=Object.create(this);return r.Identifiers={TwineScript_Identifiers:!0,get it(){return v},get time(){return Date.now()-n.timestamp},get visits(){return t.pastPassageNames().filter(function(e){return e===t.passage}).length+1},get visit(){return r.Identifiers.visits},get exits(){return n.dom.find("tw-enchantment, tw-link").filter(function(t,n){return e(n).data("enchantmentEvent")||e(n).parent().data("linkPassageName")||e(n).parent().data("clickEvent")}).length},get exit(){return r.Identifiers.exits}},r},elidedComparisonOperator:function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return r.reduce(function(n,r){return"boolean"==typeof r?r:m[e](n,m[t](v,r))},"and"===e)},and:o("boolean",a(function(e,t){return e&&t}),"use 'and' to join",b),or:o("boolean",a(function(e,t){return e||t}),"use 'or' to join",b),not:o("boolean",function(e){return!e},"use 'not' to invert",b),"+":a(function(e,t){if(Array.isArray(e))return[].concat(_toConsumableArray(e),_toConsumableArray(t));var n=void 0;return e instanceof Map?(n=new Map(e),t.forEach(function(e,t){return n.set(t,e)}),n):e instanceof Set?new Set([].concat(_toConsumableArray(e),_toConsumableArray(t)).filter(d).map(p)):"function"==typeof e["TwineScript_+"]?e["TwineScript_+"](t):"string|number|boolean".includes(void 0===e?"undefined":_typeof(e))?e+t:i.create("operation","I can't use + on "+y(e)+".")}),"-":a(function(e,t){if(Array.isArray(e))return e.filter(function(e){return!t.some(function(t){return l(e,t)})});if(e instanceof Set){var n=[].concat(_toConsumableArray(t));return new Set([].concat(_toConsumableArray(e)).filter(function(e){return!n.some(function(t){return l(e,t)})}))}return"string"==typeof e?e.split(t).join(""):"number"==typeof e?e-t:i.create("operation","I can't use - on "+y(e)+".")}),"*":o("number",a(function(e,t){return e*t}),"multiply"),"/":o("number",a(function(e,t){return 0===t?i.create("operation","I can't divide "+y(e)+" by zero."):e/t}),"divide"),"%":o("number",a(function(e,t){return 0===t?i.create("operation","I can't modulo "+y(e)+" by zero."):e%t}),"modulus"),"<":s(o("number",a(function(e,t){return e<t}),"do < to")),">":s(o("number",a(function(e,t){return e>t}),"do > to")),"<=":s(o("number",a(function(e,t){return e<=t}),"do <= to")),">=":s(o("number",a(function(e,t){return e>=t}),"do >= to")),is:s(l),isNot:s(function(e,t){return!m.is(e,t)}),contains:s(h),isIn:s(function(e,t){return h(t,e)}),isA:s(f),isNotA:s(function(e,t){return!f(e,t)}),typifies:s(function(e,t){return f(t,e)}),untypifies:s(function(e,t){return!f(t,e)}),matches:s(g),where:function(e,t,n){var r=void 0;return(r=i.containsError(e))?r:"boolean"!=typeof e?i.create("operation","This lambda's 'where' clause must evaluate to true or false, not "+y(e)+"."):e?t:n},makeSpreader:function(e){return{value:e,spreader:!0}},makeAssignmentRequest:function(e,t,r){var o=i.containsError(e,t);return o||(c(e)&&"varref"in e?n.create(e,t,r):i.create("operation","I can't store a new value inside "+y(e)+"."))},setIt:function(e){return i.containsError(e)?e:e.varref?(v=e.get(),e):i.create("operation","I can't put a new value into "+y(e)+".")},initialiseIt:function(e){v=e}},Object.freeze(m)}),define("twinescript/environ",["macros","state","utils","datatypes/colour","datatypes/hookset","datatypes/lambda","datatypes/datatype","datatypes/varbind","internaltypes/varref","internaltypes/twineerror","twinescript/operations"],function(Macros,State,Utils,Colour,HookSet,Lambda,Datatype,VarBind,VarRef,TwineError,OperationsProto){return function(section){"object"===(void 0===section?"undefined":_typeof(section))&&section||Utils.impossible("TwineScript.environ","no Section argument was given!");var Operations=OperationsProto.create(section);return section.eval=function(){try{for(var _len7=arguments.length,args=Array(_len7),_key7=0;_key7<_len7;_key7++)args[_key7]=arguments[_key7];return eval(args.join(""))}catch(e){return e}},section}}),define("internaltypes/twinenotifier",["jquery","utils"],function(e,t){var n=t.impossible,r={create:function(e){return e||n("TwineNotifier.create","called with only 1 string."),Object.assign(Object.create(r),{message:e})},render:function(){return e("<tw-notifier>").attr("message",this.message)}};return r}),define("section",["jquery","utils","utils/selectors","renderer","twinescript/environ","twinescript/operations","state","utils/operationutils","datatypes/changercommand","datatypes/hookset","datatypes/colour","internaltypes/changedescriptor","internaltypes/varscope","internaltypes/twineerror","internaltypes/twinenotifier"],function(e,t,n,r,i,o,a,s,c,u,l,f,p,d,h){function g(e,n,r){if(n&&"object"===(void 0===n?"undefined":_typeof(n))&&c.isPrototypeOf(n)){if(!this.renderInto(r.popAttr("source"),r,n)){var i=t.insensitiveName(e.attr("name"));if(["if","elseif","unless","else"].includes(i)&&(e.addClass("false"),"elseif"!==i&&(this.stack[0].lastHookShown=!1)),r.data("live")){var o=r.data("live"),a=o.delay,s=o.event;x.call(this,e,r,a,s)}return}}else{if(!1===n)return r.attr("source")&&r.data("hiddenSource",r.popAttr("source")),e.addClass("false"),void(this.stack[0].lastHookShown=!1);!0!==n&&e.replaceWith(d.create("datatype",S(n)+" cannot be attached to this hook.","Only Booleans, changer commands, and the (live:) macro can be attached to hooks.").render(e.attr("title")))}this.stack[0].lastHookShown=!0}function y(t){var n=t instanceof e?t[0]:t,r=n.nextSibling;if(r&&(r instanceof Text&&!r.textContent.trim()||"br"===(r.tagName||"").toLowerCase())){var i=y(r),o=i.whitespace,a=i.nextElem;return{whitespace:e(r).add(o),nextElem:a}}return{whitespace:e(),nextElem:e(r)}}function m(r){var i=this.eval(r.popAttr("js")||"");this.stackTop.evaluateOnly&&i&&(c.isPrototypeOf(i)||"function"==typeof i.TwineScript_Run)&&(i=d.create("syntax","I can't work out what this "+this.stackTop.evaluateOnly+" should evaluate to, because it contains a "+c.isPrototypeOf(i)?"changer":"command.","Please rewrite this without putting changers or commands here."));var a=void 0,s=void 0,u=e();for(s=r;c.isPrototypeOf(i);){var p=y(s);if(a=p.whitespace,s=p.nextElem,s[0]instanceof Text&&"+"===s[0].textContent.trim()){var m=void 0,v=s,b=y(v);if(m=b.whitespace,s=b.nextElem,s.is(n.expression)){var w=this.eval(s.popAttr("js"));if(d.containsError(w)){i=w;break}var x=o["+"](i,w);e(a).add(v).add(m).remove(),i=d.containsError(x)?d.create("operation","I can't combine "+S(i)+" with "+S(w)+".","function"==typeof w.TwineScript_Run?"If you want to attach this changer to "+S(w)+", remove the + between them.":"Changers can only be added to other changers."):x;continue}}if(s.is(n.expression)){var k=this.eval(s.popAttr("js"));if(d.containsError(k)){i=k;break}if(k&&"object"===(void 0===k?"undefined":_typeof(k))&&"function"==typeof k.TwineScript_Attach){i=k.TwineScript_Attach(i);break}return c.isPrototypeOf(k)?void r.replaceWith(d.create("operation","Changers like ("+i.macroName+":) need to be combined using + between them.","Place the + between the changer macros, or the variables holding them. The + is absent only between a changer and its attached hook or command.").render(r.attr("title"))):void r.replaceWith(d.create("operation",S(k)+" can't have changers like ("+i.macroName+":) attached.","Changers placed just before hooks, links and commands will attempt to attach, but in this case it didn't work.").render(r.attr("title")))}if(s.is(n.hook)){a.remove(),u=s;break}i.macroName||t.impossible("Section.runExpression","changer has no macroName");var O=r.attr("title")||"("+i.macroName+": ...)";return void r.replaceWith(d.create("syntax","The ("+i.macroName+":) changer should be stored in a variable or attached to a hook.","Macros like this should appear to the left of a hook: "+O+"[Some text]").render(r.attr("title")))}u=u.length?u:y(r).nextElem.filter(n.hook);var j=void 0;if(j=d.containsError(i))j instanceof Error&&(j=d.fromError(j)),r.replaceWith(j.render(r.attr("title"),r));else if(h.isPrototypeOf(i))r.append(i.render());else if(i&&"function"==typeof i.TwineScript_Run)if(i=i.TwineScript_Run(this),d.containsError(i))r.replaceWith(i.render(r.attr("title")));else if(f.isPrototypeOf(i)){if(i.data&&i.data.live)return void r.replaceWith(d.create("unimplemented","I currently can't attach (live:) or (event:) macros to commands - only hooks.").render(r.attr("title")));i.section=this,i.target=s,this.renderInto("",s,i)}else{if("blocked"===i)return void(this.stackTop.blocked=!0);i&&t.impossible("Section.runExpression","TwineScript_Run() returned a non-ChangeDescriptor "+(void 0===i?"undefined":_typeof(i))+': "'+i+'"')}else!u.length&&("string"==typeof i||"number"==typeof i||i instanceof Map||i instanceof Set||Array.isArray(i)||l.isPrototypeOf(i))||i&&"function"==typeof i.TwineScript_Print&&!c.isPrototypeOf(i)?(i=T(i),d.containsError(i)?(i instanceof Error&&(i=d.fromError(i)),r.replaceWith(i.render(r.attr("title")))):"string"!=typeof i?t.impossible("printBuiltinValue() produced a non-string "+(void 0===i?"undefined":_typeof(i))):this.renderInto(i,r)):u.length?g.call(this,r,i,u):c.isPrototypeOf(i)||"boolean"==typeof i||t.impossible("Section.runExpression","The expression evaluated to an unknown value: "+i.toSource())}function v(e){var t=e.first()[0],n=e.parent();if(!n.length)return null;var r=n.textNodes().filter(function(e){var n=e.compareDocumentPosition(t);return 4&n&&!(8&n)});return(r=r[r.length-1])||v(n)}function b(e){var t=e.last()[0],n=e.parent();if(!n.length)return null;var r=n.textNodes().filter(function(e){var n=e.compareDocumentPosition(t);return 2&n&&!(8&n)})[0];return r||b(n)}function w(t){function n(t){return 0===e(this||t).parentsUntil("tw-collapsed").filter("tw-verbatim, tw-expression, [collapsing=false]").length}var r=v(t);e(r).parents("tw-collapsed").length||(r=null);var i=b(t);e(i).parents("tw-collapsed").length||(i=null),t.findAndFilter("br:not([data-raw])").filter(n).replaceWith(document.createTextNode(" "));var o=t.textNodes(),a=0;o.reduce(function(e,t){return n(t)?(t.textContent=t.textContent.replace(/\s+/g," ")," "!==t.textContent[0]||e&&e.textContent&&!(e.textContent.search(/\s$/)>-1)||(t.textContent=t.textContent.slice(1)),t):document.createTextNode("A")},r),[].concat(_toConsumableArray(o)).reverse().every(function(e){return!!n(e)&&(e.textContent.match(/^\s*$/)?(a+=e.textContent.length,e.textContent="",!0):(e.textContent=e.textContent.replace(/\s+$/,function(e){return a+=e.length,""}),!1))}),a>0&&i&&(o[o.length-1].textContent+=" "),t[0]&&O()&&t[0].normalize()}function x(e,r){var i=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:void 0;a&&t.assertMustHave(a,["when"]);var s=r.data("hiddenSource")||"",c=_slicedToArray(this.stack,1),u=c[0].tempVariables,l=this.whenUnblocked.bind(this,function(){if(i.inDOM()){var t=a&&a.filter(i,[!0],u);if(d.containsError(t))return void t.render(e.attr("title")).replaceAll(e);if(a&&!t[0])return void setTimeout(l,o);i.renderInto(s,r,{append:"replace"}),t||r.find(n.expression+"[name='stop']").length||i.inDOM()&&setTimeout(l,o)}});setTimeout(l,o)}var T=s.printBuiltinValue,S=s.objectName,k=void 0,O=function(){var t=void 0;return function(){if(void 0!==t)return t;var n=e("<p>");return n[0].normalize?(n.append(document.createTextNode("0-"),document.createTextNode("2"),document.createTextNode(""))[0].normalize(),t=1===n.contents().length):t=!1}}();return k={create:function(n){n instanceof e&&1===n.length||t.impossible("Section.create","called with no DOM element");var r=Object.assign(Object.create(this),{timestamp:Date.now(),dom:n||t.storyElement,stack:[],enchantments:[],unblockCallbacks:[]});return r=i(r)},get stackTop(){return this.stack[0]},inDOM:function(){return e(t.storyElement).find(this.dom).length>0},evaluateTwineMarkup:function(t,n){var r=e("<p>");this.stack.unshift({desc:f.create({target:r,source:t,section:this}),tempVariables:this.stackTop.tempVariables,evaluateOnly:n}),this.execute();var i=void 0;return(i=r.find("tw-error")).length>0?i:r},renderInto:function(t,r,i){var o=this,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=f.create({target:r,source:t,section:this});if(i)if(c.isPrototypeOf(i)){var u=i.run(s);if(d.containsError(u))return u.render(r.attr("title")).replaceAll(r),!1}else Object.assign(s,i);if(r=s.target,this.stack.length>=50)return d.create("infinite","Printing this expression may have trapped me in an infinite loop.").render(r.attr("title")).replaceAll(r),!1;var l=function(t,i){var a=r instanceof e&&r.is(n.hook)&&r.parents("tw-collapsed").length>0;o.stack.unshift({desc:t,tempVariables:i,collapses:a,evaluateOnly:o.stackTop&&o.stackTop.evaluateOnly})};if(!a){a=Object.create(this.stack.length?this.stackTop.tempVariables:p);var h=r&&r.tag();a.TwineScript_VariableStoreName=h===n.hook?r.attr("name")?"?"+r.attr("name"):"an unnamed hook":h===n.expression?"a "+r.attr("type")+" expression":h===n.passage?"this passage":"an unknown scope"}return Object.keys(s.loopVars).length?function(){var e=Object.assign({},s.loopVars),t=Math.min.apply(Math,_toConsumableArray(Object.keys(e).map(function(t){return e[t].length})));if(t){for(var n=t-1;n>=0;n-=1)!function(t){l(s,Object.keys(e).reduce(function(n,r){return n[r]=e[r][t],n},Object.create(a)))}(n);for(var n=t-1;n>=0&&!o.stackTop.blocked;n-=1)o.execute()}}():(l(s,a),this.execute()),0===this.stack.length&&this.updateEnchantments(),s.enabled},execute:function(){var r=_slicedToArray(this.stack,1),i=r[0],o=i.desc,a=i.dom,s=i.collapses,c=i.evaluateOnly;o&&!a&&(a=o.render(),this.stackTop.dom=a,this.stackTop.desc=void 0);var u=this;a.findAndFilter(n.hook+","+n.expression).each(function(){var r=e(this);switch(r.tag()){case n.hook:r.attr("hidden")&&(r.removeAttr("hidden"),r.data("hiddenSource",r.popAttr("source"))),r.attr("source")&&u.renderInto(r.popAttr("source"),r);break;case n.expression:if(r.attr("blockers")){if(c)return void r.removeAttr("blockers").removeAttr("js").replaceWith(d.create("syntax","I can't use a macro like (prompt:) or (confirm:) in "+c+".","Please rewrite this without putting such macros here.").render(r.attr("title"),r));var i=[];try{i=JSON.parse(r.popAttr("blockers")),r.data("blockers",i)}catch(e){t.impossible("Section.execute","JSON.parse blockers failed.")}}if(r.data("blockers")){var o=r.data("blockers");if(o.length){u.stackTop.blocked=!0;var a=u.eval(o.shift());return d.containsError(a)&&(u.stackTop.blocked=!1,r.removeData("blockers").replaceWith(a.render(r.attr("title"),r))),!1}r.removeData("blockers")}if(r.attr("js")&&m.call(u,r),u.stackTop.blocked)return!1}}),u.stackTop.blocked||(a.length&&s&&w(a),a.findAndFilter(n.collapsed).each(function(){w(e(this))}),this.stack.shift())},updateEnchantments:function(){this.enchantments.forEach(function(e){e.disenchant(),e.enchantScope()})},unblock:function(e){for(this.stack.length||t.impossible("Section.unblock","stack is empty"),this.stackTop.blocked=!1,void 0!==e&&(this.stackTop.blockedValues=(this.stackTop.blockedValues||[]).concat(e));this.stack.length&&!this.stackTop.blocked;)this.execute();if(!this.stack.length)for(;this.unblockCallbacks.length>0;){var n=this.unblockCallbacks.shift();if(n(),this.stackTop.blocked)return}},whenUnblocked:function(e){if(!this.stack.length||!this.stackTop.blocked)return void e();this.unblockCallbacks=this.unblockCallbacks.concat(e)},blockedValue:function(){var e=this.stackTop;return e||t.impossible("Section.blockedValue","stack is empty"),e.blockedValues&&e.blockedValues.length||t.impossible("Section.blockedValue","blockedValues is missing or empty"),e.blockedValues.shift()}},Object.preventExtensions(k)}),define("engine",["jquery","utils","utils/selectors","state","section","passages"],function(e,t,n,r,i,o){function a(){var t=e("<tw-passage><tw-sidebar>"),i=t.children(n.sidebar);h.permalink&&r.save&&i.append('<tw-icon tabindex=0 class="permalink" title="Permanent link to this passage"><a href="#'+r.save()+'">&sect;');var o=e('<tw-icon tabindex=0 class="undo" title="Undo">&#8630;</tw-icon>').click(function(){return d.goBack()}),a=e('<tw-icon tabindex=0 class="redo" title="Redo">&#8631;</tw-icon>').click(function(){return d.goForward()});return r.pastLength<=0&&o.css("visibility","hidden"),r.futureLength<=0&&a.css("visibility","hidden"),i.append(o).append(a),t}function s(e,t){return"<tw-include type="+e+" title='"+u(t.get("name"))+"'>"+t.get("source")+"</tw-include>"}function c(c){var u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.assertOnlyHas(u,["stretch","transitionIn","transitionOut","transitionTime"]);var d=o.get(c),g=t.storyElement,y=g.parent(),m=u.stretch,v=u.transitionOut,b=u.transitionIn,w=u.transitionTime;if(v=v||"instant",b=b||"dissolve",y.is(n.enchantment)){var x=y.data("enchantedProperties");x&&g.css(x.reduce(function(e,t){return e[t]="",e},{})),y=g.unwrap().parent()}o.hasValid(c)||l("Engine.showPassage","There's no passage with the name \""+c+'"!'),g.detach();var T=t.$(g.children(f));!m&&v&&(p(T,v,w),T.css("position","absolute"));var S=(d.get("tags")||[]).join(" "),k=a().appendTo(g).attr({tags:S});g.attr({tags:S});var O=i.create(k),j=d.get("source");j=o.getTagged("header").map(s.bind(0,"header")).join("")+(h.debug?o.getTagged("debug-header").map(s.bind(0,"debug-header")).join(""):"")+j+o.getTagged("footer").map(s.bind(0,"footer")).join("")+(h.debug?o.getTagged("debug-footer").map(s.bind(0,"debug-footer")).join(""):""),r.pastLength<=0&&(h.debug&&(j=o.getTagged("debug-startup").map(s.bind(0,"debug-startup")).join("")+j),j=o.getTagged("startup").map(s.bind(0,"startup")).join("")+j),O.renderInto(j,k,{transition:b,transitionTime:w}),y.append(g.parents().length?g.parents().last():g),scroll(0,m?k.offset().top-.05*e(window).height():g.offset().top)}var u=t.escape,l=t.impossible,f=t.passageSelector,p=t.transitionOut,d=void 0,h=Object.create(null);return d={goBack:function(e){r.rewind()&&c(r.passage,e)},goForward:function(e){r.fastForward()&&c(r.passage,e)},goToPassage:function(e,t){r.play(e),c(e,t)},showPassage:c,options:h},Object.freeze(d)}),define("debugmode",["jquery","utils","state","internaltypes/varref","internaltypes/twineerror","utils/operationutils","engine","passages"],function(e,t,n,r,i,o,a,s){var c=o.objectName,u=(o.typeName,o.is),l=o.isObject;return function(){function o(){var e=y.children();d.find(".tab-variables").text(e.length+" Variable"+(1!==e.length?"s":""))}function f(n,r,i,a){var s=y.children('[data-name="'+t.escape(n+"")+'"][data-path="'+t.escape(r+"")+'"]'),u=l(i)&&i.TwineScript_DebugName?i.TwineScript_DebugName():t.escape(c(i));s.length||(s=e('<div class="variable-row" data-name="'+t.escape(n+"")+'" data-path="'+t.escape(r+"")+'" data-value="'+u+'"></div>').appendTo(y));var p="";r.length&&(p=r.reduce(function(e,t){return e+t+"'s "},"")),s.empty().append("<span class='variable-name "+(p?"":a?"temporary":"global")+"'>"+(p?"<span class='variable-path "+(a?"temporary":"global")+"'>"+t.escape(p)+"</span> ":"")+t.escape(n+"")+(a?"<span class='temporary-variable-scope'>"+a+"</span>":"")+"</span><span class='variable-value'>"+u+"</span>").css("padding-left",Math.min(5,r.length)+"em").appendTo(y),o(),Array.isArray(i)?i.forEach(function(e,i){return f(t.nth(i+1),r.concat(n),e,a)}):i instanceof Map?[].concat(_toConsumableArray(i)).forEach(function(e){var t=_slicedToArray(e,2),i=t[0],o=t[1];return f(i,r.concat(n),o,a)}):i instanceof Set&&[].concat(_toConsumableArray(i)).forEach(function(e){return f("???",r.concat(n),e,a)})}function p(){var t=[];y.children().each(function(r,i){i=e(i);var a=i.attr("data-name"),s=i.attr("data-path"),c=i.attr("data-value");s||a.startsWith("TwineScript")||(a in n.variables?(t.push(a),u(n.variables[a],c)||f(a,[],n.variables[a])):(i.remove(),o()))});for(var r in n.variables)r.startsWith("TwineScript")||t.includes(r)||f(r,[],n.variables[r]);d.find(".panel-source").text(s.get(n.passage).get("source"))}var d=e("<tw-debugger>\n\t\t<div class='panel panel-variables'></div>\n\t\t<div class='panel panel-errors' hidden><table></table></div>\n\t\t<div class='panel panel-source' hidden></div>\n\t\t<div class='tabs'>\n\t\t<button class='tab tab-variables enabled'>0 Variables</button> <button class='tab tab-errors'>0 Errors</button> <button class='tab tab-source'>Source</button>\n\t\t</div>\n\t\tTurns: <select class='turns' disabled></select><button class='show-invisibles'>Debug View</button></tw-debugger>"),h=d.find(".show-invisibles");h.click(function(){e(document.documentElement).toggleClass("debug-mode"),h.toggleClass("enabled")}),["variables","source","errors"].forEach(function(e){var t=d.find(".tab-"+e),n=d.find(".panel-"+e);t.click(function(){t.toggleClass("enabled"),d.find(".tab:not(.tab-"+e+")").removeClass("enabled"),d.find(".panel").attr("hidden",""),t.is(".enabled")&&n.removeAttr("hidden")})});var g=d.find(".turns");g.change(function(e){var t=e.target.value,r=t-n.pastLength;0!==r&&(n[r<0?"rewind":"fastForward"](Math.abs(r)),a.showPassage(n.passage))}),n.on("forward",function(t){var r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=n.pastLength;i>1&&g.removeAttr("disabled"),r?(g.find("[selected]").removeAttr("selected"),g.val(i)):(g.children().each(function(t,n){t>=i&&e(n).remove()}),g.append("<option value="+i+">"+(i+1)+": "+t+"</option>").val(i))}).on("back",function(){n.pastLength<=1&&g.attr("disabled"),g.find("[selected]").removeAttr("selected"),g.val(n.pastLength)}).on("load",function(e){g.empty(),g[e.length<=1?"attr":"removeAttr"]("disabled"),e.forEach(function(e,t){return g.append("<option value="+t+">"+(t+1)+": "+e.passage+"</option>")})});var y=d.find(".panel-variables");n.on("forward",p).on("back",p),n.on("load",function(){return e(".panel-variables").empty()}),r.on("set",function(e,t,r){(e===n.variables||e.TwineScript_VariableStore)&&f(t,[],r,e===n.variables?"":e.TwineScript_VariableStoreName)}).on("delete",function(e,t){e===n.variables&&y.find('[data-name="'+t+'"]:not(.temporary)').remove()}),i.on("error",function(t,r){var i=e('<tr class="error-row"><td class="error-passage">'+n.passage+'</td><td class="error-message">'+t.message+"</td></tr>");i.find(".error-message").attr("title",r);var o=d.find(".panel-errors table"),a=o.children().length+1;a>500&&o.children(":first-child").remove(),o.append(i),d.find(".tab-errors").text(a+" Error"+(1!==a?"s":""))}),e(document.body).append(d)}}),define("utils/dialog",["jquery","renderer"],function(e,t){function n(n,r,i,o){var a=e(t.exec("<tw-backdrop><tw-dialog>\n"+(r||""===r?"=><=\n<input type=text></input>\n\n=><=\n":"")+"==>\n"+(o?"|||=\n<tw-link tabindex=0>OK</tw-link>\n=|\n<tw-link tabindex=0>Cancel</tw-link>":"\n<tw-link tabindex=0>OK</tw-link>")+"</tw-dialog></tw-backdrop>"));return a.find("tw-dialog").prepend(t.exec(n)),r&&a.find("input").last().val(r),a.find("tw-link").last().on("click",function(){a.remove(),i()}),o&&e(a.find("tw-link").get(-2)).on("click",function(){a.remove(),o()}),a}return n}),define("macrolib/values",["macros","utils","utils/operationutils","datatypes/colour","datatypes/gradient","internaltypes/twineerror"],function(e,t,n,r,i,o){function a(e){return function(){var t=e.apply(void 0,arguments);return"number"!=typeof t||isNaN(t)?o.create("macrocall","This mathematical expression doesn't compute!"):t}}var s=t.realWhitespace,c=t.nth,u=t.anyRealLetter,l=n.subset,f=n.objectName,p=n.clone,d=e.TypeSignature,h=d.rest,g=d.zeroOrMore,y=d.either,m=d.optional,v=d.Any;e.add(["text","string","str"],function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.join("")},[g(e.TypeSignature.either(String,Number,Boolean,Array))])("substring",function(e,t,n,r){return l(t,n,r)},[String,parseInt,parseInt])("lowercase",function(e,t){return t.toLowerCase()},[String])("uppercase",function(e,t){return t.toUpperCase()},[String])("lowerfirst",function(e,t){return t.replace(new RegExp(u+"+"),function(e){return e=Array.from(e),e[0].toLowerCase()+e.slice(1).join("").toLowerCase()})},[String])("upperfirst",function(e,t){return t.replace(new RegExp(u+"+"),function(e){return e=Array.from(e),e[0].toUpperCase()+e.slice(1).join("").toLowerCase()})},[String])("words",function(e,t){return t.split(new RegExp(s+"+")).filter(Boolean)},[String])(["str-repeated","string-repeated"],function(e,t,n){return t<=0?o.create("macrocall","I can't repeat this string "+t+" times."):0===n.length?o.create("macrocall","I can't repeat an empty string."):n.repeat(t)},[parseInt,String])(["str-reversed","string-reversed"],function(e,t){return[].concat(_toConsumableArray(t)).reverse().join("")},[String])(["num","number"],function(e,t){return Number.isNaN(+t)?o.create("macrocall","I couldn't convert "+f(t)+" to a number."):+t},[String])(["rgb","rgba"],function(e){for(var t,n=0;n<3;n+=1)if((t=arguments.length<=n+1?void 0:arguments[n+1])<0||t>255)return o.create("macrocall","RGB values must be whole numbers between 0 and 255, not "+f(t)+".");return(arguments.length<=4?void 0:arguments[4])<0||(arguments.length<=4?void 0:arguments[4])>1?o.create("macrocall","Alpha values must be numbers between 0 and 1 inclusive, not "+f(arguments.length<=4?void 0:arguments[4])+"."):r.create({r:arguments.length<=1?void 0:arguments[1],g:arguments.length<=2?void 0:arguments[2],b:arguments.length<=3?void 0:arguments[3],a:arguments.length<=4?void 0:arguments[4]})},[parseInt,parseInt,parseInt,m(Number)])(["hsl","hsla"],function(e,t,n,i,a){var s=" values must be numbers between 0 and 1 inclusive, not ";return n<0||n>1?o.create("macrocall","Saturation"+s+f(n)+"."):i<0||i>1?o.create("macrocall","Lightness"+s+f(i)+"."):a<0||a>1?o.create("macrocall","Alpha"+s+f(i)+"."):(t=Math.round(t)%360,t<0&&(t+=360),r.create({h:t,s:n,l:i,a:a}))},[Number,Number,Number,m(Number)])(["gradient"],function(e,t){for(var n=arguments.length,a=Array(n>2?n-2:0),s=2;s<n;s++)a[s-2]=arguments[s];if("number"!=typeof t)return o.create("datatype","(gradient:)'s first argument should be a number of degrees, not "+f(t)+".");if(t=Math.round(t)%360,t<0&&(t+=360),a.length<4)return o.create("datatype","(gradient:) must be given at least 2 colour-stop pairs of numbers and colours.");var c=void 0,u=[],l=a.reduce(function(e,t){if(o.containsError(e))return e;if(void 0===c)c=t;else{if("number"!=typeof c||c<0||c>1)return r.isPrototypeOf(c)?o.create("datatype","(gradient:) colour-stops should be pairs of numbers and colours, not colours and numbers."):o.create("datatype","(gradient:) colour-stop percents should be fractional numbers between 0 and 1, not "+f(c)+".");if(!r.isPrototypeOf(t))return"string"==typeof t&&t.startsWith("#")?o.create("datatype",'HTML hex colours should be given to (gradient:) as bare colour values like #808080, not strings like "'+t+'".'):o.create("datatype","(gradient:) colours should be built-in colours, HTML hex colours, or colours produced by (rgb:), (rgba:), (hsl:) or (hsla:), not "+f(c)+".");u.push({stop:c,colour:p(t)}),c=void 0}return e},!0);return o.containsError(l)?l:void 0!==c?o.create("macrocall","This gradient has a colour-stop percent without a colour."):i.create(t,u)},[Number,h(y(Number,r))])("cond",function(e){for(var t=0;t<(arguments.length<=1?0:arguments.length-1);t+=2){var n=arguments.length<=t+1?void 0:arguments[t+1];if(t===(arguments.length<=1?0:arguments.length-1)-1||o.containsError(n))return n;if("boolean"!=typeof n)return o.create("datatype","(cond:)'s "+c(t+1)+" value is "+f(n)+", but should be a boolean.");if(n)return arguments.length<=t+1+1?void 0:arguments[t+1+1]}
return o.create("macrocall","An odd number of values must be given to (cond:), not "+(arguments.length<=1?0:arguments.length-1),"(cond:) must be given one or more pairs of booleans and values, as well as one final value.")},[Boolean,v,h(v)]),{weekday:[function(){return["Sun","Mon","Tues","Wednes","Thurs","Fri","Satur"][(new Date).getDay()]+"day"},null],monthday:[function(){return(new Date).getDate()},null],currenttime:[function(){var e=new Date,t=e.getHours()<12;return(e.getHours()%12||12)+":"+(e.getMinutes()<10?"0":"")+e.getMinutes()+" "+(t?"A":"P")+"M"},null],currentdate:[function(){return(new Date).toDateString()},null],min:[Math.min,h(Number)],max:[Math.max,h(Number)],abs:[Math.abs,Number],sign:[Math.sign,Number],sin:[Math.sin,Number],cos:[Math.cos,Number],tan:[Math.tan,Number],floor:[Math.floor,Number],round:[Math.round,Number],ceil:[Math.ceil,Number],pow:[a(Math.pow),[Number,Number]],exp:[Math.exp,Number],sqrt:[a(Math.sqrt),Number],log:[a(Math.log),Number],log10:[a(Math.log10),Number],log2:[a(Math.log2),Number],random:[function(e,t){var n=void 0,r=void 0;return t?(n=Math.min(e,t),r=Math.max(e,t)):(n=0,r=e),r+=1,~~(Math.random()*(r-n))+n},[parseInt,e.TypeSignature.optional(parseInt)]],either:[function(){var e;return e=~~(Math.random()*arguments.length),arguments.length<=e?void 0:arguments[e]},h(v)],nth:[function(e){var t;return e<=0?o.create("datatype","(nth:)'s first value should be a positive whole number, not "+e):(t=(e-1)%(arguments.length<=1?0:arguments.length-1)+1,arguments.length<=t?void 0:arguments[t])},[parseInt,h(v)]],"":function(){var t=this;Object.keys(this).forEach(function(n){if(n){var r=t[n][0],i=t[n][1];e.add(n,function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return r.apply(void 0,n)},i)}})}}[""]()}),function(e){!function(){if(!e.requestAnimationFrame){if(e.webkitRequestAnimationFrame)return e.requestAnimationFrame=e.webkitRequestAnimationFrame,void(e.cancelAnimationFrame=e.webkitCancelAnimationFrame||e.webkitCancelRequestAnimationFrame);var t=0;e.requestAnimationFrame=function(n){var r=(new Date).getTime(),i=Math.max(0,16-(r-t)),o=e.setTimeout(function(){n(r+i)},i);return t=r+i,o},e.cancelAnimationFrame=function(e){clearTimeout(e)}}}(),"function"==typeof define&&define("requestAnimationFrame",[],function(){return e.requestAnimationFrame})}(window),define("macrolib/commands",["jquery","requestAnimationFrame","macros","utils","utils/selectors","state","passages","renderer","engine","internaltypes/twineerror","datatypes/hookset","datatypes/varbind","utils/operationutils","utils/dialog"],function(e,t,n,r,i,o,a,s,c,u,l,f,p,d){function h(e){return"("+e+" "+c.options.ifid+") "}var g=p.printBuiltinValue,y=n.TypeSignature,m=y.Any,v=y.rest,b=y.either,w=y.optional,x=Object.assign;n.addCommand("display",function(e){if(!a.hasValid(e))return u.create("macrocall","I can't (display:) the passage '"+e+"' because it doesn't exist.")},function(e,t,n){return x(e,{source:r.unescape(a.get(n).get("source"))})},[String])("print",function(){},function(e,t,n){return x(e,{source:g(n)})},[m])("go-to",function(e){if(!a.hasValid(e))return u.create("macrocall","I can't (go-to:) the passage '"+e+"' because it doesn't exist.")},function(e,n,r){return t(function(){return c.goToPassage(r,{transitionOut:e.data.t8nDepart,transitionIn:e.data.t8nArrive})}),"blocked"},[String])("undo",function(){},function(e){return o.pastLength<1?u.create("macrocall","I can't (undo:) on the first turn."):(t(function(){return c.goBack({transitionOut:e.data.t8nDepart,transitionIn:e.data.t8nArrive})}),"blocked")},[])("cycling-link",function(){if(""===(arguments.length<=0?void 0:arguments[0]))return u.create("macrocall","The first string in a (cycling-link:) can't be empty.");if(arguments.length<=(f.isPrototypeOf(arguments.length<=0?void 0:arguments[0])?2:1)){var e;return u.create("macrocall","I need two or more strings to cycle through, not just '"+(e=arguments.length-1,arguments.length<=e?void 0:arguments[e])+"'.")}},function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];var o=void 0;f.isPrototypeOf(r[0])&&(o=r.shift());var a=0,s=_slicedToArray(t.stack,1),c=s[0].tempVariables;e.data.clickEvent=function(t){a=(a+1)%r.length;var n=""===r[a]?"":"<tw-link>"+r[a]+"</tw-link>";if(o){var i=o.set(r[a]);if(u.containsError(i))return void t.replaceWith(i.render(r[a]))}var s=x({},e,{source:n,transitionDeferred:!1});e.section.renderInto("",null,s,c)};var l="<tw-link>"+r[0]+"</tw-link>";if(o){var p=o.set(r[a]);if(u.containsError(p))return p}return x(e,{source:l,append:"replace",transitionDeferred:!0})},[b(f,String),v(String)]),r.onStartup(function(){return e(r.storyElement).on("change.dropdown-macro","select",function(){var t=e(this),n=t.closest("tw-expression, tw-hook").data("dropdownEvent");n&&n(t)})}),n.addCommand("dropdown",function(e){var t;return""===(arguments.length<=1?void 0:arguments[1])||""===(t=(arguments.length<=1?0:arguments.length-1)-1+1,arguments.length<=t?void 0:arguments[t])?u.create("macrocall","The first or last strings in a (dropdown:) can't be empty.","Because empty strings create separators within (dropdown:)s, having them at the start or end doesn't make sense."):(arguments.length<=1?0:arguments.length-1)<=1?u.create("macrocall","I need two or more strings to create a (dropdown:) menu, not just "+(arguments.length<=1?0:arguments.length-1)+"."):void 0},function(e,t,n){for(var r=arguments.length,i=Array(r>3?r-3:0),o=3;o<r;o++)i[o-3]=arguments[o];var a=Math.max.apply(Math,_toConsumableArray(i.map(function(e){return[].concat(_toConsumableArray(e)).length}))),s="<select>"+i.map(function(e,t){return"<option"+(0===t?" selected":"")+(""===e?" disabled":"")+">"+(e||"\u2500".repeat(a))+"</option>"}).join("\n")+"</select>";e.data.dropdownEvent=function(e){var t=e.val(),r=n.set(t);if(u.containsError(r))return void e.replaceWith(r.render(t))};var c=n.set(i[0]);return u.containsError(c)?c:x(e,{source:s,append:"replace"})},[f,String,v(String)])("show",function(){},function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return r.forEach(function(n){return n.forEach(t,function(n){var r=n.data("hiddenSource");void 0!==r&&(t.renderInto("",null,x({},e,{source:r,target:n})),n.removeData("hiddenSource"))})}),e},[v(l)])("stop",function(){},function(){},[],!1)("load-game",function(){},function(e,n){var i=localStorage.getItem(h("Saved Game")+n);if(!i)return u.create("saving","I can't find a save slot named '"+n+"'!");var a=o.deserialise(i);if(a instanceof Error){var s=d("Sorry to interrupt... The story tried to load saved data, but there was a problem.\n"+a.message+"\n\nThat data might have been saved from a different version of this story. Should I delete it?\n(Type 'delete' and choose OK to delete it.)\n\nEither way, the story will now continue without loading the data.","",function(){e.unblock()},function(){"delete"===s.find("input").last().val()&&localStorage.removeItem(h("Saved Game")+n),e.unblock()});return r.storyElement.append(s),"blocked"}t(c.showPassage.bind(c,o.passage,!1))},[String],!1)("alert",function(){},function(e,t){r.storyElement.append(d(t,!1,function(){return e.unblock()})),e.stackTop.blocked=!0},[String],!1)("open-url",function(){},function(e,t){window.open(t,"")},[String],!1)("reload",function(){},function(){if(o.pastLength<1)return u.create("infinite","I mustn't (reload:) the page in the starting passage.");o.hasSessionStorage&&sessionStorage.removeItem("Saved Session"),window.location.reload()},[],!1)("goto-url",function(){},function(e,t){window.location.assign(t)},[String],!1),n.add("save-game",function(e,t,n){if(n=n||"",!o.hasStorage)return!1;var r=o.serialise();if(u.containsError(r))return r;if(!1===r)return!1;try{return localStorage.setItem(h("Saved Game")+t,r),localStorage.setItem(h("Saved Game Filename")+t,n),!0}catch(e){return!1}},[String,w(String)])("prompt",function(e,t,n){var i=d(t,n,function(){e.unblock(n)},function(){e.unblock(i.find("input").last().val())});r.storyElement.append(i)},[String,String])("confirm",function(e,t){r.storyElement.append(d(t,!1,function(){return e.unblock(!1)},function(){return e.unblock(!0)}))},[String])("page-url",function(){return window.location.href},[]),s.options.blockerMacros.push("prompt","confirm")}),define("macrolib/datastructures",["jquery","utils/naturalsort","macros","utils/operationutils","state","engine","passages","datatypes/lambda","datatypes/assignmentrequest","internaltypes/twineerror","internaltypes/twinenotifier"],function(e,t,n,r,i,o,a,s,c,u,l){var f=r.objectName,p=(r.typeName,r.subset),d=r.collectionType,h=r.isValidDatamapName,g=r.is,y=r.unique,m=r.clone,v=r.range,b=n.TypeSignature,w=b.optional,x=b.rest,T=b.either,S=b.zeroOrMore,k=b.Any;n.add("set",function(e){for(var t="",n=0;n<(arguments.length<=1?0:arguments.length-1);n+=1){var r=arguments.length<=n+1?void 0:arguments[n+1];if("into"===r.operator)return u.create("macrocall","Please say 'to' when using the (set:) macro.");var i=void 0;if(r.src&&r.src.varref){var a=r.src.get(),s=void 0;if(s=u.containsError(a))return s;i=r.dest.set(a)}else i=r.dest.set(r.src);if(u.isPrototypeOf(i))return i;o.options.debug&&(t+=(t?"; ":"")+f(r.dest)+" is now "+f(r.src))}return{TwineScript_TypeName:"a (set:) operation",TwineScript_ObjectName:"a (set:) operation",TwineScript_Unstorable:!0,TwineScript_Print:function(){return t&&l.create(t).render()[0].outerHTML}}},[x(c)])("put",function(e){for(var t="",n=0;n<(arguments.length<=1?0:arguments.length-1);n+=1){var r=arguments.length<=n+1?void 0:arguments[n+1];if("into"!==r.operator)return u.create("macrocall","Please say 'into' when using the (put:) macro.");var i=r.dest.set(r.src);if(u.isPrototypeOf(i))return i;o.options.debug&&(t+=(t?"; ":"")+f(r.dest)+" is now "+f(r.src))}return{TwineScript_TypeName:"a (put:) operation",TwineScript_ObjectName:"a (put:) operation",TwineScript_Unstorable:!0,TwineScript_Print:function(){return t&&l.create(t).render()[0].outerHTML}}},[x(c)])("move",function(e){for(var t="",n=0;n<(arguments.length<=1?0:arguments.length-1);n+=1){var r=arguments.length<=n+1?void 0:arguments[n+1];if("into"!==r.operator)return u.create("macrocall","Please say 'into' when using the (move:) macro.");var i=void 0,a=void 0;if(r.src&&r.src.varref){var s=r.src.get();if(a=u.containsError(s))return a;if(i=r.dest.set(s),a=u.containsError(i))return a;r.src.delete()}else if(i=r.dest.set(r.src),a=u.containsError(i))return a;o.options.debug&&(t+=(t?"; ":"")+f(r.dest)+" is now "+f(r.src))}return{TwineScript_TypeName:"a (move:) operation",TwineScript_ObjectName:"a (move:) operation",TwineScript_Unstorable:!0,TwineScript_Print:function(){return t&&l.create(t).render()[0].outerHTML}}},[x(c)])(["a","array"],function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n},S(k))("range",function(e,t,n){return v(t,n)},[parseInt,parseInt])("subarray",function(e,t,n,r){return p(t,n,r)},[Array,parseInt,parseInt])("reversed",function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.reverse().map(m)},S(k))("shuffled",function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.reduce(function(e,t,n){var r=Math.random()*(n+1)|0;return r===n?e.push(t):(e.push(e[r]),e[r]=t),e},[]).map(m)},[k,x(k)])("sorted",function(e){for(var n=arguments.length,r=Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return r.sort(t("en"))},[T(Number,String),x(T(Number,String))])("rotated",function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return t*=-1,0===t?u.create("macrocall","I can't rotate these values by 0 positions."):Math.abs(t)>=r.length?u.create("macrocall","I can't rotate these "+r.length+" values by "+t+" positions."):r.slice(t).concat(r.slice(0,t)).map(m)},[parseInt,k,x(k)])("repeated",function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];if(t<=0)return u.create("macrocall","I can't repeat these values "+t+" times.");for(var o=[];t-- >0;)o.push.apply(o,r);return o.map(m)},[parseInt,x(k)])("interlaced",function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var i=Math.min.apply(Math,_toConsumableArray(n.map(function(e){return e.length}))),o=[],a=0;a<i;a+=1)for(var s=0;s<n.length;s+=1)o.push(m(n[s][a]));return o},[Array,x(Array)]),n.add("altered",function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return r.map(function(n){return t.apply(e,{loop:n})})},[s.TypeSignature("via"),S(k)])("find",function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return t.filter(e,r)},[s.TypeSignature("where"),S(k)])("all-pass",function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];var o=t.filter(e,r);return u.containsError(o)||o.length===r.length},[s.TypeSignature("where"),S(k)])("some-pass",function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];var o=t.filter(e,r);return u.containsError(o)||o.length>0},[s.TypeSignature("where"),S(k)])("none-pass",function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];var o=t.filter(e,r);return u.containsError(o)||0===o.length},[s.TypeSignature("where"),S(k)])("folded",function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return"where"in t&&(r=t.filter(e,r)),u.containsError(r)||r.reduce(function(n,r){return t.apply(e,{making:n,loop:r})})},[T(s.TypeSignature("where via making"),s.TypeSignature("via making")),x(k)]),n.add("datanames",function(e,n){return Array.from(n.keys()).sort(t("en"))},[Map])("datavalues",function(e,n){return Array.from(n.entries()).sort(t("en",function(e){return String(e[0])})).map(function(e){return m(e[1])})},[Map])("dataentries",function(e,n){return Array.from(n.entries()).sort(function(e,n){return[e[0],n[0]].sort(t("en"))[0]===e[0]?-1:1}).map(function(e){return new Map([["name",e[0]],["value",m(e[1])]])})},[Map])("history",function(e,t){if(!t)return i.pastPassageNames();var n=t.filter(e,i.pastPassageNames().map(function(e){return a.get(e)}));return u.containsError(n)?n:n.map(function(e){return e.get("name")})},[w(s.TypeSignature("where"))])("passage",function(e,t){return u.containsError(t)?t:m(a.get(t||i.passage))||u.create("macrocall","There's no passage named '"+t+"' in this story.")},[w(String)])("passages",function(e,n){if(u.containsError(n))return n;var r=t("en"),i=[].concat(_toConsumableArray(a.values())),o=n?n.filter(e,i):i,s=u.containsError(o);return s||o.sort(function(e,t){return r(e.get("name"),t.get("name"))})},[w(s.TypeSignature("where"))])("savedgames",function(){function e(e){return"("+e+" "+o.options.ifid+") "}var t=0,n=void 0,r=new Map;do{if(!i.hasStorage)break;n=localStorage.key(t),t+=1;var a=e("Saved Game");n&&n.startsWith(a)&&(n=n.slice(a.length),r.set(n,localStorage.getItem(e("Saved Game Filename")+n)))}while(n);return r},[])(["datamap","dm"],function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var i=void 0,o=new Map,a=n.reduce(function(e,t){var n=void 0;if(u.containsError(e))return e;if(void 0===i)i=t;else{if(n=u.containsError(h(o,i)))return n;if(o.has(i))return u.create("macrocall","You used the same data name ("+f(i)+") twice in the same (datamap:) call.");o.set(i,m(t)),i=void 0}return e},!0);return u.containsError(a)?a:void 0!==i?u.create("macrocall","This datamap has a data name without a value."):o},S(k))(["dataset","ds"],function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return new Set(n.filter(y).map(m))},S(k))("count",function e(t,n){for(var r=arguments.length,i=Array(r>2?r-2:0),o=2;o<r;o++)i[o-2]=arguments[o];if(i.length>1){var a=void 0,s=i.map(function(r){return e(t,n,r)});return(a=u.containsError(s))?a:s.reduce(function(e,t){return e+t},0)}var c=i[0];switch(d(n)){case"dataset":case"datamap":return u.create("macrocall","(count:) shouldn't be given a datamap or dataset.","You should use the 'contains' operator instead. For instance, write: $variable contains 'value'.");case"string":return"string"!=typeof c?u.create("macrocall",f(n)+" can't contain  "+f(c)+" because it isn't a string."):c?n.split(c).length-1:0;case"array":return n.reduce(function(e,t){return e+g(t,c)},0);default:return u.create("macrocall",f(n)+" can't contain values, let alone "+f(c)+".")}},[k,x(k)])}),define("macrolib/stylechangers",["jquery","macros","utils","utils/selectors","datatypes/colour","datatypes/gradient","datatypes/changercommand","datatypes/lambda","internaltypes/changedescriptor","internaltypes/twineerror"],function(e,t,n,r,i,o,a,s,c,u){var l=t.TypeSignature,f=l.either,p=l.wrapped,d=l.optional,h=l.Any,g=l.zeroOrMore,y=[p(Boolean,'If you gave a number, you may instead want to check that the number is not 0. If you gave a string, you may instead want to check that the string is not "".')];n.onStartup(function(){return e(n.storyElement).on("mouseenter.hover-macro","[hover=false]",function(){var t=e(this),n=t.data("hoverChanger");t.data({mouseoutStyle:t.attr("style")||""}),c.create({target:t},n).update(),t.attr("hover",!0)}).on("mouseleave.hover-macro","[hover=true]",function(){var t=e(this),n=t.data("mouseoutStyle");t.attr("style",n).removeData("mouseoutStyle").attr("hover",!1)})});var m=["instant","dissolve","rumble","shudder","pulse","flicker","slideleft","slideright","slideup","slidedown"],v="Only the following names are recognised (capitalisation and hyphens ignored): "+m.join(", ");t.addChanger("if",function(e,t){return a.create("if",[t])},function(e,t){return e.enabled=e.enabled&&t},y)("unless",function(e,t){return a.create("unless",[!t])},function(e,t){return e.enabled=e.enabled&&t},y)("elseif",function(e,t){return"lastHookShown"in e.stack[0]?a.create("elseif",[!1===e.stack[0].lastHookShown&&!!t]):u.create("macrocall","There's no (if:) or something else before this to do (else-if:) with.")},function(e,t){return e.enabled=e.enabled&&t},y)("else",function(e){return"lastHookShown"in e.stack[0]?a.create("else",[!1===e.stack[0].lastHookShown]):u.create("macrocall","There's nothing before this to do (else:) with.")},function(e,t){return e.enabled=e.enabled&&t},null)("hidden",function(){return a.create("hidden")},function(e){return e.enabled=!1},null)("live",function(e,t){return a.create("live",[t])},function(e,t){e.enabled=!1,e.data.live={delay:t}},d(Number))("event",function(e,t){return a.create("event",[t])},function(e,t){e.enabled=!1,e.data.live={event:t}},s.TypeSignature("when"))("more",function(){return a.create("more")},function(e){e.enabled=!1,e.data.live={event:{when:!0,filter:function(e){return 0!==e.eval("Operations").Identifiers.exits?[]:[!0]}}}},null)("hook",function(e,t){return a.create("hook",[t])},function(e,t){return e.attr.push({name:t})},[String])(["for","loop"],function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return t.loop?a.create("for",[t,r]):u.create("datatype","The lambda provided to (for:) must refer to a temp variable, not just 'it'.")},function(e,t,n){var r=t.filter(e.section,n),i=void 0;if(i=u.containsError(r))return i;e.loopVars[t.loop]=r||[]},[s.TypeSignature("where"),g(h)])(["transition","t8n"],function(e,t){return t=n.insensitiveName(t),-1===m.indexOf(t)?u.create("datatype","'"+t+"' is not a valid (transition:)",v):a.create("transition",[t])},function(e,t){return e.transition=t,e},[String])(["transition-time","t8n-time"],function(e,t){return t<=0?u.create("datatype","(transition-time:) should be a positive number of (milli)seconds, not "+t):a.create("transition-time",[t])},function(e,t){return e.transitionTime=t,e.data.t8nTime=t,e},[Number])(["transition-depart","t8n-depart"],function(e,t){return t=n.insensitiveName(t),-1===m.indexOf(t)?u.create("datatype","'"+t+"' is not a valid transition",v):a.create("transition-depart",[t])},function(e,t){return e.data.t8nDepart=t,e},[String])(["transition-arrive","t8n-arrive"],function(e,t){return t=n.insensitiveName(t),-1===m.indexOf(t)?u.create("datatype","'"+t+"' is not a valid transition",v):a.create("transition-arrive",[t])},function(e,t){return e.data.t8nArrive=t,e},[String])("font",function(e,t){return a.create("font",[t])},function(e,t){return e.styles.push({"font-family":t}),e},[String])("align",function(e,t){var n=void 0,r=t.indexOf("><");if(!/^(==+>|<=+|=+><=+|<==+>)$/.test(t))return u.create("macrocall",'The (align:) macro requires an alignment arrow ("==>", "<==", "==><=" etc.) be provided, not "'+t+'"');if(~r){var i=Math.round(r/(t.length-2)*50);n=Object.assign({"text-align":"center","max-width":"50%"},25===i?{"margin-left":"auto","margin-right":"auto"}:{"margin-left":i+"%"})}else n="<"===t[0]&&">"===t.slice(-1)?{"text-align":"justify","max-width":"50%"}:t.includes(">")?{"text-align":"right"}:{"text-align":"left"};return n.display="block",a.create("align",[n])},function(e,t){e.styles.push(t)},[String])(["text-colour","text-color","color","colour"],function(e,t){return i.isPrototypeOf(t)&&(t=t.toRGBAString(t)),a.create("text-colour",[t])},function(e,t){return e.styles.push({color:t}),e},[f(String,i)])("text-rotate",function(e,t){return a.create("text-rotate",[t])},function(t,n){return t.styles.push({display:"inline-block",transform:function(){var t=e(this).css("transform")||"";return"none"===t&&(t=""),t+" rotate("+n+"deg)"}}),t},[Number])("background",function(e,t){return i.isPrototypeOf(t)?t=t.toRGBAString(t):o.isPrototypeOf(t)&&(t=t.toLinearGradientString(t)),a.create("background",[t])},function(t,r){var o=void 0;return o=i.isHexString(r)||i.isCSS3Function(r)?{"background-color":r}:r.startsWith("linear-gradient(")?{"background-image":r}:{"background-size":"cover","background-image":"url("+r+")"},t.styles.push(o,{display:function(){return n.childrenProbablyInline(e(this))?"initial":"block"}}),t},[f(String,i,o)]).apply(void 0,_toConsumableArray(function(){var t={color:function(){return"transparent"}},r=Object.assign(Object.create(null),{none:{},bold:{"font-weight":"bold"},italic:{"font-style":"italic"},underline:{"text-decoration":"underline"},strike:{"text-decoration":"line-through"},superscript:{"vertical-align":"super","font-size":".83em"},subscript:{"vertical-align":"sub","font-size":".83em"},blink:{animation:"fade-in-out 1s steps(1,end) infinite alternate"},shudder:{animation:"shudder linear 0.1s 0s infinite",display:"inline-block"},mark:{"background-color":"hsla(60, 100%, 50%, 0.6)"},condense:{"letter-spacing":"-0.08em"},expand:{"letter-spacing":"0.1em"},outline:[{"text-shadow":function(){var t=e(this).css("color");return"-1px -1px 0 "+t+", 1px -1px 0 "+t+",-1px  1px 0 "+t+", 1px  1px 0 "+t}},{color:function(){for(var t=e(this);t.length&&t[0]!==document;t=t.parent()){var n=t.css("background-color");if("transparent"!==n&&!n.match(/^\w+a\(.+?,\s*0\s*\)$/))return n}return"#fff"}}],shadow:{"text-shadow":function(){return"0.08em 0.08em 0.08em "+e(this).css("color")}},emboss:{"text-shadow":function(){return"0.08em 0.08em 0em "+e(this).css("color")}},smear:[{"text-shadow":function(){var t=e(this).css("color");return"0em   0em 0.02em "+t+",-0.2em 0em  0.5em "+t+", 0.2em 0em  0.5em "+t}},t],blur:[{"text-shadow":function(){return"0em 0em 0.08em "+e(this).css("color")}},t],blurrier:[{"text-shadow":function(){return"0em 0em 0.2em "+e(this).css("color")},"user-select":"none"},t],mirror:{display:"inline-block",transform:"scaleX(-1)"},upsidedown:{display:"inline-block",transform:"scaleY(-1)"},fadeinout:{animation:"fade-in-out 2s ease-in-out infinite alternate"},rumble:{animation:"rumble linear 0.1s 0s infinite",display:"inline-block"}});return["text-style",function(e,t){return t=n.insensitiveName(t),t in r?a.create("text-style",[t]):u.create("datatype","'"+t+"' is not a valid (text-style:)","Only the following names are recognised (capitalisation and hyphens ignored): "+Object.keys(r).join(", "))},function(e,t){return n.assertMustHave(r,[t]),e.styles="none"===t?[]:e.styles.concat(r[t]),e}]}()).concat([[String]]))("hover-style",function(e,t){var n=c.create(),r=(t.run(n),n.summary());return r+""=="styles"||r.every(function(e){return"styles"===e||"attr"===e})&&n.attr.every(function(e){return Object.keys(e)+""=="style"})?a.create("hover-style",[t]):u.create("datatype","The changer given to (hover-style:) must only change the hook's style.")},function(e,t){return e.data.hoverChanger=t,e.attr.push({hover:!1}),e},[a])("css",function(e,t){return t.trim().endsWith(";")||(t+=";"),a.create("css",[t])},function(t,n){return t.attr.push({style:function(){return(e(this).attr("style")||"")+n}}),t},[String])}),define("internaltypes/enchantment",["jquery","utils","internaltypes/changedescriptor"],function(e,t,n){var r={create:function(n){return t.assertOnlyHas(n,["scope","section","attr","data","changer","functions"]),Object.assign(Object.create(this),{enchantments:e()},n)},enchantScope:function(){var r=this,i=this.attr,o=this.data,a=this.functions,s=this.section,c=this.changer,u=this.scope;u instanceof e&&(u=Array.prototype.map.call(u,function(t){return e(t)})),this.enchantments=e(),u.forEach(s,function(e){var u=e.wrapAll("<tw-enchantment>").parent();if(i&&u.attr(i),o&&u.data(o),a&&a.forEach(function(e){return e(u)}),c){var l=n.create({section:s,target:u});if(c.run(l),l.update(),e.is(t.storyElement)){var f=Object.keys(Object.assign.apply(Object,[{}].concat(_toConsumableArray(l.styles))));e.css(f.reduce(function(e,t){return e[t]="inherit",e},{})),u.data({enchantedProperties:f})}}e.is(t.storyElement)&&u.css({width:"100%",height:"100%"}),r.enchantments=r.enchantments.add(u)})},disenchant:function(){this.enchantments.each(function(){var n=e(this).contents();n.unwrap();var r=e(this).data("enchantedProperties");r&&n.has(t.storyElement)&&t.storyElement.css(r.reduce(function(e,t){return e[t]="",e},{}))})}};return Object.freeze(r)}),define("macrolib/enchantments",["jquery","utils","utils/selectors","utils/operationutils","engine","passages","macros","datatypes/hookset","datatypes/changercommand","internaltypes/enchantment","internaltypes/twineerror"],function(e,t,n,r,i,o,a,s,c,u,l){function f(n,r){return t.onStartup(function(){t.storyElement.on(n.event+".enchantment","."+n.classList.replace(/ /g,"."),function(){var t=e(this),n=t.data("enchantmentEvent");n&&n(t)})}),[function(e,t){return t?c.create(r,[s.from(t)]):l.create("datatype","A string given to this ("+r+":) macro was empty.")},function(e,t){e.enabled=!1,e.transitionDeferred=!0,n.rerender&&(e.newTargets=(e.newTargets||[]).concat({target:t,append:n.rerender}));var r=_slicedToArray(e.section.stack,1),o=r[0].tempVariables,a=u.create({functions:[function(e){e.attr("class",e.children().is("tw-story, tw-sidebar, tw-passage")?n.blockClassList:n.classList)}],attr:(n.classList+"").match(/\b(?:link|enchantment-clickblock)\b/)?{tabIndex:"0"}:{},data:{enchantmentEvent:function(){if(!e.section.stackTop||!e.section.stackTop.blocked){if(n.once){var t=e.section.enchantments.indexOf(a);e.section.enchantments.splice(t,1),a.disenchant()}if(n.goto)return void i.goToPassage(n.goto,{transitionOut:n.transitionOut,transitionIn:n.transitionIn});e.section.renderInto(e.source,null,Object.assign({},e,{enabled:!0,transitionDeferred:!1}),o)}}},scope:t,section:e.section});return e.section.enchantments.push(a),a.enchantScope(),e},h(s,String)]}var p=r.is,d=a.TypeSignature,h=d.either,g=d.rest;a.addCommand("enchant",function(e,t){var n=t.summary();if(n.includes("newTargets")||n.includes("target"))return l.create("macrocall","The changer given to (enchant:) can't include a revision command like (replace:) or (append:).")},function(e,t,n){var r=u.create({scope:s.from(t),changer:n,section:e});return e.enchantments.push(r),r.enchantScope(),""},[h(s,String),c],!1);var y=["replace","append","prepend"];y.forEach(function(t){a.addChanger(t,function(e){for(var n=arguments.length,r=Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return r.every(Boolean)?c.create(t,r.map(s.from)):l.create("datatype","A string given to this ("+t+":) macro was empty.")},function(n){for(var r,i=arguments.length,o=Array(i>1?i-1:0),a=1;a<i;a++)o[a-1]=arguments[a];return e(n.target).parents().filter("tw-collapsed").length>0||(n.attr=[].concat(_toConsumableArray(n.attr),[{collapsing:!1}])),n.newTargets=n.newTargets||[],(r=n.newTargets).push.apply(r,_toConsumableArray(o.filter(function(e){return!n.newTargets.some(function(n){var r=n.target,i=n.append;return p(e,r)&&t===i})}).map(function(e){return{target:e,append:t,before:!0}}))),n},g(h(s,String)))}),t.onStartup(function(){t.storyElement.on("click.enchantment",function(){Array.from(e(this).parents(".enchantment-clickblock")).sort(function(e,t){return 8&e.compareDocumentPosition(t)?1:-1}).forEach(function(t){var n=e(t).data("enchantmentEvent");n&&n()})})});var m=[{name:"click",enchantDesc:{event:"click",once:!0,rerender:"",classList:"link enchantment-link",blockClassList:"enchantment-clickblock"}},{name:"mouseover",enchantDesc:{event:"mouseenter",once:!0,rerender:"",classList:"enchantment-mouseover"}},{name:"mouseout",enchantDesc:{event:"mouseleave",once:!0,rerender:"",classList:"enchantment-mouseout"}}];m.forEach(function(e){return a.addChanger.apply(a,[e.name].concat(_toConsumableArray(f(e.enchantDesc,e.name))))}),y.forEach(function(e){m.forEach(function(t){var n=Object.assign({},t.enchantDesc,{rerender:e}),r=t.name+"-"+e;a.addChanger.apply(a,[r].concat(_toConsumableArray(f(n,r))))})}),m.forEach(function(e){var t=e.name+"-goto";a.addCommand(t,function(e,n){return e&&n?o.hasValid(n)?void 0:l.create("macrocall","I can't ("+t+":) the passage '"+n+"' because it doesn't exist."):l.create("datatype","A string given to this ("+t+":) macro was empty.")},function(n,r,i,o){var a=f(Object.assign({},e.enchantDesc,{goto:o,transitionOut:n.data.t8nDepart,transitionIn:n.data.t8nArrive}),t);return(0,_slicedToArray(a,2)[1])({section:r},s.from(i)),Object.assign(n,{source:""})},[h(s,String),String])})}),define("macrolib/links",["jquery","macros","utils","utils/selectors","state","passages","engine","datatypes/changercommand","datatypes/hookset","internaltypes/twineerror"],function(e,t,n,r,i,o,a,s,c,u){function l(e,t,r){r=r||t;var i=o.hasValid(t)&&t===r,a=e.evaluateTwineMarkup(n.unescape(r),"a link's passage name"),s=void 0;if(i){var c=a.children().length>0?"`".repeat((r.match(/`+/)||[]).reduce(function(e,t){return Math.max(e,t.length+1)},1)):"";t=c+"\0".repeat(!!c)+t+"\0".repeat(!!c)+c}else a.findAndFilter("tw-error").length&&(s=a.findAndFilter("tw-error").data("TwineError")),r=a.text();return{text:t,passage:r,error:s}}var f=t.TypeSignature,p=f.optional,d=f.rest,h=["Links can't have empty strings for their displayed text.","In the link syntax, a link's displayed text is inside the [[ and ]], and on the non-pointy side of the -> or <- arrow if it's there."],g=Object.assign;n.onStartup(function(){return e(n.storyElement).on("click.passage-link",r.internalLink,function(){var t=e(this),n=t.closest("tw-expression"),r=t.closest("tw-expression, tw-hook"),i=r.data("clickEvent"),o=r.data("section");if(!(o&&o.stackTop&&o.stackTop.blocked)){if(i){if(t.find("tw-error").length>0)return;return void i(t)}var s=n.data("linkPassageName"),c=n.data("t8nDepart"),u=n.data("t8nArrive"),l=n.data("t8nTime");return n.find("tw-enchantment").each(function(t,n){c=e(n).data("t8nDepart")||c,u=e(n).data("t8nArrive")||u,l=void 0!==e(n).data("t8nTime")?e(n).data("t8nTime"):l}),s?void a.goToPassage(s,{transitionOut:c,transitionIn:u,transitionTime:l}):t.is("[undo]")?void a.goBack({transitionOut:c,transitionIn:u,transitionTime:l}):void 0}})}),[["link","link-replace"],["link-reveal"],["link-repeat"]].forEach(function(e){return t.addChanger(e,function(t,n){return n?s.create(e[0],[n]):u.create("macrocall",h[0])},function(t,n){t.innerSource||(t.innerSource=t.source),t.source="<tw-link tabindex=0>"+n+"</tw-link>",t.append="link"===e[0]?"replace":"append",t.transitionDeferred=!0;var r=_slicedToArray(t.section.stack,1),i=r[0].tempVariables
;t.data.section=t.section,t.data.clickEvent=function(n){"link-reveal"===e[0]&&n.contents().unwrap(),t.source=t.innerSource+"",t.transitionDeferred=!1,t.section.renderInto("",null,t,i)}},[String])}),t.addCommand(["link-goto"],function(e){if(!e)return u.create.apply(u,["macrocall"].concat(h))},function(e,t,r,a){var s=void 0,c=l(t,r,a);if(r=c.text,a=c.passage,s=c.error)return s;var u=void 0;return o.hasValid(a)||(u='<tw-broken-link passage-name="'+n.escape(a)+'">'+r+"</tw-broken-link>"),u=u||"<tw-link tabindex=0 "+(i.passageNameVisited(a)>0?'class="visited" ':"")+">"+r+"</tw-link>",e.data.linkPassageName=a,e.data.section=t,g(e,{source:u,transitionDeferred:!0})},[String,p(String)])("link-undo",function(e){if(!e)return u.create("macrocall",h[0])},function(e,t,n){return i.pastLength<1?u.create("macrocall","I can't use (link-undo:) on the first turn."):(e.data.section=t,g(e,{source:"<tw-link tabindex=0 undo>"+n+"</tw-link>",transitionDeferred:!0}))},[String])("link-show",function(e){if(!e)return u.create("macrocall",h[0])},function(e,t,n){for(var r=arguments.length,i=Array(r>3?r-3:0),o=3;o<r;o++)i[o-3]=arguments[o];var a=_slicedToArray(t.stack,1),s=a[0].tempVariables;return e.data.section=t,e.data.clickEvent=function(n){n.contents().unwrap(),i.forEach(function(n){return n.forEach(t,function(n){var r=n.data("hiddenSource");void 0!==r&&t.renderInto("",null,g({},e,{source:r,target:n,transitionDeferred:!1}),s)})})},g(e,{source:"<tw-link tabindex=0>"+n+"</tw-link>",transitionDeferred:!0})},[String,d(c)]),t.addChanger(["link-reveal-goto"],function(e,t,n){if(!t)return u.create.apply(u,["macrocall"].concat(h));var r=l(e,t,n);return t=r.text,n=r.passage,r.error||s.create("link-reveal-goto",[t,n])},function(e,t,r){if(!o.hasValid(r))return void(e.source='<tw-broken-link passage-name="'+n.escape(r)+'">'+t+"</tw-broken-link>");e.innerSource||(e.innerSource=e.source);var s=i.passageNameVisited(r);e.source="<tw-link tabindex=0 "+(s>0?'class="visited" ':"")+">"+t+"</tw-link>",e.append="append",e.transitionDeferred=!0;var c=_slicedToArray(e.section.stack,1),u=c[0].tempVariables;e.data.section=e.section,e.data.clickEvent=function(t){e.source=e.innerSource,t.contents().unwrap(),e.transitionDeferred=!1,e.section.renderInto(e.innerSource+"",null,e,u),e.section.whenUnblocked(function(){return a.goToPassage(r,{transitionOut:e.data.t8nDepart,transitionIn:e.data.t8nArrive})})}},[String,p(String)])}),define("repl",["utils","engine","markup","twinescript/compiler","twinescript/environ"],function(e,t,n,r,i){e.onStartup(function(){return setTimeout(function(){t.options.debug&&(window.REPL=function(e){var t=r(n.lex("(print:"+e+")"));console.log(t);var o=i({}).eval(t);return o.TwineScript_Print?o.TwineScript_Print():o},window.LEX=function(e){var t=n.lex(e);return 1===t.length?t[0]:t})})})}),require.config({paths:{jquery:"../node_modules/jquery/dist/jquery",almond:"../node_modules/almond/almond","es6-shim":"../node_modules/es6-shim/es6-shim",requestAnimationFrame:"../node_modules/requestanimationframe/app/requestAnimationFrame",jqueryplugins:"utils/jqueryplugins",markup:"./markup/markup",lexer:"./markup/lexer",patterns:"./markup/patterns"},deps:["jquery","es6-shim","jqueryplugins"]}),require(["jquery","debugmode","renderer","state","engine","passages","utils","utils/selectors","utils/dialog","macros","macrolib/values","macrolib/commands","macrolib/datastructures","macrolib/stylechangers","macrolib/enchantments","macrolib/links","repl"],function($,DebugMode,Renderer,State,Engine,Passages,Utils,Selectors,Dialog){function __HarloweEval(text){return eval(text+"")}function printJSError(e){var t=e.name+": "+e.message;if(e.stack){var n=e.stack.split("\n"),r=n.findIndex(function(e){return e.includes("__HarloweEval")});t+="\n"+n.slice(0,r).join("\n").replace(/\([^\)]+\)/g,"")}return"<div style='font-family:monospace;overflow-y:scroll;max-height:30vh'>```"+t+"```</div>"}var _installHandlers=function(){$(document.documentElement).on("keydown",function(e){13===e.which&&"0"===e.target.getAttribute("tabindex")&&$(e.target).trigger("click")}),Engine.options.debug&&DebugMode(),_installHandlers=null};!function(e){window.onerror=function(t,n,r,i,o){window.onerror=e,Utils.storyElement.parent().append(Dialog("Sorry to interrupt, but this page's code has got itself in a mess.\n\n"+printJSError(o)+"\n(This is probably due to a bug in the Harlowe game engine.)",void 0,function(){})),"function"==typeof e&&e.apply(void 0,arguments)}}(window.onerror),Utils.onStartup(function(){var e=$(Selectors.storyData);if(0!==e.length){var t=e.attr("options");t&&t.split(/\s/).forEach(function(e){Renderer.options[e]=Engine.options[e]=!0});var n=e.attr("startnode");Renderer.options.ifid=Engine.options.ifid=e.attr("ifid"),n||(n=[].reduce.call($(Selectors.passageData),function(e,t){var n=t.getAttribute("pid");return n<e?n:e},1/0)),n=$(Selectors.passageData+"[pid="+n+"]").attr("name"),_installHandlers();var r=!1;$(Selectors.script).each(function(e){try{__HarloweEval($(this).html())}catch(t){r||(r=!0,Utils.storyElement.parent().append(Dialog("There is a problem with this story's "+Utils.nth(e+1)+" script:\n\n"+printJSError(t),void 0,function(){})))}}),$(Selectors.stylesheet).each(function(e){$(document.head).append('<style data-title="Story stylesheet '+(e+1)+'">'+$(this).html())});var i=!Engine.options.debug&&State.hasSessionStorage&&sessionStorage.getItem("Saved Session");if(i&&!0===State.deserialise(i))return void Engine.showPassage(State.passage,!1);Engine.goToPassage(n)}})}),define("harlowe",function(){}),require(["harlowe"])}();
</script>


</body>
</html>
